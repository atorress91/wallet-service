image: atlassian/default-image:2

pipelines:
  branches:
    development:
      - step:
          name: Build and Push to ECR - QA for WalletServiceApi
          script:
            - export AWS_ACCESS_KEY_ID=your_aws_access_key_id
            - export AWS_SECRET_ACCESS_KEY=your_aws_secret_access_key
            - export AWS_DEFAULT_REGION=your_aws_region
            - export ECR_REPO_URI=your_aws_account_id.dkr.ecr.your_aws_region.amazonaws.com/walletserviceapi
            - export IMAGE_TAG=qa-$BITBUCKET_COMMIT
            - export TASK_FAMILY_NAME=WalletServiceApiTaskFamily
            - export SERVICE_NAME=WalletServiceApi
            - export CLUSTER_NAME=HeroSystemQA
            
            - $(aws ecr get-login --no-include-email --region $AWS_DEFAULT_REGION)
            
            - docker build -t $ECR_REPO_URI:$IMAGE_TAG .
            
            - docker push $ECR_REPO_URI:$IMAGE_TAG
            
            - sed -i "s|<IMAGE_NAME>|$ECR_REPO_URI:$IMAGE_TAG|g" qa-task-definition.json
            
            - aws ecs register-task-definition --cli-input-json file://qa-task-definition.json
            
            - aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $TASK_FAMILY_NAME --force-new-deployment

    master:
      - step:
          name: Build and Push to ECR - Prod for WalletServiceApi
          script:
            - export AWS_ACCESS_KEY_ID=your_aws_access_key_id
            - export AWS_SECRET_ACCESS_KEY=your_aws_secret_access_key
            - export AWS_DEFAULT_REGION=your_aws_region
            - export ECR_REPO_URI=your_aws_account_id.dkr.ecr.your_aws_region.amazonaws.com/walletserviceapi
            - export IMAGE_TAG=prod-$BITBUCKET_COMMIT
            - export TASK_FAMILY_NAME=WalletServiceApiTaskFamily
            - export SERVICE_NAME=WalletServiceApiProd
            - export CLUSTER_NAME=HeroSystemProd
            
            - $(aws ecr get-login --no-include-email --region $AWS_DEFAULT_REGION)
            
            - docker build -t $ECR_REPO_URI:$IMAGE_TAG .
            
            - docker push $ECR_REPO_URI:$IMAGE_TAG
            
            - sed -i "s|<IMAGE_NAME>|$ECR_REPO_URI:$IMAGE_TAG|g" task-definition.json
            
            - aws ecs register-task-definition --cli-input-json file://prod-task-definition.json
            
            - aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $TASK_FAMILY_NAME --force-new-deployment
