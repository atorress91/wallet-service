ú
gC:\HeroSystem\walletService\WalletService.Core\BackgroundServices\RedisCacheCleanupBackgroundService.cs
	namespace 	
WalletService
 
. 
Core 
. 
BackgroundServices /
;/ 0
public 
class .
"RedisCacheCleanupBackgroundService /
:/ 0
BackgroundService0 A
{		 
private

 
readonly

 
IServiceProvider

 %
	_services

& /
;

/ 0
private 
readonly 
ILogger 
< .
"RedisCacheCleanupBackgroundService ?
>? @
_loggerA H
;H I
public 
.
"RedisCacheCleanupBackgroundService -
(- .
IServiceProvider. >
services? G
,G H
ILoggerI P
<P Q.
"RedisCacheCleanupBackgroundServiceQ s
>s t
loggeru {
){ |
{ 
	_services 
= 
services 
; 
_logger 
= 
logger 
; 
} 
	protected 
override 
async 
Task !
ExecuteAsync" .
(. /
CancellationToken/ @
stoppingTokenA N
)N O
{ 
while 
( 
! 
stoppingToken 
. #
IsCancellationRequested 5
)5 6
{ 	
_logger 
. 
LogInformation "
(" #
$str# C
)C D
;D E
using 
( 
var 
scope 
= 
	_services (
.( )
CreateScope) 4
(4 5
)5 6
)6 7
{ 
var 
cleanupService "
=# $
scope% *
.* +
ServiceProvider+ :
.: ;
GetRequiredService; M
<M N%
IRedisCacheCleanupServiceN g
>g h
(h i
)i j
;j k
await 
cleanupService $
.$ %
CleanupAsync% 1
(1 2
)2 3
;3 4
} 
await 
Task 
. 
Delay 
( 
TimeSpan %
.% &
FromMinutes& 1
(1 2
$num2 3
)3 4
,4 5
stoppingToken6 C
)C D
;D E
}   	
}!! 
}"" Æ6
GC:\HeroSystem\walletService\WalletService.Core\Caching\InMemoryCache.cs
	namespace 	
WalletService
 
. 
Core 
. 
Caching $
;$ %
public 
class 
InMemoryCache 
: 
ICache #
{ 
private		 
readonly		 
MemoryCache		  
_memoryCache		! -
=		. /
new		0 3
(		3 4
new		4 7
MemoryCacheOptions		8 J
(		J K
)		K L
)		L M
;		M N
private

 
readonly

 
SemaphoreSlim

 "

_semaphore

# -
;

- .
public 

InMemoryCache 
( 
) 
=> 


_semaphore 
= 
new 
SemaphoreSlim )
() *
$num* +
,+ ,
$num- .
). /
;/ 0
public 

async 
Task 
Set 
( 
string  
key! $
,$ %
object& ,
?, -
value. 3
,3 4
TimeSpan5 =
?= >
timeOut? F
=G H
nullI M
,M N
TimeSpanO W
?W X
slidingExpirationY j
=k l
nullm q
)q r
{ 
try 
{ 	
await 

_semaphore 
. 
	WaitAsync &
(& '
)' (
;( )
await 
Task 
. 
Run 
( 
( 
) 
=>  
{ 
if 
( 
timeOut 
. 
HasValue $
)$ %
_memoryCache  
.  !
Set! $
($ %
key% (
,( )
value* /
,/ 0
timeOut1 8
.8 9
Value9 >
)> ?
;? @
else 
_memoryCache  
.  !
Set! $
($ %
key% (
,( )
value* /
,/ 0
new1 4#
MemoryCacheEntryOptions5 L
{ 
SlidingExpiration )
=* +
slidingExpiration, =
} 
) 
; 
} 
) 
; 
} 	
finally 
{   	

_semaphore!! 
.!! 
Release!! 
(!! 
)!!  
;!!  !
}"" 	
}## 
public%% 

async%% 
Task%% 
<%% 
T%% 
?%% 
>%% 
Get%% 
<%% 
T%% 
>%%  
(%%  !
string%%! '
key%%( +
)%%+ ,
{&& 
try'' 
{(( 	
await)) 

_semaphore)) 
.)) 
	WaitAsync)) &
())& '
)))' (
;))( )
return** 
_memoryCache** 
.**  
Get**  #
<**# $
T**$ %
>**% &
(**& '
key**' *
)*** +
;**+ ,
}++ 	
finally,, 
{-- 	

_semaphore.. 
... 
Release.. 
(.. 
)..  
;..  !
}// 	
}00 
public22 

async22 
Task22 
Delete22 
(22 
string22 #
key22$ '
)22' (
{33 
try44 
{55 	
await66 

_semaphore66 
.66 
	WaitAsync66 &
(66& '
)66' (
;66( )
await77 
Task77 
.77 
Run77 
(77 
(77 
)77 
=>77  
{77! "
_memoryCache77# /
.77/ 0
Remove770 6
(776 7
key777 :
)77: ;
;77; <
}77= >
)77> ?
;77? @
}88 	
finally99 
{:: 	

_semaphore;; 
.;; 
Release;; 
(;; 
);;  
;;;  !
}<< 	
}== 
public?? 

async?? 
Task?? 
<?? 
List?? 
<?? 
T?? 
??? 
>?? 
>?? 
GetMultiple??  +
<??+ ,
T??, -
>??- .
(??. /
List??/ 3
<??3 4
string??4 :
>??: ;
keys??< @
)??@ A
{@@ 
varAA 
listAA 
=AA 
newAA 
ListAA 
<AA 
TAA 
?AA 
>AA 
(AA  
)AA  !
;AA! "
foreachBB 
(BB 
varBB 
keyBB 
inBB 
keysBB  
)BB  !
listCC 
.CC 
AddCC 
(CC 
awaitCC 
GetCC 
<CC 
TCC  
?CC  !
>CC! "
(CC" #
keyCC# &
)CC& '
)CC' (
;CC( )
returnEE 
listEE 
;EE 
}FF 
publicHH 

asyncHH 
TaskHH 
<HH 
THH 
>HH 
RememberHH !
<HH! "
THH" #
>HH# $
(HH$ %
stringHH% +
keyHH, /
,HH/ 0
TimeSpanHH1 9
?HH9 :
timeOutHH; B
,HHB C
FuncHHD H
<HHH I
TaskHHI M
<HHM N
THHN O
>HHO P
>HHP Q
actionHHR X
)HHX Y
{II 
varJJ 
dataJJ 
=JJ 
awaitJJ 
GetJJ 
<JJ 
TJJ 
?JJ 
>JJ  
(JJ  !
keyJJ! $
)JJ$ %
;JJ% &
ifKK 

(KK 
dataKK 
isKK 
notKK 
nullKK 
&&KK 
dataKK  $
.KK$ %
AssignedKK% -
(KK- .
)KK. /
)KK/ 0
returnLL 
dataLL 
;LL 
dataNN 
=NN 
awaitNN 
actionNN 
(NN 
)NN 
;NN 
awaitOO 
SetOO 
(OO 
keyOO 
,OO 
dataOO 
,OO 
timeOutOO $
)OO$ %
;OO% &
returnQQ 
dataQQ 
;QQ 
}RR 
publicTT 

TaskTT 
<TT 
boolTT 
>TT 
	KeyExistsTT 
(TT  
stringTT  &
keyTT' *
)TT* +
=>UU 

TaskUU 
.UU 

FromResultUU 
(UU 
_memoryCacheUU '
.UU' (
TryGetValueUU( 3
(UU3 4
keyUU4 7
,UU7 8
outUU9 <
_UU= >
)UU> ?
)UU? @
;UU@ A
}VV ﬂ
JC:\HeroSystem\walletService\WalletService.Core\Caching\Interface\ICache.cs
	namespace 	
WalletService
 
. 
Core 
. 
Caching $
.$ %
	Interface% .
;. /
public 
	interface 
ICache 
{ 
Task 
Set	 
( 
string 
key/ 2
,2 3
object4 :
?: ;
value< A
,A B
TimeSpanC K
?K L
timeOutM T
=U V
nullW [
,[ \
TimeSpan] e
?e f
slidingExpirationg x
=y z
null{ 
)	 Ä
;
Ä Å
Task 
< 	
T	 

?
 
> 
Get 
< 
T 
> 
( 
string 
key/ 2
)2 3
;3 4
Task		 
Delete		 
(		 
string		 
key		/ 2
)		2 3
;		3 4
Task

 
<

 	
List

	 
<

 
T

 
?

 
>

 
>

 
GetMultiple

 
<

 
T

  
>

  !
(

! "
List

" &
<

& '
string

' -
>

- .
keys

/ 3
)

3 4
;

4 5
Task 
< 	
T	 

>
 
Remember 
< 
T 
> 
( 
string 
key/ 2
,2 3
TimeSpan4 <
?< =
timeOut> E
,E F
FuncG K
<K L
TaskL P
<P Q
TQ R
>R S
>S T
actionU [
)[ \
;\ ]
Task 
< 	
bool	 
> 
	KeyExists 
( 
string 
key/ 2
)2 3
;3 4
} ÁB
DC:\HeroSystem\walletService\WalletService.Core\Caching\RedisCache.cs
	namespace 	
WalletService
 
. 
Core 
. 
Caching $
;$ %
public 
class 

RedisCache 
: 
ICache  
,  !
IDisposable" -
{ 
private		 
readonly		 
	IDatabase		 
_db		 "
;		" #
private

 
readonly

 "
IConnectionMultiplexer

 +"
_connectionMultiplexer

, B
;

B C
private 
bool 
	_disposed 
; 
public 


RedisCache 
( "
IConnectionMultiplexer ,!
connectionMultiplexer- B
)B C
{ 
_db	 
= !
connectionMultiplexer $
.$ %
GetDatabase% 0
(0 1
)1 2
;2 3"
_connectionMultiplexer	 
=  !!
connectionMultiplexer" 7
;7 8
	_disposed	 
= 
false 
; 
} 
public 

async 
Task 
Set 
( 
string  
key! $
,$ %
object& ,
?, -
value. 3
,3 4
TimeSpan5 =
?= >
timeOut? F
=G H
nullI M
,M N
TimeSpanO W
?W X
slidingExpirationY j
=k l
nullm q
)q r
{ 
string 
? 
jsonStringData 
=  
null! %
;% &
var 
stringValue 
= 
value "
?" #
.# $
ToString$ ,
(, -
)- .
;. /
if 

( 
stringValue 
is 
not 
null #
&&$ &
stringValue' 2
.2 3
IsValidJson3 >
(> ?
)? @
)@ A
jsonStringData 
= 
stringValue (
;( )
else 
if 
( 
value 
is 
not 
null "
)" #
jsonStringData 
= 
value "
." #
ToJsonString# /
(/ 0
)0 1
;1 2
await 
_db 
. 
StringSetAsync  
(  !
key! $
,$ %
jsonStringData& 4
,4 5
timeOut6 =
)= >
;> ?
}   
public"" 

async"" 
Task"" 
<"" 
T"" 
?"" 
>"" 
Get"" 
<"" 
T"" 
>""  
(""  !
string""! '
key""( +
)""+ ,
{## 
var$$ 
keyValue$$ 
=$$ 
await$$ 
_db$$  
.$$  !
StringGetAsync$$! /
($$/ 0
key$$0 3
)$$3 4
;$$4 5
if&& 

(&& 
!&& 
keyValue&& 
.&& 
HasValue&& 
)&&  
return'' 
default'' 
;'' 
var)) 
	keyString)) 
=)) 
keyValue))  
.))  !
ToString))! )
())) *
)))* +
;))+ ,
var** 
deserializeObject** 
=** 
	keyString**  )
.**) *
ToJsonObject*** 6
<**6 7
T**7 8
>**8 9
(**9 :
)**: ;
;**; <
return,, 
deserializeObject,,  
;,,  !
}-- 
public// 

async// 
Task// 
Delete// 
(// 
string// #
key//$ '
)//' (
=>00 

await00 
_db00 
.00 
KeyDeleteAsync00 #
(00# $
key00$ '
)00' (
;00( )
public33 

async33 
Task33 
<33 
List33 
<33 
T33 
?33 
>33 
>33 
GetMultiple33  +
<33+ ,
T33, -
>33- .
(33. /
List33/ 3
<333 4
string334 :
>33: ;
keys33< @
)33@ A
{44 
var55 
	redisKeys55 
=55 
keys55 
.55 
Select55 #
(55# $
x55$ %
=>55& (
new55) ,
RedisKey55- 5
(555 6
x556 7
)557 8
)558 9
.559 :
ToArray55: A
(55A B
)55B C
;55C D
var66 
data66 
=66 
await66 
_db66 !
.66! "
StringGetAsync66" 0
(660 1
	redisKeys661 :
)66: ;
;66; <
if88 

(88 
data88 
.88 
Assigned88 
(88 
)88 
)88 
{99 	
return:: 
data:: 
.;; 
Where;; 
(;; 
x;; 
=>;; 
x;; 
.;; 
Assigned;; &
(;;& '
);;' (
&&;;) +
x;;, -
.;;- .
HasValue;;. 6
);;6 7
.<< 
Select<< 
(<< 
s<< 
=><< 
s<< 
.<< 
ToString<< '
(<<' (
)<<( )
.<<) *
ToJsonObject<<* 6
<<<6 7
T<<7 8
><<8 9
(<<9 :
)<<: ;
)<<; <
.== 
ToList== 
(== 
)== 
;== 
}>> 	
return@@ 
new@@ 
List@@ 
<@@ 
T@@ 
?@@ 
>@@ 
(@@ 
)@@ 
;@@ 
}AA 
publicCC 

asyncCC 
TaskCC 
<CC 
TCC 
>CC 
RememberCC !
<CC! "
TCC" #
>CC# $
(CC$ %
stringCC% +
keyCC, /
,CC/ 0
TimeSpanCC1 9
?CC9 :
timeOutCC; B
,CCB C
FuncCCD H
<CCH I
TaskCCI M
<CCM N
TCCN O
>CCO P
>CCP Q
actionCCR X
)CCX Y
{DD 
varEE 
valueEE 
=EE 
awaitEE 
GetEE 
<EE 
TEE 
>EE  
(EE  !
keyEE! $
)EE$ %
;EE% &
ifGG 

(GG 
valueGG 
isGG 
nullGG 
||GG 
valueGG "
.GG" #
NotAssignedGG# .
(GG. /
)GG/ 0
)GG0 1
{HH 	
valueII 
=II 
awaitII 
actionII  
(II  !
)II! "
;II" #
awaitJJ 
SetJJ 
(JJ 
keyJJ 
,JJ 
valueJJ  
,JJ  !
timeOutJJ" )
)JJ) *
;JJ* +
}KK 	
returnMM 
valueMM 
;MM 
}NN 
publicPP 

TaskPP 
<PP 
boolPP 
>PP 
	KeyExistsPP 
(PP  
stringPP  &
keyPP' *
)PP* +
=>QQ 

_dbQQ 
.QQ 
KeyExistsAsyncQQ 
(QQ 
newQQ !
RedisKeyQQ" *
(QQ* +
keyQQ+ .
)QQ. /
)QQ/ 0
;QQ0 1
publicSS 

voidSS 
DisposeSS 
(SS 
)SS 
{TT 
DisposeUU 
(UU 
trueUU 
)UU 
;UU 
GCVV 

.VV
 
SuppressFinalizeVV 
(VV 
thisVV  
)VV  !
;VV! "
}WW 
	protectedYY 
virtualYY 
voidYY 
DisposeYY "
(YY" #
boolYY# '
	disposingYY( 1
)YY1 2
{ZZ 
if[[ 

([[ 
	_disposed[[ 
)[[ 
return[[ 
;[[ 
if\\ 

(\\ 
	disposing\\ 
)\\ 
{]] 	"
_connectionMultiplexer^^ "
.^^" #
Dispose^^# *
(^^* +
)^^+ ,
;^^, -
}__ 	
	_disposedaa 
=aa 
trueaa 
;aa 
}bb 
}cc ì7
OC:\HeroSystem\walletService\WalletService.Core\ConPaymentsApi\ConPaymentsApi.cs
	namespace 	
WalletService
 
. 
Core 
. 
ConPaymentsApi +
{ 
public 

class 
ConPaymentsApi 
:  !
IConPaymentsApi" 1
{ 
private 
readonly 
string  &
_privateKey+ 6
;6 7
private		 
readonly		 
string		  &

_publicKey		+ 5
;		5 6
private

 
readonly

 
Encoding

  (
	_encoding

+ 4
=

7 8
Encoding

9 A
.

A B
UTF8

B F
;

F G
private 
readonly 

HttpClient $
_httpClient% 0
=1 2
new3 6

HttpClient7 A
(A B
)B C
;C D
public 
ConPaymentsApi 
( 
string $
privkey% ,
,, -
string. 4
pubkey5 ;
); <
{ 	
_privateKey 
= 
privkey !
;! "

_publicKey 
= 
pubkey  
;  !
if 
( 
_privateKey 
. 
Length "
==# %
$num& '
||( *

_publicKey+ 5
.5 6
Length6 <
=== ?
$num@ A
)A B
{ 
throw 
new 
ArgumentException +
(+ ,
$str, L
)L M
;M N
} 
} 	
public 
async 
Task 
< 
IRestResponse '
>' (
CallApi) 0
(0 1
string1 7
cmd8 ;
,; <

SortedList= G
<G H
stringH N
,N O
stringP V
>V W
?W X
parmsY ^
)^ _
{ 	
if 
( 
parms 
== 
null 
) 
{ 
parms 
= 
new 

SortedList &
<& '
string' -
,- .
string/ 5
>5 6
(6 7
)7 8
;8 9
} 
parms 
[ 
$str 
] 
= 
$str "
;" #
parms 
[ 
$str 
] 
= 

_publicKey )
;) *
parms 
[ 
$str 
] 
= 
cmd "
;" #
string!! 
postData!! 
=!! 
$str!!  
;!!  !
foreach"" 
("" 
KeyValuePair"" !
<""! "
string""" (
,""( )
string""* 0
>""0 1
parm""2 6
in""7 9
parms"": ?
)""? @
{## 
if$$ 
($$ 
postData$$ 
.$$ 
Length$$ #
>$$$ %
$num$$& '
)$$' (
{%% 
postData&& 
+=&& 
$str&&  #
;&&# $
}'' 
postData)) 
+=)) 
parm))  
.))  !
Key))! $
+))% &
$str))' *
+))+ ,
Uri))- 0
.))0 1
EscapeDataString))1 A
())A B
parm))B F
.))F G
Value))G L
)))L M
;))M N
}** 
byte,, 
[,, 
],, 
keyBytes,, 
=,, 
	_encoding,,  )
.,,) *
GetBytes,,* 2
(,,2 3
_privateKey,,3 >
),,> ?
;,,? @
byte-- 
[-- 
]-- 
	postBytes-- 
=-- 
	_encoding--  )
.--) *
GetBytes--* 2
(--2 3
postData--3 ;
)--; <
;--< =
var.. 

hmacsha512.. 
=.. 
new..  #
System..$ *
...* +
Security..+ 3
...3 4
Cryptography..4 @
...@ A

HMACSHA512..A K
(..K L
keyBytes..L T
)..T U
;..U V
string// 
hmac// 
=// 
BitConverter//  ,
.//, -
ToString//- 5
(//5 6

hmacsha512//6 @
.//@ A
ComputeHash//A L
(//L M
	postBytes//M V
)//V W
)//W X
.//X Y
Replace//Y `
(//` a
$str//a d
,//d e
string//f l
.//l m
Empty//m r
)//r s
;//s t
_httpClient22 
.22 !
DefaultRequestHeaders22 -
.22- .
Clear22. 3
(223 4
)224 5
;225 6
_httpClient33 
.33 !
DefaultRequestHeaders33 -
.33- .
Add33. 1
(331 2
$str332 8
,338 9
hmac33: >
)33> ?
;33? @
var55 
restResponse55 
=55 
new55 "
RestResponse55# /
(55/ 0
)550 1
;551 2
try77 
{88 
var99 
content99 
=99 
new99 "
StringContent99# 0
(990 1
postData991 9
,999 :
Encoding99; C
.99C D
UTF899D H
,99H I
$str99J m
)99m n
;99n o
var:: 
response:: 
=:: 
await:: $
_httpClient::% 0
.::0 1
	PostAsync::1 :
(::: ;
$str::; a
,::a b
content::c j
)::j k
;::k l
restResponse<< 
.<< 
Content<< $
=<</ 0
await<<1 6
response<<7 ?
.<<? @
Content<<@ G
.<<G H
ReadAsStringAsync<<H Y
(<<Y Z
)<<Z [
;<<[ \
restResponse== 
.== 

StatusCode== '
===/ 0
response==1 9
.==9 :

StatusCode==: D
;==D E
restResponse>> 
.>> 
StatusDescription>> .
=>>/ 0
response>>1 9
.>>9 :
ReasonPhrase>>: F
;>>F G
}?? 
catch@@ 
(@@  
HttpRequestException@@ '
e@@( )
)@@) *
{AA 
restResponseBB 
.BB 
ContentBB $
=BB% &
$strBB' V
+BBW X
eBBY Z
.BBZ [
MessageBB[ b
;BBb c
}CC 
catchDD 
(DD 
	ExceptionDD 
eDD 
)DD 
{EE 
restResponseFF 
.FF 
ContentFF $
=FF% &
$strFF' <
+FF= >
eFF? @
.FF@ A
MessageFFA H
;FFH I
}GG 
returnII 
restResponseII 
;II  
}JJ 	
}KK 
}LL ç
PC:\HeroSystem\walletService\WalletService.Core\ConPaymentsApi\IConPaymentsApi.cs
	namespace 	
WalletService
 
. 
Core 
. 
ConPaymentsApi +
;+ ,
public 
	interface 
IConPaymentsApi  
{ 
Task 
< 	
IRestResponse	 
> 
CallApi 
(  
string  &
cmd' *
,* +

SortedList, 6
<6 7
string7 =
,= >
string? E
>E F
?F G
parmsH M
)M N
;N O
} ˇÖ
SC:\HeroSystem\walletService\WalletService.Core\Kafka\Consumers\BaseKafkaConsumer.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
	Consumers# ,
;, -
public 
abstract 
class 
BaseKafkaConsumer '
{ 
public 

int 
ConsumerIndex 
{ 
get "
;" #
set$ '
;' (
}) *
private 
readonly 
ConsumerSettings %
_consumerSettings& 7
;7 8
private 
Guid 

InstanceId 
{ 
get !
;! "
set# &
;& '
}( )
private 
readonly $
ApplicationConfiguration -
_configuration. <
;< =
	protected 
readonly 
ILogger 
Logger %
;% &
private 
	IConsumer 
< 
Ignore 
, 
string $
>$ %
	_consumer& /
;/ 0
private 
Thread 
_thread 
; 
private 
readonly #
CancellationTokenSource ,$
_cancellationTokenSource- E
;E F
private 
ConsumeResult 
< 
Ignore  
,  !
string" (
>( )
_consumeResult* 8
;8 9
	protected 
readonly  
IServiceScopeFactory +
ServiceScopeFactory, ?
;? @
private 
bool 
Enabled 
{ 
get 
; 
set  #
;# $
}% &
private 
readonly 
object 
_locker #
=$ %
new& )
() *
)* +
;+ ,
	protected 
BaseKafkaConsumer 
(  
ConsumerSettings 
consumerSettings# 3
,3 4$
ApplicationConfiguration  
configuration# 0
,0 1
ILogger   
logger   
,    
IServiceScopeFactory!! 
serviceScopeFactory!!# 6
)"" 
{## 

InstanceId$$ 
=$$! "
Guid$$# '
.$$' (
NewGuid$$( /
($$/ 0
)$$0 1
;$$1 2
Logger%% 
=%%! "
logger%%# )
;%%) *
_consumerSettings&& 
=&&! "
consumerSettings&&# 3
;&&3 4
_configuration'' 
=''! "
configuration''# 0
;''0 1$
_cancellationTokenSource((  
=((! "
new((# &#
CancellationTokenSource((' >
(((> ?
)((? @
;((@ A
ServiceScopeFactory)) 
=))! "
serviceScopeFactory))# 6
;))6 7
Connect** 
(** 
)** 
;** 
}++ 
private-- 
void-- 
Connect-- 
(-- 
)-- 
{.. 
var// 
conf// 
=// 
new// 
ConsumerConfig// %
{00 	
BootstrapServers11 
=11+ ,
_configuration11- ;
.11; <
ConsumersSetting11< L
?11L M
.11M N

BrokerList11N X
,11X Y
FetchMaxBytes22 
=22+ ,
$num22- 4
*225 6
$num227 8
,228 9
AutoOffsetReset33 
=33+ ,
_consumerSettings33- >
.33> ?
ReadLast33? G
?33H I
AutoOffsetReset33J Y
.33Y Z
Latest33Z `
:33a b
AutoOffsetReset33c r
.33r s
Earliest33s {
,33{ |"
MaxPartitionFetchBytes44 "
=44+ ,
$num44- 4
*445 6
$num447 8
,448 9!
SocketKeepaliveEnable55 !
=55+ ,
true55- 1
,551 2
ReconnectBackoffMs66 
=66+ ,
$num66- 1
,661 2*
TopicMetadataRefreshIntervalMs77 *
=77+ ,
$num77- 2
,772 3
Acks88 
=88+ ,
Acks88- 1
.881 2
All882 5
,885 6
EnableAutoCommit99 
=99+ ,
true99- 1
,991 2
MaxPollIntervalMs:: 
=::+ ,
$num::- 2
,::2 3
SessionTimeoutMs;; 
=;;+ ,
$num;;- 2
}<< 	
;<<	 

if>> 

(>> 
_consumerSettings>> 
.>> 
GroupId>> %
.>>% &
Assigned>>& .
(>>. /
)>>/ 0
)>>0 1
{?? 	
conf@@ 
.@@ 
GroupId@@ 
=@@ 
_consumerSettings@@ ,
.@@, -
GroupId@@- 4
;@@4 5
}AA 	
elseBB 
ifBB 
(BB 
_consumerSettingsBB "
.BB" #
UniqueByMacBB# .
)BB. /
{CC 	
varDD 
firstMacAddressDD 
=DD  !
NetworkInterfaceDD" 2
.DD2 3#
GetAllNetworkInterfacesDD3 J
(DDJ K
)DDK L
.EE 
WhereEE 
(EE 
nicEE 
=>EE 
nicEE !
.EE! "
OperationalStatusEE" 3
==EE4 6
OperationalStatusEE7 H
.EEH I
UpEEI K
&&EEL N
nicFF !
.FF! " 
NetworkInterfaceTypeFF" 6
!=FF7 9 
NetworkInterfaceTypeFF: N
.FFN O
LoopbackFFO W
)FFW X
.GG 
SelectGG 
(GG 
nicGG 
=>GG 
nicGG "
.GG" #
GetPhysicalAddressGG# 5
(GG5 6
)GG6 7
.GG7 8
ToStringGG8 @
(GG@ A
)GGA B
)GGB C
.GGC D
FirstOrDefaultGGD R
(GGR S
)GGS T
;GGT U
confHH 
.HH 
GroupIdHH 
=HH 
$"HH 
$strHH )
{HH) *
firstMacAddressHH* 9
}HH9 :
"HH: ;
;HH; <
}II 	
elseJJ 
{KK 	
varLL 
guidLL 
=LL 
GuidLL 
.LL 
NewGuidLL #
(LL# $
)LL$ %
.LL% &
ToStringLL& .
(LL. /
)LL/ 0
;LL0 1
confMM 
.MM 
GroupIdMM 
=MM 
$"MM 
$strMM $
{MM$ %
guidMM% )
}MM) *
"MM* +
;MM+ ,
}NN 	
lockPP 
(PP 
_lockerPP 
)PP 
{QQ 	
	_consumerRR 
=RR 
newRR 
ConsumerBuilderRR +
<RR+ ,
IgnoreRR, 2
,RR2 3
stringRR4 :
>RR: ;
(RR; <
confRR< @
)RR@ A
.SS  
SetStatisticsHandlerSS %
(SS% &
(SS& '
_SS' (
,SS( )
jsonSS* .
)SS. /
=>SS0 2
ConsoleSS3 :
.SS: ;
	WriteLineSS; D
(SSD E
$"SSE G
$strSSG S
{SSS T
jsonSST X
}SSX Y
"SSY Z
)SSZ [
)SS[ \
.TT 
BuildTT 
(TT 
)TT 
;TT 
	_consumerUU 
.UU 
	SubscribeUU 
(UU  
_consumerSettingsUU  1
.UU1 2
TopicsUU2 8
)UU8 9
;UU9 :
}VV 	
lockXX 
(XX 
_lockerXX 
)XX 
	_consumerYY 
.YY 
	SubscribeYY 
(YY  
_consumerSettingsYY  1
.YY1 2
TopicsYY2 8
)YY8 9
;YY9 :
if[[ 

([[ 
_consumerSettings[[ 
.[[ 
ReadLast[[ &
)[[& '
	_consumer\\ 
.\\ 
Assign\\ 
(\\ 
	_consumer\\ &
.\\& '

Assignment\\' 1
.\\1 2
Select\\2 8
(\\8 9
tp\\9 ;
=>\\< >
new\\? B 
TopicPartitionOffset\\C W
(\\W X
tp\\X Z
,\\Z [
Offset\\\ b
.\\b c
End\\c f
)\\f g
)\\g h
)\\h i
;\\i j
Console^^ 
.^^ 
CancelKeyPress^^ 
+=^^ !
(^^" #
_^^# $
,^^$ %
e^^& '
)^^' (
=>^^) +
{__ 	
e`` 
.`` 
Cancel`` 
=`` 
true`` 
;`` $
_cancellationTokenSourceaa $
.aa$ %
Cancelaa% +
(aa+ ,
)aa, -
;aa- .
}bb 	
;bb	 

}cc 
publicee 

voidee 
Consumeee 
(ee 
)ee 
{ff 
lockgg 
(gg 
_lockergg 
)gg 
{hh 
ifii 
(ii 
Enabledii 
)ii 
returnjj 
;jj 
Enabledll 
=ll 
truell 
;ll 
_threadmm 
=mm 
newmm 
Threadmm 
(mm  
ConsumeMessagesmm  /
)mm/ 0
;mm0 1
_threadnn 
.nn 
Startnn 
(nn 
)nn 
;nn 
}oo 
}pp 
privaterr 
asyncrr 
voidrr 
ConsumeMessagesrr &
(rr& '
)rr' (
{ss 
whileuu 
(uu 
Enableduu 
&&uu 
!uu $
_cancellationTokenSourceuu 3
.uu3 4#
IsCancellationRequesteduu4 K
)uuK L
{vv 	
varww 
consumerNameww &
=ww) *
GetTypeww+ 2
(ww2 3
)ww3 4
.ww4 5
Nameww5 9
;ww9 :
varxx 
topicxx 
=xx) *
stringxx+ 1
.xx1 2
Joinxx2 6
(xx6 7
$charxx7 :
,xx: ;
_consumerSettingsxx< M
.xxM N
TopicsxxN T
)xxT U
;xxU V
ITransactionyy 
?yy 
apmTransactionyy (
=yy) *
nullyy+ /
;yy/ 0
tryzz 
{{{ 
var|| 
guid|| 
=|| 
Guid|| 
.||  
NewGuid||  '
(||' (
)||( )
;||) *
Logger}} 
.}} 
LogInformation}} %
(}}% &
$"}}& (
$str}}( <
{}}< =
ConsumerIndex}}= J
}}}J K
$str}}K Y
{}}Y Z
guid}}Z ^
}}}^ _
"}}_ `
)}}` a
;}}a b
_consumeResult~~ "
=~~# $
	_consumer~~% .
.~~. /
Consume~~/ 6
(~~6 7$
_cancellationTokenSource~~7 O
.~~O P
Token~~P U
)~~U V
;~~V W
apmTransaction
ÄÄ 
=
ÄÄ  
Agent
ÄÄ! &
.
ÄÄ& '
Tracer
ÄÄ' -
.
ÄÄ- .
StartTransaction
ÄÄ. >
(
ÄÄ> ?
$"
ÄÄ? A
{
ÄÄA B
consumerName
ÄÄB N
}
ÄÄN O
$str
ÄÄO P
{
ÄÄP Q
topic
ÄÄQ V
}
ÄÄV W
"
ÄÄW X
,
ÄÄX Y 
ApmTransactionType
ÄÄZ l
.
ÄÄl m
KafkaMessage
ÄÄm y
)
ÄÄy z
;
ÄÄz {
Logger
ÇÇ 
.
ÇÇ 
LogInformation
ÇÇ %
(
ÇÇ% &
$"
ÇÇ& (
$str
ÇÇ( B
{
ÇÇB C
_consumeResult
ÇÇC Q
.
ÇÇQ R
Topic
ÇÇR W
}
ÇÇW X
$str
ÇÇX f
{
ÇÇf g
guid
ÇÇg k
.
ÇÇk l
ToString
ÇÇl t
(
ÇÇt u
)
ÇÇu v
}
ÇÇv w
"
ÇÇw x
)
ÇÇx y
;
ÇÇy z
await
ÉÉ 
	OnMessage
ÉÉ 
(
ÉÉ  
_consumeResult
ÉÉ  .
)
ÉÉ. /
;
ÉÉ/ 0
Logger
ÑÑ 
.
ÑÑ 
LogInformation
ÑÑ %
(
ÑÑ% &
$"
ÖÖ 
$str
ÖÖ 2
{
ÖÖ2 3
_consumeResult
ÖÖ3 A
.
ÖÖA B
Topic
ÖÖB G
}
ÖÖG H
$str
ÖÖH T
{
ÖÖT U
_consumeResult
ÖÖU c
.
ÖÖc d
	Partition
ÖÖd m
.
ÖÖm n
ToString
ÖÖn v
(
ÖÖv w
)
ÖÖw x
}
ÖÖx y
$str
ÖÖy z
{
ÖÖz {
ConsumerIndexÖÖ{ à
}ÖÖà â
$strÖÖâ ô
{ÖÖô ö
guidÖÖö û
.ÖÖû ü
ToStringÖÖü ß
(ÖÖß ®
)ÖÖ® ©
}ÖÖ© ™
"ÖÖ™ ´
,ÖÖ´ ¨
_consumeResult
ÜÜ "
.
ÜÜ" #
Topic
ÜÜ# (
,
ÜÜ( )
_consumeResult
ÜÜ* 8
.
ÜÜ8 9
	Partition
ÜÜ9 B
.
ÜÜB C
ToString
ÜÜC K
(
ÜÜK L
)
ÜÜL M
,
ÜÜM N
ConsumerIndex
ÜÜO \
.
ÜÜ\ ]
ToString
ÜÜ] e
(
ÜÜe f
)
ÜÜf g
,
ÜÜg h
guid
ÜÜi m
.
ÜÜm n
ToString
ÜÜn v
(
ÜÜv w
)
ÜÜw x
)
ÜÜx y
;
ÜÜy z
	_consumer
áá 
.
áá 
Commit
áá  
(
áá  !
_consumeResult
áá! /
)
áá/ 0
;
áá0 1
}
àà 
catch
ââ 
(
ââ 
ConsumeException
ââ #
ex
ââ$ &
)
ââ& '
{
ää 
apmTransaction
ãã 
?
ãã 
.
ãã  
CaptureException
ãã  0
(
ãã0 1
ex
ãã1 3
)
ãã3 4
;
ãã4 5 
OnConsumeException
åå "
(
åå" #
ex
åå# %
)
åå% &
;
åå& '
}
çç 
catch
éé 
(
éé (
OperationCanceledException
éé -
ex
éé. 0
)
éé0 1
{
èè 
apmTransaction
êê 
?
êê 
.
êê  
CaptureException
êê  0
(
êê0 1
ex
êê1 3
)
êê3 4
;
êê4 5
Logger
ëë 
.
ëë 
LogError
ëë 
(
ëë  
$"
ëë  "
$str
ëë" P
"
ëëP Q
)
ëëQ R
;
ëëR S
	_consumer
íí 
.
íí 
Close
íí 
(
íí  
)
íí  !
;
íí! "*
OnOperationCanceledException
ìì ,
(
ìì, -
ex
ìì- /
)
ìì/ 0
;
ìì0 1
}
îî 
catch
ïï 
(
ïï 
	Exception
ïï 
ex
ïï 
)
ïï  
{
ññ 
apmTransaction
óó 
?
óó 
.
óó  
CaptureException
óó  0
(
óó0 1
ex
óó1 3
)
óó3 4
;
óó4 5
Logger
òò 
.
òò 
LogError
òò 
(
òò  
$"
òò  "
$str
òò" F
"
òòF G
)
òòG H
;
òòH I
OnOtherException
ôô  
(
ôô  !
ex
ôô! #
)
ôô# $
;
ôô$ %
}
öö 
finally
õõ 
{
úú 
apmTransaction
ùù 
?
ùù 
.
ùù  
End
ùù  #
(
ùù# $
)
ùù$ %
;
ùù% &
}
ûû 
}
üü 	
}
†† 
public
¢¢ 

void
¢¢ 
StopConsume
¢¢ 
(
¢¢ 
)
¢¢ 
{
££ &
_cancellationTokenSource
§§  
.
§§  !
Cancel
§§! '
(
§§' (
)
§§( )
;
§§) *
}
•• 
	protected
ßß 
virtual
ßß 
void
ßß  
OnConsumeException
ßß -
(
ßß- .
ConsumeException
ßß. >
ex
ßß? A
)
ßßA B
{
®® 
Logger
©© 
.
©© 

LogWarning
©© 
(
©© 
$"
©© 
$str
©© V
"
©©V W
)
©©W X
;
©©X Y
}
™™ 
	protected
¨¨ 
virtual
¨¨ 
void
¨¨ 
OnOtherException
¨¨ +
(
¨¨+ ,
	Exception
¨¨, 5
ex
¨¨6 8
)
¨¨8 9
{
≠≠ 
Logger
ÆÆ 
.
ÆÆ 

LogWarning
ÆÆ 
(
ÆÆ 
$"
ÆÆ 
$str
ÆÆ L
"
ÆÆL M
)
ÆÆM N
;
ÆÆN O
}
ØØ 
private
±± 
void
±± *
OnOperationCanceledException
±± -
(
±±- .(
OperationCanceledException
±±. H
ex
±±I K
)
±±K L
{
≤≤ 
lock
≥≥ 
(
≥≥ 
_locker
≥≥ 
)
≥≥ 
{
¥¥ 	
Enabled
µµ 
=
µµ 
false
µµ 
;
µµ 
}
∂∂ 	
}
∑∑ 
	protected
ªª 
abstract
ªª 
Task
ªª 
<
ªª 
bool
ªª  
>
ªª  !
	OnMessage
ªª" +
(
ªª+ ,
ConsumeResult
ªª, 9
<
ªª9 :
Ignore
ªª: @
,
ªª@ A
string
ªªB H
>
ªªH I
e
ªªJ K
)
ªªK L
;
ªªL M
}ºº …¢
XC:\HeroSystem\walletService\WalletService.Core\Kafka\Consumers\ProcessModel1AConsumer.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Kafka

 "
.

" #
	Consumers

# ,
;

, -
public 
class "
ProcessModel1AConsumer #
:$ %
BaseKafkaConsumer& 7
{ 
public 
"
ProcessModel1AConsumer !
(! "
ConsumerSettings 
consumerSettings! 1
,1 2$
ApplicationConfiguration  
configuration! .
,. /
ILogger 
logger! '
,' ( 
IServiceScopeFactory 
serviceScopeFactory! 4
) 
: 
base 
( 
consumerSettings 
, 
configuration ,
,, -
logger. 4
,4 5
serviceScopeFactory6 I
)I J
{K L
}M N
	protected 
override 
Task 
< 
bool  
>  !
	OnMessage" +
(+ ,
ConsumeResult, 9
<9 :
Ignore: @
,@ A
stringB H
>H I
eJ K
)K L
{ 
var 
message 
= 
e 
. 
Message 
.  
Value  %
.% &
ToJsonObject& 2
<2 3
Model1AMessage3 A
>A B
(B C
)C D
;D E
try 
{ 	
Logger 
. 
LogInformation !
(! "
$str" M
)M N
;N O
return 
message 
is 
not !
null" &
?' (
Process) 0
(0 1
message1 8
)8 9
:: ;
Task< @
.@ A

FromResultA K
(K L
falseL Q
)Q R
;R S
} 	
catch 
( 
	Exception 
ex 
) 
{ 	
Logger 
. 
LogError 
( 
$" 
$str J
{J K
exK M
.M N
ToJsonStringN Z
(Z [
)[ \
}\ ]
"] ^
)^ _
;_ `
return   
Task   
.   

FromResult   "
(  " #
false  # (
)  ( )
;  ) *
}!! 	
finally"" 
{## 	
Logger$$ 
.$$ 
LogInformation$$ !
($$! "
$str$$" L
)$$L M
;$$M N
}%% 	
}&& 
private(( 
async(( 
Task(( 
<(( 
bool(( 
>(( 
Process(( $
((($ %
Model1AMessage((% 3
message((4 ;
)((; <
{)) 
using** 
var** 
scope** 
=**# $
ServiceScopeFactory**% 8
.**8 9
CreateScope**9 D
(**D E
)**E F
;**F G
var++ 
walletRepository++ "
=++# $
scope++% *
.++* +
ServiceProvider+++ :
.++: ;

GetService++; E
<++E F
IWalletRepository++F W
>++W X
(++X Y
)++Y Z
;++Z [
var-- 
ecoPoolsType-- 
=-- 
new-- 
List-- #
<--# $
Model1AType--$ /
>--/ 0
(--0 1
)--1 2
;--2 3
var.. 

levelsType.. 
=.. 
new.. 
List.. #
<..# $
Model1ALevelsType..$ 5
>..5 6
(..6 7
)..7 8
;..8 9
var00 
request00 
=00 
new00 %
Model1ATransactionRequest00 3
{11 	"
EcoPoolConfigurationId22 "
=22$ %
message22& -
.22- .
Configuration22. ;
.22; <
Id22< >
,22> ?#
CompanyPercentageLevels33 #
=33$ %
message33& -
.33- .
Configuration33. ;
.33; <#
CompanyPercentageLevels33< S
.33S T
	ToDecimal33T ]
(33] ^
)33^ _
,33_ `
CompanyPercentage44 
=44$ %
message44& -
.44- .
Configuration44. ;
.44; <
CompanyPercentage44< M
.44M N
	ToDecimal44N W
(44W X
)44X Y
,44Y Z
EcoPoolPercentage55 
=55$ %
message55& -
.55- .
Configuration55. ;
.55; <
ModelPercentage55< K
.55K L
	ToDecimal55L U
(55U V
)55V W
,55W X
Points66 
=66$ %
message66& -
.66- .
Points66. 4
,664 5
Case77 
=77$ %
message77& -
.77- .
Configuration77. ;
.77; <
Case77< @
,77@ A!
TotalPercentageLevels88 !
=88$ %
message88& -
.88- .
Configuration88. ;
.88; <$
ModelConfigurationLevels88< T
.88T U
Sum88U X
(88X Y
x88Y Z
=>88[ ]
x88^ _
.88_ `

Percentage88` j
)88j k
}99 	
;99	 

Logger:: 
.:: 
LogInformation:: 
(:: 
$"::  
$str::  R
{::R S
request::S Z
.::Z [
ToJsonString::[ g
(::g h
)::h i
}::i j
"::j k
)::k l
;::l m(
CalculateModelTwoWithInMonth<< $
(<<$ %
message<<% ,
,<<, -

levelsType<<. 8
,<<8 9
ecoPoolsType<<: F
)<<F G
;<<G H)
CalculateModelTwoWithOutMonth== %
(==% &
message==& -
,==- .

levelsType==/ 9
,==9 :
ecoPoolsType==; G
)==G H
;==H I
request?? 
.?? 

LevelsType?? 
=?? 

levelsType?? )
;??) *
request@@ 
.@@ 
EcoPoolsType@@ 
=@@ 
ecoPoolsType@@ +
;@@+ ,
awaitAA 
walletRepositoryAA 
!AA 
.AA  
CreateModel1ASpAA  /
(AA/ 0
requestAA0 7
)AA7 8
;AA8 9
LoggerBB 
.BB 
LogInformationBB 
(BB 
$"BB  
$strBB  [
"BB[ \
)BB\ ]
;BB] ^
returnDD 
trueDD 
;DD 
}EE 
privateGG 
voidGG )
CalculateModelTwoWithOutMonthGG .
(GG. /
Model1AMessageGG/ =
messageGG> E
,GGE F
ListGGG K
<GGK L
Model1ALevelsTypeGGL ]
>GG] ^

levelsTypeGG_ i
,GGi j
ListGGk o
<GGo p
Model1ATypeGGp {
>GG{ |
ecoPoolsType	GG} â
)
GGâ ä
{HH 
foreachII 
(II 
varII 
poolII 
inII 
messageII $
.II$ %
ItemWithOutMonthII% 5
)II5 6
{JJ 	
varKK 
	affiliateKK 
=KK 
messageKK #
.KK# $
ListResultAccountsKK$ 6
.KK6 7
FirstOrDefaultKK7 E
(KKE F
xKKF G
=>KKH J
xKKK L
.KKL M
IdKKM O
==KKP R
poolKKS W
.KKW X
InvoiceKKX _
.KK_ `
AffiliateIdKK` k
)KKk l
;KKl m
varLL 
productLL 
=LL 
messageLL #
.LL# $
ListResultProductsLL$ 6
.LL6 7
FirstOrDefaultLL7 E
(LLE F
xLLF G
=>LLH J
xLLK L
.LLL M
IdLLM O
==LLP R
poolLLS W
.LLW X
	ProductIdLLX a
)LLa b
;LLb c
ifNN 
(NN 
	affiliateNN 
isNN 
nullNN !
)NN! "
{OO 
LoggerPP 
.PP 

LogWarningPP !
(PP! "
$"PP" $
$strPP$ [
{PP[ \
	affiliatePP\ e
.PPe f
ToJsonStringPPf r
(PPr s
)PPs t
}PPt u
"PPu v
)PPv w
;PPw x
continueQQ 
;QQ 
}RR 
ifTT 
(TT 
poolTT 
.TT 
InvoiceTT 
.TT 
DateTT !
isTT" $
nullTT% )
)TT) *
{UU 
LoggerVV 
.VV 

LogWarningVV !
(VV! "
$"VV" $
$strVV$ Z
"VVZ [
)VV[ \
;VV\ ]
continueWW 
;WW 
}XX 
varZZ 
datePoolTempZZ 
=ZZ  !
poolZZ" &
.ZZ& '
InvoiceZZ' .
.ZZ. /
DateZZ/ 3
!ZZ3 4
.ZZ4 5
ValueZZ5 :
;ZZ: ;
var[[ 
firstDayInMonth[[ 
=[[  !
new[[" %
DateTime[[& .
([[. /
datePoolTemp[[/ ;
.[[; <
Year[[< @
,[[@ A
datePoolTemp[[B N
.[[N O
Month[[O T
,[[T U
$num[[V W
)[[W X
;[[X Y
var\\ 
daysInMonth\\ 
=\\  !
DateTime\\" *
.\\* +
DaysInMonth\\+ 6
(\\6 7
datePoolTemp\\7 C
.\\C D
Year\\D H
,\\H I
datePoolTemp\\J V
.\\V W
Month\\W \
)\\\ ]
;\\] ^
var]] 
lastDayInMonth]] 
=]]  !
new]]" %
DateTime]]& .
(]]. /
datePoolTemp]]/ ;
.]]; <
Year]]< @
,]]@ A
datePoolTemp]]B N
.]]N O
Month]]O T
,]]T U
daysInMonth]]V a
,]]a b
$num]]c e
,]]e f
$num]]g i
,]]i j
$num]]k m
)]]m n
;]]n o
var__ 
levelsMapped__ 
=__ 
	affiliate__ (
.__( )

FamilyTree__) 3
.__3 4
Select__4 :
(__: ;
s__; <
=>__= ?
new__@ C
Model1ALevelsType__D U
{`` 

Percentageaa 
=aa 
messageaa  '
.aa' (
Configurationaa( 5
.aa5 6$
ModelConfigurationLevelsaa6 N
.aaN O
FirstOrDefaultaaO ]
(aa] ^
xaa^ _
=>aa` b
xaac d
.aad e
Levelaae j
==aak m
saan o
.aao p
Levelaap u
)aau v
!aav w
.aaw x

Percentage	aax Ç
,
aaÇ É
Levelbb 
=bb 
sbb  !
.bb! "
Levelbb" '
,bb' (
AffiliateIdcc 
=cc 
scc  !
.cc! "
Idcc" $
,cc$ %
PoolIddd 
=dd 
pooldd  $
.dd$ %
Iddd% '
,dd' (
AffiliateNameee 
=ee 
see  !
.ee! "
UserNameee" *
,ee* +
Sideff 
=ff 
sff  !
.ff! "
Sideff" &
,ff& '
UserCreatedAtgg 
=gg 
sgg  !
.gg! "
	CreatedAtgg" +
}hh 
)hh 
.hh 
ToListhh 
(hh 
)hh 
;hh 
varjj 
productNamejj 
=jj 
productjj %
?jj% &
.jj& '
Namejj' +
??jj, .
stringjj/ 5
.jj5 6
Emptyjj6 ;
;jj; <

levelsTypekk 
.kk 
AddRangekk 
(kk  
levelsMappedkk  ,
)kk, -
;kk- .
ecoPoolsTypell 
.ll 
Addll 
(ll 
newll  
Model1ATypell! ,
{mm 
AffiliateIdnn 
=nn" #
	affiliatenn$ -
.nn- .
Idnn. 0
,nn0 1
AffiliateUserNameoo !
=oo" #
	affiliateoo$ -
.oo- .
UserNameoo. 6
,oo6 7
PoolIdpp 
=pp" #
poolpp$ (
.pp( )
Idpp) +
,pp+ ,
	CountDaysqq 
=qq" #
daysInMonthqq$ /
,qq/ 0
DaysInMonthrr 
=rr" #
daysInMonthrr$ /
,rr/ 0
Amountss 
=ss" #
poolss$ (
.ss( )

BaseAmountss) 3
!ss3 4
.ss4 5
Valuess5 :
,ss: ;
LastDayDatett 
=tt" #
lastDayInMonthtt$ 2
,tt2 3
PaymentDateuu 
=uu" #
firstDayInMonthuu$ 3
,uu3 4
ProductExternalIdvv !
=vv" #
poolvv$ (
.vv( )
	ProductIdvv) 2
,vv2 3
ProductNameww 
=ww" #
productNameww$ /
,ww/ 0
UserCreatedAtxx 
=xx" #
	affiliatexx$ -
.xx- .
	CreatedAtxx. 7
}yy 
)yy 
;yy 
}zz 	
}{{ 
private}} 
void}} (
CalculateModelTwoWithInMonth}} -
(}}- .
Model1AMessage}}. <
message}}= D
,}}D E
List}}F J
<}}J K
Model1ALevelsType}}K \
>}}\ ]

levelsType}}^ h
,}}h i
List}}j n
<}}n o
Model1AType}}o z
>}}z {
ecoPoolsType	}}| à
)
}}à â
{~~ 
foreach 
( 
var 
pool 
in 
message $
.$ %
ItemWithInMonth% 4
)4 5
{
ÄÄ 	
var
ÅÅ 
	affiliate
ÅÅ 
=
ÅÅ 
message
ÅÅ #
.
ÅÅ# $ 
ListResultAccounts
ÅÅ$ 6
.
ÅÅ6 7
FirstOrDefault
ÅÅ7 E
(
ÅÅE F
x
ÅÅF G
=>
ÅÅH J
x
ÅÅK L
.
ÅÅL M
Id
ÅÅM O
==
ÅÅP R
pool
ÅÅS W
.
ÅÅW X
Invoice
ÅÅX _
.
ÅÅ_ `
AffiliateId
ÅÅ` k
)
ÅÅk l
;
ÅÅl m
var
ÇÇ 
product
ÇÇ 
=
ÇÇ 
message
ÇÇ #
.
ÇÇ# $ 
ListResultProducts
ÇÇ$ 6
.
ÇÇ6 7
FirstOrDefault
ÇÇ7 E
(
ÇÇE F
x
ÇÇF G
=>
ÇÇH J
x
ÇÇK L
.
ÇÇL M
Id
ÇÇM O
==
ÇÇP R
pool
ÇÇS W
.
ÇÇW X
	ProductId
ÇÇX a
)
ÇÇa b
;
ÇÇb c
var
ÉÉ 
	daysDelay
ÉÉ 
=
ÉÉ 
product
ÉÉ #
?
ÉÉ# $
.
ÉÉ$ %
DaysWait
ÉÉ% -
??
ÉÉ. 0
$num
ÉÉ1 2
;
ÉÉ2 3
if
ÜÜ 
(
ÜÜ 
	affiliate
ÜÜ 
is
ÜÜ 
null
ÜÜ !
)
ÜÜ! "
{
áá 
Logger
àà 
.
àà 

LogWarning
àà !
(
àà! "
$"
àà" $
$str
àà$ [
{
àà[ \
	affiliate
àà\ e
.
ààe f
ToJsonString
ààf r
(
ààr s
)
ààs t
}
ààt u
"
ààu v
)
ààv w
;
ààw x
continue
ââ 
;
ââ 
}
ää 
if
åå 
(
åå 
pool
åå 
.
åå 
Invoice
åå 
.
åå 
Date
åå !
is
åå" $
null
åå% )
)
åå) *
{
çç 
Logger
éé 
.
éé 

LogWarning
éé !
(
éé! "
$"
éé" $
$str
éé$ Z
"
ééZ [
)
éé[ \
;
éé\ ]
continue
èè 
;
èè 
}
êê 
var
íí 
datePoolTemp
íí 
=
íí 
pool
íí #
.
íí# $
Invoice
íí$ +
.
íí+ ,
Date
íí, 0
!
íí0 1
.
íí1 2
Value
íí2 7
.
íí7 8
AddDays
íí8 ?
(
íí? @
	daysDelay
íí@ I
)
ííI J
;
ííJ K
var
ìì 
	firstDate
ìì 
=
ìì 
new
ìì "
DateTime
ìì# +
(
ìì+ ,
datePoolTemp
ìì, 8
.
ìì8 9
Year
ìì9 =
,
ìì= >
datePoolTemp
ìì? K
.
ììK L
Month
ììL Q
,
ììQ R
datePoolTemp
ììS _
.
ìì_ `
Day
ìì` c
,
ììc d
$num
ììe g
,
ììg h
$num
ììi k
,
ììk l
$num
ììm o
)
ììo p
;
ììp q
var
îî 
	countDays
îî 
=
îî 
message
îî &
.
îî& '
EndDate
îî' .
.
îî. /
Subtract
îî/ 7
(
îî7 8
	firstDate
îî8 A
)
îîA B
.
îîB C
Days
îîC G
+
îîH I
$num
îîJ K
;
îîK L
var
ïï 
daysInMonth
ïï 
=
ïï 
message
ïï &
.
ïï& '
EndDate
ïï' .
.
ïï. /
Subtract
ïï/ 7
(
ïï7 8
message
ïï8 ?
.
ïï? @
StarDate
ïï@ H
)
ïïH I
.
ïïI J
Days
ïïJ N
+
ïïO P
$num
ïïQ R
;
ïïR S
var
óó 
levelsMapped
óó 
=
óó 
	affiliate
óó (
.
óó( )

FamilyTree
óó) 3
.
óó3 4
Select
óó4 :
(
óó: ;
s
óó; <
=>
óó= ?
new
óó@ C
Model1ALevelsType
óóD U
{
òò 

Percentage
ôô 
=
ôô 
message
ôô  '
.
ôô' (
Configuration
ôô( 5
.
ôô5 6&
ModelConfigurationLevels
ôô6 N
.
ôôN O
FirstOrDefault
ôôO ]
(
ôô] ^
x
ôô^ _
=>
ôô` b
x
ôôc d
.
ôôd e
Level
ôôe j
==
ôôk m
s
ôôn o
.
ôôo p
Level
ôôp u
)
ôôu v
!
ôôv w
.
ôôw x

Percentageôôx Ç
,ôôÇ É
Level
öö 
=
öö 
s
öö  !
.
öö! "
Level
öö" '
,
öö' (
PoolId
õõ 
=
õõ 
pool
õõ  $
.
õõ$ %
Id
õõ% '
,
õõ' (
AffiliateId
úú 
=
úú 
s
úú  !
.
úú! "
Id
úú" $
,
úú$ %
AffiliateName
ùù 
=
ùù 
s
ùù  !
.
ùù! "
UserName
ùù" *
,
ùù* +
Side
ûû 
=
ûû 
s
ûû  !
.
ûû! "
Side
ûû" &
,
ûû& '
UserCreatedAt
üü 
=
üü 
s
üü  !
.
üü! "
	CreatedAt
üü" +
}
†† 
)
†† 
.
†† 
ToList
†† 
(
†† 
)
†† 
;
†† 
var
¢¢ 
productName
¢¢ 
=
¢¢ 
product
¢¢ %
?
¢¢% &
.
¢¢& '
Name
¢¢' +
??
¢¢, .
string
¢¢/ 5
.
¢¢5 6
Empty
¢¢6 ;
;
¢¢; <

levelsType
££ 
.
££ 
AddRange
££ 
(
££  
levelsMapped
££  ,
)
££, -
;
££- .
ecoPoolsType
§§ 
.
§§ 
Add
§§ 
(
§§ 
new
§§  
Model1AType
§§! ,
{
•• 
AffiliateId
¶¶ 
=
¶¶" #
	affiliate
¶¶$ -
.
¶¶- .
Id
¶¶. 0
,
¶¶0 1
AffiliateUserName
ßß !
=
ßß" #
	affiliate
ßß$ -
.
ßß- .
UserName
ßß. 6
,
ßß6 7
PoolId
®® 
=
®®" #
pool
®®$ (
.
®®( )
Id
®®) +
,
®®+ ,
	CountDays
©© 
=
©©" #
	countDays
©©$ -
,
©©- .
DaysInMonth
™™ 
=
™™" #
daysInMonth
™™$ /
,
™™/ 0
Amount
´´ 
=
´´" #
pool
´´$ (
.
´´( )

BaseAmount
´´) 3
!
´´3 4
.
´´4 5
Value
´´5 :
,
´´: ;
LastDayDate
¨¨ 
=
¨¨" #
message
¨¨$ +
.
¨¨+ ,
Configuration
¨¨, 9
.
¨¨9 :
DateEnd
¨¨: A
,
¨¨A B
PaymentDate
≠≠ 
=
≠≠" #
	firstDate
≠≠$ -
,
≠≠- .
ProductExternalId
ÆÆ !
=
ÆÆ" #
pool
ÆÆ$ (
.
ÆÆ( )
	ProductId
ÆÆ) 2
,
ÆÆ2 3
ProductName
ØØ 
=
ØØ" #
productName
ØØ$ /
,
ØØ/ 0
UserCreatedAt
∞∞ 
=
∞∞" #
	affiliate
∞∞$ -
.
∞∞- .
	CreatedAt
∞∞. 7
}
±± 
)
±± 
;
±± 
}
≤≤ 	
}
≥≥ 
}¥¥ …¢
XC:\HeroSystem\walletService\WalletService.Core\Kafka\Consumers\ProcessModel1BConsumer.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Kafka

 "
.

" #
	Consumers

# ,
;

, -
public 
class "
ProcessModel1BConsumer #
:$ %
BaseKafkaConsumer& 7
{ 
public 
"
ProcessModel1BConsumer !
(! "
ConsumerSettings 
consumerSettings! 1
,1 2$
ApplicationConfiguration  
configuration! .
,. /
ILogger 
logger! '
,' ( 
IServiceScopeFactory 
serviceScopeFactory! 4
) 
: 
base 
( 
consumerSettings 
, 
configuration ,
,, -
logger. 4
,4 5
serviceScopeFactory6 I
)I J
{K L
}M N
	protected 
override 
Task 
< 
bool  
>  !
	OnMessage" +
(+ ,
ConsumeResult, 9
<9 :
Ignore: @
,@ A
stringB H
>H I
eJ K
)K L
{ 
var 
message 
= 
e 
. 
Message 
.  
Value  %
.% &
ToJsonObject& 2
<2 3
Model1BMessage3 A
>A B
(B C
)C D
;D E
try 
{ 	
Logger 
. 
LogInformation !
(! "
$str" M
)M N
;N O
return 
message 
is 
not !
null" &
?' (
Process) 0
(0 1
message1 8
)8 9
:: ;
Task< @
.@ A

FromResultA K
(K L
falseL Q
)Q R
;R S
} 	
catch 
( 
	Exception 
ex 
) 
{ 	
Logger 
. 
LogError 
( 
$" 
$str J
{J K
exK M
.M N
ToJsonStringN Z
(Z [
)[ \
}\ ]
"] ^
)^ _
;_ `
return   
Task   
.   

FromResult   "
(  " #
false  # (
)  ( )
;  ) *
}!! 	
finally"" 
{## 	
Logger$$ 
.$$ 
LogInformation$$ !
($$! "
$str$$" L
)$$L M
;$$M N
}%% 	
}&& 
private(( 
async(( 
Task(( 
<(( 
bool(( 
>(( 
Process(( $
((($ %
Model1BMessage((% 3
message((4 ;
)((; <
{)) 
using** 
var** 
scope** 
=**# $
ServiceScopeFactory**% 8
.**8 9
CreateScope**9 D
(**D E
)**E F
;**F G
var++ 
walletRepository++ "
=++# $
scope++% *
.++* +
ServiceProvider+++ :
.++: ;

GetService++; E
<++E F
IWalletRepository++F W
>++W X
(++X Y
)++Y Z
;++Z [
var-- 
ecoPoolsType-- 
=-- 
new-- 
List-- #
<--# $
Model1BType--$ /
>--/ 0
(--0 1
)--1 2
;--2 3
var.. 

levelsType.. 
=.. 
new.. 
List.. #
<..# $
Model1BLevelsType..$ 5
>..5 6
(..6 7
)..7 8
;..8 9
var00 
request00 
=00 
new00 %
Model1BTransactionRequest00 3
{11 	"
EcoPoolConfigurationId22 "
=22$ %
message22& -
.22- .
Configuration22. ;
.22; <
Id22< >
,22> ?#
CompanyPercentageLevels33 #
=33$ %
message33& -
.33- .
Configuration33. ;
.33; <#
CompanyPercentageLevels33< S
.33S T
	ToDecimal33T ]
(33] ^
)33^ _
,33_ `
CompanyPercentage44 
=44$ %
message44& -
.44- .
Configuration44. ;
.44; <
CompanyPercentage44< M
.44M N
	ToDecimal44N W
(44W X
)44X Y
,44Y Z
EcoPoolPercentage55 
=55$ %
message55& -
.55- .
Configuration55. ;
.55; <
ModelPercentage55< K
.55K L
	ToDecimal55L U
(55U V
)55V W
,55W X
Points66 
=66$ %
message66& -
.66- .
Points66. 4
,664 5
Case77 
=77$ %
message77& -
.77- .
Configuration77. ;
.77; <
Case77< @
,77@ A!
TotalPercentageLevels88 !
=88$ %
message88& -
.88- .
Configuration88. ;
.88; <$
ModelConfigurationLevels88< T
.88T U
Sum88U X
(88X Y
x88Y Z
=>88[ ]
x88^ _
.88_ `

Percentage88` j
)88j k
}99 	
;99	 

Logger:: 
.:: 
LogInformation:: 
(:: 
$"::  
$str::  R
{::R S
request::S Z
.::Z [
ToJsonString::[ g
(::g h
)::h i
}::i j
"::j k
)::k l
;::l m(
CalculateModelTwoWithInMonth<< $
(<<$ %
message<<% ,
,<<, -

levelsType<<. 8
,<<8 9
ecoPoolsType<<: F
)<<F G
;<<G H)
CalculateModelTwoWithOutMonth== %
(==% &
message==& -
,==- .

levelsType==/ 9
,==9 :
ecoPoolsType==; G
)==G H
;==H I
request?? 
.?? 

LevelsType?? 
=?? 

levelsType?? )
;??) *
request@@ 
.@@ 
EcoPoolsType@@ 
=@@ 
ecoPoolsType@@ +
;@@+ ,
awaitAA 
walletRepositoryAA 
!AA 
.AA  
CreateModel1BSpAA  /
(AA/ 0
requestAA0 7
)AA7 8
;AA8 9
LoggerBB 
.BB 
LogInformationBB 
(BB 
$"BB  
$strBB  [
"BB[ \
)BB\ ]
;BB] ^
returnDD 
trueDD 
;DD 
}EE 
privateGG 
voidGG )
CalculateModelTwoWithOutMonthGG .
(GG. /
Model1BMessageGG/ =
messageGG> E
,GGE F
ListGGG K
<GGK L
Model1BLevelsTypeGGL ]
>GG] ^

levelsTypeGG_ i
,GGi j
ListGGk o
<GGo p
Model1BTypeGGp {
>GG{ |
ecoPoolsType	GG} â
)
GGâ ä
{HH 
foreachII 
(II 
varII 
poolII 
inII 
messageII $
.II$ %
ItemWithOutMonthII% 5
)II5 6
{JJ 	
varKK 
	affiliateKK 
=KK 
messageKK #
.KK# $
ListResultAccountsKK$ 6
.KK6 7
FirstOrDefaultKK7 E
(KKE F
xKKF G
=>KKH J
xKKK L
.KKL M
IdKKM O
==KKP R
poolKKS W
.KKW X
InvoiceKKX _
.KK_ `
AffiliateIdKK` k
)KKk l
;KKl m
varLL 
productLL 
=LL 
messageLL #
.LL# $
ListResultProductsLL$ 6
.LL6 7
FirstOrDefaultLL7 E
(LLE F
xLLF G
=>LLH J
xLLK L
.LLL M
IdLLM O
==LLP R
poolLLS W
.LLW X
	ProductIdLLX a
)LLa b
;LLb c
ifNN 
(NN 
	affiliateNN 
isNN 
nullNN !
)NN! "
{OO 
LoggerPP 
.PP 

LogWarningPP !
(PP! "
$"PP" $
$strPP$ [
{PP[ \
	affiliatePP\ e
.PPe f
ToJsonStringPPf r
(PPr s
)PPs t
}PPt u
"PPu v
)PPv w
;PPw x
continueQQ 
;QQ 
}RR 
ifTT 
(TT 
poolTT 
.TT 
InvoiceTT 
.TT 
DateTT !
isTT" $
nullTT% )
)TT) *
{UU 
LoggerVV 
.VV 

LogWarningVV !
(VV! "
$"VV" $
$strVV$ Z
"VVZ [
)VV[ \
;VV\ ]
continueWW 
;WW 
}XX 
varZZ 
datePoolTempZZ 
=ZZ  !
poolZZ" &
.ZZ& '
InvoiceZZ' .
.ZZ. /
DateZZ/ 3
!ZZ3 4
.ZZ4 5
ValueZZ5 :
;ZZ: ;
var[[ 
firstDayInMonth[[ 
=[[  !
new[[" %
DateTime[[& .
([[. /
datePoolTemp[[/ ;
.[[; <
Year[[< @
,[[@ A
datePoolTemp[[B N
.[[N O
Month[[O T
,[[T U
$num[[V W
)[[W X
;[[X Y
var\\ 
daysInMonth\\ 
=\\  !
DateTime\\" *
.\\* +
DaysInMonth\\+ 6
(\\6 7
datePoolTemp\\7 C
.\\C D
Year\\D H
,\\H I
datePoolTemp\\J V
.\\V W
Month\\W \
)\\\ ]
;\\] ^
var]] 
lastDayInMonth]] 
=]]  !
new]]" %
DateTime]]& .
(]]. /
datePoolTemp]]/ ;
.]]; <
Year]]< @
,]]@ A
datePoolTemp]]B N
.]]N O
Month]]O T
,]]T U
daysInMonth]]V a
,]]a b
$num]]c e
,]]e f
$num]]g i
,]]i j
$num]]k m
)]]m n
;]]n o
var__ 
levelsMapped__ 
=__ 
	affiliate__ (
.__( )

FamilyTree__) 3
.__3 4
Select__4 :
(__: ;
s__; <
=>__= ?
new__@ C
Model1BLevelsType__D U
{`` 

Percentageaa 
=aa 
messageaa  '
.aa' (
Configurationaa( 5
.aa5 6$
ModelConfigurationLevelsaa6 N
.aaN O
FirstOrDefaultaaO ]
(aa] ^
xaa^ _
=>aa` b
xaac d
.aad e
Levelaae j
==aak m
saan o
.aao p
Levelaap u
)aau v
!aav w
.aaw x

Percentage	aax Ç
,
aaÇ É
Levelbb 
=bb 
sbb  !
.bb! "
Levelbb" '
,bb' (
AffiliateIdcc 
=cc 
scc  !
.cc! "
Idcc" $
,cc$ %
PoolIddd 
=dd 
pooldd  $
.dd$ %
Iddd% '
,dd' (
AffiliateNameee 
=ee 
see  !
.ee! "
UserNameee" *
,ee* +
Sideff 
=ff 
sff  !
.ff! "
Sideff" &
,ff& '
UserCreatedAtgg 
=gg 
sgg  !
.gg! "
	CreatedAtgg" +
}hh 
)hh 
.hh 
ToListhh 
(hh 
)hh 
;hh 
varjj 
productNamejj 
=jj 
productjj %
?jj% &
.jj& '
Namejj' +
??jj, .
stringjj/ 5
.jj5 6
Emptyjj6 ;
;jj; <

levelsTypekk 
.kk 
AddRangekk 
(kk  
levelsMappedkk  ,
)kk, -
;kk- .
ecoPoolsTypell 
.ll 
Addll 
(ll 
newll  
Model1BTypell! ,
{mm 
AffiliateIdnn 
=nn" #
	affiliatenn$ -
.nn- .
Idnn. 0
,nn0 1
AffiliateUserNameoo !
=oo" #
	affiliateoo$ -
.oo- .
UserNameoo. 6
,oo6 7
PoolIdpp 
=pp" #
poolpp$ (
.pp( )
Idpp) +
,pp+ ,
	CountDaysqq 
=qq" #
daysInMonthqq$ /
,qq/ 0
DaysInMonthrr 
=rr" #
daysInMonthrr$ /
,rr/ 0
Amountss 
=ss" #
poolss$ (
.ss( )

BaseAmountss) 3
!ss3 4
.ss4 5
Valuess5 :
,ss: ;
LastDayDatett 
=tt" #
lastDayInMonthtt$ 2
,tt2 3
PaymentDateuu 
=uu" #
firstDayInMonthuu$ 3
,uu3 4
ProductExternalIdvv !
=vv" #
poolvv$ (
.vv( )
	ProductIdvv) 2
,vv2 3
ProductNameww 
=ww" #
productNameww$ /
,ww/ 0
UserCreatedAtxx 
=xx" #
	affiliatexx$ -
.xx- .
	CreatedAtxx. 7
}yy 
)yy 
;yy 
}zz 	
}{{ 
private}} 
void}} (
CalculateModelTwoWithInMonth}} -
(}}- .
Model1BMessage}}. <
message}}= D
,}}D E
List}}F J
<}}J K
Model1BLevelsType}}K \
>}}\ ]

levelsType}}^ h
,}}h i
List}}j n
<}}n o
Model1BType}}o z
>}}z {
ecoPoolsType	}}| à
)
}}à â
{~~ 
foreach 
( 
var 
pool 
in 
message $
.$ %
ItemWithInMonth% 4
)4 5
{
ÄÄ 	
var
ÅÅ 
	affiliate
ÅÅ 
=
ÅÅ 
message
ÅÅ #
.
ÅÅ# $ 
ListResultAccounts
ÅÅ$ 6
.
ÅÅ6 7
FirstOrDefault
ÅÅ7 E
(
ÅÅE F
x
ÅÅF G
=>
ÅÅH J
x
ÅÅK L
.
ÅÅL M
Id
ÅÅM O
==
ÅÅP R
pool
ÅÅS W
.
ÅÅW X
Invoice
ÅÅX _
.
ÅÅ_ `
AffiliateId
ÅÅ` k
)
ÅÅk l
;
ÅÅl m
var
ÇÇ 
product
ÇÇ 
=
ÇÇ 
message
ÇÇ #
.
ÇÇ# $ 
ListResultProducts
ÇÇ$ 6
.
ÇÇ6 7
FirstOrDefault
ÇÇ7 E
(
ÇÇE F
x
ÇÇF G
=>
ÇÇH J
x
ÇÇK L
.
ÇÇL M
Id
ÇÇM O
==
ÇÇP R
pool
ÇÇS W
.
ÇÇW X
	ProductId
ÇÇX a
)
ÇÇa b
;
ÇÇb c
var
ÉÉ 
	daysDelay
ÉÉ 
=
ÉÉ 
product
ÉÉ #
?
ÉÉ# $
.
ÉÉ$ %
DaysWait
ÉÉ% -
??
ÉÉ. 0
$num
ÉÉ1 2
;
ÉÉ2 3
if
ÖÖ 
(
ÖÖ 
	affiliate
ÖÖ 
is
ÖÖ 
null
ÖÖ !
)
ÖÖ! "
{
ÜÜ 
Logger
áá 
.
áá 

LogWarning
áá !
(
áá! "
$"
áá" $
$str
áá$ [
{
áá[ \
	affiliate
áá\ e
.
ááe f
ToJsonString
ááf r
(
áár s
)
áás t
}
áát u
"
ááu v
)
ááv w
;
ááw x
continue
àà 
;
àà 
}
ââ 
if
ãã 
(
ãã 
pool
ãã 
.
ãã 
Invoice
ãã 
.
ãã 
Date
ãã !
is
ãã" $
null
ãã% )
)
ãã) *
{
åå 
Logger
çç 
.
çç 

LogWarning
çç !
(
çç! "
$"
çç" $
$str
çç$ Z
"
ççZ [
)
çç[ \
;
çç\ ]
continue
éé 
;
éé 
}
èè 
var
ëë 
datePoolTemp
ëë 
=
ëë 
pool
ëë #
.
ëë# $
Invoice
ëë$ +
.
ëë+ ,
Date
ëë, 0
!
ëë0 1
.
ëë1 2
Value
ëë2 7
.
ëë7 8
AddDays
ëë8 ?
(
ëë? @
	daysDelay
ëë@ I
)
ëëI J
;
ëëJ K
var
íí 
	firstDate
íí 
=
íí 
new
íí "
DateTime
íí# +
(
íí+ ,
datePoolTemp
íí, 8
.
íí8 9
Year
íí9 =
,
íí= >
datePoolTemp
íí? K
.
ííK L
Month
ííL Q
,
ííQ R
datePoolTemp
ííS _
.
íí_ `
Day
íí` c
,
ííc d
$num
ííe g
,
ííg h
$num
ííi k
,
íík l
$num
íím o
)
íío p
;
ííp q
var
ìì 
	countDays
ìì 
=
ìì 
message
ìì &
.
ìì& '
EndDate
ìì' .
.
ìì. /
Subtract
ìì/ 7
(
ìì7 8
	firstDate
ìì8 A
)
ììA B
.
ììB C
Days
ììC G
+
ììH I
$num
ììJ K
;
ììK L
var
îî 
daysInMonth
îî 
=
îî 
message
îî &
.
îî& '
EndDate
îî' .
.
îî. /
Subtract
îî/ 7
(
îî7 8
message
îî8 ?
.
îî? @
StarDate
îî@ H
)
îîH I
.
îîI J
Days
îîJ N
+
îîO P
$num
îîQ R
;
îîR S
var
ññ 
levelsMapped
ññ 
=
ññ 
	affiliate
ññ (
.
ññ( )

FamilyTree
ññ) 3
.
ññ3 4
Select
ññ4 :
(
ññ: ;
s
ññ; <
=>
ññ= ?
new
ññ@ C
Model1BLevelsType
ññD U
{
óó 

Percentage
òò 
=
òò 
message
òò  '
.
òò' (
Configuration
òò( 5
.
òò5 6&
ModelConfigurationLevels
òò6 N
.
òòN O
FirstOrDefault
òòO ]
(
òò] ^
x
òò^ _
=>
òò` b
x
òòc d
.
òòd e
Level
òòe j
==
òòk m
s
òòn o
.
òòo p
Level
òòp u
)
òòu v
!
òòv w
.
òòw x

Percentageòòx Ç
,òòÇ É
Level
ôô 
=
ôô 
s
ôô  !
.
ôô! "
Level
ôô" '
,
ôô' (
PoolId
öö 
=
öö 
pool
öö  $
.
öö$ %
Id
öö% '
,
öö' (
AffiliateId
õõ 
=
õõ 
s
õõ  !
.
õõ! "
Id
õõ" $
,
õõ$ %
AffiliateName
úú 
=
úú 
s
úú  !
.
úú! "
UserName
úú" *
,
úú* +
Side
ùù 
=
ùù 
s
ùù  !
.
ùù! "
Side
ùù" &
,
ùù& '
UserCreatedAt
ûû 
=
ûû 
s
ûû  !
.
ûû! "
	CreatedAt
ûû" +
}
üü 
)
üü 
.
üü 
ToList
üü 
(
üü 
)
üü 
;
üü 
var
°° 
productName
°° 
=
°° 
product
°° %
?
°°% &
.
°°& '
Name
°°' +
??
°°, .
string
°°/ 5
.
°°5 6
Empty
°°6 ;
;
°°; <

levelsType
¢¢ 
.
¢¢ 
AddRange
¢¢ 
(
¢¢  
levelsMapped
¢¢  ,
)
¢¢, -
;
¢¢- .
ecoPoolsType
££ 
.
££ 
Add
££ 
(
££ 
new
££  
Model1BType
££! ,
{
§§ 
AffiliateId
•• 
=
••" #
	affiliate
••$ -
.
••- .
Id
••. 0
,
••0 1
AffiliateUserName
¶¶ !
=
¶¶" #
	affiliate
¶¶$ -
.
¶¶- .
UserName
¶¶. 6
,
¶¶6 7
PoolId
ßß 
=
ßß" #
pool
ßß$ (
.
ßß( )
Id
ßß) +
,
ßß+ ,
	CountDays
®® 
=
®®" #
	countDays
®®$ -
,
®®- .
DaysInMonth
©© 
=
©©" #
daysInMonth
©©$ /
,
©©/ 0
Amount
™™ 
=
™™" #
pool
™™$ (
.
™™( )

BaseAmount
™™) 3
!
™™3 4
.
™™4 5
Value
™™5 :
,
™™: ;
LastDayDate
´´ 
=
´´" #
message
´´$ +
.
´´+ ,
Configuration
´´, 9
.
´´9 :
DateEnd
´´: A
,
´´A B
PaymentDate
¨¨ 
=
¨¨" #
	firstDate
¨¨$ -
,
¨¨- .
ProductExternalId
≠≠ !
=
≠≠" #
pool
≠≠$ (
.
≠≠( )
	ProductId
≠≠) 2
,
≠≠2 3
ProductName
ÆÆ 
=
ÆÆ" #
productName
ÆÆ$ /
,
ÆÆ/ 0
UserCreatedAt
ØØ 
=
ØØ" #
	affiliate
ØØ$ -
.
ØØ- .
	CreatedAt
ØØ. 7
}
∞∞ 
)
∞∞ 
;
∞∞ 
}
±± 	
}
≤≤ 
}≥≥ ª¢
WC:\HeroSystem\walletService\WalletService.Core\Kafka\Consumers\ProcessModel2Consumer.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Kafka

 "
.

" #
	Consumers

# ,
;

, -
public 
class !
ProcessModel2Consumer "
:# $
BaseKafkaConsumer% 6
{ 
public 
!
ProcessModel2Consumer  
(  !
ConsumerSettings 
consumerSettings! 1
,1 2$
ApplicationConfiguration  
configuration! .
,. /
ILogger 
logger! '
,' ( 
IServiceScopeFactory 
serviceScopeFactory! 4
) 
: 
base 
( 
consumerSettings 
, 
configuration ,
,, -
logger. 4
,4 5
serviceScopeFactory6 I
)I J
{K L
}M N
	protected 
override 
Task 
< 
bool  
>  !
	OnMessage" +
(+ ,
ConsumeResult, 9
<9 :
Ignore: @
,@ A
stringB H
>H I
eJ K
)K L
{ 
var 
message 
= 
e 
. 
Message 
.  
Value  %
.% &
ToJsonObject& 2
<2 3
Model2Message3 @
>@ A
(A B
)B C
;C D
try 
{ 	
Logger 
. 
LogInformation !
(! "
$str" L
)L M
;M N
return 
message 
is 
not !
null" &
?' (
Process) 0
(0 1
message1 8
)8 9
:: ;
Task< @
.@ A

FromResultA K
(K L
falseL Q
)Q R
;R S
} 	
catch 
( 
	Exception 
ex 
) 
{ 	
Logger 
. 
LogError 
( 
$" 
$str I
{I J
exJ L
.L M
ToJsonStringM Y
(Y Z
)Z [
}[ \
"\ ]
)] ^
;^ _
return   
Task   
.   

FromResult   "
(  " #
false  # (
)  ( )
;  ) *
}!! 	
finally"" 
{## 	
Logger$$ 
.$$ 
LogInformation$$ !
($$! "
$str$$" K
)$$K L
;$$L M
}%% 	
}&& 
private(( 
async(( 
Task(( 
<(( 
bool(( 
>(( 
Process(( $
((($ %
Model2Message((% 2
message((3 :
)((: ;
{)) 
using** 
var** 
scope** 
=**# $
ServiceScopeFactory**% 8
.**8 9
CreateScope**9 D
(**D E
)**E F
;**F G
var++ 
walletRepository++ "
=++# $
scope++% *
.++* +
ServiceProvider+++ :
.++: ;

GetService++; E
<++E F
IWalletRepository++F W
>++W X
(++X Y
)++Y Z
;++Z [
var-- 
ecoPoolsType-- 
=-- 
new-- 
List-- #
<--# $

Model2Type--$ .
>--. /
(--/ 0
)--0 1
;--1 2
var.. 

levelsType.. 
=.. 
new.. 
List.. #
<..# $
Model2LevelsType..$ 4
>..4 5
(..5 6
)..6 7
;..7 8
var00 
request00 
=00 
new00 $
Model2TransactionRequest00 2
{11 	"
EcoPoolConfigurationId22 "
=22$ %
message22& -
.22- .
Configuration22. ;
.22; <
Id22< >
,22> ?#
CompanyPercentageLevels33 #
=33$ %
message33& -
.33- .
Configuration33. ;
.33; <#
CompanyPercentageLevels33< S
.33S T
	ToDecimal33T ]
(33] ^
)33^ _
,33_ `
CompanyPercentage44 
=44$ %
message44& -
.44- .
Configuration44. ;
.44; <
CompanyPercentage44< M
.44M N
	ToDecimal44N W
(44W X
)44X Y
,44Y Z
EcoPoolPercentage55 
=55$ %
message55& -
.55- .
Configuration55. ;
.55; <
ModelPercentage55< K
.55K L
	ToDecimal55L U
(55U V
)55V W
,55W X
Points66 
=66$ %
message66& -
.66- .
Points66. 4
,664 5
Case77 
=77$ %
message77& -
.77- .
Configuration77. ;
.77; <
Case77< @
,77@ A!
TotalPercentageLevels88 !
=88$ %
message88& -
.88- .
Configuration88. ;
.88; <$
ModelConfigurationLevels88< T
.88T U
Sum88U X
(88X Y
x88Y Z
=>88[ ]
x88^ _
.88_ `

Percentage88` j
)88j k
}99 	
;99	 

Logger:: 
.:: 
LogInformation:: 
(:: 
$"::  
$str::  Q
{::Q R
request::R Y
.::Y Z
ToJsonString::Z f
(::f g
)::g h
}::h i
"::i j
)::j k
;::k l(
CalculateModelTwoWithInMonth<< $
(<<$ %
message<<% ,
,<<, -

levelsType<<. 8
,<<8 9
ecoPoolsType<<: F
)<<F G
;<<G H)
CalculateModelTwoWithOutMonth== %
(==% &
message==& -
,==- .

levelsType==/ 9
,==9 :
ecoPoolsType==; G
)==G H
;==H I
request?? 
.?? 

LevelsType?? 
=?? 

levelsType?? )
;??) *
request@@ 
.@@ 
EcoPoolsType@@ 
=@@ 
ecoPoolsType@@ +
;@@+ ,
awaitAA 
walletRepositoryAA 
!AA 
.AA  
CreateModel2SpAA  .
(AA. /
requestAA/ 6
)AA6 7
;AA7 8
LoggerBB 
.BB 
LogInformationBB 
(BB 
$"BB  
$strBB  Z
"BBZ [
)BB[ \
;BB\ ]
returnDD 
trueDD 
;DD 
}EE 
privateGG 
voidGG )
CalculateModelTwoWithOutMonthGG .
(GG. /
Model2MessageGG/ <
messageGG= D
,GGD E
ListGGF J
<GGJ K
Model2LevelsTypeGGK [
>GG[ \

levelsTypeGG] g
,GGg h
ListGGi m
<GGm n

Model2TypeGGn x
>GGx y
ecoPoolsType	GGz Ü
)
GGÜ á
{HH 
foreachII 
(II 
varII 
poolII 
inII 
messageII $
.II$ %
ItemWithOutMonthII% 5
)II5 6
{JJ 	
varKK 
	affiliateKK 
=KK 
messageKK #
.KK# $
ListResultAccountsKK$ 6
.KK6 7
FirstOrDefaultKK7 E
(KKE F
xKKF G
=>KKH J
xKKK L
.KKL M
IdKKM O
==KKP R
poolKKS W
.KKW X
InvoiceKKX _
.KK_ `
AffiliateIdKK` k
)KKk l
;KKl m
varLL 
productLL 
=LL 
messageLL #
.LL# $
ListResultProductsLL$ 6
.LL6 7
FirstOrDefaultLL7 E
(LLE F
xLLF G
=>LLH J
xLLK L
.LLL M
IdLLM O
==LLP R
poolLLS W
.LLW X
	ProductIdLLX a
)LLa b
;LLb c
ifNN 
(NN 
	affiliateNN 
isNN 
nullNN !
)NN! "
{OO 
LoggerPP 
.PP 

LogWarningPP !
(PP! "
$"PP" $
$strPP$ e
{PPe f
	affiliatePPf o
.PPo p
ToJsonStringPPp |
(PP| }
)PP} ~
}PP~ 
"	PP Ä
)
PPÄ Å
;
PPÅ Ç
continueQQ 
;QQ 
}RR 
ifTT 
(TT 
poolTT 
.TT 
InvoiceTT 
.TT 
DateTT !
isTT" $
nullTT% )
)TT) *
{UU 
LoggerVV 
.VV 

LogWarningVV !
(VV! "
$"VV" $
$strVV$ d
"VVd e
)VVe f
;VVf g
continueWW 
;WW 
}XX 
varZZ 
datePoolTempZZ 
=ZZ  !
poolZZ" &
.ZZ& '
InvoiceZZ' .
.ZZ. /
DateZZ/ 3
!ZZ3 4
.ZZ4 5
ValueZZ5 :
;ZZ: ;
var[[ 
firstDayInMonth[[ 
=[[  !
new[[" %
DateTime[[& .
([[. /
datePoolTemp[[/ ;
.[[; <
Year[[< @
,[[@ A
datePoolTemp[[B N
.[[N O
Month[[O T
,[[T U
$num[[V W
)[[W X
;[[X Y
var\\ 
daysInMonth\\ 
=\\  !
DateTime\\" *
.\\* +
DaysInMonth\\+ 6
(\\6 7
datePoolTemp\\7 C
.\\C D
Year\\D H
,\\H I
datePoolTemp\\J V
.\\V W
Month\\W \
)\\\ ]
;\\] ^
var]] 
lastDayInMonth]] 
=]]  !
new]]" %
DateTime]]& .
(]]. /
datePoolTemp]]/ ;
.]]; <
Year]]< @
,]]@ A
datePoolTemp]]B N
.]]N O
Month]]O T
,]]T U
daysInMonth]]V a
,]]a b
$num]]c e
,]]e f
$num]]g i
,]]i j
$num]]k m
)]]m n
;]]n o
var__ 
levelsMapped__ 
=__ 
	affiliate__ (
.__( )

FamilyTree__) 3
.__3 4
Select__4 :
(__: ;
s__; <
=>__= ?
new__@ C
Model2LevelsType__D T
{`` 

Percentageaa 
=aa 
messageaa  '
.aa' (
Configurationaa( 5
.aa5 6$
ModelConfigurationLevelsaa6 N
.aaN O
FirstOrDefaultaaO ]
(aa] ^
xaa^ _
=>aa` b
xaac d
.aad e
Levelaae j
==aak m
saan o
.aao p
Levelaap u
)aau v
!aav w
.aaw x

Percentage	aax Ç
,
aaÇ É
Levelbb 
=bb 
sbb  !
.bb! "
Levelbb" '
,bb' (
AffiliateIdcc 
=cc 
scc  !
.cc! "
Idcc" $
,cc$ %
PoolIddd 
=dd 
pooldd  $
.dd$ %
Iddd% '
,dd' (
AffiliateNameee 
=ee 
see  !
.ee! "
UserNameee" *
,ee* +
Sideff 
=ff 
sff  !
.ff! "
Sideff" &
,ff& '
UserCreatedAtgg 
=gg 
sgg  !
.gg! "
	CreatedAtgg" +
}hh 
)hh 
.hh 
ToListhh 
(hh 
)hh 
;hh 
varjj 
productNamejj 
=jj 
productjj %
?jj% &
.jj& '
Namejj' +
??jj, .
stringjj/ 5
.jj5 6
Emptyjj6 ;
;jj; <

levelsTypekk 
.kk 
AddRangekk 
(kk  
levelsMappedkk  ,
)kk, -
;kk- .
ecoPoolsTypell 
.ll 
Addll 
(ll 
newll  

Model2Typell! +
{mm 
AffiliateIdnn 
=nn" #
	affiliatenn$ -
.nn- .
Idnn. 0
,nn0 1
AffiliateUserNameoo !
=oo" #
	affiliateoo$ -
.oo- .
UserNameoo. 6
,oo6 7
PoolIdpp 
=pp" #
poolpp$ (
.pp( )
Idpp) +
,pp+ ,
	CountDaysqq 
=qq" #
daysInMonthqq$ /
,qq/ 0
DaysInMonthrr 
=rr" #
daysInMonthrr$ /
,rr/ 0
Amountss 
=ss" #
poolss$ (
.ss( )

BaseAmountss) 3
!ss3 4
.ss4 5
Valuess5 :
,ss: ;
LastDayDatett 
=tt" #
lastDayInMonthtt$ 2
,tt2 3
PaymentDateuu 
=uu" #
firstDayInMonthuu$ 3
,uu3 4
ProductExternalIdvv !
=vv" #
poolvv$ (
.vv( )
	ProductIdvv) 2
,vv2 3
ProductNameww 
=ww" #
productNameww$ /
,ww/ 0
UserCreatedAtxx 
=xx" #
	affiliatexx$ -
.xx- .
	CreatedAtxx. 7
}yy 
)yy 
;yy 
}zz 	
}{{ 
private}} 
void}} (
CalculateModelTwoWithInMonth}} -
(}}- .
Model2Message}}. ;
message}}< C
,}}C D
List}}E I
<}}I J
Model2LevelsType}}J Z
>}}Z [

levelsType}}\ f
,}}f g
List}}h l
<}}l m

Model2Type}}m w
>}}w x
ecoPoolsType	}}y Ö
)
}}Ö Ü
{~~ 
foreach 
( 
var 
pool 
in 
message $
.$ %
ItemWithInMonth% 4
)4 5
{
ÄÄ 	
var
ÅÅ 
	affiliate
ÅÅ 
=
ÅÅ 
message
ÅÅ #
.
ÅÅ# $ 
ListResultAccounts
ÅÅ$ 6
.
ÅÅ6 7
FirstOrDefault
ÅÅ7 E
(
ÅÅE F
x
ÅÅF G
=>
ÅÅH J
x
ÅÅK L
.
ÅÅL M
Id
ÅÅM O
==
ÅÅP R
pool
ÅÅS W
.
ÅÅW X
Invoice
ÅÅX _
.
ÅÅ_ `
AffiliateId
ÅÅ` k
)
ÅÅk l
;
ÅÅl m
var
ÇÇ 
product
ÇÇ 
=
ÇÇ 
message
ÇÇ #
.
ÇÇ# $ 
ListResultProducts
ÇÇ$ 6
.
ÇÇ6 7
FirstOrDefault
ÇÇ7 E
(
ÇÇE F
x
ÇÇF G
=>
ÇÇH J
x
ÇÇK L
.
ÇÇL M
Id
ÇÇM O
==
ÇÇP R
pool
ÇÇS W
.
ÇÇW X
	ProductId
ÇÇX a
)
ÇÇa b
;
ÇÇb c
var
ÉÉ 
	daysDelay
ÉÉ 
=
ÉÉ 
product
ÉÉ #
?
ÉÉ# $
.
ÉÉ$ %
DaysWait
ÉÉ% -
??
ÉÉ. 0
$num
ÉÉ1 2
;
ÉÉ2 3
if
ÖÖ 
(
ÖÖ 
	affiliate
ÖÖ 
is
ÖÖ 
null
ÖÖ !
)
ÖÖ! "
{
ÜÜ 
Logger
áá 
.
áá 

LogWarning
áá !
(
áá! "
$"
áá" $
$str
áá$ Z
{
ááZ [
	affiliate
áá[ d
.
áád e
ToJsonString
ááe q
(
ááq r
)
áár s
}
áás t
"
áát u
)
ááu v
;
ááv w
continue
àà 
;
àà 
}
ââ 
if
ãã 
(
ãã 
pool
ãã 
.
ãã 
Invoice
ãã 
.
ãã 
Date
ãã !
is
ãã" $
null
ãã% )
)
ãã) *
{
åå 
Logger
çç 
.
çç 

LogWarning
çç !
(
çç! "
$"
çç" $
$str
çç$ Y
"
ççY Z
)
ççZ [
;
çç[ \
continue
éé 
;
éé 
}
èè 
var
ëë 
datePoolTemp
ëë 
=
ëë 
pool
ëë #
.
ëë# $
Invoice
ëë$ +
.
ëë+ ,
Date
ëë, 0
!
ëë0 1
.
ëë1 2
Value
ëë2 7
.
ëë7 8
AddDays
ëë8 ?
(
ëë? @
	daysDelay
ëë@ I
)
ëëI J
;
ëëJ K
var
íí 
	firstDate
íí 
=
íí 
new
íí "
DateTime
íí# +
(
íí+ ,
datePoolTemp
íí, 8
.
íí8 9
Year
íí9 =
,
íí= >
datePoolTemp
íí? K
.
ííK L
Month
ííL Q
,
ííQ R
datePoolTemp
ííS _
.
íí_ `
Day
íí` c
,
ííc d
$num
ííe g
,
ííg h
$num
ííi k
,
íík l
$num
íím o
)
íío p
;
ííp q
var
ìì 
	countDays
ìì 
=
ìì 
message
ìì &
.
ìì& '
EndDate
ìì' .
.
ìì. /
Subtract
ìì/ 7
(
ìì7 8
	firstDate
ìì8 A
)
ììA B
.
ììB C
Days
ììC G
+
ììH I
$num
ììJ K
;
ììK L
var
îî 
daysInMonth
îî 
=
îî 
message
îî &
.
îî& '
EndDate
îî' .
.
îî. /
Subtract
îî/ 7
(
îî7 8
message
îî8 ?
.
îî? @
StarDate
îî@ H
)
îîH I
.
îîI J
Days
îîJ N
+
îîO P
$num
îîQ R
;
îîR S
var
ññ 
levelsMapped
ññ 
=
ññ 
	affiliate
ññ (
.
ññ( )

FamilyTree
ññ) 3
.
ññ3 4
Select
ññ4 :
(
ññ: ;
s
ññ; <
=>
ññ= ?
new
ññ@ C
Model2LevelsType
ññD T
{
óó 

Percentage
òò 
=
òò 
message
òò  '
.
òò' (
Configuration
òò( 5
.
òò5 6&
ModelConfigurationLevels
òò6 N
.
òòN O
FirstOrDefault
òòO ]
(
òò] ^
x
òò^ _
=>
òò` b
x
òòc d
.
òòd e
Level
òòe j
==
òòk m
s
òòn o
.
òòo p
Level
òòp u
)
òòu v
!
òòv w
.
òòw x

Percentageòòx Ç
,òòÇ É
Level
ôô 
=
ôô 
s
ôô  !
.
ôô! "
Level
ôô" '
,
ôô' (
PoolId
öö 
=
öö 
pool
öö  $
.
öö$ %
Id
öö% '
,
öö' (
AffiliateId
õõ 
=
õõ 
s
õõ  !
.
õõ! "
Id
õõ" $
,
õõ$ %
AffiliateName
úú 
=
úú 
s
úú  !
.
úú! "
UserName
úú" *
,
úú* +
Side
ùù 
=
ùù 
s
ùù  !
.
ùù! "
Side
ùù" &
,
ùù& '
UserCreatedAt
ûû 
=
ûû 
s
ûû  !
.
ûû! "
	CreatedAt
ûû" +
}
üü 
)
üü 
.
üü 
ToList
üü 
(
üü 
)
üü 
;
üü 
var
°° 
productName
°° 
=
°° 
product
°° %
?
°°% &
.
°°& '
Name
°°' +
??
°°, .
string
°°/ 5
.
°°5 6
Empty
°°6 ;
;
°°; <

levelsType
¢¢ 
.
¢¢ 
AddRange
¢¢ 
(
¢¢  
levelsMapped
¢¢  ,
)
¢¢, -
;
¢¢- .
ecoPoolsType
££ 
.
££ 
Add
££ 
(
££ 
new
££  

Model2Type
££! +
{
§§ 
AffiliateId
•• 
=
••" #
	affiliate
••$ -
.
••- .
Id
••. 0
,
••0 1
AffiliateUserName
¶¶ !
=
¶¶" #
	affiliate
¶¶$ -
.
¶¶- .
UserName
¶¶. 6
,
¶¶6 7
PoolId
ßß 
=
ßß" #
pool
ßß$ (
.
ßß( )
Id
ßß) +
,
ßß+ ,
	CountDays
®® 
=
®®" #
	countDays
®®$ -
,
®®- .
DaysInMonth
©© 
=
©©" #
daysInMonth
©©$ /
,
©©/ 0
Amount
™™ 
=
™™" #
pool
™™$ (
.
™™( )

BaseAmount
™™) 3
!
™™3 4
.
™™4 5
Value
™™5 :
,
™™: ;
LastDayDate
´´ 
=
´´" #
message
´´$ +
.
´´+ ,
Configuration
´´, 9
.
´´9 :
DateEnd
´´: A
,
´´A B
PaymentDate
¨¨ 
=
¨¨" #
	firstDate
¨¨$ -
,
¨¨- .
ProductExternalId
≠≠ !
=
≠≠" #
pool
≠≠$ (
.
≠≠( )
	ProductId
≠≠) 2
,
≠≠2 3
ProductName
ÆÆ 
=
ÆÆ" #
productName
ÆÆ$ /
,
ÆÆ/ 0
UserCreatedAt
ØØ 
=
ØØ" #
	affiliate
ØØ$ -
.
ØØ- .
	CreatedAt
ØØ. 7
}
∞∞ 
)
∞∞ 
;
∞∞ 
}
±± 	
}
≤≤ 
}≥≥ ÆR
WC:\HeroSystem\walletService\WalletService.Core\Kafka\Consumers\ProcessModel3Consumer.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Kafka

 "
.

" #
	Consumers

# ,
;

, -
public 
class !
ProcessModel3Consumer "
:# $
BaseKafkaConsumer% 6
{ 
public !
ProcessModel3Consumer "
(" #
ConsumerSettings 
consumerSettings! 1
,1 2$
ApplicationConfiguration  
configuration! .
,. /
ILogger 
logger! '
,' ( 
IServiceScopeFactory 
serviceScopeFactory! 4
) 
: 
base 
( 
consumerSettings 
, 
configuration ,
,, -
logger. 4
,4 5
serviceScopeFactory6 I
)I J
{ 
} 
	protected 
override 
Task 
< 
bool  
>  !
	OnMessage" +
(+ ,
ConsumeResult, 9
<9 :
Ignore: @
,@ A
stringB H
>H I
eJ K
)K L
{ 
var 
message 
= 
e 
. 
Message 
.  
Value  %
.% &
ToJsonObject& 2
<2 3
Model3Message3 @
>@ A
(A B
)B C
;C D
try 
{ 	
Logger 
. 
LogInformation !
(! "
$str" N
)N O
;O P
return 
message 
is 
not !
null" &
?' (
Process) 0
(0 1
message1 8
)8 9
:: ;
Task< @
.@ A

FromResultA K
(K L
falseL Q
)Q R
;R S
} 	
catch 
( 
	Exception 
ex 
) 
{   	
Logger!! 
.!! 
LogError!! 
(!! 
$"!! 
$str!! K
{!!K L
ex!!L N
.!!N O
ToJsonString!!O [
(!![ \
)!!\ ]
}!!] ^
"!!^ _
)!!_ `
;!!` a
return"" 
Task"" 
."" 

FromResult"" "
(""" #
false""# (
)""( )
;"") *
}## 	
finally$$ 
{%% 	
Logger&& 
.&& 
LogInformation&& !
(&&! "
$str&&" M
)&&M N
;&&N O
}'' 	
}(( 
private** 
async** 
Task** 
<** 
bool** 
>** 
Process** $
(**$ %
Model3Message**% 2
message**3 :
)**: ;
{++ 
using,, 
var,, 
scope,, 
=,,# $
ServiceScopeFactory,,% 8
.,,8 9
CreateScope,,9 D
(,,D E
),,E F
;,,F G
var-- 
walletRepository-- "
=--# $
scope--% *
.--* +
ServiceProvider--+ :
.--: ;

GetService--; E
<--E F
IWalletRepository--F W
>--W X
(--X Y
)--Y Z
;--Z [
var// 
ecoPoolsType// 
=// 
new// 
List// #
<//# $

Model3Type//$ .
>//. /
(/// 0
)//0 1
;//1 2
var00 

levelsType00 
=00 
new00 
List00 #
<00# $
Model3LevelsType00$ 4
>004 5
(005 6
)006 7
;007 8
var22 
request22 
=22 
new22 $
Model3TransactionRequest22 2
{33 	"
EcoPoolConfigurationId44 "
=44# $
message44% ,
.44, -
Configuration44- :
.44: ;
Id44; =
,44= >

Percentage55 
=55# $
(55% &
decimal55& -
)55- .
message55. 5
.555 6
Configuration556 C
.55C D
ModelPercentage55D S
,55S T
Case66 
=66# $
message66% ,
.66, -
Configuration66- :
.66: ;
Case66; ?
,66? @!
TotalPercentageLevels77 !
=77# $
message77% ,
.77, -
Configuration77- :
.77: ;$
ModelConfigurationLevels77; S
.77S T
Sum77T W
(77W X
x77X Y
=>77Z \
x77] ^
.77^ _

Percentage77_ i
)77i j
}88 	
;88	 

Logger:: 
.:: 
LogInformation:: 
(:: 
$"::  
$str::  S
{::S T
request::T [
.::[ \
ToJsonString::\ h
(::h i
)::i j
}::j k
"::k l
)::l m
;::m n
foreach<< 
(<< 
var<< 
item<< 
in<< 
message<< $
.<<$ %
EducatedCourses<<% 4
)<<4 5
{== 	
var>> 
	affiliate>> 
=>> 
message>> #
.>># $
ListResultAccounts>>$ 6
.>>6 7
FirstOrDefault>>7 E
(>>E F
x>>F G
=>>>H J
x>>K L
.>>L M
Id>>M O
==>>P R
item>>S W
.>>W X
Invoice>>X _
.>>_ `
AffiliateId>>` k
)>>k l
;>>l m
var?? 
product?? 
=?? 
message?? #
.??# $
ListResultProducts??$ 6
.??6 7
FirstOrDefault??7 E
(??E F
x??F G
=>??H J
x??K L
.??L M
Id??M O
==??P R
item??S W
.??W X
	ProductId??X a
)??a b
;??b c
ifAA 
(AA 
	affiliateAA 
isAA 
nullAA !
)AA! "
{BB 
LoggerCC 
.CC 

LogWarningCC !
(CC! "
$"CC" $
$strCC$ \
{CC\ ]
	affiliateCC] f
.CCf g
ToJsonStringCCg s
(CCs t
)CCt u
}CCu v
"CCv w
)CCw x
;CCx y
continueDD 
;DD 
}EE 
ifGG 
(GG 
itemGG 
.GG 
InvoiceGG 
.GG 
DateGG !
isGG" $
nullGG% )
)GG) *
{HH 
LoggerII 
.II 

LogWarningII !
(II! "
$"II" $
$strII$ [
"II[ \
)II\ ]
;II] ^
continueJJ 
;JJ 
}KK 
varMM 
levelsMappedMM 
=MM 
	affiliateMM (
.MM( )

FamilyTreeMM) 3
.MM3 4
SelectMM4 :
(MM: ;
sMM; <
=>MM= ?
newMM@ C
Model3LevelsTypeMMD T
{NN 

PercentageOO 
=OO 
messageOO  '
.OO' (
ConfigurationOO( 5
.OO5 6$
ModelConfigurationLevelsOO6 N
.OON O
FirstOrDefaultOOO ]
(OO] ^
xOO^ _
=>OO` b
xOOc d
.OOd e
LevelOOe j
==OOk m
sOOn o
.OOo p
LevelOOp u
)OOu v
!OOv w
.OOw x

Percentage	OOx Ç
,
OOÇ É
LevelPP 
=PP 
sPP  !
.PP! "
LevelPP" '
,PP' (
PoolIdQQ 
=QQ 
itemQQ  $
.QQ$ %
IdQQ% '
,QQ' (
AffiliateIdRR 
=RR 
sRR  !
.RR! "
IdRR" $
,RR$ %
AffiliateNameSS 
=SS 
sSS  !
.SS! "
UserNameSS" *
,SS* +
SideTT 
=TT 
sTT  !
.TT! "
SideTT" &
,TT& '
UserCreatedAtUU 
=UU 
sUU  !
.UU! "
	CreatedAtUU" +
}VV 
)VV 
.VV 
ToListVV 
(VV 
)VV 
;VV 
varXX 
productNameXX 
=XX 
productXX %
?XX% &
.XX& '
NameXX' +
??XX, .
stringXX/ 5
.XX5 6
EmptyXX6 ;
;XX; <

levelsTypeYY 
.YY 
AddRangeYY 
(YY  
levelsMappedYY  ,
)YY, -
;YY- .
ecoPoolsTypeZZ 
.ZZ 
AddZZ 
(ZZ 
newZZ  

Model3TypeZZ! +
{[[ 
AffiliateId\\ 
=\\" #
	affiliate\\$ -
.\\- .
Id\\. 0
,\\0 1
AffiliateUserName]] !
=]]" #
	affiliate]]$ -
.]]- .
UserName]]. 6
,]]6 7
PoolId^^ 
=^^" #
item^^$ (
.^^( )
Id^^) +
,^^+ ,
Amount__ 
=__" #
product__$ +
!__+ ,
.__, -
ModelTwoPercentage__- ?
??__@ B
$num__C D
,__D E
LastDayDate`` 
=``" #
message``$ +
.``+ ,
Configuration``, 9
.``9 :
DateEnd``: A
,``A B
PaymentDateaa 
=aa" #
DateTimeaa$ ,
.aa, -
Nowaa- 0
,aa0 1
ProductExternalIdbb !
=bb" #
itembb$ (
.bb( )
	ProductIdbb) 2
,bb2 3
ProductNamecc 
=cc" #
productNamecc$ /
,cc/ 0
UserCreatedAtdd 
=dd" #
	affiliatedd$ -
.dd- .
	CreatedAtdd. 7
}ee 
)ee 
;ee 
}ff 	
requesthh 
.hh 

LevelsTypehh 
=hh 

levelsTypehh )
;hh) *
requestii 
.ii 
EcoPoolsTypeii 
=ii 
ecoPoolsTypeii +
;ii+ ,
awaitjj 
walletRepositoryjj 
!jj 
.jj  
CreateModel3Spjj  .
(jj. /
requestjj/ 6
)jj6 7
;jj7 8
Loggerkk 
.kk 
LogInformationkk 
(kk 
$"kk  
$strkk  \
"kk\ ]
)kk] ^
;kk^ _
returnmm 
truemm 
;mm 
}nn 
}oo Ïë
bC:\HeroSystem\walletService\WalletService.Core\Kafka\Consumers\ProcessModelsFourFiveSixConsumer.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
	Consumers# ,
;, -
public 
class ,
 ProcessModelsFourFiveSixConsumer -
:. /
BaseKafkaConsumer0 A
{ 
public 
,
 ProcessModelsFourFiveSixConsumer +
(+ ,
ConsumerSettings 
consumerSettings )
,) *$
ApplicationConfiguration  
configuration! .
,. /
ILogger 
logger 
,  
IServiceScopeFactory 
serviceScopeFactory 0
) 
: 
base 
( 
consumerSettings 
, 
configuration ,
,, -
logger. 4
,4 5
serviceScopeFactory6 I
)I J
{J K
} 
	protected 
override 
Task 
< 
bool  
>  !
	OnMessage" +
(+ ,
ConsumeResult, 9
<9 :
Ignore: @
,@ A
stringB H
>H I
eJ K
)K L
{ 
try   
{!! 	
var"" 
message"" 
="" 
e"" 
."" 
Message"" #
.""# $
Value""$ )
."") *
ToJsonObject""* 6
<""6 7#
ModelFourFiveSixMessage""7 N
>""N O
(""O P
)""P Q
;""Q R
Logger## 
.## 
LogInformation## !
(##! "
$str##" W
)##W X
;##X Y
return$$ 
message$$ 
is$$ 
not$$ !
null$$" &
?$$' (
Process$$) 0
($$0 1
message$$1 8
)$$8 9
:$$: ;
Task$$< @
.$$@ A

FromResult$$A K
($$K L
false$$L Q
)$$Q R
;$$R S
}%% 	
catch&& 
(&& 
	Exception&& 
ex&& 
)&& 
{'' 	
Logger(( 
.(( 
LogError(( 
((( 
$str(( Z
,((Z [
ex((\ ^
)((^ _
;((_ `
return)) 
Task)) 
.)) 

FromResult)) "
())" #
false))# (
)))( )
;))) *
}** 	
finally++ 
{,, 	
Logger-- 
.-- 
LogInformation-- !
(--! "
$str--" V
)--V W
;--W X
}.. 	
}// 
private11 
async11 
Task11 
<11 
bool11 
>11 
Process11 $
(11$ %#
ModelFourFiveSixMessage11% <
model11= B
)11B C
{22 
try33 
{44 	
using55 
var55 
scope55 
=55 
ServiceScopeFactory55 1
.551 2
CreateScope552 =
(55= >
)55> ?
;55? @
var66 
walletRepository66  
=66! "
scope66# (
.66( )
ServiceProvider66) 8
.668 9

GetService669 C
<66C D
IWalletRepository66D U
>66U V
(66V W
)66W X
;66X Y
var77 !
accountServiceAdapter77 %
=77& '
scope77( -
.77- .
ServiceProvider77. =
.77= >

GetService77> H
<77H I"
IAccountServiceAdapter77I _
>77_ `
(77` a
)77a b
;77b c
var88 
brandService88 
=88 
scope88 $
.88$ %
ServiceProvider88% 4
.884 5

GetService885 ?
<88? @
IBrandService88@ M
>88M N
(88N O
)88O P
;88P Q
var:: 
brandId:: 
=:: 
brandService:: &
!::& '
.::' (
BrandId::( /
;::/ 0
var<< 
listUsersGraded<< 
=<<  !
model<<" '
.<<' (
UserGradings<<( 4
.== 
Where== 
(== 
x== 
=>== 
x== 
.== 
Grading== %
!==% &
.==& '

ScopeLevel==' 1
>===2 4
	Constants==5 >
.==> ?
CustomerModel4Scope==? R
[==R S
$num==S T
]==T U
)==U V
.>> 
ToList>> 
(>> 
)>> 
;>> 
if@@ 
(@@ 
listUsersGraded@@ 
is@@  "
{@@# $
Count@@% *
:@@* +
$num@@, -
}@@. /
)@@/ 0
returnAA 
falseAA 
;AA 
listUsersGradedCC 
=CC 
listUsersGradedCC -
.CC- .
OrderByDescendingCC. ?
(CC? @
xCC@ A
=>CCB D
xCCE F
.CCF G
CommissionsCCG R
)CCR S
.CCS T
ToListCCT Z
(CCZ [
)CC[ \
;CC\ ]
varDD 

dictionaryDD 
=DD 
awaitDD "%
DebitModelFourFiveProcessDD# <
(DD< =
modelDD= B
,DDB C
listUsersGradedDDD S
,DDS T
walletRepositoryDDU e
,DDe f!
accountServiceAdapterDDg |
,DD| }
brandId	DD~ Ö
)
DDÖ Ü
;
DDÜ á
varFF  
treeUsersInformationFF $
=FF% &
awaitFF' ,'
LeaderBoardModelFourProcessFF- H
(FFH I!
accountServiceAdapterFFI ^
,FF^ _

dictionaryFF` j
,FFj k
brandIdFFl s
)FFs t
;FFt u
varHH 
leaderBoardModel5HH !
=HH" #
newHH$ '
ListHH( ,
<HH, -
LeaderBoardModel5HH- >
>HH> ?
(HH? @
)HH@ A
;HHA B
varII 
leaderBoardModel6II !
=II" #
newII$ '
ListII( ,
<II, -
LeaderBoardModel6II- >
>II> ?
(II? @
)II@ A
;IIA B
awaitKK +
GradingModel4ToCreateNextModelsKK 1
(KK1 2
modelLL 
,LL 
listUsersGradedMM 
,MM  !
accountServiceAdapterNN %
,NN% &
walletRepositoryOO  
!OO  !
,OO! "

dictionaryPP 
,PP 
leaderBoardModel5QQ !
,QQ! "
leaderBoardModel6RR !
,RR! " 
treeUsersInformationSS $
,SS$ %
brandIdTT 
)TT 
;TT 
awaitVV '
LeaderBoardModelFiveProcessVV -
(VV- .
leaderBoardModel5VV. ?
,VV? @!
accountServiceAdapterVVA V
,VVV W
walletRepositoryVVX h
!VVh i
,VVi j
modelVVk p
.VVp q
GradingsVVq y
,VVy z
brandId	VV{ Ç
)
VVÇ É
;
VVÉ Ñ
awaitWW &
LeaderBoardModelSixProcessWW ,
(WW, -
leaderBoardModel6WW- >
,WW> ?!
accountServiceAdapterWW@ U
,WWU V
walletRepositoryWWW g
!WWg h
,WWh i
modelWWj o
.WWo p
GradingsWWp x
,WWx y
brandId	WWz Å
)
WWÅ Ç
;
WWÇ É
returnYY 
trueYY 
;YY 
}ZZ 	
catch[[ 
([[ 
	Exception[[ 
e[[ 
)[[ 
{\\ 	
Console]] 
.]] 
	WriteLine]] 
(]] 
e]] 
)]]  
;]]  !
throw^^ 
;^^ 
}__ 	
}`` 
privateaa 
staticaa 
asyncaa 
Taskaa '
LeaderBoardModelFiveProcessaa 9
(aa9 :
Listbb 
<bb 
LeaderBoardModel5bb 
>bb 
leaderBoardModel5bb( 9
,bb9 :"
IAccountServiceAdaptercc 
?cc !
accountServiceAdaptercc( =
,cc= >
IWalletRepositorydd 
walletRepositorydd( 8
,dd8 9
ICollectionee 
<ee 

GradingDtoee 
>ee 
gradingsee  (
,ee( )
longee) -
brandIdee. 5
)ee5 6
{ff 
leaderBoardModel5hh 
=hh 
leaderBoardModel5hh -
.hh- .
OrderModel5hh. 9
(hh9 :
)hh: ;
;hh; <
awaitii !
accountServiceAdapterii #
!ii# $
.ii$ %
DeleteTreeModel5ii% 5
(ii5 6
brandIdii6 =
)ii= >
;ii> ?
awaitjj !
accountServiceAdapterjj #
.jj# $
AddTreeModel5jj$ 1
(jj1 2
leaderBoardModel5jj2 C
,jjC D
brandIdjjD K
)jjK L
;jjL M
foreachll 
(ll 
varll 
itemll 
inll 
leaderBoardModel5ll .
)ll. /
{mm 	
varnn 
paymentGroupnn 
=nn 
leaderBoardModel5nn 0
.nn0 1
Wherenn1 6
(nn6 7
xnn7 8
=>nn9 ;
xnn< =
.nn= >
FatherModel5nn> J
==nnK M
itemnnN R
.nnR S
AffiliateIdnnS ^
)nn^ _
.nn_ `
ToListnn` f
(nnf g
)nng h
;nnh i
ifoo 
(oo 
paymentGroupoo 
isoo 
{oo  
Countoo  %
:oo% &
$numoo& '
}oo' (
)oo( )
continuepp 
;pp 
varrr 
gradingrr 
=rr 
gradingsrr &
.rr& '
Firstrr' ,
(rr, -
xrr- .
=>rr/ 1
xrr2 3
.rr3 4
Idrr4 6
==rr7 9
itemrr: >
.rr> ?
	GradingIdrr? H
)rrH I
;rrI J
varss 
totalAmountss 
=ss 
paymentGroupss *
.ss* +
Countss+ 0
*ss1 2
gradingss3 :
.ss: ;
PurchasesNetworkss; K
;ssK L
awaittt 
CreateCreditPaymenttt %
(tt% &
walletRepositoryuu  
,uu  !
itemvv 
.vv 
AffiliateIdvv  
,vv  !
itemww 
.ww 
UserNameww 
,ww 
(xx 
doublexx 
)xx 
totalAmountxx #
,xx# $
stringyy 
.yy 
Formatyy 
(yy 
	Constantsyy '
.yy' (-
!ConceptCommissionModelFivePaymentyy( I
,yyI J
totalAmountyyK V
,yyV W
gradingyyX _
.yy_ `
Nameyy` d
)yyd e
,yye f
WalletConceptTypezz !
.zz! "
model_four_paymentzz" 4
.zz4 5
ToStringzz5 =
(zz= >
)zz> ?
){{ 
;{{ 
}|| 	
}}} 
private 
static 
async 
Task &
LeaderBoardModelSixProcess 8
(8 9
List
ÄÄ 
<
ÄÄ 
LeaderBoardModel6
ÄÄ 
>
ÄÄ 
leaderBoardModel6
ÄÄ  1
,
ÄÄ1 2$
IAccountServiceAdapter
ÅÅ 
?
ÅÅ #
accountServiceAdapter
ÅÅ  5
,
ÅÅ5 6
IWalletRepository
ÇÇ 
walletRepository
ÇÇ  0
,
ÇÇ0 1
ICollection
ÉÉ 
<
ÉÉ 

GradingDto
ÉÉ 
>
ÉÉ 
gradings
ÉÉ  (
,
ÉÉ( )
long
ÉÉ) -
brandId
ÉÉ. 5
)
ÉÉ5 6
{
ÑÑ 
leaderBoardModel6
ÖÖ 
=
ÖÖ 
leaderBoardModel6
ÖÖ -
.
ÖÖ- .
OrderModel6
ÖÖ. 9
(
ÖÖ9 :
)
ÖÖ: ;
;
ÖÖ; <
await
ÜÜ #
accountServiceAdapter
ÜÜ #
!
ÜÜ# $
.
ÜÜ$ %
DeleteTreeModel6
ÜÜ% 5
(
ÜÜ5 6
brandId
ÜÜ6 =
)
ÜÜ= >
;
ÜÜ> ?
await
áá #
accountServiceAdapter
áá #
.
áá# $
AddTreeModel6
áá$ 1
(
áá1 2
leaderBoardModel6
áá2 C
,
ááC D
brandId
ááD K
)
ááK L
;
ááL M
foreach
ââ 
(
ââ 
var
ââ 
item
ââ 
in
ââ 
leaderBoardModel6
ââ .
)
ââ. /
{
ää 	
var
ãã 
paymentGroup
ãã 
=
ãã 
leaderBoardModel6
ãã 0
.
ãã0 1
Where
ãã1 6
(
ãã6 7
x
ãã7 8
=>
ãã9 ;
x
ãã< =
.
ãã= >
FatherModel6
ãã> J
==
ããK M
item
ããN R
.
ããR S
AffiliateId
ããS ^
)
ãã^ _
.
ãã_ `
ToList
ãã` f
(
ããf g
)
ããg h
;
ããh i
if
åå 
(
åå 
paymentGroup
åå 
is
åå 
{
åå  
Count
åå  %
:
åå% &
$num
åå& '
}
åå' (
)
åå( )
continue
çç 
;
çç 
var
èè 
grading
èè 
=
èè 
gradings
èè &
.
èè& '
First
èè' ,
(
èè, -
x
èè- .
=>
èè/ 1
x
èè2 3
.
èè3 4
Id
èè4 6
==
èè7 9
item
èè: >
.
èè> ?
	GradingId
èè? H
)
èèH I
;
èèI J
var
êê 
totalAmount
êê 
=
êê 
paymentGroup
êê *
.
êê* +
Count
êê+ 0
*
êê1 2
grading
êê3 :
.
êê: ;
PurchasesNetwork
êê; K
;
êêK L
await
ëë !
CreateCreditPayment
ëë %
(
ëë% &
walletRepository
íí  
,
íí  !
item
ìì 
.
ìì 
AffiliateId
ìì  
,
ìì  !
item
îî 
.
îî 
UserName
îî 
,
îî 
(
ïï 
double
ïï 
)
ïï 
totalAmount
ïï #
,
ïï# $
string
ññ 
.
ññ 
Format
ññ 
(
ññ 
	Constants
ññ '
.
ññ' (.
 ConceptCommissionModelSixPayment
ññ( H
,
ññH I
totalAmount
ññJ U
,
ññU V
grading
ññW ^
.
ññ^ _
Name
ññ_ c
)
ññc d
,
ññd e
WalletConceptType
óó !
.
óó! " 
model_four_payment
óó" 4
.
óó4 5
ToString
óó5 =
(
óó= >
)
óó> ?
)
òò 
;
òò 
}
ôô 	
}
öö 
private
úú 
static
úú 
async
úú 
Task
úú 
<
úú 
ICollection
úú )
<
úú) *#
UserBinaryInformation
úú* ?
>
úú? @
>
úú@ A)
LeaderBoardModelFourProcess
úúB ]
(
úú] ^$
IAccountServiceAdapter
ùù 
?
ùù #
accountServiceAdapter
ùù  5
,
ùù5 6

Dictionary
ûû 
<
ûû 
int
ûû 
,
ûû 
decimal
ûû 
>
ûû  

dictionary
ûû! +
,
ûû+ ,
long
ûû- 1
brandId
ûû2 9
)
ûû9 :
{
üü 
var
†† 
result
†† 
=
†† 
new
†† 
List
†† 
<
†† #
UserBinaryInformation
†† 3
>
††3 4
(
††4 5
)
††5 6
;
††6 7
var
¢¢ 
response
¢¢ 
=
¢¢ 
await
¢¢ #
accountServiceAdapter
¢¢ 2
!
¢¢2 3
.
¢¢3 4
GetTreeModel4
¢¢4 A
(
¢¢A B

dictionary
¢¢B L
,
¢¢L M
brandId
¢¢N U
)
¢¢U V
;
¢¢V W
if
§§ 

(
§§ 
string
§§ 
.
§§ 
IsNullOrEmpty
§§  
(
§§  !
response
§§! )
.
§§) *
Content
§§* 1
)
§§1 2
)
§§2 3
return
•• 
result
•• 
;
•• 
var
ßß  
userBinaryResponse
ßß 
=
ßß  
response
ßß! )
.
ßß) *
Content
ßß* 1
.
ßß1 2
ToJsonObject
ßß2 >
<
ßß> ? 
UserBinaryResponse
ßß? Q
>
ßßQ R
(
ßßR S
)
ßßS T
;
ßßT U
return
®®  
userBinaryResponse
®® !
!
®®! "
.
®®" #
data
®®# '
;
®®' (
}
©© 
private
´´ 
static
´´ 
async
´´ 
Task
´´ 
<
´´ 

Dictionary
´´ (
<
´´( )
int
´´) ,
,
´´, -
decimal
´´. 5
>
´´5 6
>
´´6 7'
DebitModelFourFiveProcess
´´8 Q
(
´´Q R%
ModelFourFiveSixMessage
¨¨ 
model
¨¨( -
,
¨¨- .
List
≠≠ 
<
≠≠  
UserGradingRequest
≠≠ 
>
≠≠  
listUsersGraded
≠≠! 0
,
≠≠0 1
IWalletRepository
ÆÆ 
?
ÆÆ 
walletRepository
ÆÆ! 1
,
ÆÆ1 2$
IAccountServiceAdapter
ØØ 
?
ØØ #
accountServiceAdapter
ØØ! 6
,
ØØ6 7
long
ØØ8 <
brandId
ØØ= D
)
ØØD E
{
∞∞ 
var
±± 
userDictionary
±± 
=
±± 
listUsersGraded
±± ,
.
±±, -
ToDictionary
±±- 9
(
±±9 :
x
±±: ;
=>
±±< >
x
±±? @
.
±±@ A
AffiliateId
±±A L
,
±±L M
_
±±N O
=>
±±P R
$num
±±S U
)
±±U V
;
±±V W
foreach
≤≤ 
(
≤≤ 
var
≤≤ 
item
≤≤ 
in
≤≤ 
listUsersGraded
≤≤ ,
)
≤≤, -
{
≥≥ 	
if
¥¥ 
(
¥¥ 
item
¥¥ 
.
¥¥ 
Grading
¥¥ 
!
¥¥ 
.
¥¥ 

ScopeLevel
¥¥ (
>=
¥¥) +
$num
¥¥, -
)
¥¥- .
{
µµ 
if
∂∂ 
(
∂∂ 
walletRepository
∂∂ $
is
∂∂% '
not
∂∂( +
null
∂∂, 0
)
∂∂0 1
await
∑∑  
CreateDebitPayment
∑∑ ,
(
∑∑, -
walletRepository
∏∏ (
,
∏∏( )
item
ππ 
.
ππ 
AffiliateId
ππ (
,
ππ( )
item
∫∫ 
.
∫∫ 
UserName
∫∫ %
,
∫∫% &
item
ªª 
.
ªª 
Grading
ªª $
.
ªª$ %
PersonalPurchases
ªª% 6
,
ªª6 7
string
ºº 
.
ºº 
Format
ºº %
(
ºº% &
	Constants
ºº& /
.
ºº/ 0"
ConceptBinaryPayment
ºº0 D
,
ººD E
item
ººF J
.
ººJ K
Grading
ººK R
.
ººR S
PersonalPurchases
ººS d
,
ººd e
item
ººf j
.
ººj k
Grading
ººk r
.
ººr s
Name
ººs w
)
ººw x
,
ººx y
WalletConceptType
ΩΩ )
.
ΩΩ) * 
model_four_payment
ΩΩ* <
.
ΩΩ< =
ToString
ΩΩ= E
(
ΩΩE F
)
ΩΩF G
)
ΩΩG H
;
ΩΩH I
userDictionary
øø 
[
øø 
item
øø #
.
øø# $
AffiliateId
øø$ /
]
øø/ 0
=
øø1 2
item
øø3 7
.
øø7 8
Grading
øø8 ?
.
øø? @
PurchasesNetwork
øø@ P
;
øøP Q
var
¡¡ 
description
¡¡ 
=
¡¡  !
item
¡¡" &
.
¡¡& '
Grading
¡¡' .
!
¡¡. /
.
¡¡/ 0

ScopeLevel
¡¡0 :
>
¡¡; <
	Constants
¡¡= F
.
¡¡F G!
CustomerModel5Scope
¡¡G Z
?
¡¡[ \
	Constants
¡¡] f
.
¡¡f g$
ConceptModelSixPayment
¡¡g }
:
¡¡~ 
	Constants¡¡Ä â
.¡¡â ä'
ConceptModelFivePayment¡¡ä °
;¡¡° ¢
if
¬¬ 
(
¬¬ 
walletRepository
¬¬ $
is
¬¬% '
not
¬¬( +
null
¬¬, 0
&&
¬¬1 3
item
¬¬4 8
.
¬¬8 9
Grading
¬¬9 @
!
¬¬@ A
.
¬¬A B

ScopeLevel
¬¬B L
>=
¬¬M O
	Constants
¬¬P Y
.
¬¬Y Z!
CustomerModel5Scope
¬¬Z m
)
¬¬m n
await
√√  
CreateDebitPayment
√√ ,
(
√√, -
walletRepository
ƒƒ (
,
ƒƒ( )
item
≈≈ 
.
≈≈ 
AffiliateId
≈≈ (
,
≈≈( )
item
∆∆ 
.
∆∆ 
UserName
∆∆ %
,
∆∆% &
item
«« 
.
«« 
Grading
«« $
.
««$ %
PersonalPurchases
««% 6
,
««6 7
string
»» 
.
»» 
Format
»» %
(
»»% &
description
»»& 1
,
»»1 2
item
»»3 7
.
»»7 8
Grading
»»8 ?
.
»»? @
PersonalPurchases
»»@ Q
,
»»Q R
item
»»S W
.
»»W X
Grading
»»X _
.
»»_ `
Name
»»` d
)
»»d e
,
»»e f
WalletConceptType
…… )
.
……) * 
model_five_payment
……* <
.
……< =
ToString
……= E
(
……E F
)
……F G
)
……G H
;
……H I
await
ÀÀ #
accountServiceAdapter
ÀÀ +
!
ÀÀ+ ,
.
ÀÀ, -!
UpdateGradingByUser
ÀÀ- @
(
ÀÀ@ A
item
ÀÀA E
.
ÀÀE F
AffiliateId
ÀÀF Q
,
ÀÀQ R
item
ÀÀS W
.
ÀÀW X
Grading
ÀÀX _
.
ÀÀ_ `
Id
ÀÀ` b
,
ÀÀb c
brandId
ÀÀd k
)
ÀÀk l
;
ÀÀl m
}
ÃÃ 
else
ÕÕ 
{
ŒŒ 
if
œœ 
(
œœ 
walletRepository
œœ $
is
œœ% '
not
œœ( +
null
œœ, 0
)
œœ0 1
await
––  
CreateDebitPayment
–– ,
(
––, -
walletRepository
—— (
,
——( )
item
““ 
.
““ 
AffiliateId
““ (
,
““( )
item
”” 
.
”” 
UserName
”” %
,
””% &
item
‘‘ 
.
‘‘ 
Grading
‘‘ $
.
‘‘$ %
PersonalPurchases
‘‘% 6
,
‘‘6 7
string
’’ 
.
’’ 
Format
’’ %
(
’’% &
	Constants
’’& /
.
’’/ 0"
ConceptBinaryPayment
’’0 D
,
’’D E
item
’’F J
.
’’J K
Grading
’’K R
.
’’R S
PersonalPurchases
’’S d
,
’’d e
item
’’f j
.
’’j k
Grading
’’k r
.
’’r s
Name
’’s w
)
’’w x
,
’’x y
WalletConceptType
÷÷ )
.
÷÷) * 
model_four_payment
÷÷* <
.
÷÷< =
ToString
÷÷= E
(
÷÷E F
)
÷÷F G
)
◊◊ 
;
◊◊ 
userDictionary
ÿÿ 
[
ÿÿ 
item
ÿÿ #
.
ÿÿ# $
AffiliateId
ÿÿ$ /
]
ÿÿ/ 0
=
ÿÿ1 2
item
ÿÿ3 7
.
ÿÿ7 8
Grading
ÿÿ8 ?
.
ÿÿ? @
PurchasesNetwork
ÿÿ@ P
;
ÿÿP Q
await
⁄⁄ #
accountServiceAdapter
⁄⁄ +
!
⁄⁄+ ,
.
⁄⁄, -!
UpdateGradingByUser
⁄⁄- @
(
⁄⁄@ A
item
⁄⁄A E
.
⁄⁄E F
AffiliateId
⁄⁄F Q
,
⁄⁄Q R
item
⁄⁄S W
.
⁄⁄W X
Grading
⁄⁄X _
.
⁄⁄_ `
Id
⁄⁄` b
,
⁄⁄b c
brandId
⁄⁄d k
)
⁄⁄k l
;
⁄⁄l m
}
€€ 
}
‹‹ 	
return
ﬁﬁ 
userDictionary
ﬁﬁ 
;
ﬁﬁ 
}
ﬂﬂ 
private
‚‚ 
static
‚‚ 
async
‚‚ 
Task
‚‚ -
GradingModel4ToCreateNextModels
‚‚ =
(
‚‚= >%
ModelFourFiveSixMessage
„„ 
model
„„2 7
,
„„7 8
ICollection
‰‰ 
<
‰‰  
UserGradingRequest
‰‰ &
>
‰‰& '
listUsersGraded
‰‰+ :
,
‰‰: ;$
IAccountServiceAdapter
ÂÂ 
?
ÂÂ #
accountServiceAdapter
ÂÂ+ @
,
ÂÂ@ A
IWalletRepository
ÊÊ 
walletRepository
ÊÊ+ ;
,
ÊÊ; <

Dictionary
ÁÁ 
<
ÁÁ 
int
ÁÁ 
,
ÁÁ 
decimal
ÁÁ 
>
ÁÁ  
userDictionary
ÁÁ+ 9
,
ÁÁ9 :
ICollection
ËË 
<
ËË 
LeaderBoardModel5
ËË %
>
ËË% &
leaderBoardModel5
ËË+ <
,
ËË< =
ICollection
ÈÈ 
<
ÈÈ 
LeaderBoardModel6
ÈÈ %
>
ÈÈ% &
leaderBoardModel6
ÈÈ+ <
,
ÈÈ< =
ICollection
ÍÍ 
<
ÍÍ #
UserBinaryInformation
ÍÍ )
>
ÍÍ) *
resultPoints
ÍÍ+ 7
,
ÍÍ7 8
long
ÍÍ8 <
brandId
ÍÍ= D
)
ÍÍD E
{
ÎÎ 
var
ÏÏ 
resultOldPoints
ÏÏ 
=
ÏÏ 
await
ÏÏ  %
walletRepository
ÏÏ& 6
.
ÏÏ6 7
GetUserModelFour
ÏÏ7 G
(
ÏÏG H
userDictionary
ÏÏH V
.
ÏÏV W
Select
ÏÏW ]
(
ÏÏ] ^
x
ÏÏ^ _
=>
ÏÏ` b
x
ÏÏc d
.
ÏÏd e
Key
ÏÏe h
)
ÏÏh i
.
ÏÏi j
ToArray
ÏÏj q
(
ÏÏq r
)
ÏÏr s
)
ÏÏs t
;
ÏÏt u
var
ÓÓ 
userIds
ÓÓ 
=
ÓÓ 
listUsersGraded
ÓÓ  /
.
ÓÓ/ 0
Select
ÓÓ0 6
(
ÓÓ6 7
x
ÓÓ7 8
=>
ÓÓ9 ;
x
ÓÓ< =
.
ÓÓ= >
AffiliateId
ÓÓ> I
)
ÓÓI J
.
ÓÓJ K
ToArray
ÓÓK R
(
ÓÓR S
)
ÓÓS T
;
ÓÓT U
var
ÔÔ 
responseCondition
ÔÔ 
=
ÔÔ 
await
ÔÔ  %#
accountServiceAdapter
ÔÔ& ;
!
ÔÔ; <
.
ÔÔ< =
GetHave2Children
ÔÔ= M
(
ÔÔM N
userIds
ÔÔN U
,
ÔÔU V
brandId
ÔÔW ^
)
ÔÔ^ _
;
ÔÔ_ `
if
ÒÒ 

(
ÒÒ 
string
ÒÒ 
.
ÒÒ 
IsNullOrEmpty
ÒÒ  
(
ÒÒ  !
responseCondition
ÒÒ! 2
.
ÒÒ2 3
Content
ÒÒ3 :
)
ÒÒ: ;
)
ÒÒ; <
return
ÚÚ 
;
ÚÚ 
var
ÙÙ 
resultUserIds
ÙÙ 
=
ÙÙ 
responseCondition
ÙÙ -
.
ÙÙ- .
Content
ÙÙ. 5
.
ÙÙ5 6
ToJsonObject
ÙÙ6 B
<
ÙÙB C
int
ÙÙC F
[
ÙÙF G
]
ÙÙG H
>
ÙÙH I
(
ÙÙI J
)
ÙÙJ K
;
ÙÙK L
foreach
ˆˆ 
(
ˆˆ 
var
ˆˆ 
user
ˆˆ 
in
ˆˆ 
userDictionary
ˆˆ +
)
ˆˆ+ ,
{
˜˜ 	
var
¯¯ 
	oldPoints
¯¯ 
=
¯¯# $
resultOldPoints
¯¯% 4
.
¯¯4 5
Where
¯¯5 :
(
¯¯: ;
x
¯¯; <
=>
¯¯= ?
x
¯¯@ A
.
¯¯A B
AffiliateId
¯¯B M
==
¯¯N P
user
¯¯Q U
.
¯¯U V
Key
¯¯V Y
)
¯¯Y Z
.
¯¯Z [
ToList
¯¯[ a
(
¯¯a b
)
¯¯b c
;
¯¯c d
var
˘˘ 
oldLeftPoints
˘˘ !
=
˘˘# $
	oldPoints
˘˘% .
.
˘˘. /
Sum
˘˘/ 2
(
˘˘2 3
x
˘˘3 4
=>
˘˘5 7
x
˘˘8 9
.
˘˘9 :

CreditLeft
˘˘: D
-
˘˘E F
x
˘˘G H
.
˘˘H I
	DebitLeft
˘˘I R
)
˘˘R S
;
˘˘S T
var
˙˙ 
oldRightPoints
˙˙ "
=
˙˙# $
	oldPoints
˙˙% .
.
˙˙. /
Sum
˙˙/ 2
(
˙˙2 3
x
˙˙3 4
=>
˙˙5 7
x
˙˙8 9
.
˙˙9 :
CreditRight
˙˙: E
-
˙˙F G
x
˙˙H I
.
˙˙I J

DebitRight
˙˙J T
)
˙˙T U
;
˙˙U V
decimal
˚˚ 
payment
˚˚ 
;
˚˚ 
var
¸¸ 

leftPoints
¸¸ 
=
¸¸* +
$num
¸¸, .
;
¸¸. /
var
˝˝ 
rightPoints
˝˝ 
=
˝˝* +
$num
˝˝, .
;
˝˝. /
var
˛˛ #
userPointsInformation
˛˛ )
=
˛˛* +
resultPoints
˛˛, 8
.
˛˛8 9
FirstOrDefault
˛˛9 G
(
˛˛G H
x
˛˛H I
=>
˛˛J L
x
˛˛M N
.
˛˛N O
AffiliateId
˛˛O Z
==
˛˛[ ]
user
˛˛^ b
.
˛˛b c
Key
˛˛c f
)
˛˛f g
;
˛˛g h
var
ˇˇ 
userInformation
ˇˇ #
=
ˇˇ* +
listUsersGraded
ˇˇ, ;
.
ˇˇ; <
First
ˇˇ< A
(
ˇˇA B
x
ˇˇB C
=>
ˇˇD F
x
ˇˇG H
.
ˇˇH I
AffiliateId
ˇˇI T
==
ˇˇU W
user
ˇˇX \
.
ˇˇ\ ]
Key
ˇˇ] `
)
ˇˇ` a
;
ˇˇa b
if
ÅÅ 
(
ÅÅ #
userPointsInformation
ÅÅ %
is
ÅÅ& (
not
ÅÅ) ,
null
ÅÅ- 1
)
ÅÅ1 2
{
ÇÇ 

leftPoints
ÉÉ 
=
ÉÉ 
(
ÉÉ 
decimal
ÉÉ &
)
ÉÉ& '
oldLeftPoints
ÉÉ' 4
!
ÉÉ4 5
+
ÉÉ6 7#
userPointsInformation
ÉÉ8 M
.
ÉÉM N

LeftVolume
ÉÉN X
;
ÉÉX Y
rightPoints
ÑÑ 
=
ÑÑ 
(
ÑÑ 
decimal
ÑÑ &
)
ÑÑ& '
oldRightPoints
ÑÑ' 5
!
ÑÑ5 6
+
ÑÑ7 8#
userPointsInformation
ÑÑ9 N
.
ÑÑN O
RightVolume
ÑÑO Z
;
ÑÑZ [
}
ÖÖ 
if
áá 
(
áá 

leftPoints
áá 
==
áá 
rightPoints
áá )
&&
áá* ,

leftPoints
áá- 7
>
áá8 9
$num
áá: ;
)
áá; <
{
àà 
payment
ââ 
=
ââ  

leftPoints
ââ! +
;
ââ+ ,
var
ää 
points
ää 
=
ää# $
payment
ää% ,
+
ää- .
(
ää/ 0
decimal
ää0 7
)
ää7 8
userInformation
ää8 G
.
ääG H
Commissions
ääH S
;
ääS T
var
ãã 
hasTwoChildren
ãã "
=
ãã# $
resultUserIds
ãã% 2
!
ãã2 3
.
ãã3 4
Contains
ãã4 <
(
ãã< =
userInformation
ãã= L
.
ããL M
AffiliateId
ããM X
)
ããX Y
;
ããY Z
await
åå 
CreditModel4
åå "
(
åå" #
walletRepository
çç $
,
çç$ %
payment
éé 
,
éé #
userPointsInformation
èè )
!
èè) *
.
èè* +

LeftVolume
èè+ 5
,
èè5 6#
userPointsInformation
êê )
.
êê) *
RightVolume
êê* 5
,
êê5 6
userInformation
ëë #
,
ëë# $
hasTwoChildren
íí "
)
íí" #
;
íí# $
var
îî 
grading
îî 
=
îî 
await
îî #!
GradingModelFiveSix
îî$ 7
(
îî7 8
model
îî8 =
,
îî= >#
accountServiceAdapter
îî? T
,
îîT U
walletRepository
îîV f
,
îîf g
payment
îîh o
,
îîo p
userInformationîîq Ä
,îîÄ Å
userîîÇ Ü
,îîÜ á
brandIdîîá é
)îîé è
;îîè ê
if
ññ 
(
ññ 
grading
ññ 
is
ññ 
null
ññ #
)
ññ# $
continue
óó 
;
óó 
if
ôô 
(
ôô 
grading
ôô 
.
ôô 

ScopeLevel
ôô &
>=
ôô' )
	Constants
ôô* 3
.
ôô3 4!
CustomerModel5Scope
ôô4 G
)
ôôG H
{
öö 
leaderBoardModel5
õõ %
.
õõ% &
Add
õõ& )
(
õõ) *
new
õõ* -
LeaderBoardModel5
õõ. ?
{
úú 
AffiliateId
ùù #
=
ùù$ %
user
ùù& *
.
ùù* +
Key
ùù+ .
,
ùù. /
Amount
ûû 
=
ûû$ %
points
ûû& ,
,
ûû, -
UserName
üü  
=
üü$ %
userInformation
üü& 5
.
üü5 6
UserName
üü6 >
,
üü> ?
	CreatedAt
†† !
=
††$ %
DateTime
††& .
.
††. /
Now
††/ 2
,
††2 3
	GradingId
°° !
=
°°$ %
grading
°°& -
.
°°- .
Id
°°. 0
,
°°0 1
UserCreatedAt
¢¢ %
=
¢¢& '
userInformation
¢¢( 7
.
¢¢7 8
UserCreatedAt
¢¢8 E
}
££ 
)
££ 
;
££ 
}
§§ 
if
¶¶ 
(
¶¶ 
grading
¶¶ 
.
¶¶ 

ScopeLevel
¶¶ &
>=
¶¶' )
	Constants
¶¶* 3
.
¶¶3 4!
CustomerModel6Scope
¶¶4 G
[
¶¶G H
$num
¶¶H I
]
¶¶I J
)
¶¶J K
{
ßß 
leaderBoardModel6
®® %
.
®®% &
Add
®®& )
(
®®) *
new
®®* -
LeaderBoardModel6
®®. ?
{
©© 
AffiliateId
™™ #
=
™™& '
user
™™( ,
.
™™, -
Key
™™- 0
,
™™0 1
Amount
´´ 
=
´´& '
points
´´( .
,
´´. /
UserName
¨¨  
=
¨¨& '
userInformation
¨¨( 7
.
¨¨7 8
UserName
¨¨8 @
,
¨¨@ A
	CreatedAt
≠≠ !
=
≠≠& '
DateTime
≠≠( 0
.
≠≠0 1
Now
≠≠1 4
,
≠≠4 5
	GradingId
ÆÆ !
=
ÆÆ& '
grading
ÆÆ( /
.
ÆÆ/ 0
Id
ÆÆ0 2
,
ÆÆ2 3
UserCreatedAt
ØØ %
=
ØØ& '
userInformation
ØØ( 7
.
ØØ7 8
UserCreatedAt
ØØ8 E
,
ØØE F
}
∞∞ 
)
∞∞ 
;
∞∞ 
}
±± 
}
≥≥ 
else
¥¥ 
if
¥¥ 
(
¥¥ 

leftPoints
¥¥ 
>
¥¥  !
$num
¥¥" #
||
¥¥$ &
rightPoints
¥¥' 2
>
¥¥3 4
$num
¥¥5 6
)
¥¥6 7
{
µµ 
payment
∂∂ 
=
∂∂) *

leftPoints
∂∂+ 5
<
∂∂6 7
rightPoints
∂∂8 C
?
∂∂D E

leftPoints
∂∂F P
:
∂∂Q R
rightPoints
∂∂S ^
;
∂∂^ _
var
∑∑ 
points
∑∑ 
=
∑∑# $
payment
∑∑% ,
+
∑∑- .
(
∑∑/ 0
decimal
∑∑0 7
)
∑∑7 8
userInformation
∑∑8 G
.
∑∑G H
Commissions
∑∑H S
;
∑∑S T
var
∏∏ 
hasTwoChildren
∏∏ "
=
∏∏# $
resultUserIds
∏∏% 2
!
∏∏2 3
.
∏∏3 4
Contains
∏∏4 <
(
∏∏< =
userInformation
∏∏= L
.
∏∏L M
AffiliateId
∏∏M X
)
∏∏X Y
;
∏∏Y Z
await
ππ 
CreditModel4
ππ "
(
ππ" #
walletRepository
∫∫ $
,
∫∫$ %
payment
ªª 
,
ªª #
userPointsInformation
ºº )
!
ºº) *
.
ºº* +

LeftVolume
ºº+ 5
,
ºº5 6#
userPointsInformation
ΩΩ )
.
ΩΩ) *
RightVolume
ΩΩ* 5
,
ΩΩ5 6
userInformation
ææ #
,
ææ# $
hasTwoChildren
øø "
)
øø" #
;
øø# $
var
¡¡ 
grading
¡¡ 
=
¡¡ 
await
¡¡ #!
GradingModelFiveSix
¡¡$ 7
(
¡¡7 8
model
¡¡8 =
,
¡¡= >#
accountServiceAdapter
¡¡? T
,
¡¡T U
walletRepository
¡¡V f
,
¡¡f g
payment
¡¡h o
,
¡¡o p
userInformation¡¡q Ä
,¡¡Ä Å
user¡¡Ç Ü
,¡¡Ü á
brandId¡¡á é
)¡¡é è
;¡¡è ê
if
√√ 
(
√√ 
grading
√√ 
is
√√ 
null
√√ #
)
√√# $
continue
ƒƒ 
;
ƒƒ 
if
∆∆ 
(
∆∆ 
grading
∆∆ 
.
∆∆ 

ScopeLevel
∆∆ &
>=
∆∆' )
	Constants
∆∆* 3
.
∆∆3 4!
CustomerModel5Scope
∆∆4 G
)
∆∆G H
{
«« 
leaderBoardModel5
»» %
.
»»% &
Add
»»& )
(
»») *
new
»»* -
LeaderBoardModel5
»». ?
{
…… 
AffiliateId
   #
=
  $ %
user
  & *
.
  * +
Key
  + .
,
  . /
Amount
ÀÀ 
=
ÀÀ$ %
points
ÀÀ& ,
,
ÀÀ, -
UserName
ÃÃ  
=
ÃÃ$ %
userInformation
ÃÃ& 5
.
ÃÃ5 6
UserName
ÃÃ6 >
,
ÃÃ> ?
	CreatedAt
ÕÕ !
=
ÕÕ$ %
DateTime
ÕÕ& .
.
ÕÕ. /
Now
ÕÕ/ 2
,
ÕÕ2 3
	GradingId
ŒŒ !
=
ŒŒ& '
grading
ŒŒ( /
.
ŒŒ/ 0
Id
ŒŒ0 2
,
ŒŒ2 3
UserCreatedAt
œœ %
=
œœ& '
userInformation
œœ( 7
.
œœ7 8
UserCreatedAt
œœ8 E
}
–– 
)
–– 
;
–– 
}
—— 
if
”” 
(
”” 
grading
”” 
.
”” 

ScopeLevel
”” &
>=
””' )
	Constants
””* 3
.
””3 4!
CustomerModel6Scope
””4 G
[
””G H
$num
””H I
]
””I J
)
””J K
{
‘‘ 
leaderBoardModel6
’’ %
.
’’% &
Add
’’& )
(
’’) *
new
’’* -
LeaderBoardModel6
’’. ?
{
÷÷ 
AffiliateId
◊◊ #
=
◊◊& '
user
◊◊( ,
.
◊◊, -
Key
◊◊- 0
,
◊◊0 1
Amount
ÿÿ 
=
ÿÿ& '
points
ÿÿ( .
,
ÿÿ. /
UserName
ŸŸ  
=
ŸŸ& '
userInformation
ŸŸ( 7
.
ŸŸ7 8
UserName
ŸŸ8 @
,
ŸŸ@ A
	CreatedAt
⁄⁄ !
=
⁄⁄& '
DateTime
⁄⁄( 0
.
⁄⁄0 1
Now
⁄⁄1 4
,
⁄⁄4 5
	GradingId
€€ !
=
€€& '
grading
€€( /
.
€€/ 0
Id
€€0 2
,
€€2 3
UserCreatedAt
‹‹ %
=
‹‹& '
userInformation
‹‹( 7
.
‹‹7 8
UserCreatedAt
‹‹8 E
,
‹‹E F
}
›› 
)
›› 
;
›› 
}
ﬁﬁ 
}
ﬂﬂ 
else
‡‡ 
await
·· 
walletRepository
·· &
.
··& '
TransactionPoints
··' 8
(
··8 9
user
‚‚ 
.
‚‚ 
Key
‚‚ 
,
‚‚ 
$num
‚‚ 
,
‚‚  
$num
‚‚! "
,
‚‚" ##
userPointsInformation
„„ )
!
„„) *
.
„„* +

LeftVolume
„„+ 5
,
„„5 6#
userPointsInformation
‰‰ )
.
‰‰) *
RightVolume
‰‰* 5
)
‰‰5 6
;
‰‰6 7
}
ÊÊ 	
}
ÁÁ 
private
ÈÈ 
static
ÈÈ 
void
ÈÈ "
AddUsersLeaderBoard5
ÈÈ ,
(
ÈÈ, -
ICollection
ÍÍ 
<
ÍÍ 
LeaderBoardModel5
ÍÍ %
>
ÍÍ% &
leaderBoardModel5
ÍÍ' 8
,
ÍÍ8 9
ICollection
ÎÎ 
<
ÎÎ 
LeaderBoardModel6
ÎÎ %
>
ÎÎ% &
leaderBoardModel6
ÎÎ' 8
,
ÎÎ8 9

GradingDto
ÏÏ 
grading
ÏÏ' .
,
ÏÏ. /
KeyValuePair
ÌÌ 
<
ÌÌ 
int
ÌÌ 
,
ÌÌ 
decimal
ÌÌ !
>
ÌÌ! "
user
ÌÌ' +
,
ÌÌ+ ,
decimal
ÓÓ 
points
ÓÓ' -
,
ÓÓ- . 
UserGradingRequest
ÔÔ 
userInformation
ÔÔ' 6
)
ÔÔ6 7
{
 
if
ÒÒ 

(
ÒÒ 
grading
ÒÒ 
.
ÒÒ 

ScopeLevel
ÒÒ 
==
ÒÒ !
	Constants
ÒÒ" +
.
ÒÒ+ ,!
CustomerModel5Scope
ÒÒ, ?
)
ÒÒ? @
{
ÚÚ 	
leaderBoardModel5
ÛÛ 
.
ÛÛ 
Add
ÛÛ !
(
ÛÛ! "
new
ÛÛ" %
LeaderBoardModel5
ÛÛ& 7
{
ÙÙ 
AffiliateId
ıı 
=
ıı 
user
ıı "
.
ıı" #
Key
ıı# &
,
ıı& '
Amount
ˆˆ 
=
ˆˆ 
points
ˆˆ $
,
ˆˆ$ %
UserName
˜˜ 
=
˜˜ 
userInformation
˜˜ -
.
˜˜- .
UserName
˜˜. 6
,
˜˜6 7
	CreatedAt
¯¯ 
=
¯¯ 
DateTime
¯¯ &
.
¯¯& '
Now
¯¯' *
}
˘˘ 
)
˘˘ 
;
˘˘ 
}
˙˙ 	
if
¸¸ 

(
¸¸ 
grading
¸¸ 
.
¸¸ 

ScopeLevel
¸¸ 
>=
¸¸ !
	Constants
¸¸" +
.
¸¸+ ,!
CustomerModel6Scope
¸¸, ?
[
¸¸? @
$num
¸¸@ A
]
¸¸A B
)
¸¸B C
{
˝˝ 	
leaderBoardModel6
˛˛ 
.
˛˛ 
Add
˛˛ !
(
˛˛! "
new
˛˛" %
LeaderBoardModel6
˛˛& 7
{
ˇˇ 
AffiliateId
ÄÄ 
=
ÄÄ 
user
ÄÄ "
.
ÄÄ" #
Key
ÄÄ# &
,
ÄÄ& '
Amount
ÅÅ 
=
ÅÅ 
points
ÅÅ $
,
ÅÅ$ %
UserName
ÇÇ 
=
ÇÇ 
userInformation
ÇÇ -
.
ÇÇ- .
UserName
ÇÇ. 6
,
ÇÇ6 7
	CreatedAt
ÉÉ 
=
ÉÉ 
DateTime
ÉÉ &
.
ÉÉ& '
Now
ÉÉ' *
}
ÑÑ 
)
ÑÑ 
;
ÑÑ 
}
ÖÖ 	
}
ÜÜ 
private
ää 
static
ää 
async
ää 
Task
ää 
<
ää 

GradingDto
ää (
?
ää( )
>
ää) *!
GradingModelFiveSix
ää+ >
(
ää> ?%
ModelFourFiveSixMessage
ãã 
model
ãã* /
,
ãã/ 0$
IAccountServiceAdapter
åå 
?
åå #
accountServiceAdapter
åå# 8
,
åå8 9
IWalletRepository
çç 
walletRepository
çç# 3
,
çç3 4
decimal
éé 
payment
éé# *
,
éé* + 
UserGradingRequest
èè 
userInformation
èè# 2
,
èè2 3
KeyValuePair
êê 
<
êê 
int
êê 
,
êê 
decimal
êê !
>
êê! "
user
êê# '
,
êê' (
long
êê( ,
brandId
êê- 4
)
êê4 5
{
ëë 
var
íí 
pointsModel
íí 
=
íí 
payment
íí !
+
íí" #
(
íí$ %
decimal
íí% ,
)
íí, -
userInformation
íí- <
.
íí< =
Commissions
íí= H
;
ííH I
var
îî 
grading
îî 
=
îî 
model
îî 
.
îî 
Gradings
îî $
.
îî$ %
Where
îî% *
(
îî* +
x
îî+ ,
=>
ïï 
x
ïï 
.
ïï 
VolumePoints
ïï !
<
ïï" #
pointsModel
ïï$ /
&&
ïï0 2
x
ïï3 4
.
ïï4 5

ScopeLevel
ïï5 ?
>
ïï@ A
	Constants
ïïB K
.
ïïK L!
CustomerModel4Scope
ïïL _
[
ïï_ `
$num
ïï` a
]
ïïa b
)
ïïb c
.
ññ 
MaxBy
ññ 
(
ññ 
o
ññ 
=>
ññ 
o
ññ 
.
ññ 

ScopeLevel
ññ $
)
ññ$ %
;
ññ% &
if
òò 

(
òò 
grading
òò 
is
òò 
null
òò 
)
òò 
return
ôô 
null
ôô 
;
ôô 
if
õõ 

(
õõ 
grading
õõ 
.
õõ 

ScopeLevel
õõ 
<=
õõ !
	Constants
õõ" +
.
õõ+ ,!
CustomerModel5Scope
õõ, ?
)
õõ? @
return
úú 
grading
úú 
;
úú 
await
ûû  
CreateDebitPayment
ûû  
(
ûû  !
walletRepository
üü 
,
üü 
user
†† 
.
†† 
Key
†† 
,
†† 
userInformation
°° 
.
°° 
UserName
°° $
,
°°$ %
grading
¢¢ 
.
¢¢ 
PersonalPurchases
¢¢ %
,
¢¢% &
string
££ 
.
££ 
Format
££ 
(
££ 
	Constants
££ #
.
££# $.
 ConceptCommissionModelSixPayment
££$ D
,
££D E
grading
££F M
.
££M N
PersonalPurchases
££N _
,
££_ `
grading
££a h
.
££h i
Name
££i m
)
££m n
,
££n o
WalletConceptType
§§ 
.
§§ 
model_six_payment
§§ /
.
§§/ 0
ToString
§§0 8
(
§§8 9
)
§§9 :
)
§§: ;
;
§§; <
await
•• #
accountServiceAdapter
•• #
!
••# $
.
••$ %!
UpdateGradingByUser
••% 8
(
••8 9
user
••9 =
.
••= >
Key
••> A
,
••A B
grading
••C J
.
••J K
Id
••K M
,
••M N
brandId
••O V
)
••V W
;
••W X
return
ßß 
grading
ßß 
;
ßß 
}
®® 
private
™™ 
static
™™ 
async
™™ 
Task
™™ 
CreditModel4
™™ *
(
™™* +
IWalletRepository
´´ 
walletRepository
´´' 7
,
´´7 8
decimal
¨¨ 
payment
¨¨' .
,
¨¨. /
decimal
≠≠ 
creditPointLeft
≠≠' 6
,
≠≠6 7
decimal
ÆÆ 
creditPointRight
ÆÆ' 7
,
ÆÆ7 8 
UserGradingRequest
ØØ 
userInformation
ØØ' 6
,
ØØ6 7
bool
∞∞ 
hasTwoChildren
∞∞' 5
)
∞∞5 6
{
±± 
hasTwoChildren
≤≤ 
=
≤≤ 
true
≤≤ 
;
≤≤ 
if
≥≥ 

(
≥≥ 
hasTwoChildren
≥≥ 
)
≥≥ 
{
¥¥ 	
await
∂∂ !
CreateCreditPayment
∂∂ %
(
∂∂% &
walletRepository
∑∑  
,
∑∑  !
userInformation
∏∏ 
.
∏∏  
AffiliateId
∏∏  +
,
∏∏+ ,
userInformation
ππ 
.
ππ  
UserName
ππ  (
,
ππ( )
(
∫∫ 
double
∫∫ 
)
∫∫ 
payment
∫∫ 
,
∫∫  
string
ªª 
.
ªª 
Format
ªª 
(
ªª 
	Constants
ªª '
.
ªª' (,
ConceptCommissionBinaryPayment
ªª( F
,
ªªF G
payment
ªªH O
,
ªªO P
userInformation
ªªQ `
.
ªª` a
Grading
ªªa h
!
ªªh i
.
ªªi j
Name
ªªj n
)
ªªn o
,
ªªo p
WalletConceptType
ºº !
.
ºº! " 
model_four_payment
ºº" 4
.
ºº4 5
ToString
ºº5 =
(
ºº= >
)
ºº> ?
)
ΩΩ 
;
ΩΩ 
await
øø 
walletRepository
øø "
.
øø" #
TransactionPoints
øø# 4
(
øø4 5
userInformation
¿¿ 
.
¿¿  
AffiliateId
¿¿  +
,
¿¿+ ,
payment
¿¿- 4
,
¿¿4 5
payment
¿¿6 =
,
¿¿= >
creditPointLeft
¡¡ 
,
¡¡  
creditPointRight
¬¬  
)
¬¬  !
;
¬¬! "
}
√√ 	
}
ƒƒ 
private
∆∆ 
static
∆∆ 
Task
∆∆  
CreateDebitPayment
∆∆ *
(
∆∆* +
IWalletRepository
«« 
walletRepository
«« *
,
««* +
int
»» 
userId
»»  
,
»»  !
string
…… 
userName
…… "
,
……" #
decimal
   
payment
   !
,
  ! "
string
ÀÀ 
concept
ÀÀ !
,
ÀÀ! "
string
ÃÃ 
conceptType
ÃÃ %
)
ÃÃ% &
{
ÕÕ 
if
ŒŒ 

(
ŒŒ 
payment
ŒŒ 
<=
ŒŒ 
$num
ŒŒ 
)
ŒŒ 
return
œœ 
Task
œœ 
.
œœ 
CompletedTask
œœ %
;
œœ% &
return
—— 
Task
—— 
.
—— 
CompletedTask
—— !
;
——! "
var
”” 
creditTransaction
”” 
=
”” 
new
””  #%
DebitTransactionRequest
””$ ;
{
‘‘ 	
AffiliateId
’’ 
=
’’ 
userId
’’  &
,
’’& '
AffiliateUserName
÷÷ 
=
÷÷ 
userName
÷÷  (
,
÷÷( )
Debit
◊◊ 
=
◊◊ 
payment
◊◊  '
,
◊◊' (
PaymentMethod
ÿÿ 
=
ÿÿ 
$str
ÿÿ  +
,
ÿÿ+ ,
UserId
ŸŸ 
=
ŸŸ 
	Constants
ŸŸ  )
.
ŸŸ) *
AdminUserId
ŸŸ* 5
,
ŸŸ5 6
Concept
⁄⁄ 
=
⁄⁄ 
concept
⁄⁄  '
,
⁄⁄' (
AdminUserName
€€ 
=
€€ 
	Constants
€€  )
.
€€) *$
AdminEcosystemUserName
€€* @
,
€€@ A
ConceptType
‹‹ 
=
‹‹ 
conceptType
‹‹  +
}
›› 	
;
››	 

return
ﬁﬁ 
walletRepository
ﬁﬁ 
.
ﬁﬁ  '
DebitEcoPoolTransactionSp
ﬁﬁ  9
(
ﬁﬁ9 :
creditTransaction
ﬁﬁ: K
)
ﬁﬁK L
;
ﬁﬁL M
}
ﬂﬂ 
private
·· 
static
·· 
Task
·· !
CreateCreditPayment
·· +
(
··+ ,
IWalletRepository
‚‚ 
walletRepository
‚‚ *
,
‚‚* +
int
„„ 
userId
„„  
,
„„  !
string
‰‰ 
userName
‰‰ "
,
‰‰" #
double
ÂÂ 
globalPayment
ÂÂ '
,
ÂÂ' (
string
ÊÊ 
concept
ÊÊ !
,
ÊÊ! "
string
ÁÁ 
conceptType
ÁÁ %
)
ÁÁ% &
{
ËË 
if
ÈÈ 

(
ÈÈ 
globalPayment
ÈÈ 
<=
ÈÈ 
$num
ÈÈ 
)
ÈÈ 
return
ÍÍ 
Task
ÍÍ 
.
ÍÍ 
CompletedTask
ÍÍ %
;
ÍÍ% &
return
ÏÏ 
Task
ÏÏ 
.
ÏÏ 
CompletedTask
ÏÏ !
;
ÏÏ! "
var
ÔÔ 
creditTransaction
ÔÔ 
=
ÔÔ 
new
ÔÔ  #&
CreditTransactionRequest
ÔÔ$ <
{
 	
AffiliateId
ÒÒ 
=
ÒÒ 
userId
ÒÒ  &
,
ÒÒ& '
AffiliateUserName
ÚÚ 
=
ÚÚ 
userName
ÚÚ  (
,
ÚÚ( )
Credit
ÛÛ 
=
ÛÛ 
globalPayment
ÛÛ  -
,
ÛÛ- .
UserId
ÙÙ 
=
ÙÙ 
	Constants
ÙÙ  )
.
ÙÙ) *
AdminUserId
ÙÙ* 5
,
ÙÙ5 6
Concept
ıı 
=
ıı 
concept
ıı  '
,
ıı' (
AdminUserName
ˆˆ 
=
ˆˆ 
	Constants
ˆˆ  )
.
ˆˆ) *$
AdminEcosystemUserName
ˆˆ* @
,
ˆˆ@ A
ConceptType
˜˜ 
=
˜˜ 
conceptType
˜˜  +
}
¯¯ 	
;
¯¯	 

return
˘˘ 
walletRepository
˘˘ 
.
˘˘  
CreditTransaction
˘˘  1
(
˘˘1 2
creditTransaction
˘˘2 C
)
˘˘C D
;
˘˘D E
}
˙˙ 
}˚˚ Ã«
cC:\HeroSystem\walletService\WalletService.Core\Kafka\Consumers\ProcessPaymentModel1A1B23Consumer.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
	Consumers# ,
;, -
public 
class -
!ProcessPaymentModel1A1B23Consumer .
:/ 0
BaseKafkaConsumer1 B
{ 
public 
-
!ProcessPaymentModel1A1B23Consumer ,
(, -
ConsumerSettings 
consumerSettings! 1
,1 2$
ApplicationConfiguration  
configuration! .
,. /
ILogger 
logger! '
,' ( 
IServiceScopeFactory 
serviceScopeFactory! 4
)4 5
: 	
base
 
( 
consumerSettings 
,  
configuration! .
,. /
logger0 6
,6 7
serviceScopeFactory8 K
)K L
{ 
}   
	protected## 
override## 
Task## 
<## 
bool##  
>##  !
	OnMessage##" +
(##+ ,
ConsumeResult##, 9
<##9 :
Ignore##: @
,##@ A
string##B H
>##H I
e##J K
)##K L
{$$ 
try%% 
{&& 	
Logger'' 
.'' 
LogInformation'' !
(''! "
$str''" T
)''T U
;''U V
return)) 
Process)) 
()) 
))) 
;)) 
}** 	
catch++ 
(++ 
	Exception++ 
ex++ 
)++ 
{,, 	
Logger-- 
.-- 
LogError-- 
(-- 
$str-- W
,--W X
ex--Y [
)--[ \
;--\ ]
return.. 
Task.. 
... 

FromResult.. "
(.." #
false..# (
)..( )
;..) *
}// 	
finally00 
{11 	
Logger22 
.22 
LogInformation22 !
(22! "
$str22" S
)22S T
;22T U
}33 	
}44 
private66 
async66 
Task66 
<66 
bool66 
>66 
Process66 $
(66$ %
)66% &
{77 
using88 
var88 
scope88( -
=88A B
ServiceScopeFactory88C V
.88V W
CreateScope88W b
(88b c
)88c d
;88d e
var99 $
resultsEcoPoolRepository99( @
=99A B
scope99C H
.99H I
ServiceProvider99I X
.99X Y

GetService99Y c
<99c d%
IResultsEcoPoolRepository99d }
>99} ~
(99~ 
)	99 Ä
;
99Ä Å
var:: 
walletRepository::( 8
=::A B
scope::C H
.::H I
ServiceProvider::I X
.::X Y

GetService::Y c
<::c d
IWalletRepository::d u
>::u v
(::v w
)::w x
;::x y
var;; 
wallet1ARepository;;( :
=;;C D
scope;;E J
.;;J K
ServiceProvider;;K Z
.;;Z [

GetService;;[ e
<;;e f$
IWalletModel1ARepository;;f ~
>;;~ 
(	;; Ä
)
;;Ä Å
;
;;Å Ç
var<< 
wallet1BRepository<<( :
=<<C D
scope<<E J
.<<J K
ServiceProvider<<K Z
.<<Z [

GetService<<[ e
<<<e f$
IWalletModel1BRepository<<f ~
><<~ 
(	<< Ä
)
<<Ä Å
;
<<Å Ç
var==  
configurationAdapter==( <
===A B
scope==C H
.==H I
ServiceProvider==I X
.==X Y

GetService==Y c
<==c d!
IConfigurationAdapter==d y
>==y z
(==z {
)=={ |
;==| }
var>> 
kafkaProducer>>( 5
=>>A B
scope>>C H
.>>H I
ServiceProvider>>I X
.>>X Y

GetService>>Y c
<>>c d
KafkaProducer>>d q
>>>q r
(>>r s
)>>s t
;>>t u
var?? 
brandService??( 4
=??A B
scope??C H
.??H I
ServiceProvider??I X
.??X Y

GetService??Y c
<??c d
IBrandService??d q
>??q r
(??r s
)??s t
;??t u
ICollection@@ 
<@@ 
UserGradingRequest@@ &
>@@& '
listGrading@@( 3
=@@A B
new@@C F
List@@G K
<@@K L
UserGradingRequest@@L ^
>@@^ _
(@@_ `
)@@` a
;@@a b
varAA 
responseGradingsAA( 8
=AAA B
newAAC F
GradingResponseAAG V
(AAV W
)AAW X
;AAX Y
varCC 
branIdCC 
=CC 
brandServiceCC !
!CC! "
.CC" #
BrandIdCC# *
;CC* +
varDD 
listModel1AResultsDD 
=DD  
awaitDD! &$
resultsEcoPoolRepositoryDD' ?
!DD? @
.DD@ A&
GetResultsModel1AToPaymentDDA [
(DD[ \
)DD\ ]
;DD] ^
varEE 
listModel1BResultsEE 
=EE  
awaitEE! &$
resultsEcoPoolRepositoryEE' ?
.EE? @&
GetResultsModel1BToPaymentEE@ Z
(EEZ [
)EE[ \
;EE\ ]
varFF 
listModel2ResultsFF 
=FF 
awaitFF  %$
resultsEcoPoolRepositoryFF& >
.FF> ?%
GetResultsModel2ToPaymentFF? X
(FFX Y
)FFY Z
;FFZ [
varGG 
listModel3ResultsGG 
=GG 
awaitGG  %$
resultsEcoPoolRepositoryGG& >
.GG> ?$
GetResultsMode3ToPaymentGG? W
(GGW X
)GGX Y
;GGY Z
varII &
dictionaryPointsModelTotalII &
=II' (
newII) ,

DictionaryII- 7
<II7 8
intII8 ;
,II; <
UserGradingRequestII= O
>IIO P
(IIP Q
)IIQ R
;IIR S
varKK 
dictionaryModel1AKK 
=KK 
listModel1AResultsKK  2
.KK2 3
GroupByKK3 :
(KK: ;
xKK; <
=>LL 
xLL 
.LL 
AffiliateIdLL 
)LL 
.LL 
ToDictionaryLL *
(LL* +
groupLL+ 0
=>LL1 3
groupLL4 9
.LL9 :
KeyLL: =
,LL= >
groupLL? D
=>LLE G
groupLLH M
.LLM N
ToListLLN T
(LLT U
)LLU V
)LLV W
;LLW X
varNN 
dictionaryModel1BNN 
=NN 
listModel1BResultsNN  2
.NN2 3
GroupByNN3 :
(NN: ;
xNN; <
=>OO 
xOO 
.OO 
AffiliateIdOO 
)OO 
.OO 
ToDictionaryOO *
(OO* +
groupOO+ 0
=>OO1 3
groupOO4 9
.OO9 :
KeyOO: =
,OO= >
groupOO? D
=>OOE G
groupOOH M
.OOM N
ToListOON T
(OOT U
)OOU V
)OOV W
;OOW X
varQQ 
dictionaryModel2QQ 
=QQ 
listModel2ResultsQQ 0
.QQ0 1
GroupByQQ1 8
(QQ8 9
xQQ9 :
=>RR 
xRR 
.RR 
AffiliateIdRR 
)RR 
.RR 
ToDictionaryRR *
(RR* +
groupRR+ 0
=>RR1 3
groupRR4 9
.RR9 :
KeyRR: =
,RR= >
groupRR? D
=>RRE G
groupRRH M
.RRM N
ToListRRN T
(RRT U
)RRU V
)RRV W
;RRW X
varTT 
dictionaryModel3TT 
=TT 
listModel3ResultsTT 0
.TT0 1
GroupByTT1 8
(TT8 9
xTT9 :
=>UU 
xUU 
.UU 
AffiliateIdUU 
)UU 
.UU 
ToDictionaryUU *
(UU* +
groupUU+ 0
=>UU1 3
groupUU4 9
.UU9 :
KeyUU: =
,UU= >
groupUU? D
=>UUE G
groupUUH M
.UUM N
ToListUUN T
(UUT U
)UUU V
)UUV W
;UUW X
ifWW 

(WW 
listModel2ResultsWW 
isWW  
{WW! "
CountWW# (
:WW( )
$numWW* +
}WW, -
&&WW. 0
listModel3ResultsWW1 B
isWWC E
{WWF G
CountWWH M
:WWM N
$numWWO P
}WWQ R
)WWR S
returnXX 
falseXX 
;XX 
varZZ 
gradingResponseZZ 
=ZZ 
awaitZZ # 
configurationAdapterZZ$ 8
!ZZ8 9
.ZZ9 :
GetGradingsZZ: E
(ZZE F
branIdZZF L
)ZZL M
;ZZM N
if[[ 

([[ 
gradingResponse[[ 
.[[ 
IsSuccessful[[ (
&&[[) +
![[, -
string[[- 3
.[[3 4
IsNullOrEmpty[[4 A
([[A B
gradingResponse[[B Q
.[[Q R
Content[[R Y
)[[Y Z
)[[Z [
responseGradings\\ 
=\\ 
gradingResponse\\ .
.\\. /
Content\\/ 6
.\\6 7
ToJsonObject\\7 C
<\\C D
GradingResponse\\D S
>\\S T
(\\T U
)\\U V
;\\V W
ICollection^^ 
<^^ 

GradingDto^^ 
>^^ 
gradings^^  (
=^^) *
responseGradings^^+ ;
!^^; <
.^^< =
Data^^= A
;^^A B
await`` 
CommissionsModel1A``  
(``  !
dictionaryModel1A``! 2
,``2 3
wallet1ARepository``4 F
,``F G
walletRepository``H X
,``X Y&
dictionaryPointsModelTotal``Z t
)``t u
;``u v
awaitbb 
CommissionsModel1Bbb  
(bb  !
dictionaryModel1Bbb! 2
,bb2 3
wallet1BRepositorybb4 F
,bbF G
walletRepositorybbH X
,bbX Y&
dictionaryPointsModelTotalbbZ t
)bbt u
;bbu v
awaitdd 
CommissionsModel3dd 
(dd  
dictionaryModel3dd  0
,dd0 1
walletRepositorydd2 B
,ddB C&
dictionaryPointsModelTotalddD ^
)dd^ _
;dd_ `
awaitff 
CommissionsModel2ff 
(ff  
dictionaryModel2ff  0
,ff0 1
walletRepositoryff2 B
,ffB C&
dictionaryPointsModelTotalffD ^
)ff^ _
;ff_ `
varhh 
modelhh 
=hh 
CreateGradingListhh %
(hh% &&
dictionaryPointsModelTotalhh& @
,hh@ A
listGradinghhB M
,hhM N
gradingshhO W
)hhW X
;hhX Y
_ii 	
=ii
 
Taskii 
.ii 
Runii 
(ii 
asyncii 
(ii 
)ii 
=>jj 
awaitjj 
kafkaProducerjj "
!jj" #
.jj# $
ProduceAsyncjj$ 0
(jj0 1
KafkaTopicsjj1 <
.jj< =(
ProcessModelFourFiveSixTopicjj= Y
,jjY Z
modeljj[ `
.jj` a
ToJsonStringjja m
(jjm n
)jjn o
)jjo p
)jjp q
;jjq r
returnll 
truell 
;ll 
}mm 
privatepp 
staticpp #
ModelFourFiveSixMessagepp .
CreateGradingListpp/ @
(pp@ A

Dictionaryqq 
<qq 
intqq 
,qq 
UserGradingRequestqq *
>qq* +
dictionaryPointsqq; K
,qqK L
ICollectionrr 
<rr 
UserGradingRequestrr &
>rr& '
listGradingrr/ :
,rr: ;
ICollectionss 
<ss 

GradingDtoss 
>ss 
gradingsss/ 7
)ss7 8
{tt 
foreachuu 
(uu 
varuu 
(uu 
keyuu 
,uu 
valueuu  
)uu  !
inuu" $
dictionaryPointsuu% 5
)uu5 6
{vv 	
AddOrUpdateGradingww 
(ww 
refxx 
listGradingxx 
,xx  
keyyy 
,yy 
valuezz 
.zz 
AffiliateOwnerIdzz &
,zz& '
value{{ 
.{{ 
UserName{{ 
,{{ 
value|| 
.|| 
Commissions|| !
,||! "
value}} 
.}} 
Points}} 
,}} 
value~~ 
.~~ 
Side~~ 
,~~ 
value 
. 
UserCreatedAt #
,# $
gradings
ÄÄ 
)
ÄÄ 
;
ÄÄ 
}
ÅÅ 	
var
ÉÉ 
model
ÉÉ 
=
ÉÉ 
new
ÉÉ %
ModelFourFiveSixMessage
ÉÉ /
{
ÑÑ 	
Gradings
ÖÖ 
=
ÖÖ 
gradings
ÖÖ #
.
ÖÖ# $
Where
ÖÖ$ )
(
ÖÖ) *
x
ÖÖ* +
=>
ÖÖ, .
x
ÖÖ/ 0
.
ÖÖ0 1

ScopeLevel
ÖÖ1 ;
>=
ÖÖ< >
$num
ÖÖ? @
)
ÖÖ@ A
.
ÖÖA B
ToList
ÖÖB H
(
ÖÖH I
)
ÖÖI J
,
ÖÖJ K
UserGradings
ÜÜ 
=
ÜÜ 
listGrading
ÜÜ &
.
ÜÜ& '
Where
ÜÜ' ,
(
ÜÜ, -
x
ÜÜ- .
=>
ÜÜ/ 1
x
ÜÜ2 3
.
ÜÜ3 4
Grading
ÜÜ4 ;
is
ÜÜ< >
{
ÜÜ? @

ScopeLevel
ÜÜA K
:
ÜÜK L
>=
ÜÜM O
$num
ÜÜP Q
}
ÜÜR S
)
ÜÜS T
.
ÜÜT U
ToList
ÜÜU [
(
ÜÜ[ \
)
ÜÜ\ ]
}
áá 	
;
áá	 

return
àà 
model
àà 
;
àà 
}
ââ 
private
ãã 
static
ãã 
async
ãã 
Task
ãã 
CommissionsModel2
ãã /
(
ãã/ 0

Dictionary
åå 
<
åå 
int
åå 
,
åå 
List
åå 
<
åå 
ResultsModel2
åå *
>
åå* +
>
åå+ ,

dictionary
åå- 7
,
åå7 8
IWalletRepository
çç 
?
çç 
walletRepository
çç- =
,
çç= >

Dictionary
éé 
<
éé 
int
éé 
,
éé  
UserGradingRequest
éé *
>
éé* +&
dictionaryPointsModelTwo
éé- E
)
ééE F
{
èè 
foreach
êê 
(
êê 
var
êê 
(
êê 
key
êê 
,
êê 
listPoolsPerUser
êê +
)
êê+ ,
in
êê- /

dictionary
êê0 :
)
êê: ;
{
ëë 	
var
ìì 
globalPayment
ìì 
=
ìì 
(
ìì  !
double
ìì! '
)
ìì' (
listPoolsPerUser
ìì( 8
.
ìì8 9
Sum
ìì9 <
(
ìì< =
x
ìì= >
=>
ìì? A
x
ììB C
.
ììC D
PaymentAmount
ììD Q
)
ììQ R
;
ììR S
var
îî 
userName
îî 
=
îî 
listPoolsPerUser
îî  0
.
îî0 1
First
îî1 6
(
îî6 7
)
îî7 8
.
îî8 9
AffiliateName
îî9 F
;
îîF G
if
ïï 
(
ïï 
walletRepository
ïï  
is
ïï! #
not
ïï$ '
null
ïï( ,
&&
ïï- /
globalPayment
ïï0 =
is
ïï> @
not
ïïA D
$num
ïïE F
)
ïïF G
await
ññ !
CreateCreditPayment
ññ )
(
ññ) *
walletRepository
óó $
,
óó$ %
key
òò 
,
òò 
userName
ôô 
,
ôô 
globalPayment
öö !
,
öö! "
	Constants
õõ 
.
õõ 3
%CommissionModelThreeDescriptionNormal
õõ C
,
õõC D
WalletConceptType
úú %
.
úú% &
purchasing_pool
úú& 5
.
úú5 6
ToString
úú6 >
(
úú> ?
)
úú? @
)
úú@ A
;
úúA B
var
ûû 
listPerLevels
ûû 
=
ûû 
listPoolsPerUser
ûû  0
.
ûû0 1

SelectMany
ûû1 ;
(
ûû; <
x
ûû< =
=>
ûû> @
x
ûûA B
.
ûûB C!
ResultsModel2Levels
ûûC V
)
ûûV W
;
ûûW X
var
üü !
dictionaryPerLevels
üü #
=
üü$ %
listPerLevels
üü& 3
.
üü3 4
GroupBy
üü4 ;
(
üü; <
x
üü< =
=>
†† 
x
†† 
.
†† 
AffiliateId
††  
)
††  !
.
††! "
ToDictionary
††" .
(
††. /
group
††/ 4
=>
††5 7
group
††8 =
.
††= >
Key
††> A
,
††A B
group
††C H
=>
††I K
group
††L Q
.
††Q R
ToList
††R X
(
††X Y
)
††Y Z
)
††Z [
;
††[ \
foreach
¢¢ 
(
¢¢ 
var
¢¢ 
(
¢¢ 
	userLevel
¢¢ #
,
¢¢# $
ecoPoolLevelsList
¢¢% 6
)
¢¢6 7
in
¢¢8 :!
dictionaryPerLevels
¢¢; N
)
¢¢N O
{
££ 
if
§§ 
(
§§ 
ecoPoolLevelsList
§§ %
.
§§% &
Any
§§& )
(
§§) *
x
§§* +
=>
§§, .
x
§§/ 0
.
§§0 1
CompletedAt
§§1 <
!=
§§= ?
null
§§@ D
)
§§D E
)
§§E F
continue
•• 
;
•• 
var
ßß 
userNameLevel
ßß !
=
ßß' (
ecoPoolLevelsList
ßß) :
.
ßß: ;
First
ßß; @
(
ßß@ A
)
ßßA B
.
ßßB C
AffiliateName
ßßC P
;
ßßP Q
var
®® 
level
®® 
=
®®' (
ecoPoolLevelsList
®®) :
.
®®: ;
First
®®; @
(
®®@ A
)
®®A B
.
®®B C
Level
®®C H
;
®®H I
var
©©  
globalPaymentLevel
©© &
=
©©' (
(
©©) *
double
©©* 0
)
©©0 1
ecoPoolLevelsList
©©1 B
.
©©B C
Sum
©©C F
(
©©F G
x
©©G H
=>
©©I K
x
©©L M
.
©©M N
PaymentAmount
©©N [
)
©©[ \
;
©©\ ]
if
´´ 
(
´´ 
walletRepository
´´ $
is
´´% '
null
´´( ,
||
´´- / 
globalPaymentLevel
´´0 B
is
´´C E
$num
´´F G
)
´´G H
continue
¨¨ 
;
¨¨ 
if
ÆÆ 
(
ÆÆ &
dictionaryPointsModelTwo
ÆÆ ,
.
ÆÆ, -
ContainsKey
ÆÆ- 8
(
ÆÆ8 9
	userLevel
ÆÆ9 B
)
ÆÆB C
)
ÆÆC D
{
ØØ &
dictionaryPointsModelTwo
∞∞ ,
[
∞∞, -
	userLevel
∞∞- 6
]
∞∞6 7
.
∞∞7 8
Points
∞∞8 >
+=
∞∞D F 
globalPaymentLevel
∞∞H Z
;
∞∞Z [&
dictionaryPointsModelTwo
±± ,
[
±±, -
	userLevel
±±- 6
]
±±6 7
.
±±7 8
Commissions
±±8 C
+=
±±D F 
globalPaymentLevel
±±G Y
;
±±Y Z
}
≤≤ 
else
≥≥ &
dictionaryPointsModelTwo
¥¥ ,
.
¥¥, -
Add
¥¥- 0
(
¥¥0 1
	userLevel
¥¥1 :
,
¥¥: ;
new
¥¥< ? 
UserGradingRequest
¥¥@ R
(
¥¥R S
)
¥¥S T
{
µµ 
Commissions
∂∂ #
=
∂∂) * 
globalPaymentLevel
∂∂+ =
,
∂∂= >
Points
∑∑ 
=
∑∑) * 
globalPaymentLevel
∑∑+ =
,
∑∑= >
AffiliateId
∏∏ #
=
∏∏) *
	userLevel
∏∏+ 4
,
∏∏4 5
Side
ππ 
=
ππ) *
ecoPoolLevelsList
ππ+ <
.
ππ< =
First
ππ= B
(
ππB C
)
ππC D
.
ππD E

BinarySide
ππE O
,
ππO P
AffiliateOwnerId
∫∫ (
=
∫∫) *
key
∫∫+ .
,
∫∫. /
UserName
ªª  
=
ªª) *
ecoPoolLevelsList
ªª+ <
.
ªª< =
First
ªª= B
(
ªªB C
)
ªªC D
.
ªªD E
AffiliateName
ªªE R
,
ªªR S
UserCreatedAt
ºº %
=
ºº) *
ecoPoolLevelsList
ºº+ <
.
ºº< =
First
ºº= B
(
ººB C
)
ººC D
.
ººD E
UserCreatedAt
ººE R
}
ΩΩ 
)
ΩΩ 
;
ΩΩ 
await
øø !
CreateCreditPayment
øø )
(
øø) *
walletRepository
¿¿ $
,
¿¿$ %
	userLevel
¡¡ 
,
¡¡ 
userNameLevel
¬¬ !
,
¬¬! " 
globalPaymentLevel
√√ &
,
√√& '
string
ƒƒ 
.
ƒƒ 
Format
ƒƒ !
(
ƒƒ! "
	Constants
ƒƒ" +
.
ƒƒ+ ,-
CommissionModelThreeDescription
ƒƒ, K
,
ƒƒK L
userName
ƒƒM U
,
ƒƒU V
level
ƒƒW \
)
ƒƒ\ ]
,
ƒƒ] ^
WalletConceptType
≈≈ %
.
≈≈% &
pool_commission
≈≈& 5
.
≈≈5 6
ToString
≈≈6 >
(
≈≈> ?
)
≈≈? @
)
≈≈@ A
;
≈≈A B
}
∆∆ 
}
«« 	
}
»» 
private
   
static
   
async
   
Task
   
CommissionsModel3
   /
(
  / 0

Dictionary
ÀÀ 
<
ÀÀ 
int
ÀÀ 
,
ÀÀ 
List
ÀÀ 
<
ÀÀ 
ResultsModel3
ÀÀ *
>
ÀÀ* +
>
ÀÀ+ ,
dictionaryModelT3
ÀÀ- >
,
ÀÀ> ?
IWalletRepository
ÃÃ 
?
ÃÃ 
walletRepository
ÃÃ- =
,
ÃÃ= >

Dictionary
ÕÕ 
<
ÕÕ 
int
ÕÕ 
,
ÕÕ  
UserGradingRequest
ÕÕ *
>
ÕÕ* +&
dictionaryPointsModelTwo
ÕÕ- E
)
ÕÕE F
{
ŒŒ 
foreach
œœ 
(
œœ 
var
œœ 
(
œœ 
key
œœ 
,
œœ 
listPoolsPerUser
œœ +
)
œœ+ ,
in
œœ- /
dictionaryModelT3
œœ0 A
)
œœA B
{
–– 	
var
““ 
globalPayment
““ 
=
““ 
(
““  !
double
““! '
)
““' (
listPoolsPerUser
““( 8
.
““8 9
Sum
““9 <
(
““< =
x
““= >
=>
““? A
x
““B C
.
““C D
PaymentAmount
““D Q
)
““Q R
;
““R S
var
”” 
userName
”” 
=
”” 
listPoolsPerUser
””  0
.
””0 1
First
””1 6
(
””6 7
)
””7 8
.
””8 9
AffiliateName
””9 F
;
””F G
if
‘‘ 
(
‘‘ 
walletRepository
‘‘  
is
‘‘! #
not
‘‘$ '
null
‘‘( ,
&&
‘‘- /
globalPayment
‘‘0 =
is
‘‘> @
not
‘‘A D
$num
‘‘E F
)
‘‘F G
await
’’ !
CreateCreditPayment
’’ )
(
’’) *
walletRepository
÷÷ $
,
÷÷$ %
key
◊◊ 
,
◊◊ 
userName
ÿÿ 
,
ÿÿ 
globalPayment
ŸŸ !
,
ŸŸ! "
	Constants
⁄⁄ 
.
⁄⁄ 1
#CommissionModelTwoDescriptionNormal
⁄⁄ A
,
⁄⁄A B
WalletConceptType
€€ %
.
€€% &
purchasing_pool
€€& 5
.
€€5 6
ToString
€€6 >
(
€€> ?
)
€€? @
)
€€@ A
;
€€A B
var
›› 
listPerLevels
›› 
=
›› 
listPoolsPerUser
››  0
.
››0 1

SelectMany
››1 ;
(
››; <
x
››< =
=>
››> @
x
››A B
.
››B C!
ResultsModel3Levels
››C V
)
››V W
;
››W X
var
ﬁﬁ !
dictionaryPerLevels
ﬁﬁ #
=
ﬁﬁ$ %
listPerLevels
ﬁﬁ& 3
.
ﬁﬁ3 4
GroupBy
ﬁﬁ4 ;
(
ﬁﬁ; <
x
ﬁﬁ< =
=>
ﬂﬂ 
x
ﬂﬂ 
.
ﬂﬂ 
AffiliateId
ﬂﬂ  
)
ﬂﬂ  !
.
ﬂﬂ! "
ToDictionary
ﬂﬂ" .
(
ﬂﬂ. /
group
ﬂﬂ/ 4
=>
ﬂﬂ5 7
group
ﬂﬂ8 =
.
ﬂﬂ= >
Key
ﬂﬂ> A
,
ﬂﬂA B
group
ﬂﬂC H
=>
ﬂﬂI K
group
ﬂﬂL Q
.
ﬂﬂQ R
ToList
ﬂﬂR X
(
ﬂﬂX Y
)
ﬂﬂY Z
)
ﬂﬂZ [
;
ﬂﬂ[ \
foreach
·· 
(
·· 
var
·· 
(
·· 
	userLevel
·· #
,
··# $
ecoPoolLevelsList
··% 6
)
··6 7
in
··8 :!
dictionaryPerLevels
··; N
)
··N O
{
‚‚ 
if
‰‰ 
(
‰‰ 
ecoPoolLevelsList
‰‰ %
.
‰‰% &
Any
‰‰& )
(
‰‰) *
x
‰‰* +
=>
‰‰, .
x
‰‰/ 0
.
‰‰0 1
CompletedAt
‰‰1 <
!=
‰‰= ?
null
‰‰@ D
)
‰‰D E
)
‰‰E F
continue
ÂÂ 
;
ÂÂ 
var
ÁÁ 
userNameLevel
ÁÁ !
=
ÁÁ' (
ecoPoolLevelsList
ÁÁ) :
.
ÁÁ: ;
First
ÁÁ; @
(
ÁÁ@ A
)
ÁÁA B
.
ÁÁB C
AffiliateName
ÁÁC P
;
ÁÁP Q
var
ËË 
level
ËË 
=
ËË' (
ecoPoolLevelsList
ËË) :
.
ËË: ;
First
ËË; @
(
ËË@ A
)
ËËA B
.
ËËB C
Level
ËËC H
;
ËËH I
var
ÈÈ  
globalPaymentLevel
ÈÈ &
=
ÈÈ' (
(
ÈÈ) *
double
ÈÈ* 0
)
ÈÈ0 1
ecoPoolLevelsList
ÈÈ1 B
.
ÈÈB C
Sum
ÈÈC F
(
ÈÈF G
x
ÈÈG H
=>
ÈÈI K
x
ÈÈL M
.
ÈÈM N
PaymentAmount
ÈÈN [
)
ÈÈ[ \
;
ÈÈ\ ]
if
ÎÎ 
(
ÎÎ 
walletRepository
ÎÎ $
is
ÎÎ% '
null
ÎÎ( ,
||
ÎÎ- / 
globalPaymentLevel
ÎÎ0 B
is
ÎÎC E
$num
ÎÎF G
)
ÎÎG H
continue
ÏÏ 
;
ÏÏ 
if
ÓÓ 
(
ÓÓ &
dictionaryPointsModelTwo
ÓÓ ,
.
ÓÓ, -
ContainsKey
ÓÓ- 8
(
ÓÓ8 9
	userLevel
ÓÓ9 B
)
ÓÓB C
)
ÓÓC D
{
ÔÔ &
dictionaryPointsModelTwo
 ,
[
, -
	userLevel
- 6
]
6 7
.
7 8
Points
8 >
=
D E 
globalPaymentLevel
G Y
;
Y Z&
dictionaryPointsModelTwo
ÒÒ ,
[
ÒÒ, -
	userLevel
ÒÒ- 6
]
ÒÒ6 7
.
ÒÒ7 8
Commissions
ÒÒ8 C
+=
ÒÒD F 
globalPaymentLevel
ÒÒG Y
;
ÒÒY Z
}
ÚÚ 
else
ÛÛ &
dictionaryPointsModelTwo
ÙÙ ,
.
ÙÙ, -
Add
ÙÙ- 0
(
ÙÙ0 1
	userLevel
ÙÙ1 :
,
ÙÙ: ;
new
ÙÙ< ? 
UserGradingRequest
ÙÙ@ R
(
ÙÙR S
)
ÙÙS T
{
ıı 
Commissions
ˆˆ #
=
ˆˆ) * 
globalPaymentLevel
ˆˆ+ =
,
ˆˆ= >
Points
˜˜ 
=
˜˜) * 
globalPaymentLevel
˜˜+ =
,
˜˜= >
AffiliateId
¯¯ #
=
¯¯) *
	userLevel
¯¯+ 4
,
¯¯4 5
Side
˘˘ 
=
˘˘) *
ecoPoolLevelsList
˘˘+ <
.
˘˘< =
First
˘˘= B
(
˘˘B C
)
˘˘C D
.
˘˘D E

BinarySide
˘˘E O
,
˘˘O P
AffiliateOwnerId
˙˙ (
=
˙˙) *
key
˙˙+ .
,
˙˙. /
UserName
˚˚  
=
˚˚) *
ecoPoolLevelsList
˚˚+ <
.
˚˚< =
First
˚˚= B
(
˚˚B C
)
˚˚C D
.
˚˚D E
AffiliateName
˚˚E R
,
˚˚R S
UserCreatedAt
¸¸ %
=
¸¸) *
ecoPoolLevelsList
¸¸+ <
.
¸¸< =
First
¸¸= B
(
¸¸B C
)
¸¸C D
.
¸¸D E
UserCreatedAt
¸¸E R
}
˝˝ 
)
˝˝ 
;
˝˝ 
await
ˇˇ !
CreateCreditPayment
ˇˇ )
(
ˇˇ) *
walletRepository
ÄÄ $
,
ÄÄ$ %
	userLevel
ÅÅ 
,
ÅÅ 
userNameLevel
ÇÇ !
,
ÇÇ! " 
globalPaymentLevel
ÉÉ &
,
ÉÉ& '
string
ÑÑ 
.
ÑÑ 
Format
ÑÑ !
(
ÑÑ! "
	Constants
ÑÑ" +
.
ÑÑ+ ,+
CommissionModelTwoDescription
ÑÑ, I
,
ÑÑI J
userName
ÑÑK S
,
ÑÑS T
level
ÑÑU Z
)
ÑÑZ [
,
ÑÑ[ \
WalletConceptType
ÖÖ %
.
ÖÖ% &
pool_commission
ÖÖ& 5
.
ÖÖ5 6
ToString
ÖÖ6 >
(
ÖÖ> ?
)
ÖÖ? @
)
ÖÖ@ A
;
ÖÖA B
}
ÜÜ 
}
áá 	
}
àà 
private
ââ 
static
ââ 
async
ââ 
Task
ââ  
CommissionsModel1A
ââ 0
(
ââ0 1

Dictionary
ää 
<
ää 
int
ää 
,
ää 
List
ää 
<
ää 
ResultsModel1a
ää +
>
ää+ ,
>
ää, -
dictionaryModel1A
ää. ?
,
ää? @&
IWalletModel1ARepository
ãã  
?
ãã  ! 
walletRepository1A
ãã. @
,
ãã@ A
IWalletRepository
åå 
?
åå 
walletRepository
åå. >
,
åå> ?

Dictionary
çç 
<
çç 
int
çç 
,
çç  
UserGradingRequest
çç *
>
çç* +%
dictionaryPointsModel1A
çç. E
)
ççE F
{
éé 
foreach
èè 
(
èè 
var
èè 
(
èè 
key
èè 
,
èè 
listPoolsPerUser
èè +
)
èè+ ,
in
èè- /
dictionaryModel1A
èè0 A
)
èèA B
{
êê 	
var
ëë 
globalPayment
ëë 
=
ëë 
(
ëë  !
double
ëë! '
)
ëë' (
listPoolsPerUser
ëë( 8
.
ëë8 9
Sum
ëë9 <
(
ëë< =
x
ëë= >
=>
ëë? A
x
ëëB C
.
ëëC D
PaymentAmount
ëëD Q
)
ëëQ R
;
ëëR S
var
íí 
userName
íí 
=
íí 
listPoolsPerUser
íí  0
.
íí0 1
First
íí1 6
(
íí6 7
)
íí7 8
.
íí8 9
AffiliateName
íí9 F
;
ííF G
if
ìì 
(
ìì 
walletRepository
ìì  
is
ìì! #
not
ìì$ '
null
ìì( ,
&&
ìì- /
globalPayment
ìì0 =
is
ìì> @
not
ììA D
$num
ììE F
)
ììF G
await
îî +
CreateCredit1APaymentServices
îî 3
(
îî3 4 
walletRepository1A
ïï &
!
ïï& '
,
ïï' (
key
ññ 
,
ññ 
userName
óó 
,
óó 
globalPayment
òò !
,
òò! "
	Constants
ôô 
.
ôô 0
"CommissionModel1ADescriptionNormal
ôô @
,
ôô@ A
WalletConceptType
öö %
.
öö% &
purchasing_pool
öö& 5
.
öö5 6
ToString
öö6 >
(
öö> ?
)
öö? @
)
öö@ A
;
ööA B
var
úú 
listPerLevels
úú 
=
úú 
listPoolsPerUser
úú  0
.
úú0 1

SelectMany
úú1 ;
(
úú; <
x
úú< =
=>
úú> @
x
úúA B
.
úúB C"
ResultsModel1aLevels
úúC W
)
úúW X
;
úúX Y
var
ùù !
dictionaryPerLevels
ùù #
=
ùù$ %
listPerLevels
ùù& 3
.
ùù3 4
GroupBy
ùù4 ;
(
ùù; <
x
ùù< =
=>
ûû 
x
ûû 
.
ûû 
AffiliateId
ûû  
)
ûû  !
.
ûû! "
ToDictionary
ûû" .
(
ûû. /
group
ûû/ 4
=>
ûû5 7
group
ûû8 =
.
ûû= >
Key
ûû> A
,
ûûA B
group
ûûC H
=>
ûûI K
group
ûûL Q
.
ûûQ R
ToList
ûûR X
(
ûûX Y
)
ûûY Z
)
ûûZ [
;
ûû[ \
foreach
†† 
(
†† 
var
†† 
(
†† 
	userLevel
†† #
,
††# $
ecoPoolLevelsList
††% 6
)
††6 7
in
††8 :!
dictionaryPerLevels
††; N
)
††N O
{
°° 
if
££ 
(
££ 
ecoPoolLevelsList
££ %
.
££% &
Any
££& )
(
££) *
x
££* +
=>
££, .
x
££/ 0
.
££0 1
CompletedAt
££1 <
!=
££= ?
null
££@ D
)
££D E
)
££E F
continue
§§ 
;
§§ 
var
¶¶ 
userNameLevel
¶¶ !
=
¶¶' (
ecoPoolLevelsList
¶¶) :
.
¶¶: ;
First
¶¶; @
(
¶¶@ A
)
¶¶A B
.
¶¶B C
AffiliateName
¶¶C P
;
¶¶P Q
var
ßß 
level
ßß 
=
ßß' (
ecoPoolLevelsList
ßß) :
.
ßß: ;
First
ßß; @
(
ßß@ A
)
ßßA B
.
ßßB C
Level
ßßC H
;
ßßH I
var
®®  
globalPaymentLevel
®® &
=
®®' (
(
®®) *
double
®®* 0
)
®®0 1
ecoPoolLevelsList
®®1 B
.
®®B C
Sum
®®C F
(
®®F G
x
®®G H
=>
®®I K
x
®®L M
.
®®M N
PaymentAmount
®®N [
)
®®[ \
;
®®\ ]
if
™™ 
(
™™ 
walletRepository
™™ $
is
™™% '
null
™™( ,
||
™™- / 
globalPaymentLevel
™™0 B
is
™™C E
$num
™™F G
)
™™G H
continue
´´ 
;
´´ 
if
≠≠ 
(
≠≠ %
dictionaryPointsModel1A
≠≠ +
.
≠≠+ ,
ContainsKey
≠≠, 7
(
≠≠7 8
	userLevel
≠≠8 A
)
≠≠A B
)
≠≠B C
{
ÆÆ %
dictionaryPointsModel1A
ØØ +
[
ØØ+ ,
	userLevel
ØØ, 5
]
ØØ5 6
.
ØØ6 7
Points
ØØ7 =
=
ØØ> ? 
globalPaymentLevel
ØØ@ R
;
ØØR S%
dictionaryPointsModel1A
∞∞ +
[
∞∞+ ,
	userLevel
∞∞, 5
]
∞∞5 6
.
∞∞6 7
Commissions
∞∞7 B
+=
∞∞C E 
globalPaymentLevel
∞∞F X
;
∞∞X Y
}
±± 
else
≤≤ %
dictionaryPointsModel1A
≥≥ +
.
≥≥+ ,
Add
≥≥, /
(
≥≥/ 0
	userLevel
≥≥0 9
,
≥≥9 :
new
≥≥; > 
UserGradingRequest
≥≥? Q
(
≥≥Q R
)
≥≥R S
{
¥¥ 
Commissions
µµ #
=
µµ$ % 
globalPaymentLevel
µµ& 8
,
µµ8 9
Points
∂∂ 
=
∂∂   
globalPaymentLevel
∂∂! 3
,
∂∂3 4
AffiliateId
∑∑ #
=
∑∑$ %
	userLevel
∑∑& /
,
∑∑/ 0
Side
∏∏ 
=
∏∏ 
ecoPoolLevelsList
∏∏ 0
.
∏∏0 1
First
∏∏1 6
(
∏∏6 7
)
∏∏7 8
.
∏∏8 9

BinarySide
∏∏9 C
,
∏∏C D
AffiliateOwnerId
ππ (
=
ππ) *
key
ππ+ .
,
ππ. /
UserName
∫∫  
=
∫∫! "
ecoPoolLevelsList
∫∫# 4
.
∫∫4 5
First
∫∫5 :
(
∫∫: ;
)
∫∫; <
.
∫∫< =
AffiliateName
∫∫= J
,
∫∫J K
UserCreatedAt
ªª %
=
ªª& '
ecoPoolLevelsList
ªª( 9
.
ªª9 :
First
ªª: ?
(
ªª? @
)
ªª@ A
.
ªªA B
UserCreatedAt
ªªB O
}
ºº 
)
ºº 
;
ºº 
await
ææ !
CreateCreditPayment
ææ )
(
ææ) *
walletRepository
øø $
,
øø$ %
	userLevel
¿¿ 
,
¿¿ 
userNameLevel
¡¡ !
,
¡¡! " 
globalPaymentLevel
¬¬ &
,
¬¬& '
string
√√ 
.
√√ 
Format
√√ !
(
√√! "
	Constants
√√" +
.
√√+ ,*
CommissionModel1ADescription
√√, H
,
√√H I
userName
√√J R
,
√√R S
level
√√T Y
)
√√Y Z
,
√√Z [
WalletConceptType
ƒƒ %
.
ƒƒ% &
pool_commission
ƒƒ& 5
.
ƒƒ5 6
ToString
ƒƒ6 >
(
ƒƒ> ?
)
ƒƒ? @
)
ƒƒ@ A
;
ƒƒA B
}
≈≈ 
}
∆∆ 	
}
«« 
private
»» 
static
»» 
async
»» 
Task
»»  
CommissionsModel1B
»» 0
(
»»0 1

Dictionary
…… 
<
…… 
int
…… 
,
…… 
List
…… 
<
…… 
ResultsModel1b
…… +
>
……+ ,
>
……, -
dictionaryModel1B
……. ?
,
……? @&
IWalletModel1BRepository
    
?
    ! 
walletRepository1B
  . @
,
  @ A
IWalletRepository
ÀÀ 
?
ÀÀ 
walletRepository
ÀÀ. >
,
ÀÀ> ?

Dictionary
ÃÃ 
<
ÃÃ 
int
ÃÃ 
,
ÃÃ  
UserGradingRequest
ÃÃ *
>
ÃÃ* +%
dictionaryPointsModel1B
ÃÃ. E
)
ÃÃE F
{
ÕÕ 
foreach
ŒŒ 
(
ŒŒ 
var
ŒŒ 
(
ŒŒ 
key
ŒŒ 
,
ŒŒ 
listPoolsPerUser
ŒŒ +
)
ŒŒ+ ,
in
ŒŒ- /
dictionaryModel1B
ŒŒ0 A
)
ŒŒA B
{
œœ 	
var
—— 
globalPayment
—— 
=
—— 
(
——  !
double
——! '
)
——' (
listPoolsPerUser
——( 8
.
——8 9
Sum
——9 <
(
——< =
x
——= >
=>
——? A
x
——B C
.
——C D
PaymentAmount
——D Q
)
——Q R
;
——R S
var
““ 
userName
““ 
=
““ 
listPoolsPerUser
““  0
.
““0 1
First
““1 6
(
““6 7
)
““7 8
.
““8 9
AffiliateName
““9 F
;
““F G
if
”” 
(
”” 
walletRepository
””  
is
””! #
not
””$ '
null
””( ,
&&
””- /
globalPayment
””0 =
is
””> @
not
””A D
$num
””E F
)
””F G
await
‘‘ +
CreateCredit1BPaymentServices
‘‘ 3
(
‘‘3 4 
walletRepository1B
’’ &
!
’’& '
,
’’' (
key
÷÷ 
,
÷÷ 
userName
◊◊ 
,
◊◊ 
globalPayment
ÿÿ !
,
ÿÿ! "
	Constants
ŸŸ 
.
ŸŸ 0
"CommissionModel1BDescriptionNormal
ŸŸ @
,
ŸŸ@ A
WalletConceptType
⁄⁄ %
.
⁄⁄% &
purchasing_pool
⁄⁄& 5
.
⁄⁄5 6
ToString
⁄⁄6 >
(
⁄⁄> ?
)
⁄⁄? @
)
⁄⁄@ A
;
⁄⁄A B
var
‹‹ 
listPerLevels
‹‹ 
=
‹‹ 
listPoolsPerUser
‹‹  0
.
‹‹0 1

SelectMany
‹‹1 ;
(
‹‹; <
x
‹‹< =
=>
‹‹> @
x
‹‹A B
.
‹‹B C"
ResultsModel1bLevels
‹‹C W
)
‹‹W X
;
‹‹X Y
var
›› !
dictionaryPerLevels
›› #
=
››$ %
listPerLevels
››& 3
.
››3 4
GroupBy
››4 ;
(
››; <
x
››< =
=>
ﬁﬁ 
x
ﬁﬁ 
.
ﬁﬁ 
AffiliateId
ﬁﬁ  
)
ﬁﬁ  !
.
ﬁﬁ! "
ToDictionary
ﬁﬁ" .
(
ﬁﬁ. /
group
ﬁﬁ/ 4
=>
ﬁﬁ5 7
group
ﬁﬁ8 =
.
ﬁﬁ= >
Key
ﬁﬁ> A
,
ﬁﬁA B
group
ﬁﬁC H
=>
ﬁﬁI K
group
ﬁﬁL Q
.
ﬁﬁQ R
ToList
ﬁﬁR X
(
ﬁﬁX Y
)
ﬁﬁY Z
)
ﬁﬁZ [
;
ﬁﬁ[ \
foreach
‡‡ 
(
‡‡ 
var
‡‡ 
(
‡‡ 
	userLevel
‡‡ #
,
‡‡# $
ecoPoolLevelsList
‡‡% 6
)
‡‡6 7
in
‡‡8 :!
dictionaryPerLevels
‡‡; N
)
‡‡N O
{
·· 
if
„„ 
(
„„ 
ecoPoolLevelsList
„„ %
.
„„% &
Any
„„& )
(
„„) *
x
„„* +
=>
„„, .
x
„„/ 0
.
„„0 1
CompletedAt
„„1 <
!=
„„= ?
null
„„@ D
)
„„D E
)
„„E F
continue
‰‰ 
;
‰‰ 
var
ÊÊ 
userNameLevel
ÊÊ !
=
ÊÊ' (
ecoPoolLevelsList
ÊÊ) :
.
ÊÊ: ;
First
ÊÊ; @
(
ÊÊ@ A
)
ÊÊA B
.
ÊÊB C
AffiliateName
ÊÊC P
;
ÊÊP Q
var
ÁÁ 
level
ÁÁ 
=
ÁÁ' (
ecoPoolLevelsList
ÁÁ) :
.
ÁÁ: ;
First
ÁÁ; @
(
ÁÁ@ A
)
ÁÁA B
.
ÁÁB C
Level
ÁÁC H
;
ÁÁH I
var
ËË  
globalPaymentLevel
ËË &
=
ËË' (
(
ËË) *
double
ËË* 0
)
ËË0 1
ecoPoolLevelsList
ËË1 B
.
ËËB C
Sum
ËËC F
(
ËËF G
x
ËËG H
=>
ËËI K
x
ËËL M
.
ËËM N
PaymentAmount
ËËN [
)
ËË[ \
;
ËË\ ]
if
ÍÍ 
(
ÍÍ 
walletRepository
ÍÍ $
is
ÍÍ% '
null
ÍÍ( ,
||
ÍÍ- / 
globalPaymentLevel
ÍÍ0 B
is
ÍÍC E
$num
ÍÍF G
)
ÍÍG H
continue
ÎÎ 
;
ÎÎ 
if
ÌÌ 
(
ÌÌ %
dictionaryPointsModel1B
ÌÌ +
.
ÌÌ+ ,
ContainsKey
ÌÌ, 7
(
ÌÌ7 8
	userLevel
ÌÌ8 A
)
ÌÌA B
)
ÌÌB C
{
ÓÓ %
dictionaryPointsModel1B
ÔÔ +
[
ÔÔ+ ,
	userLevel
ÔÔ, 5
]
ÔÔ5 6
.
ÔÔ6 7
Points
ÔÔ7 =
=
ÔÔC D 
globalPaymentLevel
ÔÔF X
;
ÔÔX Y%
dictionaryPointsModel1B
 +
[
+ ,
	userLevel
, 5
]
5 6
.
6 7
Commissions
7 B
+=
C E 
globalPaymentLevel
F X
;
X Y
}
ÒÒ 
else
ÚÚ %
dictionaryPointsModel1B
ÛÛ +
.
ÛÛ+ ,
Add
ÛÛ, /
(
ÛÛ/ 0
	userLevel
ÛÛ0 9
,
ÛÛ9 :
new
ÛÛ; > 
UserGradingRequest
ÛÛ? Q
(
ÛÛQ R
)
ÛÛR S
{
ÙÙ 
Commissions
ıı #
=
ıı) * 
globalPaymentLevel
ıı+ =
,
ıı= >
Points
ˆˆ 
=
ˆˆ) * 
globalPaymentLevel
ˆˆ+ =
,
ˆˆ= >
AffiliateId
˜˜ #
=
˜˜) *
	userLevel
˜˜+ 4
,
˜˜4 5
Side
¯¯ 
=
¯¯) *
ecoPoolLevelsList
¯¯+ <
.
¯¯< =
First
¯¯= B
(
¯¯B C
)
¯¯C D
.
¯¯D E

BinarySide
¯¯E O
,
¯¯O P
AffiliateOwnerId
˘˘ (
=
˘˘) *
key
˘˘+ .
,
˘˘. /
UserName
˙˙  
=
˙˙) *
ecoPoolLevelsList
˙˙+ <
.
˙˙< =
First
˙˙= B
(
˙˙B C
)
˙˙C D
.
˙˙D E
AffiliateName
˙˙E R
,
˙˙R S
UserCreatedAt
˚˚ %
=
˚˚) *
ecoPoolLevelsList
˚˚+ <
.
˚˚< =
First
˚˚= B
(
˚˚B C
)
˚˚C D
.
˚˚D E
UserCreatedAt
˚˚E R
}
¸¸ 
)
¸¸ 
;
¸¸ 
await
˛˛ !
CreateCreditPayment
˛˛ )
(
˛˛) *
walletRepository
ˇˇ $
,
ˇˇ$ %
	userLevel
ÄÄ 
,
ÄÄ 
userNameLevel
ÅÅ !
,
ÅÅ! " 
globalPaymentLevel
ÇÇ &
,
ÇÇ& '
string
ÉÉ 
.
ÉÉ 
Format
ÉÉ !
(
ÉÉ! "
	Constants
ÉÉ" +
.
ÉÉ+ ,*
CommissionModel1BDescription
ÉÉ, H
,
ÉÉH I
userName
ÉÉJ R
,
ÉÉR S
level
ÉÉT Y
)
ÉÉY Z
,
ÉÉZ [
WalletConceptType
ÑÑ %
.
ÑÑ% &
pool_commission
ÑÑ& 5
.
ÑÑ5 6
ToString
ÑÑ6 >
(
ÑÑ> ?
)
ÑÑ? @
)
ÑÑ@ A
;
ÑÑA B
}
ÖÖ 
}
ÜÜ 	
}
áá 
private
ââ 
static
ââ 
void
ââ  
AddOrUpdateGrading
ââ *
(
ââ* +
ref
ää 
ICollection
ää 
<
ää  
UserGradingRequest
ää *
>
ää* +
listGrading
ää, 7
,
ää7 8
int
ãã 
	userLevel
ãã, 5
,
ãã5 6
int
åå 
	userOwner
åå, 5
,
åå5 6
string
çç 
userName
çç, 4
,
çç4 5
double
éé  
globalPaymentLevel
éé, >
,
éé> ?
double
èè 
points
èè, 2
,
èè2 3
int
êê 
side
êê, 0
,
êê0 1
DateTime
ëë 
userCreateAt
ëë, 8
,
ëë8 9
ICollection
íí 
<
íí 

GradingDto
íí 
>
íí 
?
íí  
gradings
íí, 4
)
íí4 5
{
ìì 
var
îî 
userGrading
îî 
=
îî 
listGrading
îî %
.
îî% &
FirstOrDefault
îî& 4
(
îî4 5
x
îî5 6
=>
îî7 9
x
îî: ;
.
îî; <
AffiliateId
îî< G
==
îîH J
	userLevel
îîK T
)
îîT U
;
îîU V
if
ïï 

(
ïï 
userGrading
ïï 
is
ïï 
not
ïï 
null
ïï #
)
ïï# $
{
ññ 	
userGrading
óó 
.
óó 
Points
óó 
=
óó$ %
points
óó& ,
;
óó, -
userGrading
òò 
.
òò 
Commissions
òò #
=
òò$ % 
globalPaymentLevel
òò& 8
;
òò8 9
}
ôô 	
else
öö 
{
õõ 	
userGrading
úú 
=
úú 
new
úú  
UserGradingRequest
úú 0
{
ùù 
AffiliateId
ûû 
=
ûû! "
	userLevel
ûû# ,
,
ûû, -
AffiliateOwnerId
üü  
=
üü! "
	userOwner
üü# ,
,
üü, -
UserName
†† 
=
††! "
userName
††# +
,
††+ ,
Commissions
°° 
=
°°! " 
globalPaymentLevel
°°# 5
,
°°5 6
Points
¢¢ 
=
¢¢! "
points
¢¢# )
,
¢¢) *
Side
££ 
=
££! "
side
££# '
,
££' (
UserCreatedAt
§§ 
=
§§! "
userCreateAt
§§# /
}
•• 
;
•• 
listGrading
¶¶ 
.
¶¶ 
Add
¶¶ 
(
¶¶ 
userGrading
¶¶ '
)
¶¶' (
;
¶¶( )
}
ßß 	
if
©© 

(
©© 
gradings
©© 
is
©© 
null
©© 
)
©© 
return
™™ 
;
™™ 
gradings
´´ 
=
´´ 
gradings
´´ 
.
´´ 
Where
´´ !
(
´´! "
x
´´" #
=>
´´$ &
x
´´' (
.
´´( )

ScopeLevel
´´) 3
>=
´´4 6
$num
´´7 8
)
´´8 9
.
´´9 :
ToList
´´: @
(
´´@ A
)
´´A B
;
´´B C
var
≠≠ 
gradingTempPoints
≠≠ 
=
≠≠ 
gradings
≠≠  (
.
≠≠( )
OrderByDescending
≠≠) :
(
≠≠: ;
x
≠≠; <
=>
ÆÆ 
x
ÆÆ 
.
ÆÆ 

ScopeLevel
ÆÆ 
)
ÆÆ 
.
ÆÆ 
FirstOrDefault
ÆÆ +
(
ÆÆ+ ,
x
ÆÆ, -
=>
ÆÆ. 0
x
ÆÆ1 2
.
ÆÆ2 3
VolumePoints
ÆÆ3 ?
<=
ÆÆ@ B
userGrading
ÆÆC N
.
ÆÆN O
Commissions
ÆÆO Z
)
ÆÆZ [
;
ÆÆ[ \
if
∞∞ 

(
∞∞ 
userGrading
∞∞ 
.
∞∞ 
AffiliateId
∞∞ #
==
∞∞$ &
$num
∞∞' +
)
∞∞+ ,
{
±± 	
Console
≤≤ 
.
≤≤ 
	WriteLine
≤≤ 
(
≤≤ 
$str
≤≤ $
)
≤≤$ %
;
≤≤% &
}
≥≥ 	
if
¥¥ 

(
¥¥ 
gradingTempPoints
¥¥ 
is
¥¥  
not
¥¥! $
null
¥¥% )
)
¥¥) *
userGrading
µµ 
.
µµ 
Grading
µµ 
=
µµ  !
gradingTempPoints
µµ" 3
;
µµ3 4
}
∂∂ 
private
∏∏ 
static
∏∏ 
Task
∏∏ !
CreateCreditPayment
∏∏ +
(
∏∏+ ,
IWalletRepository
ππ 
walletRepository
ππ *
,
ππ* +
int
∫∫ 
userId
∫∫  
,
∫∫  !
string
ªª 
userName
ªª "
,
ªª" #
double
ºº 
globalPayment
ºº '
,
ºº' (
string
ΩΩ 
concept
ΩΩ !
,
ΩΩ! "
string
ææ 
conceptType
ææ %
)
ææ% &
{
øø 
if
¿¿ 

(
¿¿ 
globalPayment
¿¿ 
<=
¿¿ 
$num
¿¿ 
)
¿¿ 
return
¡¡ 
Task
¡¡ 
.
¡¡ 
CompletedTask
¡¡ %
;
¡¡% &
return
√√ 
Task
√√ 
.
√√ 
CompletedTask
√√ !
;
√√! "
var
≈≈ 
creditTransaction
≈≈ 
=
≈≈ 
new
≈≈  #&
CreditTransactionRequest
≈≈$ <
{
∆∆ 	
AffiliateId
«« 
=
«« 
userId
««  &
,
««& '
AffiliateUserName
»» 
=
»» 
userName
»»  (
,
»»( )
Credit
…… 
=
…… 
globalPayment
……  -
,
……- .
UserId
   
=
   
	Constants
    )
.
  ) *
AdminUserId
  * 5
,
  5 6
Concept
ÀÀ 
=
ÀÀ 
concept
ÀÀ  '
,
ÀÀ' (
AdminUserName
ÃÃ 
=
ÃÃ 
	Constants
ÃÃ  )
.
ÃÃ) *$
AdminEcosystemUserName
ÃÃ* @
,
ÃÃ@ A
ConceptType
ÕÕ 
=
ÕÕ 
conceptType
ÕÕ  +
}
ŒŒ 	
;
ŒŒ	 

return
œœ 
walletRepository
œœ 
.
œœ  
CreditTransaction
œœ  1
(
œœ1 2
creditTransaction
œœ2 C
)
œœC D
;
œœD E
}
–– 
private
““ 
static
““ 
Task
““ #
CreateCredit1APayment
““ -
(
““- .&
IWalletModel1ARepository
””  
walletRepository
””! 1
,
””1 2
int
‘‘ 
userId
‘‘  
,
‘‘  !
string
’’ 
userName
’’ "
,
’’" #
double
÷÷ 
globalPayment
÷÷ '
,
÷÷' (
string
◊◊ 
concept
◊◊ !
,
◊◊! "
string
ÿÿ 
conceptType
ÿÿ %
)
ÿÿ% &
{
ŸŸ 
if
⁄⁄ 

(
⁄⁄ 
globalPayment
⁄⁄ 
<=
⁄⁄ 
$num
⁄⁄ 
)
⁄⁄ 
return
€€ 
Task
€€ 
.
€€ 
CompletedTask
€€ %
;
€€% &
return
›› 
Task
›› 
.
›› 
CompletedTask
›› !
;
››! "
var
ﬂﬂ 
creditTransaction
ﬂﬂ 
=
ﬂﬂ 
new
ﬂﬂ  #&
CreditTransactionRequest
ﬂﬂ$ <
{
‡‡ 	
AffiliateId
·· 
=
·· 
userId
··  &
,
··& '
AffiliateUserName
‚‚ 
=
‚‚ 
userName
‚‚  (
,
‚‚( )
Credit
„„ 
=
„„ 
globalPayment
„„  -
,
„„- .
UserId
‰‰ 
=
‰‰ 
	Constants
‰‰  )
.
‰‰) *
AdminUserId
‰‰* 5
,
‰‰5 6
Concept
ÂÂ 
=
ÂÂ 
concept
ÂÂ  '
,
ÂÂ' (
AdminUserName
ÊÊ 
=
ÊÊ 
	Constants
ÊÊ  )
.
ÊÊ) *$
AdminEcosystemUserName
ÊÊ* @
,
ÊÊ@ A
ConceptType
ÁÁ 
=
ÁÁ 
conceptType
ÁÁ  +
}
ËË 	
;
ËË	 

return
ÈÈ 
walletRepository
ÈÈ 
.
ÈÈ  
CreditTransaction
ÈÈ  1
(
ÈÈ1 2
creditTransaction
ÈÈ2 C
)
ÈÈC D
;
ÈÈD E
}
ÍÍ 
private
ÏÏ 
static
ÏÏ 
Task
ÏÏ +
CreateCredit1APaymentServices
ÏÏ 5
(
ÏÏ5 6&
IWalletModel1ARepository
ÌÌ  
walletRepository
ÌÌ! 1
,
ÌÌ1 2
int
ÓÓ 
userId
ÓÓ! '
,
ÓÓ' (
string
ÔÔ 
userName
ÔÔ! )
,
ÔÔ) *
double
 
globalPayment
! .
,
. /
string
ÒÒ 
concept
ÒÒ! (
,
ÒÒ( )
string
ÚÚ 
conceptType
ÚÚ! ,
)
ÚÚ, -
{
ÛÛ 
if
ÙÙ 

(
ÙÙ 
globalPayment
ÙÙ 
<=
ÙÙ 
$num
ÙÙ 
)
ÙÙ 
return
ıı 
Task
ıı 
.
ıı 
CompletedTask
ıı %
;
ıı% &
return
˜˜ 
Task
˜˜ 
.
˜˜ 
CompletedTask
˜˜ !
;
˜˜! "
var
˘˘ 
creditTransaction
˘˘ 
=
˘˘ 
new
˘˘  #&
CreditTransactionRequest
˘˘$ <
{
˙˙ 	
AffiliateId
˚˚ 
=
˚˚ 
userId
˚˚  &
,
˚˚& '
AffiliateUserName
¸¸ 
=
¸¸ 
userName
¸¸  (
,
¸¸( )
Credit
˝˝ 
=
˝˝ 
globalPayment
˝˝  -
,
˝˝- .
UserId
˛˛ 
=
˛˛ 
	Constants
˛˛  )
.
˛˛) *
AdminUserId
˛˛* 5
,
˛˛5 6
Concept
ˇˇ 
=
ˇˇ 
concept
ˇˇ  '
,
ˇˇ' (
AdminUserName
ÄÄ 
=
ÄÄ 
	Constants
ÄÄ  )
.
ÄÄ) *$
AdminEcosystemUserName
ÄÄ* @
,
ÄÄ@ A
ConceptType
ÅÅ 
=
ÅÅ 
conceptType
ÅÅ  +
}
ÇÇ 	
;
ÇÇ	 

return
ÉÉ 
walletRepository
ÉÉ 
.
ÉÉ  -
CreditServiceBalanceTransaction
ÉÉ  ?
(
ÉÉ? @
creditTransaction
ÉÉ@ Q
)
ÉÉQ R
;
ÉÉR S
}
ÑÑ 
private
ÜÜ 
static
ÜÜ 
Task
ÜÜ #
CreateCredit1BPayment
ÜÜ -
(
ÜÜ- .&
IWalletModel1BRepository
áá  
walletRepository
áá! 1
,
áá1 2
int
àà 
userId
àà! '
,
àà' (
string
ââ 
userName
ââ! )
,
ââ) *
double
ää 
globalPayment
ää! .
,
ää. /
string
ãã 
concept
ãã! (
,
ãã( )
string
åå 
conceptType
åå! ,
)
åå, -
{
çç 
if
éé 

(
éé 
globalPayment
éé 
<=
éé 
$num
éé 
)
éé 
return
èè 
Task
èè 
.
èè 
CompletedTask
èè %
;
èè% &
return
ëë 
Task
ëë 
.
ëë 
CompletedTask
ëë !
;
ëë! "
var
ìì 
creditTransaction
ìì 
=
ìì 
new
ìì  #&
CreditTransactionRequest
ìì$ <
{
îî 	
AffiliateId
ïï 
=
ïï 
userId
ïï  &
,
ïï& '
AffiliateUserName
ññ 
=
ññ 
userName
ññ  (
,
ññ( )
Credit
óó 
=
óó 
globalPayment
óó  -
,
óó- .
UserId
òò 
=
òò 
	Constants
òò  )
.
òò) *
AdminUserId
òò* 5
,
òò5 6
Concept
ôô 
=
ôô 
concept
ôô  '
,
ôô' (
AdminUserName
öö 
=
öö 
	Constants
öö  )
.
öö) *$
AdminEcosystemUserName
öö* @
,
öö@ A
ConceptType
õõ 
=
õõ 
conceptType
õõ  +
}
úú 	
;
úú	 

return
ùù 
walletRepository
ùù 
.
ùù  
CreditTransaction
ùù  1
(
ùù1 2
creditTransaction
ùù2 C
)
ùùC D
;
ùùD E
}
ûû 
private
†† 
static
†† 
Task
†† +
CreateCredit1BPaymentServices
†† 5
(
††5 6&
IWalletModel1BRepository
°°  
walletRepository
°°! 1
,
°°1 2
int
¢¢ 
userId
¢¢! '
,
¢¢' (
string
££ 
userName
££! )
,
££) *
double
§§ 
globalPayment
§§! .
,
§§. /
string
•• 
concept
••! (
,
••( )
string
¶¶ 
conceptType
¶¶! ,
)
¶¶, -
{
ßß 
if
®® 

(
®® 
globalPayment
®® 
<=
®® 
$num
®® 
)
®® 
return
©© 
Task
©© 
.
©© 
CompletedTask
©© %
;
©©% &
return
´´ 
Task
´´ 
.
´´ 
CompletedTask
´´ !
;
´´! "
var
≠≠ 
creditTransaction
≠≠ 
=
≠≠ 
new
≠≠  #&
CreditTransactionRequest
≠≠$ <
{
ÆÆ 	
AffiliateId
ØØ 
=
ØØ 
userId
ØØ  &
,
ØØ& '
AffiliateUserName
∞∞ 
=
∞∞ 
userName
∞∞  (
,
∞∞( )
Credit
±± 
=
±± 
globalPayment
±±  -
,
±±- .
UserId
≤≤ 
=
≤≤ 
	Constants
≤≤  )
.
≤≤) *
AdminUserId
≤≤* 5
,
≤≤5 6
Concept
≥≥ 
=
≥≥ 
concept
≥≥  '
,
≥≥' (
AdminUserName
¥¥ 
=
¥¥ 
	Constants
¥¥  )
.
¥¥) *$
AdminEcosystemUserName
¥¥* @
,
¥¥@ A
ConceptType
µµ 
=
µµ 
conceptType
µµ  +
}
∂∂ 	
;
∂∂	 

return
∑∑ 
walletRepository
∑∑ 
.
∑∑  -
CreditServiceBalanceTransaction
∑∑  ?
(
∑∑? @
creditTransaction
∑∑@ Q
)
∑∑Q R
;
∑∑R S
}
∏∏ 
}∫∫ ﬁ
OC:\HeroSystem\walletService\WalletService.Core\Kafka\Messages\Model1AMessage.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
Messages# +
;+ ,
public 
class 
Model1AMessage 
{		 
public

 

ICollection

 
<

 
InvoiceDetailDto

 '
>

' (
ItemWithInMonth

* 9
{

; <
get

= @
;

@ A
set

B E
;

E F
}

G H
=

I J
new

K N
List

O S
<

S T
InvoiceDetailDto

T d
>

d e
(

e f
)

f g
;

g h
public 

ICollection 
< 
InvoiceDetailDto '
>' (
ItemWithOutMonth) 9
{: ;
get< ?
;? @
setA D
;D E
}F G
=H I
newJ M
ListN R
<R S
InvoiceDetailDtoS c
>c d
(d e
)e f
;f g
public 

ICollection 
< 
ProductWalletDto '
>' (
ListResultProducts* <
{= >
get? B
;B C
setD G
;G H
}I J
=K L
newM P
ListQ U
<U V
ProductWalletDtoV f
>f g
(g h
)h i
;i j
public 

ICollection 
< 
UserModelResponse (
>( )
ListResultAccounts* <
{? @
getA D
;D E
setF I
;I J
}K L
=M N
newO R
ListS W
<W X
UserModelResponseX i
>i j
(j k
)k l
;l m
public 
!
ModelConfigurationDto  
Configuration* 7
{? @
getA D
;D E
setF I
;I J
}K L
public 

DateTime 
StarDate* 2
{? @
getA D
;D E
setF I
;I J
}K L
public 

DateTime 
EndDate* 1
{? @
getA D
;D E
setF I
;I J
}K L
public 

decimal 
Points* 0
{? @
getA D
;D E
setF I
;I J
}K L
} ﬁ
OC:\HeroSystem\walletService\WalletService.Core\Kafka\Messages\Model1BMessage.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
Messages# +
;+ ,
public 
class 
Model1BMessage 
{		 
public

 

ICollection

 
<

 
InvoiceDetailDto

 '
>

' (
ItemWithInMonth

) 8
{

9 :
get

; >
;

> ?
set

@ C
;

C D
}

E F
=

G H
new

I L
List

M Q
<

Q R
InvoiceDetailDto

R b
>

b c
(

c d
)

d e
;

e f
public 

ICollection 
< 
InvoiceDetailDto '
>' (
ItemWithOutMonth) 9
{: ;
get< ?
;? @
setA D
;D E
}F G
=H I
newJ M
ListN R
<R S
InvoiceDetailDtoS c
>c d
(d e
)e f
;f g
public 

ICollection 
< 
ProductWalletDto '
>' (
ListResultProducts) ;
{< =
get> A
;A B
setC F
;F G
}H I
=J K
newL O
ListP T
<T U
ProductWalletDtoU e
>e f
(f g
)g h
;h i
public 

ICollection 
< 
UserModelResponse (
>( )
ListResultAccounts* <
{= >
get? B
;B C
setD G
;G H
}I J
=K L
newM P
ListQ U
<U V
UserModelResponseV g
>g h
(h i
)i j
;j k
public 
!
ModelConfigurationDto  
Configuration* 7
{? @
getA D
;D E
setF I
;I J
}K L
public 

DateTime 
StarDate* 2
{? @
getA D
;D E
setF I
;I J
}K L
public 

DateTime 
EndDate* 1
{? @
getA D
;D E
setF I
;I J
}K L
public 

decimal 
Points* 0
{? @
getA D
;D E
setF I
;I J
}K L
} ‹
NC:\HeroSystem\walletService\WalletService.Core\Kafka\Messages\Model2Message.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
Messages# +
;+ ,
public 
class 
Model2Message 
{		 
public

 

ICollection

 
<

 
InvoiceDetailDto

 '
>

' (
ItemWithInMonth

) 8
{

9 :
get

; >
;

> ?
set

@ C
;

C D
}

E F
=

G H
new

I L
List

M Q
<

Q R
InvoiceDetailDto

R b
>

b c
(

c d
)

d e
;

e f
public 

ICollection 
< 
InvoiceDetailDto '
>' (
ItemWithOutMonth* :
{< =
get> A
;A B
setC F
;F G
}H I
=K L
newM P
ListQ U
<U V
InvoiceDetailDtoV f
>f g
(g h
)h i
;i j
public 

ICollection 
< 
ProductWalletDto '
>' (
ListResultProducts* <
{= >
get? B
;B C
setD G
;G H
}I J
=K L
newM P
ListQ U
<U V
ProductWalletDtoV f
>f g
(g h
)h i
;i j
public 

ICollection 
< 
UserModelResponse (
>( )
ListResultAccounts* <
{? @
getA D
;D E
setF I
;I J
}K L
=N O
newP S
ListT X
<X Y
UserModelResponseY j
>j k
(k l
)l m
;m n
public 
!
ModelConfigurationDto  
Configuration* 7
{? @
getA D
;D E
setF I
;I J
}K L
public 

DateTime 
StarDate* 2
{? @
getA D
;D E
setF I
;I J
}K L
public 

DateTime 
EndDate* 1
{? @
getA D
;D E
setF I
;I J
}K L
public 

decimal 
Points* 0
{? @
getA D
;D E
setF I
;I J
}K L
} Ü
NC:\HeroSystem\walletService\WalletService.Core\Kafka\Messages\Model3Message.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
Messages# +
;+ ,
public 
class 
Model3Message 
{		 
public

 

ICollection

 
<

 
InvoiceDetailDto

 '
>

' (
EducatedCourses

) 8
{

9 :
get

; >
;

> ?
set

@ C
;

C D
}

E F
=

G H
new

I L
List

M Q
<

Q R
InvoiceDetailDto

R b
>

b c
(

c d
)

d e
;

e f
public 

ICollection 
< 
ProductWalletDto '
>' (
ListResultProducts) ;
{< =
get> A
;A B
setC F
;F G
}H I
=J K
newL O
ListP T
<T U
ProductWalletDtoU e
>e f
(f g
)g h
;h i
public 

ICollection 
< 
UserModelResponse (
>( )
ListResultAccounts* <
{= >
get? B
;B C
setD G
;G H
}I J
=K L
newM P
ListQ U
<U V
UserModelResponseV g
>g h
(h i
)i j
;j k
public 
!
ModelConfigurationDto  
Configuration! .
{/ 0
get1 4
;4 5
set6 9
;9 :
}; <
} ü
XC:\HeroSystem\walletService\WalletService.Core\Kafka\Messages\ModelFourFiveSixMessage.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
Messages# +
;+ ,
public 
class #
ModelFourFiveSixMessage $
{ 
public 

ICollection 
< 

GradingDto !
>! "
Gradings# +
{, -
get. 1
;1 2
set3 6
;6 7
}8 9
public		 

ICollection		 
<		 
UserGradingRequest		 )
>		) *
UserGradings		+ 7
{		8 9
get		: =
;		= >
set		? B
;		B C
}		D E
}

 ˘
\C:\HeroSystem\walletService\WalletService.Core\Kafka\Messages\PaymentModelTwoThreeMessage.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
Messages# +
;+ ,
public 
class '
PaymentModelTwoThreeMessage (
{ 
public 

IEnumerable 
< 
ResultsModel2 $
>$ %
EcoPools& .
{/ 0
get1 4
;4 5
set6 9
;9 :
}; <
public 

ModelConfiguration 
ModelConfiguration 0
{1 2
get3 6
;6 7
set8 ;
;; <
}= >
}		 ø1
NC:\HeroSystem\walletService\WalletService.Core\Kafka\Producer\KafkaProducer.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
Producer# +
;+ ,
public		 
class		 
KafkaProducer		 
{

 
private 
readonly 
ProducerConfig #
_producerConfig$ 3
;3 4
public 

KafkaProducer 
( 
IServiceCollection +
serviceCollection, =
)= >
{ 
var 
serviceProvider 
= 
serviceCollection /
./ 0 
BuildServiceProvider0 D
(D E
)E F
;F G
var 
settings 
= 
serviceProvider &
.& '
GetRequiredService' 9
<9 :
IOptions: B
<B C$
ApplicationConfigurationC [
>[ \
>\ ]
(] ^
)^ _
._ `
Value` e
;e f
_producerConfig 
= 
new 
ProducerConfig ,
{ 	
BootstrapServers 
= 
settings '
.' (
ConsumersSetting( 8
!8 9
.9 :

BrokerList: D
,D E
BatchNumMessages 
= 
$num $
*% &
$num' (
,( )
LingerMs 
= 
$num  
,  !
CompressionType 
= 
CompressionType .
.. /
Gzip/ 3
,3 4
Acks 
= 
Acks #
.# $
Leader$ *
,* +
MessageMaxBytes 
= 
$num '
} 	
;	 

} 
private 
async 
Task 
< 
DeliveryResult %
<% &
Null& *
,* +
string, 2
>2 3
>3 4
ProduceAsync5 A
<A B
TB C
>C D
(D E
stringE K
topicL Q
,Q R
TS T
sourceU [
)[ \
{ 
var 
value 
= 
source #
as$ &
string' -
??. 0
source1 7
.7 8
ToJsonString8 D
(D E
)E F
;F G
using 
var 
producer 
= 
new  
ProducerBuilder! 0
<0 1
Null1 5
,5 6
string7 =
>= >
(> ?
_producerConfig? N
)N O
.O P
BuildP U
(U V
)V W
;W X
return 
await 
producer 
. 
ProduceAsync *
(* +
topic+ 0
,0 1
new2 5
Message6 =
<= >
Null> B
,B C
stringD J
>J K
{   	
Value!! 
=!! 
value!! 
}"" 	
)""	 

;""
 
}## 
public%% 

async%% 
Task%% 
<%% 
DeliveryResult%% $
<%%$ %
Null%%% )
,%%) *
string%%+ 1
>%%1 2
>%%2 3
ProduceAsync%%4 @
(%%@ A
string%%A G
topic%%H M
,%%M N
string%%O U
source%%V \
)%%\ ]
{&& 
return'' 
await'' 
ProduceAsync'' !
<''! "
string''" (
>''( )
('') *
topic''* /
,''/ 0
source''1 7
)''7 8
;''8 9
}(( 
public** 

async** 
Task** 
<** 
DeliveryResult** $
<**$ %
string**% +
,**+ ,
string**- 3
>**3 4
>**4 5
ProduceAsync**6 B
(**B C
string**C I
topic**J O
,**O P
string**Q W
source**X ^
,**^ _
string**` f
key**g j
)**j k
{++ 
return,, 
await,, 
ProduceWithKeyAsync,, (
(,,( )
topic,,) .
,,,. /
source,,0 6
,,,6 7
key,,8 ;
),,; <
;,,< =
}-- 
public// 

async// 
Task// 
<// 
DeliveryResult// $
<//$ %
string//% +
,//+ ,
string//- 3
>//3 4
>//4 5
ProduceWithKeyAsync//6 I
<//I J
T//J K
>//K L
(//L M
string//M S
topic//T Y
,//Y Z
T//[ \
source//] c
,//c d
string//e k
key//l o
)//o p
{00 
try11 
{22 	
var33 
value33 
=33  
source33! '
as33( *
string33+ 1
??332 4
source335 ;
.33; <
ToJsonString33< H
(33H I
)33I J
;33J K
using44 
var44 
producer44 
=44  
new44! $
ProducerBuilder44% 4
<444 5
string445 ;
,44; <
string44= C
>44C D
(44D E
_producerConfig44E T
)44T U
.44U V
Build44V [
(44[ \
)44\ ]
;44] ^
return55 
await55 
producer55 !
.55! "
ProduceAsync55" .
(55. /
topic55/ 4
,554 5
new556 9
Message55: A
<55A B
string55B H
,55H I
string55J P
>55P Q
{66 
Value77 
=77 
value77 
,77 
Key88 
=88 
key88 
}99 
)99 
;99 
}:: 	
catch;; 
(;; 
	Exception;; 
e;; 
);; 
{<< 	
Console== 
.== 
	WriteLine== 
(== 
e== 
)==  
;==  !
throw>> 
;>> 
}?? 	
}@@ 
}AA é
JC:\HeroSystem\walletService\WalletService.Core\Kafka\Topics\KafkaTopics.cs
	namespace 	
WalletService
 
. 
Core 
. 
Kafka "
." #
Topics# )
;) *
public 
static 
class 
KafkaTopics 
{ 
public 

static 
string 
ProcessModel1ATopic ,
{- .
get/ 2
;2 3
set4 7
;7 8
}9 :
=; <
$str= O
;O P
public 

static 
string 
ProcessModel1BTopic ,
{- .
get/ 2
;2 3
set4 7
;7 8
}9 :
=; <
$str= O
;O P
public		 

static		 
string		 
ProcessModel2Topic		 +
{		, -
get		. 1
;		1 2
set		3 6
;		6 7
}		8 9
=		: ;
$str		< M
;		M N
public

 

static

 
string

 ,
 ProcessPaymentModelTwoThreeTopic

 9
{

: ;
get

< ?
;

? @
set

A D
;

D E
}

F G
=

H I
$str

J [
;

[ \
public 

static 
string (
ProcessModelFourFiveSixTopic 5
{6 7
get8 ;
;; <
set= @
;@ A
}B C
=D E
$strF Z
;Z [
public 

static 
string 
ProcessModel3Topic +
{, -
get. 1
;1 2
set3 6
;6 7
}8 9
=: ;
$str< M
;M N
public 

static 
void 
RegisterKafkaTopics *
(* +
this+ /
IServiceCollection0 B
servicesC K
,K L
stringM S
envT W
)W X
{ 
var 
envLower 
= 
env 
. 
ToLower "
(" #
)# $
;$ %
ProcessModel2Topic 
+= !
$str" %
+& '
envLower( 0
;0 1,
 ProcessPaymentModelTwoThreeTopic (
+=) +
$str, /
+0 1
envLower2 :
;: ;
ProcessModel3Topic 
+=' )
$str* -
+. /
envLower0 8
;8 9
} 
} Ô
MC:\HeroSystem\walletService\WalletService.Core\Lock\Interface\ILockManager.cs
	namespace 	
WalletService
 
. 
Core 
. 
Lock !
.! "
	Interface" +
;+ ,
public 
	interface 
ILockManager 
{ 
public 

Task 
< 
bool 
> 
Take 
( 
string !
key% (
,( )
string* 0
value1 6
,6 7
TimeSpan8 @
expiryA G
)G H
;H I
public 

Task 
< 
bool 
> 
Release 
( 
string $
key% (
,( )
string* 0
value1 6
)6 7
;7 8
} Æ
BC:\HeroSystem\walletService\WalletService.Core\Lock\LockManager.cs
	namespace 	
WalletService
 
. 
Core 
. 
Lock !
;! "
public 
class 
LockManager 
: 
ILockManager '
{ 
private		 
readonly		 
	IDatabase		 
_db		 "
;		" #
public 

LockManager 
( "
IConnectionMultiplexer -!
connectionMultiplexer. C
)C D
{ 
_db 
= !
connectionMultiplexer #
.# $
GetDatabase$ /
(/ 0
)0 1
;1 2
} 
public 

Task 
< 
bool 
> 
Take 
( 
string !
key" %
,% &
string' -
value. 3
,3 4
TimeSpan5 =
expiry> D
)D E
{ 
return 
_db 
. 
LockTakeAsync  
(  !
key! $
,$ %
value& +
,+ ,
expiry- 3
)3 4
;4 5
} 
public 

Task 
< 
bool 
> 
Release 
( 
string $
key( +
,+ ,
string- 3
value4 9
)9 :
{ 
return 
_db 
. 
LockReleaseAsync #
(# $
key$ '
,' (
value) .
). /
;/ 0
} 
} ù©
FC:\HeroSystem\walletService\WalletService.Core\Mapper\MapperProfile.cs
	namespace 	
WalletService
 
. 
Core 
. 
Mapper #
;# $
public!! 
class!! 
MapperProfile!! 
:!! 
Profile!! $
{"" 
public## 

MapperProfile## 
(## 
)## 
{$$ 
MapDto%% 
(%% 
)%% 
;%% 
	CreateMap'' 
<'' 
DateOnly'' 
,'' 
DateTime'' $
>''$ %
(''% &
)''& '
.(( 
ConvertUsing(( 
((( 
src(( 
=>((  
new((! $
DateTime((% -
(((- .
src((. 1
.((1 2
Year((2 6
,((6 7
src((8 ;
.((; <
Month((< A
,((A B
src((C F
.((F G
Day((G J
)((J K
)((K L
;((L M
	CreateMap** 
<** 
DateTime** 
,** 
DateOnly** $
>**$ %
(**% &
)**& '
.++ 
ConvertUsing++ 
(++ 
src++ 
=>++  
new++! $
DateOnly++% -
(++- .
src++. 1
.++1 2
Year++2 6
,++6 7
src++8 ;
.++; <
Month++< A
,++A B
src++C F
.++F G
Day++G J
)++J K
)++K L
;++L M
},, 
private.. 
void.. 
MapDto.. 
(.. 
).. 
{// 
	CreateMap00 
<00 
Wallet00 
,00 
	WalletDto00 #
>00# $
(00$ %
)00% &
;00& '
	CreateMap11 
<11 
WalletsHistory11  
,11  !
WalletHistoryDto11" 2
>112 3
(113 4
)114 5
;115 6
	CreateMap22 
<22 
WalletsPeriod22 
,22  
WalletPeriodDto22! 0
>220 1
(221 2
)222 3
;223 4
	CreateMap33 
<33 #
WalletsRetentionsConfig33 )
,33) *$
WalletRetentionConfigDto33+ C
>33C D
(33D E
)33E F
;33F G
	CreateMap44 
<44 
WalletsWait44 
,44 
WalletWaitDto44 ,
>44, -
(44- .
)44. /
;44/ 0
	CreateMap55 
<55 
WalletsWithdrawal55 #
,55# $
WalletWithDrawalDto55% 8
>558 9
(559 :
)55: ;
;55; <
	CreateMap66 
<66 
WalletsRequest66  
,66  !
WalletRequestDto66" 2
>662 3
(663 4
)664 5
;665 6
	CreateMap77 
<77 
Invoice77 
,77 

InvoiceDto77 %
>77% &
(77& '
)77' (
;77( )
	CreateMap88 
<88 
Invoice88 
,88 

InvoiceDTO88 %
>88% &
(88& '
)88' (
;88( )
	CreateMap99 
<99 
InvoicesDetail99  
,99  !
InvoiceDetailDto99" 2
>992 3
(993 4
)994 5
.:: 
	ForMember:: 
(:: 
dest:: 
=>:: 
dest:: #
.::# $
Invoice::$ +
,::+ ,
opt::- 0
=>::1 3
opt::4 7
.::7 8
Ignore::8 >
(::> ?
)::? @
)::@ A
;::A B
	CreateMap;; 
<;; 
ModelConfiguration;; $
,;;$ %!
ModelConfigurationDto;;& ;
>;;; <
(;;< =
);;= >
;;;> ?
	CreateMap<< 
<<< #
ModelConfigurationLevel<< )
,<<) *
EcoPoolLevelDto<<+ :
><<: ;
(<<; <
)<<< =
;<<= >
	CreateMap== 
<== $
WalletTransactionRequest== *
,==* +
Wallet==, 2
>==2 3
(==3 4
)==4 5
;==5 6
	CreateMap>> 
<>> 
ResultsModel2>> 
,>>  
ResultsEcoPoolDto>>! 2
>>>2 3
(>>3 4
)>>4 5
;>>5 6
	CreateMap?? 
<?? 
ResultsModel2Level?? $
,??$ %"
ResultEcoPoolLevelsDto??& <
>??< =
(??= >
)??> ?
;??? @
	CreateMap@@ 
<@@ "
CoinpaymentTransaction@@ (
,@@( )!
PaymentTransactionDto@@* ?
>@@? @
(@@@ A
)@@A B
;@@B C
	CreateMapAA 
<AA *
InvoicesTradingAcademyResponseAA 0
,AA0 1$
InvoiceTradingAcademyDtoAA2 J
>AAJ K
(AAK L
)AAL M
;AAM N
	CreateMapBB 
<BB )
InvoiceModelOneAndTwoResponseBB /
,BB/ 0$
InvoiceModelOneAndTwoDtoBB1 I
>BBI J
(BBJ K
)BBK L
;BBL M
	CreateMapEE 
<EE  
WalletRequestRequestEE &
,EE& '
WalletsRequestEE( 6
>EE6 7
(EE7 8
)EE8 9
.FF 
	ForMemberFF 
(FF 
dFF 
=>FF 
dFF 
.FF 
IdFF  
,FF  !
mapFF" %
=>FF& (
mapFF) ,
.FF, -
IgnoreFF- 3
(FF3 4
)FF4 5
)FF5 6
.GG 
	ForMemberGG 
(GG 
dGG 
=>GG 
dGG 
.GG 
	UpdatedAtGG '
,GG' (
mapGG) ,
=>GG- /
mapGG0 3
.GG3 4
IgnoreGG4 :
(GG: ;
)GG; <
)GG< =
.HH 
	ForMemberHH 
(HH 
dHH 
=>HH 
dHH 
.HH 
	CreatedAtHH '
,HH' (
mapHH) ,
=>HH- /
mapHH0 3
.HH3 4
IgnoreHH4 :
(HH: ;
)HH; <
)HH< =
;HH= >
	CreateMapJJ 
<JJ 
WalletRequestJJ 
,JJ  
WalletJJ! '
>JJ' (
(JJ( )
)JJ) *
.KK 
	ForMemberKK 
(KK 
dKK 
=>KK 
dKK 
.KK 
IdKK  
,KK  !
mapKK" %
=>KK& (
mapKK) ,
.KK, -
IgnoreKK- 3
(KK3 4
)KK4 5
)KK5 6
.LL 
	ForMemberLL 
(LL 
dLL 
=>LL 
dLL 
.LL 
	UpdatedAtLL '
,LL' (
mapLL) ,
=>LL- /
mapLL0 3
.LL3 4
IgnoreLL4 :
(LL: ;
)LL; <
)LL< =
.MM 
	ForMemberMM 
(MM 
dMM 
=>MM 
dMM 
.MM 
	CreatedAtMM '
,MM' (
mapMM) ,
=>MM- /
mapMM0 3
.MM3 4
IgnoreMM4 :
(MM: ;
)MM; <
)MM< =
;MM= >
	CreateMapOO 
<OO  
WalletHistoryRequestOO &
,OO& '
WalletsHistoryOO( 6
>OO6 7
(OO7 8
)OO8 9
.PP 
	ForMemberPP 
(PP 
dPP 
=>PP 
dPP 
.PP 
IdPP  
,PP  !
mapPP" %
=>PP& (
mapPP) ,
.PP, -
IgnorePP- 3
(PP3 4
)PP4 5
)PP5 6
.QQ 
	ForMemberQQ 
(QQ 
dQQ 
=>QQ 
dQQ 
.QQ 
	UpdatedAtQQ '
,QQ' (
mapQQ) ,
=>QQ- /
mapQQ0 3
.QQ3 4
IgnoreQQ4 :
(QQ: ;
)QQ; <
)QQ< =
.RR 
	ForMemberRR 
(RR 
dRR 
=>RR 
dRR 
.RR 
	CreatedAtRR '
,RR' (
mapRR) ,
=>RR- /
mapRR0 3
.RR3 4
IgnoreRR4 :
(RR: ;
)RR; <
)RR< =
;RR= >
	CreateMapTT 
<TT 
WalletPeriodRequestTT %
,TT% &
WalletsPeriodTT' 4
>TT4 5
(TT5 6
)TT6 7
.UU 
	ForMemberUU 
(UU 
dUU 
=>UU 
dUU 
.UU 
IdUU  
,UU  !
mapUU" %
=>UU& (
mapUU) ,
.UU, -
IgnoreUU- 3
(UU3 4
)UU4 5
)UU5 6
.VV 
	ForMemberVV 
(VV 
dVV 
=>VV 
dVV 
.VV 
	UpdatedAtVV '
,VV' (
mapVV) ,
=>VV- /
mapVV0 3
.VV3 4
IgnoreVV4 :
(VV: ;
)VV; <
)VV< =
.WW 
	ForMemberWW 
(WW 
dWW 
=>WW 
dWW 
.WW 
	CreatedAtWW '
,WW' (
mapWW) ,
=>WW- /
mapWW0 3
.WW3 4
IgnoreWW4 :
(WW: ;
)WW; <
)WW< =
;WW= >
	CreateMapYY 
<YY (
WalletRetentionConfigRequestYY .
,YY. /#
WalletsRetentionsConfigYY0 G
>YYG H
(YYH I
)YYI J
.ZZ 
	ForMemberZZ 
(ZZ 
dZZ 
=>ZZ 
dZZ 
.ZZ 
IdZZ  
,ZZ  !
mapZZ" %
=>ZZ& (
mapZZ) ,
.ZZ, -
IgnoreZZ- 3
(ZZ3 4
)ZZ4 5
)ZZ5 6
.[[ 
	ForMember[[ 
([[ 
d[[ 
=>[[ 
d[[ 
.[[ 
	UpdatedAt[[ '
,[[' (
map[[) ,
=>[[- /
map[[0 3
.[[3 4
Ignore[[4 :
([[: ;
)[[; <
)[[< =
.\\ 
	ForMember\\ 
(\\ 
d\\ 
=>\\ 
d\\ 
.\\ 
	CreatedAt\\ '
,\\' (
map\\) ,
=>\\- /
map\\0 3
.\\3 4
Ignore\\4 :
(\\: ;
)\\; <
)\\< =
;\\= >
	CreateMap^^ 
<^^ 
WalletWaitRequest^^ #
,^^# $
WalletsWait^^% 0
>^^0 1
(^^1 2
)^^2 3
.__ 
	ForMember__ 
(__ 
d__ 
=>__ 
d__ 
.__ 
Id__  
,__  !
map__" %
=>__& (
map__) ,
.__, -
Ignore__- 3
(__3 4
)__4 5
)__5 6
.`` 
	ForMember`` 
(`` 
d`` 
=>`` 
d`` 
.`` 
	UpdatedAt`` '
,``' (
map``) ,
=>``- /
map``0 3
.``3 4
Ignore``4 :
(``: ;
)``; <
)``< =
.aa 
	ForMemberaa 
(aa 
daa 
=>aa 
daa 
.aa 
	CreatedAtaa '
,aa' (
mapaa) ,
=>aa- /
mapaa0 3
.aa3 4
Ignoreaa4 :
(aa: ;
)aa; <
)aa< =
;aa= >
	CreateMapcc 
<cc #
WalletWithDrawalRequestcc )
,cc) *
WalletsWithdrawalcc+ <
>cc< =
(cc= >
)cc> ?
.dd 
	ForMemberdd 
(dd 
ddd 
=>dd 
ddd 
.dd 
Iddd  
,dd  !
mapdd" %
=>dd& (
mapdd) ,
.dd, -
Ignoredd- 3
(dd3 4
)dd4 5
)dd5 6
.ee 
	ForMemberee 
(ee 
dee 
=>ee 
dee 
.ee 
	UpdatedAtee '
,ee' (
mapee) ,
=>ee- /
mapee0 3
.ee3 4
Ignoreee4 :
(ee: ;
)ee; <
)ee< =
.ff 
	ForMemberff 
(ff 
dff 
=>ff 
dff 
.ff 
	CreatedAtff '
,ff' (
mapff) ,
=>ff- /
mapff0 3
.ff3 4
Ignoreff4 :
(ff: ;
)ff; <
)ff< =
;ff= >
	CreateMaphh 
<hh 
InvoiceRequesthh  
,hh  !
Invoicehh" )
>hh) *
(hh* +
)hh+ ,
.ii 
	ForMemberii 
(ii 
destii 
=>ii 
destii #
.ii# $
Idii$ &
,ii& '
optii( +
=>ii, .
optii/ 2
.ii2 3
Ignoreii3 9
(ii9 :
)ii: ;
)ii; <
.jj 
	ForMemberjj 
(jj 
destjj 
=>jj 
destjj #
.jj# $
	UpdatedAtjj$ -
,jj- .
optjj/ 2
=>jj3 5
optjj6 9
.jj9 :
Ignorejj: @
(jj@ A
)jjA B
)jjB C
.kk 
	ForMemberkk 
(kk 
destkk 
=>kk 
destkk #
.kk# $
	CreatedAtkk$ -
,kk- .
optkk/ 2
=>kk3 5
optkk6 9
.kk9 :
Ignorekk: @
(kk@ A
)kkA B
)kkB C
.ll 
	ForMemberll 
(ll 
destll 
=>ll 
destll #
.ll# $
InvoicesDetailsll$ 3
,ll3 4
optll5 8
=>ll9 ;
optll< ?
.ll? @
Ignorell@ F
(llF G
)llG H
)llH I
;llI J
	CreateMapnn 
<nn 
Invoicenn 
,nn 

InvoiceDtonn %
>nn% &
(nn& '
)nn' (
.oo 
	ForMemberoo 
(oo 
destoo 
=>oo 
destoo #
.oo# $
Idoo$ &
,oo& '
optoo( +
=>oo, .
optoo/ 2
.oo2 3
MapFromoo3 :
(oo: ;
srcoo; >
=>oo? A
(ooB C
intooC F
)ooF G
srcooG J
.ooJ K
IdooK M
)ooM N
)ooN O
.pp 
	ForMemberpp 
(pp 
destpp 
=>pp 
destpp #
.pp# $
DepositDatepp$ /
,pp/ 0
optpp1 4
=>pp5 7
optpp8 ;
.pp; <
MapFrompp< C
(ppC D
srcppD G
=>ppH J
srcqq 
.qq 
DepositDateqq 
.qq  
HasValueqq  (
?qq) *
newrr 
DateTimerr  
(rr  !
srcrr! $
.rr$ %
DepositDaterr% 0
.rr0 1
Valuerr1 6
.rr6 7
Yearrr7 ;
,rr; <
srcrr= @
.rr@ A
DepositDaterrA L
.rrL M
ValuerrM R
.rrR S
MonthrrS X
,rrX Y
srcrrZ ]
.rr] ^
DepositDaterr^ i
.rri j
Valuerrj o
.rro p
Dayrrp s
)rrs t
:rru v
(ss 
DateTimess 
?ss 
)ss 
nullss #
)ss# $
)ss$ %
.tt 
	ForMembertt 
(tt 
desttt 
=>tt 
desttt #
.tt# $
InvoicesDetailstt$ 3
,tt3 4
opttt5 8
=>tt9 ;
opttt< ?
.tt? @
MapFromtt@ G
(ttG H
srcttH K
=>ttL N
srcttO R
.ttR S
InvoicesDetailsttS b
)ttb c
)ttc d
;ttd e
	CreateMapvv 
<vv  
InvoiceDetailRequestvv &
,vv& '
InvoicesDetailvv( 6
>vv6 7
(vv7 8
)vv8 9
.ww 
	ForMemberww 
(ww 
destww 
=>ww 
destww #
.ww# $
Invoiceww$ +
,ww+ ,
optww- 0
=>ww1 3
optww4 7
.ww7 8
Ignoreww8 >
(ww> ?
)ww? @
)ww@ A
;wwA B
	CreateMapyy 
<yy $
WalletTransactionRequestyy *
,yy* +
Walletyy, 2
>yy2 3
(yy3 4
)yy4 5
.zz 
	ForMemberzz 
(zz 
dzz 
=>zz 
dzz 
.zz 
Idzz  
,zz  !
mapzz" %
=>zz& (
mapzz) ,
.zz, -
Ignorezz- 3
(zz3 4
)zz4 5
)zz5 6
.{{ 
	ForMember{{ 
({{ 
d{{ 
=>{{ 
d{{ 
.{{ 
	UpdatedAt{{ '
,{{' (
map{{) ,
=>{{- /
map{{0 3
.{{3 4
Ignore{{4 :
({{: ;
){{; <
){{< =
.|| 
	ForMember|| 
(|| 
d|| 
=>|| 
d|| 
.|| 
	CreatedAt|| '
,||' (
map||) ,
=>||- /
map||0 3
.||3 4
Ignore||4 :
(||: ;
)||; <
)||< =
;||= >
	CreateMap~~ 
<~~ 
ResultsEcoPoolDto~~ #
,~~# $
ResultsModel2~~% 2
>~~2 3
(~~3 4
)~~4 5
. 
	ForMember 
( 
d 
=> 
d 
. 
Id  
,  !
map" %
=>& (
map) ,
., -
Ignore- 3
(3 4
)4 5
)5 6
.
ÄÄ 
	ForMember
ÄÄ 
(
ÄÄ 
dest
ÄÄ 
=>
ÄÄ 
dest
ÄÄ #
.
ÄÄ# $!
ResultsModel2Levels
ÄÄ$ 7
,
ÄÄ7 8
opt
ÄÄ9 <
=>
ÄÄ= ?
opt
ÄÄ@ C
.
ÄÄC D
MapFrom
ÄÄD K
(
ÄÄK L
src
ÄÄL O
=>
ÄÄP R
src
ÄÄS V
.
ÄÄV W!
ResultEcoPoolLevels
ÄÄW j
)
ÄÄj k
)
ÄÄk l
;
ÄÄl m
	CreateMap
ÇÇ 
<
ÇÇ $
ResultEcoPoolLevelsDto
ÇÇ (
,
ÇÇ( ) 
ResultsModel2Level
ÇÇ* <
>
ÇÇ< =
(
ÇÇ= >
)
ÇÇ> ?
.
ÉÉ 
	ForMember
ÉÉ 
(
ÉÉ 
d
ÉÉ 
=>
ÉÉ 
d
ÉÉ 
.
ÉÉ 
Id
ÉÉ  
,
ÉÉ  !
map
ÉÉ" %
=>
ÉÉ& (
map
ÉÉ) ,
.
ÉÉ, -
Ignore
ÉÉ- 3
(
ÉÉ3 4
)
ÉÉ4 5
)
ÉÉ5 6
;
ÉÉ6 7
	CreateMap
ÖÖ 
<
ÖÖ +
CoinPaymentTransactionRequest
ÖÖ /
,
ÖÖ/ 0$
CoinpaymentTransaction
ÖÖ1 G
>
ÖÖG H
(
ÖÖH I
)
ÖÖI J
.
ÜÜ 
	ForMember
ÜÜ 
(
ÜÜ 
d
ÜÜ 
=>
ÜÜ 
d
ÜÜ 
.
ÜÜ 
Id
ÜÜ  
,
ÜÜ  !
map
ÜÜ" %
=>
ÜÜ& (
map
ÜÜ) ,
.
ÜÜ, -
Ignore
ÜÜ- 3
(
ÜÜ3 4
)
ÜÜ4 5
)
ÜÜ5 6
.
áá 
	ForMember
áá 
(
áá 
d
áá 
=>
áá 
d
áá 
.
áá 
	UpdatedAt
áá '
,
áá' (
map
áá) ,
=>
áá- /
map
áá0 3
.
áá3 4
Ignore
áá4 :
(
áá: ;
)
áá; <
)
áá< =
.
àà 
	ForMember
àà 
(
àà 
d
àà 
=>
àà 
d
àà 
.
àà 
	CreatedAt
àà '
,
àà' (
map
àà) ,
=>
àà- /
map
àà0 3
.
àà3 4
Ignore
àà4 :
(
àà: ;
)
àà; <
)
àà< =
;
àà= >
	CreateMap
ää 
<
ää '
PaymentTransactionRequest
ää +
,
ää+ ,$
CoinpaymentTransaction
ää- C
>
ääC D
(
ääD E
)
ääE F
.
ãã 
	ForMember
ãã 
(
ãã 
d
ãã 
=>
ãã 
d
ãã 
.
ãã 
Id
ãã  
,
ãã  !
map
ãã" %
=>
ãã& (
map
ãã) ,
.
ãã, -
Ignore
ãã- 3
(
ãã3 4
)
ãã4 5
)
ãã5 6
.
åå 
	ForMember
åå 
(
åå 
d
åå 
=>
åå 
d
åå 
.
åå 
	UpdatedAt
åå '
,
åå' (
map
åå) ,
=>
åå- /
map
åå0 3
.
åå3 4
Ignore
åå4 :
(
åå: ;
)
åå; <
)
åå< =
.
çç 
	ForMember
çç 
(
çç 
d
çç 
=>
çç 
d
çç 
.
çç 
	CreatedAt
çç '
,
çç' (
map
çç) ,
=>
çç- /
map
çç0 3
.
çç3 4
Ignore
çç4 :
(
çç: ;
)
çç; <
)
çç< =
;
çç= >
	CreateMap
èè 
<
èè .
 CreatePagaditoTransactionRequest
èè 2
,
èè2 3'
CreatePagaditoTransaction
èè4 M
>
èèM N
(
èèN O
)
èèO P
.
êê 
	ForMember
êê 
(
êê 
d
êê 
=>
êê 
d
êê 
.
êê 
Token
êê #
,
êê# $
map
êê% (
=>
êê) +
map
êê, /
.
êê/ 0
Ignore
êê0 6
(
êê6 7
)
êê7 8
)
êê8 9
.
ëë 
	ForMember
ëë 
(
ëë 
d
ëë 
=>
ëë 
d
ëë 
.
ëë 
Ern
ëë !
,
ëë! "
map
ëë# &
=>
ëë' )
map
ëë* -
.
ëë- .
Ignore
ëë. 4
(
ëë4 5
)
ëë5 6
)
ëë6 7
;
ëë7 8
	CreateMap
ìì 
<
ìì .
 PagaditoTransactionDetailRequest
ìì 2
,
ìì2 3'
PagaditoTransactionDetail
ìì4 M
>
ììM N
(
ììN O
)
ììO P
;
ììP Q
}
îî 
}ïï ˆ
QC:\HeroSystem\walletService\WalletService.Core\Middlewares\ExceptionMiddleware.cs
	namespace 	
WalletService
 
. 
Core 
. 
Middlewares (
;( )
public 
class 
ExceptionMiddleware  
{ 
private 
readonly	 
RequestDelegate !
_next" '
;' (
public 
ExceptionMiddleware 
( 
RequestDelegate +
next, 0
)0 1
{ 
_next 
= 	
next
 
; 
} 
public 
async 
Task 
InvokeAsync 
( 
HttpContext *
context+ 2
)2 3
{ 
try 
{ 
await 
_next	 
( 
context 
) 
; 
} 
catch 
( 	
	Exception	 
e 
) 
{ 
await  
HandleExceptionAsync	 
( 
context %
,% &
e' (
)( )
;) *
} 
} 
private"" 
static""	 
Task""  
HandleExceptionAsync"" )
("") *
HttpContext""* 5
context""6 =
,""= >
	Exception""? H
	exception""I R
)""R S
{## 
string$$ 
exceptionBody$$	 
;$$ 
context&& 	
.&&	 

Response&&
 
.&& 
ContentType&& 
=&&  
MediaTypeNames&&! /
.&&/ 0
Application&&0 ;
.&&; <
Json&&< @
;&&@ A
context'' 	
.''	 

Response''
 
.'' 

StatusCode'' 
='' 
(''  !
int''! $
)''$ %
HttpStatusCode''% 3
.''3 4
InternalServerError''4 G
;''G H
switch)) 
())	 

	exception))
 
))) 
{** 
case++ 
CustomException++ 
customException++ '
:++' (
context,, 
.,, 
Response,, 
.,, 

StatusCode,, 
=,,  !
(,," #
int,,# &
),,& '
customException,,' 6
.,,6 7

StatusCode,,7 A
;,,A B
exceptionBody-- 
=-- 
customException-- #
.--# $
ExceptionBody--$ 1
??--2 4
string--5 ;
.--; <
Empty--< A
;--A B
return// 

context// 
.// 
Response// 
.// 

WriteAsync// &
(//& '
exceptionBody//' 4
)//4 5
;//5 6
default00 

:00
 
context11 
.11 
Response11 
.11 

StatusCode11 
=11  !
(11" #
int11# &
)11& '
HttpStatusCode11' 5
.115 6
InternalServerError116 I
;11I J
exceptionBody22 
=22 
	exception22 
.22 
Message22 %
;22% &
var44 
response44 
=44 
new44 
ServicesResponse44 '
{55 
Success66 
=66 
false66 
,66 
Code77 	
=77
 
context77 
.77 
Response77 
.77 

StatusCode77 '
,77' (
Message88 
=88 
exceptionBody88 
}99 
;99 
return;; 

context;; 
.;; 
Response;; 
.;; 

WriteAsync;; &
(;;& '
response;;' /
.;;/ 0
ToJsonString;;0 <
(;;< =
);;= >
);;> ?
;;;? @
}<< 
}== 
}>> ˙<
WC:\HeroSystem\walletService\WalletService.Core\Middlewares\TokenValidationMiddleware.cs
	namespace		 	
WalletService		
 
.		 
Core		 
.		 
Middlewares		 (
;		( )
public 
class %
TokenValidationMiddleware &
{ 
private 
readonly 
RequestDelegate $
_next% *
;* +
public 
%
TokenValidationMiddleware $
($ %
RequestDelegate% 4
next5 9
)9 :
{ 
_next 
= 
next 
; 
} 
public 

async 
Task 
InvokeAsync !
(! "
HttpContext" -
context. 5
,5 6 
IApiClientRepository7 K
apiClientServiceL \
,\ ]
IBrandRepository 
brandRepository (
,( )
ILogger* 1
<1 2%
TokenValidationMiddleware2 K
>K L
loggerM S
)S T
{ 
if 

( 
context 
. 
Request 
. 
Path  
.  !
Value! &
!& '
.' (
Equals( .
(. /
$str/ 8
,8 9
StringComparison: J
.J K
OrdinalIgnoreCaseK \
)\ ]
||^ `
context 
. 
Request 
. 
Path  
.  !
Value! &
.& '
Equals' -
(- .
$str. S
,S T
StringComparison  
.  !
OrdinalIgnoreCase! 2
)2 3
||4 6
context 
. 
Request 
. 
Path  
.  !
Value! &
.& '
Equals' -
(- .
$str. H
,H I
StringComparisonJ Z
.Z [
OrdinalIgnoreCase[ l
)l m
||n p
context 
. 
Request 
. 
Path  
.  !
Value! &
.& '
Equals' -
(- .
$str. G
,G H
StringComparisonI Y
.Y Z
OrdinalIgnoreCaseZ k
)k l
)l m
{ 	
await 
_next 
( 
context 
)  
;  !
return 
; 
} 	
var!! 
token!! 
=!! 
context!! 
.!! 
Request!! #
.!!# $
Headers!!$ +
[!!+ ,
$str!!, ;
]!!; <
.!!< =
ToString!!= E
(!!E F
)!!F G
;!!G H
var"" 
	secretKey"" 
="" 
context"" 
.""  
Request""  '
.""' (
Headers""( /
[""/ 0
$str""0 =
]""= >
.""> ?
ToString""? G
(""G H
)""H I
;""I J
if$$ 

($$ 
string$$ 
.$$ 
IsNullOrEmpty$$  
($$  !
token$$! &
)$$& '
&&$$( *
context$$+ 2
.$$2 3
Request$$3 :
.$$: ;
HasFormContentType$$; M
)$$M N
{%% 	
var&& 
form&& 
=&& 
await&& 
context&& $
.&&$ %
Request&&% ,
.&&, -
ReadFormAsync&&- :
(&&: ;
)&&; <
;&&< =
token'' 
='' 
form'' 
['' 
$str'' (
]''( )
;'') *
}(( 	
if** 

(** 
string** 
.** 
IsNullOrEmpty**  
(**  !
token**! &
)**& '
||**( *
string**+ 1
.**1 2
IsNullOrEmpty**2 ?
(**? @
	secretKey**@ I
)**I J
)**J K
{++ 	
var,, 
response,, 
=,, 
new,, 
ServicesResponse,, /
{-- 
Success.. 
=.. 
false.. 
,..  
Code// 
=// 
(// 
int// 
)// 
HttpStatusCode// *
.//* +
Unauthorized//+ 7
,//7 8
Message00 
=00 
$str00 (
}11 
;11 
logger33 
.33 
LogInformation33 !
(33! "
$"33" $
$str33$ G
{33G H
context33H O
.33O P
Request33P W
.33W X
GetDisplayUrl33X e
(33e f
)33f g
}33g h
"33h i
)33i j
;33j k
context44 
.44 
Response44 
.44 

StatusCode44 '
=44( )
$num44* -
;44- .
await55 
context55 
.55 
Response55 "
.55" #

WriteAsync55# -
(55- .
response55. 6
.556 7
ToJsonString557 C
(55C D
)55D E
)55E F
;55F G
return66 
;66 
}77 	
var99 

isValidate99 
=99 
await99 
apiClientService99 /
.99/ 0
ValidateApiClient990 A
(99A B
token99B G
)99G H
;99H I
var:: 
brand:: 
=:: 
await:: 
brandRepository:: )
.::) *
GetBrandByIdAsync::* ;
(::; <
	secretKey::< E
)::E F
;::F G
if;; 

(;; 
!;; 

isValidate;; 
||;; 
brand;;  
==;;! #
null;;$ (
);;( )
{<< 	
var== 
response== 
=== 
new== 
ServicesResponse== /
{>> 
Success?? 
=?? 
false?? 
,??  
Code@@ 
=@@ 
(@@ 
int@@ 
)@@ 
HttpStatusCode@@ *
.@@* +
Unauthorized@@+ 7
,@@7 8
MessageAA 
=AA 
$strAA (
}BB 
;BB 
loggerDD 
.DD 
LogInformationDD !
(DD! "
$"DD" $
$strDD$ G
{DDG H
contextDDH O
.DDO P
RequestDDP W
.DDW X
GetDisplayUrlDDX e
(DDe f
)DDf g
}DDg h
"DDh i
)DDi j
;DDj k
contextEE 
.EE 
ResponseEE 
.EE 

StatusCodeEE '
=EE( )
contextEE* 1
.EE1 2
ResponseEE2 :
.EE: ;

StatusCodeEE; E
=EEF G
$numEEH K
;EEK L
awaitFF 
contextFF 
.FF 
ResponseFF "
.FF" #

WriteAsyncFF# -
(FF- .
responseFF. 6
.FF6 7
ToJsonStringFF7 C
(FFC D
)FFD E
)FFE F
;FFF G
returnGG 
;GG 
}HH 	
contextJJ 
.JJ 
ItemsJJ 
[JJ 
$strJJ 
]JJ  
=JJ! "
brandJJ# (
.JJ( )
IdJJ) +
;JJ+ ,
loggerKK 
.KK 
LogInformationKK 
(KK 
$"KK  
$strKK  =
{KK= >
contextKK> E
.KKE F
RequestKKF M
.KKM N
GetDisplayUrlKKN [
(KK[ \
)KK\ ]
}KK] ^
"KK^ _
)KK_ `
;KK` a
awaitMM 
_nextMM 
(MM 
contextMM 
)MM 
;MM 
}NN 
}OO Ï∏
ZC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\BalancePaymentStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
;. /
public 
class "
BalancePaymentStrategy #
:$ %#
IBalancePaymentStrategy& =
{ 
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter. D
;D E
private 
readonly 
IWalletRepository &
_walletRepository. ?
;? @
private 
readonly  
IEcosystemPdfService ) 
_ecosystemPdfService/ C
;C D
private 
readonly 
IBrevoEmailService '
_brevoEmailService. @
;@ A
private 
readonly $
IWalletRequestRepository -$
_walletRequestRepository. F
;F G
private 
readonly 

RedisCache 
_redisCache. 9
;9 :
private 
readonly 
IBrandService "
_brandService. ;
;; <
private 
readonly 
IRecyCoinPdfService (
_recyCoinPdfService. A
;A B
private 
readonly 
IBonusRepository %
_bonusRepository. >
;> ?
private 
readonly  
IHouseCoinPdfService ) 
_houseCoinPdfService. B
;B C
public 
"
BalancePaymentStrategy !
(! "$
IInventoryServiceAdapter" :#
inventoryServiceAdapter; R
,R S"
IAccountServiceAdapter !
accountServiceAdapter; P
,P Q
IWalletRepositoryR c
walletRepositoryd t
,t u 
IEcosystemPdfService   
ecosystemPdfService  < O
,  O P
IBrevoEmailService!! 
brevoEmailService!!; L
,!!L M$
IWalletRequestRepository!!N f#
walletRequestRepository!!g ~
,!!~ 

RedisCache"" 

redisCache""; E
,""E F
IBrandService""F S
brandService""T `
,""` a
IRecyCoinPdfService## 
recyCoinPdfService##; M
,##M N 
IHouseCoinPdfService$$ 
houseCoinPdfService$$; N
,$$N O
IBonusRepository%% 
bonusRepository%% (
)%%( )
{&& $
_inventoryServiceAdapter''  
=''! "#
inventoryServiceAdapter''# :
;'': ;"
_accountServiceAdapter(( 
=((! "!
accountServiceAdapter((# 8
;((8 9
_walletRepository)) 
=))! "
walletRepository))# 3
;))3 4
_brevoEmailService** 
=**! "
brevoEmailService**# 4
;**4 5 
_ecosystemPdfService++ 
=++! "
ecosystemPdfService++# 6
;++6 7$
_walletRequestRepository,,  
=,,! "#
walletRequestRepository,,# :
;,,: ;
_redisCache-- 
=--! "

redisCache--# -
;--- .
_brandService.. 
=..! "
brandService..# /
;../ 0
_recyCoinPdfService// 
=//! "
recyCoinPdfService//# 5
;//5 6
_bonusRepository00 
=00! "
bonusRepository00# 2
;002 3 
_houseCoinPdfService11 
=11! "
houseCoinPdfService11# 6
;116 7
}22 
private44 
async44 
Task44 
<44 !
BalanceInformationDto44 ,
>44, -.
"GetBalanceInformationByAffiliateId44. P
(44P Q
int44Q T
affiliateId44U `
,44` a
long44a e
brandId44f m
)44m n
{55 
var66 
amountRequests66 
=66 
await66  %$
_walletRequestRepository66& >
.66> ?4
(GetTotalWalletRequestAmountByAffiliateId66? g
(66g h
affiliateId66h s
,66s t
brandId66u |
)66| }
;66} ~
var77 
availableBalance77 
=77 
await77  %
_walletRepository77& 7
.777 8,
 GetAvailableBalanceByAffiliateId778 X
(77X Y
affiliateId77Y d
,77d e
brandId77e l
)77l m
;77m n
var88 
reverseBalance88 
=88 
await88  %
_walletRepository88& 7
.887 8*
GetReverseBalanceByAffiliateId888 V
(88V W
affiliateId88W b
,88b c
brandId88c j
)88j k
;88k l
var99 
totalAcquisitions99 
=99 
await99  %
_walletRepository99& 7
.997 8-
!GetTotalAcquisitionsByAffiliateId998 Y
(99Y Z
affiliateId99Z e
,99e f
brandId99f m
)99m n
;99n o
var;; 
response;; 
=;; 
new;; !
BalanceInformationDto;; 0
{<< 	
AvailableBalance== 
=== 
availableBalance==  0
,==0 1
ReverseBalance>> 
=>> 
reverseBalance>>  .
??>>/ 1
	Constants>>2 ;
.>>; <

EmptyValue>>< F
,>>F G
TotalAcquisitions?? 
=?? 
totalAcquisitions??  1
????2 4
	Constants??5 >
.??> ?

EmptyValue??? I
}@@ 	
;@@	 

ifBB 

(BB 
amountRequestsBB 
==BB 
$numBB  
&&BB! #
responseBB$ ,
.BB, -
ReverseBalanceBB- ;
==BB< >
$numBB? A
)BBA B
returnBBC I
responseBBJ R
;BBR S
responseDD 
.DD 
AvailableBalanceDD !
-=DD" $
amountRequestsDD% 3
;DD3 4
responseEE 
.EE 
AvailableBalanceEE !
-=EE" $
responseEE% -
.EE- .
ReverseBalanceEE. <
;EE< =
returnGG 
responseGG 
;GG 
}HH 
privateJJ 
asyncJJ 
TaskJJ 
<JJ 
boolJJ 
>JJ &
PayMembershipBonusToFatherJJ 7
(JJ7 8$
CreditTransactionRequestJJ8 P
requestJJQ X
)JJX Y
{KK 
varLL 
createBonusLL 
=LL 
awaitLL 
_walletRepositoryLL  1
.LL1 2
CreditTransactionLL2 C
(LLC D
requestLLD K
)LLK L
;LLL M
returnNN 
createBonusNN 
;NN 
}OO 
publicQQ 

asyncQQ 
TaskQQ 
<QQ 
boolQQ 
>QQ !
ExecuteEcoPoolPaymentQQ 1
(QQ1 2
WalletRequestQQ2 ?
requestQQ@ G
)QQG H
{RR 
varSS 
debitSS 
=SS 
$numSS 
;SS  
varTT 
pointsTT 
=TT 
$numTT  
;TT  !
varUU 
commissionableUU 
=UU 
$numUU  
;UU  !
byteVV 
originVV 
=VV 
$numVV 
;VV  
varXX 
invoiceDetailsXX 
=XX 
newXX "
ListXX# '
<XX' (,
 InvoiceDetailsTransactionRequestXX( H
>XXH I
(XXI J
)XXJ K
;XXK L
varYY 
userInfoResponseYY 
=YY 
awaitYY $"
_accountServiceAdapterYY% ;
.YY; <
GetUserInfoYY< G
(YYG H
requestYYH O
.YYO P
AffiliateIdYYP [
,YY[ \
requestYY\ c
.YYc d
BrandIdYYd k
)YYk l
;YYl m
varZZ 
balanceInfoZZ 
=ZZ 
awaitZZ $.
"GetBalanceInformationByAffiliateIdZZ% G
(ZZG H
requestZZH O
.ZZO P
AffiliateIdZZP [
,ZZ[ \
requestZZ\ c
.ZZc d
BrandIdZZd k
)ZZk l
;ZZl m
var[[ 

productIds[[ 
=[[ 
request[[ &
.[[& '
ProductsList[[' 3
.[[3 4
Select[[4 :
([[: ;
p[[; <
=>[[= ?
p[[@ A
.[[A B
	IdProduct[[B K
)[[K L
.[[L M
ToArray[[M T
([[T U
)[[U V
;[[V W
var\\ 
responseList\\ 
=\\ 
await\\ $$
_inventoryServiceAdapter\\% =
.\\= >
GetProductsIds\\> L
(\\L M

productIds\\M W
,\\W X
request\\X _
.\\_ `
BrandId\\` g
)\\g h
;\\h i
if^^ 

(^^ 
!^^ 
responseList^^ 
.^^ 
IsSuccessful^^ &
)^^& '
return__ 
false__ 
;__ 
ifaa 

(aa 
stringaa 
.aa 
IsNullOrEmptyaa  
(aa  !
responseListaa! -
.aa- .
Contentaa. 5
)aa5 6
)aa6 7
returnbb 
falsebb 
;bb 
vardd 
resultdd 
=dd 
responseListdd !
.dd! "
Contentdd" )
.dd) *
ToJsonObjectdd* 6
<dd6 7
ProductsResponsedd7 G
>ddG H
(ddH I
)ddI J
;ddJ K
ifff 

(ff 
resultff 
?ff 
.ff 
Dataff 
.ff 
Countff 
==ff !
	Constantsff" +
.ff+ ,

EmptyValueff, 6
)ff6 7
{gg 	
varhh 
firstProductIdhh 
=hh! "
requesthh# *
.hh* +
ProductsListhh+ 7
.hh7 8
Firsthh8 =
(hh= >
)hh> ?
.hh? @
	IdProducthh@ I
;hhI J
varii 
membershipResultii  
=ii! "
awaitii# ($
_inventoryServiceAdapterii) A
.iiA B
GetProductByIdiiB P
(iiP Q
firstProductIdiiQ _
,ii_ `
requestii` g
.iig h
BrandIdiih o
)iio p
;iip q
varkk 
productResponsekk 
=kk  !
membershipResultkk" 2
.kk2 3
Contentkk3 :
!kk: ;
.kk; <
ToJsonObjectkk< H
<kkH I
ProductResponsekkI X
>kkX Y
(kkY Z
)kkZ [
;kk[ \
awaitmm "
_accountServiceAdaptermm (
.mm( ) 
UpdateActivationDatemm) =
(mm= >
requestmm> E
.mmE F
AffiliateIdmmF Q
,mmQ R
requestmmR Y
.mmY Z
BrandIdmmZ a
)mma b
;mmb c
resultoo 
.oo 
Dataoo 
.oo 
Addoo 
(oo 
productResponseoo +
!oo+ ,
.oo, -
Dataoo- 1
)oo1 2
;oo2 3
}pp 	
ifrr 

(rr 
resultrr 
?rr 
.rr 
Datarr 
==rr 
nullrr  
)rr  !
returnss 
falsess 
;ss 
ifuu 

(uu 
resultuu 
.uu 
Datauu 
.uu 
Countuu 
!=uu  
requestuu! (
.uu( )
ProductsListuu) 5
.uu5 6
Countuu6 ;
)uu; <
returnvv 
falsevv 
;vv 
varxx 
productNamesxx 
=xx 
resultxx !
.xx! "
Dataxx" &
.xx& '
Selectxx' -
(xx- .
itemxx. 2
=>xx3 5
itemxx6 :
.xx: ;
Namexx; ?
)xx? @
.xx@ A
ToArrayxxA H
(xxH I
)xxI J
;xxJ K
foreachzz 
(zz 
varzz 
itemzz 
inzz 
resultzz #
.zz# $
Datazz$ (
)zz( )
{{{ 	
var|| 
product|| 
=|| 
request|| !
.||! "
ProductsList||" .
.||. /
FirstOrDefault||/ =
(||= >
x||> ?
=>||@ B
x||C D
.||D E
	IdProduct||E N
==||O Q
item||R V
.||V W
Id||W Y
)||Y Z
;||Z [
var}} 
tax}} 
=}} 
item}} 
.}} 
Tax}} "
;}}" #
debit~~ 
+=~~ 
(~~ 
int~~ "
)~~" #
(~~# $
(~~$ %
item~~% )
.~~) *
	SalePrice~~* 3
*~~4 5
product~~6 =
!~~= >
.~~> ?
Count~~? D
)~~D E
*~~F G
(~~H I
$num~~I J
+~~K L
(~~M N
tax~~N Q
/~~R S
$num~~T W
)~~W X
)~~X Y
)~~Y Z
;~~Z [
points 
+= 
item "
." #
BinaryPoints# /
*0 1
product2 9
.9 :
Count: ?
;? @
commissionable
ÄÄ 
+=
ÄÄ 
item
ÄÄ "
.
ÄÄ" #!
CommissionableValue
ÄÄ# 6
*
ÄÄ7 8
product
ÄÄ9 @
.
ÄÄ@ A
Count
ÄÄA F
;
ÄÄF G
if
ÅÅ 
(
ÅÅ 
item
ÅÅ 
.
ÅÅ 

CategoryId
ÅÅ 
==
ÅÅ  "
$num
ÅÅ# $
)
ÅÅ$ %
{
ÇÇ 
origin
ÉÉ 
=
ÉÉ 
$num
ÉÉ 
;
ÉÉ 
}
ÑÑ 
var
ÜÜ 
invoiceDetail
ÜÜ 
=
ÜÜ 
new
ÜÜ  #.
 InvoiceDetailsTransactionRequest
ÜÜ$ D
{
áá 
	ProductId
àà 
=
àà& '
item
àà( ,
.
àà, -
Id
àà- /
,
àà/ 0
PaymentGroupId
ââ 
=
ââ& '
item
ââ( ,
.
ââ, -
PaymentGroup
ââ- 9
,
ââ9 :
AccumMinPurchase
ää  
=
ää& '
item
ää( ,
.
ää, -
AcumCompMin
ää- 8
,
ää8 9
ProductName
ãã 
=
ãã& '
item
ãã( ,
.
ãã, -
Name
ãã- 1
!
ãã1 2
,
ãã2 3
ProductPrice
åå 
=
åå& '
item
åå( ,
.
åå, -
	SalePrice
åå- 6
,
åå6 7
ProductPriceBtc
çç 
=
çç& '
	Constants
çç( 1
.
çç1 2

EmptyValue
çç2 <
,
çç< =

ProductIva
éé 
=
éé& '
item
éé( ,
.
éé, -
Tax
éé- 0
,
éé0 1
ProductQuantity
èè 
=
èè& '
product
èè( /
.
èè/ 0
Count
èè0 5
,
èè5 6#
ProductCommissionable
êê %
=
êê& '
item
êê( ,
.
êê, -!
CommissionableValue
êê- @
,
êê@ A
BinaryPoints
ëë 
=
ëë& '
item
ëë( ,
.
ëë, -
BinaryPoints
ëë- 9
,
ëë9 :
ProductPoints
íí 
=
íí& '
item
íí( ,
.
íí, -
ValuePoints
íí- 8
,
íí8 9
ProductDiscount
ìì 
=
ìì& '
item
ìì( ,
.
ìì, -
ProductDiscount
ìì- <
,
ìì< =
CombinationId
îî 
=
îî& '
	Constants
îî( 1
.
îî1 2

EmptyValue
îî2 <
,
îî< =
ProductPack
ïï 
=
ïï& '
item
ïï( ,
.
ïï, -
ProductPacks
ïï- 9
,
ïï9 :

BaseAmount
ññ 
=
ññ& '
(
ññ( )
item
ññ) -
.
ññ- .

BaseAmount
ññ. 8
*
ññ9 :
product
ññ; B
.
ññB C
Count
ññC H
)
ññH I
,
ññI J
DailyPercentage
óó 
=
óó& '
item
óó( ,
.
óó, -
DailyPercentage
óó- <
,
óó< =
WaitingDays
òò 
=
òò& '
item
òò( ,
.
òò, -
DaysWait
òò- 5
,
òò5 6
DaysToPayQuantity
ôô !
=
ôô& '
	Constants
ôô( 1
.
ôô1 2
DaysToPayQuantity
ôô2 C
,
ôôC D
ProductStart
öö 
=
öö& '
false
öö( -
,
öö- .
BrandId
õõ 
=
õõ& '
request
õõ( /
.
õõ/ 0
BrandId
õõ0 7
,
õõ7 8
}
úú 
;
úú 
invoiceDetails
ûû 
.
ûû 
Add
ûû 
(
ûû 
invoiceDetail
ûû ,
)
ûû, -
;
ûû- .
}
üü 	
if
°° 

(
°° 
debit
°° 
==
°° 
	Constants
°° 
.
°° 

EmptyValue
°° )
)
°°) *
return
¢¢ 
false
¢¢ 
;
¢¢ 
if
§§ 

(
§§ 
invoiceDetails
§§ 
.
§§ 
Count
§§  
==
§§! #
	Constants
§§$ -
.
§§- .

EmptyValue
§§. 8
)
§§8 9
return
•• 
false
•• 
;
•• 
if
ßß 

(
ßß 
debit
ßß 
>
ßß 
balanceInfo
ßß 
.
ßß  
AvailableBalance
ßß  0
.
ßß0 1
GetValueOrDefault
ßß1 B
(
ßßB C
)
ßßC D
)
ßßD E
return
®® 
false
®® 
;
®® 
var
™™ %
debitTransactionRequest
™™ #
=
™™$ %
new
™™& )%
DebitTransactionRequest
™™* A
{
´´ 	
Debit
¨¨ 
=
¨¨ 
debit
¨¨  %
,
¨¨% &
AffiliateId
≠≠ 
=
≠≠ 
request
≠≠  '
.
≠≠' (
AffiliateId
≠≠( 3
,
≠≠3 4
UserId
ÆÆ 
=
ÆÆ 
	Constants
ÆÆ  )
.
ÆÆ) *
AdminUserId
ÆÆ* 5
,
ÆÆ5 6
ConceptType
ØØ 
=
ØØ 
WalletConceptType
ØØ  1
.
ØØ1 2
purchasing_pool
ØØ2 A
.
ØØA B
ToString
ØØB J
(
ØØJ K
)
ØØK L
,
ØØL M
Points
∞∞ 
=
∞∞ 
points
∞∞  &
,
∞∞& '
Concept
±± 
=
±± 
	Constants
±±  )
.
±±) *$
EcoPoolProductCategory
±±* @
,
±±@ A
Commissionable
≤≤ 
=
≤≤ 
commissionable
≤≤  .
,
≤≤. /
Bank
≥≥ 
=
≥≥ 
request
≥≥  '
.
≥≥' (
Bank
≥≥( ,
,
≥≥, -
PaymentMethod
¥¥ 
=
¥¥ 
	Constants
¥¥  )
.
¥¥) *
WalletBalance
¥¥* 7
,
¥¥7 8
Origin
µµ 
=
µµ 
origin
µµ  &
,
µµ& '
Level
∂∂ 
=
∂∂ 
	Constants
∂∂  )
.
∂∂) *

EmptyValue
∂∂* 4
,
∂∂4 5
AffiliateUserName
∑∑ 
=
∑∑ 
request
∑∑  '
.
∑∑' (
AffiliateUserName
∑∑( 9
,
∑∑9 :
AdminUserName
∏∏ 
=
∏∏ 
request
∏∏  '
.
∏∏' (
BrandId
∏∏( /
switch
∏∏0 6
{
ππ 
$num
∫∫ 
=>
∫∫ 
	Constants
∫∫ 
.
∫∫ $
AdminEcosystemUserName
∫∫ 5
,
∫∫5 6
$num
ªª 
=>
ªª 
	Constants
ªª 
.
ªª 
RecycoinAdmin
ªª ,
,
ªª, -
$num
ºº 
=>
ºº 
	Constants
ºº 
.
ºº 
HouseCoinAdmin
ºº -
,
ºº- .
_
ΩΩ 
=>
ΩΩ 
	Constants
ΩΩ 
.
ΩΩ $
AdminEcosystemUserName
ΩΩ 5
}
ææ 
,
ææ 
ReceiptNumber
øø 
=
øø 
request
øø  '
.
øø' (
ReceiptNumber
øø( 5
,
øø5 6
Type
¿¿ 
=
¿¿ 
true
¿¿  $
,
¿¿$ %
	SecretKey
¡¡ 
=
¡¡ 
request
¡¡  '
.
¡¡' (
	SecretKey
¡¡( 1
,
¡¡1 2
invoices
¬¬ 
=
¬¬ 
invoiceDetails
¬¬  .
,
¬¬. /
Reason
√√ 
=
√√ 
string
√√  &
.
√√& '
Empty
√√' ,
,
√√, -
BrandId
ƒƒ 
=
ƒƒ 
request
ƒƒ  '
.
ƒƒ' (
BrandId
ƒƒ( /
,
ƒƒ/ 0
}
≈≈ 	
;
≈≈	 

var
«« 

spResponse
«« 
=
«« 
await
«« 
_walletRepository
«« 0
.
««0 1
DebitTransaction
««1 A
(
««A B%
debitTransactionRequest
««B Y
)
««Y Z
;
««Z [
if
…… 

(
…… 

spResponse
…… 
is
…… 
null
…… 
)
…… 
return
   
false
   
;
   
if
ÃÃ 

(
ÃÃ 
request
ÃÃ 
.
ÃÃ 
BrandId
ÃÃ 
==
ÃÃ 
	Constants
ÃÃ (
.
ÃÃ( )
RecyCoin
ÃÃ) 1
)
ÃÃ1 2
{
ÕÕ 	
await
’’ 
_walletRepository
’’ #
.
’’# $3
%DistributeCommissionsPerPurchaseAsync
’’$ I
(
’’I J
new
’’J M*
DistributeCommissionsRequest
’’N j
{
÷÷ 
AffiliateId
◊◊ 
=
◊◊ 
request
◊◊ %
.
◊◊% &
AffiliateId
◊◊& 1
,
◊◊1 2
InvoiceAmount
◊◊3 @
=
◊◊A B%
debitTransactionRequest
◊◊C Z
.
◊◊Z [
Debit
◊◊[ `
,
◊◊` a
BrandId
ÿÿ 
=
ÿÿ 
request
ÿÿ !
.
ÿÿ! "
BrandId
ÿÿ" )
,
ÿÿ) *
AdminUserName
ŸŸ 
=
ŸŸ 
	Constants
ŸŸ  )
.
ŸŸ) *
RecycoinAdmin
ŸŸ* 7
,
ŸŸ7 8
LevelPercentages
⁄⁄  
=
⁄⁄! "
[
⁄⁄# $
$num
⁄⁄$ (
,
⁄⁄( )
$num
⁄⁄) -
,
⁄⁄- .
$num
⁄⁄. 2
,
⁄⁄2 3
$num
⁄⁄3 7
,
⁄⁄7 8
$num
⁄⁄8 <
]
⁄⁄< =
}
€€ 
)
€€ 
;
€€ 
}
‹‹ 	
if
ﬁﬁ 

(
ﬁﬁ 
request
ﬁﬁ 
.
ﬁﬁ 
BrandId
ﬁﬁ 
==
ﬁﬁ 
	Constants
ﬁﬁ (
.
ﬁﬁ( )
	HouseCoin
ﬁﬁ) 2
)
ﬁﬁ2 3
{
ﬂﬂ 	
await
‡‡ 
_walletRepository
‡‡ #
.
‡‡# $3
%DistributeCommissionsPerPurchaseAsync
‡‡$ I
(
‡‡I J
new
‡‡J M*
DistributeCommissionsRequest
‡‡N j
{
·· 
AffiliateId
‚‚ 
=
‚‚ 
request
‚‚ %
.
‚‚% &
AffiliateId
‚‚& 1
,
‚‚1 2
InvoiceAmount
‚‚3 @
=
‚‚A B%
debitTransactionRequest
‚‚C Z
.
‚‚Z [
Debit
‚‚[ `
,
‚‚` a
BrandId
„„ 
=
„„ 
request
„„ !
.
„„! "
BrandId
„„" )
,
„„) *
AdminUserName
‰‰ 
=
‰‰ 
	Constants
‰‰  )
.
‰‰) *
HouseCoinAdmin
‰‰* 8
,
‰‰8 9
LevelPercentages
ÂÂ  
=
ÂÂ! "
[
ÂÂ# $
$num
ÂÂ$ (
,
ÂÂ( )
$num
ÂÂ* .
,
ÂÂ. /
$num
ÂÂ0 4
,
ÂÂ4 5
$num
ÂÂ6 :
,
ÂÂ: ;
$num
ÂÂ< @
]
ÂÂ@ A
,
ÂÂA B
}
ÊÊ 
)
ÊÊ 
;
ÊÊ 
}
ÁÁ 	
await
ÈÈ 
RemoveCacheKey
ÈÈ 
(
ÈÈ 
request
ÈÈ $
.
ÈÈ$ %
AffiliateId
ÈÈ% 0
,
ÈÈ0 1
	CacheKeys
ÈÈ2 ;
.
ÈÈ; <&
BalanceInformationModel2
ÈÈ< T
)
ÈÈT U
;
ÈÈU V
await
ÍÍ 
RemoveCacheKey
ÍÍ 
(
ÍÍ 
request
ÍÍ $
.
ÍÍ$ %
AffiliateId
ÍÍ% 0
,
ÍÍ0 1
	CacheKeys
ÍÍ2 ;
.
ÍÍ; <'
BalanceInformationModel1A
ÍÍ< U
)
ÍÍU V
;
ÍÍV W
await
ÎÎ 
RemoveCacheKey
ÎÎ 
(
ÎÎ 
request
ÎÎ $
.
ÎÎ$ %
AffiliateId
ÎÎ% 0
,
ÎÎ0 1
	CacheKeys
ÎÎ2 ;
.
ÎÎ; <'
BalanceInformationModel1B
ÎÎ< U
)
ÎÎU V
;
ÎÎV W
byte
ÌÌ 
[
ÌÌ 
]
ÌÌ 

invoicePdf
ÌÌ 
;
ÌÌ 
if
ÓÓ 

(
ÓÓ 
request
ÓÓ 
.
ÓÓ 
BrandId
ÓÓ 
==
ÓÓ 
	Constants
ÓÓ (
.
ÓÓ( )
RecyCoin
ÓÓ) 1
)
ÓÓ1 2
{
ÔÔ 	

invoicePdf
 
=
 
await
 !
_recyCoinPdfService
 2
.
2 3
GenerateInvoice
3 B
(
B C
userInfoResponse
C S
!
S T
,
T U%
debitTransactionRequest
V m
,
m n

spResponse
o y
)
y z
;
z {
}
ÒÒ 	
else
ÚÚ 
if
ÚÚ 
(
ÚÚ 
request
ÚÚ 
.
ÚÚ 
BrandId
ÚÚ  
==
ÚÚ! #
	Constants
ÚÚ$ -
.
ÚÚ- .
	HouseCoin
ÚÚ. 7
)
ÚÚ7 8
{
ÛÛ 	

invoicePdf
ÙÙ 
=
ÙÙ 
await
ÙÙ "
_houseCoinPdfService
ÙÙ 3
.
ÙÙ3 4
GenerateInvoice
ÙÙ4 C
(
ÙÙC D
userInfoResponse
ÙÙD T
!
ÙÙT U
,
ÙÙU V%
debitTransactionRequest
ÙÙW n
,
ÙÙn o

spResponse
ÙÙp z
)
ÙÙz {
;
ÙÙ{ |
}
ıı 	
else
ˆˆ 
{
˜˜ 	

invoicePdf
¯¯ 
=
¯¯ 
await
¯¯ "
_ecosystemPdfService
¯¯ 3
.
¯¯3 4
GenerateInvoice
¯¯4 C
(
¯¯C D
userInfoResponse
¯¯D T
!
¯¯T U
,
¯¯U V%
debitTransactionRequest
¯¯W n
,
¯¯n o

spResponse
¯¯p z
)
¯¯z {
;
¯¯{ |
}
˘˘ 	
var
˚˚ !
productPdfsContents
˚˚ 
=
˚˚  !
await
˚˚" '
CommonExtensions
˚˚( 8
.
˚˚8 9+
GetPdfContentFromProductNames
˚˚9 V
(
˚˚V W
productNames
˚˚W c
!
˚˚c d
)
˚˚d e
;
˚˚e f

Dictionary
˝˝ 
<
˝˝ 
string
˝˝ 
,
˝˝ 
byte
˝˝ 
[
˝˝  
]
˝˝  !
>
˝˝! "

allPdfData
˝˝# -
=
˝˝. /
new
˝˝0 3

Dictionary
˝˝4 >
<
˝˝> ?
string
˝˝? E
,
˝˝E F
byte
˝˝G K
[
˝˝K L
]
˝˝L M
>
˝˝M N
{
˛˛ 	
[
ˇˇ 
$str
ˇˇ 
]
ˇˇ 
=
ˇˇ 

invoicePdf
ˇˇ (
}
ÄÄ 	
;
ÄÄ	 

foreach
ÇÇ 
(
ÇÇ 
var
ÇÇ 
pdfDataEntry
ÇÇ !
in
ÇÇ" $!
productPdfsContents
ÇÇ% 8
)
ÇÇ8 9
{
ÉÉ 	

allPdfData
ÑÑ 
[
ÑÑ 
pdfDataEntry
ÑÑ #
.
ÑÑ# $
Key
ÑÑ$ '
]
ÑÑ' (
=
ÑÑ) *
pdfDataEntry
ÑÑ+ 7
.
ÑÑ7 8
Value
ÑÑ8 =
;
ÑÑ= >
}
ÖÖ 	
if
áá 

(
áá 

allPdfData
áá 
.
áá 
Count
áá 
>
áá 
	Constants
áá (
.
áá( )

EmptyValue
áá) 3
)
áá3 4
{
àà 	
await
ââ  
_brevoEmailService
ââ $
.
ââ$ %&
SendEmailPurchaseConfirm
ââ% =
(
ââ= >
userInfoResponse
ââ> N
!
ââN O
,
ââO P

allPdfData
ââQ [
,
ââ[ \

spResponse
ââ] g
,
ââg h
request
ââh o
.
ââo p
BrandId
ââp w
)
ââw x
;
ââx y
}
ää 	
return
åå 
true
åå 
;
åå 
}
çç 
public
èè 

async
èè 
Task
èè 
<
èè 
bool
èè 
>
èè !
ExecuteAdminPayment
èè /
(
èè/ 0
WalletRequest
èè0 =
request
èè> E
)
èèE F
{
êê 
var
ëë 
debit
ëë 
=
ëë 
$num
ëë 
;
ëë  
var
íí 
points
íí 
=
íí 
$num
íí  
;
íí  !
var
ìì 
commissionable
ìì 
=
ìì 
$num
ìì  
;
ìì  !
byte
îî 
origin
îî 
=
îî 
$num
îî 
;
îî  
var
ññ 
invoiceDetails
ññ 
=
ññ 
new
ññ "
List
ññ# '
<
ññ' (.
 InvoiceDetailsTransactionRequest
ññ( H
>
ññH I
(
ññI J
)
ññJ K
;
ññK L
var
óó 
userInfoResponse
óó 
=
óó 
await
óó $$
_accountServiceAdapter
óó% ;
.
óó; <
GetUserInfo
óó< G
(
óóG H
request
óóH O
.
óóO P
AffiliateId
óóP [
,
óó[ \
request
óó\ c
.
óóc d
BrandId
óód k
)
óók l
;
óól m
var
òò 

productIds
òò 
=
òò 
request
òò &
.
òò& '
ProductsList
òò' 3
.
òò3 4
Select
òò4 :
(
òò: ;
p
òò; <
=>
òò= ?
p
òò@ A
.
òòA B
	IdProduct
òòB K
)
òòK L
.
òòL M
ToArray
òòM T
(
òòT U
)
òòU V
;
òòV W
var
ôô 
responseList
ôô 
=
ôô 
await
ôô $&
_inventoryServiceAdapter
ôô% =
.
ôô= >
GetProductsIds
ôô> L
(
ôôL M

productIds
ôôM W
,
ôôW X
request
ôôX _
.
ôô_ `
BrandId
ôô` g
)
ôôg h
;
ôôh i
if
õõ 

(
õõ 
!
õõ 
responseList
õõ 
.
õõ 
IsSuccessful
õõ &
)
õõ& '
return
úú 
false
úú 
;
úú 
if
ûû 

(
ûû 
string
ûû 
.
ûû 
IsNullOrEmpty
ûû  
(
ûû  !
responseList
ûû! -
.
ûû- .
Content
ûû. 5
)
ûû5 6
)
ûû6 7
return
üü 
false
üü 
;
üü 
var
°° 
result
°° 
=
°° 
responseList
°° !
.
°°! "
Content
°°" )
.
°°) *
ToJsonObject
°°* 6
<
°°6 7
ProductsResponse
°°7 G
>
°°G H
(
°°H I
)
°°I J
;
°°J K
if
££ 

(
££ 
result
££ 
?
££ 
.
££ 
Data
££ 
.
££ 
Count
££ 
==
££ !
	Constants
££" +
.
££+ ,

EmptyValue
££, 6
)
££6 7
{
§§ 	
var
•• 
firstProductId
•• 
=
••! "
request
••# *
.
••* +
ProductsList
••+ 7
.
••7 8
First
••8 =
(
••= >
)
••> ?
.
••? @
	IdProduct
••@ I
;
••I J
var
¶¶ 
membershipResult
¶¶  
=
¶¶! "
await
¶¶# (&
_inventoryServiceAdapter
¶¶) A
.
¶¶A B
GetProductById
¶¶B P
(
¶¶P Q
firstProductId
¶¶Q _
,
¶¶_ `
request
¶¶` g
.
¶¶g h
BrandId
¶¶h o
)
¶¶o p
;
¶¶p q
var
®® 
productResponse
®® 
=
®®  !
membershipResult
®®" 2
.
®®2 3
Content
®®3 :
!
®®: ;
.
®®; <
ToJsonObject
®®< H
<
®®H I
ProductResponse
®®I X
>
®®X Y
(
®®Y Z
)
®®Z [
;
®®[ \
await
™™ $
_accountServiceAdapter
™™ (
.
™™( )"
UpdateActivationDate
™™) =
(
™™= >
request
™™> E
.
™™E F
AffiliateId
™™F Q
,
™™Q R
request
™™R Y
.
™™Y Z
BrandId
™™Z a
)
™™a b
;
™™b c
result
¨¨ 
.
¨¨ 
Data
¨¨ 
.
¨¨ 
Add
¨¨ 
(
¨¨ 
productResponse
¨¨ +
!
¨¨+ ,
.
¨¨, -
Data
¨¨- 1
)
¨¨1 2
;
¨¨2 3
}
≠≠ 	
if
ØØ 

(
ØØ 
result
ØØ 
?
ØØ 
.
ØØ 
Data
ØØ 
==
ØØ 
null
ØØ  
)
ØØ  !
return
∞∞ 
false
∞∞ 
;
∞∞ 
if
≤≤ 

(
≤≤ 
result
≤≤ 
.
≤≤ 
Data
≤≤ 
.
≤≤ 
Count
≤≤ 
!=
≤≤  
request
≤≤! (
.
≤≤( )
ProductsList
≤≤) 5
.
≤≤5 6
Count
≤≤6 ;
)
≤≤; <
return
≥≥ 
false
≥≥ 
;
≥≥ 
var
µµ 
productNames
µµ 
=
µµ 
result
µµ !
.
µµ! "
Data
µµ" &
.
µµ& '
Select
µµ' -
(
µµ- .
item
µµ. 2
=>
µµ3 5
item
µµ6 :
.
µµ: ;
Name
µµ; ?
)
µµ? @
.
µµ@ A
ToArray
µµA H
(
µµH I
)
µµI J
;
µµJ K
foreach
∑∑ 
(
∑∑ 
var
∑∑ 
item
∑∑ 
in
∑∑ 
result
∑∑ #
.
∑∑# $
Data
∑∑$ (
)
∑∑( )
{
∏∏ 	
var
ππ 
product
ππ 
=
ππ 
request
ππ !
.
ππ! "
ProductsList
ππ" .
.
ππ. /
FirstOrDefault
ππ/ =
(
ππ= >
x
ππ> ?
=>
ππ@ B
x
ππC D
.
ππD E
	IdProduct
ππE N
==
ππO Q
item
ππR V
.
ππV W
Id
ππW Y
)
ππY Z
;
ππZ [
var
∫∫ 
tax
∫∫ 
=
∫∫ 
item
∫∫ 
.
∫∫ 
Tax
∫∫ "
;
∫∫" #
debit
ªª 
+=
ªª 
(
ªª 
int
ªª "
)
ªª" #
(
ªª# $
(
ªª$ %
item
ªª% )
.
ªª) *
	SalePrice
ªª* 3
*
ªª4 5
product
ªª6 =
!
ªª= >
.
ªª> ?
Count
ªª? D
)
ªªD E
*
ªªF G
(
ªªH I
$num
ªªI J
+
ªªK L
(
ªªM N
tax
ªªN Q
/
ªªR S
$num
ªªT W
)
ªªW X
)
ªªX Y
)
ªªY Z
;
ªªZ [
points
ºº 
+=
ºº 
item
ºº "
.
ºº" #
BinaryPoints
ºº# /
*
ºº0 1
product
ºº2 9
.
ºº9 :
Count
ºº: ?
;
ºº? @
commissionable
ΩΩ 
+=
ΩΩ 
item
ΩΩ "
.
ΩΩ" #!
CommissionableValue
ΩΩ# 6
*
ΩΩ7 8
product
ΩΩ9 @
.
ΩΩ@ A
Count
ΩΩA F
;
ΩΩF G
if
ææ 
(
ææ 
item
ææ 
.
ææ 

CategoryId
ææ 
==
ææ  "
$num
ææ# $
)
ææ$ %
{
øø 
origin
¿¿ 
=
¿¿ 
$num
¿¿ 
;
¿¿ 
}
¡¡ 
var
√√ 
invoiceDetail
√√ 
=
√√ 
new
√√  #.
 InvoiceDetailsTransactionRequest
√√$ D
{
ƒƒ 
	ProductId
≈≈ 
=
≈≈& '
item
≈≈( ,
.
≈≈, -
Id
≈≈- /
,
≈≈/ 0
PaymentGroupId
∆∆ 
=
∆∆& '
item
∆∆( ,
.
∆∆, -
PaymentGroup
∆∆- 9
,
∆∆9 :
AccumMinPurchase
««  
=
««& '
item
««( ,
.
««, -
AcumCompMin
««- 8
,
««8 9
ProductName
»» 
=
»»& '
item
»»( ,
.
»», -
Name
»»- 1
!
»»1 2
,
»»2 3
ProductPrice
…… 
=
……& '
item
……( ,
.
……, -
	SalePrice
……- 6
,
……6 7
ProductPriceBtc
   
=
  & '
	Constants
  ( 1
.
  1 2

EmptyValue
  2 <
,
  < =

ProductIva
ÀÀ 
=
ÀÀ& '
item
ÀÀ( ,
.
ÀÀ, -
Tax
ÀÀ- 0
,
ÀÀ0 1
ProductQuantity
ÃÃ 
=
ÃÃ& '
product
ÃÃ( /
.
ÃÃ/ 0
Count
ÃÃ0 5
,
ÃÃ5 6#
ProductCommissionable
ÕÕ %
=
ÕÕ& '
item
ÕÕ( ,
.
ÕÕ, -!
CommissionableValue
ÕÕ- @
,
ÕÕ@ A
BinaryPoints
ŒŒ 
=
ŒŒ& '
item
ŒŒ( ,
.
ŒŒ, -
BinaryPoints
ŒŒ- 9
,
ŒŒ9 :
ProductPoints
œœ 
=
œœ& '
item
œœ( ,
.
œœ, -
ValuePoints
œœ- 8
,
œœ8 9
ProductDiscount
–– 
=
––& '
item
––( ,
.
––, -
ProductDiscount
––- <
,
––< =
CombinationId
—— 
=
——& '
	Constants
——( 1
.
——1 2

EmptyValue
——2 <
,
——< =
ProductPack
““ 
=
““& '
item
““( ,
.
““, -
ProductPacks
““- 9
,
““9 :

BaseAmount
”” 
=
””& '
(
””( )
item
””) -
.
””- .

BaseAmount
””. 8
*
””9 :
product
””; B
.
””B C
Count
””C H
)
””H I
,
””I J
DailyPercentage
‘‘ 
=
‘‘& '
item
‘‘( ,
.
‘‘, -
DailyPercentage
‘‘- <
,
‘‘< =
WaitingDays
’’ 
=
’’& '
item
’’( ,
.
’’, -
DaysWait
’’- 5
,
’’5 6
DaysToPayQuantity
÷÷ !
=
÷÷& '
	Constants
÷÷( 1
.
÷÷1 2
DaysToPayQuantity
÷÷2 C
,
÷÷C D
ProductStart
◊◊ 
=
◊◊& '
false
◊◊( -
,
◊◊- .
BrandId
ÿÿ 
=
ÿÿ& '
request
ÿÿ( /
.
ÿÿ/ 0
BrandId
ÿÿ0 7
}
ŸŸ 
;
ŸŸ 
invoiceDetails
€€ 
.
€€ 
Add
€€ 
(
€€ 
invoiceDetail
€€ ,
)
€€, -
;
€€- .
}
‹‹ 	
if
ﬁﬁ 

(
ﬁﬁ 
debit
ﬁﬁ 
==
ﬁﬁ 
	Constants
ﬁﬁ 
.
ﬁﬁ 

EmptyValue
ﬁﬁ )
)
ﬁﬁ) *
return
ﬂﬂ 
false
ﬂﬂ 
;
ﬂﬂ 
if
·· 

(
·· 
invoiceDetails
·· 
.
·· 
Count
··  
==
··! #
	Constants
··$ -
.
··- .

EmptyValue
··. 8
)
··8 9
return
‚‚ 
false
‚‚ 
;
‚‚ 
var
‰‰ %
debitTransactionRequest
‰‰ #
=
‰‰$ %
new
‰‰& )%
DebitTransactionRequest
‰‰* A
{
ÂÂ 	
Debit
ÊÊ 
=
ÊÊ 
debit
ÊÊ  %
,
ÊÊ% &
AffiliateId
ÁÁ 
=
ÁÁ 
request
ÁÁ  '
.
ÁÁ' (
AffiliateId
ÁÁ( 3
,
ÁÁ3 4
UserId
ËË 
=
ËË 
	Constants
ËË  )
.
ËË) *
AdminUserId
ËË* 5
,
ËË5 6
ConceptType
ÈÈ 
=
ÈÈ 
WalletConceptType
ÈÈ  1
.
ÈÈ1 2
purchasing_pool
ÈÈ2 A
.
ÈÈA B
ToString
ÈÈB J
(
ÈÈJ K
)
ÈÈK L
,
ÈÈL M
Points
ÍÍ 
=
ÍÍ 
points
ÍÍ  &
,
ÍÍ& '
Concept
ÎÎ 
=
ÎÎ 
	Constants
ÎÎ  )
.
ÎÎ) *,
EcoPoolProductCategoryForAdmin
ÎÎ* H
,
ÎÎH I
Commissionable
ÏÏ 
=
ÏÏ 
commissionable
ÏÏ  .
,
ÏÏ. /
Bank
ÌÌ 
=
ÌÌ 
request
ÌÌ  '
.
ÌÌ' (
Bank
ÌÌ( ,
,
ÌÌ, -
PaymentMethod
ÓÓ 
=
ÓÓ 
	Constants
ÓÓ  )
.
ÓÓ) *
AdminPayment
ÓÓ* 6
,
ÓÓ6 7
Origin
ÔÔ 
=
ÔÔ 
origin
ÔÔ  &
,
ÔÔ& '
Level
 
=
 
	Constants
  )
.
) *

EmptyValue
* 4
,
4 5
AffiliateUserName
ÒÒ 
=
ÒÒ 
request
ÒÒ  '
.
ÒÒ' (
AffiliateUserName
ÒÒ( 9
,
ÒÒ9 :
AdminUserName
ÚÚ 
=
ÚÚ 
request
ÚÚ  '
.
ÚÚ' (
BrandId
ÚÚ( /
==
ÚÚ0 2
$num
ÚÚ3 4
?
ÚÚ5 6
	Constants
ÚÚ7 @
.
ÚÚ@ A$
AdminEcosystemUserName
ÚÚA W
:
ÚÚX Y
	Constants
ÚÚZ c
.
ÚÚc d
RecycoinAdmin
ÚÚd q
,
ÚÚq r
ReceiptNumber
ÛÛ 
=
ÛÛ 
request
ÛÛ  '
.
ÛÛ' (
ReceiptNumber
ÛÛ( 5
,
ÛÛ5 6
Type
ÙÙ 
=
ÙÙ 
true
ÙÙ  $
,
ÙÙ$ %
	SecretKey
ıı 
=
ıı 
request
ıı  '
.
ıı' (
	SecretKey
ıı( 1
,
ıı1 2
invoices
ˆˆ 
=
ˆˆ 
invoiceDetails
ˆˆ  .
,
ˆˆ. /
Reason
˜˜ 
=
˜˜ 
string
˜˜  &
.
˜˜& '
Empty
˜˜' ,
,
˜˜, -
BrandId
¯¯ 
=
¯¯ 
request
¯¯  '
.
¯¯' (
BrandId
¯¯( /
}
˘˘ 	
;
˘˘	 

var
˚˚ 

spResponse
˚˚ 
=
˚˚ 
await
˚˚ 
_walletRepository
˚˚ 0
.
˚˚0 1#
AdminDebitTransaction
˚˚1 F
(
˚˚F G%
debitTransactionRequest
˚˚G ^
)
˚˚^ _
;
˚˚_ `
if
˝˝ 

(
˝˝ 

spResponse
˝˝ 
is
˝˝ 
null
˝˝ 
)
˝˝ 
return
˛˛ 
false
˛˛ 
;
˛˛ 
await
ÄÄ 
RemoveCacheKey
ÄÄ 
(
ÄÄ 
request
ÄÄ $
.
ÄÄ$ %
AffiliateId
ÄÄ% 0
,
ÄÄ0 1
	CacheKeys
ÄÄ2 ;
.
ÄÄ; <&
BalanceInformationModel2
ÄÄ< T
)
ÄÄT U
;
ÄÄU V
var
ÇÇ 

invoicePdf
ÇÇ 
=
ÇÇ 
await
ÇÇ "
_ecosystemPdfService
ÇÇ 3
.
ÇÇ3 4
GenerateInvoice
ÇÇ4 C
(
ÇÇC D
userInfoResponse
ÇÇD T
!
ÇÇT U
,
ÇÇU V%
debitTransactionRequest
ÇÇW n
,
ÇÇn o

spResponse
ÇÇp z
)
ÇÇz {
;
ÇÇ{ |
var
ÉÉ !
productPdfsContents
ÉÉ 
=
ÉÉ  !
await
ÉÉ" '
CommonExtensions
ÉÉ( 8
.
ÉÉ8 9+
GetPdfContentFromProductNames
ÉÉ9 V
(
ÉÉV W
productNames
ÉÉW c
!
ÉÉc d
)
ÉÉd e
;
ÉÉe f

Dictionary
ÖÖ 
<
ÖÖ 
string
ÖÖ 
,
ÖÖ 
byte
ÖÖ 
[
ÖÖ  
]
ÖÖ  !
>
ÖÖ! "

allPdfData
ÖÖ# -
=
ÖÖ. /
new
ÖÖ0 3

Dictionary
ÖÖ4 >
<
ÖÖ> ?
string
ÖÖ? E
,
ÖÖE F
byte
ÖÖG K
[
ÖÖK L
]
ÖÖL M
>
ÖÖM N
{
ÜÜ 	
[
áá 
$str
áá 
]
áá 
=
áá 

invoicePdf
áá (
}
àà 	
;
àà	 

foreach
ää 
(
ää 
var
ää 
pdfDataEntry
ää !
in
ää" $!
productPdfsContents
ää% 8
)
ää8 9
{
ãã 	

allPdfData
åå 
[
åå 
pdfDataEntry
åå #
.
åå# $
Key
åå$ '
]
åå' (
=
åå) *
pdfDataEntry
åå+ 7
.
åå7 8
Value
åå8 =
;
åå= >
}
çç 	
if
èè 

(
èè 

allPdfData
èè 
.
èè 
Count
èè 
>
èè 
	Constants
èè (
.
èè( )

EmptyValue
èè) 3
)
èè3 4
{
êê 	
await
ëë  
_brevoEmailService
ëë $
.
ëë$ %&
SendEmailPurchaseConfirm
ëë% =
(
ëë= >
userInfoResponse
ëë> N
!
ëëN O
,
ëëO P

allPdfData
ëëQ [
,
ëë[ \

spResponse
ëë] g
,
ëëg h
request
ëëh o
.
ëëo p
BrandId
ëëp w
)
ëëw x
;
ëëx y
}
íí 	
return
îî 
true
îî 
;
îî 
}
ïï 
public
ññ 

async
ññ 
Task
ññ 
<
ññ 
bool
ññ 
>
ññ #
ExecutePaymentCourses
ññ 1
(
ññ1 2
WalletRequest
ññ2 ?
request
ññ@ G
)
ññG H
{
óó 
var
òò 
debit
òò 
=
òò 
$num
òò 
;
òò  
var
ôô 
points
ôô 
=
ôô 
$num
ôô  
;
ôô  !
var
öö 
commissionable
öö 
=
öö 
$num
öö  
;
öö  !
byte
õõ 
origin
õõ 
=
õõ 
$num
õõ 
;
õõ  
var
ùù 
invoiceDetails
ùù 
=
ùù 
new
ùù "
List
ùù# '
<
ùù' (.
 InvoiceDetailsTransactionRequest
ùù( H
>
ùùH I
(
ùùI J
)
ùùJ K
;
ùùK L
var
ûû 
userInfoResponse
ûû 
=
ûû 
await
ûû $$
_accountServiceAdapter
ûû% ;
.
ûû; <
GetUserInfo
ûû< G
(
ûûG H
request
ûûH O
.
ûûO P
AffiliateId
ûûP [
,
ûû[ \
request
ûû\ c
.
ûûc d
BrandId
ûûd k
)
ûûk l
;
ûûl m
var
üü 
balanceInfo
üü 
=
üü 
await
üü $0
"GetBalanceInformationByAffiliateId
üü% G
(
üüG H
request
üüH O
.
üüO P
AffiliateId
üüP [
,
üü[ \
request
üü] d
.
üüd e
BrandId
üüe l
)
üül m
;
üüm n
var
†† 

productIds
†† 
=
†† 
request
†† &
.
††& '
ProductsList
††' 3
.
††3 4
Select
††4 :
(
††: ;
p
††; <
=>
††= ?
p
††@ A
.
††A B
	IdProduct
††B K
)
††K L
.
††L M
ToArray
††M T
(
††T U
)
††U V
;
††V W
var
°° 
responseList
°° 
=
°° 
await
°° $&
_inventoryServiceAdapter
°°% =
.
°°= >
GetProductsIds
°°> L
(
°°L M

productIds
°°M W
,
°°W X
request
°°X _
.
°°_ `
BrandId
°°` g
)
°°g h
;
°°h i
if
££ 

(
££ 
!
££ 
responseList
££ 
.
££ 
IsSuccessful
££ &
)
££& '
return
§§ 
false
§§ 
;
§§ 
if
¶¶ 

(
¶¶ 
string
¶¶ 
.
¶¶ 
IsNullOrEmpty
¶¶  
(
¶¶  !
responseList
¶¶! -
.
¶¶- .
Content
¶¶. 5
)
¶¶5 6
)
¶¶6 7
return
ßß 
false
ßß 
;
ßß 
var
©© 
result
©© 
=
©© 
responseList
©© !
.
©©! "
Content
©©" )
.
©©) *
ToJsonObject
©©* 6
<
©©6 7
ProductsResponse
©©7 G
>
©©G H
(
©©H I
)
©©I J
;
©©J K
if
´´ 

(
´´ 
result
´´ 
?
´´ 
.
´´ 
Data
´´ 
==
´´ 
null
´´  
)
´´  !
return
¨¨ 
false
¨¨ 
;
¨¨ 
if
ÆÆ 

(
ÆÆ 
result
ÆÆ 
.
ÆÆ 
Data
ÆÆ 
.
ÆÆ 
Count
ÆÆ 
!=
ÆÆ  
request
ÆÆ! (
.
ÆÆ( )
ProductsList
ÆÆ) 5
.
ÆÆ5 6
Count
ÆÆ6 ;
)
ÆÆ; <
return
ØØ 
false
ØØ 
;
ØØ 
foreach
±± 
(
±± 
var
±± 
item
±± 
in
±± 
result
±± #
.
±±# $
Data
±±$ (
)
±±( )
{
≤≤ 	
var
≥≥ 
product
≥≥ 
=
≥≥ 
request
≥≥ !
.
≥≥! "
ProductsList
≥≥" .
.
≥≥. /
FirstOrDefault
≥≥/ =
(
≥≥= >
x
≥≥> ?
=>
≥≥@ B
x
≥≥C D
.
≥≥D E
	IdProduct
≥≥E N
==
≥≥O Q
item
≥≥R V
.
≥≥V W
Id
≥≥W Y
)
≥≥Y Z
;
≥≥Z [
var
¥¥ 
tax
¥¥ 
=
¥¥ 
item
¥¥ 
.
¥¥ 
Tax
¥¥ "
;
¥¥" #
debit
µµ 
+=
µµ 
(
µµ 
int
µµ "
)
µµ" #
(
µµ# $
(
µµ$ %
item
µµ% )
.
µµ) *
	SalePrice
µµ* 3
*
µµ4 5
product
µµ6 =
!
µµ= >
.
µµ> ?
Count
µµ? D
)
µµD E
*
µµF G
(
µµH I
$num
µµI J
+
µµK L
(
µµM N
tax
µµN Q
/
µµR S
$num
µµT W
)
µµW X
)
µµX Y
)
µµY Z
;
µµZ [
points
∂∂ 
+=
∂∂ 
item
∂∂ "
.
∂∂" #
BinaryPoints
∂∂# /
*
∂∂0 1
product
∂∂2 9
.
∂∂9 :
Count
∂∂: ?
;
∂∂? @
commissionable
∑∑ 
+=
∑∑ 
item
∑∑ "
.
∑∑" #!
CommissionableValue
∑∑# 6
*
∑∑7 8
product
∑∑9 @
.
∑∑@ A
Count
∑∑A F
;
∑∑F G
if
∏∏ 
(
∏∏ 
item
∏∏ 
.
∏∏ 

CategoryId
∏∏ 
==
∏∏  "
$num
∏∏# $
)
∏∏$ %
{
ππ 
origin
∫∫ 
=
∫∫ 
$num
∫∫ 
;
∫∫ 
}
ªª 
var
ΩΩ 
invoiceDetail
ΩΩ 
=
ΩΩ 
new
ΩΩ  #.
 InvoiceDetailsTransactionRequest
ΩΩ$ D
{
ææ 
	ProductId
øø 
=
øø& '
item
øø( ,
.
øø, -
Id
øø- /
,
øø/ 0
PaymentGroupId
¿¿ 
=
¿¿& '
item
¿¿( ,
.
¿¿, -
PaymentGroup
¿¿- 9
,
¿¿9 :
AccumMinPurchase
¡¡  
=
¡¡& '
item
¡¡( ,
.
¡¡, -
AcumCompMin
¡¡- 8
,
¡¡8 9
ProductName
¬¬ 
=
¬¬& '
item
¬¬( ,
.
¬¬, -
Name
¬¬- 1
!
¬¬1 2
,
¬¬2 3
ProductPrice
√√ 
=
√√& '
item
√√( ,
.
√√, -
	SalePrice
√√- 6
,
√√6 7
ProductPriceBtc
ƒƒ 
=
ƒƒ& '
	Constants
ƒƒ( 1
.
ƒƒ1 2

EmptyValue
ƒƒ2 <
,
ƒƒ< =

ProductIva
≈≈ 
=
≈≈& '
item
≈≈( ,
.
≈≈, -
Tax
≈≈- 0
,
≈≈0 1
ProductQuantity
∆∆ 
=
∆∆& '
product
∆∆( /
.
∆∆/ 0
Count
∆∆0 5
,
∆∆5 6#
ProductCommissionable
«« %
=
««& '
item
««( ,
.
««, -!
CommissionableValue
««- @
,
««@ A
BinaryPoints
»» 
=
»»& '
item
»»( ,
.
»», -
BinaryPoints
»»- 9
,
»»9 :
ProductPoints
…… 
=
……& '
item
……( ,
.
……, -
ValuePoints
……- 8
,
……8 9
ProductDiscount
   
=
  & '
item
  ( ,
.
  , -
ProductDiscount
  - <
,
  < =
CombinationId
ÀÀ 
=
ÀÀ& '
	Constants
ÀÀ( 1
.
ÀÀ1 2

EmptyValue
ÀÀ2 <
,
ÀÀ< =
ProductPack
ÃÃ 
=
ÃÃ& '
item
ÃÃ( ,
.
ÃÃ, -
ProductPacks
ÃÃ- 9
,
ÃÃ9 :

BaseAmount
ÕÕ 
=
ÕÕ& '
(
ÕÕ( )
item
ÕÕ) -
.
ÕÕ- .

BaseAmount
ÕÕ. 8
*
ÕÕ9 :
product
ÕÕ; B
.
ÕÕB C
Count
ÕÕC H
)
ÕÕH I
,
ÕÕI J
DailyPercentage
ŒŒ 
=
ŒŒ& '
item
ŒŒ( ,
.
ŒŒ, -
DailyPercentage
ŒŒ- <
,
ŒŒ< =
WaitingDays
œœ 
=
œœ& '
item
œœ( ,
.
œœ, -
DaysWait
œœ- 5
,
œœ5 6
DaysToPayQuantity
–– !
=
––& '
	Constants
––( 1
.
––1 2
DaysToPayQuantity
––2 C
,
––C D
ProductStart
—— 
=
——& '
false
——( -
,
——- .
BrandId
““ 
=
““& '
request
““( /
.
““/ 0
BrandId
““0 7
}
”” 
;
”” 
invoiceDetails
’’ 
.
’’ 
Add
’’ 
(
’’ 
invoiceDetail
’’ ,
)
’’, -
;
’’- .
}
÷÷ 	
if
ÿÿ 

(
ÿÿ 
debit
ÿÿ 
==
ÿÿ 
	Constants
ÿÿ 
.
ÿÿ 

EmptyValue
ÿÿ )
)
ÿÿ) *
return
ŸŸ 
false
ŸŸ 
;
ŸŸ 
if
€€ 

(
€€ 
invoiceDetails
€€ 
.
€€ 
Count
€€  
==
€€! #
	Constants
€€$ -
.
€€- .

EmptyValue
€€. 8
)
€€8 9
return
‹‹ 
false
‹‹ 
;
‹‹ 
if
ﬁﬁ 

(
ﬁﬁ 
debit
ﬁﬁ 
>
ﬁﬁ 
balanceInfo
ﬁﬁ 
.
ﬁﬁ  
AvailableBalance
ﬁﬁ  0
.
ﬁﬁ0 1
GetValueOrDefault
ﬁﬁ1 B
(
ﬁﬁB C
)
ﬁﬁC D
)
ﬁﬁD E
return
ﬂﬂ 
false
ﬂﬂ 
;
ﬂﬂ 
var
·· %
debitTransactionRequest
·· #
=
··$ %
new
··& )%
DebitTransactionRequest
··* A
{
‚‚ 	
Debit
„„ 
=
„„ 
debit
„„  %
,
„„% &
AffiliateId
‰‰ 
=
‰‰ 
request
‰‰  '
.
‰‰' (
AffiliateId
‰‰( 3
,
‰‰3 4
UserId
ÂÂ 
=
ÂÂ 
	Constants
ÂÂ  )
.
ÂÂ) *
AdminUserId
ÂÂ* 5
,
ÂÂ5 6
ConceptType
ÊÊ 
=
ÊÊ 
WalletConceptType
ÊÊ  1
.
ÊÊ1 2
purchasing_pool
ÊÊ2 A
.
ÊÊA B
ToString
ÊÊB J
(
ÊÊJ K
)
ÊÊK L
,
ÊÊL M
Points
ÁÁ 
=
ÁÁ 
points
ÁÁ  &
,
ÁÁ& '
Concept
ËË 
=
ËË 
	Constants
ËË  )
.
ËË) *$
EcoPoolProductCategory
ËË* @
,
ËË@ A
Commissionable
ÈÈ 
=
ÈÈ 
commissionable
ÈÈ  .
,
ÈÈ. /
Bank
ÍÍ 
=
ÍÍ 
request
ÍÍ  '
.
ÍÍ' (
Bank
ÍÍ( ,
,
ÍÍ, -
PaymentMethod
ÎÎ 
=
ÎÎ 
	Constants
ÎÎ  )
.
ÎÎ) *
WalletBalance
ÎÎ* 7
,
ÎÎ7 8
Origin
ÏÏ 
=
ÏÏ 
origin
ÏÏ  &
,
ÏÏ& '
Level
ÌÌ 
=
ÌÌ 
	Constants
ÌÌ  )
.
ÌÌ) *

EmptyValue
ÌÌ* 4
,
ÌÌ4 5
AffiliateUserName
ÓÓ 
=
ÓÓ 
request
ÓÓ  '
.
ÓÓ' (
AffiliateUserName
ÓÓ( 9
,
ÓÓ9 :
AdminUserName
ÔÔ 
=
ÔÔ 
request
ÔÔ  '
.
ÔÔ' (
BrandId
ÔÔ( /
==
ÔÔ0 2
$num
ÔÔ3 4
?
ÔÔ5 6
	Constants
ÔÔ7 @
.
ÔÔ@ A$
AdminEcosystemUserName
ÔÔA W
:
ÔÔX Y
	Constants
ÔÔZ c
.
ÔÔc d
RecycoinAdmin
ÔÔd q
,
ÔÔq r
ReceiptNumber
 
=
 
request
  '
.
' (
ReceiptNumber
( 5
,
5 6
Type
ÒÒ 
=
ÒÒ 
true
ÒÒ  $
,
ÒÒ$ %
	SecretKey
ÚÚ 
=
ÚÚ 
request
ÚÚ  '
.
ÚÚ' (
	SecretKey
ÚÚ( 1
,
ÚÚ1 2
invoices
ÛÛ 
=
ÛÛ 
invoiceDetails
ÛÛ  .
,
ÛÛ. /
Reason
ÙÙ 
=
ÙÙ 
string
ÙÙ  &
.
ÙÙ& '
Empty
ÙÙ' ,
,
ÙÙ- .
BrandId
ıı 
=
ıı 
request
ıı  '
.
ıı' (
BrandId
ıı( /
,
ıı/ 0
}
ˆˆ 	
;
ˆˆ	 

var
¯¯ 

spResponse
¯¯ 
=
¯¯ 
await
¯¯ 
_walletRepository
¯¯ 0
.
¯¯0 1
DebitTransaction
¯¯1 A
(
¯¯A B%
debitTransactionRequest
¯¯B Y
)
¯¯Y Z
;
¯¯Z [
if
˙˙ 

(
˙˙ 

spResponse
˙˙ 
is
˙˙ 
null
˙˙ 
)
˙˙ 
return
˚˚ 
false
˚˚ 
;
˚˚ 
await
˝˝ 
RemoveCacheKey
˝˝ 
(
˝˝ 
request
˝˝ $
.
˝˝$ %
AffiliateId
˝˝% 0
,
˝˝0 1
	CacheKeys
˝˝2 ;
.
˝˝; <&
BalanceInformationModel2
˝˝< T
)
˝˝T U
;
˝˝U V
var
ˇˇ 

invoicePdf
ˇˇ 
=
ˇˇ 
await
ÄÄ "
_ecosystemPdfService
ÄÄ &
.
ÄÄ& '
GenerateInvoice
ÄÄ' 6
(
ÄÄ6 7
userInfoResponse
ÄÄ7 G
!
ÄÄG H
,
ÄÄH I%
debitTransactionRequest
ÄÄJ a
,
ÄÄa b

spResponse
ÄÄc m
)
ÄÄm n
;
ÄÄn o

Dictionary
ÇÇ 
<
ÇÇ 
string
ÇÇ 
,
ÇÇ 
byte
ÇÇ 
[
ÇÇ  
]
ÇÇ  !
>
ÇÇ! "

allPdfData
ÇÇ# -
=
ÇÇ. /
new
ÇÇ0 3

Dictionary
ÇÇ4 >
<
ÇÇ> ?
string
ÇÇ? E
,
ÇÇE F
byte
ÇÇG K
[
ÇÇK L
]
ÇÇL M
>
ÇÇM N
{
ÉÉ 	
[
ÑÑ 
$str
ÑÑ 
]
ÑÑ 
=
ÑÑ 

invoicePdf
ÑÑ (
}
ÖÖ 	
;
ÖÖ	 

if
áá 

(
áá 

allPdfData
áá 
.
áá 
Count
áá 
>
áá 
	Constants
áá (
.
áá( )

EmptyValue
áá) 3
)
áá3 4
{
àà 	
await
ââ  
_brevoEmailService
ââ $
.
ââ$ %&
SendEmailPurchaseConfirm
ââ% =
(
ââ= >
userInfoResponse
ââ> N
!
ââN O
,
ââO P

allPdfData
ââQ [
,
ââ[ \

spResponse
ââ] g
,
ââg h
request
ââh o
.
ââo p
BrandId
ââp w
)
ââw x
;
ââx y
}
ää 	
return
åå 
true
åå 
;
åå 
}
çç 
public
èè 

async
èè 
Task
èè 
<
èè 
bool
èè 
>
èè "
ExecuteCustomPayment
èè 0
(
èè0 1
WalletRequest
èè1 >
request
èè? F
)
èèF G
{
êê 
var
ëë 
debit
ëë 
=
ëë 
$num
ëë  
;
ëë  !
var
íí 
points
íí 
=
íí 
$num
íí  
;
íí  !
var
ìì 
commissionable
ìì 
=
ìì 
$num
ìì  
;
ìì  !
byte
îî 
origin
îî 
=
îî 
$num
îî 
;
îî  
var
ññ 
invoiceDetails
ññ 
=
ññ 
new
ññ "
List
ññ# '
<
ññ' (.
 InvoiceDetailsTransactionRequest
ññ( H
>
ññH I
(
ññI J
)
ññJ K
;
ññK L
var
óó 
userInfoResponse
óó 
=
óó 
await
óó $$
_accountServiceAdapter
óó% ;
.
óó; <
GetUserInfo
óó< G
(
óóG H
request
óóH O
.
óóO P
AffiliateId
óóP [
,
óó[ \
request
óó\ c
.
óóc d
BrandId
óód k
)
óók l
;
óól m
var
òò 

productIds
òò 
=
òò 
request
òò &
.
òò& '
ProductsList
òò' 3
.
òò3 4
Select
òò4 :
(
òò: ;
p
òò; <
=>
òò= ?
p
òò@ A
.
òòA B
	IdProduct
òòB K
)
òòK L
.
òòL M
ToArray
òòM T
(
òòT U
)
òòU V
;
òòV W
var
ôô 
responseList
ôô 
=
ôô 
await
ôô $&
_inventoryServiceAdapter
ôô% =
.
ôô= >
GetProductsIds
ôô> L
(
ôôL M

productIds
ôôM W
,
ôôW X
request
ôôX _
.
ôô_ `
BrandId
ôô` g
)
ôôg h
;
ôôh i
if
õõ 

(
õõ 
!
õõ 
responseList
õõ 
.
õõ 
IsSuccessful
õõ &
)
õõ& '
return
úú 
false
úú 
;
úú 
if
ûû 

(
ûû 
string
ûû 
.
ûû 
IsNullOrEmpty
ûû  
(
ûû  !
responseList
ûû! -
.
ûû- .
Content
ûû. 5
)
ûû5 6
)
ûû6 7
return
üü 
false
üü 
;
üü 
var
°° 
result
°° 
=
°° 
responseList
°° !
.
°°! "
Content
°°" )
.
°°) *
ToJsonObject
°°* 6
<
°°6 7
ProductsResponse
°°7 G
>
°°G H
(
°°H I
)
°°I J
;
°°J K
if
££ 

(
££ 
result
££ 
?
££ 
.
££ 
Data
££ 
==
££ 
null
££  
)
££  !
return
§§ 
false
§§ 
;
§§ 
if
¶¶ 

(
¶¶ 
result
¶¶ 
.
¶¶ 
Data
¶¶ 
.
¶¶ 
Count
¶¶ 
!=
¶¶  
request
¶¶! (
.
¶¶( )
ProductsList
¶¶) 5
.
¶¶5 6
Count
¶¶6 ;
)
¶¶; <
return
ßß 
false
ßß 
;
ßß 
foreach
©© 
(
©© 
var
©© 
item
©© 
in
©© 
result
©© #
.
©©# $
Data
©©$ (
)
©©( )
{
™™ 	
var
´´ 
product
´´ 
=
´´ 
request
´´ !
.
´´! "
ProductsList
´´" .
.
´´. /
FirstOrDefault
´´/ =
(
´´= >
x
´´> ?
=>
´´@ B
x
´´C D
.
´´D E
	IdProduct
´´E N
==
´´O Q
item
´´R V
.
´´V W
Id
´´W Y
)
´´Y Z
;
´´Z [
item
¨¨ 
.
¨¨ 
	SalePrice
¨¨ 
=
¨¨ 
Convert
¨¨ %
.
¨¨% &
	ToDecimal
¨¨& /
(
¨¨/ 0
request
¨¨0 7
.
¨¨7 8
ReceiptNumber
¨¨8 E
)
¨¨E F
;
¨¨F G
item
≠≠ 
.
≠≠ 

BaseAmount
≠≠ 
=
≠≠ 
item
≠≠ "
.
≠≠" #
	SalePrice
≠≠# ,
;
≠≠, -
item
ÆÆ 
.
ÆÆ 
Name
ÆÆ 
=
ÆÆ 
$str
ÆÆ -
;
ÆÆ- .
debit
∞∞ 
=
∞∞ 
item
∞∞ "
.
∞∞" #

BaseAmount
∞∞# -
;
∞∞- .
points
±± 
+=
±± 
item
±± "
.
±±" #
BinaryPoints
±±# /
*
±±0 1
product
±±2 9
!
±±9 :
.
±±: ;
Count
±±; @
;
±±@ A
commissionable
≤≤ 
+=
≤≤ 
item
≤≤ "
.
≤≤" #!
CommissionableValue
≤≤# 6
*
≤≤7 8
product
≤≤9 @
.
≤≤@ A
Count
≤≤A F
;
≤≤F G
if
≥≥ 
(
≥≥ 
item
≥≥ 
.
≥≥ 

CategoryId
≥≥ 
==
≥≥  "
$num
≥≥# $
)
≥≥$ %
{
¥¥ 
origin
µµ 
=
µµ 
$num
µµ 
;
µµ 
}
∂∂ 
var
∏∏ 
invoiceDetail
∏∏ 
=
∏∏ 
new
∏∏  #.
 InvoiceDetailsTransactionRequest
∏∏$ D
{
ππ 
	ProductId
∫∫ 
=
∫∫& '
item
∫∫( ,
.
∫∫, -
Id
∫∫- /
,
∫∫/ 0
PaymentGroupId
ªª 
=
ªª& '
item
ªª( ,
.
ªª, -
PaymentGroup
ªª- 9
,
ªª9 :
AccumMinPurchase
ºº  
=
ºº& '
item
ºº( ,
.
ºº, -
AcumCompMin
ºº- 8
,
ºº8 9
ProductName
ΩΩ 
=
ΩΩ& '
item
ΩΩ( ,
.
ΩΩ, -
Name
ΩΩ- 1
!
ΩΩ1 2
,
ΩΩ2 3
ProductPrice
ææ 
=
ææ& '
item
ææ( ,
.
ææ, -
	SalePrice
ææ- 6
,
ææ6 7
ProductPriceBtc
øø 
=
øø& '
	Constants
øø( 1
.
øø1 2

EmptyValue
øø2 <
,
øø< =

ProductIva
¿¿ 
=
¿¿& '
item
¿¿( ,
.
¿¿, -
Tax
¿¿- 0
,
¿¿0 1
ProductQuantity
¡¡ 
=
¡¡& '
product
¡¡( /
.
¡¡/ 0
Count
¡¡0 5
,
¡¡5 6#
ProductCommissionable
¬¬ %
=
¬¬& '
item
¬¬( ,
.
¬¬, -!
CommissionableValue
¬¬- @
,
¬¬@ A
BinaryPoints
√√ 
=
√√& '
item
√√( ,
.
√√, -
BinaryPoints
√√- 9
,
√√9 :
ProductPoints
ƒƒ 
=
ƒƒ& '
item
ƒƒ( ,
.
ƒƒ, -
ValuePoints
ƒƒ- 8
,
ƒƒ8 9
ProductDiscount
≈≈ 
=
≈≈& '
item
≈≈( ,
.
≈≈, -
ProductDiscount
≈≈- <
,
≈≈< =
CombinationId
∆∆ 
=
∆∆& '
	Constants
∆∆( 1
.
∆∆1 2

EmptyValue
∆∆2 <
,
∆∆< =
ProductPack
«« 
=
««& '
item
««( ,
.
««, -
ProductPacks
««- 9
,
««9 :

BaseAmount
»» 
=
»»& '
(
»»( )
item
»») -
.
»»- .

BaseAmount
»». 8
*
»»9 :
product
»»; B
.
»»B C
Count
»»C H
)
»»H I
,
»»I J
DailyPercentage
…… 
=
……& '
item
……( ,
.
……, -
DailyPercentage
……- <
,
……< =
WaitingDays
   
=
  & '
item
  ( ,
.
  , -
DaysWait
  - 5
,
  5 6
DaysToPayQuantity
ÀÀ !
=
ÀÀ& '
	Constants
ÀÀ( 1
.
ÀÀ1 2
DaysToPayQuantity
ÀÀ2 C
,
ÀÀC D
ProductStart
ÃÃ 
=
ÃÃ& '
false
ÃÃ( -
,
ÃÃ- .
BrandId
ÕÕ 
=
ÕÕ& '
request
ÕÕ( /
.
ÕÕ/ 0
BrandId
ÕÕ0 7
}
ŒŒ 
;
ŒŒ 
invoiceDetails
–– 
.
–– 
Add
–– 
(
–– 
invoiceDetail
–– ,
)
––, -
;
––- .
}
—— 	
if
”” 

(
”” 
debit
”” 
==
”” 
	Constants
”” 
.
”” 

EmptyValue
”” )
)
””) *
return
‘‘ 
false
‘‘ 
;
‘‘ 
if
÷÷ 

(
÷÷ 
invoiceDetails
÷÷ 
.
÷÷ 
Count
÷÷  
==
÷÷! #
	Constants
÷÷$ -
.
÷÷- .

EmptyValue
÷÷. 8
)
÷÷8 9
return
◊◊ 
false
◊◊ 
;
◊◊ 
var
ŸŸ %
debitTransactionRequest
ŸŸ #
=
ŸŸ$ %
new
ŸŸ& )%
DebitTransactionRequest
ŸŸ* A
{
⁄⁄ 	
Debit
€€ 
=
€€ 
debit
€€  %
,
€€% &
AffiliateId
‹‹ 
=
‹‹ 
request
‹‹  '
.
‹‹' (
AffiliateId
‹‹( 3
,
‹‹3 4
UserId
›› 
=
›› 
	Constants
››  )
.
››) *
AdminUserId
››* 5
,
››5 6
ConceptType
ﬁﬁ 
=
ﬁﬁ 
WalletConceptType
ﬁﬁ  1
.
ﬁﬁ1 2
purchasing_pool
ﬁﬁ2 A
.
ﬁﬁA B
ToString
ﬁﬁB J
(
ﬁﬁJ K
)
ﬁﬁK L
,
ﬁﬁL M
Points
ﬂﬂ 
=
ﬂﬂ 
points
ﬂﬂ  &
,
ﬂﬂ& '
Concept
‡‡ 
=
‡‡ 
	Constants
‡‡  )
.
‡‡) *,
EcoPoolProductCategoryForAdmin
‡‡* H
,
‡‡H I
Commissionable
·· 
=
·· 
commissionable
··  .
,
··. /
Bank
‚‚ 
=
‚‚ 
request
‚‚  '
.
‚‚' (
Bank
‚‚( ,
,
‚‚, -
PaymentMethod
„„ 
=
„„ 
	Constants
„„  )
.
„„) *
AdminPayment
„„* 6
,
„„6 7
Origin
‰‰ 
=
‰‰ 
origin
‰‰  &
,
‰‰& '
Level
ÂÂ 
=
ÂÂ 
	Constants
ÂÂ  )
.
ÂÂ) *

EmptyValue
ÂÂ* 4
,
ÂÂ4 5
AffiliateUserName
ÊÊ 
=
ÊÊ 
request
ÊÊ  '
.
ÊÊ' (
AffiliateUserName
ÊÊ( 9
,
ÊÊ9 :
AdminUserName
ÁÁ 
=
ÁÁ 
request
ÁÁ  '
.
ÁÁ' (
BrandId
ÁÁ( /
==
ÁÁ0 2
$num
ÁÁ3 4
?
ÁÁ5 6
	Constants
ÁÁ7 @
.
ÁÁ@ A$
AdminEcosystemUserName
ÁÁA W
:
ÁÁX Y
	Constants
ÁÁZ c
.
ÁÁc d
RecycoinAdmin
ÁÁd q
,
ÁÁq r
ReceiptNumber
ËË 
=
ËË 
request
ËË  '
.
ËË' (
ReceiptNumber
ËË( 5
,
ËË5 6
Type
ÈÈ 
=
ÈÈ 
true
ÈÈ  $
,
ÈÈ$ %
	SecretKey
ÍÍ 
=
ÍÍ 
request
ÍÍ  '
.
ÍÍ' (
	SecretKey
ÍÍ( 1
,
ÍÍ1 2
invoices
ÎÎ 
=
ÎÎ 
invoiceDetails
ÎÎ  .
,
ÎÎ. /
Reason
ÏÏ 
=
ÏÏ 
string
ÏÏ  &
.
ÏÏ& '
Empty
ÏÏ' ,
,
ÏÏ- .
BrandId
ÌÌ 
=
ÌÌ 
request
ÌÌ  '
.
ÌÌ' (
BrandId
ÌÌ( /
,
ÌÌ/ 0
}
ÓÓ 	
;
ÓÓ	 

var
 

spResponse
 
=
 
await
 
_walletRepository
 0
.
0 1#
AdminDebitTransaction
1 F
(
F G%
debitTransactionRequest
G ^
)
^ _
;
_ `
if
ÚÚ 

(
ÚÚ 

spResponse
ÚÚ 
is
ÚÚ 
null
ÚÚ 
)
ÚÚ 
return
ÛÛ 
false
ÛÛ 
;
ÛÛ 
await
ıı 
RemoveCacheKey
ıı 
(
ıı 
request
ıı $
.
ıı$ %
AffiliateId
ıı% 0
,
ıı0 1
	CacheKeys
ıı2 ;
.
ıı; <&
BalanceInformationModel2
ıı< T
)
ııT U
;
ııU V
var
˜˜ 

invoicePdf
˜˜ 
=
˜˜ 
await
˜˜ "
_ecosystemPdfService
˜˜ 3
.
˜˜3 4
GenerateInvoice
˜˜4 C
(
˜˜C D
userInfoResponse
˜˜D T
!
˜˜T U
,
˜˜U V%
debitTransactionRequest
˜˜W n
,
˜˜n o

spResponse
˜˜p z
)
˜˜z {
;
˜˜{ |

Dictionary
˘˘ 
<
˘˘ 
string
˘˘ 
,
˘˘ 
byte
˘˘ 
[
˘˘  
]
˘˘  !
>
˘˘! "

allPdfData
˘˘# -
=
˘˘. /
new
˘˘0 3

Dictionary
˘˘4 >
<
˘˘> ?
string
˘˘? E
,
˘˘E F
byte
˘˘G K
[
˘˘K L
]
˘˘L M
>
˘˘M N
{
˙˙ 	
[
˚˚ 
$str
˚˚ 
]
˚˚ 
=
˚˚ 

invoicePdf
˚˚ (
}
¸¸ 	
;
¸¸	 

if
˛˛ 

(
˛˛ 

allPdfData
˛˛ 
.
˛˛ 
Count
˛˛ 
>
˛˛ 
	Constants
˛˛ (
.
˛˛( )

EmptyValue
˛˛) 3
)
˛˛3 4
{
ˇˇ 	
await
ÄÄ  
_brevoEmailService
ÄÄ $
.
ÄÄ$ %&
SendEmailPurchaseConfirm
ÄÄ% =
(
ÄÄ= >
userInfoResponse
ÄÄ> N
!
ÄÄN O
,
ÄÄO P

allPdfData
ÄÄQ [
,
ÄÄ[ \

spResponse
ÄÄ] g
,
ÄÄg h
request
ÄÄh o
.
ÄÄo p
BrandId
ÄÄp w
)
ÄÄw x
;
ÄÄx y
}
ÅÅ 	
return
ÉÉ 
true
ÉÉ 
;
ÉÉ 
}
ÑÑ 
public
ÜÜ 

async
ÜÜ 
Task
ÜÜ 
<
ÜÜ 
bool
ÜÜ 
>
ÜÜ &
ExecuteMembershipPayment
ÜÜ 4
(
ÜÜ4 5
WalletRequest
ÜÜ5 B
request
ÜÜC J
)
ÜÜJ K
{
áá 
var
àà 
debit
àà 
=
àà 
$num
àà 
;
àà  
var
ââ 
points
ââ 
=
ââ 
$num
ââ  
;
ââ  !
var
ää 
commissionable
ää 
=
ää 
$num
ää  
;
ää  !
byte
ãã 
origin
ãã 
=
ãã 
$num
ãã 
;
ãã  
var
çç 
invoiceDetails
çç 
=
çç! "
new
çç# &
List
çç' +
<
çç+ ,.
 InvoiceDetailsTransactionRequest
çç, L
>
ççL M
(
ççM N
)
ççN O
;
ççO P
var
éé 
userInfoResponse
éé 
=
éé! "
await
éé# ($
_accountServiceAdapter
éé) ?
.
éé? @
GetUserInfo
éé@ K
(
ééK L
request
ééL S
.
ééS T
AffiliateId
ééT _
,
éé_ `
request
éé` g
.
éég h
BrandId
ééh o
)
ééo p
;
éép q
var
èè 
balanceInfo
èè 
=
èè! "
await
èè# (0
"GetBalanceInformationByAffiliateId
èè) K
(
èèK L
request
èèL S
.
èèS T
AffiliateId
èèT _
,
èè_ `
request
èèa h
.
èèh i
BrandId
èèi p
)
èèp q
;
èèq r
var
êê "
affiliateBonusWinner
êê  
=
êê! "
await
êê# ($
_accountServiceAdapter
êê) ?
.
êê? @
GetUserInfo
êê@ K
(
êêK L
userInfoResponse
êêL \
!
êê\ ]
.
êê] ^
Father
êê^ d
,
êêd e
request
êêe l
.
êêl m
BrandId
êêm t
)
êêt u
;
êêu v
var
íí 
firstProductId
íí 
=
íí 
request
íí &
.
íí& '
ProductsList
íí' 3
.
íí3 4
First
íí4 9
(
íí9 :
)
íí: ;
.
íí; <
	IdProduct
íí< E
;
ííE F
var
ìì 
membershipResult
ìì 
=
ìì 
await
ìì $&
_inventoryServiceAdapter
ìì% =
.
ìì= >
GetProductById
ìì> L
(
ììL M
firstProductId
ììM [
,
ìì[ \
request
ìì\ c
.
ììc d
BrandId
ììd k
)
ììk l
;
ììl m
var
ïï 
productResponse
ïï 
=
ïï 
membershipResult
ïï .
.
ïï. /
Content
ïï/ 6
!
ïï6 7
.
ïï7 8
ToJsonObject
ïï8 D
<
ïïD E
ProductResponse
ïïE T
>
ïïT U
(
ïïU V
)
ïïV W
;
ïïW X
if
óó 

(
óó 
productResponse
óó 
?
óó 
.
óó 
Data
óó !
==
óó" $
null
óó% )
)
óó) *
return
òò 
false
òò 
;
òò 
var
öö 
item
öö 
=
öö 
productResponse
öö %
.
öö% &
Data
öö& *
;
öö* +
var
õõ 
product
õõ 
=
õõ 
request
õõ 
.
õõ 
ProductsList
õõ *
.
õõ* +
FirstOrDefault
õõ+ 9
(
õõ9 :
x
õõ: ;
=>
õõ< >
x
õõ? @
.
õõ@ A
	IdProduct
õõA J
==
õõK M
item
õõN R
.
õõR S
Id
õõS U
)
õõU V
;
õõV W
if
úú 

(
úú 
product
úú 
!=
úú 
null
úú 
)
úú 
{
ùù 	
var
ûû 
tax
ûû 
=
ûû 
item
ûû 
.
ûû 
Tax
ûû 
;
ûû 
debit
üü 
+=
üü 
(
üü 
int
üü "
)
üü" #
(
üü# $
(
üü$ %
item
üü% )
.
üü) *
	SalePrice
üü* 3
*
üü4 5
product
üü6 =
.
üü= >
Count
üü> C
)
üüC D
*
üüE F
(
üüG H
$num
üüH I
+
üüJ K
(
üüL M
tax
üüM P
/
üüQ R
$num
üüS V
)
üüV W
)
üüW X
)
üüX Y
;
üüY Z
points
†† 
+=
†† 
item
†† "
.
††" #
BinaryPoints
††# /
*
††0 1
product
††2 9
.
††9 :
Count
††: ?
;
††? @
commissionable
°° 
+=
°° 
item
°° "
.
°°" #!
CommissionableValue
°°# 6
*
°°7 8
product
°°9 @
.
°°@ A
Count
°°A F
;
°°F G
if
¢¢ 
(
¢¢ 
item
¢¢ 
.
¢¢ 

CategoryId
¢¢ 
==
¢¢  "
$num
¢¢# $
)
¢¢$ %
{
££ 
origin
§§ 
=
§§ 
$num
§§ 
;
§§ 
}
•• 
var
ßß 
invoiceDetail
ßß 
=
ßß 
new
ßß  #.
 InvoiceDetailsTransactionRequest
ßß$ D
{
®® 
	ProductId
©© 
=
©©& '
item
©©( ,
.
©©, -
Id
©©- /
,
©©/ 0
PaymentGroupId
™™ 
=
™™& '
item
™™( ,
.
™™, -
PaymentGroup
™™- 9
,
™™9 :
AccumMinPurchase
´´  
=
´´& '
item
´´( ,
.
´´, -
AcumCompMin
´´- 8
,
´´8 9
ProductName
¨¨ 
=
¨¨& '
item
¨¨( ,
.
¨¨, -
Name
¨¨- 1
!
¨¨1 2
,
¨¨2 3
ProductPrice
≠≠ 
=
≠≠& '
item
≠≠( ,
.
≠≠, -
	SalePrice
≠≠- 6
,
≠≠6 7
ProductPriceBtc
ÆÆ 
=
ÆÆ& '
	Constants
ÆÆ( 1
.
ÆÆ1 2

EmptyValue
ÆÆ2 <
,
ÆÆ< =

ProductIva
ØØ 
=
ØØ& '
item
ØØ( ,
.
ØØ, -
Tax
ØØ- 0
,
ØØ0 1
ProductQuantity
∞∞ 
=
∞∞& '
product
∞∞( /
.
∞∞/ 0
Count
∞∞0 5
,
∞∞5 6#
ProductCommissionable
±± %
=
±±& '
item
±±( ,
.
±±, -!
CommissionableValue
±±- @
,
±±@ A
BinaryPoints
≤≤ 
=
≤≤& '
item
≤≤( ,
.
≤≤, -
BinaryPoints
≤≤- 9
,
≤≤9 :
ProductPoints
≥≥ 
=
≥≥& '
item
≥≥( ,
.
≥≥, -
ValuePoints
≥≥- 8
,
≥≥8 9
ProductDiscount
¥¥ 
=
¥¥& '
	Constants
¥¥( 1
.
¥¥1 2

EmptyValue
¥¥2 <
,
¥¥< =
CombinationId
µµ 
=
µµ& '
	Constants
µµ( 1
.
µµ1 2

EmptyValue
µµ2 <
,
µµ< =
ProductPack
∂∂ 
=
∂∂& '
item
∂∂( ,
.
∂∂, -
ProductPacks
∂∂- 9
,
∂∂9 :

BaseAmount
∑∑ 
=
∑∑& '
item
∑∑( ,
.
∑∑, -

BaseAmount
∑∑- 7
,
∑∑7 8
DailyPercentage
∏∏ 
=
∏∏& '
item
∏∏( ,
.
∏∏, -
DailyPercentage
∏∏- <
,
∏∏< =
WaitingDays
ππ 
=
ππ& '
item
ππ( ,
.
ππ, -
DaysWait
ππ- 5
,
ππ5 6
DaysToPayQuantity
∫∫ !
=
∫∫& '
	Constants
∫∫( 1
.
∫∫1 2

EmptyValue
∫∫2 <
,
∫∫< =
ProductStart
ªª 
=
ªª& '
false
ªª( -
,
ªª- .
BrandId
ºº 
=
ºº& '
request
ºº( /
.
ºº/ 0
BrandId
ºº0 7
}
ΩΩ 
;
ΩΩ 
invoiceDetails
øø 
.
øø 
Add
øø 
(
øø 
invoiceDetail
øø ,
)
øø, -
;
øø- .
}
¿¿ 	
if
¬¬ 

(
¬¬ 
debit
¬¬ 
>
¬¬ 
balanceInfo
¬¬ 
.
¬¬  
AvailableBalance
¬¬  0
.
¬¬0 1
GetValueOrDefault
¬¬1 B
(
¬¬B C
)
¬¬C D
)
¬¬D E
return
√√ 
false
√√ 
;
√√ 
if
≈≈ 

(
≈≈ 
debit
≈≈ 
==
≈≈ 
	Constants
≈≈ 
.
≈≈ 

EmptyValue
≈≈ )
)
≈≈) *
return
∆∆ 
false
∆∆ 
;
∆∆ 
if
»» 

(
»» 
invoiceDetails
»» 
.
»» 
Count
»»  
==
»»! #
	Constants
»»$ -
.
»»- .

EmptyValue
»». 8
)
»»8 9
return
…… 
false
…… 
;
…… 
var
ÀÀ %
debitTransactionRequest
ÀÀ #
=
ÀÀ$ %
new
ÀÀ& )%
DebitTransactionRequest
ÀÀ* A
{
ÃÃ 	
Debit
ÕÕ 
=
ÕÕ 
debit
ÕÕ  %
,
ÕÕ% &
AffiliateId
ŒŒ 
=
ŒŒ 
request
ŒŒ  '
.
ŒŒ' (
AffiliateId
ŒŒ( 3
,
ŒŒ3 4
UserId
œœ 
=
œœ 
	Constants
œœ  )
.
œœ) *
AdminUserId
œœ* 5
,
œœ5 6
ConceptType
–– 
=
–– 
WalletConceptType
––  1
.
––1 2
purchasing_pool
––2 A
.
––A B
ToString
––B J
(
––J K
)
––K L
,
––L M
Points
—— 
=
—— 
points
——  &
,
——& '
Concept
““ 
=
““ 
	Constants
““  )
.
““) *

Membership
““* 4
,
““4 5
Commissionable
”” 
=
”” 
commissionable
””  .
,
””. /
Bank
‘‘ 
=
‘‘ 
request
‘‘  '
.
‘‘' (
Bank
‘‘( ,
,
‘‘, -
PaymentMethod
’’ 
=
’’ 
	Constants
’’  )
.
’’) *
WalletBalance
’’* 7
,
’’7 8
Origin
÷÷ 
=
÷÷ 
origin
÷÷  &
,
÷÷& '
Level
◊◊ 
=
◊◊ 
	Constants
◊◊  )
.
◊◊) *

EmptyValue
◊◊* 4
,
◊◊4 5
AffiliateUserName
ÿÿ 
=
ÿÿ 
request
ÿÿ  '
.
ÿÿ' (
AffiliateUserName
ÿÿ( 9
,
ÿÿ9 :
AdminUserName
ŸŸ 
=
ŸŸ 
request
ŸŸ  '
.
ŸŸ' (
BrandId
ŸŸ( /
==
ŸŸ0 2
$num
ŸŸ3 4
?
ŸŸ5 6
	Constants
ŸŸ7 @
.
ŸŸ@ A$
AdminEcosystemUserName
ŸŸA W
:
ŸŸX Y
	Constants
ŸŸZ c
.
ŸŸc d
RecycoinAdmin
ŸŸd q
,
ŸŸq r
ReceiptNumber
⁄⁄ 
=
⁄⁄ 
request
⁄⁄  '
.
⁄⁄' (
ReceiptNumber
⁄⁄( 5
,
⁄⁄5 6
Type
€€ 
=
€€ 
true
€€  $
,
€€$ %
	SecretKey
‹‹ 
=
‹‹ 
request
‹‹  '
.
‹‹' (
	SecretKey
‹‹( 1
,
‹‹1 2
invoices
›› 
=
›› 
invoiceDetails
››  .
,
››. /
Reason
ﬁﬁ 
=
ﬁﬁ 
string
ﬁﬁ  &
.
ﬁﬁ& '
Empty
ﬁﬁ' ,
,
ﬁﬁ, -
BrandId
ﬂﬂ 
=
ﬂﬂ 
request
ﬂﬂ  '
.
ﬂﬂ' (
BrandId
ﬂﬂ( /
}
‡‡ 	
;
‡‡	 

var
‚‚ 

spResponse
‚‚ 
=
‚‚ 
await
‚‚ 
_walletRepository
‚‚ 0
.
‚‚0 1(
MembershipDebitTransaction
‚‚1 K
(
‚‚K L%
debitTransactionRequest
‚‚L c
)
‚‚c d
;
‚‚d e
if
‰‰ 

(
‰‰ 

spResponse
‰‰ 
is
‰‰ 
null
‰‰ 
)
‰‰ 
return
ÂÂ 
false
ÂÂ 
;
ÂÂ 
await
ÁÁ 
RemoveCacheKey
ÁÁ 
(
ÁÁ 
request
ÁÁ $
.
ÁÁ$ %
AffiliateId
ÁÁ% 0
,
ÁÁ0 1
	CacheKeys
ÁÁ2 ;
.
ÁÁ; <&
BalanceInformationModel2
ÁÁ< T
)
ÁÁT U
;
ÁÁU V
await
ÈÈ $
_accountServiceAdapter
ÈÈ $
.
ÈÈ$ %"
UpdateActivationDate
ÈÈ% 9
(
ÈÈ9 :
request
ÈÈ: A
.
ÈÈA B
AffiliateId
ÈÈB M
,
ÈÈM N
_brandService
ÈÈN [
.
ÈÈ[ \
BrandId
ÈÈ\ c
)
ÈÈc d
;
ÈÈd e
var
ÎÎ .
 creditTransactionForWinningBonus
ÎÎ ,
=
ÎÎ- .
new
ÎÎ/ 2&
CreditTransactionRequest
ÎÎ3 K
{
ÏÏ 	
AffiliateId
ÌÌ 
=
ÌÌ "
affiliateBonusWinner
ÌÌ  4
!
ÌÌ4 5
.
ÌÌ5 6
Id
ÌÌ6 8
,
ÌÌ8 9
UserId
ÓÓ 
=
ÓÓ 
	Constants
ÓÓ  )
.
ÓÓ) *
AdminUserId
ÓÓ* 5
,
ÓÓ5 6
Concept
ÔÔ 
=
ÔÔ 
	Constants
ÔÔ  )
.
ÔÔ) *"
CommissionMembership
ÔÔ* >
+
ÔÔ? @
$char
ÔÔA D
+
ÔÔE F
request
ÔÔG N
.
ÔÔN O
AffiliateUserName
ÔÔO `
,
ÔÔ` a
Credit
 
=
 
	Constants
  )
.
) *
MembershipBonus
* 9
,
9 :
AffiliateUserName
ÒÒ 
=
ÒÒ "
affiliateBonusWinner
ÒÒ  4
.
ÒÒ4 5
UserName
ÒÒ5 =
,
ÒÒ= >
ConceptType
ÚÚ 
=
ÚÚ 
WalletConceptType
ÚÚ  1
.
ÚÚ1 2
membership_bonus
ÚÚ2 B
.
ÚÚB C
ToString
ÚÚC K
(
ÚÚK L
)
ÚÚL M
,
ÚÚM N
AdminUserName
ÛÛ 
=
ÛÛ 
	Constants
ÛÛ  )
.
ÛÛ) *$
AdminEcosystemUserName
ÛÛ* @
}
ÙÙ 	
;
ÙÙ	 

var
ˆˆ  
bonusPaymentResult
ˆˆ 
=
ˆˆ  
await
ˆˆ! &(
PayMembershipBonusToFather
ˆˆ' A
(
ˆˆA B.
 creditTransactionForWinningBonus
ˆˆB b
)
ˆˆb c
;
ˆˆc d
if
¯¯ 

(
¯¯  
bonusPaymentResult
¯¯ 
is
¯¯ !
false
¯¯" '
)
¯¯' (
return
˘˘ 
false
˘˘ 
;
˘˘ 
await
˚˚ 
RemoveCacheKey
˚˚ 
(
˚˚ "
affiliateBonusWinner
˚˚ 1
.
˚˚1 2
Id
˚˚2 4
,
˚˚4 5
	CacheKeys
˚˚6 ?
.
˚˚? @&
BalanceInformationModel2
˚˚@ X
)
˚˚X Y
;
˚˚Y Z
await
˝˝  
_brevoEmailService
˝˝  
.
˝˝  !#
SendBonusConfirmation
˝˝! 6
(
˝˝6 7"
affiliateBonusWinner
˝˝7 K
,
˝˝K L
request
˝˝M T
.
˝˝T U
AffiliateUserName
˝˝U f
,
˝˝f g
request
˝˝g n
.
˝˝n o
BrandId
˝˝o v
)
˝˝v w
;
˝˝w x
var
˛˛ 
	pdfResult
˛˛ 
=
˛˛ 
await
˛˛ "
_ecosystemPdfService
˛˛ 2
.
˛˛2 3
GenerateInvoice
˛˛3 B
(
˛˛B C
userInfoResponse
˛˛C S
,
˛˛S T%
debitTransactionRequest
˛˛U l
,
˛˛l m

spResponse
˛˛n x
)
˛˛x y
;
˛˛y z
await
ˇˇ  
_brevoEmailService
ˇˇ  
.
ˇˇ  !
SendEmailWelcome
ˇˇ! 1
(
ˇˇ1 2
userInfoResponse
ˇˇ2 B
,
ˇˇB C

spResponse
ˇˇD N
,
ˇˇN O
request
ˇˇO V
.
ˇˇV W
BrandId
ˇˇW ^
)
ˇˇ^ _
;
ˇˇ_ `
if
ÅÅ 

(
ÅÅ 
	pdfResult
ÅÅ 
.
ÅÅ 
Length
ÅÅ 
!=
ÅÅ 
	Constants
ÅÅ  )
.
ÅÅ) *

EmptyValue
ÅÅ* 4
)
ÅÅ4 5
{
ÇÇ 	
await
ÉÉ  
_brevoEmailService
ÉÉ $
.
ÉÉ$ %(
SendEmailMembershipConfirm
ÉÉ% ?
(
ÉÉ? @
userInfoResponse
ÉÉ@ P
,
ÉÉP Q
	pdfResult
ÉÉR [
,
ÉÉ[ \

spResponse
ÉÉ] g
,
ÉÉg h
request
ÉÉh o
.
ÉÉo p
BrandId
ÉÉp w
)
ÉÉw x
;
ÉÉx y
}
ÑÑ 	
return
ÜÜ 
true
ÜÜ 
;
ÜÜ 
}
áá 
private
àà 
async
àà 
Task
àà 
RemoveCacheKey
àà %
(
àà% &
int
àà& )
affiliateId
àà* 5
,
àà5 6
string
àà7 =
	stringKey
àà> G
)
ààG H
{
ââ 
var
ää 
key
ää 
=
ää 
string
ää 
.
ää 
Format
ää $
(
ää$ %
	stringKey
ää% .
,
ää. /
affiliateId
ää0 ;
)
ää; <
;
ää< =
var
ãã 
	existsKey
ãã 
=
ãã 
await
ãã 
_redisCache
ãã )
.
ãã) *
	KeyExists
ãã* 3
(
ãã3 4
key
ãã4 7
)
ãã7 8
;
ãã8 9
if
çç 

(
çç 
	existsKey
çç 
)
çç 
await
éé 
_redisCache
éé 
.
éé 
Delete
éé $
(
éé$ %
key
éé% (
)
éé( )
;
éé) *
}
èè 
}êê «Ä
aC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\BalancePaymentStrategyModel1A.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
;. /
public 
class $
BalancePaymentStrategy1A %
:& '*
IBalancePaymentStrategyModel1A( F
{ 
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter, B
;B C
private 
readonly $
IWalletModel1ARepository -$
_walletModel1ARepository. F
;F G
private 
readonly  
IEcosystemPdfService ) 
_ecosystemPdfService* >
;> ?
private 
readonly 
IBrevoEmailService '
_brevoEmailService( :
;: ;
private 
readonly 
IBrandService "
_brandService# 0
;0 1
public 
$
BalancePaymentStrategy1A #
(# $$
IInventoryServiceAdapter$ <#
inventoryServiceAdapter= T
,T U"
IAccountServiceAdapter !
accountServiceAdapter 4
,4 5$
IWalletModel1ARepository6 N#
walletModel1ARepositoryO f
,f g 
IEcosystemPdfService 
ecosystemPdfService 0
,0 1
IBrevoEmailService 
brevoEmailService ,
,, -
IBrandService- :
brandService; G
)G H
{ $
_inventoryServiceAdapter  
=! "#
inventoryServiceAdapter# :
;: ;"
_accountServiceAdapter 
=  !
accountServiceAdapter! 6
;6 7$
_walletModel1ARepository  
=! "#
walletModel1ARepository# :
;: ;
_brevoEmailService   
=   
brevoEmailService   .
;  . / 
_ecosystemPdfService!! 
=!! 
ecosystemPdfService!! 2
;!!2 3
_brandService"" 
="" 
brandService"" $
;""$ %
}## 
private%% 
async%% 
Task%% 
<%% (
BalanceInformationModel1ADto%% 3
>%%3 4.
"GetBalanceInformationByAffiliateId%%5 W
(%%W X
int%%X [
affiliateId%%\ g
)%%g h
{&& 
var'' 
availableBalance'' 
='' 
await'' $$
_walletModel1ARepository''% =
.''= >,
 GetAvailableBalanceByAffiliateId''> ^
(''^ _
affiliateId''_ j
)''j k
;''k l
var(( 
reverseBalance(( 
=(( 
await(( "$
_walletModel1ARepository((# ;
.((; <*
GetReverseBalanceByAffiliateId((< Z
(((Z [
affiliateId(([ f
)((f g
;((g h
var)) 
totalAcquisitions)) 
=)) 
await))  %$
_walletModel1ARepository))& >
.))> ?-
!GetTotalAcquisitionsByAffiliateId))? `
())` a
affiliateId))a l
)))l m
;))m n
var** 
serviceBalance** 
=** 
await** "$
_walletModel1ARepository**# ;
.**; <"
GetTotalServiceBalance**< R
(**R S
affiliateId**S ^
)**^ _
;**_ `
var,, 
response,, 
=,, 
new,, (
BalanceInformationModel1ADto,, 7
(,,7 8
),,8 9
{-- 	
AvailableBalance.. 
=.. 
availableBalance.. /
,../ 0
ReverseBalance// 
=// 
reverseBalance// +
??//, .
$num/// 0
,//0 1
TotalAcquisitions00 
=00 
totalAcquisitions00  1
??002 4
$num005 6
,006 7
ServiceBalance11 
=11 
serviceBalance11 +
??11, .
$num11/ 0
}22 	
;22	 

if44 

(44 
response44 
.44 
ReverseBalance44 #
==44$ &
$num44' )
)44) *
return44+ 1
response442 :
;44: ;
response66 
.66 
AvailableBalance66 !
-=66" $
response66% -
.66- .
ReverseBalance66. <
;66< =
return88 
response88 
;88 
}99 
public;; 

async;; 
Task;; 
<;; 
bool;; 
>;; !
ExecuteEcoPoolPayment;; 1
(;;1 2
WalletRequest;;2 ?
request;;@ G
);;G H
{<< 
var== 
debit== 
=== 
$num== 
;== 
var>> 
points>> 
=>> 
$num>> 
;>> 
var?? 
commissionable?? 
=?? 
$num?? 
;??  
byte@@ 
origin@@ 
=@@ 
$num@@ 
;@@ 
varBB 
invoiceDetailsBB 
=BB 
newBB  
ListBB! %
<BB% &,
 InvoiceDetailsTransactionRequestBB& F
>BBF G
(BBG H
)BBH I
;BBI J
varCC 
userInfoResponseCC 
=CC 
awaitCC $"
_accountServiceAdapterCC% ;
.CC; <
GetUserInfoCC< G
(CCG H
requestCCH O
.CCO P
AffiliateIdCCP [
,CC[ \
_brandServiceCC\ i
.CCi j
BrandIdCCj q
)CCq r
;CCr s
varDD 
balanceInfoDD 
=DD 
awaitDD .
"GetBalanceInformationByAffiliateIdDD  B
(DDB C
requestDDC J
.DDJ K
AffiliateIdDDK V
)DDV W
;DDW X
varEE 

productIdsEE 
=EE 
requestEE  
.EE  !
ProductsListEE! -
.EE- .
SelectEE. 4
(EE4 5
pEE5 6
=>EE7 9
pEE: ;
.EE; <
	IdProductEE< E
)EEE F
.EEF G
ToArrayEEG N
(EEN O
)EEO P
;EEP Q
varFF 
responseListFF 
=FF 
awaitFF  $
_inventoryServiceAdapterFF! 9
.FF9 :
GetProductsIdsFF: H
(FFH I

productIdsFFI S
,FFS T
_brandServiceFFT a
.FFa b
BrandIdFFb i
)FFi j
;FFj k
ifHH 

(HH 
!HH 
responseListHH 
.HH 
IsSuccessfulHH &
)HH& '
returnII 
falseII 
;II 
ifKK 

(KK 
stringKK 
.KK 
IsNullOrEmptyKK  
(KK  !
responseListKK! -
.KK- .
ContentKK. 5
)KK5 6
)KK6 7
returnLL 
falseLL 
;LL 
varNN 
resultNN 
=NN 
responseListNN !
.NN! "
ContentNN" )
.NN) *
ToJsonObjectNN* 6
<NN6 7
ProductsResponseNN7 G
>NNG H
(NNH I
)NNI J
;NNJ K
ifPP 

(PP 
resultPP 
?PP 
.PP 
DataPP 
==PP 
nullPP  
)PP  !
returnQQ 
falseQQ 
;QQ 
ifSS 

(SS 
resultSS 
.SS 
DataSS 
.SS 
CountSS 
!=SS  
requestSS! (
.SS( )
ProductsListSS) 5
.SS5 6
CountSS6 ;
)SS; <
returnTT 
falseTT 
;TT 
varVV 
productNamesVV 
=VV 
resultVV !
.VV! "
DataVV" &
.VV& '
SelectVV' -
(VV- .
itemVV. 2
=>VV3 5
itemVV6 :
.VV: ;
NameVV; ?
)VV? @
.VV@ A
ToArrayVVA H
(VVH I
)VVI J
;VVJ K
foreachXX 
(XX 
varXX 
itemXX 
inXX 
resultXX #
.XX# $
DataXX$ (
)XX( )
{YY 	
varZZ 
productZZ 
=ZZ 
requestZZ !
.ZZ! "
ProductsListZZ" .
.ZZ. /
FirstOrDefaultZZ/ =
(ZZ= >
xZZ> ?
=>ZZ@ B
xZZC D
.ZZD E
	IdProductZZE N
==ZZO Q
itemZZR V
.ZZV W
IdZZW Y
)ZZY Z
;ZZZ [
var[[ 
tax[[ 
=[[ 
item[[ 
.[[ 
Tax[[ 
;[[ 
debit\\ 
+=\\ 
(\\ 
int\\ 
)\\ 
(\\ 
(\\ 
item\\  
.\\  !
	SalePrice\\! *
*\\+ ,
product\\- 4
!\\4 5
.\\5 6
Count\\6 ;
)\\; <
*\\= >
(\\? @
$num\\@ A
+\\B C
(\\D E
tax\\E H
/\\I J
$num\\K N
)\\N O
)\\O P
)\\P Q
;\\Q R
points]] 
+=]] 
item]] 
.]] 
BinaryPoints]] '
*]]( )
product]]* 1
.]]1 2
Count]]2 7
;]]7 8
commissionable^^ 
+=^^ 
item^^ "
.^^" #
CommissionableValue^^# 6
*^^7 8
product^^9 @
.^^@ A
Count^^A F
;^^F G
if__ 
(__ 
item__ 
.__ 

CategoryId__ 
==__  "
$num__# $
)__$ %
{`` 
originaa 
=aa 
$numaa 
;aa 
}bb 
vardd 
invoiceDetaildd 
=dd 
newdd  #,
 InvoiceDetailsTransactionRequestdd$ D
{ee 
	ProductIdff 
=ff 
itemff  
.ff  !
Idff! #
,ff# $
PaymentGroupIdgg 
=gg  
itemgg! %
.gg% &
PaymentGroupgg& 2
,gg2 3
AccumMinPurchasehh  
=hh! "
itemhh# '
.hh' (
AcumCompMinhh( 3
,hh3 4
ProductNameii 
=ii 
itemii "
.ii" #
Nameii# '
!ii' (
,ii( )
ProductPricejj 
=jj 
itemjj #
.jj# $
	SalePricejj$ -
,jj- .
ProductPriceBtckk 
=kk  !
	Constantskk" +
.kk+ ,

EmptyValuekk, 6
,kk6 7

ProductIvall 
=ll 
itemll !
.ll! "
Taxll" %
,ll% &
ProductQuantitymm 
=mm  !
productmm" )
.mm) *
Countmm* /
,mm/ 0!
ProductCommissionablenn %
=nn& '
itemnn( ,
.nn, -
CommissionableValuenn- @
,nn@ A
BinaryPointsoo 
=oo 
itemoo #
.oo# $
BinaryPointsoo$ 0
,oo0 1
ProductPointspp 
=pp 
itempp  $
.pp$ %
ValuePointspp% 0
,pp0 1
ProductDiscountqq 
=qq  !
itemqq" &
.qq& '
ProductDiscountqq' 6
,qq6 7
CombinationIdrr 
=rr 
	Constantsrr  )
.rr) *

EmptyValuerr* 4
,rr4 5
ProductPackss 
=ss 
itemss "
.ss" #
ProductPacksss# /
,ss/ 0

BaseAmounttt 
=tt 
(tt 
itemtt "
.tt" #

BaseAmounttt# -
*tt. /
producttt0 7
.tt7 8
Counttt8 =
)tt= >
,tt> ?
DailyPercentageuu 
=uu  !
itemuu" &
.uu& '
DailyPercentageuu' 6
,uu6 7
WaitingDaysvv 
=vv 
itemvv "
.vv" #
DaysWaitvv# +
,vv+ ,
DaysToPayQuantityww !
=ww" #
	Constantsww$ -
.ww- .
DaysToPayQuantityww. ?
,ww? @
ProductStartxx 
=xx 
falsexx $
,xx$ %
}yy 
;yy 
invoiceDetails{{ 
.{{ 
Add{{ 
({{ 
invoiceDetail{{ ,
){{, -
;{{- .
}|| 	
if~~ 

(~~ 
debit~~ 
==~~ 
	Constants~~ 
.~~ 

EmptyValue~~ )
)~~) *
return 
false 
; 
if
ÅÅ 

(
ÅÅ 
invoiceDetails
ÅÅ 
.
ÅÅ 
Count
ÅÅ  
==
ÅÅ! #
	Constants
ÅÅ$ -
.
ÅÅ- .

EmptyValue
ÅÅ. 8
)
ÅÅ8 9
return
ÇÇ 
false
ÇÇ 
;
ÇÇ 
if
ÑÑ 

(
ÑÑ 
debit
ÑÑ 
>
ÑÑ 
balanceInfo
ÑÑ 
.
ÑÑ  
ReverseBalance
ÑÑ  .
.
ÑÑ. /
GetValueOrDefault
ÑÑ/ @
(
ÑÑ@ A
)
ÑÑA B
)
ÑÑB C
return
ÖÖ 
false
ÖÖ 
;
ÖÖ 
var
áá %
debitTransactionRequest
áá #
=
áá$ %
new
áá& )%
DebitTransactionRequest
áá* A
{
àà 	
Debit
ââ 
=
ââ 
debit
ââ 
,
ââ 
AffiliateId
ää 
=
ää 
request
ää !
.
ää! "
AffiliateId
ää" -
,
ää- .
UserId
ãã 
=
ãã 
	Constants
ãã 
.
ãã 
AdminUserId
ãã *
,
ãã* +
ConceptType
åå 
=
åå 
WalletConceptType
åå +
.
åå+ ,+
purchase_with_reverse_balance
åå, I
.
ååI J
ToString
ååJ R
(
ååR S
)
ååS T
,
ååT U
Points
çç 
=
çç 
points
çç 
,
çç 
Concept
éé 
=
éé 
	Constants
éé 
.
éé  $
EcoPoolProductCategory
éé  6
,
éé6 7
Commissionable
èè 
=
èè 
commissionable
èè +
,
èè+ ,
Bank
êê 
=
êê 
request
êê 
.
êê 
Bank
êê 
,
êê  
PaymentMethod
ëë 
=
ëë 
	Constants
ëë %
.
ëë% &"
WalletModel1ABalance
ëë& :
,
ëë: ;
Origin
íí 
=
íí 
origin
íí 
,
íí 
Level
ìì 
=
ìì 
	Constants
ìì 
.
ìì 

EmptyValue
ìì (
,
ìì( )
AffiliateUserName
îî 
=
îî 
request
îî  '
.
îî' (
AffiliateUserName
îî( 9
,
îî9 :
AdminUserName
ïï 
=
ïï 
	Constants
ïï %
.
ïï% &$
AdminEcosystemUserName
ïï& <
,
ïï< =
ReceiptNumber
ññ 
=
ññ 
request
ññ #
.
ññ# $
ReceiptNumber
ññ$ 1
,
ññ1 2
Type
óó 
=
óó 
true
óó 
,
óó 
	SecretKey
òò 
=
òò 
request
òò 
.
òò  
	SecretKey
òò  )
,
òò) *
invoices
ôô 
=
ôô 
invoiceDetails
ôô %
,
ôô% &
Reason
öö 
=
öö 
string
öö  &
.
öö& '
Empty
öö' ,
}
õõ 	
;
õõ	 

var
ùù 

spResponse
ùù 
=
ùù 
await
ùù &
_walletModel1ARepository
ùù 7
.
ùù7 8
DebitTransaction
ùù8 H
(
ùùH I%
debitTransactionRequest
ùùI `
)
ùù` a
;
ùùa b
if
üü 

(
üü 

spResponse
üü 
is
üü 
null
üü 
)
üü 
return
†† 
false
†† 
;
†† 
var
¢¢ 

invoicePdf
¢¢ 
=
¢¢ 
await
££ "
_ecosystemPdfService
££ &
.
££& '
GenerateInvoice
££' 6
(
££6 7
userInfoResponse
££7 G
!
££G H
,
££H I%
debitTransactionRequest
££J a
,
££a b

spResponse
££c m
)
££m n
;
££n o
var
•• !
productPdfsContents
•• 
=
••  !
await
••" '
CommonExtensions
••( 8
.
••8 9+
GetPdfContentFromProductNames
••9 V
(
••V W
productNames
••W c
!
••c d
)
••d e
;
••e f

Dictionary
ßß 
<
ßß 
string
ßß 
,
ßß 
byte
ßß 
[
ßß  
]
ßß  !
>
ßß! "

allPdfData
ßß# -
=
ßß. /
new
ßß0 3

Dictionary
ßß4 >
<
ßß> ?
string
ßß? E
,
ßßE F
byte
ßßG K
[
ßßK L
]
ßßL M
>
ßßM N
{
®® 	
[
©© 
$str
©© 
]
©© 
=
©© 

invoicePdf
©© (
}
™™ 	
;
™™	 

foreach
¨¨ 
(
¨¨ 
var
¨¨ 
pdfDataEntry
¨¨ !
in
¨¨" $!
productPdfsContents
¨¨% 8
)
¨¨8 9
{
≠≠ 	

allPdfData
ÆÆ 
[
ÆÆ 
pdfDataEntry
ÆÆ #
.
ÆÆ# $
Key
ÆÆ$ '
]
ÆÆ' (
=
ÆÆ) *
pdfDataEntry
ÆÆ+ 7
.
ÆÆ7 8
Value
ÆÆ8 =
;
ÆÆ= >
}
ØØ 	
if
±± 

(
±± 

allPdfData
±± 
.
±± 
Count
±± 
>
±± 
	Constants
±± (
.
±±( )

EmptyValue
±±) 3
)
±±3 4
{
≤≤ 	
await
≥≥  
_brevoEmailService
≥≥ $
.
≥≥$ %&
SendEmailPurchaseConfirm
≥≥% =
(
≥≥= >
userInfoResponse
≥≥> N
!
≥≥N O
,
≥≥O P

allPdfData
≥≥Q [
,
≥≥[ \

spResponse
≥≥] g
,
≥≥g h
request
≥≥h o
.
≥≥o p
BrandId
≥≥p w
)
≥≥w x
;
≥≥x y
}
¥¥ 	
return
∂∂ 
true
∂∂ 
;
∂∂ 
}
∑∑ 
public
ππ 

async
ππ 
Task
ππ 
<
ππ 
bool
ππ 
>
ππ 5
'ExecuteEcoPoolPaymentWithServiceBalance
ππ C
(
ππC D
WalletRequest
ππD Q
request
ππR Y
)
ππY Z
{
∫∫ 
var
ªª 
debit
ªª 
=
ªª 
$num
ªª 
;
ªª 
var
ºº 
points
ºº 
=
ºº 
$num
ºº 
;
ºº 
var
ΩΩ 
commissionable
ΩΩ 
=
ΩΩ 
$num
ΩΩ 
;
ΩΩ  
byte
ææ 
origin
ææ 
=
ææ 
$num
ææ 
;
ææ 
var
¿¿ 
invoiceDetails
¿¿ 
=
¿¿ 
new
¿¿  
List
¿¿! %
<
¿¿% &.
 InvoiceDetailsTransactionRequest
¿¿& F
>
¿¿F G
(
¿¿G H
)
¿¿H I
;
¿¿I J
var
¡¡ 
userInfoResponse
¡¡ 
=
¡¡ 
await
¡¡ $$
_accountServiceAdapter
¡¡% ;
.
¡¡; <
GetUserInfo
¡¡< G
(
¡¡G H
request
¡¡H O
.
¡¡O P
AffiliateId
¡¡P [
,
¡¡[ \
_brandService
¡¡\ i
.
¡¡i j
BrandId
¡¡j q
)
¡¡q r
;
¡¡r s
var
¬¬ 
balanceInfo
¬¬ 
=
¬¬ 
await
¬¬ 0
"GetBalanceInformationByAffiliateId
¬¬  B
(
¬¬B C
request
¬¬C J
.
¬¬J K
AffiliateId
¬¬K V
)
¬¬V W
;
¬¬W X
var
√√ 

productIds
√√ 
=
√√ 
request
√√  
.
√√  !
ProductsList
√√! -
.
√√- .
Select
√√. 4
(
√√4 5
p
√√5 6
=>
√√7 9
p
√√: ;
.
√√; <
	IdProduct
√√< E
)
√√E F
.
√√F G
ToArray
√√G N
(
√√N O
)
√√O P
;
√√P Q
var
ƒƒ 
responseList
ƒƒ 
=
ƒƒ 
await
ƒƒ  &
_inventoryServiceAdapter
ƒƒ! 9
.
ƒƒ9 :
GetProductsIds
ƒƒ: H
(
ƒƒH I

productIds
ƒƒI S
,
ƒƒS T
_brandService
ƒƒT a
.
ƒƒa b
BrandId
ƒƒb i
)
ƒƒi j
;
ƒƒj k
if
∆∆ 

(
∆∆ 
!
∆∆ 
responseList
∆∆ 
.
∆∆ 
IsSuccessful
∆∆ &
)
∆∆& '
return
«« 
false
«« 
;
«« 
if
…… 

(
…… 
string
…… 
.
…… 
IsNullOrEmpty
……  
(
……  !
responseList
……! -
.
……- .
Content
……. 5
)
……5 6
)
……6 7
return
   
false
   
;
   
var
ÃÃ 
result
ÃÃ 
=
ÃÃ 
responseList
ÃÃ !
.
ÃÃ! "
Content
ÃÃ" )
.
ÃÃ) *
ToJsonObject
ÃÃ* 6
<
ÃÃ6 7
ProductsResponse
ÃÃ7 G
>
ÃÃG H
(
ÃÃH I
)
ÃÃI J
;
ÃÃJ K
if
ŒŒ 

(
ŒŒ 
result
ŒŒ 
?
ŒŒ 
.
ŒŒ 
Data
ŒŒ 
==
ŒŒ 
null
ŒŒ  
)
ŒŒ  !
return
œœ 
false
œœ 
;
œœ 
if
—— 

(
—— 
result
—— 
.
—— 
Data
—— 
.
—— 
Count
—— 
!=
——  
request
——! (
.
——( )
ProductsList
——) 5
.
——5 6
Count
——6 ;
)
——; <
return
““ 
false
““ 
;
““ 
var
‘‘ 
productNames
‘‘ 
=
‘‘ 
result
‘‘ !
.
‘‘! "
Data
‘‘" &
.
‘‘& '
Select
‘‘' -
(
‘‘- .
item
‘‘. 2
=>
‘‘3 5
item
‘‘6 :
.
‘‘: ;
Name
‘‘; ?
)
‘‘? @
.
‘‘@ A
ToArray
‘‘A H
(
‘‘H I
)
‘‘I J
;
‘‘J K
foreach
÷÷ 
(
÷÷ 
var
÷÷ 
item
÷÷ 
in
÷÷ 
result
÷÷ #
.
÷÷# $
Data
÷÷$ (
)
÷÷( )
{
◊◊ 	
var
ÿÿ 
product
ÿÿ 
=
ÿÿ 
request
ÿÿ !
.
ÿÿ! "
ProductsList
ÿÿ" .
.
ÿÿ. /
FirstOrDefault
ÿÿ/ =
(
ÿÿ= >
x
ÿÿ> ?
=>
ÿÿ@ B
x
ÿÿC D
.
ÿÿD E
	IdProduct
ÿÿE N
==
ÿÿO Q
item
ÿÿR V
.
ÿÿV W
Id
ÿÿW Y
)
ÿÿY Z
;
ÿÿZ [
var
ŸŸ 
tax
ŸŸ 
=
ŸŸ 
item
ŸŸ 
.
ŸŸ 
Tax
ŸŸ 
;
ŸŸ 
debit
⁄⁄ 
+=
⁄⁄ 
(
⁄⁄ 
int
⁄⁄ 
)
⁄⁄ 
(
⁄⁄ 
(
⁄⁄ 
item
⁄⁄  
.
⁄⁄  !
	SalePrice
⁄⁄! *
*
⁄⁄+ ,
product
⁄⁄- 4
!
⁄⁄4 5
.
⁄⁄5 6
Count
⁄⁄6 ;
)
⁄⁄; <
*
⁄⁄= >
(
⁄⁄? @
$num
⁄⁄@ A
+
⁄⁄B C
(
⁄⁄D E
tax
⁄⁄E H
/
⁄⁄I J
$num
⁄⁄K N
)
⁄⁄N O
)
⁄⁄O P
)
⁄⁄P Q
;
⁄⁄Q R
points
€€ 
+=
€€ 
item
€€ 
.
€€ 
BinaryPoints
€€ '
*
€€( )
product
€€* 1
.
€€1 2
Count
€€2 7
;
€€7 8
commissionable
‹‹ 
+=
‹‹ 
item
‹‹ "
.
‹‹" #!
CommissionableValue
‹‹# 6
*
‹‹7 8
product
‹‹9 @
.
‹‹@ A
Count
‹‹A F
;
‹‹F G
if
›› 
(
›› 
item
›› 
.
›› 

CategoryId
›› 
==
››  "
$num
››# $
)
››$ %
{
ﬁﬁ 
origin
ﬂﬂ 
=
ﬂﬂ 
$num
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 
var
‚‚ 
invoiceDetail
‚‚ 
=
‚‚ 
new
‚‚  #.
 InvoiceDetailsTransactionRequest
‚‚$ D
{
„„ 
	ProductId
‰‰ 
=
‰‰ 
item
‰‰  
.
‰‰  !
Id
‰‰! #
,
‰‰# $
PaymentGroupId
ÂÂ 
=
ÂÂ  
item
ÂÂ! %
.
ÂÂ% &
PaymentGroup
ÂÂ& 2
,
ÂÂ2 3
AccumMinPurchase
ÊÊ  
=
ÊÊ! "
item
ÊÊ# '
.
ÊÊ' (
AcumCompMin
ÊÊ( 3
,
ÊÊ3 4
ProductName
ÁÁ 
=
ÁÁ 
item
ÁÁ "
.
ÁÁ" #
Name
ÁÁ# '
!
ÁÁ' (
,
ÁÁ( )
ProductPrice
ËË 
=
ËË 
item
ËË #
.
ËË# $
	SalePrice
ËË$ -
,
ËË- .
ProductPriceBtc
ÈÈ 
=
ÈÈ  !
	Constants
ÈÈ" +
.
ÈÈ+ ,

EmptyValue
ÈÈ, 6
,
ÈÈ6 7

ProductIva
ÍÍ 
=
ÍÍ 
item
ÍÍ !
.
ÍÍ! "
Tax
ÍÍ" %
,
ÍÍ% &
ProductQuantity
ÎÎ 
=
ÎÎ  !
product
ÎÎ" )
.
ÎÎ) *
Count
ÎÎ* /
,
ÎÎ/ 0#
ProductCommissionable
ÏÏ %
=
ÏÏ& '
item
ÏÏ( ,
.
ÏÏ, -!
CommissionableValue
ÏÏ- @
,
ÏÏ@ A
BinaryPoints
ÌÌ 
=
ÌÌ 
item
ÌÌ #
.
ÌÌ# $
BinaryPoints
ÌÌ$ 0
,
ÌÌ0 1
ProductPoints
ÓÓ 
=
ÓÓ 
item
ÓÓ  $
.
ÓÓ$ %
ValuePoints
ÓÓ% 0
,
ÓÓ0 1
ProductDiscount
ÔÔ 
=
ÔÔ  !
item
ÔÔ" &
.
ÔÔ& '
ProductDiscount
ÔÔ' 6
,
ÔÔ6 7
CombinationId
 
=
 
	Constants
  )
.
) *

EmptyValue
* 4
,
4 5
ProductPack
ÒÒ 
=
ÒÒ 
item
ÒÒ "
.
ÒÒ" #
ProductPacks
ÒÒ# /
,
ÒÒ/ 0

BaseAmount
ÚÚ 
=
ÚÚ 
(
ÚÚ 
item
ÚÚ "
.
ÚÚ" #

BaseAmount
ÚÚ# -
*
ÚÚ. /
product
ÚÚ0 7
.
ÚÚ7 8
Count
ÚÚ8 =
)
ÚÚ= >
,
ÚÚ> ?
DailyPercentage
ÛÛ 
=
ÛÛ  !
item
ÛÛ" &
.
ÛÛ& '
DailyPercentage
ÛÛ' 6
,
ÛÛ6 7
WaitingDays
ÙÙ 
=
ÙÙ 
item
ÙÙ "
.
ÙÙ" #
DaysWait
ÙÙ# +
,
ÙÙ+ ,
DaysToPayQuantity
ıı !
=
ıı" #
	Constants
ıı$ -
.
ıı- .
DaysToPayQuantity
ıı. ?
,
ıı? @
ProductStart
ˆˆ 
=
ˆˆ 
false
ˆˆ $
,
ˆˆ$ %
}
˜˜ 
;
˜˜ 
invoiceDetails
˘˘ 
.
˘˘ 
Add
˘˘ 
(
˘˘ 
invoiceDetail
˘˘ ,
)
˘˘, -
;
˘˘- .
}
˙˙ 	
if
¸¸ 

(
¸¸ 
debit
¸¸ 
==
¸¸ 
	Constants
¸¸ 
.
¸¸ 

EmptyValue
¸¸ )
)
¸¸) *
return
˝˝ 
false
˝˝ 
;
˝˝ 
if
ˇˇ 

(
ˇˇ 
invoiceDetails
ˇˇ 
.
ˇˇ 
Count
ˇˇ  
==
ˇˇ! #
	Constants
ˇˇ$ -
.
ˇˇ- .

EmptyValue
ˇˇ. 8
)
ˇˇ8 9
return
ÄÄ 
false
ÄÄ 
;
ÄÄ 
if
ÇÇ 

(
ÇÇ 
debit
ÇÇ 
>
ÇÇ 
balanceInfo
ÇÇ 
.
ÇÇ  
ServiceBalance
ÇÇ  .
.
ÇÇ. /
GetValueOrDefault
ÇÇ/ @
(
ÇÇ@ A
)
ÇÇA B
)
ÇÇB C
return
ÉÉ 
false
ÉÉ 
;
ÉÉ 
var
ÖÖ %
debitTransactionRequest
ÖÖ #
=
ÖÖ$ %
new
ÖÖ& )%
DebitTransactionRequest
ÖÖ* A
{
ÜÜ 	
Debit
áá 
=
áá 
debit
áá 
,
áá 
AffiliateId
àà 
=
àà 
request
àà !
.
àà! "
AffiliateId
àà" -
,
àà- .
UserId
ââ 
=
ââ 
	Constants
ââ 
.
ââ 
AdminUserId
ââ *
,
ââ* +
ConceptType
ää 
=
ää 
WalletConceptType
ää +
.
ää+ ,
purchasing_pool
ää, ;
.
ää; <
ToString
ää< D
(
ääD E
)
ääE F
,
ääF G
Points
ãã 
=
ãã 
points
ãã 
,
ãã 
Concept
åå 
=
åå 
	Constants
åå 
.
åå  $
EcoPoolProductCategory
åå  6
,
åå6 7
Commissionable
çç 
=
çç 
commissionable
çç +
,
çç+ ,
Bank
éé 
=
éé 
	Constants
éé 
.
éé #
ServiceBalanceModel1A
éé 2
,
éé2 3
PaymentMethod
èè 
=
èè 
	Constants
èè %
.
èè% &#
ServiceBalanceModel1A
èè& ;
,
èè; <
Origin
êê 
=
êê 
origin
êê 
,
êê 
Level
ëë 
=
ëë 
	Constants
ëë 
.
ëë 

EmptyValue
ëë (
,
ëë( )
AffiliateUserName
íí 
=
íí 
request
íí  '
.
íí' (
AffiliateUserName
íí( 9
,
íí9 :
AdminUserName
ìì 
=
ìì 
	Constants
ìì %
.
ìì% &$
AdminEcosystemUserName
ìì& <
,
ìì< =
ReceiptNumber
îî 
=
îî 
request
îî #
.
îî# $
ReceiptNumber
îî$ 1
,
îî1 2
Type
ïï 
=
ïï 
true
ïï 
,
ïï 
	SecretKey
ññ 
=
ññ 
request
ññ 
.
ññ  
	SecretKey
ññ  )
,
ññ) *
invoices
óó 
=
óó 
invoiceDetails
óó %
,
óó% &
Reason
òò 
=
òò 
string
òò 
.
òò 
Empty
òò #
}
ôô 	
;
ôô	 

var
õõ 

spResponse
õõ 
=
õõ 
await
õõ &
_walletModel1ARepository
õõ 7
.
õõ7 8,
DebitServiceBalanceTransaction
õõ8 V
(
õõV W%
debitTransactionRequest
õõW n
)
õõn o
;
õõo p
if
ùù 

(
ùù 

spResponse
ùù 
is
ùù 
null
ùù 
)
ùù 
return
ûû 
false
ûû 
;
ûû 
var
†† 

invoicePdf
†† 
=
†† 
await
°° "
_ecosystemPdfService
°° &
.
°°& '
GenerateInvoice
°°' 6
(
°°6 7
userInfoResponse
°°7 G
!
°°G H
,
°°H I%
debitTransactionRequest
°°J a
,
°°a b

spResponse
°°c m
)
°°m n
;
°°n o
var
££ !
productPdfsContents
££ 
=
££  !
await
££" '
CommonExtensions
££( 8
.
££8 9+
GetPdfContentFromProductNames
££9 V
(
££V W
productNames
££W c
!
££c d
)
££d e
;
££e f

Dictionary
•• 
<
•• 
string
•• 
,
•• 
byte
•• 
[
••  
]
••  !
>
••! "

allPdfData
••# -
=
••. /
new
••0 3

Dictionary
••4 >
<
••> ?
string
••? E
,
••E F
byte
••G K
[
••K L
]
••L M
>
••M N
{
¶¶ 	
[
ßß 
$str
ßß 
]
ßß 
=
ßß 

invoicePdf
ßß (
}
®® 	
;
®®	 

foreach
™™ 
(
™™ 
var
™™ 
pdfDataEntry
™™ !
in
™™" $!
productPdfsContents
™™% 8
)
™™8 9
{
´´ 	

allPdfData
¨¨ 
[
¨¨ 
pdfDataEntry
¨¨ #
.
¨¨# $
Key
¨¨$ '
]
¨¨' (
=
¨¨) *
pdfDataEntry
¨¨+ 7
.
¨¨7 8
Value
¨¨8 =
;
¨¨= >
}
≠≠ 	
if
ØØ 

(
ØØ 

allPdfData
ØØ 
.
ØØ 
Count
ØØ 
>
ØØ 
	Constants
ØØ (
.
ØØ( )

EmptyValue
ØØ) 3
)
ØØ3 4
{
∞∞ 	
await
±±  
_brevoEmailService
±± $
.
±±$ %&
SendEmailPurchaseConfirm
±±% =
(
±±= >
userInfoResponse
±±> N
!
±±N O
,
±±O P

allPdfData
±±Q [
,
±±[ \

spResponse
±±] g
,
±±g h
request
±±h o
.
±±o p
BrandId
±±p w
)
±±w x
;
±±x y
}
≤≤ 	
return
¥¥ 
true
¥¥ 
;
¥¥ 
}
µµ 
}∂∂ ïÄ
aC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\BalancePaymentStrategyModel1B.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
;. /
public 
class $
BalancePaymentStrategy1B %
:& '*
IBalancePaymentStrategyModel1B( F
{ 
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter, B
;B C
private 
readonly $
IWalletModel1BRepository -$
_walletModel1BRepository. F
;F G
private 
readonly  
IEcosystemPdfService ) 
_ecosystemPdfService* >
;> ?
private 
readonly 
IBrevoEmailService '
_brevoEmailService( :
;: ;
private 
readonly 
IBrandService "
_brandService# 0
;0 1
public 
$
BalancePaymentStrategy1B #
(# $$
IInventoryServiceAdapter$ <#
inventoryServiceAdapter= T
,T U"
IAccountServiceAdapter !
accountServiceAdapter 4
,4 5$
IWalletModel1BRepository6 N#
walletModel1BRepositoryO f
,f g 
IEcosystemPdfService 
ecosystemPdfService 0
,0 1
IBrevoEmailService 
brevoEmailService ,
,, -
IBrandService- :
brandService; G
)G H
{ $
_inventoryServiceAdapter  
=! "#
inventoryServiceAdapter# :
;: ;"
_accountServiceAdapter 
=  !
accountServiceAdapter! 6
;6 7$
_walletModel1BRepository  
=! "#
walletModel1BRepository# :
;: ;
_brevoEmailService 
= 
brevoEmailService .
;. / 
_ecosystemPdfService 
= 
ecosystemPdfService 2
;2 3
_brandService   
=   
brandService   $
;  $ %
}!! 
private## 
async## 
Task## 
<## (
BalanceInformationModel1BDto## 3
>##3 4.
"GetBalanceInformationByAffiliateId##5 W
(##W X
int##X [
affiliateId##\ g
)##g h
{$$ 
var%% 
availableBalance%% 
=%% 
await%% $$
_walletModel1BRepository%%% =
.%%= >,
 GetAvailableBalanceByAffiliateId%%> ^
(%%^ _
affiliateId%%_ j
)%%j k
;%%k l
var&& 
reverseBalance&& 
=&& 
await&& "$
_walletModel1BRepository&&# ;
.&&; <*
GetReverseBalanceByAffiliateId&&< Z
(&&Z [
affiliateId&&[ f
)&&f g
;&&g h
var'' 
totalAcquisitions'' 
='' 
await''  %$
_walletModel1BRepository''& >
.''> ?-
!GetTotalAcquisitionsByAffiliateId''? `
(''` a
affiliateId''a l
)''l m
;''m n
var(( 
serviceBalance(( 
=(( 
await(( "$
_walletModel1BRepository((# ;
.((; <"
GetTotalServiceBalance((< R
(((R S
affiliateId((S ^
)((^ _
;((_ `
var** 
response** 
=** 
new** (
BalanceInformationModel1BDto** 7
{++ 	
AvailableBalance,, 
=,, 
availableBalance,, /
,,,/ 0
ReverseBalance-- 
=-- 
reverseBalance-- +
??--, .
$num--/ 0
,--0 1
TotalAcquisitions.. 
=.. 
totalAcquisitions..  1
??..2 4
$num..5 6
,..6 7
ServiceBalance// 
=// 
serviceBalance// +
??//, .
$num/// 0
}00 	
;00	 

if22 

(22 
response22 
.22 
ReverseBalance22 #
==22$ &
$num22' )
)22) *
return22+ 1
response222 :
;22: ;
response44 
.44 
AvailableBalance44 !
-=44" $
response44% -
.44- .
ReverseBalance44. <
;44< =
return66 
response66 
;66 
}77 
public99 

async99 
Task99 
<99 
bool99 
>99 !
ExecuteEcoPoolPayment99 1
(991 2
WalletRequest992 ?
request99@ G
)99G H
{:: 
var;; 
debit;; 
=;; 
$num;; 
;;; 
var<< 
points<< 
=<< 
$num<< 
;<< 
var== 
commissionable== 
=== 
$num== 
;==  
byte>> 
origin>> 
=>> 
$num>> 
;>> 
var@@ 
invoiceDetails@@ 
=@@ 
new@@  
List@@! %
<@@% &,
 InvoiceDetailsTransactionRequest@@& F
>@@F G
(@@G H
)@@H I
;@@I J
varAA 
userInfoResponseAA 
=AA 
awaitAA $"
_accountServiceAdapterAA% ;
.AA; <
GetUserInfoAA< G
(AAG H
requestAAH O
.AAO P
AffiliateIdAAP [
,AA[ \
_brandServiceAA\ i
.AAi j
BrandIdAAj q
)AAq r
;AAr s
varBB 
balanceInfoBB 
=BB 
awaitBB .
"GetBalanceInformationByAffiliateIdBB  B
(BBB C
requestBBC J
.BBJ K
AffiliateIdBBK V
)BBV W
;BBW X
varCC 

productIdsCC 
=CC 
requestCC  
.CC  !
ProductsListCC! -
.CC- .
SelectCC. 4
(CC4 5
pCC5 6
=>CC7 9
pCC: ;
.CC; <
	IdProductCC< E
)CCE F
.CCF G
ToArrayCCG N
(CCN O
)CCO P
;CCP Q
varDD 
responseListDD 
=DD 
awaitDD  $
_inventoryServiceAdapterDD! 9
.DD9 :
GetProductsIdsDD: H
(DDH I

productIdsDDI S
,DDS T
_brandServiceDDU b
.DDb c
BrandIdDDc j
)DDj k
;DDk l
ifFF 

(FF 
!FF 
responseListFF 
.FF 
IsSuccessfulFF &
)FF& '
returnGG 
falseGG 
;GG 
ifII 

(II 
stringII 
.II 
IsNullOrEmptyII  
(II  !
responseListII! -
.II- .
ContentII. 5
)II5 6
)II6 7
returnJJ 
falseJJ 
;JJ 
varLL 
resultLL 
=LL 
responseListLL !
.LL! "
ContentLL" )
.LL) *
ToJsonObjectLL* 6
<LL6 7
ProductsResponseLL7 G
>LLG H
(LLH I
)LLI J
;LLJ K
ifNN 

(NN 
resultNN 
?NN 
.NN 
DataNN 
==NN 
nullNN  
)NN  !
returnOO 
falseOO 
;OO 
ifQQ 

(QQ 
resultQQ 
.QQ 
DataQQ 
.QQ 
CountQQ 
!=QQ  
requestQQ! (
.QQ( )
ProductsListQQ) 5
.QQ5 6
CountQQ6 ;
)QQ; <
returnRR 
falseRR 
;RR 
varTT 
productNamesTT 
=TT 
resultTT !
.TT! "
DataTT" &
.TT& '
SelectTT' -
(TT- .
itemTT. 2
=>TT3 5
itemTT6 :
.TT: ;
NameTT; ?
)TT? @
.TT@ A
ToArrayTTA H
(TTH I
)TTI J
;TTJ K
foreachVV 
(VV 
varVV 
itemVV 
inVV 
resultVV #
.VV# $
DataVV$ (
)VV( )
{WW 	
varXX 
productXX 
=XX 
requestXX !
.XX! "
ProductsListXX" .
.XX. /
FirstOrDefaultXX/ =
(XX= >
xXX> ?
=>XX@ B
xXXC D
.XXD E
	IdProductXXE N
==XXO Q
itemXXR V
.XXV W
IdXXW Y
)XXY Z
;XXZ [
varYY 
taxYY 
=YY 
itemYY 
.YY 
TaxYY 
;YY 
debitZZ 
+=ZZ 
(ZZ 
intZZ 
)ZZ 
(ZZ 
(ZZ 
itemZZ  
.ZZ  !
	SalePriceZZ! *
*ZZ+ ,
productZZ- 4
!ZZ4 5
.ZZ5 6
CountZZ6 ;
)ZZ; <
*ZZ= >
(ZZ? @
$numZZ@ A
+ZZB C
(ZZD E
taxZZE H
/ZZI J
$numZZK N
)ZZN O
)ZZO P
)ZZP Q
;ZZQ R
points[[ 
+=[[ 
item[[ 
.[[ 
BinaryPoints[[ '
*[[( )
product[[* 1
.[[1 2
Count[[2 7
;[[7 8
commissionable\\ 
+=\\ 
item\\ "
.\\" #
CommissionableValue\\# 6
*\\7 8
product\\9 @
.\\@ A
Count\\A F
;\\F G
if]] 
(]] 
item]] 
.]] 

CategoryId]] 
==]]  "
$num]]# $
)]]$ %
{^^ 
origin__ 
=__ 
$num__ 
;__ 
}`` 
varbb 
invoiceDetailbb 
=bb 
newbb  #,
 InvoiceDetailsTransactionRequestbb$ D
{cc 
	ProductIddd 
=dd 
itemdd  
.dd  !
Iddd! #
,dd# $
PaymentGroupIdee 
=ee  
itemee! %
.ee% &
PaymentGroupee& 2
,ee2 3
AccumMinPurchaseff  
=ff! "
itemff# '
.ff' (
AcumCompMinff( 3
,ff3 4
ProductNamegg 
=gg 
itemgg "
.gg" #
Namegg# '
!gg' (
,gg( )
ProductPricehh 
=hh 
itemhh #
.hh# $
	SalePricehh$ -
,hh- .
ProductPriceBtcii 
=ii  !
	Constantsii" +
.ii+ ,

EmptyValueii, 6
,ii6 7

ProductIvajj 
=jj 
itemjj !
.jj! "
Taxjj" %
,jj% &
ProductQuantitykk 
=kk  !
productkk" )
.kk) *
Countkk* /
,kk/ 0!
ProductCommissionablell %
=ll& '
itemll( ,
.ll, -
CommissionableValuell- @
,ll@ A
BinaryPointsmm 
=mm 
itemmm #
.mm# $
BinaryPointsmm$ 0
,mm0 1
ProductPointsnn 
=nn 
itemnn  $
.nn$ %
ValuePointsnn% 0
,nn0 1
ProductDiscountoo 
=oo  !
itemoo" &
.oo& '
ProductDiscountoo' 6
,oo6 7
CombinationIdpp 
=pp 
	Constantspp  )
.pp) *

EmptyValuepp* 4
,pp4 5
ProductPackqq 
=qq 
itemqq "
.qq" #
ProductPacksqq# /
,qq/ 0

BaseAmountrr 
=rr 
(rr 
itemrr "
.rr" #

BaseAmountrr# -
*rr. /
productrr0 7
.rr7 8
Countrr8 =
)rr= >
,rr> ?
DailyPercentagess 
=ss  !
itemss" &
.ss& '
DailyPercentagess' 6
,ss6 7
WaitingDaystt 
=tt 
itemtt "
.tt" #
DaysWaittt# +
,tt+ ,
DaysToPayQuantityuu !
=uu" #
	Constantsuu$ -
.uu- .
DaysToPayQuantityuu. ?
,uu? @
ProductStartvv 
=vv 
falsevv $
,vv$ %
}ww 
;ww 
invoiceDetailsyy 
.yy 
Addyy 
(yy 
invoiceDetailyy ,
)yy, -
;yy- .
}zz 	
if|| 

(|| 
debit|| 
==|| 
	Constants|| 
.|| 

EmptyValue|| )
)||) *
return}} 
false}} 
;}} 
if 

( 
invoiceDetails 
. 
Count  
==! #
	Constants$ -
.- .

EmptyValue. 8
)8 9
return
ÄÄ 
false
ÄÄ 
;
ÄÄ 
if
ÇÇ 

(
ÇÇ 
debit
ÇÇ 
>
ÇÇ 
balanceInfo
ÇÇ 
.
ÇÇ  
ReverseBalance
ÇÇ  .
.
ÇÇ. /
GetValueOrDefault
ÇÇ/ @
(
ÇÇ@ A
)
ÇÇA B
)
ÇÇB C
return
ÉÉ 
false
ÉÉ 
;
ÉÉ 
var
ÖÖ %
debitTransactionRequest
ÖÖ #
=
ÖÖ$ %
new
ÖÖ& )%
DebitTransactionRequest
ÖÖ* A
{
ÜÜ 	
Debit
áá 
=
áá 
debit
áá 
,
áá 
AffiliateId
àà 
=
àà 
request
àà !
.
àà! "
AffiliateId
àà" -
,
àà- .
UserId
ââ 
=
ââ 
	Constants
ââ 
.
ââ 
AdminUserId
ââ *
,
ââ* +
ConceptType
ää 
=
ää 
WalletConceptType
ää +
.
ää+ ,+
purchase_with_reverse_balance
ää, I
.
ääI J
ToString
ääJ R
(
ääR S
)
ääS T
,
ääT U
Points
ãã 
=
ãã 
points
ãã 
,
ãã 
Concept
åå 
=
åå 
	Constants
åå 
.
åå  $
EcoPoolProductCategory
åå  6
,
åå6 7
Commissionable
çç 
=
çç 
commissionable
çç +
,
çç+ ,
Bank
éé 
=
éé 
request
éé 
.
éé 
Bank
éé 
,
éé  
PaymentMethod
èè 
=
èè 
	Constants
èè %
.
èè% &"
WalletModel1BBalance
èè& :
,
èè: ;
Origin
êê 
=
êê 
origin
êê 
,
êê 
Level
ëë 
=
ëë 
	Constants
ëë 
.
ëë 

EmptyValue
ëë (
,
ëë( )
AffiliateUserName
íí 
=
íí 
request
íí  '
.
íí' (
AffiliateUserName
íí( 9
,
íí9 :
AdminUserName
ìì 
=
ìì 
	Constants
ìì %
.
ìì% &$
AdminEcosystemUserName
ìì& <
,
ìì< =
ReceiptNumber
îî 
=
îî 
request
îî #
.
îî# $
ReceiptNumber
îî$ 1
,
îî1 2
Type
ïï 
=
ïï 
true
ïï 
,
ïï 
	SecretKey
ññ 
=
ññ 
request
ññ 
.
ññ  
	SecretKey
ññ  )
,
ññ) *
invoices
óó 
=
óó 
invoiceDetails
óó %
,
óó% &
Reason
òò 
=
òò 
string
òò  &
.
òò& '
Empty
òò' ,
}
ôô 	
;
ôô	 

var
õõ 

spResponse
õõ 
=
õõ 
await
õõ &
_walletModel1BRepository
õõ 7
.
õõ7 8
DebitTransaction
õõ8 H
(
õõH I%
debitTransactionRequest
õõI `
)
õõ` a
;
õõa b
if
ùù 

(
ùù 

spResponse
ùù 
is
ùù 
null
ùù 
)
ùù 
return
ûû 
false
ûû 
;
ûû 
var
†† 

invoicePdf
†† 
=
†† 
await
°° "
_ecosystemPdfService
°° &
.
°°& '
GenerateInvoice
°°' 6
(
°°6 7
userInfoResponse
°°7 G
!
°°G H
,
°°H I%
debitTransactionRequest
°°J a
,
°°a b

spResponse
°°c m
)
°°m n
;
°°n o
var
££ !
productPdfsContents
££ 
=
££  !
await
££" '
CommonExtensions
££( 8
.
££8 9+
GetPdfContentFromProductNames
££9 V
(
££V W
productNames
££W c
!
££c d
)
££d e
;
££e f

Dictionary
•• 
<
•• 
string
•• 
,
•• 
byte
•• 
[
••  
]
••  !
>
••! "

allPdfData
••# -
=
••. /
new
••0 3

Dictionary
••4 >
<
••> ?
string
••? E
,
••E F
byte
••G K
[
••K L
]
••L M
>
••M N
{
¶¶ 	
[
ßß 
$str
ßß 
]
ßß 
=
ßß 

invoicePdf
ßß (
}
®® 	
;
®®	 

foreach
™™ 
(
™™ 
var
™™ 
pdfDataEntry
™™ !
in
™™" $!
productPdfsContents
™™% 8
)
™™8 9
{
´´ 	

allPdfData
¨¨ 
[
¨¨ 
pdfDataEntry
¨¨ #
.
¨¨# $
Key
¨¨$ '
]
¨¨' (
=
¨¨) *
pdfDataEntry
¨¨+ 7
.
¨¨7 8
Value
¨¨8 =
;
¨¨= >
}
≠≠ 	
if
ØØ 

(
ØØ 

allPdfData
ØØ 
.
ØØ 
Count
ØØ 
>
ØØ 
	Constants
ØØ (
.
ØØ( )

EmptyValue
ØØ) 3
)
ØØ3 4
{
∞∞ 	
await
±±  
_brevoEmailService
±± $
.
±±$ %&
SendEmailPurchaseConfirm
±±% =
(
±±= >
userInfoResponse
±±> N
!
±±N O
,
±±O P

allPdfData
±±Q [
,
±±[ \

spResponse
±±] g
,
±±g h
request
±±h o
.
±±o p
BrandId
±±p w
)
±±w x
;
±±x y
}
≤≤ 	
return
¥¥ 
true
¥¥ 
;
¥¥ 
}
µµ 
public
∑∑ 

async
∑∑ 
Task
∑∑ 
<
∑∑ 
bool
∑∑ 
>
∑∑ 5
'ExecuteEcoPoolPaymentWithServiceBalance
∑∑ C
(
∑∑C D
WalletRequest
∑∑D Q
request
∑∑R Y
)
∑∑Y Z
{
∏∏ 
var
ππ 
debit
ππ 
=
ππ 
$num
ππ 
;
ππ 
var
∫∫ 
points
∫∫ 
=
∫∫ 
$num
∫∫ 
;
∫∫ 
var
ªª 
commissionable
ªª 
=
ªª 
$num
ªª 
;
ªª  
byte
ºº 
origin
ºº 
=
ºº 
$num
ºº 
;
ºº 
var
ææ 
invoiceDetails
ææ 
=
ææ 
new
ææ  
List
ææ! %
<
ææ% &.
 InvoiceDetailsTransactionRequest
ææ& F
>
ææF G
(
ææG H
)
ææH I
;
ææI J
var
øø 
userInfoResponse
øø 
=
øø 
await
øø $$
_accountServiceAdapter
øø% ;
.
øø; <
GetUserInfo
øø< G
(
øøG H
request
øøH O
.
øøO P
AffiliateId
øøP [
,
øø[ \
_brandService
øø\ i
.
øøi j
BrandId
øøj q
)
øøq r
;
øør s
var
¿¿ 
balanceInfo
¿¿ 
=
¿¿ 
await
¿¿ 0
"GetBalanceInformationByAffiliateId
¿¿  B
(
¿¿B C
request
¿¿C J
.
¿¿J K
AffiliateId
¿¿K V
)
¿¿V W
;
¿¿W X
var
¡¡ 

productIds
¡¡ 
=
¡¡ 
request
¡¡  
.
¡¡  !
ProductsList
¡¡! -
.
¡¡- .
Select
¡¡. 4
(
¡¡4 5
p
¡¡5 6
=>
¡¡7 9
p
¡¡: ;
.
¡¡; <
	IdProduct
¡¡< E
)
¡¡E F
.
¡¡F G
ToArray
¡¡G N
(
¡¡N O
)
¡¡O P
;
¡¡P Q
var
¬¬ 
responseList
¬¬ 
=
¬¬ 
await
¬¬  &
_inventoryServiceAdapter
¬¬! 9
.
¬¬9 :
GetProductsIds
¬¬: H
(
¬¬H I

productIds
¬¬I S
,
¬¬S T
_brandService
¬¬T a
.
¬¬a b
BrandId
¬¬b i
)
¬¬i j
;
¬¬j k
if
ƒƒ 

(
ƒƒ 
!
ƒƒ 
responseList
ƒƒ 
.
ƒƒ 
IsSuccessful
ƒƒ &
)
ƒƒ& '
return
≈≈ 
false
≈≈ 
;
≈≈ 
if
«« 

(
«« 
string
«« 
.
«« 
IsNullOrEmpty
««  
(
««  !
responseList
««! -
.
««- .
Content
««. 5
)
««5 6
)
««6 7
return
»» 
false
»» 
;
»» 
var
   
result
   
=
   
responseList
   !
.
  ! "
Content
  " )
.
  ) *
ToJsonObject
  * 6
<
  6 7
ProductsResponse
  7 G
>
  G H
(
  H I
)
  I J
;
  J K
if
ÃÃ 

(
ÃÃ 
result
ÃÃ 
?
ÃÃ 
.
ÃÃ 
Data
ÃÃ 
==
ÃÃ 
null
ÃÃ  
)
ÃÃ  !
return
ÕÕ 
false
ÕÕ 
;
ÕÕ 
if
œœ 

(
œœ 
result
œœ 
.
œœ 
Data
œœ 
.
œœ 
Count
œœ 
!=
œœ  
request
œœ! (
.
œœ( )
ProductsList
œœ) 5
.
œœ5 6
Count
œœ6 ;
)
œœ; <
return
–– 
false
–– 
;
–– 
var
““ 
productNames
““ 
=
““ 
result
““ !
.
““! "
Data
““" &
.
““& '
Select
““' -
(
““- .
item
““. 2
=>
““3 5
item
““6 :
.
““: ;
Name
““; ?
)
““? @
.
““@ A
ToArray
““A H
(
““H I
)
““I J
;
““J K
foreach
‘‘ 
(
‘‘ 
var
‘‘ 
item
‘‘ 
in
‘‘ 
result
‘‘ #
.
‘‘# $
Data
‘‘$ (
)
‘‘( )
{
’’ 	
var
÷÷ 
product
÷÷ 
=
÷÷ 
request
÷÷ !
.
÷÷! "
ProductsList
÷÷" .
.
÷÷. /
FirstOrDefault
÷÷/ =
(
÷÷= >
x
÷÷> ?
=>
÷÷@ B
x
÷÷C D
.
÷÷D E
	IdProduct
÷÷E N
==
÷÷O Q
item
÷÷R V
.
÷÷V W
Id
÷÷W Y
)
÷÷Y Z
;
÷÷Z [
var
◊◊ 
tax
◊◊ 
=
◊◊ 
item
◊◊ 
.
◊◊ 
Tax
◊◊ 
;
◊◊ 
debit
ÿÿ 
+=
ÿÿ 
(
ÿÿ 
int
ÿÿ 
)
ÿÿ 
(
ÿÿ 
(
ÿÿ 
item
ÿÿ  
.
ÿÿ  !
	SalePrice
ÿÿ! *
*
ÿÿ+ ,
product
ÿÿ- 4
!
ÿÿ4 5
.
ÿÿ5 6
Count
ÿÿ6 ;
)
ÿÿ; <
*
ÿÿ= >
(
ÿÿ? @
$num
ÿÿ@ A
+
ÿÿB C
(
ÿÿD E
tax
ÿÿE H
/
ÿÿI J
$num
ÿÿK N
)
ÿÿN O
)
ÿÿO P
)
ÿÿP Q
;
ÿÿQ R
points
ŸŸ 
+=
ŸŸ 
item
ŸŸ 
.
ŸŸ 
BinaryPoints
ŸŸ '
*
ŸŸ( )
product
ŸŸ* 1
.
ŸŸ1 2
Count
ŸŸ2 7
;
ŸŸ7 8
commissionable
⁄⁄ 
+=
⁄⁄ 
item
⁄⁄ "
.
⁄⁄" #!
CommissionableValue
⁄⁄# 6
*
⁄⁄7 8
product
⁄⁄9 @
.
⁄⁄@ A
Count
⁄⁄A F
;
⁄⁄F G
if
€€ 
(
€€ 
item
€€ 
.
€€ 

CategoryId
€€ 
==
€€  "
$num
€€# $
)
€€$ %
{
‹‹ 
origin
›› 
=
›› 
$num
›› 
;
›› 
}
ﬁﬁ 
var
‡‡ 
invoiceDetail
‡‡ 
=
‡‡ 
new
‡‡  #.
 InvoiceDetailsTransactionRequest
‡‡$ D
{
·· 
	ProductId
‚‚ 
=
‚‚ 
item
‚‚  
.
‚‚  !
Id
‚‚! #
,
‚‚# $
PaymentGroupId
„„ 
=
„„  
item
„„! %
.
„„% &
PaymentGroup
„„& 2
,
„„2 3
AccumMinPurchase
‰‰  
=
‰‰! "
item
‰‰# '
.
‰‰' (
AcumCompMin
‰‰( 3
,
‰‰3 4
ProductName
ÂÂ 
=
ÂÂ 
item
ÂÂ "
.
ÂÂ" #
Name
ÂÂ# '
!
ÂÂ' (
,
ÂÂ( )
ProductPrice
ÊÊ 
=
ÊÊ 
item
ÊÊ #
.
ÊÊ# $
	SalePrice
ÊÊ$ -
,
ÊÊ- .
ProductPriceBtc
ÁÁ 
=
ÁÁ  !
	Constants
ÁÁ" +
.
ÁÁ+ ,

EmptyValue
ÁÁ, 6
,
ÁÁ6 7

ProductIva
ËË 
=
ËË 
item
ËË !
.
ËË! "
Tax
ËË" %
,
ËË% &
ProductQuantity
ÈÈ 
=
ÈÈ  !
product
ÈÈ" )
.
ÈÈ) *
Count
ÈÈ* /
,
ÈÈ/ 0#
ProductCommissionable
ÍÍ %
=
ÍÍ& '
item
ÍÍ( ,
.
ÍÍ, -!
CommissionableValue
ÍÍ- @
,
ÍÍ@ A
BinaryPoints
ÎÎ 
=
ÎÎ 
item
ÎÎ #
.
ÎÎ# $
BinaryPoints
ÎÎ$ 0
,
ÎÎ0 1
ProductPoints
ÏÏ 
=
ÏÏ 
item
ÏÏ  $
.
ÏÏ$ %
ValuePoints
ÏÏ% 0
,
ÏÏ0 1
ProductDiscount
ÌÌ 
=
ÌÌ  !
item
ÌÌ" &
.
ÌÌ& '
ProductDiscount
ÌÌ' 6
,
ÌÌ6 7
CombinationId
ÓÓ 
=
ÓÓ 
	Constants
ÓÓ  )
.
ÓÓ) *

EmptyValue
ÓÓ* 4
,
ÓÓ4 5
ProductPack
ÔÔ 
=
ÔÔ 
item
ÔÔ "
.
ÔÔ" #
ProductPacks
ÔÔ# /
,
ÔÔ/ 0

BaseAmount
 
=
 
(
 
item
 "
.
" #

BaseAmount
# -
*
. /
product
0 7
.
7 8
Count
8 =
)
= >
,
> ?
DailyPercentage
ÒÒ 
=
ÒÒ  !
item
ÒÒ" &
.
ÒÒ& '
DailyPercentage
ÒÒ' 6
,
ÒÒ6 7
WaitingDays
ÚÚ 
=
ÚÚ 
item
ÚÚ "
.
ÚÚ" #
DaysWait
ÚÚ# +
,
ÚÚ+ ,
DaysToPayQuantity
ÛÛ !
=
ÛÛ" #
	Constants
ÛÛ$ -
.
ÛÛ- .
DaysToPayQuantity
ÛÛ. ?
,
ÛÛ? @
ProductStart
ÙÙ 
=
ÙÙ 
false
ÙÙ $
,
ÙÙ$ %
}
ıı 
;
ıı 
invoiceDetails
˜˜ 
.
˜˜ 
Add
˜˜ 
(
˜˜ 
invoiceDetail
˜˜ ,
)
˜˜, -
;
˜˜- .
}
¯¯ 	
if
˙˙ 

(
˙˙ 
debit
˙˙ 
==
˙˙ 
	Constants
˙˙ 
.
˙˙ 

EmptyValue
˙˙ )
)
˙˙) *
return
˚˚ 
false
˚˚ 
;
˚˚ 
if
˝˝ 

(
˝˝ 
invoiceDetails
˝˝ 
.
˝˝ 
Count
˝˝  
==
˝˝! #
	Constants
˝˝$ -
.
˝˝- .

EmptyValue
˝˝. 8
)
˝˝8 9
return
˛˛ 
false
˛˛ 
;
˛˛ 
if
ÄÄ 

(
ÄÄ 
debit
ÄÄ 
>
ÄÄ 
balanceInfo
ÄÄ 
.
ÄÄ  
ServiceBalance
ÄÄ  .
.
ÄÄ. /
GetValueOrDefault
ÄÄ/ @
(
ÄÄ@ A
)
ÄÄA B
)
ÄÄB C
return
ÅÅ 
false
ÅÅ 
;
ÅÅ 
var
ÉÉ %
debitTransactionRequest
ÉÉ #
=
ÉÉ$ %
new
ÉÉ& )%
DebitTransactionRequest
ÉÉ* A
{
ÑÑ 	
Debit
ÖÖ 
=
ÖÖ 
debit
ÖÖ 
,
ÖÖ 
AffiliateId
ÜÜ 
=
ÜÜ 
request
ÜÜ !
.
ÜÜ! "
AffiliateId
ÜÜ" -
,
ÜÜ- .
UserId
áá 
=
áá 
	Constants
áá 
.
áá 
AdminUserId
áá *
,
áá* +
ConceptType
àà 
=
àà 
WalletConceptType
àà +
.
àà+ ,
purchasing_pool
àà, ;
.
àà; <
ToString
àà< D
(
ààD E
)
ààE F
,
ààF G
Points
ââ 
=
ââ 
points
ââ 
,
ââ 
Concept
ää 
=
ää 
	Constants
ää 
.
ää  $
EcoPoolProductCategory
ää  6
,
ää6 7
Commissionable
ãã 
=
ãã 
commissionable
ãã +
,
ãã+ ,
Bank
åå 
=
åå 
	Constants
åå 
.
åå #
ServiceBalanceModel1B
åå 2
,
åå2 3
PaymentMethod
çç 
=
çç 
	Constants
çç %
.
çç% &#
ServiceBalanceModel1B
çç& ;
,
çç; <
Origin
éé 
=
éé 
origin
éé 
,
éé 
Level
èè 
=
èè 
	Constants
èè 
.
èè 

EmptyValue
èè (
,
èè( )
AffiliateUserName
êê 
=
êê 
request
êê  '
.
êê' (
AffiliateUserName
êê( 9
,
êê9 :
AdminUserName
ëë 
=
ëë 
	Constants
ëë %
.
ëë% &$
AdminEcosystemUserName
ëë& <
,
ëë< =
ReceiptNumber
íí 
=
íí 
request
íí #
.
íí# $
ReceiptNumber
íí$ 1
,
íí1 2
Type
ìì 
=
ìì 
true
ìì 
,
ìì 
	SecretKey
îî 
=
îî 
request
îî 
.
îî  
	SecretKey
îî  )
,
îî) *
invoices
ïï 
=
ïï 
invoiceDetails
ïï %
,
ïï% &
Reason
ññ 
=
ññ 
string
ññ  &
.
ññ& '
Empty
ññ' ,
}
óó 	
;
óó	 

var
ôô 

spResponse
ôô 
=
ôô 
await
ôô &
_walletModel1BRepository
ôô 7
.
ôô7 8,
DebitServiceBalanceTransaction
ôô8 V
(
ôôV W%
debitTransactionRequest
ôôW n
)
ôôn o
;
ôôo p
if
õõ 

(
õõ 

spResponse
õõ 
is
õõ 
null
õõ 
)
õõ 
return
úú 
false
úú 
;
úú 
var
ûû 

invoicePdf
ûû 
=
ûû 
await
üü "
_ecosystemPdfService
üü &
.
üü& '
GenerateInvoice
üü' 6
(
üü6 7
userInfoResponse
üü7 G
!
üüG H
,
üüH I%
debitTransactionRequest
üüJ a
,
üüa b

spResponse
üüc m
)
üüm n
;
üün o
var
°° !
productPdfsContents
°° 
=
°°  !
await
°°" '
CommonExtensions
°°( 8
.
°°8 9+
GetPdfContentFromProductNames
°°9 V
(
°°V W
productNames
°°W c
!
°°c d
)
°°d e
;
°°e f

Dictionary
££ 
<
££ 
string
££ 
,
££ 
byte
££ 
[
££  
]
££  !
>
££! "

allPdfData
££# -
=
££. /
new
££0 3

Dictionary
££4 >
<
££> ?
string
££? E
,
££E F
byte
££G K
[
££K L
]
££L M
>
££M N
{
§§ 	
[
•• 
$str
•• 
]
•• 
=
•• 

invoicePdf
•• (
}
¶¶ 	
;
¶¶	 

foreach
®® 
(
®® 
var
®® 
pdfDataEntry
®® !
in
®®" $!
productPdfsContents
®®% 8
)
®®8 9
{
©© 	

allPdfData
™™ 
[
™™ 
pdfDataEntry
™™ #
.
™™# $
Key
™™$ '
]
™™' (
=
™™) *
pdfDataEntry
™™+ 7
.
™™7 8
Value
™™8 =
;
™™= >
}
´´ 	
if
≠≠ 

(
≠≠ 

allPdfData
≠≠ 
.
≠≠ 
Count
≠≠ 
>
≠≠ 
	Constants
≠≠ (
.
≠≠( )

EmptyValue
≠≠) 3
)
≠≠3 4
{
ÆÆ 	
await
ØØ  
_brevoEmailService
ØØ $
.
ØØ$ %&
SendEmailPurchaseConfirm
ØØ% =
(
ØØ= >
userInfoResponse
ØØ> N
!
ØØN O
,
ØØO P

allPdfData
ØØQ [
,
ØØ[ \

spResponse
ØØ] g
,
ØØg h
request
ØØh o
.
ØØo p
BrandId
ØØp w
)
ØØw x
;
ØØx y
}
∞∞ 	
return
≤≤ 
true
≤≤ 
;
≤≤ 
}
≥≥ 
}¥¥ Á´
`C:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\BalancePaymentStrategyModel2.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
;. /
public 
class (
BalancePaymentStrategyModel2 )
:* +)
IBalancePaymentStrategyModel2, I
{ 
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter. D
;D E
private 
readonly 
IWalletRepository &
_walletRepository. ?
;? @
private 
readonly  
IEcosystemPdfService ) 
_ecosystemPdfService/ C
;C D
private 
readonly 
IBrevoEmailService '
_brevoEmailService. @
;@ A
private 
readonly $
IWalletRequestRepository -$
_walletRequestRepository. F
;F G
private 
readonly 

RedisCache 
_redisCache. 9
;9 :
private 
readonly 
IBrandService "
_brandService# 0
;0 1
public 
(
BalancePaymentStrategyModel2 '
(' ($
IInventoryServiceAdapter( @#
inventoryServiceAdapterA X
,X Y"
IAccountServiceAdapter !
accountServiceAdapterC X
,X Y
IWalletRepositoryZ k
walletRepositoryl |
,| }!
IEcosystemPdfService	~ í!
ecosystemPdfService
ì ¶
,
¶ ß
IBrevoEmailService 
brevoEmailServiceC T
,T U$
IWalletRequestRepositoryV n$
walletRequestRepository	o Ü
,
Ü á

RedisCache 

redisCacheC M
,M N
IBrandServiceO \
brandService] i
)i j
{ $
_inventoryServiceAdapter  
=! "#
inventoryServiceAdapter# :
;: ;"
_accountServiceAdapter 
=! "!
accountServiceAdapter# 8
;8 9
_walletRepository   
=  ! "
walletRepository  # 3
;  3 4
_brevoEmailService!! 
=!!! "
brevoEmailService!!# 4
;!!4 5 
_ecosystemPdfService"" 
=""" #
ecosystemPdfService""$ 7
;""7 8$
_walletRequestRepository##  
=##! "#
walletRequestRepository### :
;##: ;
_redisCache$$ 
=$$! "

redisCache$$# -
;$$- .
_brandService%% 
=%%  
brandService%%! -
;%%- .
}&& 
public'' 

async'' 
Task'' 
<'' 
bool'' 
>'' 
ExecutePayment'' *
(''* +
WalletRequest''+ 8
request''9 @
)''@ A
{(( 
var)) 
debit)) 
=)) 
$num))  
;))  !
var** 
points** 
=** 
$num**  
;**  !
var++ 
commissionable++ 
=++ 
$num++  
;++  !
byte,, 
origin,, 
=,, 
$num,, 
;,,  
var.. 
invoiceDetails.. 
=.. 
new.. "
List..# '
<..' (,
 InvoiceDetailsTransactionRequest..( H
>..H I
(..I J
)..J K
;..K L
var// 
userInfoResponse// 
=// 
await// $"
_accountServiceAdapter//% ;
.//; <
GetUserInfo//< G
(//G H
request//H O
.//O P
AffiliateId//P [
,//[ \
_brandService//\ i
.//i j
BrandId//j q
)//q r
;//r s
var00 
balanceInfo00 
=00 
await00 $.
"GetBalanceInformationByAffiliateId00% G
(00G H
request00H O
.00O P
AffiliateId00P [
)00[ \
;00\ ]
var11 

productIds11 
=11 
request11 &
.11& '
ProductsList11' 3
.113 4
Select114 :
(11: ;
p11; <
=>11= ?
p11@ A
.11A B
	IdProduct11B K
)11K L
.11L M
ToArray11M T
(11T U
)11U V
;11V W
var22 
responseList22 
=22 
await22 $$
_inventoryServiceAdapter22% =
.22= >
GetProductsIds22> L
(22L M

productIds22M W
,22W X
_brandService22X e
.22e f
BrandId22f m
)22m n
;22n o
if44 

(44 
!44 
responseList44 
.44 
IsSuccessful44 &
)44& '
return55 
false55 
;55 
if77 

(77 
string77 
.77 
IsNullOrEmpty77  
(77  !
responseList77! -
.77- .
Content77. 5
)775 6
)776 7
return88 
false88 
;88 
var:: 
result:: 
=:: 
responseList:: !
.::! "
Content::" )
.::) *
ToJsonObject::* 6
<::6 7
ProductsResponse::7 G
>::G H
(::H I
)::I J
;::J K
if<< 

(<< 
result<< 
?<< 
.<< 
Data<< 
.<< 
Count<< 
==<< !
	Constants<<" +
.<<+ ,

EmptyValue<<, 6
)<<6 7
{== 	
var>> 
firstProductId>> 
=>>! "
request>># *
.>>* +
ProductsList>>+ 7
.>>7 8
First>>8 =
(>>= >
)>>> ?
.>>? @
	IdProduct>>@ I
;>>I J
var?? 
membershipResult??  
=??! "
await??# ($
_inventoryServiceAdapter??) A
.??A B
GetProductById??B P
(??P Q
firstProductId??Q _
,??_ `
_brandService??a n
.??n o
BrandId??o v
)??v w
;??w x
varAA 
productResponseAA 
=AA  !
membershipResultAA" 2
.AA2 3
ContentAA3 :
!AA: ;
.AA; <
ToJsonObjectAA< H
<AAH I
ProductResponseAAI X
>AAX Y
(AAY Z
)AAZ [
;AA[ \
awaitCC "
_accountServiceAdapterCC (
.CC( ) 
UpdateActivationDateCC) =
(CC= >
requestCC> E
.CCE F
AffiliateIdCCF Q
,CCQ R
_brandServiceCCR _
.CC_ `
BrandIdCC` g
)CCg h
;CCh i
resultEE 
.EE 
DataEE 
.EE 
AddEE 
(EE 
productResponseEE +
!EE+ ,
.EE, -
DataEE- 1
)EE1 2
;EE2 3
}FF 	
ifHH 

(HH 
resultHH 
?HH 
.HH 
DataHH 
==HH 
nullHH  
)HH  !
returnII 
falseII 
;II 
ifKK 

(KK 
resultKK 
.KK 
DataKK 
.KK 
CountKK 
!=KK  
requestKK! (
.KK( )
ProductsListKK) 5
.KK5 6
CountKK6 ;
)KK; <
returnLL 
falseLL 
;LL 
foreachNN 
(NN 
varNN 
itemNN 
inNN 
resultNN #
.NN# $
DataNN$ (
)NN( )
{OO 	
varPP 
productPP 
=PP 
requestPP !
.PP! "
ProductsListPP" .
.PP. /
FirstOrDefaultPP/ =
(PP= >
xPP> ?
=>PP@ B
xPPC D
.PPD E
	IdProductPPE N
==PPO Q
itemPPR V
.PPV W
IdPPW Y
)PPY Z
;PPZ [
varQQ 
taxQQ 
=QQ 
itemQQ 
.QQ 
TaxQQ "
;QQ" #
debitRR 
+=RR 
(RR 
intRR "
)RR" #
(RR# $
(RR$ %
itemRR% )
.RR) *
	SalePriceRR* 3
*RR4 5
productRR6 =
!RR= >
.RR> ?
CountRR? D
)RRD E
*RRF G
(RRH I
$numRRI J
+RRK L
(RRM N
taxRRN Q
/RRR S
$numRRT W
)RRW X
)RRX Y
)RRY Z
;RRZ [
pointsSS 
+=SS 
itemSS "
.SS" #
BinaryPointsSS# /
*SS0 1
productSS2 9
.SS9 :
CountSS: ?
;SS? @
commissionableTT 
+=TT 
itemTT "
.TT" #
CommissionableValueTT# 6
*TT7 8
productTT9 @
.TT@ A
CountTTA F
;TTF G
ifUU 
(UU 
itemUU 
.UU 

CategoryIdUU 
==UU  "
$numUU# $
)UU$ %
{VV 
originWW 
=WW 
$numWW 
;WW 
}XX 
varZZ 
invoiceDetailZZ 
=ZZ 
newZZ  #,
 InvoiceDetailsTransactionRequestZZ$ D
{[[ 
	ProductId\\ 
=\\& '
item\\( ,
.\\, -
Id\\- /
,\\/ 0
PaymentGroupId]] 
=]]& '
item]]( ,
.]], -
PaymentGroup]]- 9
,]]9 :
AccumMinPurchase^^  
=^^& '
item^^( ,
.^^, -
AcumCompMin^^- 8
,^^8 9
ProductName__ 
=__& '
item__( ,
.__, -
Name__- 1
!__1 2
,__2 3
ProductPrice`` 
=``& '
item``( ,
.``, -
	SalePrice``- 6
,``6 7
ProductPriceBtcaa 
=aa& '
	Constantsaa( 1
.aa1 2

EmptyValueaa2 <
,aa< =

ProductIvabb 
=bb& '
itembb( ,
.bb, -
Taxbb- 0
,bb0 1
ProductQuantitycc 
=cc& '
productcc( /
.cc/ 0
Countcc0 5
,cc5 6!
ProductCommissionabledd %
=dd& '
itemdd( ,
.dd, -
CommissionableValuedd- @
,dd@ A
BinaryPointsee 
=ee& '
itemee( ,
.ee, -
BinaryPointsee- 9
,ee9 :
ProductPointsff 
=ff& '
itemff( ,
.ff, -
ValuePointsff- 8
,ff8 9
ProductDiscountgg 
=gg& '
itemgg( ,
.gg, -
ProductDiscountgg- <
,gg< =
CombinationIdhh 
=hh& '
	Constantshh( 1
.hh1 2

EmptyValuehh2 <
,hh< =
ProductPackii 
=ii& '
itemii( ,
.ii, -
ProductPacksii- 9
,ii9 :

BaseAmountjj 
=jj& '
(jj( )
itemjj) -
.jj- .

BaseAmountjj. 8
*jj9 :
productjj; B
.jjB C
CountjjC H
)jjH I
,jjI J
DailyPercentagekk 
=kk& '
itemkk( ,
.kk, -
DailyPercentagekk- <
,kk< =
WaitingDaysll 
=ll& '
itemll( ,
.ll, -
DaysWaitll- 5
,ll5 6
DaysToPayQuantitymm !
=mm& '
	Constantsmm( 1
.mm1 2
DaysToPayQuantitymm2 C
,mmC D
ProductStartnn 
=nn& '
falsenn( -
}oo 
;oo 
invoiceDetailsqq 
.qq 
Addqq 
(qq 
invoiceDetailqq ,
)qq, -
;qq- .
}rr 	
iftt 

(tt 
debittt 
==tt 
	Constantstt 
.tt 

EmptyValuett )
)tt) *
returnuu 
falseuu 
;uu 
ifww 

(ww 
invoiceDetailsww 
.ww 
Countww  
==ww! #
	Constantsww$ -
.ww- .

EmptyValueww. 8
)ww8 9
returnxx 
falsexx 
;xx 
ifzz 

(zz 
debitzz 
>zz 
balanceInfozz 
.zz  
ReverseBalancezz  .
.zz. /
GetValueOrDefaultzz/ @
(zz@ A
)zzA B
)zzB C
return{{ 
false{{ 
;{{ 
var}} 
productNames}} 
=}} 
result}} !
.}}! "
Data}}" &
.}}& '
Select}}' -
(}}- .
item}}. 2
=>}}3 5
item}}6 :
.}}: ;
Name}}; ?
)}}? @
.}}@ A
ToArray}}A H
(}}H I
)}}I J
;}}J K
var #
debitTransactionRequest #
=$ %
new& )#
DebitTransactionRequest* A
{
ÄÄ 	
Debit
ÅÅ 
=
ÅÅ 
debit
ÅÅ  %
,
ÅÅ% &
AffiliateId
ÇÇ 
=
ÇÇ 
request
ÇÇ  '
.
ÇÇ' (
AffiliateId
ÇÇ( 3
,
ÇÇ3 4
UserId
ÉÉ 
=
ÉÉ 
	Constants
ÉÉ  )
.
ÉÉ) *
AdminUserId
ÉÉ* 5
,
ÉÉ5 6
ConceptType
ÑÑ 
=
ÑÑ 
WalletConceptType
ÑÑ  1
.
ÑÑ1 2+
purchase_with_reverse_balance
ÑÑ2 O
.
ÑÑO P
ToString
ÑÑP X
(
ÑÑX Y
)
ÑÑY Z
,
ÑÑZ [
Points
ÖÖ 
=
ÖÖ 
points
ÖÖ  &
,
ÖÖ& '
Concept
ÜÜ 
=
ÜÜ 
	Constants
ÜÜ  )
.
ÜÜ) *$
EcoPoolProductCategory
ÜÜ* @
,
ÜÜ@ A
Commissionable
áá 
=
áá 
commissionable
áá  .
,
áá. /
Bank
àà 
=
àà 
request
àà  '
.
àà' (
Bank
àà( ,
,
àà, -
PaymentMethod
ââ 
=
ââ 
	Constants
ââ  )
.
ââ) *
ReverseBalance
ââ* 8
,
ââ8 9
Origin
ää 
=
ää 
origin
ää  &
,
ää& '
Level
ãã 
=
ãã 
	Constants
ãã  )
.
ãã) *

EmptyValue
ãã* 4
,
ãã4 5
AffiliateUserName
åå 
=
åå 
request
åå  '
.
åå' (
AffiliateUserName
åå( 9
,
åå9 :
AdminUserName
çç 
=
çç 
	Constants
çç  )
.
çç) *$
AdminEcosystemUserName
çç* @
,
çç@ A
ReceiptNumber
éé 
=
éé 
request
éé  '
.
éé' (
ReceiptNumber
éé( 5
,
éé5 6
Type
èè 
=
èè 
true
èè  $
,
èè$ %
	SecretKey
êê 
=
êê 
request
êê  '
.
êê' (
	SecretKey
êê( 1
,
êê1 2
invoices
ëë 
=
ëë 
invoiceDetails
ëë  .
,
ëë. /
Reason
íí 
=
íí 
string
íí  &
.
íí& '
Empty
íí' ,
}
ìì 	
;
ìì	 

var
ïï 

spResponse
ïï 
=
ïï 
await
ïï 
_walletRepository
ïï 0
.
ïï0 1
DebitTransaction
ïï1 A
(
ïïA B%
debitTransactionRequest
ïïB Y
)
ïïY Z
;
ïïZ [
if
óó 

(
óó 

spResponse
óó 
is
óó 
null
óó 
)
óó 
return
òò 
false
òò 
;
òò 
await
öö 
RemoveCacheKey
öö 
(
öö 
request
öö $
)
öö$ %
;
öö% &
var
úú 

invoicePdf
úú 
=
úú 
await
úú "
_ecosystemPdfService
úú 3
.
úú3 4
GenerateInvoice
úú4 C
(
úúC D
userInfoResponse
úúD T
!
úúT U
,
úúU V%
debitTransactionRequest
úúW n
,
úún o

spResponse
úúp z
)
úúz {
;
úú{ |
var
ùù !
productPdfsContents
ùù 
=
ùù  !
await
ùù" '
CommonExtensions
ùù( 8
.
ùù8 9+
GetPdfContentFromProductNames
ùù9 V
(
ùùV W
productNames
ùùW c
!
ùùc d
)
ùùd e
;
ùùe f

Dictionary
üü 
<
üü 
string
üü 
,
üü 
byte
üü 
[
üü  
]
üü  !
>
üü! "

allPdfData
üü# -
=
üü. /
new
üü0 3

Dictionary
üü4 >
<
üü> ?
string
üü? E
,
üüE F
byte
üüG K
[
üüK L
]
üüL M
>
üüM N
{
†† 	
[
°° 
$str
°° 
]
°° 
=
°° 

invoicePdf
°° (
}
¢¢ 	
;
¢¢	 

foreach
§§ 
(
§§ 
var
§§ 
pdfDataEntry
§§ !
in
§§" $!
productPdfsContents
§§% 8
)
§§8 9
{
•• 	

allPdfData
¶¶ 
[
¶¶ 
pdfDataEntry
¶¶ #
.
¶¶# $
Key
¶¶$ '
]
¶¶' (
=
¶¶) *
pdfDataEntry
¶¶+ 7
.
¶¶7 8
Value
¶¶8 =
;
¶¶= >
}
ßß 	
if
©© 

(
©© 

invoicePdf
©© 
.
©© 
Length
©© 
!=
©©  
	Constants
©©! *
.
©©* +

EmptyValue
©©+ 5
)
©©5 6
{
™™ 	
await
´´  
_brevoEmailService
´´ $
.
´´$ %&
SendEmailPurchaseConfirm
´´% =
(
´´= >
userInfoResponse
´´> N
!
´´N O
,
´´O P

allPdfData
´´Q [
,
´´[ \

spResponse
´´] g
,
´´g h
request
´´h o
.
´´o p
BrandId
´´p w
)
´´w x
;
´´x y
}
¨¨ 	
return
ÆÆ 
true
ÆÆ 
;
ÆÆ 
}
ØØ 
private
∞∞ 
async
∞∞ 
Task
∞∞ 
<
∞∞ #
BalanceInformationDto
∞∞ ,
>
∞∞, -0
"GetBalanceInformationByAffiliateId
∞∞. P
(
∞∞P Q
int
∞∞Q T
affiliateId
∞∞U `
)
∞∞` a
{
±± 
var
≤≤ 
amountRequests
≤≤ 
=
≤≤ 
await
≤≤  %&
_walletRequestRepository
≤≤& >
.
≤≤> ?6
(GetTotalWalletRequestAmountByAffiliateId
≤≤? g
(
≤≤g h
affiliateId
≤≤h s
,
≤≤s t
_brandService≤≤t Å
.≤≤Å Ç
BrandId≤≤Ç â
)≤≤â ä
;≤≤ä ã
var
≥≥ 
availableBalance
≥≥ 
=
≥≥ 
await
≥≥  %
_walletRepository
≥≥& 7
.
≥≥7 8.
 GetAvailableBalanceByAffiliateId
≥≥8 X
(
≥≥X Y
affiliateId
≥≥Y d
,
≥≥d e
_brandService
≥≥e r
.
≥≥r s
BrandId
≥≥s z
)
≥≥z {
;
≥≥{ |
var
¥¥ 
reverseBalance
¥¥ 
=
¥¥ 
await
¥¥  %
_walletRepository
¥¥& 7
.
¥¥7 8,
GetReverseBalanceByAffiliateId
¥¥8 V
(
¥¥V W
affiliateId
¥¥W b
,
¥¥b c
_brandService
¥¥c p
.
¥¥p q
BrandId
¥¥q x
)
¥¥x y
;
¥¥y z
var
µµ 
totalAcquisitions
µµ 
=
µµ 
await
µµ  %
_walletRepository
µµ& 7
.
µµ7 8/
!GetTotalAcquisitionsByAffiliateId
µµ8 Y
(
µµY Z
affiliateId
µµZ e
,
µµe f
_brandService
µµf s
.
µµs t
BrandId
µµt {
)
µµ{ |
;
µµ| }
var
∑∑ 
response
∑∑ 
=
∑∑ 
new
∑∑ #
BalanceInformationDto
∑∑ 0
{
∏∏ 	
AvailableBalance
ππ 
=
ππ 
availableBalance
ππ  0
,
ππ0 1
ReverseBalance
∫∫ 
=
∫∫ 
reverseBalance
∫∫  .
??
∫∫/ 1
	Constants
∫∫2 ;
.
∫∫; <

EmptyValue
∫∫< F
,
∫∫F G
TotalAcquisitions
ªª 
=
ªª 
totalAcquisitions
ªª  1
??
ªª2 4
	Constants
ªª5 >
.
ªª> ?

EmptyValue
ªª? I
}
ºº 	
;
ºº	 

if
ææ 

(
ææ 
amountRequests
ææ 
==
ææ 
$num
ææ  
&&
ææ! #
response
ææ$ ,
.
ææ, -
ReverseBalance
ææ- ;
==
ææ< >
$num
ææ? A
)
ææA B
return
ææC I
response
ææJ R
;
ææR S
response
¿¿ 
.
¿¿ 
AvailableBalance
¿¿ !
-=
¿¿" $
amountRequests
¿¿% 3
;
¿¿3 4
return
¬¬ 
response
¬¬ 
;
¬¬ 
}
√√ 
private
≈≈ 
async
≈≈ 
Task
≈≈ 
RemoveCacheKey
≈≈ %
(
≈≈% &
WalletRequest
≈≈& 3
request
≈≈4 ;
)
≈≈; <
{
∆∆ 
var
«« 
key
«« 
=
«« 
string
«« 
.
«« 
Format
«« %
(
««% &
	CacheKeys
««& /
.
««/ 0&
BalanceInformationModel2
««0 H
,
««H I
request
««J Q
.
««Q R
AffiliateId
««R ]
)
««] ^
;
««^ _
var
»» 
	existsKey
»» 
=
»» 
await
»» 
_redisCache
»» )
.
»») *
	KeyExists
»»* 3
(
»»3 4
key
»»4 7
)
»»7 8
;
»»8 9
if
   

(
   
	existsKey
   
)
   
await
ÀÀ 
_redisCache
ÀÀ 
.
ÀÀ 
Delete
ÀÀ $
(
ÀÀ$ %
key
ÀÀ% (
)
ÀÀ( )
;
ÀÀ) *
}
ÃÃ 
}ÕÕ £Î
_C:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\CoinPaymentsPaymentStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
;. /
public 
class '
CoinPaymentsPaymentStrategy (
:) *(
ICoinPaymentsPaymentStrategy+ G
{ 
private 
readonly 
IInvoiceRepository '
_invoiceRepository. @
;@ A
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter. D
;D E
private 
readonly  
IEcosystemPdfService ) 
_ecosystemPdfService/ C
;C D
private 
readonly 
IBrevoEmailService '
_brevoEmailService. @
;@ A
private 
readonly 
IWalletRepository &
_walletRepository. ?
;? @
private 
readonly 
IRecyCoinPdfService (
_recyCoinPdfService) <
;< =
public 
'
CoinPaymentsPaymentStrategy &
(& '
IInvoiceRepository' 9
invoiceRepository: K
,K L$
IInventoryServiceAdapterQ i$
inventoryServiceAdapter	j Å
,
Å Ç"
IAccountServiceAdapter !
accountServiceAdapter: O
,O P
IBrevoEmailServiceQ c
brevoEmailServicej {
,{ | 
IEcosystemPdfService 
ecosystemPdfService 0
,0 1
IWalletRepository2 C
walletRepositoryD T
,T U
IRecyCoinPdfServiceU h
recyCoinPdfServicei {
){ |
{ 
_invoiceRepository 
=! "
invoiceRepository# 4
;4 5$
_inventoryServiceAdapter  
=! "#
inventoryServiceAdapter# :
;: ;"
_accountServiceAdapter 
=! "!
accountServiceAdapter# 8
;8 9
_brevoEmailService 
=! "
brevoEmailService# 4
;4 5 
_ecosystemPdfService   
=  ! "
ecosystemPdfService  # 6
;  6 7
_walletRepository!! 
=!!! "
walletRepository!!# 3
;!!3 4
_recyCoinPdfService"" 
=""! "
recyCoinPdfService""# 5
;""5 6
}## 
private%% 
async%% 
Task%% 
<%% 

Dictionary%% !
<%%! "
string%%" (
,%%( )
byte%%* .
[%%. /
]%%/ 0
>%%0 1
>%%1 2*
GetPdfContentForTradingAcademy%%3 Q
(%%Q R
)%%R S
{&& 

Dictionary'' 
<'' 
string'' 
,'' 
byte'' 
[''  
]''  !
>''! "
pdfContents''# .
=''/ 0
new''1 4

Dictionary''5 ?
<''? @
string''@ F
,''F G
byte''H L
[''L M
]''M N
>''N O
(''O P
)''P Q
;''Q R
var)) 
workingDirectory)) 
=)) 
Path)) #
.))# $
GetDirectoryName))$ 4
())4 5
Assembly))5 =
.))= > 
GetExecutingAssembly))> R
())R S
)))S T
.))T U
Location))U ]
)))] ^
;))^ _
var** 
	separator** 
=** 
Path** #
.**# $"
DirectorySeparatorChar**$ :
;**: ;
var,, 
pdfDirectory,, 
=,, 
$",, 
{,, 
workingDirectory,, .
},,. /
{,,/ 0
	separator,,0 9
},,9 :
$str,,: @
{,,@ A
	separator,,A J
},,J K
$str,,K Y
",,Y Z
;,,Z [
var.. 
pdfFiles.. 
=.. 
	Directory..  
...  !
GetFiles..! )
(..) *
pdfDirectory..* 6
,..6 7
$str..8 ?
)..? @
;..@ A
foreach00 
(00 
var00 
pdfFile00 
in00 
pdfFiles00  (
)00( )
{11 	
var22 
fileName22 
=22 
Path22 !
.22! "
GetFileName22" -
(22- .
pdfFile22. 5
)225 6
;226 7
var33 

pdfContent33 
=33 
await33 "
File33# '
.33' (
ReadAllBytesAsync33( 9
(339 :
pdfFile33: A
)33A B
;33B C
pdfContents44 
[44 
fileName44  
]44  !
=44" #

pdfContent44$ .
;44. /
}55 	
return77 
pdfContents77 
;77 
}88 
public:: 

async:: 
Task:: 
<:: 
bool:: 
>:: !
ExecuteEcoPoolPayment:: 1
(::1 2
WalletRequest::2 ?
request::@ G
)::G H
{;; 
var<< 
debit<< 
=<< 
$num<< 
;<<  
var== 
points== 
=== 
$num==  
;==  !
var>> 
commissionable>> 
=>> 
$num>>  
;>>  !
byte?? 
origin?? 
=?? 
$num?? 
;??  
varAA 
invoiceDetailsAA 
=AA 
newAA "
ListAA# '
<AA' (,
 InvoiceDetailsTransactionRequestAA( H
>AAH I
(AAI J
)AAJ K
;AAK L
varBB 
userInfoResponseBB 
=BB 
awaitBB $"
_accountServiceAdapterBB% ;
.BB; <
GetUserInfoBB< G
(BBG H
requestBBH O
.BBO P
AffiliateIdBBP [
,BB[ \
requestBB\ c
.BBc d
BrandIdBBd k
)BBk l
;BBl m
varCC 

productIdsCC 
=CC 
requestCC "
.CC" #
ProductsListCC# /
.CC/ 0
SelectCC0 6
(CC6 7
pCC7 8
=>CC9 ;
pCC< =
.CC= >
	IdProductCC> G
)CCG H
.CCH I
ToArrayCCI P
(CCP Q
)CCQ R
;CCR S
varDD 
responseListDD 
=DD 
awaitDD $$
_inventoryServiceAdapterDD% =
.DD= >
GetProductsIdsDD> L
(DDL M

productIdsDDM W
,DDW X
requestDDX _
.DD_ `
BrandIdDD` g
)DDg h
;DDh i
ifFF 

(FF 
!FF 
responseListFF 
.FF 
IsSuccessfulFF &
)FF& '
returnGG 
falseGG 
;GG 
ifII 

(II 
stringII 
.II 
IsNullOrEmptyII  
(II  !
responseListII! -
.II- .
ContentII. 5
)II5 6
)II6 7
returnJJ 
falseJJ 
;JJ 
varLL 
resultLL 
=LL 
responseListLL !
.LL! "
ContentLL" )
.LL) *
ToJsonObjectLL* 6
<LL6 7
ProductsResponseLL7 G
>LLG H
(LLH I
)LLI J
;LLJ K
ifNN 

(NN 
resultNN 
?NN 
.NN 
DataNN 
.NN 
CountNN 
==NN !
	ConstantsNN" +
.NN+ ,

EmptyValueNN, 6
)NN6 7
{OO 	
varPP 
firstProductIdPP 
=PP! "
requestPP# *
.PP* +
ProductsListPP+ 7
.PP7 8
FirstPP8 =
(PP= >
)PP> ?
.PP? @
	IdProductPP@ I
;PPI J
varQQ 
membershipResultQQ  
=QQ! "
awaitQQ# ($
_inventoryServiceAdapterQQ) A
.QQA B
GetProductByIdQQB P
(QQP Q
firstProductIdQQQ _
,QQ_ `
requestQQ` g
.QQg h
BrandIdQQh o
)QQo p
;QQp q
varSS 
productResponseSS 
=SS  !
membershipResultSS" 2
.SS2 3
ContentSS3 :
!SS: ;
.SS; <
ToJsonObjectSS< H
<SSH I
ProductResponseSSI X
>SSX Y
(SSY Z
)SSZ [
;SS[ \
awaitUU "
_accountServiceAdapterUU (
.UU( ) 
UpdateActivationDateUU) =
(UU= >
requestUU> E
.UUE F
AffiliateIdUUF Q
,UUQ R
requestUUR Y
.UUY Z
BrandIdUUZ a
)UUa b
;UUb c
resultWW 
.WW 
DataWW 
.WW 
AddWW 
(WW 
productResponseWW +
!WW+ ,
.WW, -
DataWW- 1
)WW1 2
;WW2 3
}XX 	
ifZZ 

(ZZ 
resultZZ 
?ZZ 
.ZZ 
DataZZ 
==ZZ 
nullZZ  
)ZZ  !
return[[ 
false[[ 
;[[ 
if]] 

(]] 
result]] 
.]] 
Data]] 
.]] 
Count]] 
!=]]  
request]]! (
.]]( )
ProductsList]]) 5
.]]5 6
Count]]6 ;
)]]; <
return^^ 
false^^ 
;^^ 
var`` 
productNames`` 
=`` 
result`` !
.``! "
Data``" &
.``& '
Select``' -
(``- .
item``. 2
=>``3 5
item``6 :
.``: ;
Name``; ?
)``? @
.``@ A
ToArray``A H
(``H I
)``I J
;``J K
foreachbb 
(bb 
varbb 
itembb 
inbb 
resultbb #
.bb# $
Databb$ (
)bb( )
{dd 	
varee 
productee 
=ee 
requestee !
.ee! "
ProductsListee" .
.ee. /
FirstOrDefaultee/ =
(ee= >
xee> ?
=>ee@ B
xeeC D
.eeD E
	IdProducteeE N
==eeO Q
itemeeR V
.eeV W
IdeeW Y
)eeY Z
;eeZ [
varff 
taxff 
=ff 
itemff 
.ff 
Taxff "
;ff" #
debitgg 
+=gg 
(gg 
intgg "
)gg" #
(gg# $
(gg$ %
itemgg% )
.gg) *
	SalePricegg* 3
*gg4 5
productgg6 =
!gg= >
.gg> ?
Countgg? D
)ggD E
*ggF G
(ggH I
$numggI J
+ggK L
(ggM N
taxggN Q
/ggR S
$numggT W
)ggW X
)ggX Y
)ggY Z
;ggZ [
pointshh 
+=hh 
itemhh "
.hh" #
BinaryPointshh# /
*hh0 1
producthh2 9
.hh9 :
Counthh: ?
;hh? @
commissionableii 
+=ii 
itemii "
.ii" #
CommissionableValueii# 6
*ii7 8
productii9 @
.ii@ A
CountiiA F
;iiF G
ifjj 
(jj 
itemjj 
.jj 

CategoryIdjj 
==jj  "
$numjj# $
)jj$ %
{kk 
originll 
=ll 
$numll 
;ll 
}mm 
varoo 
invoiceDetailoo 
=oo 
newoo  #,
 InvoiceDetailsTransactionRequestoo$ D
{pp 
	ProductIdqq 
=qq& '
itemqq( ,
.qq, -
Idqq- /
,qq/ 0
PaymentGroupIdrr 
=rr& '
itemrr( ,
.rr, -
PaymentGrouprr- 9
,rr9 :
AccumMinPurchasess  
=ss& '
itemss( ,
.ss, -
AcumCompMinss- 8
,ss8 9
ProductNamett 
=tt& '
itemtt( ,
.tt, -
Namett- 1
!tt1 2
,tt2 3
ProductPriceuu 
=uu& '
itemuu( ,
.uu, -
	SalePriceuu- 6
,uu6 7
ProductPriceBtcvv 
=vv& '
	Constantsvv( 1
.vv1 2

EmptyValuevv2 <
,vv< =

ProductIvaww 
=ww& '
itemww( ,
.ww, -
Taxww- 0
,ww0 1
ProductQuantityxx 
=xx& '
productxx( /
.xx/ 0
Countxx0 5
,xx5 6!
ProductCommissionableyy %
=yy& '
itemyy( ,
.yy, -
CommissionableValueyy- @
,yy@ A
BinaryPointszz 
=zz& '
itemzz( ,
.zz, -
BinaryPointszz- 9
,zz9 :
ProductPoints{{ 
={{& '
item{{( ,
.{{, -
ValuePoints{{- 8
,{{8 9
ProductDiscount|| 
=||& '
item||( ,
.||, -
ProductDiscount||- <
,||< =
CombinationId}} 
=}}& '
	Constants}}( 1
.}}1 2

EmptyValue}}2 <
,}}< =
ProductPack~~ 
=~~& '
item~~( ,
.~~, -
ProductPacks~~- 9
,~~9 :

BaseAmount 
=& '
(( )
item) -
.- .

BaseAmount. 8
*9 :
product; B
.B C
CountC H
)H I
,I J
DailyPercentage
ÄÄ 
=
ÄÄ& '
item
ÄÄ( ,
.
ÄÄ, -
DailyPercentage
ÄÄ- <
,
ÄÄ< =
WaitingDays
ÅÅ 
=
ÅÅ& '
item
ÅÅ( ,
.
ÅÅ, -
DaysWait
ÅÅ- 5
,
ÅÅ5 6
DaysToPayQuantity
ÇÇ !
=
ÇÇ& '
	Constants
ÇÇ( 1
.
ÇÇ1 2
DaysToPayQuantity
ÇÇ2 C
,
ÇÇC D
ProductStart
ÉÉ 
=
ÉÉ& '
false
ÉÉ( -
,
ÉÉ- .
BrandId
ÑÑ 
=
ÑÑ 
request
ÑÑ !
.
ÑÑ! "
BrandId
ÑÑ" )
,
ÑÑ) *
}
ÖÖ 
;
ÖÖ 
invoiceDetails
áá 
.
áá 
Add
áá 
(
áá 
invoiceDetail
áá ,
)
áá, -
;
áá- .
}
àà 	
if
ää 

(
ää 
debit
ää 
==
ää 
	Constants
ää 
.
ää 

EmptyValue
ää )
)
ää) *
return
ãã 
false
ãã 
;
ãã 
if
çç 

(
çç 
invoiceDetails
çç 
.
çç 
Count
çç  
==
çç! #
	Constants
çç$ -
.
çç- .

EmptyValue
çç. 8
)
çç8 9
return
éé 
false
éé 
;
éé 
var
êê %
debitTransactionRequest
êê #
=
êê$ %
new
êê& )%
DebitTransactionRequest
êê* A
{
ëë 	
Debit
íí 
=
íí 
debit
íí  %
,
íí% &
AffiliateId
ìì 
=
ìì 
request
ìì  '
.
ìì' (
AffiliateId
ìì( 3
,
ìì3 4
UserId
îî 
=
îî 
	Constants
îî  )
.
îî) *
AdminUserId
îî* 5
,
îî5 6
ConceptType
ïï 
=
ïï 
WalletConceptType
ïï  1
.
ïï1 2
purchasing_pool
ïï2 A
.
ïïA B
ToString
ïïB J
(
ïïJ K
)
ïïK L
,
ïïL M
Points
ññ 
=
ññ 
points
ññ  &
,
ññ& '
Concept
óó 
=
óó 
	Constants
óó  )
.
óó) *$
EcoPoolProductCategory
óó* @
,
óó@ A
Commissionable
òò 
=
òò 
commissionable
òò  .
,
òò. /
Bank
ôô 
=
ôô 
	Constants
ôô  )
.
ôô) *
CoinPayments
ôô* 6
,
ôô6 7
PaymentMethod
öö 
=
öö 
	Constants
öö  )
.
öö) *
CoinPayments
öö* 6
,
öö6 7
Origin
õõ 
=
õõ 
origin
õõ  &
,
õõ& '
Level
úú 
=
úú 
	Constants
úú  )
.
úú) *

EmptyValue
úú* 4
,
úú4 5
AffiliateUserName
ùù 
=
ùù 
request
ùù  '
.
ùù' (
AffiliateUserName
ùù( 9
,
ùù9 :
AdminUserName
ûû 
=
ûû 
	Constants
ûû  )
.
ûû) *$
AdminEcosystemUserName
ûû* @
,
ûû@ A
ReceiptNumber
üü 
=
üü 
request
üü  '
.
üü' (
ReceiptNumber
üü( 5
,
üü5 6
Type
†† 
=
†† 
true
††  $
,
††$ %
	SecretKey
°° 
=
°° 
request
°°  '
.
°°' (
	SecretKey
°°( 1
,
°°1 2
invoices
¢¢ 
=
¢¢ 
invoiceDetails
¢¢  .
,
¢¢. /
Reason
££ 
=
££ 
string
££  &
.
££& '
Empty
££' ,
,
££, -
BrandId
§§ 
=
§§ 
request
§§ 
.
§§ 
BrandId
§§ %
,
§§% &
}
•• 	
;
••	 

var
ßß 

spResponse
ßß 
=
ßß 
await
ßß  
_invoiceRepository
ßß 1
.
ßß1 2$
HandleDebitTransaction
ßß2 H
(
ßßH I%
debitTransactionRequest
ßßI `
)
ßß` a
;
ßßa b
if
©© 

(
©© 

spResponse
©© 
is
©© 
null
©© 
)
©© 
return
™™ 
false
™™ 
;
™™ 
var
¨¨ 

invoicePdf
¨¨ 
=
¨¨ 
await
¨¨ "
_ecosystemPdfService
¨¨ 3
.
¨¨3 4
GenerateInvoice
¨¨4 C
(
¨¨C D
userInfoResponse
¨¨D T
!
¨¨T U
,
¨¨U V%
debitTransactionRequest
¨¨W n
,
¨¨n o

spResponse
¨¨p z
)
¨¨z {
;
¨¨{ |
var
ÆÆ !
productPdfsContents
ÆÆ 
=
ÆÆ  !
await
ÆÆ" '
CommonExtensions
ÆÆ( 8
.
ÆÆ8 9+
GetPdfContentFromProductNames
ÆÆ9 V
(
ÆÆV W
productNames
ÆÆW c
!
ÆÆc d
)
ÆÆd e
;
ÆÆe f

Dictionary
∞∞ 
<
∞∞ 
string
∞∞ 
,
∞∞ 
byte
∞∞ 
[
∞∞  
]
∞∞  !
>
∞∞! "

allPdfData
∞∞# -
=
∞∞. /
new
∞∞0 3

Dictionary
∞∞4 >
<
∞∞> ?
string
∞∞? E
,
∞∞E F
byte
∞∞G K
[
∞∞K L
]
∞∞L M
>
∞∞M N
{
±± 	
[
≤≤ 
$str
≤≤ 
]
≤≤ 
=
≤≤ 

invoicePdf
≤≤ (
}
≥≥ 	
;
≥≥	 

foreach
µµ 
(
µµ 
var
µµ 
pdfDataEntry
µµ !
in
µµ" $!
productPdfsContents
µµ% 8
)
µµ8 9
{
∂∂ 	

allPdfData
∑∑ 
[
∑∑ 
pdfDataEntry
∑∑ #
.
∑∑# $
Key
∑∑$ '
]
∑∑' (
=
∑∑) *
pdfDataEntry
∑∑+ 7
.
∑∑7 8
Value
∑∑8 =
;
∑∑= >
}
∏∏ 	
if
ππ 

(
ππ 
result
ππ 
.
ππ 
Data
ππ 
.
ππ 
Find
ππ 
(
ππ 
dto
ππ  
=>
ππ! #
dto
ππ$ '
.
ππ' (
ProductType
ππ( 3
)
ππ3 4
!=
ππ5 7
null
ππ8 <
)
ππ< =
{
∫∫ 	
await
ªª  
_brevoEmailService
ªª $
.
ªª$ %
SendEmailWelcome
ªª% 5
(
ªª5 6
userInfoResponse
ªª6 F
!
ªªF G
,
ªªG H

spResponse
ªªI S
,
ªªS T
request
ªªT [
.
ªª[ \
BrandId
ªª\ c
)
ªªc d
;
ªªd e
}
ºº 	
if
ææ 

(
ææ 

invoicePdf
ææ 
.
ææ 
Length
ææ 
!=
ææ  
	Constants
ææ! *
.
ææ* +

EmptyValue
ææ+ 5
)
ææ5 6
{
øø 	
await
¿¿  
_brevoEmailService
¿¿ $
.
¿¿$ %&
SendEmailPurchaseConfirm
¿¿% =
(
¿¿= >
userInfoResponse
¿¿> N
!
¿¿N O
,
¿¿O P

allPdfData
¿¿Q [
,
¿¿[ \

spResponse
¿¿] g
,
¿¿g h
request
¿¿h o
.
¿¿o p
BrandId
¿¿p w
)
¿¿w x
;
¿¿x y
}
¡¡ 	
return
√√ 
true
√√ 
;
√√ 
}
ƒƒ 
public
∆∆ 

async
∆∆ 
Task
∆∆ 
<
∆∆ 
bool
∆∆ 
>
∆∆ "
ExecuteCoursePayment
∆∆ 0
(
∆∆0 1
WalletRequest
∆∆1 >
request
∆∆? F
)
∆∆F G
{
«« 
var
»» 
debit
»» 
=
»» 
$num
»»  
;
»»  !
var
…… 
points
…… 
=
…… 
$num
……  
;
……  !
var
   
commissionable
   
=
   
$num
    
;
    !
byte
ÀÀ 
origin
ÀÀ 
=
ÀÀ 
$num
ÀÀ 
;
ÀÀ  
var
ÕÕ 
invoiceDetails
ÕÕ 
=
ÕÕ 
new
ÕÕ "
List
ÕÕ# '
<
ÕÕ' (.
 InvoiceDetailsTransactionRequest
ÕÕ( H
>
ÕÕH I
(
ÕÕI J
)
ÕÕJ K
;
ÕÕK L
var
ŒŒ 
userInfoResponse
ŒŒ 
=
ŒŒ 
await
ŒŒ $$
_accountServiceAdapter
ŒŒ% ;
.
ŒŒ; <
GetUserInfo
ŒŒ< G
(
ŒŒG H
request
ŒŒH O
.
ŒŒO P
AffiliateId
ŒŒP [
,
ŒŒ[ \
request
ŒŒ\ c
.
ŒŒc d
BrandId
ŒŒd k
)
ŒŒk l
;
ŒŒl m
var
œœ 

productIds
œœ 
=
œœ 
request
œœ &
.
œœ& '
ProductsList
œœ' 3
.
œœ3 4
Select
œœ4 :
(
œœ: ;
p
œœ; <
=>
œœ= ?
p
œœ@ A
.
œœA B
	IdProduct
œœB K
)
œœK L
.
œœL M
ToArray
œœM T
(
œœT U
)
œœU V
;
œœV W
var
–– 
responseList
–– 
=
–– 
await
–– $&
_inventoryServiceAdapter
––% =
.
––= >
GetProductsIds
––> L
(
––L M

productIds
––M W
,
––W X
request
––X _
.
––_ `
BrandId
––` g
)
––g h
;
––h i
if
““ 

(
““ 
!
““ 
responseList
““ 
.
““ 
IsSuccessful
““ &
)
““& '
return
”” 
false
”” 
;
”” 
if
’’ 

(
’’ 
string
’’ 
.
’’ 
IsNullOrEmpty
’’  
(
’’  !
responseList
’’! -
.
’’- .
Content
’’. 5
)
’’5 6
)
’’6 7
return
÷÷ 
false
÷÷ 
;
÷÷ 
var
ÿÿ 
result
ÿÿ 
=
ÿÿ 
responseList
ÿÿ !
.
ÿÿ! "
Content
ÿÿ" )
.
ÿÿ) *
ToJsonObject
ÿÿ* 6
<
ÿÿ6 7
ProductsResponse
ÿÿ7 G
>
ÿÿG H
(
ÿÿH I
)
ÿÿI J
;
ÿÿJ K
if
⁄⁄ 

(
⁄⁄ 
result
⁄⁄ 
?
⁄⁄ 
.
⁄⁄ 
Data
⁄⁄ 
==
⁄⁄ 
null
⁄⁄  
)
⁄⁄  !
return
€€ 
false
€€ 
;
€€ 
if
›› 

(
›› 
result
›› 
.
›› 
Data
›› 
.
›› 
Count
›› 
!=
››  
request
››! (
.
››( )
ProductsList
››) 5
.
››5 6
Count
››6 ;
)
››; <
return
ﬁﬁ 
false
ﬁﬁ 
;
ﬁﬁ 
foreach
‡‡ 
(
‡‡ 
var
‡‡ 
item
‡‡ 
in
‡‡ 
result
‡‡ #
.
‡‡# $
Data
‡‡$ (
)
‡‡( )
{
·· 	
var
‚‚ 
product
‚‚ 
=
‚‚ 
request
‚‚ !
.
‚‚! "
ProductsList
‚‚" .
.
‚‚. /
FirstOrDefault
‚‚/ =
(
‚‚= >
x
‚‚> ?
=>
‚‚@ B
x
‚‚C D
.
‚‚D E
	IdProduct
‚‚E N
==
‚‚O Q
item
‚‚R V
.
‚‚V W
Id
‚‚W Y
)
‚‚Y Z
;
‚‚Z [
var
„„ 
tax
„„ 
=
„„ 
item
„„ 
.
„„ 
Tax
„„ "
;
„„" #
debit
‰‰ 
+=
‰‰ 
(
‰‰ 
item
‰‰ #
.
‰‰# $
	SalePrice
‰‰$ -
*
‰‰. /
product
‰‰0 7
!
‰‰7 8
.
‰‰8 9
Count
‰‰9 >
)
‰‰> ?
*
‰‰@ A
(
‰‰B C
$num
‰‰C D
+
‰‰E F
(
‰‰G H
tax
‰‰H K
/
‰‰L M
$num
‰‰N Q
)
‰‰Q R
)
‰‰R S
;
‰‰S T
points
ÂÂ 
+=
ÂÂ 
item
ÂÂ "
.
ÂÂ" #
BinaryPoints
ÂÂ# /
*
ÂÂ0 1
product
ÂÂ2 9
.
ÂÂ9 :
Count
ÂÂ: ?
;
ÂÂ? @
commissionable
ÊÊ 
+=
ÊÊ 
item
ÊÊ "
.
ÊÊ" #!
CommissionableValue
ÊÊ# 6
*
ÊÊ7 8
product
ÊÊ9 @
.
ÊÊ@ A
Count
ÊÊA F
;
ÊÊF G
if
ÁÁ 
(
ÁÁ 
item
ÁÁ 
.
ÁÁ 

CategoryId
ÁÁ 
==
ÁÁ  "
$num
ÁÁ# $
)
ÁÁ$ %
{
ËË 
origin
ÈÈ 
=
ÈÈ 
$num
ÈÈ 
;
ÈÈ 
}
ÍÍ 
var
ÏÏ 
invoiceDetail
ÏÏ 
=
ÏÏ 
new
ÏÏ  #.
 InvoiceDetailsTransactionRequest
ÏÏ$ D
{
ÌÌ 
	ProductId
ÓÓ 
=
ÓÓ& '
item
ÓÓ( ,
.
ÓÓ, -
Id
ÓÓ- /
,
ÓÓ/ 0
PaymentGroupId
ÔÔ 
=
ÔÔ& '
item
ÔÔ( ,
.
ÔÔ, -
PaymentGroup
ÔÔ- 9
,
ÔÔ9 :
AccumMinPurchase
  
=
& '
item
( ,
.
, -
AcumCompMin
- 8
,
8 9
ProductName
ÒÒ 
=
ÒÒ& '
item
ÒÒ( ,
.
ÒÒ, -
Name
ÒÒ- 1
!
ÒÒ1 2
,
ÒÒ2 3
ProductPrice
ÚÚ 
=
ÚÚ& '
item
ÚÚ( ,
.
ÚÚ, -
	SalePrice
ÚÚ- 6
,
ÚÚ6 7
ProductPriceBtc
ÛÛ 
=
ÛÛ& '
	Constants
ÛÛ( 1
.
ÛÛ1 2

EmptyValue
ÛÛ2 <
,
ÛÛ< =

ProductIva
ÙÙ 
=
ÙÙ& '
item
ÙÙ( ,
.
ÙÙ, -
Tax
ÙÙ- 0
,
ÙÙ0 1
ProductQuantity
ıı 
=
ıı& '
product
ıı( /
.
ıı/ 0
Count
ıı0 5
,
ıı5 6#
ProductCommissionable
ˆˆ %
=
ˆˆ& '
item
ˆˆ( ,
.
ˆˆ, -!
CommissionableValue
ˆˆ- @
,
ˆˆ@ A
BinaryPoints
˜˜ 
=
˜˜& '
item
˜˜( ,
.
˜˜, -
BinaryPoints
˜˜- 9
,
˜˜9 :
ProductPoints
¯¯ 
=
¯¯& '
item
¯¯( ,
.
¯¯, -
ValuePoints
¯¯- 8
,
¯¯8 9
ProductDiscount
˘˘ 
=
˘˘& '
item
˘˘( ,
.
˘˘, -
ProductDiscount
˘˘- <
,
˘˘< =
CombinationId
˙˙ 
=
˙˙& '
	Constants
˙˙( 1
.
˙˙1 2

EmptyValue
˙˙2 <
,
˙˙< =
ProductPack
˚˚ 
=
˚˚& '
item
˚˚( ,
.
˚˚, -
ProductPacks
˚˚- 9
,
˚˚9 :

BaseAmount
¸¸ 
=
¸¸& '
(
¸¸( )
item
¸¸) -
.
¸¸- .

BaseAmount
¸¸. 8
*
¸¸9 :
product
¸¸; B
.
¸¸B C
Count
¸¸C H
)
¸¸H I
,
¸¸I J
DailyPercentage
˝˝ 
=
˝˝& '
item
˝˝( ,
.
˝˝, -
DailyPercentage
˝˝- <
,
˝˝< =
WaitingDays
˛˛ 
=
˛˛& '
item
˛˛( ,
.
˛˛, -
DaysWait
˛˛- 5
,
˛˛5 6
DaysToPayQuantity
ˇˇ !
=
ˇˇ& '
	Constants
ˇˇ( 1
.
ˇˇ1 2
DaysToPayQuantity
ˇˇ2 C
,
ˇˇC D
ProductStart
ÄÄ 
=
ÄÄ& '
false
ÄÄ( -
,
ÄÄ- .
BrandId
ÅÅ 
=
ÅÅ 
request
ÅÅ !
.
ÅÅ! "
BrandId
ÅÅ" )
,
ÅÅ) *
}
ÇÇ 
;
ÇÇ 
invoiceDetails
ÑÑ 
.
ÑÑ 
Add
ÑÑ 
(
ÑÑ 
invoiceDetail
ÑÑ ,
)
ÑÑ, -
;
ÑÑ- .
}
ÖÖ 	
if
áá 

(
áá 
debit
áá 
==
áá 
	Constants
áá 
.
áá 

EmptyValue
áá )
)
áá) *
return
àà 
false
àà 
;
àà 
if
ää 

(
ää 
invoiceDetails
ää 
.
ää 
Count
ää  
==
ää! #
	Constants
ää$ -
.
ää- .

EmptyValue
ää. 8
)
ää8 9
return
ãã 
false
ãã 
;
ãã 
var
çç %
debitTransactionRequest
çç #
=
çç$ %
new
çç& )%
DebitTransactionRequest
çç* A
{
éé 	
Debit
èè 
=
èè 
debit
èè  %
,
èè% &
AffiliateId
êê 
=
êê 
request
êê  '
.
êê' (
AffiliateId
êê( 3
,
êê3 4
UserId
ëë 
=
ëë 
	Constants
ëë  )
.
ëë) *
AdminUserId
ëë* 5
,
ëë5 6
ConceptType
íí 
=
íí 
WalletConceptType
íí  1
.
íí1 2
purchasing_pool
íí2 A
.
ííA B
ToString
ííB J
(
ííJ K
)
ííK L
,
ííL M
Points
ìì 
=
ìì 
points
ìì  &
,
ìì& '
Concept
îî 
=
îî 
	Constants
îî  )
.
îî) *$
EcoPoolProductCategory
îî* @
,
îî@ A
Commissionable
ïï 
=
ïï 
commissionable
ïï  .
,
ïï. /
Bank
ññ 
=
ññ 
	Constants
ññ  )
.
ññ) *
CoinPayments
ññ* 6
,
ññ6 7
PaymentMethod
óó 
=
óó 
	Constants
óó  )
.
óó) *
CoinPayments
óó* 6
,
óó6 7
Origin
òò 
=
òò 
origin
òò  &
,
òò& '
Level
ôô 
=
ôô 
	Constants
ôô  )
.
ôô) *

EmptyValue
ôô* 4
,
ôô4 5
AffiliateUserName
öö 
=
öö 
request
öö  '
.
öö' (
AffiliateUserName
öö( 9
,
öö9 :
AdminUserName
õõ 
=
õõ 
	Constants
õõ  )
.
õõ) *$
AdminEcosystemUserName
õõ* @
,
õõ@ A
ReceiptNumber
úú 
=
úú 
request
úú  '
.
úú' (
ReceiptNumber
úú( 5
,
úú5 6
Type
ùù 
=
ùù 
true
ùù  $
,
ùù$ %
	SecretKey
ûû 
=
ûû 
request
ûû  '
.
ûû' (
	SecretKey
ûû( 1
,
ûû1 2
invoices
üü 
=
üü 
invoiceDetails
üü  .
,
üü. /
Reason
†† 
=
†† 
string
††  &
.
††& '
Empty
††' ,
,
††0 1
BrandId
°° 
=
°° 
request
°° 
.
°° 
BrandId
°° %
,
°°% &
}
¢¢ 	
;
¢¢	 

var
§§ 
	hasCourse
§§ 
=
§§ 
await
§§  
_invoiceRepository
§§ 1
.
§§1 23
%GetInvoicesForTradingAcademyPurchases
§§2 W
(
§§W X
request
§§X _
.
§§_ `
AffiliateId
§§` k
)
§§k l
;
§§l m
var
•• 

spResponse
•• 
=
•• 
await
••  
_invoiceRepository
•• 1
.
••1 2$
HandleDebitTransaction
••2 H
(
••H I%
debitTransactionRequest
••I `
)
••` a
;
••a b
if
ßß 

(
ßß 

spResponse
ßß 
is
ßß 
null
ßß 
)
ßß 
return
®® 
false
®® 
;
®® 

Dictionary
™™ 
<
™™ 
string
™™ 
,
™™ 
byte
™™ 
[
™™  
]
™™  !
>
™™! "

allPdfData
™™# -
=
™™. /
new
™™0 3

Dictionary
™™4 >
<
™™> ?
string
™™? E
,
™™E F
byte
™™G K
[
™™K L
]
™™L M
>
™™M N
(
™™N O
)
™™O P
;
™™P Q
var
´´ 

invoicePdf
´´# -
=
´´. /
await
´´0 5"
_ecosystemPdfService
´´6 J
.
´´J K
GenerateInvoice
´´K Z
(
´´Z [
userInfoResponse
´´[ k
!
´´k l
,
´´l m&
debitTransactionRequest´´n Ö
,´´Ö Ü

spResponse´´á ë
)´´ë í
;´´í ì

allPdfData
≠≠ 
[
≠≠ 
$str
≠≠  
]
≠≠  !
=
≠≠" #

invoicePdf
≠≠$ .
;
≠≠. /
if
ØØ 

(
ØØ 
!
ØØ 
	hasCourse
ØØ 
&&
ØØ 

invoicePdf
ØØ $
.
ØØ$ %
Length
ØØ% +
!=
ØØ, .
	Constants
ØØ/ 8
.
ØØ8 9

EmptyValue
ØØ9 C
)
ØØC D
{
∞∞ 	
var
±± 
pdfContents
±± 
=
±± 
await
±± #,
GetPdfContentForTradingAcademy
±±$ B
(
±±B C
)
±±C D
;
±±D E
foreach
≤≤ 
(
≤≤ 
var
≤≤ 
pdf
≤≤ 
in
≤≤ 
pdfContents
≤≤  +
)
≤≤+ ,
{
≥≥ 

allPdfData
¥¥ 
[
¥¥ 
pdf
¥¥ 
.
¥¥ 
Key
¥¥ "
]
¥¥" #
=
¥¥$ %
pdf
¥¥& )
.
¥¥) *
Value
¥¥* /
;
¥¥/ 0
}
µµ 
await
∂∂  
_brevoEmailService
∂∂ $
.
∂∂$ %0
"SendEmailPurchaseConfirmForAcademy
∂∂% G
(
∂∂G H
userInfoResponse
∂∂H X
!
∂∂X Y
,
∂∂Y Z

allPdfData
∂∂[ e
,
∂∂e f

spResponse
∂∂g q
,
∂∂q r
request
∂∂r y
.
∂∂y z
BrandId∂∂z Å
)∂∂Å Ç
;∂∂Ç É
}
∑∑ 	
else
∏∏ 
if
∏∏ 
(
∏∏ 

invoicePdf
∏∏ 
.
∏∏ 
Length
∏∏ "
!=
∏∏# %
	Constants
∏∏& /
.
∏∏/ 0

EmptyValue
∏∏0 :
)
∏∏: ;
{
ππ 	
await
∫∫  
_brevoEmailService
∫∫ $
.
∫∫$ %&
SendEmailPurchaseConfirm
∫∫% =
(
∫∫= >
userInfoResponse
∫∫> N
!
∫∫N O
,
∫∫O P

allPdfData
∫∫Q [
,
∫∫[ \

spResponse
∫∫] g
,
∫∫g h
request
∫∫h o
.
∫∫o p
BrandId
∫∫p w
)
∫∫w x
;
∫∫x y
}
ªª 	
return
ΩΩ 
true
ΩΩ 
;
ΩΩ 
}
ææ 
public
øø 

async
øø 
Task
øø 
<
øø 
bool
øø 
>
øø &
ExecuteMembershipPayment
øø 4
(
øø4 5
WalletRequest
øø5 B
request
øøC J
)
øøJ K
{
¿¿ 
var
¡¡ 
debit
¡¡ 
=
¡¡ 
$num
¡¡ 
;
¡¡  
var
¬¬ 
points
¬¬ 
=
¬¬ 
$num
¬¬  
;
¬¬  !
var
√√ 
commissionable
√√ 
=
√√ 
$num
√√  
;
√√  !
byte
ƒƒ 
origin
ƒƒ 
=
ƒƒ 
$num
ƒƒ 
;
ƒƒ  
var
∆∆ 
invoiceDetails
∆∆ 
=
∆∆! "
new
∆∆# &
List
∆∆' +
<
∆∆+ ,.
 InvoiceDetailsTransactionRequest
∆∆, L
>
∆∆L M
(
∆∆M N
)
∆∆N O
;
∆∆O P
var
«« 
userInfoResponse
«« 
=
««! "
await
««# ($
_accountServiceAdapter
««) ?
.
««? @
GetUserInfo
««@ K
(
««K L
request
««L S
.
««S T
AffiliateId
««T _
,
««_ `
request
««` g
.
««g h
BrandId
««h o
)
««o p
;
««p q
var
»» "
affiliateBonusWinner
»»  
=
»»! "
await
»»# ($
_accountServiceAdapter
»») ?
.
»»? @
GetUserInfo
»»@ K
(
»»K L
userInfoResponse
»»L \
!
»»\ ]
.
»»] ^
Father
»»^ d
,
»»d e
request
»»e l
.
»»l m
BrandId
»»m t
)
»»t u
;
»»u v
var
   
firstProductId
   
=
   
request
   &
.
  & '
ProductsList
  ' 3
.
  3 4
First
  4 9
(
  9 :
)
  : ;
.
  ; <
	IdProduct
  < E
;
  E F
var
ÀÀ 
membershipResult
ÀÀ 
=
ÀÀ 
await
ÀÀ $&
_inventoryServiceAdapter
ÀÀ% =
.
ÀÀ= >
GetProductById
ÀÀ> L
(
ÀÀL M
firstProductId
ÀÀM [
,
ÀÀ[ \
request
ÀÀ\ c
.
ÀÀc d
BrandId
ÀÀd k
)
ÀÀk l
;
ÀÀl m
var
ÕÕ 
productResponse
ÕÕ 
=
ÕÕ 
membershipResult
ÕÕ .
.
ÕÕ. /
Content
ÕÕ/ 6
!
ÕÕ6 7
.
ÕÕ7 8
ToJsonObject
ÕÕ8 D
<
ÕÕD E
ProductResponse
ÕÕE T
>
ÕÕT U
(
ÕÕU V
)
ÕÕV W
;
ÕÕW X
if
œœ 

(
œœ 
productResponse
œœ 
?
œœ 
.
œœ 
Data
œœ !
==
œœ" $
null
œœ% )
)
œœ) *
return
–– 
false
–– 
;
–– 
var
““ 
item
““ 
=
““ 
productResponse
““ %
.
““% &
Data
““& *
;
““* +
var
”” 
product
”” 
=
”” 
request
”” 
.
”” 
ProductsList
”” *
.
””* +
FirstOrDefault
””+ 9
(
””9 :
x
””: ;
=>
””< >
x
””? @
.
””@ A
	IdProduct
””A J
==
””K M
item
””N R
.
””R S
Id
””S U
)
””U V
;
””V W
if
‘‘ 

(
‘‘ 
product
‘‘ 
!=
‘‘ 
null
‘‘ 
)
‘‘ 
{
’’ 	
var
÷÷ 
tax
÷÷ 
=
÷÷ 
item
÷÷ 
.
÷÷ 
Tax
÷÷ 
;
÷÷ 
debit
◊◊ 
+=
◊◊ 
(
◊◊ 
int
◊◊ "
)
◊◊" #
(
◊◊# $
(
◊◊$ %
item
◊◊% )
.
◊◊) *
	SalePrice
◊◊* 3
*
◊◊4 5
product
◊◊6 =
.
◊◊= >
Count
◊◊> C
)
◊◊C D
*
◊◊E F
(
◊◊G H
$num
◊◊H I
+
◊◊J K
(
◊◊L M
tax
◊◊M P
/
◊◊Q R
$num
◊◊S V
)
◊◊V W
)
◊◊W X
)
◊◊X Y
;
◊◊Y Z
points
ÿÿ 
+=
ÿÿ 
item
ÿÿ "
.
ÿÿ" #
BinaryPoints
ÿÿ# /
*
ÿÿ0 1
product
ÿÿ2 9
.
ÿÿ9 :
Count
ÿÿ: ?
;
ÿÿ? @
commissionable
ŸŸ 
+=
ŸŸ 
item
ŸŸ "
.
ŸŸ" #!
CommissionableValue
ŸŸ# 6
*
ŸŸ7 8
product
ŸŸ9 @
.
ŸŸ@ A
Count
ŸŸA F
;
ŸŸF G
if
⁄⁄ 
(
⁄⁄ 
item
⁄⁄ 
.
⁄⁄ 

CategoryId
⁄⁄ 
==
⁄⁄  "
$num
⁄⁄# $
)
⁄⁄$ %
{
€€ 
origin
‹‹ 
=
‹‹ 
$num
‹‹ 
;
‹‹ 
}
›› 
var
ﬂﬂ 
invoiceDetail
ﬂﬂ 
=
ﬂﬂ 
new
ﬂﬂ  #.
 InvoiceDetailsTransactionRequest
ﬂﬂ$ D
{
‡‡ 
	ProductId
·· 
=
··& '
item
··( ,
.
··, -
Id
··- /
,
··/ 0
PaymentGroupId
‚‚ 
=
‚‚& '
item
‚‚( ,
.
‚‚, -
PaymentGroup
‚‚- 9
,
‚‚9 :
AccumMinPurchase
„„  
=
„„& '
item
„„( ,
.
„„, -
AcumCompMin
„„- 8
,
„„8 9
ProductName
‰‰ 
=
‰‰& '
item
‰‰( ,
.
‰‰, -
Name
‰‰- 1
!
‰‰1 2
,
‰‰2 3
ProductPrice
ÂÂ 
=
ÂÂ& '
item
ÂÂ( ,
.
ÂÂ, -
	SalePrice
ÂÂ- 6
,
ÂÂ6 7
ProductPriceBtc
ÊÊ 
=
ÊÊ& '
	Constants
ÊÊ( 1
.
ÊÊ1 2

EmptyValue
ÊÊ2 <
,
ÊÊ< =

ProductIva
ÁÁ 
=
ÁÁ& '
item
ÁÁ( ,
.
ÁÁ, -
Tax
ÁÁ- 0
,
ÁÁ0 1
ProductQuantity
ËË 
=
ËË& '
product
ËË( /
.
ËË/ 0
Count
ËË0 5
,
ËË5 6#
ProductCommissionable
ÈÈ %
=
ÈÈ& '
item
ÈÈ( ,
.
ÈÈ, -!
CommissionableValue
ÈÈ- @
,
ÈÈ@ A
BinaryPoints
ÍÍ 
=
ÍÍ& '
item
ÍÍ( ,
.
ÍÍ, -
BinaryPoints
ÍÍ- 9
,
ÍÍ9 :
ProductPoints
ÎÎ 
=
ÎÎ& '
item
ÎÎ( ,
.
ÎÎ, -
ValuePoints
ÎÎ- 8
,
ÎÎ8 9
ProductDiscount
ÏÏ 
=
ÏÏ& '
	Constants
ÏÏ( 1
.
ÏÏ1 2

EmptyValue
ÏÏ2 <
,
ÏÏ< =
CombinationId
ÌÌ 
=
ÌÌ& '
	Constants
ÌÌ( 1
.
ÌÌ1 2

EmptyValue
ÌÌ2 <
,
ÌÌ< =
ProductPack
ÓÓ 
=
ÓÓ& '
item
ÓÓ( ,
.
ÓÓ, -
ProductPacks
ÓÓ- 9
,
ÓÓ9 :

BaseAmount
ÔÔ 
=
ÔÔ& '
item
ÔÔ( ,
.
ÔÔ, -

BaseAmount
ÔÔ- 7
,
ÔÔ7 8
DailyPercentage
 
=
& '
item
( ,
.
, -
DailyPercentage
- <
,
< =
WaitingDays
ÒÒ 
=
ÒÒ& '
item
ÒÒ( ,
.
ÒÒ, -
DaysWait
ÒÒ- 5
,
ÒÒ5 6
DaysToPayQuantity
ÚÚ !
=
ÚÚ& '
	Constants
ÚÚ( 1
.
ÚÚ1 2

EmptyValue
ÚÚ2 <
,
ÚÚ< =
ProductStart
ÛÛ 
=
ÛÛ& '
false
ÛÛ( -
,
ÛÛ- .
BrandId
ÙÙ 
=
ÙÙ 
request
ÙÙ !
.
ÙÙ! "
BrandId
ÙÙ" )
,
ÙÙ) *
}
ıı 
;
ıı 
invoiceDetails
˜˜ 
.
˜˜ 
Add
˜˜ 
(
˜˜ 
invoiceDetail
˜˜ ,
)
˜˜, -
;
˜˜- .
}
¯¯ 	
if
˙˙ 

(
˙˙ 
debit
˙˙ 
==
˙˙ 
	Constants
˙˙ 
.
˙˙ 

EmptyValue
˙˙ )
)
˙˙) *
return
˚˚ 
false
˚˚ 
;
˚˚ 
if
˝˝ 

(
˝˝ 
invoiceDetails
˝˝ 
.
˝˝ 
Count
˝˝  
==
˝˝! #
	Constants
˝˝$ -
.
˝˝- .

EmptyValue
˝˝. 8
)
˝˝8 9
return
˛˛ 
false
˛˛ 
;
˛˛ 
var
ÄÄ %
debitTransactionRequest
ÄÄ #
=
ÄÄ$ %
new
ÄÄ& )%
DebitTransactionRequest
ÄÄ* A
{
ÅÅ 	
Debit
ÇÇ 
=
ÇÇ 
debit
ÇÇ  %
,
ÇÇ% &
AffiliateId
ÉÉ 
=
ÉÉ 
request
ÉÉ  '
.
ÉÉ' (
AffiliateId
ÉÉ( 3
,
ÉÉ3 4
UserId
ÑÑ 
=
ÑÑ 
	Constants
ÑÑ  )
.
ÑÑ) *
AdminUserId
ÑÑ* 5
,
ÑÑ5 6
ConceptType
ÖÖ 
=
ÖÖ 
WalletConceptType
ÖÖ  1
.
ÖÖ1 2
purchasing_pool
ÖÖ2 A
.
ÖÖA B
ToString
ÖÖB J
(
ÖÖJ K
)
ÖÖK L
,
ÖÖL M
Points
ÜÜ 
=
ÜÜ 
points
ÜÜ  &
,
ÜÜ& '
Concept
áá 
=
áá 
	Constants
áá  )
.
áá) *

Membership
áá* 4
,
áá4 5
Commissionable
àà 
=
àà 
commissionable
àà  .
,
àà. /
Bank
ââ 
=
ââ 
	Constants
ââ  )
.
ââ) *
CoinPayments
ââ* 6
,
ââ6 7
PaymentMethod
ää 
=
ää 
	Constants
ää  )
.
ää) *
CoinPayments
ää* 6
,
ää6 7
Origin
ãã 
=
ãã 
origin
ãã  &
,
ãã& '
Level
åå 
=
åå 
	Constants
åå  )
.
åå) *

EmptyValue
åå* 4
,
åå4 5
AffiliateUserName
çç 
=
çç 
request
çç  '
.
çç' (
AffiliateUserName
çç( 9
,
çç9 :
AdminUserName
éé 
=
éé 
	Constants
éé  )
.
éé) *$
AdminEcosystemUserName
éé* @
,
éé@ A
ReceiptNumber
èè 
=
èè 
request
èè  '
.
èè' (
ReceiptNumber
èè( 5
,
èè5 6
Type
êê 
=
êê 
true
êê  $
,
êê$ %
	SecretKey
ëë 
=
ëë 
request
ëë  '
.
ëë' (
	SecretKey
ëë( 1
,
ëë1 2
invoices
íí 
=
íí 
invoiceDetails
íí  .
,
íí. /
Reason
ìì 
=
ìì 
string
ìì  &
.
ìì& '
Empty
ìì' ,
,
ìì/ 0
BrandId
îî 
=
îî 
request
îî 
.
îî 
BrandId
îî %
,
îî% &
}
ïï 	
;
ïï	 

var
óó 

spResponse
óó 
=
óó 
await
óó 
_walletRepository
óó 0
.
óó0 1)
HandleMembershipTransaction
óó1 L
(
óóL M%
debitTransactionRequest
óóM d
)
óód e
;
óóe f
if
ôô 

(
ôô 

spResponse
ôô 
is
ôô 
null
ôô 
)
ôô 
return
öö 
false
öö 
;
öö 
await
úú $
_accountServiceAdapter
úú $
.
úú$ %"
UpdateActivationDate
úú% 9
(
úú9 :
request
úú: A
.
úúA B
AffiliateId
úúB M
,
úúM N
request
úúN U
.
úúU V
BrandId
úúV ]
)
úú] ^
;
úú^ _
var
ûû 
	pdfResult
ûû 
=
ûû 
await
ûû "
_ecosystemPdfService
ûû 2
.
ûû2 3
GenerateInvoice
ûû3 B
(
ûûB C
userInfoResponse
ûûC S
,
ûûS T%
debitTransactionRequest
ûûU l
,
ûûl m

spResponse
ûûn x
)
ûûx y
;
ûûy z
await
††  
_brevoEmailService
††  
.
††  !
SendEmailWelcome
††! 1
(
††1 2
userInfoResponse
††2 B
,
††B C

spResponse
††D N
,
††N O
request
††O V
.
††V W
BrandId
††W ^
)
††^ _
;
††_ `
if
¢¢ 

(
¢¢ 
	pdfResult
¢¢ 
.
¢¢ 
Length
¢¢ 
!=
¢¢ 
	Constants
¢¢  )
.
¢¢) *

EmptyValue
¢¢* 4
)
¢¢4 5
{
££ 	
await
§§  
_brevoEmailService
§§ $
.
§§$ %(
SendEmailMembershipConfirm
§§% ?
(
§§? @
userInfoResponse
§§@ P
,
§§P Q
	pdfResult
§§R [
,
§§[ \

spResponse
§§] g
,
§§g h
request
§§h o
.
§§o p
BrandId
§§p w
)
§§w x
;
§§x y
}
•• 	
return
ßß 
true
ßß 
;
ßß 
}
®® 
public
™™ 
async
™™ 
Task
™™ 
<
™™ 
bool
™™ 
>
™™ $
ExecuteRecyCoinPayment
™™ 3
(
™™3 4
WalletRequest
™™4 A
request
™™B I
)
™™I J
{
´´ 
var
¨¨ 
debit
¨¨ 
=
¨¨ 
$num
¨¨ 
;
¨¨ 
var
≠≠ 
points
≠≠ 
=
≠≠ 
$num
≠≠ 
;
≠≠ 
var
ÆÆ 
commissionable
ÆÆ 
=
ÆÆ 
$num
ÆÆ 
;
ÆÆ  
byte
ØØ 
origin
ØØ 
=
ØØ 
$num
ØØ 
;
ØØ 
var
±± 
invoiceDetails
±± 
=
±± 
new
±±  
List
±±! %
<
±±% &.
 InvoiceDetailsTransactionRequest
±±& F
>
±±F G
(
±±G H
)
±±H I
;
±±I J
var
≤≤ 
userInfoResponse
≤≤ 
=
≤≤ 
await
≤≤ $$
_accountServiceAdapter
≤≤% ;
.
≤≤; <
GetUserInfo
≤≤< G
(
≤≤G H
request
≤≤H O
.
≤≤O P
AffiliateId
≤≤P [
,
≤≤[ \
request
≤≤] d
.
≤≤d e
BrandId
≤≤e l
)
≤≤l m
;
≤≤m n
var
≥≥ 

productIds
≥≥ 
=
≥≥ 
request
≥≥  
.
≥≥  !
ProductsList
≥≥! -
.
≥≥- .
Select
≥≥. 4
(
≥≥4 5
p
≥≥5 6
=>
≥≥7 9
p
≥≥: ;
.
≥≥; <
	IdProduct
≥≥< E
)
≥≥E F
.
≥≥F G
ToArray
≥≥G N
(
≥≥N O
)
≥≥O P
;
≥≥P Q
var
¥¥ 
responseList
¥¥ 
=
¥¥ 
await
¥¥  &
_inventoryServiceAdapter
¥¥! 9
.
¥¥9 :
GetProductsIds
¥¥: H
(
¥¥H I

productIds
¥¥I S
,
¥¥S T
request
¥¥U \
.
¥¥\ ]
BrandId
¥¥] d
)
¥¥d e
;
¥¥e f
if
∂∂ 

(
∂∂ 
!
∂∂ 
responseList
∂∂ 
.
∂∂ 
IsSuccessful
∂∂ &
)
∂∂& '
return
∑∑ 
false
∑∑ 
;
∑∑ 
if
ππ 

(
ππ 
string
ππ 
.
ππ 
IsNullOrEmpty
ππ  
(
ππ  !
responseList
ππ! -
.
ππ- .
Content
ππ. 5
)
ππ5 6
)
ππ6 7
return
∫∫ 
false
∫∫ 
;
∫∫ 
var
ºº 
result
ºº 
=
ºº 
JsonSerializer
ºº #
.
ºº# $
Deserialize
ºº$ /
<
ºº/ 0
ProductsResponse
ºº0 @
>
ºº@ A
(
ººA B
responseList
ººB N
.
ººN O
Content
ººO V
)
ººV W
;
ººW X
if
ææ 

(
ææ 
result
ææ 
?
ææ 
.
ææ 
Data
ææ 
.
ææ 
Count
ææ 
==
ææ !
	Constants
ææ" +
.
ææ+ ,

EmptyValue
ææ, 6
)
ææ6 7
{
øø 	
var
¿¿ 
firstProductId
¿¿ 
=
¿¿  
request
¿¿! (
.
¿¿( )
ProductsList
¿¿) 5
.
¿¿5 6
First
¿¿6 ;
(
¿¿; <
)
¿¿< =
.
¿¿= >
	IdProduct
¿¿> G
;
¿¿G H
var
¡¡ 
membershipResult
¡¡  
=
¡¡! "
await
¡¡# (&
_inventoryServiceAdapter
¡¡) A
.
¡¡A B
GetProductById
¡¡B P
(
¡¡P Q
firstProductId
¡¡Q _
,
¡¡_ `
request
¡¡a h
.
¡¡h i
BrandId
¡¡i p
)
¡¡p q
;
¡¡q r
var
√√ 
productResponse
√√ 
=
√√  !
JsonSerializer
√√" 0
.
√√0 1
Deserialize
√√1 <
<
√√< =
ProductResponse
√√= L
>
√√L M
(
√√M N
membershipResult
√√N ^
.
√√^ _
Content
√√_ f
!
√√f g
)
√√g h
;
√√h i
await
≈≈ $
_accountServiceAdapter
≈≈ (
.
≈≈( )"
UpdateActivationDate
≈≈) =
(
≈≈= >
request
≈≈> E
.
≈≈E F
AffiliateId
≈≈F Q
,
≈≈Q R
request
≈≈S Z
.
≈≈Z [
BrandId
≈≈[ b
)
≈≈b c
;
≈≈c d
result
«« 
.
«« 
Data
«« 
.
«« 
Add
«« 
(
«« 
productResponse
«« +
!
««+ ,
.
««, -
Data
««- 1
)
««1 2
;
««2 3
}
»» 	
if
   

(
   
result
   
?
   
.
   
Data
   
==
   
null
    
)
    !
return
ÀÀ 
false
ÀÀ 
;
ÀÀ 
if
ÕÕ 

(
ÕÕ 
result
ÕÕ 
.
ÕÕ 
Data
ÕÕ 
.
ÕÕ 
Count
ÕÕ 
!=
ÕÕ  
request
ÕÕ! (
.
ÕÕ( )
ProductsList
ÕÕ) 5
.
ÕÕ5 6
Count
ÕÕ6 ;
)
ÕÕ; <
return
ŒŒ 
false
ŒŒ 
;
ŒŒ 
foreach
–– 
(
–– 
var
–– 
item
–– 
in
–– 
result
–– #
.
––# $
Data
––$ (
)
––( )
{
—— 	
var
““ 
product
““ 
=
““ 
request
““ !
.
““! "
ProductsList
““" .
.
““. /
FirstOrDefault
““/ =
(
““= >
x
““> ?
=>
““@ B
x
““C D
.
““D E
	IdProduct
““E N
==
““O Q
item
““R V
.
““V W
Id
““W Y
)
““Y Z
;
““Z [
var
”” 
tax
”” 
=
”” 
item
”” 
.
”” 
Tax
”” 
;
”” 
debit
‘‘ 
+=
‘‘ 
(
‘‘ 
int
‘‘ 
)
‘‘ 
(
‘‘ 
(
‘‘ 
item
‘‘  
.
‘‘  !
	SalePrice
‘‘! *
*
‘‘+ ,
product
‘‘- 4
!
‘‘4 5
.
‘‘5 6
Count
‘‘6 ;
)
‘‘; <
*
‘‘= >
(
‘‘? @
$num
‘‘@ A
+
‘‘B C
(
‘‘D E
tax
‘‘E H
/
‘‘I J
$num
‘‘K N
)
‘‘N O
)
‘‘O P
)
‘‘P Q
;
‘‘Q R
points
’’ 
+=
’’ 
item
’’ 
.
’’ 
BinaryPoints
’’ '
*
’’( )
product
’’* 1
.
’’1 2
Count
’’2 7
;
’’7 8
commissionable
÷÷ 
+=
÷÷ 
item
÷÷ "
.
÷÷" #!
CommissionableValue
÷÷# 6
*
÷÷7 8
product
÷÷9 @
.
÷÷@ A
Count
÷÷A F
;
÷÷F G
if
◊◊ 
(
◊◊ 
item
◊◊ 
.
◊◊ 

CategoryId
◊◊ 
==
◊◊  "
$num
◊◊# $
)
◊◊$ %
{
ÿÿ 
origin
ŸŸ 
=
ŸŸ 
$num
ŸŸ 
;
ŸŸ 
}
⁄⁄ 
var
‹‹ 
invoiceDetail
‹‹ 
=
‹‹ 
new
‹‹  #.
 InvoiceDetailsTransactionRequest
‹‹$ D
{
›› 
	ProductId
ﬁﬁ 
=
ﬁﬁ 
item
ﬁﬁ  
.
ﬁﬁ  !
Id
ﬁﬁ! #
,
ﬁﬁ# $
PaymentGroupId
ﬂﬂ 
=
ﬂﬂ  
item
ﬂﬂ! %
.
ﬂﬂ% &
PaymentGroup
ﬂﬂ& 2
,
ﬂﬂ2 3
AccumMinPurchase
‡‡  
=
‡‡! "
item
‡‡# '
.
‡‡' (
AcumCompMin
‡‡( 3
,
‡‡3 4
ProductName
·· 
=
·· 
item
·· "
.
··" #
Name
··# '
!
··' (
,
··( )
ProductPrice
‚‚ 
=
‚‚ 
item
‚‚ #
.
‚‚# $
	SalePrice
‚‚$ -
,
‚‚- .
ProductPriceBtc
„„ 
=
„„  !
	Constants
„„" +
.
„„+ ,

EmptyValue
„„, 6
,
„„6 7

ProductIva
‰‰ 
=
‰‰ 
item
‰‰ !
.
‰‰! "
Tax
‰‰" %
,
‰‰% &
ProductQuantity
ÂÂ 
=
ÂÂ  !
product
ÂÂ" )
.
ÂÂ) *
Count
ÂÂ* /
,
ÂÂ/ 0#
ProductCommissionable
ÊÊ %
=
ÊÊ& '
item
ÊÊ( ,
.
ÊÊ, -!
CommissionableValue
ÊÊ- @
,
ÊÊ@ A
BinaryPoints
ÁÁ 
=
ÁÁ 
item
ÁÁ #
.
ÁÁ# $
BinaryPoints
ÁÁ$ 0
,
ÁÁ0 1
ProductPoints
ËË 
=
ËË 
item
ËË  $
.
ËË$ %
ValuePoints
ËË% 0
,
ËË0 1
ProductDiscount
ÈÈ 
=
ÈÈ  !
item
ÈÈ" &
.
ÈÈ& '
ProductDiscount
ÈÈ' 6
,
ÈÈ6 7
CombinationId
ÍÍ 
=
ÍÍ 
	Constants
ÍÍ  )
.
ÍÍ) *

EmptyValue
ÍÍ* 4
,
ÍÍ4 5
ProductPack
ÎÎ 
=
ÎÎ 
item
ÎÎ "
.
ÎÎ" #
ProductPacks
ÎÎ# /
,
ÎÎ/ 0

BaseAmount
ÏÏ 
=
ÏÏ 
(
ÏÏ 
item
ÏÏ "
.
ÏÏ" #

BaseAmount
ÏÏ# -
*
ÏÏ. /
product
ÏÏ0 7
.
ÏÏ7 8
Count
ÏÏ8 =
)
ÏÏ= >
,
ÏÏ> ?
DailyPercentage
ÌÌ 
=
ÌÌ  !
item
ÌÌ" &
.
ÌÌ& '
DailyPercentage
ÌÌ' 6
,
ÌÌ6 7
WaitingDays
ÓÓ 
=
ÓÓ 
item
ÓÓ "
.
ÓÓ" #
DaysWait
ÓÓ# +
,
ÓÓ+ ,
DaysToPayQuantity
ÔÔ !
=
ÔÔ" #
	Constants
ÔÔ$ -
.
ÔÔ- .
DaysToPayQuantity
ÔÔ. ?
,
ÔÔ? @
ProductStart
 
=
 
false
 $
,
$ %
BrandId
ÒÒ 
=
ÒÒ 
request
ÒÒ !
.
ÒÒ! "
BrandId
ÒÒ" )
,
ÒÒ) *
}
ÚÚ 
;
ÚÚ 
invoiceDetails
ÙÙ 
.
ÙÙ 
Add
ÙÙ 
(
ÙÙ 
invoiceDetail
ÙÙ ,
)
ÙÙ, -
;
ÙÙ- .
}
ıı 	
if
˜˜ 

(
˜˜ 
debit
˜˜ 
==
˜˜ 
	Constants
˜˜ 
.
˜˜ 

EmptyValue
˜˜ )
)
˜˜) *
return
¯¯ 
false
¯¯ 
;
¯¯ 
if
˙˙ 

(
˙˙ 
invoiceDetails
˙˙ 
.
˙˙ 
Count
˙˙  
==
˙˙! #
	Constants
˙˙$ -
.
˙˙- .

EmptyValue
˙˙. 8
)
˙˙8 9
return
˚˚ 
false
˚˚ 
;
˚˚ 
var
˝˝ %
debitTransactionRequest
˝˝ #
=
˝˝$ %
new
˝˝& )%
DebitTransactionRequest
˝˝* A
{
˛˛ 	
Debit
ˇˇ 
=
ˇˇ 
debit
ˇˇ 
,
ˇˇ 
AffiliateId
ÄÄ 
=
ÄÄ 
request
ÄÄ !
.
ÄÄ! "
AffiliateId
ÄÄ" -
,
ÄÄ- .
UserId
ÅÅ 
=
ÅÅ 
	Constants
ÅÅ 
.
ÅÅ 
AdminUserId
ÅÅ *
,
ÅÅ* +
ConceptType
ÇÇ 
=
ÇÇ 
WalletConceptType
ÇÇ +
.
ÇÇ+ ,
purchasing_pool
ÇÇ, ;
.
ÇÇ; <
ToString
ÇÇ< D
(
ÇÇD E
)
ÇÇE F
,
ÇÇF G
Points
ÉÉ 
=
ÉÉ 
points
ÉÉ 
,
ÉÉ 
Concept
ÑÑ 
=
ÑÑ 
	Constants
ÑÑ 
.
ÑÑ  $
EcoPoolProductCategory
ÑÑ  6
,
ÑÑ6 7
Commissionable
ÖÖ 
=
ÖÖ 
commissionable
ÖÖ +
,
ÖÖ+ ,
Bank
ÜÜ 
=
ÜÜ 
	Constants
ÜÜ 
.
ÜÜ 
CoinPayments
ÜÜ )
,
ÜÜ) *
PaymentMethod
áá 
=
áá 
	Constants
áá %
.
áá% &
CoinPayments
áá& 2
,
áá2 3
Origin
àà 
=
àà 
origin
àà 
,
àà 
Level
ââ 
=
ââ 
	Constants
ââ 
.
ââ 

EmptyValue
ââ (
,
ââ( )
AffiliateUserName
ää 
=
ää 
request
ää  '
.
ää' (
AffiliateUserName
ää( 9
,
ää9 :
AdminUserName
ãã 
=
ãã 
	Constants
ãã %
.
ãã% &$
AdminEcosystemUserName
ãã& <
,
ãã< =
ReceiptNumber
åå 
=
åå 
request
åå #
.
åå# $
ReceiptNumber
åå$ 1
,
åå1 2
Type
çç 
=
çç 
true
çç 
,
çç 
	SecretKey
éé 
=
éé 
request
éé 
.
éé  
	SecretKey
éé  )
,
éé) *
invoices
èè 
=
èè 
invoiceDetails
èè %
,
èè% &
Reason
êê 
=
êê 
request
êê 
.
êê 
Bank
êê !
,
êê! "
BrandId
ëë 
=
ëë 
request
ëë 
.
ëë 
BrandId
ëë %
,
ëë% &
}
íí 	
;
íí	 

var
îî 

spResponse
îî 
=
îî 
await
îî  
_invoiceRepository
îî 1
.
îî1 2$
HandleDebitTransaction
îî2 H
(
îîH I%
debitTransactionRequest
îîI `
)
îî` a
;
îîa b
if
ññ 

(
ññ 

spResponse
ññ 
is
ññ 
null
ññ 
)
ññ 
return
óó 
false
óó 
;
óó 
var
ôô 

invoicePdf
ôô 
=
ôô 
await
ôô !
_recyCoinPdfService
ôô 2
.
ôô2 3
GenerateInvoice
ôô3 B
(
ôôB C
userInfoResponse
ôôC S
!
ôôS T
,
ôôT U%
debitTransactionRequest
ôôV m
,
ôôm n

spResponse
ôôo y
)
ôôy z
;
ôôz {

Dictionary
õõ 
<
õõ 
string
õõ 
,
õõ 
byte
õõ 
[
õõ  
]
õõ  !
>
õõ! "

allPdfData
õõ# -
=
õõ. /
new
õõ0 3

Dictionary
õõ4 >
<
õõ> ?
string
õõ? E
,
õõE F
byte
õõG K
[
õõK L
]
õõL M
>
õõM N
{
úú 	
[
ùù 
$str
ùù 
]
ùù 
=
ùù 

invoicePdf
ùù (
}
ûû 	
;
ûû	 

if
†† 

(
†† 

invoicePdf
†† 
.
†† 
Length
†† 
!=
††  
	Constants
††! *
.
††* +

EmptyValue
††+ 5
)
††5 6
{
°° 	
await
¢¢  
_brevoEmailService
¢¢ $
.
¢¢$ %&
SendEmailPurchaseConfirm
¢¢% =
(
¢¢= >
userInfoResponse
¢¢> N
!
¢¢N O
,
¢¢O P

allPdfData
¢¢Q [
,
¢¢[ \

spResponse
¢¢] g
,
¢¢g h
request
¢¢h o
.
¢¢o p
BrandId
¢¢p w
)
¢¢w x
;
¢¢x y
}
££ 	
return
•• 
true
•• 
;
•• 
}
¶¶ 
}ßß ΩÜ
ZC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\CoinPayPaymentStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
;. /
public 
class "
CoinPayPaymentStrategy #
:$ %#
ICoinPayPaymentStrategy& =
{ 
private 
readonly 
IInvoiceRepository '
_invoiceRepository( :
;: ;
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter, B
;B C
private 
readonly  
IEcosystemPdfService ) 
_ecosystemPdfService* >
;> ?
private 
readonly 
IBrevoEmailService '
_brevoEmailService( :
;: ;
private 
readonly 
IWalletRepository &
_walletRepository' 8
;8 9
private 
readonly 

RedisCache 
_redisCache  +
;+ ,
private 
readonly 
IRecyCoinPdfService (
_recyCoinPdfService) <
;< =
private 
readonly 
IBonusRepository %
_bonusRepository& 6
;6 7
private 
readonly  
IHouseCoinPdfService ) 
_houseCoinPdfService* >
;> ?
private 
readonly "
IExitoJuntosPdfService +"
_exitoJuntosPdfService, B
;B C
public 
"
CoinPayPaymentStrategy !
(! "
IInvoiceRepository" 4
invoiceRepository5 F
,F G$
IInventoryServiceAdapter  #
inventoryServiceAdapter! 8
,8 9"
IAccountServiceAdapter   !
accountServiceAdapter   4
,  4 5
IBrevoEmailService  6 H
brevoEmailService  I Z
,  Z [ 
IEcosystemPdfService!! 
ecosystemPdfService!! 0
,!!0 1
IWalletRepository!!2 C
walletRepository!!D T
,!!T U
IRecyCoinPdfService"" 
recyCoinPdfService"" .
,"". /
IBonusRepository## 
bonusRepository## (
,##( )

RedisCache##* 4

redisCache##5 ?
,##? @ 
IHouseCoinPdfService$$ 
houseCoinPdfService$$ 0
,$$0 1"
IExitoJuntosPdfService$$2 H!
exitoJuntosPdfService$$I ^
)$$^ _
{%% 
_invoiceRepository&& 
=&& 
invoiceRepository&& .
;&&. /$
_inventoryServiceAdapter''  
=''! "#
inventoryServiceAdapter''# :
;'': ;"
_accountServiceAdapter(( 
=((  !
accountServiceAdapter((! 6
;((6 7
_brevoEmailService)) 
=)) 
brevoEmailService)) .
;)). / 
_ecosystemPdfService** 
=** 
ecosystemPdfService** 2
;**2 3
_walletRepository++ 
=++ 
walletRepository++ ,
;++, -
_recyCoinPdfService,, 
=,, 
recyCoinPdfService,, 0
;,,0 1
_bonusRepository-- 
=-- 
bonusRepository-- *
;--* +
_redisCache.. 
=.. 

redisCache..  
;..  ! 
_houseCoinPdfService// 
=// 
houseCoinPdfService// 2
;//2 3"
_exitoJuntosPdfService00 
=00  !
exitoJuntosPdfService00! 6
;006 7
}11 
private33 
async33 
Task33 
<33 

Dictionary33 !
<33! "
string33" (
,33( )
byte33* .
[33. /
]33/ 0
>330 1
>331 2*
GetPdfContentForTradingAcademy333 Q
(33Q R
)33R S
{44 

Dictionary55 
<55 
string55 
,55 
byte55 
[55  
]55  !
>55! "
pdfContents55# .
=55/ 0
new551 4

Dictionary555 ?
<55? @
string55@ F
,55F G
byte55H L
[55L M
]55M N
>55N O
(55O P
)55P Q
;55Q R
var77 
workingDirectory77 
=77 
Path77 #
.77# $
GetDirectoryName77$ 4
(774 5
Assembly775 =
.77= > 
GetExecutingAssembly77> R
(77R S
)77S T
.77T U
Location77U ]
)77] ^
;77^ _
var88 
	separator88 
=88 
Path88 
.88 "
DirectorySeparatorChar88 3
;883 4
var:: 
pdfDirectory:: 
=:: 
$":: 
{:: 
workingDirectory:: .
}::. /
{::/ 0
	separator::0 9
}::9 :
$str::: @
{::@ A
	separator::A J
}::J K
$str::K Y
"::Y Z
;::Z [
var<< 
pdfFiles<< 
=<< 
	Directory<<  
.<<  !
GetFiles<<! )
(<<) *
pdfDirectory<<* 6
,<<6 7
$str<<8 ?
)<<? @
;<<@ A
foreach>> 
(>> 
var>> 
pdfFile>> 
in>> 
pdfFiles>>  (
)>>( )
{?? 	
var@@ 
fileName@@ 
=@@ 
Path@@ 
.@@  
GetFileName@@  +
(@@+ ,
pdfFile@@, 3
)@@3 4
;@@4 5
varAA 

pdfContentAA 
=AA 
awaitAA "
FileAA# '
.AA' (
ReadAllBytesAsyncAA( 9
(AA9 :
pdfFileAA: A
)AAA B
;AAB C
pdfContentsBB 
[BB 
fileNameBB  
]BB  !
=BB" #

pdfContentBB$ .
;BB. /
}CC 	
returnEE 
pdfContentsEE 
;EE 
}FF 
publicHH 

asyncHH 
TaskHH 
<HH 
boolHH 
>HH !
ExecuteEcoPoolPaymentHH 1
(HH1 2
WalletRequestHH2 ?
requestHH@ G
)HHG H
{II 
varJJ 
debitJJ 
=JJ 
$numJJ 
;JJ 
varKK 
pointsKK 
=KK 
$numKK 
;KK 
varLL 
commissionableLL 
=LL 
$numLL 
;LL  
byteMM 
originMM 
=MM 
$numMM 
;MM 
varOO 
invoiceDetailsOO 
=OO 
newOO  
ListOO! %
<OO% &,
 InvoiceDetailsTransactionRequestOO& F
>OOF G
(OOG H
)OOH I
;OOI J
varPP 
userInfoResponsePP 
=PP 
awaitPP $"
_accountServiceAdapterPP% ;
.PP; <
GetUserInfoPP< G
(PPG H
requestPPH O
.PPO P
AffiliateIdPPP [
,PP[ \
requestPP] d
.PPd e
BrandIdPPe l
)PPl m
;PPm n
varQQ 

productIdsQQ 
=QQ 
requestQQ  
.QQ  !
ProductsListQQ! -
.QQ- .
SelectQQ. 4
(QQ4 5
pQQ5 6
=>QQ7 9
pQQ: ;
.QQ; <
	IdProductQQ< E
)QQE F
.QQF G
ToArrayQQG N
(QQN O
)QQO P
;QQP Q
varRR 
responseListRR 
=RR 
awaitRR  $
_inventoryServiceAdapterRR! 9
.RR9 :
GetProductsIdsRR: H
(RRH I

productIdsRRI S
,RRS T
requestRRU \
.RR\ ]
BrandIdRR] d
)RRd e
;RRe f
ifTT 

(TT 
!TT 
responseListTT 
.TT 
IsSuccessfulTT &
)TT& '
returnUU 
falseUU 
;UU 
ifWW 

(WW 
stringWW 
.WW 
IsNullOrEmptyWW  
(WW  !
responseListWW! -
.WW- .
ContentWW. 5
)WW5 6
)WW6 7
returnXX 
falseXX 
;XX 
varZZ 
resultZZ 
=ZZ 
JsonSerializerZZ #
.ZZ# $
DeserializeZZ$ /
<ZZ/ 0
ProductsResponseZZ0 @
>ZZ@ A
(ZZA B
responseListZZB N
.ZZN O
ContentZZO V
)ZZV W
;ZZW X
if\\ 

(\\ 
result\\ 
?\\ 
.\\ 
Data\\ 
.\\ 
Count\\ 
==\\ !
	Constants\\" +
.\\+ ,

EmptyValue\\, 6
)\\6 7
{]] 	
var^^ 
firstProductId^^ 
=^^  
request^^! (
.^^( )
ProductsList^^) 5
.^^5 6
First^^6 ;
(^^; <
)^^< =
.^^= >
	IdProduct^^> G
;^^G H
var__ 
membershipResult__  
=__! "
await__# ($
_inventoryServiceAdapter__) A
.__A B
GetProductById__B P
(__P Q
firstProductId__Q _
,___ `
request__a h
.__h i
BrandId__i p
)__p q
;__q r
varaa 
productResponseaa 
=aa  !
JsonSerializeraa" 0
.aa0 1
Deserializeaa1 <
<aa< =
ProductResponseaa= L
>aaL M
(aaM N
membershipResultaaN ^
.aa^ _
Contentaa_ f
!aaf g
)aag h
;aah i
awaitcc "
_accountServiceAdaptercc (
.cc( ) 
UpdateActivationDatecc) =
(cc= >
requestcc> E
.ccE F
AffiliateIdccF Q
,ccQ R
requestccS Z
.ccZ [
BrandIdcc[ b
)ccb c
;ccc d
resultee 
.ee 
Dataee 
.ee 
Addee 
(ee 
productResponseee +
!ee+ ,
.ee, -
Dataee- 1
)ee1 2
;ee2 3
}ff 	
ifhh 

(hh 
resulthh 
?hh 
.hh 
Datahh 
==hh 
nullhh  
)hh  !
returnii 
falseii 
;ii 
ifkk 

(kk 
resultkk 
.kk 
Datakk 
.kk 
Countkk 
!=kk  
requestkk! (
.kk( )
ProductsListkk) 5
.kk5 6
Countkk6 ;
)kk; <
returnll 
falsell 
;ll 
varnn 
productNamesnn 
=nn 
resultnn !
.nn! "
Datann" &
.nn& '
Selectnn' -
(nn- .
itemnn. 2
=>nn3 5
itemnn6 :
.nn: ;
Namenn; ?
)nn? @
.nn@ A
ToArraynnA H
(nnH I
)nnI J
;nnJ K
foreachpp 
(pp 
varpp 
itempp 
inpp 
resultpp #
.pp# $
Datapp$ (
)pp( )
{qq 	
varrr 
productrr 
=rr 
requestrr !
.rr! "
ProductsListrr" .
.rr. /
FirstOrDefaultrr/ =
(rr= >
xrr> ?
=>rr@ B
xrrC D
.rrD E
	IdProductrrE N
==rrO Q
itemrrR V
.rrV W
IdrrW Y
)rrY Z
;rrZ [
varss 
taxss 
=ss 
itemss 
.ss 
Taxss 
;ss 
debittt 
+=tt 
(tt 
inttt 
)tt 
(tt 
(tt 
itemtt  
.tt  !
	SalePricett! *
*tt+ ,
producttt- 4
!tt4 5
.tt5 6
Counttt6 ;
)tt; <
*tt= >
(tt? @
$numtt@ A
+ttB C
(ttD E
taxttE H
/ttI J
$numttK N
)ttN O
)ttO P
)ttP Q
;ttQ R
pointsuu 
+=uu 
itemuu 
.uu 
BinaryPointsuu '
*uu( )
productuu* 1
.uu1 2
Countuu2 7
;uu7 8
commissionablevv 
+=vv 
itemvv "
.vv" #
CommissionableValuevv# 6
*vv7 8
productvv9 @
.vv@ A
CountvvA F
;vvF G
ifww 
(ww 
itemww 
.ww 

CategoryIdww 
==ww  "
$numww# $
)ww$ %
{xx 
originyy 
=yy 
$numyy 
;yy 
}zz 
var|| 
invoiceDetail|| 
=|| 
new||  #,
 InvoiceDetailsTransactionRequest||$ D
{}} 
	ProductId~~ 
=~~ 
item~~  
.~~  !
Id~~! #
,~~# $
PaymentGroupId 
=  
item! %
.% &
PaymentGroup& 2
,2 3
AccumMinPurchase
ÄÄ  
=
ÄÄ! "
item
ÄÄ# '
.
ÄÄ' (
AcumCompMin
ÄÄ( 3
,
ÄÄ3 4
ProductName
ÅÅ 
=
ÅÅ 
item
ÅÅ "
.
ÅÅ" #
Name
ÅÅ# '
!
ÅÅ' (
,
ÅÅ( )
ProductPrice
ÇÇ 
=
ÇÇ 
item
ÇÇ #
.
ÇÇ# $
	SalePrice
ÇÇ$ -
,
ÇÇ- .
ProductPriceBtc
ÉÉ 
=
ÉÉ  !
	Constants
ÉÉ" +
.
ÉÉ+ ,

EmptyValue
ÉÉ, 6
,
ÉÉ6 7

ProductIva
ÑÑ 
=
ÑÑ 
item
ÑÑ !
.
ÑÑ! "
Tax
ÑÑ" %
,
ÑÑ% &
ProductQuantity
ÖÖ 
=
ÖÖ  !
product
ÖÖ" )
.
ÖÖ) *
Count
ÖÖ* /
,
ÖÖ/ 0#
ProductCommissionable
ÜÜ %
=
ÜÜ& '
item
ÜÜ( ,
.
ÜÜ, -!
CommissionableValue
ÜÜ- @
,
ÜÜ@ A
BinaryPoints
áá 
=
áá 
item
áá #
.
áá# $
BinaryPoints
áá$ 0
,
áá0 1
ProductPoints
àà 
=
àà 
item
àà  $
.
àà$ %
ValuePoints
àà% 0
,
àà0 1
ProductDiscount
ââ 
=
ââ  !
item
ââ" &
.
ââ& '
ProductDiscount
ââ' 6
,
ââ6 7
CombinationId
ää 
=
ää 
	Constants
ää  )
.
ää) *

EmptyValue
ää* 4
,
ää4 5
ProductPack
ãã 
=
ãã 
item
ãã "
.
ãã" #
ProductPacks
ãã# /
,
ãã/ 0

BaseAmount
åå 
=
åå 
(
åå 
item
åå "
.
åå" #

BaseAmount
åå# -
*
åå. /
product
åå0 7
.
åå7 8
Count
åå8 =
)
åå= >
,
åå> ?
DailyPercentage
çç 
=
çç  !
item
çç" &
.
çç& '
DailyPercentage
çç' 6
,
çç6 7
WaitingDays
éé 
=
éé 
item
éé "
.
éé" #
DaysWait
éé# +
,
éé+ ,
DaysToPayQuantity
èè !
=
èè" #
	Constants
èè$ -
.
èè- .
DaysToPayQuantity
èè. ?
,
èè? @
ProductStart
êê 
=
êê 
false
êê $
,
êê$ %
BrandId
ëë 
=
ëë 
request
ëë !
.
ëë! "
BrandId
ëë" )
,
ëë) *
}
íí 
;
íí 
invoiceDetails
îî 
.
îî 
Add
îî 
(
îî 
invoiceDetail
îî ,
)
îî, -
;
îî- .
}
ïï 	
if
óó 

(
óó 
debit
óó 
==
óó 
	Constants
óó 
.
óó 

EmptyValue
óó )
)
óó) *
return
òò 
false
òò 
;
òò 
if
öö 

(
öö 
invoiceDetails
öö 
.
öö 
Count
öö  
==
öö! #
	Constants
öö$ -
.
öö- .

EmptyValue
öö. 8
)
öö8 9
return
õõ 
false
õõ 
;
õõ 
var
ùù %
debitTransactionRequest
ùù #
=
ùù$ %
new
ùù& )%
DebitTransactionRequest
ùù* A
{
ûû 	
Debit
üü 
=
üü 
debit
üü 
,
üü 
AffiliateId
†† 
=
†† 
request
†† !
.
††! "
AffiliateId
††" -
,
††- .
UserId
°° 
=
°° 
	Constants
°° 
.
°° 
AdminUserId
°° *
,
°°* +
ConceptType
¢¢ 
=
¢¢ 
WalletConceptType
¢¢ +
.
¢¢+ ,
purchasing_pool
¢¢, ;
.
¢¢; <
ToString
¢¢< D
(
¢¢D E
)
¢¢E F
,
¢¢F G
Points
££ 
=
££ 
points
££ 
,
££ 
Concept
§§ 
=
§§ 
	Constants
§§ 
.
§§  $
EcoPoolProductCategory
§§  6
,
§§6 7
Commissionable
•• 
=
•• 
commissionable
•• +
,
••+ ,
Bank
¶¶ 
=
¶¶ 
	Constants
¶¶ 
.
¶¶ 
CoinPay
¶¶ $
,
¶¶$ %
PaymentMethod
ßß 
=
ßß 
	Constants
ßß %
.
ßß% &
CoinPay
ßß& -
,
ßß- .
Origin
®® 
=
®® 
origin
®® 
,
®® 
Level
©© 
=
©© 
	Constants
©© 
.
©© 

EmptyValue
©© (
,
©©( )
AffiliateUserName
™™ 
=
™™ 
request
™™  '
.
™™' (
AffiliateUserName
™™( 9
,
™™9 :
AdminUserName
´´ 
=
´´ 
request
´´ #
.
´´# $
BrandId
´´$ +
==
´´, .
$num
´´/ 0
?
´´1 2
	Constants
´´3 <
.
´´< =$
AdminEcosystemUserName
´´= S
:
´´T U
	Constants
´´V _
.
´´_ `
RecycoinAdmin
´´` m
,
´´m n
ReceiptNumber
¨¨ 
=
¨¨ 
request
¨¨ #
.
¨¨# $
ReceiptNumber
¨¨$ 1
,
¨¨1 2
Type
≠≠ 
=
≠≠ 
true
≠≠ 
,
≠≠ 
	SecretKey
ÆÆ 
=
ÆÆ 
request
ÆÆ 
.
ÆÆ  
	SecretKey
ÆÆ  )
,
ÆÆ) *
invoices
ØØ 
=
ØØ 
invoiceDetails
ØØ %
,
ØØ% &
Reason
∞∞ 
=
∞∞ 
request
∞∞ 
.
∞∞ 
Bank
∞∞ !
,
∞∞! "
BrandId
±± 
=
±± 
request
±± 
.
±± 
BrandId
±± %
,
±±% &
}
≤≤ 	
;
≤≤	 

var
¥¥ 

spResponse
¥¥ 
=
¥¥ 
await
¥¥  
_invoiceRepository
¥¥ 1
.
¥¥1 2$
HandleDebitTransaction
¥¥2 H
(
¥¥H I%
debitTransactionRequest
¥¥I `
)
¥¥` a
;
¥¥a b
if
∂∂ 

(
∂∂ 

spResponse
∂∂ 
is
∂∂ 
null
∂∂ 
)
∂∂ 
return
∑∑ 
false
∑∑ 
;
∑∑ 
var
ππ 

invoicePdf
ππ 
=
ππ 
await
∫∫ "
_ecosystemPdfService
∫∫ &
.
∫∫& '
GenerateInvoice
∫∫' 6
(
∫∫6 7
userInfoResponse
∫∫7 G
!
∫∫G H
,
∫∫H I%
debitTransactionRequest
∫∫J a
,
∫∫a b

spResponse
∫∫c m
)
∫∫m n
;
∫∫n o
var
ºº !
productPdfsContents
ºº 
=
ºº  !
await
ºº" '
CommonExtensions
ºº( 8
.
ºº8 9+
GetPdfContentFromProductNames
ºº9 V
(
ººV W
productNames
ººW c
!
ººc d
)
ººd e
;
ººe f

Dictionary
ææ 
<
ææ 
string
ææ 
,
ææ 
byte
ææ 
[
ææ  
]
ææ  !
>
ææ! "

allPdfData
ææ# -
=
ææ. /
new
ææ0 3

Dictionary
ææ4 >
<
ææ> ?
string
ææ? E
,
ææE F
byte
ææG K
[
ææK L
]
ææL M
>
ææM N
{
øø 	
[
¿¿ 
$str
¿¿ 
]
¿¿ 
=
¿¿ 

invoicePdf
¿¿ (
}
¡¡ 	
;
¡¡	 

foreach
√√ 
(
√√ 
var
√√ 
pdfDataEntry
√√ !
in
√√" $!
productPdfsContents
√√% 8
)
√√8 9
{
ƒƒ 	

allPdfData
≈≈ 
[
≈≈ 
pdfDataEntry
≈≈ #
.
≈≈# $
Key
≈≈$ '
]
≈≈' (
=
≈≈) *
pdfDataEntry
≈≈+ 7
.
≈≈7 8
Value
≈≈8 =
;
≈≈= >
}
∆∆ 	
if
»» 

(
»» 
result
»» 
.
»» 
Data
»» 
.
»» 
Find
»» 
(
»» 
dto
»»  
=>
»»! #
dto
»»$ '
.
»»' (
ProductType
»»( 3
)
»»3 4
!=
»»5 7
null
»»8 <
)
»»< =
{
…… 	
await
    
_brevoEmailService
   $
.
  $ %
SendEmailWelcome
  % 5
(
  5 6
userInfoResponse
  6 F
!
  F G
,
  G H

spResponse
  I S
,
  S T
request
  U \
.
  \ ]
BrandId
  ] d
)
  d e
;
  e f
}
ÀÀ 	
if
ÕÕ 

(
ÕÕ 

invoicePdf
ÕÕ 
.
ÕÕ 
Length
ÕÕ 
!=
ÕÕ  
	Constants
ÕÕ! *
.
ÕÕ* +

EmptyValue
ÕÕ+ 5
)
ÕÕ5 6
{
ŒŒ 	
await
œœ  
_brevoEmailService
œœ $
.
œœ$ %&
SendEmailPurchaseConfirm
œœ% =
(
œœ= >
userInfoResponse
œœ> N
!
œœN O
,
œœO P

allPdfData
œœQ [
,
œœ[ \

spResponse
œœ] g
,
œœg h
request
–– 
.
–– 
BrandId
–– 
)
––  
;
––  !
}
—— 	
return
”” 
true
”” 
;
”” 
}
‘‘ 
public
÷÷ 

async
÷÷ 
Task
÷÷ 
<
÷÷ 
bool
÷÷ 
>
÷÷ "
ExecuteCoursePayment
÷÷ 0
(
÷÷0 1
WalletRequest
÷÷1 >
request
÷÷? F
)
÷÷F G
{
◊◊ 
var
ÿÿ 
debit
ÿÿ 
=
ÿÿ 
$num
ÿÿ 
;
ÿÿ 
var
ŸŸ 
points
ŸŸ 
=
ŸŸ 
$num
ŸŸ 
;
ŸŸ 
var
⁄⁄ 
commissionable
⁄⁄ 
=
⁄⁄ 
$num
⁄⁄ 
;
⁄⁄  
byte
€€ 
origin
€€ 
=
€€ 
$num
€€ 
;
€€ 
var
›› 
invoiceDetails
›› 
=
›› 
new
››  
List
››! %
<
››% &.
 InvoiceDetailsTransactionRequest
››& F
>
››F G
(
››G H
)
››H I
;
››I J
var
ﬁﬁ 
userInfoResponse
ﬁﬁ 
=
ﬁﬁ 
await
ﬁﬁ $$
_accountServiceAdapter
ﬁﬁ% ;
.
ﬁﬁ; <
GetUserInfo
ﬁﬁ< G
(
ﬁﬁG H
request
ﬁﬁH O
.
ﬁﬁO P
AffiliateId
ﬁﬁP [
,
ﬁﬁ[ \
request
ﬁﬁ] d
.
ﬁﬁd e
BrandId
ﬁﬁe l
)
ﬁﬁl m
;
ﬁﬁm n
var
ﬂﬂ 

productIds
ﬂﬂ 
=
ﬂﬂ 
request
ﬂﬂ  
.
ﬂﬂ  !
ProductsList
ﬂﬂ! -
.
ﬂﬂ- .
Select
ﬂﬂ. 4
(
ﬂﬂ4 5
p
ﬂﬂ5 6
=>
ﬂﬂ7 9
p
ﬂﬂ: ;
.
ﬂﬂ; <
	IdProduct
ﬂﬂ< E
)
ﬂﬂE F
.
ﬂﬂF G
ToArray
ﬂﬂG N
(
ﬂﬂN O
)
ﬂﬂO P
;
ﬂﬂP Q
var
‡‡ 
responseList
‡‡ 
=
‡‡ 
await
‡‡  &
_inventoryServiceAdapter
‡‡! 9
.
‡‡9 :
GetProductsIds
‡‡: H
(
‡‡H I

productIds
‡‡I S
,
‡‡S T
request
‡‡U \
.
‡‡\ ]
BrandId
‡‡] d
)
‡‡d e
;
‡‡e f
if
‚‚ 

(
‚‚ 
!
‚‚ 
responseList
‚‚ 
.
‚‚ 
IsSuccessful
‚‚ &
)
‚‚& '
return
„„ 
false
„„ 
;
„„ 
if
ÂÂ 

(
ÂÂ 
string
ÂÂ 
.
ÂÂ 
IsNullOrEmpty
ÂÂ  
(
ÂÂ  !
responseList
ÂÂ! -
.
ÂÂ- .
Content
ÂÂ. 5
)
ÂÂ5 6
)
ÂÂ6 7
return
ÊÊ 
false
ÊÊ 
;
ÊÊ 
var
ËË 
result
ËË 
=
ËË 
JsonSerializer
ËË #
.
ËË# $
Deserialize
ËË$ /
<
ËË/ 0
ProductsResponse
ËË0 @
>
ËË@ A
(
ËËA B
responseList
ËËB N
.
ËËN O
Content
ËËO V
)
ËËV W
;
ËËW X
if
ÍÍ 

(
ÍÍ 
result
ÍÍ 
?
ÍÍ 
.
ÍÍ 
Data
ÍÍ 
==
ÍÍ 
null
ÍÍ  
)
ÍÍ  !
return
ÎÎ 
false
ÎÎ 
;
ÎÎ 
if
ÌÌ 

(
ÌÌ 
result
ÌÌ 
.
ÌÌ 
Data
ÌÌ 
.
ÌÌ 
Count
ÌÌ 
!=
ÌÌ  
request
ÌÌ! (
.
ÌÌ( )
ProductsList
ÌÌ) 5
.
ÌÌ5 6
Count
ÌÌ6 ;
)
ÌÌ; <
return
ÓÓ 
false
ÓÓ 
;
ÓÓ 
var
 
	isAcademy
 
=
 
false
 
;
 
foreach
ÒÒ 
(
ÒÒ 
var
ÒÒ 
item
ÒÒ 
in
ÒÒ 
result
ÒÒ #
.
ÒÒ# $
Data
ÒÒ$ (
)
ÒÒ( )
{
ÚÚ 	
var
ÛÛ 
product
ÛÛ 
=
ÛÛ 
request
ÛÛ !
.
ÛÛ! "
ProductsList
ÛÛ" .
.
ÛÛ. /
FirstOrDefault
ÛÛ/ =
(
ÛÛ= >
x
ÛÛ> ?
=>
ÛÛ@ B
x
ÛÛC D
.
ÛÛD E
	IdProduct
ÛÛE N
==
ÛÛO Q
item
ÛÛR V
.
ÛÛV W
Id
ÛÛW Y
)
ÛÛY Z
;
ÛÛZ [
var
ÙÙ 
tax
ÙÙ 
=
ÙÙ 
item
ÙÙ 
.
ÙÙ 
Tax
ÙÙ 
;
ÙÙ 
debit
ıı 
+=
ıı 
(
ıı 
item
ıı 
.
ıı 
	SalePrice
ıı $
*
ıı% &
product
ıı' .
!
ıı. /
.
ıı/ 0
Count
ıı0 5
)
ıı5 6
*
ıı7 8
(
ıı9 :
$num
ıı: ;
+
ıı< =
(
ıı> ?
tax
ıı? B
/
ııC D
$num
ııE H
)
ııH I
)
ııI J
;
ııJ K
points
ˆˆ 
+=
ˆˆ 
item
ˆˆ 
.
ˆˆ 
BinaryPoints
ˆˆ '
*
ˆˆ( )
product
ˆˆ* 1
.
ˆˆ1 2
Count
ˆˆ2 7
;
ˆˆ7 8
commissionable
˜˜ 
+=
˜˜ 
item
˜˜ "
.
˜˜" #!
CommissionableValue
˜˜# 6
*
˜˜7 8
product
˜˜9 @
.
˜˜@ A
Count
˜˜A F
;
˜˜F G
	isAcademy
¯¯ 
=
¯¯ 
item
¯¯ 
.
¯¯ 
PaymentGroup
¯¯ )
==
¯¯* ,
	Constants
¯¯- 6
.
¯¯6 7!
TradingAcademyGroup
¯¯7 J
||
¯¯K M
	isAcademy
¯¯N W
;
¯¯W X
if
˘˘ 
(
˘˘ 
item
˘˘ 
.
˘˘ 

CategoryId
˘˘ 
==
˘˘  "
$num
˘˘# $
)
˘˘$ %
{
˙˙ 
origin
˚˚ 
=
˚˚ 
$num
˚˚ 
;
˚˚ 
}
¸¸ 
var
˛˛ 
invoiceDetail
˛˛ 
=
˛˛ 
new
˛˛  #.
 InvoiceDetailsTransactionRequest
˛˛$ D
{
ˇˇ 
	ProductId
ÄÄ 
=
ÄÄ 
item
ÄÄ  
.
ÄÄ  !
Id
ÄÄ! #
,
ÄÄ# $
PaymentGroupId
ÅÅ 
=
ÅÅ  
item
ÅÅ! %
.
ÅÅ% &
PaymentGroup
ÅÅ& 2
,
ÅÅ2 3
AccumMinPurchase
ÇÇ  
=
ÇÇ! "
item
ÇÇ# '
.
ÇÇ' (
AcumCompMin
ÇÇ( 3
,
ÇÇ3 4
ProductName
ÉÉ 
=
ÉÉ 
item
ÉÉ "
.
ÉÉ" #
Name
ÉÉ# '
!
ÉÉ' (
,
ÉÉ( )
ProductPrice
ÑÑ 
=
ÑÑ 
item
ÑÑ #
.
ÑÑ# $
	SalePrice
ÑÑ$ -
,
ÑÑ- .
ProductPriceBtc
ÖÖ 
=
ÖÖ  !
	Constants
ÖÖ" +
.
ÖÖ+ ,

EmptyValue
ÖÖ, 6
,
ÖÖ6 7

ProductIva
ÜÜ 
=
ÜÜ 
item
ÜÜ !
.
ÜÜ! "
Tax
ÜÜ" %
,
ÜÜ% &
ProductQuantity
áá 
=
áá  !
product
áá" )
.
áá) *
Count
áá* /
,
áá/ 0#
ProductCommissionable
àà %
=
àà& '
item
àà( ,
.
àà, -!
CommissionableValue
àà- @
,
àà@ A
BinaryPoints
ââ 
=
ââ 
item
ââ #
.
ââ# $
BinaryPoints
ââ$ 0
,
ââ0 1
ProductPoints
ää 
=
ää 
item
ää  $
.
ää$ %
ValuePoints
ää% 0
,
ää0 1
ProductDiscount
ãã 
=
ãã  !
item
ãã" &
.
ãã& '
ProductDiscount
ãã' 6
,
ãã6 7
CombinationId
åå 
=
åå 
	Constants
åå  )
.
åå) *

EmptyValue
åå* 4
,
åå4 5
ProductPack
çç 
=
çç 
item
çç "
.
çç" #
ProductPacks
çç# /
,
çç/ 0

BaseAmount
éé 
=
éé 
(
éé 
item
éé "
.
éé" #

BaseAmount
éé# -
*
éé. /
product
éé0 7
.
éé7 8
Count
éé8 =
)
éé= >
,
éé> ?
DailyPercentage
èè 
=
èè  !
item
èè" &
.
èè& '
DailyPercentage
èè' 6
,
èè6 7
WaitingDays
êê 
=
êê 
item
êê "
.
êê" #
DaysWait
êê# +
,
êê+ ,
DaysToPayQuantity
ëë !
=
ëë" #
	Constants
ëë$ -
.
ëë- .
DaysToPayQuantity
ëë. ?
,
ëë? @
ProductStart
íí 
=
íí 
false
íí $
,
íí$ %
BrandId
ìì 
=
ìì 
request
ìì !
.
ìì! "
BrandId
ìì" )
,
ìì) *
}
îî 
;
îî 
invoiceDetails
ññ 
.
ññ 
Add
ññ 
(
ññ 
invoiceDetail
ññ ,
)
ññ, -
;
ññ- .
}
óó 	
if
ôô 

(
ôô 
debit
ôô 
==
ôô 
	Constants
ôô 
.
ôô 

EmptyValue
ôô )
)
ôô) *
return
öö 
false
öö 
;
öö 
if
úú 

(
úú 
invoiceDetails
úú 
.
úú 
Count
úú  
==
úú! #
	Constants
úú$ -
.
úú- .

EmptyValue
úú. 8
)
úú8 9
return
ùù 
false
ùù 
;
ùù 
var
üü %
debitTransactionRequest
üü #
=
üü$ %
new
üü& )%
DebitTransactionRequest
üü* A
{
†† 	
Debit
°° 
=
°° 
debit
°° 
,
°° 
AffiliateId
¢¢ 
=
¢¢ 
request
¢¢ !
.
¢¢! "
AffiliateId
¢¢" -
,
¢¢- .
UserId
££ 
=
££ 
	Constants
££ 
.
££ 
AdminUserId
££ *
,
££* +
ConceptType
§§ 
=
§§ 
WalletConceptType
§§ +
.
§§+ ,
purchasing_pool
§§, ;
.
§§; <
ToString
§§< D
(
§§D E
)
§§E F
,
§§F G
Points
•• 
=
•• 
points
•• 
,
•• 
Concept
¶¶ 
=
¶¶ 
	Constants
¶¶ 
.
¶¶  $
EcoPoolProductCategory
¶¶  6
,
¶¶6 7
Commissionable
ßß 
=
ßß 
commissionable
ßß +
,
ßß+ ,
Bank
®® 
=
®® 
	Constants
®® 
.
®® 
CoinPay
®® $
,
®®$ %
PaymentMethod
©© 
=
©© 
	Constants
©© %
.
©©% &
CoinPay
©©& -
,
©©- .
Origin
™™ 
=
™™ 
origin
™™ 
,
™™ 
Level
´´ 
=
´´ 
	Constants
´´ 
.
´´ 

EmptyValue
´´ (
,
´´( )
AffiliateUserName
¨¨ 
=
¨¨ 
request
¨¨  '
.
¨¨' (
AffiliateUserName
¨¨( 9
,
¨¨9 :
AdminUserName
≠≠ 
=
≠≠ 
	Constants
≠≠ %
.
≠≠% &$
AdminEcosystemUserName
≠≠& <
,
≠≠< =
ReceiptNumber
ÆÆ 
=
ÆÆ 
request
ÆÆ #
.
ÆÆ# $
ReceiptNumber
ÆÆ$ 1
,
ÆÆ1 2
Type
ØØ 
=
ØØ 
true
ØØ 
,
ØØ 
	SecretKey
∞∞ 
=
∞∞ 
request
∞∞ 
.
∞∞  
	SecretKey
∞∞  )
,
∞∞) *
invoices
±± 
=
±± 
invoiceDetails
±± %
,
±±% &
Reason
≤≤ 
=
≤≤ 
request
≤≤ 
.
≤≤ 
Bank
≤≤ !
,
≤≤! "
BrandId
≥≥ 
=
≥≥ 
request
≥≥ 
.
≥≥ 
BrandId
≥≥ %
,
≥≥% &
}
¥¥ 	
;
¥¥	 

var
∂∂ 
	hasCourse
∂∂ 
=
∂∂ 
await
∂∂  
_invoiceRepository
∂∂ 0
.
∂∂0 13
%GetInvoicesForTradingAcademyPurchases
∂∂1 V
(
∂∂V W
request
∂∂W ^
.
∂∂^ _
AffiliateId
∂∂_ j
)
∂∂j k
;
∂∂k l
var
∑∑ 

spResponse
∑∑ 
=
∑∑ 
await
∑∑  
_invoiceRepository
∑∑ 1
.
∑∑1 2$
HandleDebitTransaction
∑∑2 H
(
∑∑H I%
debitTransactionRequest
∑∑I `
)
∑∑` a
;
∑∑a b
if
ππ 

(
ππ 

spResponse
ππ 
is
ππ 
null
ππ 
)
ππ 
return
∫∫ 
false
∫∫ 
;
∫∫ 

Dictionary
ºº 
<
ºº 
string
ºº 
,
ºº 
byte
ºº 
[
ºº  
]
ºº  !
>
ºº! "

allPdfData
ºº# -
=
ºº. /
new
ºº0 3

Dictionary
ºº4 >
<
ºº> ?
string
ºº? E
,
ººE F
byte
ººG K
[
ººK L
]
ººL M
>
ººM N
(
ººN O
)
ººO P
;
ººP Q
var
ΩΩ 

invoicePdf
ΩΩ 
=
ΩΩ 
await
ææ "
_ecosystemPdfService
ææ &
.
ææ& '
GenerateInvoice
ææ' 6
(
ææ6 7
userInfoResponse
ææ7 G
!
ææG H
,
ææH I%
debitTransactionRequest
ææJ a
,
ææa b

spResponse
ææc m
)
ææm n
;
ææn o

allPdfData
¿¿ 
[
¿¿ 
$str
¿¿  
]
¿¿  !
=
¿¿" #

invoicePdf
¿¿$ .
;
¿¿. /
if
¬¬ 

(
¬¬ 
!
¬¬ 
	hasCourse
¬¬ 
&&
¬¬ 

invoicePdf
¬¬ $
.
¬¬$ %
Length
¬¬% +
!=
¬¬, .
	Constants
¬¬/ 8
.
¬¬8 9

EmptyValue
¬¬9 C
&&
¬¬D F
	isAcademy
¬¬G P
)
¬¬P Q
{
√√ 	
var
ƒƒ 
pdfContents
ƒƒ 
=
ƒƒ 
await
ƒƒ #,
GetPdfContentForTradingAcademy
ƒƒ$ B
(
ƒƒB C
)
ƒƒC D
;
ƒƒD E
foreach
≈≈ 
(
≈≈ 
var
≈≈ 
pdf
≈≈ 
in
≈≈ 
pdfContents
≈≈  +
)
≈≈+ ,
{
∆∆ 

allPdfData
«« 
[
«« 
pdf
«« 
.
«« 
Key
«« "
]
««" #
=
««$ %
pdf
««& )
.
««) *
Value
««* /
;
««/ 0
}
»» 
await
    
_brevoEmailService
   $
.
  $ %0
"SendEmailPurchaseConfirmForAcademy
  % G
(
  G H
userInfoResponse
  H X
!
  X Y
,
  Y Z

allPdfData
  [ e
,
  e f

spResponse
  g q
,
  q r
request
ÀÀ 
.
ÀÀ 
BrandId
ÀÀ 
)
ÀÀ  
;
ÀÀ  !
}
ÃÃ 	
else
ÕÕ 
if
ÕÕ 
(
ÕÕ 

invoicePdf
ÕÕ 
.
ÕÕ 
Length
ÕÕ "
!=
ÕÕ# %
	Constants
ÕÕ& /
.
ÕÕ/ 0

EmptyValue
ÕÕ0 :
)
ÕÕ: ;
{
ŒŒ 	
await
œœ  
_brevoEmailService
œœ $
.
œœ$ %&
SendEmailPurchaseConfirm
œœ% =
(
œœ= >
userInfoResponse
œœ> N
!
œœN O
,
œœO P

allPdfData
œœQ [
,
œœ[ \

spResponse
œœ] g
,
œœg h
request
–– 
.
–– 
BrandId
–– 
)
––  
;
––  !
}
—— 	
return
”” 
true
”” 
;
”” 
}
‘‘ 
public
÷÷ 

async
÷÷ 
Task
÷÷ 
<
÷÷ 
bool
÷÷ 
>
÷÷ &
ExecuteMembershipPayment
÷÷ 4
(
÷÷4 5
WalletRequest
÷÷5 B
request
÷÷C J
)
÷÷J K
{
◊◊ 
var
ÿÿ 
debit
ÿÿ 
=
ÿÿ 
$num
ÿÿ 
;
ÿÿ 
var
ŸŸ 
points
ŸŸ 
=
ŸŸ 
$num
ŸŸ 
;
ŸŸ 
var
⁄⁄ 
commissionable
⁄⁄ 
=
⁄⁄ 
$num
⁄⁄ 
;
⁄⁄  
byte
€€ 
origin
€€ 
=
€€ 
$num
€€ 
;
€€ 
var
›› 
invoiceDetails
›› 
=
›› 
new
››  
List
››! %
<
››% &.
 InvoiceDetailsTransactionRequest
››& F
>
››F G
(
››G H
)
››H I
;
››I J
var
ﬁﬁ 
userInfoResponse
ﬁﬁ 
=
ﬁﬁ 
await
ﬁﬁ $$
_accountServiceAdapter
ﬁﬁ% ;
.
ﬁﬁ; <
GetUserInfo
ﬁﬁ< G
(
ﬁﬁG H
request
ﬁﬁH O
.
ﬁﬁO P
AffiliateId
ﬁﬁP [
,
ﬁﬁ[ \
request
ﬁﬁ] d
.
ﬁﬁd e
BrandId
ﬁﬁe l
)
ﬁﬁl m
;
ﬁﬁm n
var
ﬂﬂ "
affiliateBonusWinner
ﬂﬂ  
=
ﬂﬂ! "
await
ﬂﬂ# ($
_accountServiceAdapter
ﬂﬂ) ?
.
ﬂﬂ? @
GetUserInfo
ﬂﬂ@ K
(
ﬂﬂK L
userInfoResponse
ﬂﬂL \
!
ﬂﬂ\ ]
.
ﬂﬂ] ^
Father
ﬂﬂ^ d
,
ﬂﬂd e
request
ﬂﬂf m
.
ﬂﬂm n
BrandId
ﬂﬂn u
)
ﬂﬂu v
;
ﬂﬂv w
var
·· 
firstProductId
·· 
=
·· 
request
·· $
.
··$ %
ProductsList
··% 1
.
··1 2
First
··2 7
(
··7 8
)
··8 9
.
··9 :
	IdProduct
··: C
;
··C D
var
‚‚ 
membershipResult
‚‚ 
=
‚‚ 
await
‚‚ $&
_inventoryServiceAdapter
‚‚% =
.
‚‚= >
GetProductById
‚‚> L
(
‚‚L M
firstProductId
‚‚M [
,
‚‚[ \
request
‚‚] d
.
‚‚d e
BrandId
‚‚e l
)
‚‚l m
;
‚‚m n
var
‰‰ 
productResponse
‰‰ 
=
‰‰ 
membershipResult
‰‰ .
.
‰‰. /
Content
‰‰/ 6
!
‰‰6 7
.
‰‰7 8
ToJsonObject
‰‰8 D
<
‰‰D E
ProductResponse
‰‰E T
>
‰‰T U
(
‰‰U V
)
‰‰V W
;
‰‰W X
if
ÊÊ 

(
ÊÊ 
productResponse
ÊÊ 
?
ÊÊ 
.
ÊÊ 
Data
ÊÊ !
==
ÊÊ" $
null
ÊÊ% )
)
ÊÊ) *
return
ÁÁ 
false
ÁÁ 
;
ÁÁ 
var
ÈÈ 
item
ÈÈ 
=
ÈÈ 
productResponse
ÈÈ "
.
ÈÈ" #
Data
ÈÈ# '
;
ÈÈ' (
var
ÍÍ 
product
ÍÍ 
=
ÍÍ 
request
ÍÍ 
.
ÍÍ 
ProductsList
ÍÍ *
.
ÍÍ* +
FirstOrDefault
ÍÍ+ 9
(
ÍÍ9 :
x
ÍÍ: ;
=>
ÍÍ< >
x
ÍÍ? @
.
ÍÍ@ A
	IdProduct
ÍÍA J
==
ÍÍK M
item
ÍÍN R
.
ÍÍR S
Id
ÍÍS U
)
ÍÍU V
;
ÍÍV W
if
ÎÎ 

(
ÎÎ 
product
ÎÎ 
!=
ÎÎ 
null
ÎÎ 
)
ÎÎ 
{
ÏÏ 	
var
ÌÌ 
tax
ÌÌ 
=
ÌÌ 
item
ÌÌ 
.
ÌÌ 
Tax
ÌÌ 
;
ÌÌ 
debit
ÓÓ 
+=
ÓÓ 
(
ÓÓ 
int
ÓÓ 
)
ÓÓ 
(
ÓÓ 
(
ÓÓ 
item
ÓÓ  
.
ÓÓ  !
	SalePrice
ÓÓ! *
*
ÓÓ+ ,
product
ÓÓ- 4
.
ÓÓ4 5
Count
ÓÓ5 :
)
ÓÓ: ;
*
ÓÓ< =
(
ÓÓ> ?
$num
ÓÓ? @
+
ÓÓA B
(
ÓÓC D
tax
ÓÓD G
/
ÓÓH I
$num
ÓÓJ M
)
ÓÓM N
)
ÓÓN O
)
ÓÓO P
;
ÓÓP Q
points
ÔÔ 
+=
ÔÔ 
item
ÔÔ 
.
ÔÔ 
BinaryPoints
ÔÔ '
*
ÔÔ( )
product
ÔÔ* 1
.
ÔÔ1 2
Count
ÔÔ2 7
;
ÔÔ7 8
commissionable
 
+=
 
item
 "
.
" #!
CommissionableValue
# 6
*
7 8
product
9 @
.
@ A
Count
A F
;
F G
if
ÒÒ 
(
ÒÒ 
item
ÒÒ 
.
ÒÒ 

CategoryId
ÒÒ 
==
ÒÒ  "
$num
ÒÒ# $
)
ÒÒ$ %
{
ÚÚ 
origin
ÛÛ 
=
ÛÛ 
$num
ÛÛ 
;
ÛÛ 
}
ÙÙ 
var
ˆˆ 
invoiceDetail
ˆˆ 
=
ˆˆ 
new
ˆˆ  #.
 InvoiceDetailsTransactionRequest
ˆˆ$ D
{
˜˜ 
	ProductId
¯¯ 
=
¯¯ 
item
¯¯  
.
¯¯  !
Id
¯¯! #
,
¯¯# $
PaymentGroupId
˘˘ 
=
˘˘  
item
˘˘! %
.
˘˘% &
PaymentGroup
˘˘& 2
,
˘˘2 3
AccumMinPurchase
˙˙  
=
˙˙! "
item
˙˙# '
.
˙˙' (
AcumCompMin
˙˙( 3
,
˙˙3 4
ProductName
˚˚ 
=
˚˚ 
item
˚˚ "
.
˚˚" #
Name
˚˚# '
!
˚˚' (
,
˚˚( )
ProductPrice
¸¸ 
=
¸¸ 
item
¸¸ #
.
¸¸# $
	SalePrice
¸¸$ -
,
¸¸- .
ProductPriceBtc
˝˝ 
=
˝˝  !
	Constants
˝˝" +
.
˝˝+ ,

EmptyValue
˝˝, 6
,
˝˝6 7

ProductIva
˛˛ 
=
˛˛ 
item
˛˛ !
.
˛˛! "
Tax
˛˛" %
,
˛˛% &
ProductQuantity
ˇˇ 
=
ˇˇ  !
product
ˇˇ" )
.
ˇˇ) *
Count
ˇˇ* /
,
ˇˇ/ 0#
ProductCommissionable
ÄÄ %
=
ÄÄ& '
item
ÄÄ( ,
.
ÄÄ, -!
CommissionableValue
ÄÄ- @
,
ÄÄ@ A
BinaryPoints
ÅÅ 
=
ÅÅ 
item
ÅÅ #
.
ÅÅ# $
BinaryPoints
ÅÅ$ 0
,
ÅÅ0 1
ProductPoints
ÇÇ 
=
ÇÇ 
item
ÇÇ  $
.
ÇÇ$ %
ValuePoints
ÇÇ% 0
,
ÇÇ0 1
ProductDiscount
ÉÉ 
=
ÉÉ  !
	Constants
ÉÉ" +
.
ÉÉ+ ,

EmptyValue
ÉÉ, 6
,
ÉÉ6 7
CombinationId
ÑÑ 
=
ÑÑ 
	Constants
ÑÑ  )
.
ÑÑ) *

EmptyValue
ÑÑ* 4
,
ÑÑ4 5
ProductPack
ÖÖ 
=
ÖÖ 
item
ÖÖ "
.
ÖÖ" #
ProductPacks
ÖÖ# /
,
ÖÖ/ 0

BaseAmount
ÜÜ 
=
ÜÜ 
item
ÜÜ !
.
ÜÜ! "

BaseAmount
ÜÜ" ,
,
ÜÜ, -
DailyPercentage
áá 
=
áá  !
item
áá" &
.
áá& '
DailyPercentage
áá' 6
,
áá6 7
WaitingDays
àà 
=
àà 
item
àà "
.
àà" #
DaysWait
àà# +
,
àà+ ,
DaysToPayQuantity
ââ !
=
ââ" #
	Constants
ââ$ -
.
ââ- .

EmptyValue
ââ. 8
,
ââ8 9
ProductStart
ää 
=
ää 
false
ää $
,
ää$ %
BrandId
ãã 
=
ãã 
request
ãã !
.
ãã! "
BrandId
ãã" )
,
ãã) *
}
åå 
;
åå 
invoiceDetails
éé 
.
éé 
Add
éé 
(
éé 
invoiceDetail
éé ,
)
éé, -
;
éé- .
}
èè 	
if
ëë 

(
ëë 
debit
ëë 
==
ëë 
	Constants
ëë 
.
ëë 

EmptyValue
ëë )
)
ëë) *
return
íí 
false
íí 
;
íí 
if
îî 

(
îî 
invoiceDetails
îî 
.
îî 
Count
îî  
==
îî! #
	Constants
îî$ -
.
îî- .

EmptyValue
îî. 8
)
îî8 9
return
ïï 
false
ïï 
;
ïï 
var
óó %
debitTransactionRequest
óó #
=
óó$ %
new
óó& )%
DebitTransactionRequest
óó* A
{
òò 	
Debit
ôô 
=
ôô 
debit
ôô 
,
ôô 
AffiliateId
öö 
=
öö 
request
öö !
.
öö! "
AffiliateId
öö" -
,
öö- .
UserId
õõ 
=
õõ 
	Constants
õõ 
.
õõ 
AdminUserId
õõ *
,
õõ* +
ConceptType
úú 
=
úú 
WalletConceptType
úú +
.
úú+ ,
purchasing_pool
úú, ;
.
úú; <
ToString
úú< D
(
úúD E
)
úúE F
,
úúF G
Points
ùù 
=
ùù 
points
ùù 
,
ùù 
Concept
ûû 
=
ûû 
	Constants
ûû 
.
ûû  

Membership
ûû  *
,
ûû* +
Commissionable
üü 
=
üü 
commissionable
üü +
,
üü+ ,
Bank
†† 
=
†† 
	Constants
†† 
.
†† 
CoinPay
†† $
,
††$ %
PaymentMethod
°° 
=
°° 
	Constants
°° %
.
°°% &
CoinPay
°°& -
,
°°- .
Origin
¢¢ 
=
¢¢ 
origin
¢¢ 
,
¢¢ 
Level
££ 
=
££ 
	Constants
££ 
.
££ 

EmptyValue
££ (
,
££( )
AffiliateUserName
§§ 
=
§§ 
request
§§  '
.
§§' (
AffiliateUserName
§§( 9
,
§§9 :
AdminUserName
•• 
=
•• 
request
•• #
.
••# $
BrandId
••$ +
==
••, .
$num
••/ 0
?
••1 2
	Constants
••3 <
.
••< =$
AdminEcosystemUserName
••= S
:
••T U
	Constants
••V _
.
••_ `
RecycoinAdmin
••` m
,
••m n
ReceiptNumber
¶¶ 
=
¶¶ 
request
¶¶ #
.
¶¶# $
ReceiptNumber
¶¶$ 1
,
¶¶1 2
Type
ßß 
=
ßß 
true
ßß 
,
ßß 
	SecretKey
®® 
=
®® 
request
®® 
.
®®  
	SecretKey
®®  )
,
®®) *
invoices
©© 
=
©© 
invoiceDetails
©© %
,
©©% &
Reason
™™ 
=
™™ 
request
™™ 
.
™™ 
Bank
™™ !
,
™™! "
BrandId
´´ 
=
´´ 
request
´´ 
.
´´ 
BrandId
´´ %
,
´´% &
}
¨¨ 	
;
¨¨	 

var
ÆÆ 

spResponse
ÆÆ 
=
ÆÆ 
await
ÆÆ 
_walletRepository
ÆÆ 0
.
ÆÆ0 1)
HandleMembershipTransaction
ÆÆ1 L
(
ÆÆL M%
debitTransactionRequest
ÆÆM d
)
ÆÆd e
;
ÆÆe f
if
∞∞ 

(
∞∞ 

spResponse
∞∞ 
is
∞∞ 
null
∞∞ 
)
∞∞ 
return
±± 
false
±± 
;
±± 
await
≥≥ $
_accountServiceAdapter
≥≥ $
.
≥≥$ %"
UpdateActivationDate
≥≥% 9
(
≥≥9 :
request
≥≥: A
.
≥≥A B
AffiliateId
≥≥B M
,
≥≥M N
request
≥≥O V
.
≥≥V W
BrandId
≥≥W ^
)
≥≥^ _
;
≥≥_ `
var
µµ 
	pdfResult
µµ 
=
µµ 
await
∂∂ "
_ecosystemPdfService
∂∂ &
.
∂∂& '
GenerateInvoice
∂∂' 6
(
∂∂6 7
userInfoResponse
∂∂7 G
,
∂∂G H%
debitTransactionRequest
∂∂I `
,
∂∂` a

spResponse
∂∂b l
)
∂∂l m
;
∂∂m n
await
∏∏  
_brevoEmailService
∏∏  
.
∏∏  !
SendEmailWelcome
∏∏! 1
(
∏∏1 2
userInfoResponse
∏∏2 B
,
∏∏B C

spResponse
∏∏D N
,
∏∏N O
request
∏∏P W
.
∏∏W X
BrandId
∏∏X _
)
∏∏_ `
;
∏∏` a
if
∫∫ 

(
∫∫ 
	pdfResult
∫∫ 
.
∫∫ 
Length
∫∫ 
!=
∫∫ 
	Constants
∫∫  )
.
∫∫) *

EmptyValue
∫∫* 4
)
∫∫4 5
{
ªª 	
await
ºº  
_brevoEmailService
ºº $
.
ºº$ %(
SendEmailMembershipConfirm
ºº% ?
(
ºº? @
userInfoResponse
ºº@ P
,
ººP Q
	pdfResult
ººR [
,
ºº[ \

spResponse
ºº] g
,
ººg h
request
ΩΩ 
.
ΩΩ 
BrandId
ΩΩ 
)
ΩΩ  
;
ΩΩ  !
}
ææ 	
return
¿¿ 
true
¿¿ 
;
¿¿ 
}
¡¡ 
public
√√ 

async
√√ 
Task
√√ 
<
√√ 
bool
√√ 
>
√√ $
ExecuteRecyCoinPayment
√√ 2
(
√√2 3
WalletRequest
√√3 @
request
√√A H
)
√√H I
{
ƒƒ 
var
≈≈ 
debit
≈≈ 
=
≈≈ 
$num
≈≈ 
;
≈≈ 
var
∆∆ 
points
∆∆ 
=
∆∆ 
$num
∆∆ 
;
∆∆ 
var
«« 
commissionable
«« 
=
«« 
$num
«« 
;
««  
byte
»» 
origin
»» 
=
»» 
$num
»» 
;
»» 
var
   
invoiceDetails
   
=
   
new
    
List
  ! %
<
  % &.
 InvoiceDetailsTransactionRequest
  & F
>
  F G
(
  G H
)
  H I
;
  I J
var
ÀÀ 
userInfoResponse
ÀÀ 
=
ÀÀ 
await
ÀÀ $$
_accountServiceAdapter
ÀÀ% ;
.
ÀÀ; <
GetUserInfo
ÀÀ< G
(
ÀÀG H
request
ÀÀH O
.
ÀÀO P
AffiliateId
ÀÀP [
,
ÀÀ[ \
request
ÀÀ] d
.
ÀÀd e
BrandId
ÀÀe l
)
ÀÀl m
;
ÀÀm n
var
ÃÃ 

productIds
ÃÃ 
=
ÃÃ 
request
ÃÃ  
.
ÃÃ  !
ProductsList
ÃÃ! -
.
ÃÃ- .
Select
ÃÃ. 4
(
ÃÃ4 5
p
ÃÃ5 6
=>
ÃÃ7 9
p
ÃÃ: ;
.
ÃÃ; <
	IdProduct
ÃÃ< E
)
ÃÃE F
.
ÃÃF G
ToArray
ÃÃG N
(
ÃÃN O
)
ÃÃO P
;
ÃÃP Q
var
ÕÕ 
responseList
ÕÕ 
=
ÕÕ 
await
ÕÕ  &
_inventoryServiceAdapter
ÕÕ! 9
.
ÕÕ9 :
GetProductsIds
ÕÕ: H
(
ÕÕH I

productIds
ÕÕI S
,
ÕÕS T
request
ÕÕU \
.
ÕÕ\ ]
BrandId
ÕÕ] d
)
ÕÕd e
;
ÕÕe f
if
œœ 

(
œœ 
!
œœ 
responseList
œœ 
.
œœ 
IsSuccessful
œœ &
)
œœ& '
return
–– 
false
–– 
;
–– 
if
““ 

(
““ 
string
““ 
.
““ 
IsNullOrEmpty
““  
(
““  !
responseList
““! -
.
““- .
Content
““. 5
)
““5 6
)
““6 7
return
”” 
false
”” 
;
”” 
var
’’ 
result
’’ 
=
’’ 
JsonSerializer
’’ #
.
’’# $
Deserialize
’’$ /
<
’’/ 0
ProductsResponse
’’0 @
>
’’@ A
(
’’A B
responseList
’’B N
.
’’N O
Content
’’O V
)
’’V W
;
’’W X
if
◊◊ 

(
◊◊ 
result
◊◊ 
?
◊◊ 
.
◊◊ 
Data
◊◊ 
.
◊◊ 
Count
◊◊ 
==
◊◊ !
	Constants
◊◊" +
.
◊◊+ ,

EmptyValue
◊◊, 6
)
◊◊6 7
{
ÿÿ 	
var
ŸŸ 
firstProductId
ŸŸ 
=
ŸŸ  
request
ŸŸ! (
.
ŸŸ( )
ProductsList
ŸŸ) 5
.
ŸŸ5 6
First
ŸŸ6 ;
(
ŸŸ; <
)
ŸŸ< =
.
ŸŸ= >
	IdProduct
ŸŸ> G
;
ŸŸG H
var
⁄⁄ 
membershipResult
⁄⁄  
=
⁄⁄! "
await
⁄⁄# (&
_inventoryServiceAdapter
⁄⁄) A
.
⁄⁄A B
GetProductById
⁄⁄B P
(
⁄⁄P Q
firstProductId
⁄⁄Q _
,
⁄⁄_ `
request
⁄⁄a h
.
⁄⁄h i
BrandId
⁄⁄i p
)
⁄⁄p q
;
⁄⁄q r
var
‹‹ 
productResponse
‹‹ 
=
‹‹  !
JsonSerializer
‹‹" 0
.
‹‹0 1
Deserialize
‹‹1 <
<
‹‹< =
ProductResponse
‹‹= L
>
‹‹L M
(
‹‹M N
membershipResult
‹‹N ^
.
‹‹^ _
Content
‹‹_ f
!
‹‹f g
)
‹‹g h
;
‹‹h i
await
ﬁﬁ $
_accountServiceAdapter
ﬁﬁ (
.
ﬁﬁ( )"
UpdateActivationDate
ﬁﬁ) =
(
ﬁﬁ= >
request
ﬁﬁ> E
.
ﬁﬁE F
AffiliateId
ﬁﬁF Q
,
ﬁﬁQ R
request
ﬁﬁS Z
.
ﬁﬁZ [
BrandId
ﬁﬁ[ b
)
ﬁﬁb c
;
ﬁﬁc d
result
‡‡ 
.
‡‡ 
Data
‡‡ 
.
‡‡ 
Add
‡‡ 
(
‡‡ 
productResponse
‡‡ +
!
‡‡+ ,
.
‡‡, -
Data
‡‡- 1
)
‡‡1 2
;
‡‡2 3
}
·· 	
if
„„ 

(
„„ 
result
„„ 
?
„„ 
.
„„ 
Data
„„ 
==
„„ 
null
„„  
)
„„  !
return
‰‰ 
false
‰‰ 
;
‰‰ 
if
ÊÊ 

(
ÊÊ 
result
ÊÊ 
.
ÊÊ 
Data
ÊÊ 
.
ÊÊ 
Count
ÊÊ 
!=
ÊÊ  
request
ÊÊ! (
.
ÊÊ( )
ProductsList
ÊÊ) 5
.
ÊÊ5 6
Count
ÊÊ6 ;
)
ÊÊ; <
return
ÁÁ 
false
ÁÁ 
;
ÁÁ 
foreach
ÈÈ 
(
ÈÈ 
var
ÈÈ 
item
ÈÈ 
in
ÈÈ 
result
ÈÈ #
.
ÈÈ# $
Data
ÈÈ$ (
)
ÈÈ( )
{
ÍÍ 	
var
ÎÎ 
product
ÎÎ 
=
ÎÎ 
request
ÎÎ !
.
ÎÎ! "
ProductsList
ÎÎ" .
.
ÎÎ. /
FirstOrDefault
ÎÎ/ =
(
ÎÎ= >
x
ÎÎ> ?
=>
ÎÎ@ B
x
ÎÎC D
.
ÎÎD E
	IdProduct
ÎÎE N
==
ÎÎO Q
item
ÎÎR V
.
ÎÎV W
Id
ÎÎW Y
)
ÎÎY Z
;
ÎÎZ [
var
ÏÏ 
tax
ÏÏ 
=
ÏÏ 
item
ÏÏ 
.
ÏÏ 
Tax
ÏÏ 
;
ÏÏ 
debit
ÌÌ 
+=
ÌÌ 
(
ÌÌ 
int
ÌÌ 
)
ÌÌ 
(
ÌÌ 
(
ÌÌ 
item
ÌÌ  
.
ÌÌ  !
	SalePrice
ÌÌ! *
*
ÌÌ+ ,
product
ÌÌ- 4
!
ÌÌ4 5
.
ÌÌ5 6
Count
ÌÌ6 ;
)
ÌÌ; <
*
ÌÌ= >
(
ÌÌ? @
$num
ÌÌ@ A
+
ÌÌB C
(
ÌÌD E
tax
ÌÌE H
/
ÌÌI J
$num
ÌÌK N
)
ÌÌN O
)
ÌÌO P
)
ÌÌP Q
;
ÌÌQ R
points
ÓÓ 
+=
ÓÓ 
item
ÓÓ 
.
ÓÓ 
BinaryPoints
ÓÓ '
*
ÓÓ( )
product
ÓÓ* 1
.
ÓÓ1 2
Count
ÓÓ2 7
;
ÓÓ7 8
commissionable
ÔÔ 
+=
ÔÔ 
item
ÔÔ "
.
ÔÔ" #!
CommissionableValue
ÔÔ# 6
*
ÔÔ7 8
product
ÔÔ9 @
.
ÔÔ@ A
Count
ÔÔA F
;
ÔÔF G
if
 
(
 
item
 
.
 

CategoryId
 
==
  "
$num
# $
)
$ %
{
ÒÒ 
origin
ÚÚ 
=
ÚÚ 
$num
ÚÚ 
;
ÚÚ 
}
ÛÛ 
var
ıı 
invoiceDetail
ıı 
=
ıı 
new
ıı  #.
 InvoiceDetailsTransactionRequest
ıı$ D
{
ˆˆ 
	ProductId
˜˜ 
=
˜˜ 
item
˜˜  
.
˜˜  !
Id
˜˜! #
,
˜˜# $
PaymentGroupId
¯¯ 
=
¯¯  
item
¯¯! %
.
¯¯% &
PaymentGroup
¯¯& 2
,
¯¯2 3
AccumMinPurchase
˘˘  
=
˘˘! "
item
˘˘# '
.
˘˘' (
AcumCompMin
˘˘( 3
,
˘˘3 4
ProductName
˙˙ 
=
˙˙ 
item
˙˙ "
.
˙˙" #
Name
˙˙# '
!
˙˙' (
,
˙˙( )
ProductPrice
˚˚ 
=
˚˚ 
item
˚˚ #
.
˚˚# $
	SalePrice
˚˚$ -
,
˚˚- .
ProductPriceBtc
¸¸ 
=
¸¸  !
	Constants
¸¸" +
.
¸¸+ ,

EmptyValue
¸¸, 6
,
¸¸6 7

ProductIva
˝˝ 
=
˝˝ 
item
˝˝ !
.
˝˝! "
Tax
˝˝" %
,
˝˝% &
ProductQuantity
˛˛ 
=
˛˛  !
product
˛˛" )
.
˛˛) *
Count
˛˛* /
,
˛˛/ 0#
ProductCommissionable
ˇˇ %
=
ˇˇ& '
item
ˇˇ( ,
.
ˇˇ, -!
CommissionableValue
ˇˇ- @
,
ˇˇ@ A
BinaryPoints
ÄÄ 
=
ÄÄ 
item
ÄÄ #
.
ÄÄ# $
BinaryPoints
ÄÄ$ 0
,
ÄÄ0 1
ProductPoints
ÅÅ 
=
ÅÅ 
item
ÅÅ  $
.
ÅÅ$ %
ValuePoints
ÅÅ% 0
,
ÅÅ0 1
ProductDiscount
ÇÇ 
=
ÇÇ  !
item
ÇÇ" &
.
ÇÇ& '
ProductDiscount
ÇÇ' 6
,
ÇÇ6 7
CombinationId
ÉÉ 
=
ÉÉ 
	Constants
ÉÉ  )
.
ÉÉ) *

EmptyValue
ÉÉ* 4
,
ÉÉ4 5
ProductPack
ÑÑ 
=
ÑÑ 
item
ÑÑ "
.
ÑÑ" #
ProductPacks
ÑÑ# /
,
ÑÑ/ 0

BaseAmount
ÖÖ 
=
ÖÖ 
(
ÖÖ 
item
ÖÖ "
.
ÖÖ" #

BaseAmount
ÖÖ# -
*
ÖÖ. /
product
ÖÖ0 7
.
ÖÖ7 8
Count
ÖÖ8 =
)
ÖÖ= >
,
ÖÖ> ?
DailyPercentage
ÜÜ 
=
ÜÜ  !
item
ÜÜ" &
.
ÜÜ& '
DailyPercentage
ÜÜ' 6
,
ÜÜ6 7
WaitingDays
áá 
=
áá 
item
áá "
.
áá" #
DaysWait
áá# +
,
áá+ ,
DaysToPayQuantity
àà !
=
àà" #
	Constants
àà$ -
.
àà- .
DaysToPayQuantity
àà. ?
,
àà? @
ProductStart
ââ 
=
ââ 
false
ââ $
,
ââ$ %
BrandId
ää 
=
ää 
request
ää !
.
ää! "
BrandId
ää" )
,
ää) *
}
ãã 
;
ãã 
invoiceDetails
çç 
.
çç 
Add
çç 
(
çç 
invoiceDetail
çç ,
)
çç, -
;
çç- .
}
éé 	
if
êê 

(
êê 
debit
êê 
==
êê 
	Constants
êê 
.
êê 

EmptyValue
êê )
)
êê) *
return
ëë 
false
ëë 
;
ëë 
if
ìì 

(
ìì 
invoiceDetails
ìì 
.
ìì 
Count
ìì  
==
ìì! #
	Constants
ìì$ -
.
ìì- .

EmptyValue
ìì. 8
)
ìì8 9
return
îî 
false
îî 
;
îî 
var
ññ %
debitTransactionRequest
ññ #
=
ññ$ %
new
ññ& )%
DebitTransactionRequest
ññ* A
{
óó 	
Debit
òò 
=
òò 
debit
òò 
,
òò 
AffiliateId
ôô 
=
ôô 
request
ôô !
.
ôô! "
AffiliateId
ôô" -
,
ôô- .
UserId
öö 
=
öö 
	Constants
öö 
.
öö 
AdminUserId
öö *
,
öö* +
ConceptType
õõ 
=
õõ 
WalletConceptType
õõ +
.
õõ+ ,
purchasing_pool
õõ, ;
.
õõ; <
ToString
õõ< D
(
õõD E
)
õõE F
,
õõF G
Points
úú 
=
úú 
points
úú 
,
úú 
Concept
ùù 
=
ùù 
	Constants
ùù 
.
ùù  $
EcoPoolProductCategory
ùù  6
,
ùù6 7
Commissionable
ûû 
=
ûû 
commissionable
ûû +
,
ûû+ ,
Bank
üü 
=
üü 
	Constants
üü 
.
üü 
CoinPay
üü $
,
üü$ %
PaymentMethod
†† 
=
†† 
	Constants
†† %
.
††% &
CoinPay
††& -
,
††- .
Origin
°° 
=
°° 
origin
°° 
,
°° 
Level
¢¢ 
=
¢¢ 
	Constants
¢¢ 
.
¢¢ 

EmptyValue
¢¢ (
,
¢¢( )
AffiliateUserName
££ 
=
££ 
request
££  '
.
££' (
AffiliateUserName
££( 9
,
££9 :
AdminUserName
§§ 
=
§§ 
request
§§ #
.
§§# $
BrandId
§§$ +
==
§§, .
$num
§§/ 0
?
§§1 2
	Constants
§§3 <
.
§§< =$
AdminEcosystemUserName
§§= S
:
§§T U
	Constants
§§V _
.
§§_ `
RecycoinAdmin
§§` m
,
§§m n
ReceiptNumber
•• 
=
•• 
request
•• #
.
••# $
ReceiptNumber
••$ 1
,
••1 2
Type
¶¶ 
=
¶¶ 
true
¶¶ 
,
¶¶ 
	SecretKey
ßß 
=
ßß 
request
ßß 
.
ßß  
	SecretKey
ßß  )
,
ßß) *
invoices
®® 
=
®® 
invoiceDetails
®® %
,
®®% &
Reason
©© 
=
©© 
request
©© 
.
©© 
Bank
©© !
,
©©! "
BrandId
™™ 
=
™™ 
request
™™ 
.
™™ 
BrandId
™™ %
,
™™% &
}
´´ 	
;
´´	 

var
≠≠ 

spResponse
≠≠ 
=
≠≠ 
await
≠≠  
_invoiceRepository
≠≠ 1
.
≠≠1 2$
HandleDebitTransaction
≠≠2 H
(
≠≠H I%
debitTransactionRequest
≠≠I `
)
≠≠` a
;
≠≠a b
if
ØØ 

(
ØØ 

spResponse
ØØ 
is
ØØ 
null
ØØ 
)
ØØ 
return
∞∞ 
false
∞∞ 
;
∞∞ 
if
≤≤ 

(
≤≤ 
request
≤≤ 
.
≤≤ 
BrandId
≤≤ 
==
≤≤ 
	Constants
≤≤ (
.
≤≤( )
RecyCoin
≤≤) 1
)
≤≤1 2
{
≥≥ 	
await
ππ 
_walletRepository
ππ #
.
ππ# $3
%DistributeCommissionsPerPurchaseAsync
ππ$ I
(
ππI J
new
ππJ M*
DistributeCommissionsRequest
ππN j
{
∫∫ 
AffiliateId
ªª 
=
ªª 
request
ªª %
.
ªª% &
AffiliateId
ªª& 1
,
ªª1 2
InvoiceAmount
ºº 
=
ºº %
debitTransactionRequest
ºº  7
.
ºº7 8
Debit
ºº8 =
,
ºº= >
BrandId
ΩΩ 
=
ΩΩ 
request
ΩΩ !
.
ΩΩ! "
BrandId
ΩΩ" )
,
ΩΩ) *
AdminUserName
ææ 
=
ææ 
	Constants
ææ  )
.
ææ) *
RecycoinAdmin
ææ* 7
,
ææ7 8
LevelPercentages
øø  
=
øø! "
[
øø# $
$num
øø$ (
,
øø( )
$num
øø) -
,
øø- .
$num
øø. 2
,
øø2 3
$num
øø3 7
,
øø7 8
$num
øø8 <
]
øø< =
}
¿¿ 
)
¿¿ 
;
¿¿ 
}
¡¡ 	
await
√√ 
RemoveCacheKey
√√ 
(
√√ 
request
√√ $
.
√√$ %
AffiliateId
√√% 0
,
√√0 1
	CacheKeys
√√2 ;
.
√√; <&
BalanceInformationModel2
√√< T
)
√√T U
;
√√U V
var
ƒƒ 

invoicePdf
ƒƒ 
=
ƒƒ 
await
≈≈ !
_recyCoinPdfService
≈≈ %
.
≈≈% &
GenerateInvoice
≈≈& 5
(
≈≈5 6
userInfoResponse
≈≈6 F
!
≈≈F G
,
≈≈G H%
debitTransactionRequest
≈≈I `
,
≈≈` a

spResponse
≈≈b l
)
≈≈l m
;
≈≈m n

Dictionary
«« 
<
«« 
string
«« 
,
«« 
byte
«« 
[
««  
]
««  !
>
««! "

allPdfData
««# -
=
««. /
new
««0 3

Dictionary
««4 >
<
««> ?
string
««? E
,
««E F
byte
««G K
[
««K L
]
««L M
>
««M N
{
»» 	
[
…… 
$str
…… 
]
…… 
=
…… 

invoicePdf
…… (
}
   	
;
  	 

if
ÃÃ 

(
ÃÃ 

invoicePdf
ÃÃ 
.
ÃÃ 
Length
ÃÃ 
!=
ÃÃ  
	Constants
ÃÃ! *
.
ÃÃ* +

EmptyValue
ÃÃ+ 5
)
ÃÃ5 6
{
ÕÕ 	
await
ŒŒ  
_brevoEmailService
ŒŒ $
.
ŒŒ$ %&
SendEmailPurchaseConfirm
ŒŒ% =
(
ŒŒ= >
userInfoResponse
ŒŒ> N
!
ŒŒN O
,
ŒŒO P

allPdfData
ŒŒQ [
,
ŒŒ[ \

spResponse
ŒŒ] g
,
ŒŒg h
request
œœ 
.
œœ 
BrandId
œœ 
)
œœ  
;
œœ  !
}
–– 	
return
““ 
true
““ 
;
““ 
}
”” 
public
’’ 

async
’’ 
Task
’’ 
<
’’ 
bool
’’ 
>
’’ %
ExecuteHouseCoinPayment
’’ 3
(
’’3 4
WalletRequest
’’4 A
request
’’B I
)
’’I J
{
÷÷ 
var
◊◊ 
debit
◊◊ 
=
◊◊ 
$num
◊◊ 
;
◊◊ 
var
ÿÿ 
points
ÿÿ 
=
ÿÿ 
$num
ÿÿ 
;
ÿÿ 
var
ŸŸ 
commissionable
ŸŸ 
=
ŸŸ 
$num
ŸŸ 
;
ŸŸ  
byte
⁄⁄ 
origin
⁄⁄ 
=
⁄⁄ 
$num
⁄⁄ 
;
⁄⁄ 
var
‹‹ 
invoiceDetails
‹‹ 
=
‹‹ 
new
‹‹  
List
‹‹! %
<
‹‹% &.
 InvoiceDetailsTransactionRequest
‹‹& F
>
‹‹F G
(
‹‹G H
)
‹‹H I
;
‹‹I J
var
›› 
userInfoResponse
›› 
=
›› 
await
›› $$
_accountServiceAdapter
››% ;
.
››; <
GetUserInfo
››< G
(
››G H
request
››H O
.
››O P
AffiliateId
››P [
,
››[ \
request
››] d
.
››d e
BrandId
››e l
)
››l m
;
››m n
var
ﬁﬁ 

productIds
ﬁﬁ 
=
ﬁﬁ 
request
ﬁﬁ  
.
ﬁﬁ  !
ProductsList
ﬁﬁ! -
.
ﬁﬁ- .
Select
ﬁﬁ. 4
(
ﬁﬁ4 5
p
ﬁﬁ5 6
=>
ﬁﬁ7 9
p
ﬁﬁ: ;
.
ﬁﬁ; <
	IdProduct
ﬁﬁ< E
)
ﬁﬁE F
.
ﬁﬁF G
ToArray
ﬁﬁG N
(
ﬁﬁN O
)
ﬁﬁO P
;
ﬁﬁP Q
var
ﬂﬂ 
responseList
ﬂﬂ 
=
ﬂﬂ 
await
ﬂﬂ  &
_inventoryServiceAdapter
ﬂﬂ! 9
.
ﬂﬂ9 :
GetProductsIds
ﬂﬂ: H
(
ﬂﬂH I

productIds
ﬂﬂI S
,
ﬂﬂS T
request
ﬂﬂU \
.
ﬂﬂ\ ]
BrandId
ﬂﬂ] d
)
ﬂﬂd e
;
ﬂﬂe f
if
·· 

(
·· 
!
·· 
responseList
·· 
.
·· 
IsSuccessful
·· &
)
··& '
return
‚‚ 
false
‚‚ 
;
‚‚ 
if
‰‰ 

(
‰‰ 
string
‰‰ 
.
‰‰ 
IsNullOrEmpty
‰‰  
(
‰‰  !
responseList
‰‰! -
.
‰‰- .
Content
‰‰. 5
)
‰‰5 6
)
‰‰6 7
return
ÂÂ 
false
ÂÂ 
;
ÂÂ 
var
ÁÁ 
result
ÁÁ 
=
ÁÁ 
JsonSerializer
ÁÁ #
.
ÁÁ# $
Deserialize
ÁÁ$ /
<
ÁÁ/ 0
ProductsResponse
ÁÁ0 @
>
ÁÁ@ A
(
ÁÁA B
responseList
ÁÁB N
.
ÁÁN O
Content
ÁÁO V
)
ÁÁV W
;
ÁÁW X
if
ÈÈ 

(
ÈÈ 
result
ÈÈ 
?
ÈÈ 
.
ÈÈ 
Data
ÈÈ 
.
ÈÈ 
Count
ÈÈ 
==
ÈÈ !
	Constants
ÈÈ" +
.
ÈÈ+ ,

EmptyValue
ÈÈ, 6
)
ÈÈ6 7
{
ÍÍ 	
var
ÎÎ 
firstProductId
ÎÎ 
=
ÎÎ  
request
ÎÎ! (
.
ÎÎ( )
ProductsList
ÎÎ) 5
.
ÎÎ5 6
First
ÎÎ6 ;
(
ÎÎ; <
)
ÎÎ< =
.
ÎÎ= >
	IdProduct
ÎÎ> G
;
ÎÎG H
var
ÏÏ 
membershipResult
ÏÏ  
=
ÏÏ! "
await
ÏÏ# (&
_inventoryServiceAdapter
ÏÏ) A
.
ÏÏA B
GetProductById
ÏÏB P
(
ÏÏP Q
firstProductId
ÏÏQ _
,
ÏÏ_ `
request
ÏÏa h
.
ÏÏh i
BrandId
ÏÏi p
)
ÏÏp q
;
ÏÏq r
var
ÓÓ 
productResponse
ÓÓ 
=
ÓÓ  !
JsonSerializer
ÓÓ" 0
.
ÓÓ0 1
Deserialize
ÓÓ1 <
<
ÓÓ< =
ProductResponse
ÓÓ= L
>
ÓÓL M
(
ÓÓM N
membershipResult
ÓÓN ^
.
ÓÓ^ _
Content
ÓÓ_ f
!
ÓÓf g
)
ÓÓg h
;
ÓÓh i
await
 $
_accountServiceAdapter
 (
.
( )"
UpdateActivationDate
) =
(
= >
request
> E
.
E F
AffiliateId
F Q
,
Q R
request
S Z
.
Z [
BrandId
[ b
)
b c
;
c d
result
ÚÚ 
.
ÚÚ 
Data
ÚÚ 
.
ÚÚ 
Add
ÚÚ 
(
ÚÚ 
productResponse
ÚÚ +
!
ÚÚ+ ,
.
ÚÚ, -
Data
ÚÚ- 1
)
ÚÚ1 2
;
ÚÚ2 3
}
ÛÛ 	
if
ıı 

(
ıı 
result
ıı 
?
ıı 
.
ıı 
Data
ıı 
==
ıı 
null
ıı  
)
ıı  !
return
ˆˆ 
false
ˆˆ 
;
ˆˆ 
if
¯¯ 

(
¯¯ 
result
¯¯ 
.
¯¯ 
Data
¯¯ 
.
¯¯ 
Count
¯¯ 
!=
¯¯  
request
¯¯! (
.
¯¯( )
ProductsList
¯¯) 5
.
¯¯5 6
Count
¯¯6 ;
)
¯¯; <
return
˘˘ 
false
˘˘ 
;
˘˘ 
foreach
˚˚ 
(
˚˚ 
var
˚˚ 
item
˚˚ 
in
˚˚ 
result
˚˚ #
.
˚˚# $
Data
˚˚$ (
)
˚˚( )
{
¸¸ 	
var
˝˝ 
product
˝˝ 
=
˝˝ 
request
˝˝ !
.
˝˝! "
ProductsList
˝˝" .
.
˝˝. /
FirstOrDefault
˝˝/ =
(
˝˝= >
x
˝˝> ?
=>
˝˝@ B
x
˝˝C D
.
˝˝D E
	IdProduct
˝˝E N
==
˝˝O Q
item
˝˝R V
.
˝˝V W
Id
˝˝W Y
)
˝˝Y Z
;
˝˝Z [
var
˛˛ 
tax
˛˛ 
=
˛˛ 
item
˛˛ 
.
˛˛ 
Tax
˛˛ 
;
˛˛ 
debit
ˇˇ 
+=
ˇˇ 
(
ˇˇ 
int
ˇˇ 
)
ˇˇ 
(
ˇˇ 
(
ˇˇ 
item
ˇˇ  
.
ˇˇ  !
	SalePrice
ˇˇ! *
*
ˇˇ+ ,
product
ˇˇ- 4
!
ˇˇ4 5
.
ˇˇ5 6
Count
ˇˇ6 ;
)
ˇˇ; <
*
ˇˇ= >
(
ˇˇ? @
$num
ˇˇ@ A
+
ˇˇB C
(
ˇˇD E
tax
ˇˇE H
/
ˇˇI J
$num
ˇˇK N
)
ˇˇN O
)
ˇˇO P
)
ˇˇP Q
;
ˇˇQ R
points
ÄÄ 
+=
ÄÄ 
item
ÄÄ 
.
ÄÄ 
BinaryPoints
ÄÄ '
*
ÄÄ( )
product
ÄÄ* 1
.
ÄÄ1 2
Count
ÄÄ2 7
;
ÄÄ7 8
commissionable
ÅÅ 
+=
ÅÅ 
item
ÅÅ "
.
ÅÅ" #!
CommissionableValue
ÅÅ# 6
*
ÅÅ7 8
product
ÅÅ9 @
.
ÅÅ@ A
Count
ÅÅA F
;
ÅÅF G
if
ÇÇ 
(
ÇÇ 
item
ÇÇ 
.
ÇÇ 

CategoryId
ÇÇ 
==
ÇÇ  "
$num
ÇÇ# $
)
ÇÇ$ %
{
ÉÉ 
origin
ÑÑ 
=
ÑÑ 
$num
ÑÑ 
;
ÑÑ 
}
ÖÖ 
var
áá 
invoiceDetail
áá 
=
áá 
new
áá  #.
 InvoiceDetailsTransactionRequest
áá$ D
{
àà 
	ProductId
ââ 
=
ââ 
item
ââ  
.
ââ  !
Id
ââ! #
,
ââ# $
PaymentGroupId
ää 
=
ää  
item
ää! %
.
ää% &
PaymentGroup
ää& 2
,
ää2 3
AccumMinPurchase
ãã  
=
ãã! "
item
ãã# '
.
ãã' (
AcumCompMin
ãã( 3
,
ãã3 4
ProductName
åå 
=
åå 
item
åå "
.
åå" #
Name
åå# '
!
åå' (
,
åå( )
ProductPrice
çç 
=
çç 
item
çç #
.
çç# $
	SalePrice
çç$ -
,
çç- .
ProductPriceBtc
éé 
=
éé  !
	Constants
éé" +
.
éé+ ,

EmptyValue
éé, 6
,
éé6 7

ProductIva
èè 
=
èè 
item
èè !
.
èè! "
Tax
èè" %
,
èè% &
ProductQuantity
êê 
=
êê  !
product
êê" )
.
êê) *
Count
êê* /
,
êê/ 0#
ProductCommissionable
ëë %
=
ëë& '
item
ëë( ,
.
ëë, -!
CommissionableValue
ëë- @
,
ëë@ A
BinaryPoints
íí 
=
íí 
item
íí #
.
íí# $
BinaryPoints
íí$ 0
,
íí0 1
ProductPoints
ìì 
=
ìì 
item
ìì  $
.
ìì$ %
ValuePoints
ìì% 0
,
ìì0 1
ProductDiscount
îî 
=
îî  !
item
îî" &
.
îî& '
ProductDiscount
îî' 6
,
îî6 7
CombinationId
ïï 
=
ïï 
	Constants
ïï  )
.
ïï) *

EmptyValue
ïï* 4
,
ïï4 5
ProductPack
ññ 
=
ññ 
item
ññ "
.
ññ" #
ProductPacks
ññ# /
,
ññ/ 0

BaseAmount
óó 
=
óó 
(
óó 
item
óó "
.
óó" #

BaseAmount
óó# -
*
óó. /
product
óó0 7
.
óó7 8
Count
óó8 =
)
óó= >
,
óó> ?
DailyPercentage
òò 
=
òò  !
item
òò" &
.
òò& '
DailyPercentage
òò' 6
,
òò6 7
WaitingDays
ôô 
=
ôô 
item
ôô "
.
ôô" #
DaysWait
ôô# +
,
ôô+ ,
DaysToPayQuantity
öö !
=
öö" #
	Constants
öö$ -
.
öö- .
DaysToPayQuantity
öö. ?
,
öö? @
ProductStart
õõ 
=
õõ 
false
õõ $
,
õõ$ %
BrandId
úú 
=
úú 
request
úú !
.
úú! "
BrandId
úú" )
,
úú) *
}
ùù 
;
ùù 
invoiceDetails
üü 
.
üü 
Add
üü 
(
üü 
invoiceDetail
üü ,
)
üü, -
;
üü- .
}
†† 	
if
¢¢ 

(
¢¢ 
debit
¢¢ 
==
¢¢ 
	Constants
¢¢ 
.
¢¢ 

EmptyValue
¢¢ )
)
¢¢) *
return
££ 
false
££ 
;
££ 
if
•• 

(
•• 
invoiceDetails
•• 
.
•• 
Count
••  
==
••! #
	Constants
••$ -
.
••- .

EmptyValue
••. 8
)
••8 9
return
¶¶ 
false
¶¶ 
;
¶¶ 
var
®® %
debitTransactionRequest
®® #
=
®®$ %
new
®®& )%
DebitTransactionRequest
®®* A
{
©© 	
Debit
™™ 
=
™™ 
debit
™™ 
,
™™ 
AffiliateId
´´ 
=
´´ 
request
´´ !
.
´´! "
AffiliateId
´´" -
,
´´- .
UserId
¨¨ 
=
¨¨ 
	Constants
¨¨ 
.
¨¨ 
AdminUserId
¨¨ *
,
¨¨* +
ConceptType
≠≠ 
=
≠≠ 
WalletConceptType
≠≠ +
.
≠≠+ ,
purchasing_pool
≠≠, ;
.
≠≠; <
ToString
≠≠< D
(
≠≠D E
)
≠≠E F
,
≠≠F G
Points
ÆÆ 
=
ÆÆ 
points
ÆÆ 
,
ÆÆ 
Concept
ØØ 
=
ØØ 
	Constants
ØØ 
.
ØØ  $
EcoPoolProductCategory
ØØ  6
,
ØØ6 7
Commissionable
∞∞ 
=
∞∞ 
commissionable
∞∞ +
,
∞∞+ ,
Bank
±± 
=
±± 
	Constants
±± 
.
±± 
CoinPay
±± $
,
±±$ %
PaymentMethod
≤≤ 
=
≤≤ 
	Constants
≤≤ %
.
≤≤% &
CoinPay
≤≤& -
,
≤≤- .
Origin
≥≥ 
=
≥≥ 
origin
≥≥ 
,
≥≥ 
Level
¥¥ 
=
¥¥ 
	Constants
¥¥ 
.
¥¥ 

EmptyValue
¥¥ (
,
¥¥( )
AffiliateUserName
µµ 
=
µµ 
request
µµ  '
.
µµ' (
AffiliateUserName
µµ( 9
,
µµ9 :
AdminUserName
∂∂ 
=
∂∂ 
	Constants
∂∂ %
.
∂∂% &
HouseCoinAdmin
∂∂& 4
,
∂∂4 5
ReceiptNumber
∑∑ 
=
∑∑ 
request
∑∑ #
.
∑∑# $
ReceiptNumber
∑∑$ 1
,
∑∑1 2
Type
∏∏ 
=
∏∏ 
true
∏∏ 
,
∏∏ 
	SecretKey
ππ 
=
ππ 
request
ππ 
.
ππ  
	SecretKey
ππ  )
,
ππ) *
invoices
∫∫ 
=
∫∫ 
invoiceDetails
∫∫ %
,
∫∫% &
Reason
ªª 
=
ªª 
request
ªª 
.
ªª 
Bank
ªª !
,
ªª! "
BrandId
ºº 
=
ºº 
request
ºº 
.
ºº 
BrandId
ºº %
,
ºº% &
}
ΩΩ 	
;
ΩΩ	 

var
øø 

spResponse
øø 
=
øø 
await
øø  
_invoiceRepository
øø 1
.
øø1 2$
HandleDebitTransaction
øø2 H
(
øøH I%
debitTransactionRequest
øøI `
)
øø` a
;
øøa b
if
¡¡ 

(
¡¡ 

spResponse
¡¡ 
is
¡¡ 
null
¡¡ 
)
¡¡ 
return
¬¬ 
false
¬¬ 
;
¬¬ 
await
ƒƒ 
RemoveCacheKey
ƒƒ 
(
ƒƒ 
request
ƒƒ $
.
ƒƒ$ %
AffiliateId
ƒƒ% 0
,
ƒƒ0 1
	CacheKeys
ƒƒ2 ;
.
ƒƒ; <&
BalanceInformationModel2
ƒƒ< T
)
ƒƒT U
;
ƒƒU V
var
≈≈ 

invoicePdf
≈≈ 
=
≈≈ 
await
∆∆ "
_houseCoinPdfService
∆∆ &
.
∆∆& '
GenerateInvoice
∆∆' 6
(
∆∆6 7
userInfoResponse
∆∆7 G
!
∆∆G H
,
∆∆H I%
debitTransactionRequest
∆∆J a
,
∆∆a b

spResponse
∆∆c m
)
∆∆m n
;
∆∆n o
await
«« 
_walletRepository
«« 
.
««  3
%DistributeCommissionsPerPurchaseAsync
««  E
(
««E F
new
««F I*
DistributeCommissionsRequest
««J f
{
»» 	
AffiliateId
…… 
=
…… 
request
…… !
.
……! "
AffiliateId
……" -
,
……- .
InvoiceAmount
   
=
   %
debitTransactionRequest
   3
.
  3 4
Debit
  4 9
,
  9 :
BrandId
ÀÀ 
=
ÀÀ 
request
ÀÀ 
.
ÀÀ 
BrandId
ÀÀ %
,
ÀÀ% &
AdminUserName
ÃÃ 
=
ÃÃ 
	Constants
ÃÃ %
.
ÃÃ% &
HouseCoinAdmin
ÃÃ& 4
,
ÃÃ4 5
LevelPercentages
ÕÕ 
=
ÕÕ 
[
ÕÕ  
$num
ÕÕ  $
,
ÕÕ$ %
$num
ÕÕ& *
,
ÕÕ* +
$num
ÕÕ, 0
,
ÕÕ0 1
$num
ÕÕ2 6
,
ÕÕ6 7
$num
ÕÕ8 <
]
ÕÕ< =
,
ÕÕ= >
}
ŒŒ 	
)
ŒŒ	 

;
ŒŒ
 

Dictionary
–– 
<
–– 
string
–– 
,
–– 
byte
–– 
[
––  
]
––  !
>
––! "

allPdfData
––# -
=
––. /
new
––0 3

Dictionary
––4 >
<
––> ?
string
––? E
,
––E F
byte
––G K
[
––K L
]
––L M
>
––M N
{
—— 	
[
““ 
$str
““ 
]
““ 
=
““ 

invoicePdf
““ (
}
”” 	
;
””	 

if
’’ 

(
’’ 

invoicePdf
’’ 
.
’’ 
Length
’’ 
!=
’’  
	Constants
’’! *
.
’’* +

EmptyValue
’’+ 5
)
’’5 6
{
÷÷ 	
await
◊◊  
_brevoEmailService
◊◊ $
.
◊◊$ %&
SendEmailPurchaseConfirm
◊◊% =
(
◊◊= >
userInfoResponse
◊◊> N
!
◊◊N O
,
◊◊O P

allPdfData
◊◊Q [
,
◊◊[ \

spResponse
◊◊] g
,
◊◊g h
request
ÿÿ 
.
ÿÿ 
BrandId
ÿÿ 
)
ÿÿ  
;
ÿÿ  !
}
ŸŸ 	
return
€€ 
true
€€ 
;
€€ 
}
‹‹ 
public
ﬁﬁ 

async
ﬁﬁ 
Task
ﬁﬁ 
<
ﬁﬁ 
bool
ﬁﬁ 
>
ﬁﬁ '
ExecuteExitoJuntosPayment
ﬁﬁ 5
(
ﬁﬁ5 6
WalletRequest
ﬁﬁ6 C
request
ﬁﬁD K
)
ﬁﬁK L
{
ﬂﬂ 
var
‡‡ 
debit
‡‡ 
=
‡‡ 
$num
‡‡ 
;
‡‡ 
var
·· 
points
·· 
=
·· 
$num
·· 
;
·· 
var
‚‚ 
commissionable
‚‚ 
=
‚‚ 
$num
‚‚ 
;
‚‚  
byte
„„ 
origin
„„ 
=
„„ 
$num
„„ 
;
„„ 
var
ÂÂ 
invoiceDetails
ÂÂ 
=
ÂÂ 
new
ÂÂ  
List
ÂÂ! %
<
ÂÂ% &.
 InvoiceDetailsTransactionRequest
ÂÂ& F
>
ÂÂF G
(
ÂÂG H
)
ÂÂH I
;
ÂÂI J
var
ÊÊ 
userInfoResponse
ÊÊ 
=
ÊÊ 
await
ÊÊ $$
_accountServiceAdapter
ÊÊ% ;
.
ÊÊ; <
GetUserInfo
ÊÊ< G
(
ÊÊG H
request
ÊÊH O
.
ÊÊO P
AffiliateId
ÊÊP [
,
ÊÊ[ \
request
ÊÊ] d
.
ÊÊd e
BrandId
ÊÊe l
)
ÊÊl m
;
ÊÊm n
var
ÁÁ 

productIds
ÁÁ 
=
ÁÁ 
request
ÁÁ  
.
ÁÁ  !
ProductsList
ÁÁ! -
.
ÁÁ- .
Select
ÁÁ. 4
(
ÁÁ4 5
p
ÁÁ5 6
=>
ÁÁ7 9
p
ÁÁ: ;
.
ÁÁ; <
	IdProduct
ÁÁ< E
)
ÁÁE F
.
ÁÁF G
ToArray
ÁÁG N
(
ÁÁN O
)
ÁÁO P
;
ÁÁP Q
var
ËË 
responseList
ËË 
=
ËË 
await
ËË  &
_inventoryServiceAdapter
ËË! 9
.
ËË9 :
GetProductsIds
ËË: H
(
ËËH I

productIds
ËËI S
,
ËËS T
request
ËËU \
.
ËË\ ]
BrandId
ËË] d
)
ËËd e
;
ËËe f
if
ÍÍ 

(
ÍÍ 
!
ÍÍ 
responseList
ÍÍ 
.
ÍÍ 
IsSuccessful
ÍÍ &
)
ÍÍ& '
return
ÎÎ 
false
ÎÎ 
;
ÎÎ 
if
ÌÌ 

(
ÌÌ 
string
ÌÌ 
.
ÌÌ 
IsNullOrEmpty
ÌÌ  
(
ÌÌ  !
responseList
ÌÌ! -
.
ÌÌ- .
Content
ÌÌ. 5
)
ÌÌ5 6
)
ÌÌ6 7
return
ÓÓ 
false
ÓÓ 
;
ÓÓ 
var
 
result
 
=
 
JsonSerializer
 #
.
# $
Deserialize
$ /
<
/ 0
ProductsResponse
0 @
>
@ A
(
A B
responseList
B N
.
N O
Content
O V
)
V W
;
W X
if
ÚÚ 

(
ÚÚ 
result
ÚÚ 
?
ÚÚ 
.
ÚÚ 
Data
ÚÚ 
.
ÚÚ 
Count
ÚÚ 
==
ÚÚ !
	Constants
ÚÚ" +
.
ÚÚ+ ,

EmptyValue
ÚÚ, 6
)
ÚÚ6 7
{
ÛÛ 	
var
ÙÙ 
firstProductId
ÙÙ 
=
ÙÙ  
request
ÙÙ! (
.
ÙÙ( )
ProductsList
ÙÙ) 5
.
ÙÙ5 6
First
ÙÙ6 ;
(
ÙÙ; <
)
ÙÙ< =
.
ÙÙ= >
	IdProduct
ÙÙ> G
;
ÙÙG H
var
ıı 
membershipResult
ıı  
=
ıı! "
await
ıı# (&
_inventoryServiceAdapter
ıı) A
.
ııA B
GetProductById
ııB P
(
ııP Q
firstProductId
ııQ _
,
ıı_ `
request
ııa h
.
ııh i
BrandId
ııi p
)
ııp q
;
ııq r
var
˜˜ 
productResponse
˜˜ 
=
˜˜  !
JsonSerializer
˜˜" 0
.
˜˜0 1
Deserialize
˜˜1 <
<
˜˜< =
ProductResponse
˜˜= L
>
˜˜L M
(
˜˜M N
membershipResult
˜˜N ^
.
˜˜^ _
Content
˜˜_ f
!
˜˜f g
)
˜˜g h
;
˜˜h i
await
˘˘ $
_accountServiceAdapter
˘˘ (
.
˘˘( )"
UpdateActivationDate
˘˘) =
(
˘˘= >
request
˘˘> E
.
˘˘E F
AffiliateId
˘˘F Q
,
˘˘Q R
request
˘˘S Z
.
˘˘Z [
BrandId
˘˘[ b
)
˘˘b c
;
˘˘c d
result
˚˚ 
.
˚˚ 
Data
˚˚ 
.
˚˚ 
Add
˚˚ 
(
˚˚ 
productResponse
˚˚ +
!
˚˚+ ,
.
˚˚, -
Data
˚˚- 1
)
˚˚1 2
;
˚˚2 3
}
¸¸ 	
if
˛˛ 

(
˛˛ 
result
˛˛ 
?
˛˛ 
.
˛˛ 
Data
˛˛ 
==
˛˛ 
null
˛˛  
)
˛˛  !
return
ˇˇ 
false
ˇˇ 
;
ˇˇ 
if
ÅÅ 

(
ÅÅ 
result
ÅÅ 
.
ÅÅ 
Data
ÅÅ 
.
ÅÅ 
Count
ÅÅ 
!=
ÅÅ  
request
ÅÅ! (
.
ÅÅ( )
ProductsList
ÅÅ) 5
.
ÅÅ5 6
Count
ÅÅ6 ;
)
ÅÅ; <
return
ÇÇ 
false
ÇÇ 
;
ÇÇ 
foreach
ÑÑ 
(
ÑÑ 
var
ÑÑ 
item
ÑÑ 
in
ÑÑ 
result
ÑÑ #
.
ÑÑ# $
Data
ÑÑ$ (
)
ÑÑ( )
{
ÖÖ 	
var
ÜÜ 
product
ÜÜ 
=
ÜÜ 
request
ÜÜ !
.
ÜÜ! "
ProductsList
ÜÜ" .
.
ÜÜ. /
FirstOrDefault
ÜÜ/ =
(
ÜÜ= >
x
ÜÜ> ?
=>
ÜÜ@ B
x
ÜÜC D
.
ÜÜD E
	IdProduct
ÜÜE N
==
ÜÜO Q
item
ÜÜR V
.
ÜÜV W
Id
ÜÜW Y
)
ÜÜY Z
;
ÜÜZ [
var
áá 
tax
áá 
=
áá 
item
áá 
.
áá 
Tax
áá 
;
áá 
debit
àà 
+=
àà 
(
àà 
int
àà 
)
àà 
(
àà 
(
àà 
item
àà  
.
àà  !
	SalePrice
àà! *
*
àà+ ,
product
àà- 4
!
àà4 5
.
àà5 6
Count
àà6 ;
)
àà; <
*
àà= >
(
àà? @
$num
àà@ A
+
ààB C
(
ààD E
tax
ààE H
/
ààI J
$num
ààK N
)
ààN O
)
ààO P
)
ààP Q
;
ààQ R
points
ââ 
+=
ââ 
item
ââ 
.
ââ 
BinaryPoints
ââ '
*
ââ( )
product
ââ* 1
.
ââ1 2
Count
ââ2 7
;
ââ7 8
commissionable
ää 
+=
ää 
item
ää "
.
ää" #!
CommissionableValue
ää# 6
*
ää7 8
product
ää9 @
.
ää@ A
Count
ääA F
;
ääF G
if
ãã 
(
ãã 
item
ãã 
.
ãã 

CategoryId
ãã 
==
ãã  "
$num
ãã# $
)
ãã$ %
{
åå 
origin
çç 
=
çç 
$num
çç 
;
çç 
}
éé 
var
êê 
invoiceDetail
êê 
=
êê 
new
êê  #.
 InvoiceDetailsTransactionRequest
êê$ D
{
ëë 
	ProductId
íí 
=
íí 
item
íí  
.
íí  !
Id
íí! #
,
íí# $
PaymentGroupId
ìì 
=
ìì  
item
ìì! %
.
ìì% &
PaymentGroup
ìì& 2
,
ìì2 3
AccumMinPurchase
îî  
=
îî! "
item
îî# '
.
îî' (
AcumCompMin
îî( 3
,
îî3 4
ProductName
ïï 
=
ïï 
item
ïï "
.
ïï" #
Name
ïï# '
!
ïï' (
,
ïï( )
ProductPrice
ññ 
=
ññ 
item
ññ #
.
ññ# $
	SalePrice
ññ$ -
,
ññ- .
ProductPriceBtc
óó 
=
óó  !
	Constants
óó" +
.
óó+ ,

EmptyValue
óó, 6
,
óó6 7

ProductIva
òò 
=
òò 
item
òò !
.
òò! "
Tax
òò" %
,
òò% &
ProductQuantity
ôô 
=
ôô  !
product
ôô" )
.
ôô) *
Count
ôô* /
,
ôô/ 0#
ProductCommissionable
öö %
=
öö& '
item
öö( ,
.
öö, -!
CommissionableValue
öö- @
,
öö@ A
BinaryPoints
õõ 
=
õõ 
item
õõ #
.
õõ# $
BinaryPoints
õõ$ 0
,
õõ0 1
ProductPoints
úú 
=
úú 
item
úú  $
.
úú$ %
ValuePoints
úú% 0
,
úú0 1
ProductDiscount
ùù 
=
ùù  !
item
ùù" &
.
ùù& '
ProductDiscount
ùù' 6
,
ùù6 7
CombinationId
ûû 
=
ûû 
	Constants
ûû  )
.
ûû) *

EmptyValue
ûû* 4
,
ûû4 5
ProductPack
üü 
=
üü 
item
üü "
.
üü" #
ProductPacks
üü# /
,
üü/ 0

BaseAmount
†† 
=
†† 
(
†† 
item
†† "
.
††" #

BaseAmount
††# -
*
††. /
product
††0 7
.
††7 8
Count
††8 =
)
††= >
,
††> ?
DailyPercentage
°° 
=
°°  !
item
°°" &
.
°°& '
DailyPercentage
°°' 6
,
°°6 7
WaitingDays
¢¢ 
=
¢¢ 
item
¢¢ "
.
¢¢" #
DaysWait
¢¢# +
,
¢¢+ ,
DaysToPayQuantity
££ !
=
££" #
	Constants
££$ -
.
££- .
DaysToPayQuantity
££. ?
,
££? @
ProductStart
§§ 
=
§§ 
false
§§ $
,
§§$ %
BrandId
•• 
=
•• 
request
•• !
.
••! "
BrandId
••" )
,
••) *
}
¶¶ 
;
¶¶ 
invoiceDetails
®® 
.
®® 
Add
®® 
(
®® 
invoiceDetail
®® ,
)
®®, -
;
®®- .
}
©© 	
if
´´ 

(
´´ 
debit
´´ 
==
´´ 
	Constants
´´ 
.
´´ 

EmptyValue
´´ )
)
´´) *
return
¨¨ 
false
¨¨ 
;
¨¨ 
if
ÆÆ 

(
ÆÆ 
invoiceDetails
ÆÆ 
.
ÆÆ 
Count
ÆÆ  
==
ÆÆ! #
	Constants
ÆÆ$ -
.
ÆÆ- .

EmptyValue
ÆÆ. 8
)
ÆÆ8 9
return
ØØ 
false
ØØ 
;
ØØ 
var
±± %
debitTransactionRequest
±± #
=
±±$ %
new
±±& )%
DebitTransactionRequest
±±* A
{
≤≤ 	
Debit
≥≥ 
=
≥≥ 
debit
≥≥ 
,
≥≥ 
AffiliateId
¥¥ 
=
¥¥ 
request
¥¥ !
.
¥¥! "
AffiliateId
¥¥" -
,
¥¥- .
UserId
µµ 
=
µµ 
	Constants
µµ 
.
µµ 
AdminUserId
µµ *
,
µµ* +
ConceptType
∂∂ 
=
∂∂ 
WalletConceptType
∂∂ +
.
∂∂+ ,
purchasing_pool
∂∂, ;
.
∂∂; <
ToString
∂∂< D
(
∂∂D E
)
∂∂E F
,
∂∂F G
Points
∑∑ 
=
∑∑ 
points
∑∑ 
,
∑∑ 
Concept
∏∏ 
=
∏∏ 
	Constants
∏∏ 
.
∏∏  $
EcoPoolProductCategory
∏∏  6
,
∏∏6 7
Commissionable
ππ 
=
ππ 
commissionable
ππ +
,
ππ+ ,
Bank
∫∫ 
=
∫∫ 
	Constants
∫∫ 
.
∫∫ 
CoinPay
∫∫ $
,
∫∫$ %
PaymentMethod
ªª 
=
ªª 
	Constants
ªª %
.
ªª% &
CoinPay
ªª& -
,
ªª- .
Origin
ºº 
=
ºº 
origin
ºº 
,
ºº 
Level
ΩΩ 
=
ΩΩ 
	Constants
ΩΩ 
.
ΩΩ 

EmptyValue
ΩΩ (
,
ΩΩ( )
AffiliateUserName
ææ 
=
ææ 
request
ææ  '
.
ææ' (
AffiliateUserName
ææ( 9
,
ææ9 :
AdminUserName
øø 
=
øø 
	Constants
øø %
.
øø% &
ExitoJuntosAdmin
øø& 6
,
øø6 7
ReceiptNumber
¿¿ 
=
¿¿ 
request
¿¿ #
.
¿¿# $
ReceiptNumber
¿¿$ 1
,
¿¿1 2
Type
¡¡ 
=
¡¡ 
true
¡¡ 
,
¡¡ 
	SecretKey
¬¬ 
=
¬¬ 
request
¬¬ 
.
¬¬  
	SecretKey
¬¬  )
,
¬¬) *
invoices
√√ 
=
√√ 
invoiceDetails
√√ %
,
√√% &
Reason
ƒƒ 
=
ƒƒ 
request
ƒƒ 
.
ƒƒ 
Bank
ƒƒ !
,
ƒƒ! "
BrandId
≈≈ 
=
≈≈ 
request
≈≈ 
.
≈≈ 
BrandId
≈≈ %
,
≈≈% &
}
∆∆ 	
;
∆∆	 

var
»» 

spResponse
»» 
=
»» 
await
»»  
_invoiceRepository
»» 1
.
»»1 2$
HandleDebitTransaction
»»2 H
(
»»H I%
debitTransactionRequest
»»I `
)
»»` a
;
»»a b
if
   

(
   

spResponse
   
is
   
null
   
)
   
return
ÀÀ 
false
ÀÀ 
;
ÀÀ 
await
ÕÕ 
RemoveCacheKey
ÕÕ 
(
ÕÕ 
request
ÕÕ $
.
ÕÕ$ %
AffiliateId
ÕÕ% 0
,
ÕÕ0 1
	CacheKeys
ÕÕ2 ;
.
ÕÕ; <&
BalanceInformationModel2
ÕÕ< T
)
ÕÕT U
;
ÕÕU V
var
ŒŒ 

invoicePdf
ŒŒ 
=
ŒŒ 
await
ŒŒ $
_exitoJuntosPdfService
ŒŒ 5
.
ŒŒ5 6
GenerateInvoice
ŒŒ6 E
(
ŒŒE F
userInfoResponse
ŒŒF V
!
ŒŒV W
,
ŒŒW X%
debitTransactionRequest
ŒŒY p
,
ŒŒp q

spResponse
ŒŒr |
)
ŒŒ| }
;
ŒŒ} ~

Dictionary
–– 
<
–– 
string
–– 
,
–– 
byte
–– 
[
––  
]
––  !
>
––! "

allPdfData
––# -
=
––. /
new
––0 3

Dictionary
––4 >
<
––> ?
string
––? E
,
––E F
byte
––G K
[
––K L
]
––L M
>
––M N
{
—— 	
[
““ 
$str
““ 
]
““ 
=
““ 

invoicePdf
““ (
}
”” 	
;
””	 

if
’’ 

(
’’ 

invoicePdf
’’ 
.
’’ 
Length
’’ 
!=
’’  
	Constants
’’! *
.
’’* +

EmptyValue
’’+ 5
)
’’5 6
{
÷÷ 	
await
◊◊  
_brevoEmailService
◊◊ $
.
◊◊$ %&
SendEmailPurchaseConfirm
◊◊% =
(
◊◊= >
userInfoResponse
◊◊> N
!
◊◊N O
,
◊◊O P

allPdfData
◊◊Q [
,
◊◊[ \

spResponse
◊◊] g
,
◊◊g h
request
ÿÿ 
.
ÿÿ 
BrandId
ÿÿ 
)
ÿÿ  
;
ÿÿ  !
}
ŸŸ 	
return
€€ 
true
€€ 
;
€€ 
}
‹‹ 
private
ﬁﬁ 
async
ﬁﬁ 
Task
ﬁﬁ 
RemoveCacheKey
ﬁﬁ %
(
ﬁﬁ% &
int
ﬁﬁ& )
affiliateId
ﬁﬁ* 5
,
ﬁﬁ5 6
string
ﬁﬁ7 =
	stringKey
ﬁﬁ> G
)
ﬁﬁG H
{
ﬂﬂ 
var
‡‡ 
key
‡‡ 
=
‡‡ 
string
‡‡ 
.
‡‡ 
Format
‡‡ 
(
‡‡  
	stringKey
‡‡  )
,
‡‡) *
affiliateId
‡‡+ 6
)
‡‡6 7
;
‡‡7 8
var
·· 
	existsKey
·· 
=
·· 
await
·· 
_redisCache
·· )
.
··) *
	KeyExists
··* 3
(
··3 4
key
··4 7
)
··7 8
;
··8 9
if
„„ 

(
„„ 
	existsKey
„„ 
)
„„ 
await
‰‰ 
_redisCache
‰‰ 
.
‰‰ 
Delete
‰‰ $
(
‰‰$ %
key
‰‰% (
)
‰‰( )
;
‰‰) *
}
ÂÂ 
}ÊÊ ﬂ

nC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\IPaymentStrategies\IBalancePaymentStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
.. /
IPaymentStrategies/ A
;A B
public 
	interface #
IBalancePaymentStrategy (
{ 
Task 
< 	
bool	 
> !
ExecuteEcoPoolPayment $
($ %
WalletRequest% 2
request6 =
)= >
;> ?
Task		 
<		 	
bool			 
>		 
ExecuteAdminPayment		 "
(		" #
WalletRequest		# 0
request		6 =
)		= >
;		> ?
Task

 
<

 	
bool

	 
>

 !
ExecutePaymentCourses

 $
(

$ %
WalletRequest

% 2
request

6 =
)

= >
;

> ?
Task 
< 	
bool	 
>  
ExecuteCustomPayment #
(# $
WalletRequest$ 1
request6 =
)= >
;> ?
Task 
< 	
bool	 
> $
ExecuteMembershipPayment '
(' (
WalletRequest( 5
request6 =
)= >
;> ?
} π
uC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\IPaymentStrategies\IBalancePaymentStrategyModel1A.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
.. /
IPaymentStrategies/ A
;A B
public 
	interface *
IBalancePaymentStrategyModel1A /
{ 
Task 
< 	
bool	 
> !
ExecuteEcoPoolPayment $
($ %
WalletRequest% 2
request3 :
): ;
;; <
Task 
< 	
bool	 
> 3
'ExecuteEcoPoolPaymentWithServiceBalance 6
(6 7
WalletRequest7 D
requestE L
)L M
;M N
}		 π
uC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\IPaymentStrategies\IBalancePaymentStrategyModel1B.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
.. /
IPaymentStrategies/ A
;A B
public 
	interface *
IBalancePaymentStrategyModel1B /
{ 
Task 
< 	
bool	 
> !
ExecuteEcoPoolPayment $
($ %
WalletRequest% 2
request3 :
): ;
;; <
Task 
< 	
bool	 
> 3
'ExecuteEcoPoolPaymentWithServiceBalance 6
(6 7
WalletRequest7 D
requestE L
)L M
;M N
}		 ‹
tC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\IPaymentStrategies\IBalancePaymentStrategyModel2.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
.. /
IPaymentStrategies/ A
;A B
public 
	interface )
IBalancePaymentStrategyModel2 .
{ 
Task 
< 	
bool	 
> 
ExecutePayment 
( 
WalletRequest +
request, 3
)3 4
;4 5
} ™	
sC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\IPaymentStrategies\ICoinPaymentsPaymentStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
.. /
IPaymentStrategies/ A
;A B
public 
	interface (
ICoinPaymentsPaymentStrategy -
{ 
Task 
< 	
bool	 
> !
ExecuteEcoPoolPayment $
($ %
WalletRequest% 2
request6 =
)= >
;> ?
Task 
< 	
bool	 
>  
ExecuteCoursePayment #
(# $
WalletRequest$ 1
request6 =
)= >
;> ?
Task		 
<		 	
bool			 
>		 $
ExecuteMembershipPayment		 '
(		' (
WalletRequest		( 5
request		6 =
)		= >
;		> ?
Task

 
<

 	
bool

	 
>

 "
ExecuteRecyCoinPayment

 %
(

% &
WalletRequest

& 3
request

4 ;
)

; <
;

< =
} ™
nC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\IPaymentStrategies\ICoinPayPaymentStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
.. /
IPaymentStrategies/ A
;A B
public 
	interface #
ICoinPayPaymentStrategy (
{ 
Task 
< 	
bool	 
> !
ExecuteEcoPoolPayment $
($ %
WalletRequest% 2
request3 :
): ;
;; <
Task 
< 	
bool	 
>  
ExecuteCoursePayment #
(# $
WalletRequest$ 1
request2 9
)9 :
;: ;
Task		 
<		 	
bool			 
>		 $
ExecuteMembershipPayment		 '
(		' (
WalletRequest		( 5
request		6 =
)		= >
;		> ?
Task

 
<

 	
bool

	 
>

 "
ExecuteRecyCoinPayment

 %
(

% &
WalletRequest

& 3
request

4 ;
)

; <
;

< =
Task 
< 	
bool	 
> #
ExecuteHouseCoinPayment &
(& '
WalletRequest' 4
request5 <
)< =
;= >
Task 
< 	
bool	 
> %
ExecuteExitoJuntosPayment (
(( )
WalletRequest) 6
request7 >
)> ?
;? @
} ¢	
oC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\IPaymentStrategies\IPagaditoPaymentStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
.. /
IPaymentStrategies/ A
;A B
public 
	interface $
IPagaditoPaymentStrategy )
{ 
Task 
< 	
bool	 
> !
ExecuteEcoPoolPayment $
($ %
WalletRequest% 2
request3 :
): ;
;; <
Task 
< 	
bool	 
>  
ExecuteCoursePayment #
(# $
WalletRequest$ 1
request2 9
)9 :
;: ;
Task		 
<		 	
bool			 
>		 $
ExecuteMembershipPayment		 '
(		' (
WalletRequest		( 5
request		6 =
)		= >
;		> ?
Task

 
<

 	
bool

	 
>

 "
ExecuteRecyCoinPayment

 %
(

% &
WalletRequest

& 3
request

4 ;
)

; <
;

< =
} ï
lC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\IPaymentStrategies\IWireTransferStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
.. /
IPaymentStrategies/ A
;A B
public 
	interface !
IWireTransferStrategy &
{ 
Task 
< 	
bool	 
> !
ExecuteEcoPoolPayment $
($ %
WalletRequest% 2
request3 :
): ;
;; <
Task 
< 	
bool	 
> !
ExecutePaymentCourses $
($ %
WalletRequest% 2
request3 :
): ;
;; <
}		 ’û
[C:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\PagaditoPaymentStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
;. /
public 
class #
PagaditoPaymentStrategy $
:% &$
IPagaditoPaymentStrategy' ?
{ 
private 
readonly 
IInvoiceRepository '
_invoiceRepository. @
;@ A
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter. D
;D E
private 
readonly  
IEcosystemPdfService ) 
_ecosystemPdfService/ C
;C D
private 
readonly 
IBrevoEmailService '
_brevoEmailService. @
;@ A
private 
readonly 
IWalletRepository &
_walletRepository. ?
;? @
private 
readonly 

RedisCache 
_redisCache. 9
;9 :
private 
readonly 
IBrandService "
_brandService. ;
;; <
private 
readonly 
IBonusRepository %
_bonusRepository& 6
;6 7
private 
readonly 
IRecyCoinPdfService (
_recyCoinPdfService) <
;< =
public 
#
PagaditoPaymentStrategy "
(" #
IInvoiceRepository 
invoiceRepository ,
,, -$
IInventoryServiceAdapter2 J#
inventoryServiceAdapterK b
,b c"
IAccountServiceAdapter !
accountServiceAdapter! 6
,6 7
IBrevoEmailService8 J
brevoEmailServiceQ b
,b c 
IEcosystemPdfService   
ecosystemPdfService   0
,  0 1
IWalletRepository  2 C
walletRepository  D T
,  T U

RedisCache!! 

redisCache!! 
,!! 
IBrandService!! +
brandService!!, 8
,!!8 9
IBonusRepository!!: J
bonusRepository!!K Z
,!!Z [
IRecyCoinPdfService"" 
recyCoinPdfService"" .
)"". /
{## 
_invoiceRepository$$ 
=$$! "
invoiceRepository$$# 4
;$$4 5$
_inventoryServiceAdapter%%  
=%%! "#
inventoryServiceAdapter%%# :
;%%: ;"
_accountServiceAdapter&& 
=&&! "!
accountServiceAdapter&&# 8
;&&8 9
_brevoEmailService'' 
=''! "
brevoEmailService''# 4
;''4 5 
_ecosystemPdfService(( 
=((" #
ecosystemPdfService(($ 7
;((7 8
_walletRepository)) 
=))! "
walletRepository))# 3
;))3 4
_redisCache** 
=**! "

redisCache**# -
;**- .
_brandService++ 
=++! "
brandService++# /
;++/ 0
_bonusRepository,, 
=,,! "
bonusRepository,,# 2
;,,2 3
_recyCoinPdfService-- 
=--! "
recyCoinPdfService--# 5
;--5 6
}.. 
private// 
async// 
Task// 
<// 

Dictionary// #
<//# $
string//$ *
,//* +
byte//, 0
[//0 1
]//1 2
>//2 3
>//3 4*
GetPdfContentForTradingAcademy//5 S
(//S T
)//T U
{00 

Dictionary11 
<11 
string11 
,11 
byte11 
[11  
]11  !
>11! "
pdfContents11# .
=11/ 0
new111 4

Dictionary115 ?
<11? @
string11@ F
,11F G
byte11H L
[11L M
]11M N
>11N O
(11O P
)11P Q
;11Q R
var33 
workingDirectory33 
=33 
Path33 #
.33# $
GetDirectoryName33$ 4
(334 5
Assembly335 =
.33= > 
GetExecutingAssembly33> R
(33R S
)33S T
.33T U
Location33U ]
)33] ^
;33^ _
var44 
	separator44 
=44 
Path44 #
.44# $"
DirectorySeparatorChar44$ :
;44: ;
var66 
pdfDirectory66 
=66 
$"66 
{66 
workingDirectory66 .
}66. /
{66/ 0
	separator660 9
}669 :
$str66: @
{66@ A
	separator66A J
}66J K
$str66K Y
"66Y Z
;66Z [
var88 
pdfFiles88 
=88 
	Directory88  
.88  !
GetFiles88! )
(88) *
pdfDirectory88* 6
,886 7
$str888 ?
)88? @
;88@ A
foreach:: 
(:: 
var:: 
pdfFile:: 
in:: 
pdfFiles::  (
)::( )
{;; 	
var<< 
fileName<< 
=<< 
Path<< !
.<<! "
GetFileName<<" -
(<<- .
pdfFile<<. 5
)<<5 6
;<<6 7
var== 

pdfContent== 
=== 
await== "
File==# '
.==' (
ReadAllBytesAsync==( 9
(==9 :
pdfFile==: A
)==A B
;==B C
pdfContents>> 
[>> 
fileName>>  
]>>  !
=>>" #

pdfContent>>$ .
;>>. /
}?? 	
returnAA 
pdfContentsAA 
;AA 
}BB 
publicDD 

asyncDD 
TaskDD 
<DD 
boolDD 
>DD !
ExecuteEcoPoolPaymentDD 1
(DD1 2
WalletRequestDD2 ?
requestDD@ G
)DDG H
{EE 
varFF 
debitFF 
=FF 
$numFF 
;FF  
varGG 
pointsGG 
=GG 
$numGG  
;GG  !
varHH 
commissionableHH 
=HH 
$numHH  
;HH  !
byteII 
originII 
=II 
$numII 
;II  
varKK 
invoiceDetailsKK 
=KK 
newKK "
ListKK# '
<KK' (,
 InvoiceDetailsTransactionRequestKK( H
>KKH I
(KKI J
)KKJ K
;KKK L
varLL 
userInfoResponseLL 
=LL 
awaitLL $"
_accountServiceAdapterLL% ;
.LL; <
GetUserInfoLL< G
(LLG H
requestLLH O
.LLO P
AffiliateIdLLP [
,LL[ \
_brandServiceLL\ i
.LLi j
BrandIdLLj q
)LLq r
;LLr s
varMM 

productIdsMM 
=MM 
requestMM &
.MM& '
ProductsListMM' 3
.MM3 4
SelectMM4 :
(MM: ;
pMM; <
=>MM= ?
pMM@ A
.MMA B
	IdProductMMB K
)MMK L
.MML M
ToArrayMMM T
(MMT U
)MMU V
;MMV W
varNN 
responseListNN 
=NN 
awaitNN $$
_inventoryServiceAdapterNN% =
.NN= >
GetProductsIdsNN> L
(NNL M

productIdsNNM W
,NNW X
_brandServiceNNX e
.NNe f
BrandIdNNf m
)NNm n
;NNn o
ifPP 

(PP 
!PP 
responseListPP 
.PP 
IsSuccessfulPP &
)PP& '
returnQQ 
falseQQ 
;QQ 
ifSS 

(SS 
stringSS 
.SS 
IsNullOrEmptySS  
(SS  !
responseListSS! -
.SS- .
ContentSS. 5
)SS5 6
)SS6 7
returnTT 
falseTT 
;TT 
varVV 
resultVV 
=VV 
JsonSerializerVV #
.VV# $
DeserializeVV$ /
<VV/ 0
ProductsResponseVV0 @
>VV@ A
(VVA B
responseListVVB N
.VVN O
ContentVVO V
)VVV W
;VVW X
ifXX 

(XX 
resultXX 
?XX 
.XX 
DataXX 
.XX 
CountXX 
==XX !
$numXX" #
)XX# $
{YY 	
varZZ 
firstProductIdZZ 
=ZZ! "
requestZZ# *
.ZZ* +
ProductsListZZ+ 7
.ZZ7 8
FirstZZ8 =
(ZZ= >
)ZZ> ?
.ZZ? @
	IdProductZZ@ I
;ZZI J
var[[ 
membershipResult[[  
=[[! "
await[[# ($
_inventoryServiceAdapter[[) A
.[[A B
GetProductById[[B P
([[P Q
firstProductId[[Q _
,[[_ `
_brandService[[` m
.[[m n
BrandId[[n u
)[[u v
;[[v w
var]] 
productResponse]] 
=]]  !
JsonSerializer]]" 0
.]]0 1
Deserialize]]1 <
<]]< =
ProductResponse]]= L
>]]L M
(]]M N
membershipResult]]N ^
.]]^ _
Content]]_ f
!]]f g
)]]g h
;]]h i
await__ "
_accountServiceAdapter__ (
.__( ) 
UpdateActivationDate__) =
(__= >
request__> E
.__E F
AffiliateId__F Q
,__Q R
_brandService__R _
.___ `
BrandId__` g
)__g h
;__h i
resultaa 
.aa 
Dataaa 
.aa 
Addaa 
(aa 
productResponseaa +
!aa+ ,
.aa, -
Dataaa- 1
)aa1 2
;aa2 3
}bb 	
ifdd 

(dd 
resultdd 
?dd 
.dd 
Datadd 
==dd 
nulldd  
)dd  !
returnee 
falseee 
;ee 
ifgg 

(gg 
resultgg 
.gg 
Datagg 
.gg 
Countgg 
!=gg  
requestgg! (
.gg( )
ProductsListgg) 5
.gg5 6
Countgg6 ;
)gg; <
returnhh 
falsehh 
;hh 
varjj 
productNamesjj 
=jj 
resultjj !
.jj! "
Datajj" &
.jj& '
Selectjj' -
(jj- .
itemjj. 2
=>jj3 5
itemjj6 :
.jj: ;
Namejj; ?
)jj? @
.jj@ A
ToArrayjjA H
(jjH I
)jjI J
;jjJ K
foreachll 
(ll 
varll 
itemll 
inll 
resultll #
.ll# $
Datall$ (
)ll( )
{nn 	
varoo 
productoo 
=oo 
requestoo !
.oo! "
ProductsListoo" .
.oo. /
FirstOrDefaultoo/ =
(oo= >
xoo> ?
=>oo@ B
xooC D
.ooD E
	IdProductooE N
==ooO Q
itemooR V
.ooV W
IdooW Y
)ooY Z
;ooZ [
varpp 
taxpp 
=pp 
itempp 
.pp 
Taxpp "
;pp" #
debitqq 
+=qq 
(qq 
intqq "
)qq" #
(qq# $
(qq$ %
itemqq% )
.qq) *
	SalePriceqq* 3
*qq4 5
productqq6 =
!qq= >
.qq> ?
Countqq? D
)qqD E
*qqF G
(qqH I
$numqqI J
+qqK L
(qqM N
taxqqN Q
/qqR S
$numqqT W
)qqW X
)qqX Y
)qqY Z
;qqZ [
pointsrr 
+=rr 
itemrr "
.rr" #
BinaryPointsrr# /
*rr0 1
productrr2 9
.rr9 :
Countrr: ?
;rr? @
commissionabless 
+=ss 
itemss "
.ss" #
CommissionableValuess# 6
*ss7 8
productss9 @
.ss@ A
CountssA F
;ssF G
iftt 
(tt 
itemtt 
.tt 

CategoryIdtt 
==tt  "
$numtt# $
)tt$ %
{uu 
originvv 
=vv 
$numvv 
;vv 
}ww 
varyy 
invoiceDetailyy 
=yy 
newyy  #,
 InvoiceDetailsTransactionRequestyy$ D
{zz 
	ProductId{{ 
={{& '
item{{( ,
.{{, -
Id{{- /
,{{/ 0
PaymentGroupId|| 
=||& '
item||( ,
.||, -
PaymentGroup||- 9
,||9 :
AccumMinPurchase}}  
=}}& '
item}}( ,
.}}, -
AcumCompMin}}- 8
,}}8 9
ProductName~~ 
=~~& '
item~~( ,
.~~, -
Name~~- 1
!~~1 2
,~~2 3
ProductPrice 
=& '
item( ,
., -
	SalePrice- 6
,6 7
ProductPriceBtc
ÄÄ 
=
ÄÄ& '
	Constants
ÄÄ( 1
.
ÄÄ1 2

EmptyValue
ÄÄ2 <
,
ÄÄ< =

ProductIva
ÅÅ 
=
ÅÅ& '
item
ÅÅ( ,
.
ÅÅ, -
Tax
ÅÅ- 0
,
ÅÅ0 1
ProductQuantity
ÇÇ 
=
ÇÇ& '
product
ÇÇ( /
.
ÇÇ/ 0
Count
ÇÇ0 5
,
ÇÇ5 6#
ProductCommissionable
ÉÉ %
=
ÉÉ& '
item
ÉÉ( ,
.
ÉÉ, -!
CommissionableValue
ÉÉ- @
,
ÉÉ@ A
BinaryPoints
ÑÑ 
=
ÑÑ& '
item
ÑÑ( ,
.
ÑÑ, -
BinaryPoints
ÑÑ- 9
,
ÑÑ9 :
ProductPoints
ÖÖ 
=
ÖÖ& '
item
ÖÖ( ,
.
ÖÖ, -
ValuePoints
ÖÖ- 8
,
ÖÖ8 9
ProductDiscount
ÜÜ 
=
ÜÜ& '
item
ÜÜ( ,
.
ÜÜ, -
ProductDiscount
ÜÜ- <
,
ÜÜ< =
CombinationId
áá 
=
áá& '
	Constants
áá( 1
.
áá1 2

EmptyValue
áá2 <
,
áá< =
ProductPack
àà 
=
àà& '
item
àà( ,
.
àà, -
ProductPacks
àà- 9
,
àà9 :

BaseAmount
ââ 
=
ââ& '
(
ââ( )
item
ââ) -
.
ââ- .

BaseAmount
ââ. 8
*
ââ9 :
product
ââ; B
.
ââB C
Count
ââC H
)
ââH I
,
ââI J
DailyPercentage
ää 
=
ää& '
item
ää( ,
.
ää, -
DailyPercentage
ää- <
,
ää< =
WaitingDays
ãã 
=
ãã& '
item
ãã( ,
.
ãã, -
DaysWait
ãã- 5
,
ãã5 6
DaysToPayQuantity
åå !
=
åå& '
	Constants
åå( 1
.
åå1 2
DaysToPayQuantity
åå2 C
,
ååC D
ProductStart
çç 
=
çç& '
false
çç( -
,
çç- .
}
éé 
;
éé 
invoiceDetails
êê 
.
êê 
Add
êê 
(
êê 
invoiceDetail
êê ,
)
êê, -
;
êê- .
}
ëë 	
if
ìì 

(
ìì 
debit
ìì 
==
ìì 
	Constants
ìì 
.
ìì 

EmptyValue
ìì )
)
ìì) *
return
îî 
false
îî 
;
îî 
if
ññ 

(
ññ 
invoiceDetails
ññ 
.
ññ 
Count
ññ  
==
ññ! #
	Constants
ññ$ -
.
ññ- .

EmptyValue
ññ. 8
)
ññ8 9
return
óó 
false
óó 
;
óó 
var
ôô %
debitTransactionRequest
ôô #
=
ôô$ %
new
ôô& )%
DebitTransactionRequest
ôô* A
{
öö 	
Debit
õõ 
=
õõ 
debit
õõ  %
,
õõ% &
AffiliateId
úú 
=
úú 
request
úú  '
.
úú' (
AffiliateId
úú( 3
,
úú3 4
UserId
ùù 
=
ùù 
	Constants
ùù  )
.
ùù) *
AdminUserId
ùù* 5
,
ùù5 6
ConceptType
ûû 
=
ûû 
WalletConceptType
ûû  1
.
ûû1 2
purchasing_pool
ûû2 A
.
ûûA B
ToString
ûûB J
(
ûûJ K
)
ûûK L
,
ûûL M
Points
üü 
=
üü 
points
üü  &
,
üü& '
Concept
†† 
=
†† 
	Constants
††  )
.
††) *$
EcoPoolProductCategory
††* @
,
††@ A
Commissionable
°° 
=
°° 
commissionable
°°  .
,
°°. /
Bank
¢¢ 
=
¢¢ 
	Constants
¢¢  )
.
¢¢) *
Pagadito
¢¢* 2
,
¢¢2 3
PaymentMethod
££ 
=
££ 
	Constants
££  )
.
££) *
Pagadito
££* 2
,
££2 3
Origin
§§ 
=
§§ 
origin
§§  &
,
§§& '
Level
•• 
=
•• 
	Constants
••  )
.
••) *

EmptyValue
••* 4
,
••4 5
AffiliateUserName
¶¶ 
=
¶¶ 
request
¶¶  '
.
¶¶' (
AffiliateUserName
¶¶( 9
,
¶¶9 :
AdminUserName
ßß 
=
ßß 
request
ßß  '
.
ßß' (
BrandId
ßß( /
==
ßß0 2
$num
ßß3 4
?
ßß5 6
	Constants
ßß7 @
.
ßß@ A$
AdminEcosystemUserName
ßßA W
:
ßßX Y
	Constants
ßßZ c
.
ßßc d
RecycoinAdmin
ßßd q
,
ßßq r
ReceiptNumber
®® 
=
®® 
request
®®  '
.
®®' (
ReceiptNumber
®®( 5
,
®®5 6
Type
©© 
=
©© 
true
©©  $
,
©©$ %
	SecretKey
™™ 
=
™™ 
request
™™  '
.
™™' (
	SecretKey
™™( 1
,
™™1 2
invoices
´´ 
=
´´ 
invoiceDetails
´´  .
,
´´. /
Reason
¨¨ 
=
¨¨ 
request
¨¨  '
.
¨¨' (
Bank
¨¨( ,
}
≠≠ 	
;
≠≠	 

var
ØØ 

spResponse
ØØ 
=
ØØ 
await
ØØ  
_invoiceRepository
ØØ 1
.
ØØ1 2$
HandleDebitTransaction
ØØ2 H
(
ØØH I%
debitTransactionRequest
ØØI `
)
ØØ` a
;
ØØa b
if
±± 

(
±± 

spResponse
±± 
is
±± 
null
±± 
)
±± 
return
≤≤ 
false
≤≤ 
;
≤≤ 
await
¥¥ 
RemoveCacheKey
¥¥ 
(
¥¥ 
request
¥¥ $
.
¥¥$ %
AffiliateId
¥¥% 0
,
¥¥0 1
	CacheKeys
¥¥2 ;
.
¥¥; <&
BalanceInformationModel2
¥¥< T
)
¥¥T U
;
¥¥U V
await
µµ 
RemoveCacheKey
µµ 
(
µµ 
request
µµ $
.
µµ$ %
AffiliateId
µµ% 0
,
µµ0 1
	CacheKeys
µµ2 ;
.
µµ; <'
BalanceInformationModel1A
µµ< U
)
µµU V
;
µµV W
await
∂∂ 
RemoveCacheKey
∂∂ 
(
∂∂ 
request
∂∂ $
.
∂∂$ %
AffiliateId
∂∂% 0
,
∂∂0 1
	CacheKeys
∂∂2 ;
.
∂∂; <'
BalanceInformationModel1B
∂∂< U
)
∂∂U V
;
∂∂V W
var
∏∏ 

invoicePdf
∏∏ 
=
∏∏ 
await
∏∏ "
_ecosystemPdfService
∏∏ 3
.
∏∏3 4
GenerateInvoice
∏∏4 C
(
∏∏C D
userInfoResponse
∏∏D T
!
∏∏T U
,
∏∏U V%
debitTransactionRequest
∏∏W n
,
∏∏n o

spResponse
∏∏p z
)
∏∏z {
;
∏∏{ |
var
∫∫ !
productPdfsContents
∫∫ 
=
∫∫  !
await
∫∫" '
CommonExtensions
∫∫( 8
.
∫∫8 9+
GetPdfContentFromProductNames
∫∫9 V
(
∫∫V W
productNames
∫∫W c
!
∫∫c d
)
∫∫d e
;
∫∫e f

Dictionary
ºº 
<
ºº 
string
ºº 
,
ºº 
byte
ºº 
[
ºº  
]
ºº  !
>
ºº! "

allPdfData
ºº# -
=
ºº. /
new
ºº0 3

Dictionary
ºº4 >
<
ºº> ?
string
ºº? E
,
ººE F
byte
ººG K
[
ººK L
]
ººL M
>
ººM N
{
ΩΩ 	
[
ææ 
$str
ææ 
]
ææ 
=
ææ 

invoicePdf
ææ (
}
øø 	
;
øø	 

foreach
¡¡ 
(
¡¡ 
var
¡¡ 
pdfDataEntry
¡¡ !
in
¡¡" $!
productPdfsContents
¡¡% 8
)
¡¡8 9
{
¬¬ 	

allPdfData
√√ 
[
√√ 
pdfDataEntry
√√ #
.
√√# $
Key
√√$ '
]
√√' (
=
√√) *
pdfDataEntry
√√+ 7
.
√√7 8
Value
√√8 =
;
√√= >
}
ƒƒ 	
if
≈≈ 

(
≈≈ 
result
≈≈ 
.
≈≈ 
Data
≈≈ 
.
≈≈ 
Find
≈≈ 
(
≈≈ 
dto
≈≈  
=>
≈≈! #
dto
≈≈$ '
.
≈≈' (
ProductType
≈≈( 3
)
≈≈3 4
!=
≈≈5 7
null
≈≈8 <
)
≈≈< =
{
∆∆ 	
await
««  
_brevoEmailService
«« $
.
««$ %
SendEmailWelcome
««% 5
(
««5 6
userInfoResponse
««6 F
!
««F G
,
««G H

spResponse
««I S
,
««S T
request
««T [
.
««[ \
BrandId
««\ c
)
««c d
;
««d e
}
»» 	
if
   

(
   

invoicePdf
   
.
   
Length
   
!=
    
	Constants
  ! *
.
  * +

EmptyValue
  + 5
)
  5 6
{
ÀÀ 	
await
ÃÃ  
_brevoEmailService
ÃÃ $
.
ÃÃ$ %&
SendEmailPurchaseConfirm
ÃÃ% =
(
ÃÃ= >
userInfoResponse
ÃÃ> N
!
ÃÃN O
,
ÃÃO P

allPdfData
ÃÃQ [
,
ÃÃ[ \

spResponse
ÃÃ] g
,
ÃÃg h
request
ÃÃh o
.
ÃÃo p
BrandId
ÃÃp w
)
ÃÃw x
;
ÃÃx y
}
ÕÕ 	
return
œœ 
true
œœ 
;
œœ 
}
–– 
public
““ 

async
““ 
Task
““ 
<
““ 
bool
““ 
>
““ "
ExecuteCoursePayment
““ 0
(
““0 1
WalletRequest
““1 >
request
““? F
)
““F G
{
”” 
var
‘‘ 
debit
‘‘ 
=
‘‘ 
$num
‘‘  
;
‘‘  !
var
’’ 
points
’’ 
=
’’ 
$num
’’  
;
’’  !
var
÷÷ 
commissionable
÷÷ 
=
÷÷ 
$num
÷÷  
;
÷÷  !
byte
◊◊ 
origin
◊◊ 
=
◊◊ 
$num
◊◊ 
;
◊◊  
var
ŸŸ 
invoiceDetails
ŸŸ 
=
ŸŸ 
new
ŸŸ "
List
ŸŸ# '
<
ŸŸ' (.
 InvoiceDetailsTransactionRequest
ŸŸ( H
>
ŸŸH I
(
ŸŸI J
)
ŸŸJ K
;
ŸŸK L
var
⁄⁄ 
userInfoResponse
⁄⁄ 
=
⁄⁄ 
await
⁄⁄ $$
_accountServiceAdapter
⁄⁄% ;
.
⁄⁄; <
GetUserInfo
⁄⁄< G
(
⁄⁄G H
request
⁄⁄H O
.
⁄⁄O P
AffiliateId
⁄⁄P [
,
⁄⁄[ \
_brandService
⁄⁄\ i
.
⁄⁄i j
BrandId
⁄⁄j q
)
⁄⁄q r
;
⁄⁄r s
var
€€ 

productIds
€€ 
=
€€ 
request
€€ &
.
€€& '
ProductsList
€€' 3
.
€€3 4
Select
€€4 :
(
€€: ;
p
€€; <
=>
€€= ?
p
€€@ A
.
€€A B
	IdProduct
€€B K
)
€€K L
.
€€L M
ToArray
€€M T
(
€€T U
)
€€U V
;
€€V W
var
‹‹ 
responseList
‹‹ 
=
‹‹ 
await
‹‹ $&
_inventoryServiceAdapter
‹‹% =
.
‹‹= >
GetProductsIds
‹‹> L
(
‹‹L M

productIds
‹‹M W
,
‹‹W X
_brandService
‹‹X e
.
‹‹e f
BrandId
‹‹f m
)
‹‹m n
;
‹‹n o
if
ﬁﬁ 

(
ﬁﬁ 
!
ﬁﬁ 
responseList
ﬁﬁ 
.
ﬁﬁ 
IsSuccessful
ﬁﬁ &
)
ﬁﬁ& '
return
ﬂﬂ 
false
ﬂﬂ 
;
ﬂﬂ 
if
·· 

(
·· 
string
·· 
.
·· 
IsNullOrEmpty
··  
(
··  !
responseList
··! -
.
··- .
Content
··. 5
)
··5 6
)
··6 7
return
‚‚ 
false
‚‚ 
;
‚‚ 
var
‰‰ 
result
‰‰ 
=
‰‰ 
JsonSerializer
‰‰ #
.
‰‰# $
Deserialize
‰‰$ /
<
‰‰/ 0
ProductsResponse
‰‰0 @
>
‰‰@ A
(
‰‰A B
responseList
‰‰B N
.
‰‰N O
Content
‰‰O V
)
‰‰V W
;
‰‰W X
if
ÊÊ 

(
ÊÊ 
result
ÊÊ 
?
ÊÊ 
.
ÊÊ 
Data
ÊÊ 
==
ÊÊ 
null
ÊÊ  
)
ÊÊ  !
return
ÁÁ 
false
ÁÁ 
;
ÁÁ 
if
ÈÈ 

(
ÈÈ 
result
ÈÈ 
.
ÈÈ 
Data
ÈÈ 
.
ÈÈ 
Count
ÈÈ 
!=
ÈÈ  
request
ÈÈ! (
.
ÈÈ( )
ProductsList
ÈÈ) 5
.
ÈÈ5 6
Count
ÈÈ6 ;
)
ÈÈ; <
return
ÍÍ 
false
ÍÍ 
;
ÍÍ 
var
ÏÏ 
	isAcademy
ÏÏ 
=
ÏÏ 
false
ÏÏ 
;
ÏÏ 
foreach
ÌÌ 
(
ÌÌ 
var
ÌÌ 
item
ÌÌ 
in
ÌÌ 
result
ÌÌ #
.
ÌÌ# $
Data
ÌÌ$ (
)
ÌÌ( )
{
ÓÓ 	
var
ÔÔ 
product
ÔÔ 
=
ÔÔ 
request
ÔÔ !
.
ÔÔ! "
ProductsList
ÔÔ" .
.
ÔÔ. /
FirstOrDefault
ÔÔ/ =
(
ÔÔ= >
x
ÔÔ> ?
=>
ÔÔ@ B
x
ÔÔC D
.
ÔÔD E
	IdProduct
ÔÔE N
==
ÔÔO Q
item
ÔÔR V
.
ÔÔV W
Id
ÔÔW Y
)
ÔÔY Z
;
ÔÔZ [
var
 
tax
 
=
 
item
 
.
 
Tax
 "
;
" #
debit
ÒÒ 
+=
ÒÒ 
(
ÒÒ 
item
ÒÒ #
.
ÒÒ# $
	SalePrice
ÒÒ$ -
*
ÒÒ. /
product
ÒÒ0 7
!
ÒÒ7 8
.
ÒÒ8 9
Count
ÒÒ9 >
)
ÒÒ> ?
*
ÒÒ@ A
(
ÒÒB C
$num
ÒÒC D
+
ÒÒE F
(
ÒÒG H
tax
ÒÒH K
/
ÒÒL M
$num
ÒÒN Q
)
ÒÒQ R
)
ÒÒR S
;
ÒÒS T
points
ÚÚ 
+=
ÚÚ 
item
ÚÚ "
.
ÚÚ" #
BinaryPoints
ÚÚ# /
*
ÚÚ0 1
product
ÚÚ2 9
.
ÚÚ9 :
Count
ÚÚ: ?
;
ÚÚ? @
commissionable
ÛÛ 
+=
ÛÛ 
item
ÛÛ "
.
ÛÛ" #!
CommissionableValue
ÛÛ# 6
*
ÛÛ7 8
product
ÛÛ9 @
.
ÛÛ@ A
Count
ÛÛA F
;
ÛÛF G
	isAcademy
ÙÙ 
=
ÙÙ 
item
ÙÙ !
.
ÙÙ! "
PaymentGroup
ÙÙ" .
==
ÙÙ/ 1
	Constants
ÙÙ2 ;
.
ÙÙ; <!
TradingAcademyGroup
ÙÙ< O
||
ÙÙP R
	isAcademy
ÙÙS \
;
ÙÙ\ ]
if
ıı 
(
ıı 
item
ıı 
.
ıı 

CategoryId
ıı 
==
ıı  "
$num
ıı# $
)
ıı$ %
{
ˆˆ 
origin
˜˜ 
=
˜˜ 
$num
˜˜ 
;
˜˜ 
}
¯¯ 
var
˙˙ 
invoiceDetail
˙˙ 
=
˙˙ 
new
˙˙  #.
 InvoiceDetailsTransactionRequest
˙˙$ D
{
˚˚ 
	ProductId
¸¸ 
=
¸¸& '
item
¸¸( ,
.
¸¸, -
Id
¸¸- /
,
¸¸/ 0
PaymentGroupId
˝˝ 
=
˝˝& '
item
˝˝( ,
.
˝˝, -
PaymentGroup
˝˝- 9
,
˝˝9 :
AccumMinPurchase
˛˛  
=
˛˛& '
item
˛˛( ,
.
˛˛, -
AcumCompMin
˛˛- 8
,
˛˛8 9
ProductName
ˇˇ 
=
ˇˇ& '
item
ˇˇ( ,
.
ˇˇ, -
Name
ˇˇ- 1
!
ˇˇ1 2
,
ˇˇ2 3
ProductPrice
ÄÄ 
=
ÄÄ& '
item
ÄÄ( ,
.
ÄÄ, -
	SalePrice
ÄÄ- 6
,
ÄÄ6 7
ProductPriceBtc
ÅÅ 
=
ÅÅ& '
	Constants
ÅÅ( 1
.
ÅÅ1 2

EmptyValue
ÅÅ2 <
,
ÅÅ< =

ProductIva
ÇÇ 
=
ÇÇ& '
item
ÇÇ( ,
.
ÇÇ, -
Tax
ÇÇ- 0
,
ÇÇ0 1
ProductQuantity
ÉÉ 
=
ÉÉ& '
product
ÉÉ( /
.
ÉÉ/ 0
Count
ÉÉ0 5
,
ÉÉ5 6#
ProductCommissionable
ÑÑ %
=
ÑÑ& '
item
ÑÑ( ,
.
ÑÑ, -!
CommissionableValue
ÑÑ- @
,
ÑÑ@ A
BinaryPoints
ÖÖ 
=
ÖÖ& '
item
ÖÖ( ,
.
ÖÖ, -
BinaryPoints
ÖÖ- 9
,
ÖÖ9 :
ProductPoints
ÜÜ 
=
ÜÜ& '
item
ÜÜ( ,
.
ÜÜ, -
ValuePoints
ÜÜ- 8
,
ÜÜ8 9
ProductDiscount
áá 
=
áá& '
item
áá( ,
.
áá, -
ProductDiscount
áá- <
,
áá< =
CombinationId
àà 
=
àà& '
	Constants
àà( 1
.
àà1 2

EmptyValue
àà2 <
,
àà< =
ProductPack
ââ 
=
ââ& '
item
ââ( ,
.
ââ, -
ProductPacks
ââ- 9
,
ââ9 :

BaseAmount
ää 
=
ää& '
(
ää( )
item
ää) -
.
ää- .

BaseAmount
ää. 8
*
ää9 :
product
ää; B
.
ääB C
Count
ääC H
)
ääH I
,
ääI J
DailyPercentage
ãã 
=
ãã& '
item
ãã( ,
.
ãã, -
DailyPercentage
ãã- <
,
ãã< =
WaitingDays
åå 
=
åå& '
item
åå( ,
.
åå, -
DaysWait
åå- 5
,
åå5 6
DaysToPayQuantity
çç !
=
çç& '
	Constants
çç( 1
.
çç1 2
DaysToPayQuantity
çç2 C
,
ççC D
ProductStart
éé 
=
éé& '
false
éé( -
,
éé- .
}
èè 
;
èè 
invoiceDetails
ëë 
.
ëë 
Add
ëë 
(
ëë 
invoiceDetail
ëë ,
)
ëë, -
;
ëë- .
}
íí 	
if
îî 

(
îî 
debit
îî 
==
îî 
	Constants
îî 
.
îî 

EmptyValue
îî )
)
îî) *
return
ïï 
false
ïï 
;
ïï 
if
óó 

(
óó 
invoiceDetails
óó 
.
óó 
Count
óó  
==
óó! #
	Constants
óó$ -
.
óó- .

EmptyValue
óó. 8
)
óó8 9
return
òò 
false
òò 
;
òò 
var
öö %
debitTransactionRequest
öö #
=
öö$ %
new
öö& )%
DebitTransactionRequest
öö* A
{
õõ 	
Debit
úú 
=
úú 
debit
úú  %
,
úú% &
AffiliateId
ùù 
=
ùù 
request
ùù  '
.
ùù' (
AffiliateId
ùù( 3
,
ùù3 4
UserId
ûû 
=
ûû 
	Constants
ûû  )
.
ûû) *
AdminUserId
ûû* 5
,
ûû5 6
ConceptType
üü 
=
üü 
WalletConceptType
üü  1
.
üü1 2
purchasing_pool
üü2 A
.
üüA B
ToString
üüB J
(
üüJ K
)
üüK L
,
üüL M
Points
†† 
=
†† 
points
††  &
,
††& '
Concept
°° 
=
°° 
	Constants
°°  )
.
°°) *$
EcoPoolProductCategory
°°* @
,
°°@ A
Commissionable
¢¢ 
=
¢¢ 
commissionable
¢¢  .
,
¢¢. /
Bank
££ 
=
££ 
	Constants
££  )
.
££) *
Pagadito
££* 2
,
££2 3
PaymentMethod
§§ 
=
§§ 
	Constants
§§  )
.
§§) *
Pagadito
§§* 2
,
§§2 3
Origin
•• 
=
•• 
origin
••  &
,
••& '
Level
¶¶ 
=
¶¶ 
	Constants
¶¶  )
.
¶¶) *

EmptyValue
¶¶* 4
,
¶¶4 5
AffiliateUserName
ßß 
=
ßß 
request
ßß  '
.
ßß' (
AffiliateUserName
ßß( 9
,
ßß9 :
AdminUserName
®® 
=
®® 
request
®®  '
.
®®' (
BrandId
®®( /
==
®®0 2
$num
®®3 4
?
®®5 6
	Constants
®®7 @
.
®®@ A$
AdminEcosystemUserName
®®A W
:
®®X Y
	Constants
®®Z c
.
®®c d
RecycoinAdmin
®®d q
,
®®q r
ReceiptNumber
©© 
=
©© 
request
©©  '
.
©©' (
ReceiptNumber
©©( 5
,
©©5 6
Type
™™ 
=
™™ 
true
™™  $
,
™™$ %
	SecretKey
´´ 
=
´´ 
request
´´  '
.
´´' (
	SecretKey
´´( 1
,
´´1 2
invoices
¨¨ 
=
¨¨ 
invoiceDetails
¨¨  .
,
¨¨. /
Reason
≠≠ 
=
≠≠ 
request
≠≠  '
.
≠≠' (
Bank
≠≠( ,
}
ÆÆ 	
;
ÆÆ	 

var
∞∞ 
	hasCourse
∞∞ 
=
∞∞ 
await
∞∞  
_invoiceRepository
∞∞ 1
.
∞∞1 23
%GetInvoicesForTradingAcademyPurchases
∞∞2 W
(
∞∞W X
request
∞∞X _
.
∞∞_ `
AffiliateId
∞∞` k
)
∞∞k l
;
∞∞l m
var
±± 

spResponse
±± 
=
±± 
await
±±  
_invoiceRepository
±± 1
.
±±1 2$
HandleDebitTransaction
±±2 H
(
±±H I%
debitTransactionRequest
±±I `
)
±±` a
;
±±a b
if
≥≥ 

(
≥≥ 

spResponse
≥≥ 
is
≥≥ 
null
≥≥ 
)
≥≥ 
return
¥¥ 
false
¥¥ 
;
¥¥ 
await
∂∂ 
RemoveCacheKey
∂∂ 
(
∂∂ 
request
∂∂ $
.
∂∂$ %
AffiliateId
∂∂% 0
,
∂∂0 1
	CacheKeys
∂∂2 ;
.
∂∂; <&
BalanceInformationModel2
∂∂< T
)
∂∂T U
;
∂∂U V
await
∑∑ 
RemoveCacheKey
∑∑ 
(
∑∑ 
request
∑∑ $
.
∑∑$ %
AffiliateId
∑∑% 0
,
∑∑0 1
	CacheKeys
∑∑2 ;
.
∑∑; <'
BalanceInformationModel1A
∑∑< U
)
∑∑U V
;
∑∑V W
await
∏∏ 
RemoveCacheKey
∏∏ 
(
∏∏ 
request
∏∏ $
.
∏∏$ %
AffiliateId
∏∏% 0
,
∏∏0 1
	CacheKeys
∏∏2 ;
.
∏∏; <'
BalanceInformationModel1B
∏∏< U
)
∏∏U V
;
∏∏V W

Dictionary
∫∫ 
<
∫∫ 
string
∫∫ 
,
∫∫ 
byte
∫∫ 
[
∫∫  
]
∫∫  !
>
∫∫! "

allPdfData
∫∫# -
=
∫∫. /
new
∫∫0 3

Dictionary
∫∫4 >
<
∫∫> ?
string
∫∫? E
,
∫∫E F
byte
∫∫G K
[
∫∫K L
]
∫∫L M
>
∫∫M N
(
∫∫N O
)
∫∫O P
;
∫∫P Q
var
ªª 

invoicePdf
ªª# -
=
ªª. /
await
ªª0 5"
_ecosystemPdfService
ªª6 J
.
ªªJ K
GenerateInvoice
ªªK Z
(
ªªZ [
userInfoResponse
ªª[ k
!
ªªk l
,
ªªl m&
debitTransactionRequestªªn Ö
,ªªÖ Ü

spResponseªªá ë
)ªªë í
;ªªí ì

allPdfData
ΩΩ 
[
ΩΩ 
$str
ΩΩ  
]
ΩΩ  !
=
ΩΩ" #

invoicePdf
ΩΩ$ .
;
ΩΩ. /
if
øø 

(
øø 
!
øø 
	hasCourse
øø 
&&
øø 

invoicePdf
øø $
.
øø$ %
Length
øø% +
!=
øø, .
	Constants
øø/ 8
.
øø8 9

EmptyValue
øø9 C
&&
øøD F
	isAcademy
øøG P
)
øøP Q
{
¿¿ 	
var
¡¡ 
pdfContents
¡¡ 
=
¡¡ 
await
¡¡ #,
GetPdfContentForTradingAcademy
¡¡$ B
(
¡¡B C
)
¡¡C D
;
¡¡D E
foreach
¬¬ 
(
¬¬ 
var
¬¬ 
pdf
¬¬ 
in
¬¬ 
pdfContents
¬¬  +
)
¬¬+ ,
{
√√ 

allPdfData
ƒƒ 
[
ƒƒ 
pdf
ƒƒ 
.
ƒƒ 
Key
ƒƒ "
]
ƒƒ" #
=
ƒƒ$ %
pdf
ƒƒ& )
.
ƒƒ) *
Value
ƒƒ* /
;
ƒƒ/ 0
}
≈≈ 
await
∆∆  
_brevoEmailService
∆∆ $
.
∆∆$ %0
"SendEmailPurchaseConfirmForAcademy
∆∆% G
(
∆∆G H
userInfoResponse
∆∆H X
!
∆∆X Y
,
∆∆Y Z

allPdfData
∆∆[ e
,
∆∆e f

spResponse
∆∆g q
,
∆∆q r
request
∆∆r y
.
∆∆y z
BrandId∆∆z Å
)∆∆Å Ç
;∆∆Ç É
}
«« 	
else
»» 
if
»» 
(
»» 

invoicePdf
»» 
.
»» 
Length
»» "
!=
»»# %
	Constants
»»& /
.
»»/ 0

EmptyValue
»»0 :
)
»»: ;
{
…… 	
await
    
_brevoEmailService
   $
.
  $ %&
SendEmailPurchaseConfirm
  % =
(
  = >
userInfoResponse
  > N
!
  N O
,
  O P

allPdfData
  Q [
,
  [ \

spResponse
  ] g
,
  g h
request
  h o
.
  o p
BrandId
  p w
)
  w x
;
  x y
}
ÀÀ 	
return
ÕÕ 
true
ÕÕ 
;
ÕÕ 
}
ŒŒ 
public
œœ 

async
œœ 
Task
œœ 
<
œœ 
bool
œœ 
>
œœ &
ExecuteMembershipPayment
œœ 4
(
œœ4 5
WalletRequest
œœ5 B
request
œœC J
)
œœJ K
{
–– 
var
—— 
debit
—— 
=
—— 
$num
—— 
;
——  
var
““ 
points
““ 
=
““ 
$num
““  
;
““  !
var
”” 
commissionable
”” 
=
”” 
$num
””  
;
””  !
byte
‘‘ 
origin
‘‘ 
=
‘‘ 
$num
‘‘ 
;
‘‘  
var
÷÷ 
invoiceDetails
÷÷ 
=
÷÷! "
new
÷÷# &
List
÷÷' +
<
÷÷+ ,.
 InvoiceDetailsTransactionRequest
÷÷, L
>
÷÷L M
(
÷÷M N
)
÷÷N O
;
÷÷O P
var
◊◊ 
userInfoResponse
◊◊ 
=
◊◊! "
await
◊◊# ($
_accountServiceAdapter
◊◊) ?
.
◊◊? @
GetUserInfo
◊◊@ K
(
◊◊K L
request
◊◊L S
.
◊◊S T
AffiliateId
◊◊T _
,
◊◊_ `
_brandService
◊◊` m
.
◊◊m n
BrandId
◊◊n u
)
◊◊u v
;
◊◊v w
var
ŸŸ 
firstProductId
ŸŸ 
=
ŸŸ 
request
ŸŸ &
.
ŸŸ& '
ProductsList
ŸŸ' 3
.
ŸŸ3 4
First
ŸŸ4 9
(
ŸŸ9 :
)
ŸŸ: ;
.
ŸŸ; <
	IdProduct
ŸŸ< E
;
ŸŸE F
var
⁄⁄ 
membershipResult
⁄⁄ 
=
⁄⁄ 
await
⁄⁄ $&
_inventoryServiceAdapter
⁄⁄% =
.
⁄⁄= >
GetProductById
⁄⁄> L
(
⁄⁄L M
firstProductId
⁄⁄M [
,
⁄⁄[ \
_brandService
⁄⁄\ i
.
⁄⁄i j
BrandId
⁄⁄j q
)
⁄⁄q r
;
⁄⁄r s
var
‹‹ 
productResponse
‹‹ 
=
‹‹ 
JsonSerializer
‹‹ ,
.
‹‹, -
Deserialize
‹‹- 8
<
‹‹8 9
ProductResponse
‹‹9 H
>
‹‹H I
(
‹‹I J
membershipResult
‹‹J Z
.
‹‹Z [
Content
‹‹[ b
!
‹‹b c
)
‹‹c d
;
‹‹d e
if
ﬁﬁ 

(
ﬁﬁ
 
userInfoResponse
ﬁﬁ 
is
ﬁﬁ 
null
ﬁﬁ #
)
ﬁﬁ# $
return
ﬂﬂ 
false
ﬂﬂ 
;
ﬂﬂ 
if
·· 

(
·· 
productResponse
·· 
?
·· 
.
·· 
Data
·· !
==
··" $
null
··% )
)
··) *
return
‚‚ 
false
‚‚ 
;
‚‚ 
var
‰‰ 
item
‰‰ 
=
‰‰ 
productResponse
‰‰ %
.
‰‰% &
Data
‰‰& *
;
‰‰* +
var
ÂÂ 
product
ÂÂ 
=
ÂÂ 
request
ÂÂ 
.
ÂÂ 
ProductsList
ÂÂ *
.
ÂÂ* +
FirstOrDefault
ÂÂ+ 9
(
ÂÂ9 :
x
ÂÂ: ;
=>
ÂÂ< >
x
ÂÂ? @
.
ÂÂ@ A
	IdProduct
ÂÂA J
==
ÂÂK M
item
ÂÂN R
.
ÂÂR S
Id
ÂÂS U
)
ÂÂU V
;
ÂÂV W
if
ÊÊ 

(
ÊÊ 
product
ÊÊ 
!=
ÊÊ 
null
ÊÊ 
)
ÊÊ 
{
ÁÁ 	
var
ËË 
tax
ËË 
=
ËË 
item
ËË 
.
ËË 
Tax
ËË 
;
ËË 
debit
ÈÈ 
+=
ÈÈ 
(
ÈÈ 
int
ÈÈ "
)
ÈÈ" #
(
ÈÈ# $
(
ÈÈ$ %
item
ÈÈ% )
.
ÈÈ) *
	SalePrice
ÈÈ* 3
*
ÈÈ4 5
product
ÈÈ6 =
.
ÈÈ= >
Count
ÈÈ> C
)
ÈÈC D
*
ÈÈE F
(
ÈÈG H
$num
ÈÈH I
+
ÈÈJ K
(
ÈÈL M
tax
ÈÈM P
/
ÈÈQ R
$num
ÈÈS V
)
ÈÈV W
)
ÈÈW X
)
ÈÈX Y
;
ÈÈY Z
points
ÍÍ 
+=
ÍÍ 
item
ÍÍ "
.
ÍÍ" #
BinaryPoints
ÍÍ# /
*
ÍÍ0 1
product
ÍÍ2 9
.
ÍÍ9 :
Count
ÍÍ: ?
;
ÍÍ? @
commissionable
ÎÎ 
+=
ÎÎ 
item
ÎÎ "
.
ÎÎ" #!
CommissionableValue
ÎÎ# 6
*
ÎÎ7 8
product
ÎÎ9 @
.
ÎÎ@ A
Count
ÎÎA F
;
ÎÎF G
if
ÏÏ 
(
ÏÏ 
item
ÏÏ 
.
ÏÏ 

CategoryId
ÏÏ 
==
ÏÏ  "
$num
ÏÏ# $
)
ÏÏ$ %
{
ÌÌ 
origin
ÓÓ 
=
ÓÓ 
$num
ÓÓ 
;
ÓÓ 
}
ÔÔ 
var
ÒÒ 
invoiceDetail
ÒÒ 
=
ÒÒ 
new
ÒÒ  #.
 InvoiceDetailsTransactionRequest
ÒÒ$ D
{
ÚÚ 
	ProductId
ÛÛ 
=
ÛÛ& '
item
ÛÛ( ,
.
ÛÛ, -
Id
ÛÛ- /
,
ÛÛ/ 0
PaymentGroupId
ÙÙ 
=
ÙÙ& '
item
ÙÙ( ,
.
ÙÙ, -
PaymentGroup
ÙÙ- 9
,
ÙÙ9 :
AccumMinPurchase
ıı  
=
ıı& '
item
ıı( ,
.
ıı, -
AcumCompMin
ıı- 8
,
ıı8 9
ProductName
ˆˆ 
=
ˆˆ& '
item
ˆˆ( ,
.
ˆˆ, -
Name
ˆˆ- 1
!
ˆˆ1 2
,
ˆˆ2 3
ProductPrice
˜˜ 
=
˜˜& '
item
˜˜( ,
.
˜˜, -
	SalePrice
˜˜- 6
,
˜˜6 7
ProductPriceBtc
¯¯ 
=
¯¯& '
	Constants
¯¯( 1
.
¯¯1 2

EmptyValue
¯¯2 <
,
¯¯< =

ProductIva
˘˘ 
=
˘˘& '
item
˘˘( ,
.
˘˘, -
Tax
˘˘- 0
,
˘˘0 1
ProductQuantity
˙˙ 
=
˙˙& '
product
˙˙( /
.
˙˙/ 0
Count
˙˙0 5
,
˙˙5 6#
ProductCommissionable
˚˚ %
=
˚˚& '
item
˚˚( ,
.
˚˚, -!
CommissionableValue
˚˚- @
,
˚˚@ A
BinaryPoints
¸¸ 
=
¸¸& '
item
¸¸( ,
.
¸¸, -
BinaryPoints
¸¸- 9
,
¸¸9 :
ProductPoints
˝˝ 
=
˝˝& '
item
˝˝( ,
.
˝˝, -
ValuePoints
˝˝- 8
,
˝˝8 9
ProductDiscount
˛˛ 
=
˛˛& '
	Constants
˛˛( 1
.
˛˛1 2

EmptyValue
˛˛2 <
,
˛˛< =
CombinationId
ˇˇ 
=
ˇˇ& '
	Constants
ˇˇ( 1
.
ˇˇ1 2

EmptyValue
ˇˇ2 <
,
ˇˇ< =
ProductPack
ÄÄ 
=
ÄÄ& '
item
ÄÄ( ,
.
ÄÄ, -
ProductPacks
ÄÄ- 9
,
ÄÄ9 :

BaseAmount
ÅÅ 
=
ÅÅ& '
item
ÅÅ( ,
.
ÅÅ, -

BaseAmount
ÅÅ- 7
,
ÅÅ7 8
DailyPercentage
ÇÇ 
=
ÇÇ& '
item
ÇÇ( ,
.
ÇÇ, -
DailyPercentage
ÇÇ- <
,
ÇÇ< =
WaitingDays
ÉÉ 
=
ÉÉ& '
item
ÉÉ( ,
.
ÉÉ, -
DaysWait
ÉÉ- 5
,
ÉÉ5 6
DaysToPayQuantity
ÑÑ !
=
ÑÑ& '
	Constants
ÑÑ( 1
.
ÑÑ1 2

EmptyValue
ÑÑ2 <
,
ÑÑ< =
ProductStart
ÖÖ 
=
ÖÖ& '
false
ÖÖ( -
,
ÖÖ- .
}
áá 
;
áá 
invoiceDetails
ââ 
.
ââ 
Add
ââ 
(
ââ 
invoiceDetail
ââ ,
)
ââ, -
;
ââ- .
}
ää 	
if
åå 

(
åå 
debit
åå 
==
åå 
	Constants
åå 
.
åå 

EmptyValue
åå )
)
åå) *
return
çç 
false
çç 
;
çç 
if
èè 

(
èè 
invoiceDetails
èè 
.
èè 
Count
èè  
==
èè! #
	Constants
èè$ -
.
èè- .

EmptyValue
èè. 8
)
èè8 9
return
êê 
false
êê 
;
êê 
var
íí %
debitTransactionRequest
íí #
=
íí$ %
new
íí& )%
DebitTransactionRequest
íí* A
{
ìì 	
Debit
îî 
=
îî 
debit
îî  %
,
îî% &
AffiliateId
ïï 
=
ïï 
request
ïï  '
.
ïï' (
AffiliateId
ïï( 3
,
ïï3 4
UserId
ññ 
=
ññ 
	Constants
ññ  )
.
ññ) *
AdminUserId
ññ* 5
,
ññ5 6
ConceptType
óó 
=
óó 
WalletConceptType
óó  1
.
óó1 2
purchasing_pool
óó2 A
.
óóA B
ToString
óóB J
(
óóJ K
)
óóK L
,
óóL M
Points
òò 
=
òò 
points
òò  &
,
òò& '
Concept
ôô 
=
ôô 
	Constants
ôô  )
.
ôô) *

Membership
ôô* 4
,
ôô4 5
Commissionable
öö 
=
öö 
commissionable
öö  .
,
öö. /
Bank
õõ 
=
õõ 
	Constants
õõ  )
.
õõ) *
Pagadito
õõ* 2
,
õõ2 3
PaymentMethod
úú 
=
úú 
	Constants
úú  )
.
úú) *
Pagadito
úú* 2
,
úú2 3
Origin
ùù 
=
ùù 
origin
ùù  &
,
ùù& '
Level
ûû 
=
ûû 
	Constants
ûû  )
.
ûû) *

EmptyValue
ûû* 4
,
ûû4 5
AffiliateUserName
üü 
=
üü 
request
üü  '
.
üü' (
AffiliateUserName
üü( 9
,
üü9 :
AdminUserName
†† 
=
†† 
request
††  '
.
††' (
BrandId
††( /
==
††0 2
$num
††3 4
?
††5 6
	Constants
††7 @
.
††@ A$
AdminEcosystemUserName
††A W
:
††X Y
	Constants
††Z c
.
††c d
RecycoinAdmin
††d q
,
††q r
ReceiptNumber
°° 
=
°° 
request
°°  '
.
°°' (
ReceiptNumber
°°( 5
,
°°5 6
Type
¢¢ 
=
¢¢ 
true
¢¢  $
,
¢¢$ %
	SecretKey
££ 
=
££ 
request
££  '
.
££' (
	SecretKey
££( 1
,
££1 2
invoices
§§ 
=
§§ 
invoiceDetails
§§  .
,
§§. /
Reason
•• 
=
•• 
request
••  '
.
••' (
Bank
••( ,
}
¶¶	 

;
¶¶
 
var
®® 

spResponse
®® 
=
®® 
await
®® 
_walletRepository
®® 0
.
®®0 1)
HandleMembershipTransaction
®®1 L
(
®®L M%
debitTransactionRequest
®®M d
)
®®d e
;
®®e f
if
™™ 

(
™™ 

spResponse
™™ 
is
™™ 
null
™™ 
)
™™ 
return
´´ 
false
´´ 
;
´´ 
await
≠≠ $
_accountServiceAdapter
≠≠ $
.
≠≠$ %"
UpdateActivationDate
≠≠% 9
(
≠≠9 :
request
≠≠: A
.
≠≠A B
AffiliateId
≠≠B M
,
≠≠M N
_brandService
≠≠N [
.
≠≠[ \
BrandId
≠≠\ c
)
≠≠c d
;
≠≠d e
await
ØØ 
RemoveCacheKey
ØØ 
(
ØØ 
request
ØØ $
.
ØØ$ %
AffiliateId
ØØ% 0
,
ØØ0 1
	CacheKeys
ØØ2 ;
.
ØØ; <&
BalanceInformationModel2
ØØ< T
)
ØØT U
;
ØØU V
await
∞∞ 
RemoveCacheKey
∞∞ 
(
∞∞ 
request
∞∞ $
.
∞∞$ %
AffiliateId
∞∞% 0
,
∞∞0 1
	CacheKeys
∞∞2 ;
.
∞∞; <'
BalanceInformationModel1A
∞∞< U
)
∞∞U V
;
∞∞V W
await
±± 
RemoveCacheKey
±± 
(
±± 
request
±± $
.
±±$ %
AffiliateId
±±% 0
,
±±0 1
	CacheKeys
±±2 ;
.
±±; <'
BalanceInformationModel1B
±±< U
)
±±U V
;
±±V W
var
≥≥ 
	pdfResult
≥≥ 
=
≥≥ 
await
≥≥ "
_ecosystemPdfService
≥≥ 2
.
≥≥2 3
GenerateInvoice
≥≥3 B
(
≥≥B C
userInfoResponse
≥≥C S
,
≥≥S T%
debitTransactionRequest
≥≥U l
,
≥≥l m

spResponse
≥≥n x
)
≥≥x y
;
≥≥y z
await
µµ  
_brevoEmailService
µµ  
.
µµ  !
SendEmailWelcome
µµ! 1
(
µµ1 2
userInfoResponse
µµ2 B
,
µµB C

spResponse
µµD N
,
µµN O
request
µµO V
.
µµV W
BrandId
µµW ^
)
µµ^ _
;
µµ_ `
if
∑∑ 

(
∑∑ 
	pdfResult
∑∑ 
.
∑∑ 
Length
∑∑ 
!=
∑∑ 
	Constants
∑∑  )
.
∑∑) *

EmptyValue
∑∑* 4
)
∑∑4 5
{
∏∏ 	
await
ππ  
_brevoEmailService
ππ $
.
ππ$ %(
SendEmailMembershipConfirm
ππ% ?
(
ππ? @
userInfoResponse
ππ@ P
,
ππP Q
	pdfResult
ππR [
,
ππ[ \

spResponse
ππ] g
,
ππg h
request
ππh o
.
ππo p
BrandId
ππp w
)
ππw x
;
ππx y
}
∫∫ 	
return
ºº 
true
ºº 
;
ºº 
}
ΩΩ 
public
øø 
async
øø 
Task
øø 
<
øø 
bool
øø 
>
øø $
ExecuteRecyCoinPayment
øø 3
(
øø3 4
WalletRequest
øø4 A
request
øøB I
)
øøI J
{
¿¿ 
var
¡¡ 
debit
¡¡ 
=
¡¡ 
$num
¡¡ 
;
¡¡ 
var
¬¬ 
points
¬¬ 
=
¬¬ 
$num
¬¬ 
;
¬¬ 
var
√√ 
commissionable
√√ 
=
√√ 
$num
√√ 
;
√√  
byte
ƒƒ 
origin
ƒƒ 
=
ƒƒ 
$num
ƒƒ 
;
ƒƒ 
var
∆∆ 
invoiceDetails
∆∆ 
=
∆∆ 
new
∆∆  
List
∆∆! %
<
∆∆% &.
 InvoiceDetailsTransactionRequest
∆∆& F
>
∆∆F G
(
∆∆G H
)
∆∆H I
;
∆∆I J
var
«« 
userInfoResponse
«« 
=
«« 
await
«« $$
_accountServiceAdapter
««% ;
.
««; <
GetUserInfo
««< G
(
««G H
request
««H O
.
««O P
AffiliateId
««P [
,
««[ \
request
««] d
.
««d e
BrandId
««e l
)
««l m
;
««m n
var
»» 

productIds
»» 
=
»» 
request
»»  
.
»»  !
ProductsList
»»! -
.
»»- .
Select
»». 4
(
»»4 5
p
»»5 6
=>
»»7 9
p
»»: ;
.
»»; <
	IdProduct
»»< E
)
»»E F
.
»»F G
ToArray
»»G N
(
»»N O
)
»»O P
;
»»P Q
var
…… 
responseList
…… 
=
…… 
await
……  &
_inventoryServiceAdapter
……! 9
.
……9 :
GetProductsIds
……: H
(
……H I

productIds
……I S
,
……S T
request
……U \
.
……\ ]
BrandId
……] d
)
……d e
;
……e f
if
ÀÀ 

(
ÀÀ 
!
ÀÀ 
responseList
ÀÀ 
.
ÀÀ 
IsSuccessful
ÀÀ &
)
ÀÀ& '
return
ÃÃ 
false
ÃÃ 
;
ÃÃ 
if
ŒŒ 

(
ŒŒ 
string
ŒŒ 
.
ŒŒ 
IsNullOrEmpty
ŒŒ  
(
ŒŒ  !
responseList
ŒŒ! -
.
ŒŒ- .
Content
ŒŒ. 5
)
ŒŒ5 6
)
ŒŒ6 7
return
œœ 
false
œœ 
;
œœ 
var
—— 
result
—— 
=
—— 
JsonSerializer
—— #
.
——# $
Deserialize
——$ /
<
——/ 0
ProductsResponse
——0 @
>
——@ A
(
——A B
responseList
——B N
.
——N O
Content
——O V
)
——V W
;
——W X
if
”” 

(
”” 
result
”” 
?
”” 
.
”” 
Data
”” 
.
”” 
Count
”” 
==
”” !
	Constants
””" +
.
””+ ,

EmptyValue
””, 6
)
””6 7
{
‘‘ 	
var
’’ 
firstProductId
’’ 
=
’’  
request
’’! (
.
’’( )
ProductsList
’’) 5
.
’’5 6
First
’’6 ;
(
’’; <
)
’’< =
.
’’= >
	IdProduct
’’> G
;
’’G H
var
÷÷ 
membershipResult
÷÷  
=
÷÷! "
await
÷÷# (&
_inventoryServiceAdapter
÷÷) A
.
÷÷A B
GetProductById
÷÷B P
(
÷÷P Q
firstProductId
÷÷Q _
,
÷÷_ `
request
÷÷a h
.
÷÷h i
BrandId
÷÷i p
)
÷÷p q
;
÷÷q r
var
ÿÿ 
productResponse
ÿÿ 
=
ÿÿ  !
JsonSerializer
ÿÿ" 0
.
ÿÿ0 1
Deserialize
ÿÿ1 <
<
ÿÿ< =
ProductResponse
ÿÿ= L
>
ÿÿL M
(
ÿÿM N
membershipResult
ÿÿN ^
.
ÿÿ^ _
Content
ÿÿ_ f
!
ÿÿf g
)
ÿÿg h
;
ÿÿh i
await
⁄⁄ $
_accountServiceAdapter
⁄⁄ (
.
⁄⁄( )"
UpdateActivationDate
⁄⁄) =
(
⁄⁄= >
request
⁄⁄> E
.
⁄⁄E F
AffiliateId
⁄⁄F Q
,
⁄⁄Q R
request
⁄⁄S Z
.
⁄⁄Z [
BrandId
⁄⁄[ b
)
⁄⁄b c
;
⁄⁄c d
result
‹‹ 
.
‹‹ 
Data
‹‹ 
.
‹‹ 
Add
‹‹ 
(
‹‹ 
productResponse
‹‹ +
!
‹‹+ ,
.
‹‹, -
Data
‹‹- 1
)
‹‹1 2
;
‹‹2 3
}
›› 	
if
ﬂﬂ 

(
ﬂﬂ 
result
ﬂﬂ 
?
ﬂﬂ 
.
ﬂﬂ 
Data
ﬂﬂ 
==
ﬂﬂ 
null
ﬂﬂ  
)
ﬂﬂ  !
return
‡‡ 
false
‡‡ 
;
‡‡ 
if
‚‚ 

(
‚‚ 
result
‚‚ 
.
‚‚ 
Data
‚‚ 
.
‚‚ 
Count
‚‚ 
!=
‚‚  
request
‚‚! (
.
‚‚( )
ProductsList
‚‚) 5
.
‚‚5 6
Count
‚‚6 ;
)
‚‚; <
return
„„ 
false
„„ 
;
„„ 
foreach
ÂÂ 
(
ÂÂ 
var
ÂÂ 
item
ÂÂ 
in
ÂÂ 
result
ÂÂ #
.
ÂÂ# $
Data
ÂÂ$ (
)
ÂÂ( )
{
ÊÊ 	
var
ÁÁ 
product
ÁÁ 
=
ÁÁ 
request
ÁÁ !
.
ÁÁ! "
ProductsList
ÁÁ" .
.
ÁÁ. /
FirstOrDefault
ÁÁ/ =
(
ÁÁ= >
x
ÁÁ> ?
=>
ÁÁ@ B
x
ÁÁC D
.
ÁÁD E
	IdProduct
ÁÁE N
==
ÁÁO Q
item
ÁÁR V
.
ÁÁV W
Id
ÁÁW Y
)
ÁÁY Z
;
ÁÁZ [
var
ËË 
tax
ËË 
=
ËË 
item
ËË 
.
ËË 
Tax
ËË 
;
ËË 
debit
ÈÈ 
+=
ÈÈ 
(
ÈÈ 
int
ÈÈ 
)
ÈÈ 
(
ÈÈ 
(
ÈÈ 
item
ÈÈ  
.
ÈÈ  !
	SalePrice
ÈÈ! *
*
ÈÈ+ ,
product
ÈÈ- 4
!
ÈÈ4 5
.
ÈÈ5 6
Count
ÈÈ6 ;
)
ÈÈ; <
*
ÈÈ= >
(
ÈÈ? @
$num
ÈÈ@ A
+
ÈÈB C
(
ÈÈD E
tax
ÈÈE H
/
ÈÈI J
$num
ÈÈK N
)
ÈÈN O
)
ÈÈO P
)
ÈÈP Q
;
ÈÈQ R
points
ÍÍ 
+=
ÍÍ 
item
ÍÍ 
.
ÍÍ 
BinaryPoints
ÍÍ '
*
ÍÍ( )
product
ÍÍ* 1
.
ÍÍ1 2
Count
ÍÍ2 7
;
ÍÍ7 8
commissionable
ÎÎ 
+=
ÎÎ 
item
ÎÎ "
.
ÎÎ" #!
CommissionableValue
ÎÎ# 6
*
ÎÎ7 8
product
ÎÎ9 @
.
ÎÎ@ A
Count
ÎÎA F
;
ÎÎF G
if
ÏÏ 
(
ÏÏ 
item
ÏÏ 
.
ÏÏ 

CategoryId
ÏÏ 
==
ÏÏ  "
$num
ÏÏ# $
)
ÏÏ$ %
{
ÌÌ 
origin
ÓÓ 
=
ÓÓ 
$num
ÓÓ 
;
ÓÓ 
}
ÔÔ 
var
ÒÒ 
invoiceDetail
ÒÒ 
=
ÒÒ 
new
ÒÒ  #.
 InvoiceDetailsTransactionRequest
ÒÒ$ D
{
ÚÚ 
	ProductId
ÛÛ 
=
ÛÛ 
item
ÛÛ  
.
ÛÛ  !
Id
ÛÛ! #
,
ÛÛ# $
PaymentGroupId
ÙÙ 
=
ÙÙ  
item
ÙÙ! %
.
ÙÙ% &
PaymentGroup
ÙÙ& 2
,
ÙÙ2 3
AccumMinPurchase
ıı  
=
ıı! "
item
ıı# '
.
ıı' (
AcumCompMin
ıı( 3
,
ıı3 4
ProductName
ˆˆ 
=
ˆˆ 
item
ˆˆ "
.
ˆˆ" #
Name
ˆˆ# '
!
ˆˆ' (
,
ˆˆ( )
ProductPrice
˜˜ 
=
˜˜ 
item
˜˜ #
.
˜˜# $
	SalePrice
˜˜$ -
,
˜˜- .
ProductPriceBtc
¯¯ 
=
¯¯  !
	Constants
¯¯" +
.
¯¯+ ,

EmptyValue
¯¯, 6
,
¯¯6 7

ProductIva
˘˘ 
=
˘˘ 
item
˘˘ !
.
˘˘! "
Tax
˘˘" %
,
˘˘% &
ProductQuantity
˙˙ 
=
˙˙  !
product
˙˙" )
.
˙˙) *
Count
˙˙* /
,
˙˙/ 0#
ProductCommissionable
˚˚ %
=
˚˚& '
item
˚˚( ,
.
˚˚, -!
CommissionableValue
˚˚- @
,
˚˚@ A
BinaryPoints
¸¸ 
=
¸¸ 
item
¸¸ #
.
¸¸# $
BinaryPoints
¸¸$ 0
,
¸¸0 1
ProductPoints
˝˝ 
=
˝˝ 
item
˝˝  $
.
˝˝$ %
ValuePoints
˝˝% 0
,
˝˝0 1
ProductDiscount
˛˛ 
=
˛˛  !
item
˛˛" &
.
˛˛& '
ProductDiscount
˛˛' 6
,
˛˛6 7
CombinationId
ˇˇ 
=
ˇˇ 
	Constants
ˇˇ  )
.
ˇˇ) *

EmptyValue
ˇˇ* 4
,
ˇˇ4 5
ProductPack
ÄÄ 
=
ÄÄ 
item
ÄÄ "
.
ÄÄ" #
ProductPacks
ÄÄ# /
,
ÄÄ/ 0

BaseAmount
ÅÅ 
=
ÅÅ 
(
ÅÅ 
item
ÅÅ "
.
ÅÅ" #

BaseAmount
ÅÅ# -
*
ÅÅ. /
product
ÅÅ0 7
.
ÅÅ7 8
Count
ÅÅ8 =
)
ÅÅ= >
,
ÅÅ> ?
DailyPercentage
ÇÇ 
=
ÇÇ  !
item
ÇÇ" &
.
ÇÇ& '
DailyPercentage
ÇÇ' 6
,
ÇÇ6 7
WaitingDays
ÉÉ 
=
ÉÉ 
item
ÉÉ "
.
ÉÉ" #
DaysWait
ÉÉ# +
,
ÉÉ+ ,
DaysToPayQuantity
ÑÑ !
=
ÑÑ" #
	Constants
ÑÑ$ -
.
ÑÑ- .
DaysToPayQuantity
ÑÑ. ?
,
ÑÑ? @
ProductStart
ÖÖ 
=
ÖÖ 
false
ÖÖ $
,
ÖÖ$ %
BrandId
ÜÜ 
=
ÜÜ 
request
ÜÜ !
.
ÜÜ! "
BrandId
ÜÜ" )
,
ÜÜ) *
}
áá 
;
áá 
invoiceDetails
ââ 
.
ââ 
Add
ââ 
(
ââ 
invoiceDetail
ââ ,
)
ââ, -
;
ââ- .
}
ää 	
if
åå 

(
åå 
debit
åå 
==
åå 
	Constants
åå 
.
åå 

EmptyValue
åå )
)
åå) *
return
çç 
false
çç 
;
çç 
if
èè 

(
èè 
invoiceDetails
èè 
.
èè 
Count
èè  
==
èè! #
	Constants
èè$ -
.
èè- .

EmptyValue
èè. 8
)
èè8 9
return
êê 
false
êê 
;
êê 
var
íí %
debitTransactionRequest
íí #
=
íí$ %
new
íí& )%
DebitTransactionRequest
íí* A
{
ìì 	
Debit
îî 
=
îî 
debit
îî 
,
îî 
AffiliateId
ïï 
=
ïï 
request
ïï !
.
ïï! "
AffiliateId
ïï" -
,
ïï- .
UserId
ññ 
=
ññ 
	Constants
ññ 
.
ññ 
AdminUserId
ññ *
,
ññ* +
ConceptType
óó 
=
óó 
WalletConceptType
óó +
.
óó+ ,
purchasing_pool
óó, ;
.
óó; <
ToString
óó< D
(
óóD E
)
óóE F
,
óóF G
Points
òò 
=
òò 
points
òò 
,
òò 
Concept
ôô 
=
ôô 
	Constants
ôô 
.
ôô  $
EcoPoolProductCategory
ôô  6
,
ôô6 7
Commissionable
öö 
=
öö 
commissionable
öö +
,
öö+ ,
Bank
õõ 
=
õõ 
	Constants
õõ 
.
õõ 
CoinPay
õõ $
,
õõ$ %
PaymentMethod
úú 
=
úú 
	Constants
úú %
.
úú% &
Pagadito
úú& .
,
úú. /
Origin
ùù 
=
ùù 
origin
ùù 
,
ùù 
Level
ûû 
=
ûû 
	Constants
ûû 
.
ûû 

EmptyValue
ûû (
,
ûû( )
AffiliateUserName
üü 
=
üü 
request
üü  '
.
üü' (
AffiliateUserName
üü( 9
,
üü9 :
AdminUserName
†† 
=
†† 
request
†† #
.
††# $
BrandId
††$ +
==
††, .
$num
††/ 0
?
††1 2
	Constants
††3 <
.
††< =$
AdminEcosystemUserName
††= S
:
††T U
	Constants
††V _
.
††_ `
RecycoinAdmin
††` m
,
††m n
ReceiptNumber
°° 
=
°° 
request
°° #
.
°°# $
ReceiptNumber
°°$ 1
,
°°1 2
Type
¢¢ 
=
¢¢ 
true
¢¢ 
,
¢¢ 
	SecretKey
££ 
=
££ 
request
££ 
.
££  
	SecretKey
££  )
,
££) *
invoices
§§ 
=
§§ 
invoiceDetails
§§ %
,
§§% &
Reason
•• 
=
•• 
request
•• 
.
•• 
Bank
•• !
,
••! "
BrandId
¶¶ 
=
¶¶ 
request
¶¶ 
.
¶¶ 
BrandId
¶¶ %
,
¶¶% &
}
ßß 	
;
ßß	 

var
©© 

spResponse
©© 
=
©© 
await
©©  
_invoiceRepository
©© 1
.
©©1 2$
HandleDebitTransaction
©©2 H
(
©©H I%
debitTransactionRequest
©©I `
)
©©` a
;
©©a b
if
´´ 

(
´´ 

spResponse
´´ 
is
´´ 
null
´´ 
)
´´ 
return
¨¨ 
false
¨¨ 
;
¨¨ 
if
ÆÆ 

(
ÆÆ 
request
ÆÆ 
.
ÆÆ 
BrandId
ÆÆ 
==
ÆÆ 
	Constants
ÆÆ (
.
ÆÆ( )
RecyCoin
ÆÆ) 1
)
ÆÆ1 2
{
ØØ 	
await
∞∞ 
_bonusRepository
∞∞ "
.
∞∞" #
CreateBonus
∞∞# .
(
∞∞. /
new
∞∞/ 2
BonusRequest
∞∞3 ?
{
∞∞@ A
AffiliateId
∞∞B M
=
∞∞N O
request
∞∞P W
.
∞∞W X
AffiliateId
∞∞X c
,
∞∞c d
Amount
∞∞e k
=
∞∞l m
(
∞∞n o&
debitTransactionRequest∞∞o Ü
.∞∞Ü á
Debit∞∞á å
/∞∞ç é
$num∞∞è ê
)∞∞ê ë
,∞∞ë í
	InvoiceId∞∞ì ú
=∞∞ù û

spResponse∞∞ü ©
.∞∞© ™
Id∞∞™ ¨
,∞∞¨ ≠
Comment∞∞Æ µ
=∞∞∂ ∑
$str∞∞∏ Ã
}∞∞Õ Œ
)∞∞Œ œ
;∞∞œ –
await
±± 
_walletRepository
±± #
.
±±# $3
%DistributeCommissionsPerPurchaseAsync
±±$ I
(
±±I J
new
±±J M*
DistributeCommissionsRequest
±±N j
{
±±k l
AffiliateId
±±m x
=
±±y z
request±±{ Ç
.±±Ç É
AffiliateId±±É é
,±±é è
InvoiceAmount±±ê ù
=±±û ü'
debitTransactionRequest±±† ∑
.±±∑ ∏
Debit±±∏ Ω
,±±Ω æ
BrandId±±ø ∆
=±±« »
request±±… –
.±±– —
BrandId±±— ÿ
}±±Ÿ ⁄
)±±⁄ €
;±±€ ‹
}
≤≤ 	
await
¥¥ 
RemoveCacheKey
¥¥ 
(
¥¥ 
request
¥¥ $
.
¥¥$ %
AffiliateId
¥¥% 0
,
¥¥0 1
	CacheKeys
¥¥2 ;
.
¥¥; <&
BalanceInformationModel2
¥¥< T
)
¥¥T U
;
¥¥U V
var
µµ 

invoicePdf
µµ 
=
µµ 
await
µµ !
_recyCoinPdfService
µµ 2
.
µµ2 3
GenerateInvoice
µµ3 B
(
µµB C
userInfoResponse
µµC S
!
µµS T
,
µµT U%
debitTransactionRequest
µµV m
,
µµm n

spResponse
µµo y
)
µµy z
;
µµz {

Dictionary
∑∑ 
<
∑∑ 
string
∑∑ 
,
∑∑ 
byte
∑∑ 
[
∑∑  
]
∑∑  !
>
∑∑! "

allPdfData
∑∑# -
=
∑∑. /
new
∑∑0 3

Dictionary
∑∑4 >
<
∑∑> ?
string
∑∑? E
,
∑∑E F
byte
∑∑G K
[
∑∑K L
]
∑∑L M
>
∑∑M N
{
∏∏ 	
[
ππ 
$str
ππ 
]
ππ 
=
ππ 

invoicePdf
ππ (
}
∫∫ 	
;
∫∫	 

if
ºº 

(
ºº 

invoicePdf
ºº 
.
ºº 
Length
ºº 
!=
ºº  
	Constants
ºº! *
.
ºº* +

EmptyValue
ºº+ 5
)
ºº5 6
{
ΩΩ 	
await
ææ  
_brevoEmailService
ææ $
.
ææ$ %&
SendEmailPurchaseConfirm
ææ% =
(
ææ= >
userInfoResponse
ææ> N
!
ææN O
,
ææO P

allPdfData
ææQ [
,
ææ[ \

spResponse
ææ] g
,
ææg h
request
ææh o
.
ææo p
BrandId
ææp w
)
ææw x
;
ææx y
}
øø 	
return
¡¡ 
true
¡¡ 
;
¡¡ 
}
¬¬ 
private
ƒƒ 
async
ƒƒ 
Task
ƒƒ 
RemoveCacheKey
ƒƒ %
(
ƒƒ% &
int
ƒƒ& )
affiliateId
ƒƒ* 5
,
ƒƒ5 6
string
ƒƒ7 =
	stringKey
ƒƒ> G
)
ƒƒG H
{
≈≈ 
var
∆∆ 
key
∆∆ 
=
∆∆ 
string
∆∆ 
.
∆∆ 
Format
∆∆ %
(
∆∆% &
	stringKey
∆∆& /
,
∆∆/ 0
affiliateId
∆∆1 <
)
∆∆< =
;
∆∆= >
var
«« 
	existsKey
«« 
=
«« 
await
«« 
_redisCache
«« )
.
««) *
	KeyExists
««* 3
(
««3 4
key
««4 7
)
««7 8
;
««8 9
if
…… 

(
…… 
	existsKey
…… 
)
…… 
await
   
_redisCache
   
.
   
Delete
   $
(
  $ %
key
  % (
)
  ( )
;
  ) *
}
ÀÀ 
}ÃÃ ﬂÜ
aC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\ToThirdPartiesPaymentStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
;. /
public 
class )
ToThirdPartiesPaymentStrategy *
:+ ,
BaseService- 8
{ 
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter, B
;B C
private 
readonly 
IWalletRepository &
_walletRepository' 8
;8 9
private 
readonly  
IEcosystemPdfService ) 
_ecosystemPdfService* >
;> ?
private 
readonly 
IBrevoEmailService '
_brevoEmailService( :
;: ;
private 
readonly $
IWalletRequestRepository -$
_walletRequestRepository. F
;F G
private 
readonly 
IBonusRepository %
_bonusRepository& 6
;6 7
private 
readonly 
IRecyCoinPdfService (
_recyCoinPdfService) <
;< =
private 
readonly 

RedisCache 
_redisCache  +
;+ ,
private 
readonly  
IHouseCoinPdfService ) 
_houseCoinPdfService* >
;> ?
public   
)
ToThirdPartiesPaymentStrategy   (
(  ( )$
IInventoryServiceAdapter  ) A#
inventoryServiceAdapter  B Y
,  Y Z"
IAccountServiceAdapter!! !
accountServiceAdapter!! 4
,!!4 5
IWalletRepository!!6 G
walletRepository!!H X
,!!X Y 
IEcosystemPdfService"" 
ecosystemPdfService"" 0
,""0 1

RedisCache""2 <

redisCache""= G
,""G H
IBrevoEmailService## 
brevoEmailService## ,
,##, -$
IWalletRequestRepository##. F#
walletRequestRepository##G ^
,##^ _
IMapper$$ 
mapper$$ 
,$$ 
IBonusRepository$$ (
bonusRepository$$) 8
,$$8 9
IRecyCoinPdfService$$: M
recyCoinPdfService$$N `
,$$` a 
IHouseCoinPdfService%% 
houseCoinPdfService%% 0
)%%0 1
:%%2 3
base%%4 8
(%%8 9
mapper%%9 ?
)%%? @
{&& $
_inventoryServiceAdapter''  
=''! "#
inventoryServiceAdapter''# :
;'': ;"
_accountServiceAdapter(( 
=((  !
accountServiceAdapter((! 6
;((6 7
_walletRepository)) 
=)) 
walletRepository)) ,
;)), -
_brevoEmailService** 
=** 
brevoEmailService** .
;**. / 
_ecosystemPdfService++ 
=++ 
ecosystemPdfService++ 2
;++2 3$
_walletRequestRepository,,  
=,,! "#
walletRequestRepository,,# :
;,,: ;
_bonusRepository-- 
=-- 
bonusRepository-- *
;--* +
_recyCoinPdfService.. 
=.. 
recyCoinPdfService.. 0
;..0 1
_redisCache// 
=// 

redisCache//  
;//  ! 
_houseCoinPdfService00 
=00 
houseCoinPdfService00 2
;002 3
}11 
public33 

async33 
Task33 
<33 
bool33 
>33 
ExecutePayment33 *
(33* +
WalletRequest33+ 8
request339 @
)33@ A
{44 
var55 
debit55 
=55 
$num55 
;55 
var66 
points66 
=66 
$num66 
;66 
var77 
commissionable77 
=77 
$num77 
;77  
byte88 
origin88 
=88 
$num88 
;88 
var99 
today99 
=99 
DateTime99 
.99 
Now99  
;99  !
var;; 
invoiceDetails;; 
=;; 
new;;  
List;;! %
<;;% &,
 InvoiceDetailsTransactionRequest;;& F
>;;F G
(;;G H
);;H I
;;;I J
var<< 
userInfoResponse<< 
=<< 
await<< $"
_accountServiceAdapter<<% ;
.<<; <
GetUserInfo<<< G
(<<G H
request<<H O
.<<O P
AffiliateId<<P [
,<<[ \
request<<] d
.<<d e
BrandId<<e l
)<<l m
;<<m n
var== 
purchaseFor== 
=== 
await== "
_accountServiceAdapter==  6
.==6 7
GetUserInfo==7 B
(==B C
request==C J
.==J K
PurchaseFor==K V
,==V W
request==X _
.==_ `
BrandId==` g
)==g h
;==h i
var>> 
balanceInfo>> 
=>> 
await>> .
"GetBalanceInformationByAffiliateId>>  B
(>>B C
request>>C J
.>>J K
AffiliateId>>K V
,>>V W
request>>X _
.>>_ `
BrandId>>` g
)>>g h
;>>h i
var?? 

productIds?? 
=?? 
request??  
.??  !
ProductsList??! -
.??- .
Select??. 4
(??4 5
p??5 6
=>??7 9
p??: ;
.??; <
	IdProduct??< E
)??E F
.??F G
ToArray??G N
(??N O
)??O P
;??P Q
var@@ 
responseList@@ 
=@@ 
await@@  $
_inventoryServiceAdapter@@! 9
.@@9 :
GetProductsIds@@: H
(@@H I

productIds@@I S
,@@S T
request@@U \
.@@\ ]
BrandId@@] d
)@@d e
;@@e f
ifBB 

(BB 
!BB 
responseListBB 
.BB 
IsSuccessfulBB &
)BB& '
returnCC 
falseCC 
;CC 
ifEE 

(EE 
stringEE 
.EE 
IsNullOrEmptyEE  
(EE  !
responseListEE! -
.EE- .
ContentEE. 5
)EE5 6
)EE6 7
returnFF 
falseFF 
;FF 
varHH 
resultHH 
=HH 
responseListHH !
.HH! "
ContentHH" )
.HH) *
ToJsonObjectHH* 6
<HH6 7
ProductsResponseHH7 G
>HHG H
(HHH I
)HHI J
;HHJ K
ifJJ 

(JJ 
resultJJ 
?JJ 
.JJ 
DataJJ 
.JJ 
CountJJ 
==JJ !
	ConstantsJJ" +
.JJ+ ,

EmptyValueJJ, 6
)JJ6 7
{KK 	
varLL 
firstProductIdLL 
=LL  
requestLL! (
.LL( )
ProductsListLL) 5
.LL5 6
FirstLL6 ;
(LL; <
)LL< =
.LL= >
	IdProductLL> G
;LLG H
varMM 
membershipResultMM  
=MM! "
awaitMM# ($
_inventoryServiceAdapterMM) A
.MMA B
GetProductByIdMMB P
(MMP Q
firstProductIdMMQ _
,MM_ `
requestMMa h
.MMh i
BrandIdMMi p
)MMp q
;MMq r
varOO 
productResponseOO 
=OO  !
membershipResultOO" 2
.OO2 3
ContentOO3 :
!OO: ;
.OO; <
ToJsonObjectOO< H
<OOH I
ProductResponseOOI X
>OOX Y
(OOY Z
)OOZ [
;OO[ \
awaitQQ "
_accountServiceAdapterQQ (
.QQ( ) 
UpdateActivationDateQQ) =
(QQ= >
requestQQ> E
.QQE F
AffiliateIdQQF Q
,QQQ R
requestQQS Z
.QQZ [
BrandIdQQ[ b
)QQb c
;QQc d
resultSS 
.SS 
DataSS 
.SS 
AddSS 
(SS 
productResponseSS +
!SS+ ,
.SS, -
DataSS- 1
)SS1 2
;SS2 3
}TT 	
ifVV 

(VV 
resultVV 
?VV 
.VV 
DataVV 
isVV 
nullVV  
)VV  !
returnWW 
falseWW 
;WW 
ifYY 

(YY 
resultYY 
.YY 
DataYY 
.YY 
CountYY 
!=YY  
requestYY! (
.YY( )
ProductsListYY) 5
.YY5 6
CountYY6 ;
)YY; <
returnZZ 
falseZZ 
;ZZ 
var\\ 
productNames\\ 
=\\ 
result\\ !
.\\! "
Data\\" &
.\\& '
Select\\' -
(\\- .
item\\. 2
=>\\3 5
item\\6 :
.\\: ;
Name\\; ?
)\\? @
.\\@ A
ToArray\\A H
(\\H I
)\\I J
;\\J K
foreach^^ 
(^^ 
var^^ 
item^^ 
in^^ 
result^^ #
.^^# $
Data^^$ (
)^^( )
{__ 	
var`` 
product`` 
=`` 
request`` !
.``! "
ProductsList``" .
.``. /
FirstOrDefault``/ =
(``= >
x``> ?
=>``@ B
x``C D
.``D E
	IdProduct``E N
==``O Q
item``R V
.``V W
Id``W Y
)``Y Z
;``Z [
varaa 
taxaa 
=aa 
itemaa 
.aa 
Taxaa 
;aa 
debitbb 
+=bb 
(bb 
intbb 
)bb 
(bb 
(bb 
itembb  
.bb  !
	SalePricebb! *
*bb+ ,
productbb- 4
!bb4 5
.bb5 6
Countbb6 ;
)bb; <
*bb= >
(bb? @
$numbb@ A
+bbB C
(bbD E
taxbbE H
/bbI J
$numbbK N
)bbN O
)bbO P
)bbP Q
;bbQ R
pointscc 
+=cc 
itemcc 
.cc 
BinaryPointscc '
*cc( )
productcc* 1
.cc1 2
Countcc2 7
;cc7 8
commissionabledd 
+=dd 
itemdd "
.dd" #
CommissionableValuedd# 6
*dd7 8
productdd9 @
.dd@ A
CountddA F
;ddF G
ifee 
(ee 
itemee 
.ee 

CategoryIdee 
==ee  "
$numee# $
)ee$ %
{ff 
origingg 
=gg 
$numgg 
;gg 
}hh 
varjj 
invoiceDetailjj 
=jj 
newjj  #,
 InvoiceDetailsTransactionRequestjj$ D
{kk 
	ProductIdll 
=ll 
itemll  
.ll  !
Idll! #
,ll# $
PaymentGroupIdmm 
=mm  
itemmm! %
.mm% &
PaymentGroupmm& 2
,mm2 3
AccumMinPurchasenn  
=nn! "
itemnn# '
.nn' (
AcumCompMinnn( 3
,nn3 4
ProductNameoo 
=oo 
itemoo "
.oo" #
Nameoo# '
!oo' (
,oo( )
ProductPricepp 
=pp 
itempp #
.pp# $
	SalePricepp$ -
,pp- .
ProductPriceBtcqq 
=qq  !
	Constantsqq" +
.qq+ ,

EmptyValueqq, 6
,qq6 7

ProductIvarr 
=rr 
itemrr !
.rr! "
Taxrr" %
,rr% &
ProductQuantityss 
=ss  !
productss" )
.ss) *
Countss* /
,ss/ 0!
ProductCommissionablett %
=tt& '
itemtt( ,
.tt, -
CommissionableValuett- @
,tt@ A
BinaryPointsuu 
=uu 
itemuu #
.uu# $
BinaryPointsuu$ 0
,uu0 1
ProductPointsvv 
=vv 
itemvv  $
.vv$ %
ValuePointsvv% 0
,vv0 1
ProductDiscountww 
=ww  !
	Constantsww" +
.ww+ ,

EmptyValueww, 6
,ww6 7
CombinationIdxx 
=xx 
	Constantsxx  )
.xx) *

EmptyValuexx* 4
,xx4 5
ProductPackyy 
=yy 
itemyy "
.yy" #
ProductPacksyy# /
,yy/ 0

BaseAmountzz 
=zz 
itemzz !
.zz! "

BaseAmountzz" ,
,zz, -
DailyPercentage{{ 
={{  !
item{{" &
.{{& '
DailyPercentage{{' 6
,{{6 7
WaitingDays|| 
=|| 
item|| "
.||" #
DaysWait||# +
,||+ ,
DaysToPayQuantity}} !
=}}" #
	Constants}}$ -
.}}- .
DaysToPayQuantity}}. ?
,}}? @
ProductStart~~ 
=~~ 
false~~ $
,~~$ %
BrandId 
= 
request !
.! "
BrandId" )
}
ÄÄ 
;
ÄÄ 
invoiceDetails
ÇÇ 
.
ÇÇ 
Add
ÇÇ 
(
ÇÇ 
invoiceDetail
ÇÇ ,
)
ÇÇ, -
;
ÇÇ- .
}
ÉÉ 	
if
ÖÖ 

(
ÖÖ 
debit
ÖÖ 
==
ÖÖ 
	Constants
ÖÖ 
.
ÖÖ 

EmptyValue
ÖÖ )
)
ÖÖ) *
return
ÜÜ 
false
ÜÜ 
;
ÜÜ 
if
àà 

(
àà 
invoiceDetails
àà 
.
àà 
Count
àà  
==
àà! #
	Constants
àà$ -
.
àà- .

EmptyValue
àà. 8
)
àà8 9
return
ââ 
false
ââ 
;
ââ 
if
ãã 

(
ãã 
debit
ãã 
>
ãã 
balanceInfo
ãã 
.
ãã  
AvailableBalance
ãã  0
.
ãã0 1
GetValueOrDefault
ãã1 B
(
ããB C
)
ããC D
)
ããD E
return
åå 
false
åå 
;
åå 
var
éé 
debitTransaction
éé 
=
éé 
new
éé "&
WalletTransactionRequest
éé# ;
{
èè 	
Debit
êê 
=
êê 
debit
êê 
,
êê 
Deferred
ëë 
=
ëë 
	Constants
ëë  
.
ëë  !

EmptyValue
ëë! +
,
ëë+ ,
Detail
íí 
=
íí 
null
íí 
,
íí 
AffiliateId
ìì 
=
ìì 
request
ìì !
.
ìì! "
AffiliateId
ìì" -
,
ìì- .
AdminUserName
îî 
=
îî 
request
îî #
.
îî# $
BrandId
îî$ +
switch
îî, 2
{
ïï 
$num
ññ 
=>
ññ 
	Constants
ññ 
.
ññ $
AdminEcosystemUserName
ññ 5
,
ññ5 6
$num
óó 
=>
óó 
	Constants
óó 
.
óó 
RecycoinAdmin
óó ,
,
óó, -
$num
òò 
=>
òò 
	Constants
òò 
.
òò 
HouseCoinAdmin
òò -
,
òò- .
_
ôô 
=>
ôô 
	Constants
ôô 
.
ôô $
AdminEcosystemUserName
ôô 5
}
öö 
,
öö 
Status
õõ 
=
õõ 
true
õõ 
,
õõ 
UserId
úú 
=
úú 
	Constants
úú 
.
úú 
AdminUserId
úú *
,
úú* +
Credit
ùù 
=
ùù 
	Constants
ùù 
.
ùù 

EmptyValue
ùù )
,
ùù) *
Concept
ûû 
=
ûû 
$str
ûû >
+
ûû? @
purchaseFor
ûûA L
!
ûûL M
.
ûûM N
UserName
ûûN V
,
ûûV W
Support
üü 
=
üü 
null
üü 
!
üü 
,
üü 
Date
†† 
=
†† 
today
†† 
,
†† 
Compression
°° 
=
°° 
false
°° 
,
°°  
AffiliateUserName
¢¢ 
=
¢¢ 
request
¢¢  '
.
¢¢' (
AffiliateUserName
¢¢( 9
,
¢¢9 :
ConceptType
££ 
=
££ 
WalletConceptType
££ +
.
££+ ,
balance_transfer
££, <
,
££< =
BrandId
§§ 
=
§§ 
request
§§ 
.
§§ 
BrandId
§§ %
}
•• 	
;
••	 

var
ßß 
creditTransaction
ßß 
=
ßß 
new
ßß  #&
WalletTransactionRequest
ßß$ <
{
®® 	
Debit
©© 
=
©© 
	Constants
©© 
.
©© 

EmptyValue
©© (
,
©©( )
Deferred
™™ 
=
™™ 
	Constants
™™  
.
™™  !

EmptyValue
™™! +
,
™™+ ,
Detail
´´ 
=
´´ 
null
´´ 
,
´´ 
AffiliateId
¨¨ 
=
¨¨ 
request
¨¨ !
.
¨¨! "
PurchaseFor
¨¨" -
,
¨¨- .
AdminUserName
≠≠ 
=
≠≠ 
request
≠≠ #
.
≠≠# $
BrandId
≠≠$ +
==
≠≠, .
$num
≠≠/ 0
?
≠≠1 2
	Constants
≠≠3 <
.
≠≠< =$
AdminEcosystemUserName
≠≠= S
:
≠≠T U
	Constants
≠≠V _
.
≠≠_ `
RecycoinAdmin
≠≠` m
,
≠≠m n
Status
ÆÆ 
=
ÆÆ 
true
ÆÆ 
,
ÆÆ 
UserId
ØØ 
=
ØØ 
	Constants
ØØ 
.
ØØ 
AdminUserId
ØØ *
,
ØØ* +
Credit
∞∞ 
=
∞∞ 
debit
∞∞ 
,
∞∞ 
Concept
±± 
=
±± 
$str
±± ?
+
±±@ A
userInfoResponse
±±B R
!
±±R S
.
±±S T
UserName
±±T \
,
±±\ ]
Support
≤≤ 
=
≤≤ 
null
≤≤ 
!
≤≤ 
,
≤≤ 
Date
≥≥ 
=
≥≥ 
today
≥≥ 
,
≥≥ 
Compression
¥¥ 
=
¥¥ 
false
¥¥ 
,
¥¥  
AffiliateUserName
µµ 
=
µµ 
purchaseFor
µµ  +
.
µµ+ ,
UserName
µµ, 4
,
µµ4 5
ConceptType
∂∂ 
=
∂∂ 
WalletConceptType
∂∂ +
.
∂∂+ ,
balance_transfer
∂∂, <
,
∂∂< =
BrandId
∑∑ 
=
∑∑ 
request
∑∑ 
.
∑∑ 
BrandId
∑∑ %
}
∏∏ 	
;
∏∏	 

var
∫∫ 
debitWallet
∫∫ 
=
∫∫ 
Mapper
∫∫  
.
∫∫  !
Map
∫∫! $
<
∫∫$ %
Wallet
∫∫% +
>
∫∫+ ,
(
∫∫, -
debitTransaction
∫∫- =
)
∫∫= >
;
∫∫> ?
var
ªª 
creditWallet
ªª 
=
ªª 
Mapper
ªª !
.
ªª! "
Map
ªª" %
<
ªª% &
Wallet
ªª& ,
>
ªª, -
(
ªª- .
creditTransaction
ªª. ?
)
ªª? @
;
ªª@ A
var
ΩΩ 
success
ΩΩ 
=
ΩΩ 
await
ΩΩ 
_walletRepository
ΩΩ -
.
ΩΩ- .#
CreateTransferBalance
ΩΩ. C
(
ΩΩC D
debitWallet
ΩΩD O
,
ΩΩO P
creditWallet
ΩΩQ ]
)
ΩΩ] ^
;
ΩΩ^ _
if
øø 

(
øø 
!
øø 
success
øø 
)
øø 
return
¿¿ 
false
¿¿ 
;
¿¿ 
var
¬¬ %
debitTransactionRequest
¬¬ #
=
¬¬$ %
new
¬¬& )%
DebitTransactionRequest
¬¬* A
{
√√ 	
Debit
ƒƒ 
=
ƒƒ 
debit
ƒƒ 
,
ƒƒ 
AffiliateId
≈≈ 
=
≈≈ 
purchaseFor
≈≈ %
.
≈≈% &
Id
≈≈& (
,
≈≈( )
UserId
∆∆ 
=
∆∆ 
	Constants
∆∆ 
.
∆∆ 
AdminUserId
∆∆ *
,
∆∆* +
ConceptType
«« 
=
«« 
WalletConceptType
«« +
.
««+ ,
purchasing_pool
««, ;
.
««; <
ToString
««< D
(
««D E
)
««E F
,
««F G
Points
»» 
=
»» 
points
»» 
,
»» 
Concept
…… 
=
…… 
	Constants
…… 
.
……  $
EcoPoolProductCategory
……  6
,
……6 7
Commissionable
   
=
   
commissionable
   +
,
  + ,
Bank
ÀÀ 
=
ÀÀ 
request
ÀÀ 
.
ÀÀ 
Bank
ÀÀ 
,
ÀÀ  
PaymentMethod
ÃÃ 
=
ÃÃ 
	Constants
ÃÃ %
.
ÃÃ% &
WalletBalance
ÃÃ& 3
,
ÃÃ3 4
Origin
ÕÕ 
=
ÕÕ 
origin
ÕÕ 
,
ÕÕ 
Level
ŒŒ 
=
ŒŒ 
	Constants
ŒŒ 
.
ŒŒ 

EmptyValue
ŒŒ (
,
ŒŒ( )
AffiliateUserName
œœ 
=
œœ 
purchaseFor
œœ  +
.
œœ+ ,
UserName
œœ, 4
!
œœ4 5
,
œœ5 6
AdminUserName
–– 
=
–– 
request
–– #
.
––# $
BrandId
––$ +
==
––, .
$num
––/ 0
?
––1 2
	Constants
––3 <
.
––< =$
AdminEcosystemUserName
––= S
:
––T U
	Constants
––V _
.
––_ `
RecycoinAdmin
––` m
,
––m n
ReceiptNumber
—— 
=
—— 
request
—— #
.
——# $
ReceiptNumber
——$ 1
,
——1 2
Type
““ 
=
““ 
true
““ 
,
““ 
	SecretKey
”” 
=
”” 
request
”” 
.
””  
	SecretKey
””  )
,
””) *
invoices
‘‘ 
=
‘‘ 
invoiceDetails
‘‘ %
,
‘‘% &
Reason
’’ 
=
’’ 
string
’’ 
.
’’ 
Empty
’’ !
,
’’! "
BrandId
÷÷ 
=
÷÷ 
request
÷÷ 
.
÷÷ 
BrandId
÷÷ %
,
÷÷% &
}
◊◊ 	
;
◊◊	 

var
ŸŸ 

spResponse
ŸŸ 
=
ŸŸ 
await
ŸŸ 
_walletRepository
ŸŸ 0
.
ŸŸ0 1
DebitTransaction
ŸŸ1 A
(
ŸŸA B%
debitTransactionRequest
ŸŸB Y
)
ŸŸY Z
;
ŸŸZ [
if
€€ 

(
€€ 

spResponse
€€ 
is
€€ 
null
€€ 
)
€€ 
return
‹‹ 
false
‹‹ 
;
‹‹ 
if
ﬁﬁ 

(
ﬁﬁ 
request
ﬁﬁ 
.
ﬁﬁ 
BrandId
ﬁﬁ 
==
ﬁﬁ 
	Constants
ﬁﬁ (
.
ﬁﬁ( )
RecyCoin
ﬁﬁ) 1
)
ﬁﬁ1 2
{
ﬂﬂ 	
await
ÁÁ 
_walletRepository
ÁÁ #
.
ÁÁ# $3
%DistributeCommissionsPerPurchaseAsync
ÁÁ$ I
(
ÁÁI J
new
ÁÁJ M*
DistributeCommissionsRequest
ÁÁN j
{
ËË 
AffiliateId
ÈÈ 
=
ÈÈ 
request
ÈÈ %
.
ÈÈ% &
PurchaseFor
ÈÈ& 1
,
ÈÈ1 2
InvoiceAmount
ÍÍ 
=
ÍÍ %
debitTransactionRequest
ÍÍ  7
.
ÍÍ7 8
Debit
ÍÍ8 =
,
ÍÍ= >
BrandId
ÎÎ 
=
ÎÎ 
request
ÎÎ !
.
ÎÎ! "
BrandId
ÎÎ" )
,
ÎÎ) *
AdminUserName
ÏÏ 
=
ÏÏ 
	Constants
ÏÏ  )
.
ÏÏ) *
RecycoinAdmin
ÏÏ* 7
,
ÏÏ7 8
LevelPercentages
ÌÌ  
=
ÌÌ! "
[
ÌÌ# $
$num
ÌÌ$ (
,
ÌÌ( )
$num
ÌÌ) -
,
ÌÌ- .
$num
ÌÌ. 2
,
ÌÌ2 3
$num
ÌÌ3 7
,
ÌÌ7 8
$num
ÌÌ8 <
]
ÌÌ< =
}
ÓÓ 
)
ÓÓ 
;
ÓÓ 
}
ÔÔ 	
if
ÒÒ 

(
ÒÒ 
request
ÒÒ 
.
ÒÒ 
BrandId
ÒÒ 
==
ÒÒ 
	Constants
ÒÒ (
.
ÒÒ( )
	HouseCoin
ÒÒ) 2
)
ÒÒ2 3
{
ÚÚ 	
await
ÛÛ 
_walletRepository
ÛÛ #
.
ÛÛ# $3
%DistributeCommissionsPerPurchaseAsync
ÛÛ$ I
(
ÛÛI J
new
ÛÛJ M*
DistributeCommissionsRequest
ÛÛN j
{
ÙÙ 
AffiliateId
ıı 
=
ıı 
request
ıı %
.
ıı% &
PurchaseFor
ıı& 1
,
ıı1 2
InvoiceAmount
ıı3 @
=
ııA B%
debitTransactionRequest
ııC Z
.
ııZ [
Debit
ıı[ `
,
ıı` a
BrandId
ˆˆ 
=
ˆˆ 
request
ˆˆ !
.
ˆˆ! "
BrandId
ˆˆ" )
,
ˆˆ) *
AdminUserName
˜˜ 
=
˜˜ 
	Constants
˜˜  )
.
˜˜) *
HouseCoinAdmin
˜˜* 8
,
˜˜8 9
LevelPercentages
¯¯  
=
¯¯! "
[
¯¯# $
$num
¯¯$ (
,
¯¯( )
$num
¯¯* .
,
¯¯. /
$num
¯¯0 4
,
¯¯4 5
$num
¯¯6 :
,
¯¯: ;
$num
¯¯< @
]
¯¯@ A
,
¯¯A B
}
˘˘ 
)
˘˘ 
;
˘˘ 
}
˙˙ 	
await
¸¸ 
RemoveCacheKey
¸¸ 
(
¸¸ 
request
¸¸ $
.
¸¸$ %
AffiliateId
¸¸% 0
,
¸¸0 1
	CacheKeys
¸¸2 ;
.
¸¸; <&
BalanceInformationModel2
¸¸< T
)
¸¸T U
;
¸¸U V
await
˝˝ 
RemoveCacheKey
˝˝ 
(
˝˝ 
request
˝˝ $
.
˝˝$ %
AffiliateId
˝˝% 0
,
˝˝0 1
	CacheKeys
˝˝2 ;
.
˝˝; <'
BalanceInformationModel1A
˝˝< U
)
˝˝U V
;
˝˝V W
await
˛˛ 
RemoveCacheKey
˛˛ 
(
˛˛ 
request
˛˛ $
.
˛˛$ %
AffiliateId
˛˛% 0
,
˛˛0 1
	CacheKeys
˛˛2 ;
.
˛˛; <'
BalanceInformationModel1B
˛˛< U
)
˛˛U V
;
˛˛V W
byte
ÄÄ 
[
ÄÄ 
]
ÄÄ 

invoicePdf
ÄÄ 
;
ÄÄ 
if
ÅÅ 

(
ÅÅ 
request
ÅÅ 
.
ÅÅ 
BrandId
ÅÅ 
==
ÅÅ 
	Constants
ÅÅ (
.
ÅÅ( )
RecyCoin
ÅÅ) 1
)
ÅÅ1 2
{
ÇÇ 	

invoicePdf
ÉÉ 
=
ÉÉ 
await
ÑÑ !
_recyCoinPdfService
ÑÑ )
.
ÑÑ) *
GenerateInvoice
ÑÑ* 9
(
ÑÑ9 :
userInfoResponse
ÑÑ: J
,
ÑÑJ K%
debitTransactionRequest
ÑÑL c
,
ÑÑc d

spResponse
ÑÑe o
)
ÑÑo p
;
ÑÑp q
}
ÖÖ 	
else
ÜÜ 
if
ÜÜ 
(
ÜÜ 
request
ÜÜ 
.
ÜÜ 
BrandId
ÜÜ  
==
ÜÜ! #
	Constants
ÜÜ$ -
.
ÜÜ- .
	HouseCoin
ÜÜ. 7
)
ÜÜ7 8
{
áá 	

invoicePdf
àà 
=
àà 
await
ââ "
_houseCoinPdfService
ââ *
.
ââ* +
GenerateInvoice
ââ+ :
(
ââ: ;
userInfoResponse
ââ; K
,
ââK L%
debitTransactionRequest
ââM d
,
ââd e

spResponse
ââf p
)
ââp q
;
ââq r
}
ää 	
else
ãã 
{
åå 	

invoicePdf
çç 
=
çç 
await
éé "
_ecosystemPdfService
éé *
.
éé* +
GenerateInvoice
éé+ :
(
éé: ;
userInfoResponse
éé; K
,
ééK L%
debitTransactionRequest
ééM d
,
ééd e

spResponse
ééf p
)
éép q
;
ééq r
}
èè 	
var
ëë !
productPdfsContents
ëë 
=
ëë  !
await
ëë" '
CommonExtensions
ëë( 8
.
ëë8 9+
GetPdfContentFromProductNames
ëë9 V
(
ëëV W
productNames
ëëW c
!
ëëc d
)
ëëd e
;
ëëe f

Dictionary
ìì 
<
ìì 
string
ìì 
,
ìì 
byte
ìì 
[
ìì  
]
ìì  !
>
ìì! "

allPdfData
ìì# -
=
ìì. /
new
ìì0 3

Dictionary
ìì4 >
<
ìì> ?
string
ìì? E
,
ììE F
byte
ììG K
[
ììK L
]
ììL M
>
ììM N
{
îî 	
[
ïï 
$str
ïï 
]
ïï 
=
ïï 

invoicePdf
ïï (
}
ññ 	
;
ññ	 

foreach
òò 
(
òò 
var
òò 
pdfDataEntry
òò !
in
òò" $!
productPdfsContents
òò% 8
)
òò8 9
{
ôô 	

allPdfData
öö 
[
öö 
pdfDataEntry
öö #
.
öö# $
Key
öö$ '
]
öö' (
=
öö) *
pdfDataEntry
öö+ 7
.
öö7 8
Value
öö8 =
;
öö= >
}
õõ 	
if
ùù 

(
ùù 

invoicePdf
ùù 
.
ùù 
Length
ùù 
!=
ùù  
	Constants
ùù! *
.
ùù* +

EmptyValue
ùù+ 5
)
ùù5 6
{
ûû 	
await
üü  
_brevoEmailService
üü $
.
üü$ %&
SendEmailPurchaseConfirm
üü% =
(
üü= >
purchaseFor
üü> I
,
üüI J

allPdfData
üüK U
,
üüU V

spResponse
üüW a
,
üüa b
request
üüc j
.
üüj k
BrandId
üük r
)
üür s
;
üüs t
}
†† 	
return
¢¢ 
true
¢¢ 
;
¢¢ 
}
££ 
private
•• 
async
•• 
Task
•• 
<
•• #
BalanceInformationDto
•• ,
>
••, -0
"GetBalanceInformationByAffiliateId
••. P
(
••P Q
int
••Q T
affiliateId
••U `
,
••` a
long
••b f
brandId
••g n
)
••n o
{
¶¶ 
var
ßß 
amountRequests
ßß 
=
ßß 
await
®® &
_walletRequestRepository
®® *
.
®®* +6
(GetTotalWalletRequestAmountByAffiliateId
®®+ S
(
®®S T
affiliateId
®®T _
,
®®_ `
brandId
®®a h
)
®®h i
;
®®i j
var
©© 
availableBalance
©© 
=
©© 
await
©© $
_walletRepository
©©% 6
.
©©6 7.
 GetAvailableBalanceByAffiliateId
©©7 W
(
©©W X
affiliateId
©©X c
,
©©c d
brandId
©©e l
)
©©l m
;
©©m n
var
™™ 
reverseBalance
™™ 
=
™™ 
await
™™ "
_walletRepository
™™# 4
.
™™4 5,
GetReverseBalanceByAffiliateId
™™5 S
(
™™S T
affiliateId
™™T _
,
™™_ `
brandId
™™a h
)
™™h i
;
™™i j
var
´´ 
totalAcquisitions
´´ 
=
´´ 
await
´´  %
_walletRepository
´´& 7
.
´´7 8/
!GetTotalAcquisitionsByAffiliateId
´´8 Y
(
´´Y Z
affiliateId
´´Z e
,
´´e f
brandId
´´g n
)
´´n o
;
´´o p
var
≠≠ 
response
≠≠ 
=
≠≠ 
new
≠≠ #
BalanceInformationDto
≠≠ 0
{
ÆÆ 	
AvailableBalance
ØØ 
=
ØØ 
availableBalance
ØØ /
,
ØØ/ 0
ReverseBalance
∞∞ 
=
∞∞ 
reverseBalance
∞∞ +
??
∞∞, .
	Constants
∞∞/ 8
.
∞∞8 9

EmptyValue
∞∞9 C
,
∞∞C D
TotalAcquisitions
±± 
=
±± 
totalAcquisitions
±±  1
??
±±2 4
	Constants
±±5 >
.
±±> ?

EmptyValue
±±? I
}
≤≤ 	
;
≤≤	 

if
¥¥ 

(
¥¥ 
amountRequests
¥¥ 
==
¥¥ 
$num
¥¥  
&&
¥¥! #
response
¥¥$ ,
.
¥¥, -
ReverseBalance
¥¥- ;
==
¥¥< >
$num
¥¥? A
)
¥¥A B
return
¥¥C I
response
¥¥J R
;
¥¥R S
response
∂∂ 
.
∂∂ 
AvailableBalance
∂∂ !
-=
∂∂" $
amountRequests
∂∂% 3
;
∂∂3 4
response
∑∑ 
.
∑∑ 
AvailableBalance
∑∑ !
-=
∑∑" $
response
∑∑% -
.
∑∑- .
ReverseBalance
∑∑. <
;
∑∑< =
return
ππ 
response
ππ 
;
ππ 
}
∫∫ 
private
ºº 
async
ºº 
Task
ºº 
RemoveCacheKey
ºº %
(
ºº% &
int
ºº& )
affiliateId
ºº* 5
,
ºº5 6
string
ºº7 =
	stringKey
ºº> G
)
ººG H
{
ΩΩ 
var
ææ 
key
ææ 
=
ææ 
string
ææ 
.
ææ 
Format
ææ 
(
ææ  
	stringKey
ææ  )
,
ææ) *
affiliateId
ææ+ 6
)
ææ6 7
;
ææ7 8
var
øø 
	existsKey
øø 
=
øø 
await
øø 
_redisCache
øø )
.
øø) *
	KeyExists
øø* 3
(
øø3 4
key
øø4 7
)
øø7 8
;
øø8 9
if
¡¡ 

(
¡¡ 
	existsKey
¡¡ 
)
¡¡ 
await
¬¬ 
_redisCache
¬¬ 
.
¬¬ 
Delete
¬¬ $
(
¬¬$ %
key
¬¬% (
)
¬¬( )
;
¬¬) *
}
√√ 
}ƒƒ œà
XC:\HeroSystem\walletService\WalletService.Core\PaymentStrategies\WireTransferStrategy.cs
	namespace 	
WalletService
 
. 
Core 
. 
PaymentStrategies .
;. /
public 
class  
WireTransferStrategy !
:" #!
IWireTransferStrategy$ 9
{ 
private 
readonly 
IInvoiceRepository '
_invoiceRepository. @
;@ A
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter. D
;D E
private 
readonly  
IEcosystemPdfService ) 
_ecosystemPdfService/ C
;C D
private 
readonly 
IBrevoEmailService '
_brevoEmailService. @
;@ A
private 
readonly 
IBrandService "
_brandService# 0
;0 1
public 
 
WireTransferStrategy 
(  
IInvoiceRepository  2
invoiceRepository3 D
,D E$
IInventoryServiceAdapterF ^#
inventoryServiceAdapter_ v
,v w"
IAccountServiceAdapter !
accountServiceAdapter3 H
,H I
IBrevoEmailServiceJ \
brevoEmailService] n
,n o 
IEcosystemPdfService 
ecosystemPdfService4 G
,G H
IBrandServiceH U
brandServiceV b
)b c
{ 
_invoiceRepository 
=! "
invoiceRepository# 4
;4 5$
_inventoryServiceAdapter  
=! "#
inventoryServiceAdapter# :
;: ;"
_accountServiceAdapter 
=! "!
accountServiceAdapter# 8
;8 9
_brevoEmailService 
=! "
brevoEmailService# 4
;4 5 
_ecosystemPdfService 
=" #
ecosystemPdfService$ 7
;7 8
_brandService   
=  ! "
brandService  # /
;  / 0
}!! 
private"" 
async"" 
Task"" 
<"" 

Dictionary"" !
<""! "
string""" (
,""( )
byte""* .
["". /
]""/ 0
>""0 1
>""1 2*
GetPdfContentForTradingAcademy""3 Q
(""Q R
)""R S
{## 

Dictionary$$ 
<$$ 
string$$ 
,$$ 
byte$$ 
[$$  
]$$  !
>$$! "
pdfContents$$# .
=$$/ 0
new$$1 4

Dictionary$$5 ?
<$$? @
string$$@ F
,$$F G
byte$$H L
[$$L M
]$$M N
>$$N O
($$O P
)$$P Q
;$$Q R
var&& 
workingDirectory&& 
=&& 
Path&& #
.&&# $
GetDirectoryName&&$ 4
(&&4 5
Assembly&&5 =
.&&= > 
GetExecutingAssembly&&> R
(&&R S
)&&S T
.&&T U
Location&&U ]
)&&] ^
;&&^ _
var'' 
	separator'' 
='' 
Path'' #
.''# $"
DirectorySeparatorChar''$ :
;'': ;
var)) 
pdfDirectory)) 
=)) 
$")) 
{)) 
workingDirectory)) .
})). /
{))/ 0
	separator))0 9
}))9 :
$str)): @
{))@ A
	separator))A J
}))J K
$str))K Y
"))Y Z
;))Z [
var++ 
pdfFiles++ 
=++ 
	Directory++  
.++  !
GetFiles++! )
(++) *
pdfDirectory++* 6
,++6 7
$str++8 ?
)++? @
;++@ A
foreach-- 
(-- 
var-- 
pdfFile-- 
in-- 
pdfFiles--  (
)--( )
{.. 	
var// 
fileName// 
=// 
Path// !
.//! "
GetFileName//" -
(//- .
pdfFile//. 5
)//5 6
;//6 7
var00 

pdfContent00 
=00 
await00 "
File00# '
.00' (
ReadAllBytesAsync00( 9
(009 :
pdfFile00: A
)00A B
;00B C
pdfContents11 
[11 
fileName11  
]11  !
=11" #

pdfContent11$ .
;11. /
}22 	
return44 
pdfContents44 
;44 
}55 
public77 

async77 
Task77 
<77 
bool77 
>77 !
ExecuteEcoPoolPayment77 1
(771 2
WalletRequest772 ?
request77@ G
)77G H
{88 
var99 
debit99 
=99 
$num99 
;99  
var:: 
points:: 
=:: 
$num::  
;::  !
var;; 
commissionable;; 
=;; 
$num;;  
;;;  !
byte<< 
origin<< 
=<< 
$num<< 
;<<  
var>> 
invoiceDetails>> 
=>> 
new>> "
List>># '
<>>' (,
 InvoiceDetailsTransactionRequest>>( H
>>>H I
(>>I J
)>>J K
;>>K L
var?? 
userInfoResponse?? 
=?? 
await?? $"
_accountServiceAdapter??% ;
.??; <
GetUserInfo??< G
(??G H
request??H O
.??O P
AffiliateId??P [
,??[ \
_brandService??\ i
.??i j
BrandId??j q
)??q r
;??r s
var@@ 

productIds@@ 
=@@ 
request@@ &
.@@& '
ProductsList@@' 3
.@@3 4
Select@@4 :
(@@: ;
p@@; <
=>@@= ?
p@@@ A
.@@A B
	IdProduct@@B K
)@@K L
.@@L M
ToArray@@M T
(@@T U
)@@U V
;@@V W
varAA 
responseListAA 
=AA 
awaitAA $$
_inventoryServiceAdapterAA% =
.AA= >
GetProductsIdsAA> L
(AAL M

productIdsAAM W
,AAW X
_brandServiceAAX e
.AAe f
BrandIdAAf m
)AAm n
;AAn o
ifCC 

(CC 
!CC 
responseListCC 
.CC 
IsSuccessfulCC &
)CC& '
returnDD 
falseDD 
;DD 
ifFF 

(FF 
stringFF 
.FF 
IsNullOrEmptyFF  
(FF  !
responseListFF! -
.FF- .
ContentFF. 5
)FF5 6
)FF6 7
returnGG 
falseGG 
;GG 
varII 
resultII 
=II 
responseListII !
.II! "
ContentII" )
.II) *
ToJsonObjectII* 6
<II6 7
ProductsResponseII7 G
>IIG H
(IIH I
)III J
;IIJ K
ifKK 

(KK 
resultKK 
?KK 
.KK 
DataKK 
.KK 
CountKK 
==KK !
$numKK" #
)KK# $
{LL 	
varMM 
firstProductIdMM 
=MM! "
requestMM# *
.MM* +
ProductsListMM+ 7
.MM7 8
FirstMM8 =
(MM= >
)MM> ?
.MM? @
	IdProductMM@ I
;MMI J
varNN 
membershipResultNN  
=NN! "
awaitNN# ($
_inventoryServiceAdapterNN) A
.NNA B
GetProductByIdNNB P
(NNP Q
firstProductIdNNQ _
,NN_ `
_brandServiceNN` m
.NNm n
BrandIdNNn u
)NNu v
;NNv w
varPP 
productResponsePP 
=PP  !
membershipResultPP" 2
.PP2 3
ContentPP3 :
!PP: ;
.PP; <
ToJsonObjectPP< H
<PPH I
ProductResponsePPI X
>PPX Y
(PPY Z
)PPZ [
;PP[ \
awaitRR "
_accountServiceAdapterRR (
.RR( ) 
UpdateActivationDateRR) =
(RR= >
requestRR> E
.RRE F
AffiliateIdRRF Q
,RRQ R
_brandServiceRRR _
.RR_ `
BrandIdRR` g
)RRg h
;RRh i
resultTT 
.TT 
DataTT 
.TT 
AddTT 
(TT 
productResponseTT +
!TT+ ,
.TT, -
DataTT- 1
)TT1 2
;TT2 3
}UU 	
ifWW 

(WW 
resultWW 
?WW 
.WW 
DataWW 
==WW 
nullWW  
)WW  !
returnXX 
falseXX 
;XX 
ifZZ 

(ZZ 
resultZZ 
.ZZ 
DataZZ 
.ZZ 
CountZZ 
!=ZZ  
requestZZ! (
.ZZ( )
ProductsListZZ) 5
.ZZ5 6
CountZZ6 ;
)ZZ; <
return[[ 
false[[ 
;[[ 
var]] 
productNames]] 
=]] 
result]] !
.]]! "
Data]]" &
.]]& '
Select]]' -
(]]- .
item]]. 2
=>]]3 5
item]]6 :
.]]: ;
Name]]; ?
)]]? @
.]]@ A
ToArray]]A H
(]]H I
)]]I J
;]]J K
foreach__ 
(__ 
var__ 
item__ 
in__ 
result__ #
.__# $
Data__$ (
)__( )
{`` 	
varaa 
productaa 
=aa 
requestaa !
.aa! "
ProductsListaa" .
.aa. /
FirstOrDefaultaa/ =
(aa= >
xaa> ?
=>aa@ B
xaaC D
.aaD E
	IdProductaaE N
==aaO Q
itemaaR V
.aaV W
IdaaW Y
)aaY Z
;aaZ [
varbb 
taxbb 
=bb 
itembb 
.bb 
Taxbb "
;bb" #
debitcc 
+=cc 
(cc 
intcc "
)cc" #
(cc# $
(cc$ %
itemcc% )
.cc) *
	SalePricecc* 3
*cc4 5
productcc6 =
!cc= >
.cc> ?
Countcc? D
)ccD E
*ccF G
(ccH I
$numccI J
+ccK L
(ccM N
taxccN Q
/ccR S
$numccT W
)ccW X
)ccX Y
)ccY Z
;ccZ [
pointsdd 
+=dd 
itemdd "
.dd" #
BinaryPointsdd# /
*dd0 1
productdd2 9
.dd9 :
Countdd: ?
;dd? @
commissionableee 
+=ee 
itemee "
.ee" #
CommissionableValueee# 6
*ee7 8
productee9 @
.ee@ A
CounteeA F
;eeF G
ifff 
(ff 
itemff 
.ff 

CategoryIdff 
==ff  "
$numff# $
)ff$ %
{gg 
originhh 
=hh 
$numhh 
;hh 
}ii 
varkk 
invoiceDetailkk 
=kk 
newkk  #,
 InvoiceDetailsTransactionRequestkk$ D
{ll 
	ProductIdmm 
=mm& '
itemmm( ,
.mm, -
Idmm- /
,mm/ 0
PaymentGroupIdnn 
=nn& '
itemnn( ,
.nn, -
PaymentGroupnn- 9
,nn9 :
AccumMinPurchaseoo  
=oo& '
itemoo( ,
.oo, -
AcumCompMinoo- 8
,oo8 9
ProductNamepp 
=pp& '
itempp( ,
.pp, -
Namepp- 1
!pp1 2
,pp2 3
ProductPriceqq 
=qq& '
itemqq( ,
.qq, -
	SalePriceqq- 6
,qq6 7
ProductPriceBtcrr 
=rr& '
$numrr( )
,rr) *

ProductIvass 
=ss& '
itemss( ,
.ss, -
Taxss- 0
,ss0 1
ProductQuantitytt 
=tt& '
producttt( /
.tt/ 0
Counttt0 5
,tt5 6!
ProductCommissionableuu %
=uu& '
itemuu( ,
.uu, -
CommissionableValueuu- @
,uu@ A
BinaryPointsvv 
=vv& '
itemvv( ,
.vv, -
BinaryPointsvv- 9
,vv9 :
ProductPointsww 
=ww& '
itemww( ,
.ww, -
ValuePointsww- 8
,ww8 9
ProductDiscountxx 
=xx& '
itemxx( ,
.xx, -
ProductDiscountxx- <
,xx< =
CombinationIdyy 
=yy& '
$numyy( )
,yy) *
ProductPackzz 
=zz& '
itemzz( ,
.zz, -
ProductPackszz- 9
,zz9 :

BaseAmount{{ 
={{& '
({{( )
item{{) -
.{{- .

BaseAmount{{. 8
*{{9 :
product{{; B
.{{B C
Count{{C H
){{H I
,{{I J
DailyPercentage|| 
=||& '
item||( ,
.||, -
DailyPercentage||- <
,||< =
WaitingDays}} 
=}}& '
item}}( ,
.}}, -
DaysWait}}- 5
,}}5 6
DaysToPayQuantity~~ !
=~~& '
	Constants~~( 1
.~~1 2
DaysToPayQuantity~~2 C
,~~C D
ProductStart 
=& '
false( -
}
ÄÄ 
;
ÄÄ 
invoiceDetails
ÇÇ 
.
ÇÇ 
Add
ÇÇ 
(
ÇÇ 
invoiceDetail
ÇÇ ,
)
ÇÇ, -
;
ÇÇ- .
}
ÉÉ 	
if
ÖÖ 

(
ÖÖ 
debit
ÖÖ 
==
ÖÖ 
$num
ÖÖ 
)
ÖÖ 
return
ÜÜ 
false
ÜÜ 
;
ÜÜ 
if
àà 

(
àà 
invoiceDetails
àà 
.
àà 
Count
àà  
==
àà! #
$num
àà$ %
)
àà% &
return
ââ 
false
ââ 
;
ââ 
var
ãã %
debitTransactionRequest
ãã #
=
ãã$ %
new
ãã& )%
DebitTransactionRequest
ãã* A
{
åå 	
Debit
çç 
=
çç 
debit
çç  %
,
çç% &
AffiliateId
éé 
=
éé 
request
éé  '
.
éé' (
AffiliateId
éé( 3
,
éé3 4
UserId
èè 
=
èè 
	Constants
èè  )
.
èè) *
AdminUserId
èè* 5
,
èè5 6
ConceptType
êê 
=
êê 
WalletConceptType
êê  1
.
êê1 2
purchasing_pool
êê2 A
.
êêA B
ToString
êêB J
(
êêJ K
)
êêK L
,
êêL M
Points
ëë 
=
ëë 
points
ëë  &
,
ëë& '
Concept
íí 
=
íí 
	Constants
íí  )
.
íí) *$
EcoPoolProductCategory
íí* @
,
íí@ A
Commissionable
ìì 
=
ìì 
commissionable
ìì  .
,
ìì. /
Bank
îî 
=
îî 
	Constants
îî  )
.
îî) *
WireTransfer
îî* 6
,
îî6 7
PaymentMethod
ïï 
=
ïï 
	Constants
ïï  )
.
ïï) *
WireTransfer
ïï* 6
,
ïï6 7
Origin
ññ 
=
ññ 
origin
ññ  &
,
ññ& '
Level
óó 
=
óó 
$num
óó  !
,
óó! "
AffiliateUserName
òò 
=
òò 
request
òò  '
.
òò' (
AffiliateUserName
òò( 9
,
òò9 :
AdminUserName
ôô 
=
ôô 
	Constants
ôô  )
.
ôô) *$
AdminEcosystemUserName
ôô* @
,
ôô@ A
ReceiptNumber
öö 
=
öö 
request
öö  '
.
öö' (
ReceiptNumber
öö( 5
,
öö5 6
Type
õõ 
=
õõ 
true
õõ  $
,
õõ$ %
	SecretKey
úú 
=
úú 
request
úú  '
.
úú' (
	SecretKey
úú( 1
,
úú1 2
invoices
ùù 
=
ùù 
invoiceDetails
ùù  .
,
ùù. /
Reason
ûû 
=
ûû 
string
ûû  &
.
ûû& '
Empty
ûû' ,
}
üü 	
;
üü	 

var
°° 

spResponse
°° 
=
°° 
await
°°  
_invoiceRepository
°° 1
.
°°1 2$
HandleDebitTransaction
°°2 H
(
°°H I%
debitTransactionRequest
°°I `
)
°°` a
;
°°a b
if
££ 

(
££ 

spResponse
££ 
is
££ 
null
££ 
)
££ 
return
§§ 
false
§§ 
;
§§ 
var
¶¶ 

invoicePdf
¶¶ 
=
¶¶ 
await
ßß "
_ecosystemPdfService
ßß &
.
ßß& '
GenerateInvoice
ßß' 6
(
ßß6 7
userInfoResponse
ßß7 G
!
ßßG H
,
ßßH I%
debitTransactionRequest
ßßJ a
,
ßßa b

spResponse
ßßc m
)
ßßm n
;
ßßn o
var
©© !
productPdfsContents
©© 
=
©©  !
await
©©" '
CommonExtensions
©©( 8
.
©©8 9+
GetPdfContentFromProductNames
©©9 V
(
©©V W
productNames
©©W c
!
©©c d
)
©©d e
;
©©e f

Dictionary
´´ 
<
´´ 
string
´´ 
,
´´ 
byte
´´ 
[
´´  
]
´´  !
>
´´! "

allPdfData
´´# -
=
´´. /
new
´´0 3

Dictionary
´´4 >
<
´´> ?
string
´´? E
,
´´E F
byte
´´G K
[
´´K L
]
´´L M
>
´´M N
{
¨¨ 	
[
≠≠ 
$str
≠≠ 
]
≠≠ 
=
≠≠ 

invoicePdf
≠≠ (
}
ÆÆ 	
;
ÆÆ	 

foreach
∞∞ 
(
∞∞ 
var
∞∞ 
pdfDataEntry
∞∞ !
in
∞∞" $!
productPdfsContents
∞∞% 8
)
∞∞8 9
{
±± 	

allPdfData
≤≤ 
[
≤≤ 
pdfDataEntry
≤≤ #
.
≤≤# $
Key
≤≤$ '
]
≤≤' (
=
≤≤) *
pdfDataEntry
≤≤+ 7
.
≤≤7 8
Value
≤≤8 =
;
≤≤= >
}
≥≥ 	
if
µµ 

(
µµ 
result
µµ 
.
µµ 
Data
µµ 
.
µµ 
Find
µµ 
(
µµ 
dto
µµ  
=>
µµ! #
dto
µµ$ '
.
µµ' (
ProductType
µµ( 3
)
µµ3 4
!=
µµ5 7
null
µµ8 <
)
µµ< =
{
∂∂ 	
await
∑∑  
_brevoEmailService
∑∑ $
.
∑∑$ %
SendEmailWelcome
∑∑% 5
(
∑∑5 6
userInfoResponse
∑∑6 F
!
∑∑F G
,
∑∑G H

spResponse
∑∑I S
,
∑∑S T
request
∑∑T [
.
∑∑[ \
BrandId
∑∑\ c
)
∑∑c d
;
∑∑d e
}
∏∏ 	
if
∫∫ 

(
∫∫ 

invoicePdf
∫∫ 
.
∫∫ 
Length
∫∫ 
!=
∫∫  
$num
∫∫! "
)
∫∫" #
{
ªª 	
await
ºº  
_brevoEmailService
ºº $
.
ºº$ %&
SendEmailPurchaseConfirm
ºº% =
(
ºº= >
userInfoResponse
ºº> N
!
ººN O
,
ººO P

allPdfData
ººQ [
,
ºº[ \

spResponse
ºº] g
,
ººg h
request
ººh o
.
ººo p
BrandId
ººp w
)
ººw x
;
ººx y
}
ΩΩ 	
return
øø 
true
øø 
;
øø 
}
¿¿ 
public
¬¬ 

async
¬¬ 
Task
¬¬ 
<
¬¬ 
bool
¬¬ 
>
¬¬ #
ExecutePaymentCourses
¬¬ 1
(
¬¬1 2
WalletRequest
¬¬2 ?
request
¬¬@ G
)
¬¬G H
{
√√ 
var
ƒƒ 
debit
ƒƒ 
=
ƒƒ 
$num
ƒƒ 
;
ƒƒ  
var
≈≈ 
points
≈≈ 
=
≈≈ 
$num
≈≈  
;
≈≈  !
var
∆∆ 
commissionable
∆∆ 
=
∆∆ 
$num
∆∆  
;
∆∆  !
byte
«« 
origin
«« 
=
«« 
$num
«« 
;
««  
var
…… 
invoiceDetails
…… 
=
…… 
new
…… "
List
……# '
<
……' (.
 InvoiceDetailsTransactionRequest
……( H
>
……H I
(
……I J
)
……J K
;
……K L
var
   
userInfoResponse
   
=
   
await
   $$
_accountServiceAdapter
  % ;
.
  ; <
GetUserInfo
  < G
(
  G H
request
  H O
.
  O P
AffiliateId
  P [
,
  [ \
_brandService
  \ i
.
  i j
BrandId
  j q
)
  q r
;
  r s
var
ÀÀ 

productIds
ÀÀ 
=
ÀÀ 
request
ÀÀ &
.
ÀÀ& '
ProductsList
ÀÀ' 3
.
ÀÀ3 4
Select
ÀÀ4 :
(
ÀÀ: ;
p
ÀÀ; <
=>
ÀÀ= ?
p
ÀÀ@ A
.
ÀÀA B
	IdProduct
ÀÀB K
)
ÀÀK L
.
ÀÀL M
ToArray
ÀÀM T
(
ÀÀT U
)
ÀÀU V
;
ÀÀV W
var
ÃÃ 
responseList
ÃÃ 
=
ÃÃ 
await
ÃÃ $&
_inventoryServiceAdapter
ÃÃ% =
.
ÃÃ= >
GetProductsIds
ÃÃ> L
(
ÃÃL M

productIds
ÃÃM W
,
ÃÃW X
_brandService
ÃÃX e
.
ÃÃe f
BrandId
ÃÃf m
)
ÃÃm n
;
ÃÃn o
if
ŒŒ 

(
ŒŒ 
!
ŒŒ 
responseList
ŒŒ 
.
ŒŒ 
IsSuccessful
ŒŒ &
)
ŒŒ& '
return
œœ 
false
œœ 
;
œœ 
if
—— 

(
—— 
string
—— 
.
—— 
IsNullOrEmpty
——  
(
——  !
responseList
——! -
.
——- .
Content
——. 5
)
——5 6
)
——6 7
return
““ 
false
““ 
;
““ 
var
‘‘ 
result
‘‘ 
=
‘‘ 
responseList
‘‘ !
.
‘‘! "
Content
‘‘" )
.
‘‘) *
ToJsonObject
‘‘* 6
<
‘‘6 7
ProductsResponse
‘‘7 G
>
‘‘G H
(
‘‘H I
)
‘‘I J
;
‘‘J K
if
÷÷ 

(
÷÷ 
result
÷÷ 
?
÷÷ 
.
÷÷ 
Data
÷÷ 
==
÷÷ 
null
÷÷  
)
÷÷  !
return
◊◊ 
false
◊◊ 
;
◊◊ 
if
ŸŸ 

(
ŸŸ 
result
ŸŸ 
.
ŸŸ 
Data
ŸŸ 
.
ŸŸ 
Count
ŸŸ 
!=
ŸŸ  
request
ŸŸ! (
.
ŸŸ( )
ProductsList
ŸŸ) 5
.
ŸŸ5 6
Count
ŸŸ6 ;
)
ŸŸ; <
return
⁄⁄ 
false
⁄⁄ 
;
⁄⁄ 
foreach
‹‹ 
(
‹‹ 
var
‹‹ 
item
‹‹ 
in
‹‹ 
result
‹‹ #
.
‹‹# $
Data
‹‹$ (
)
‹‹( )
{
›› 	
var
ﬁﬁ 
product
ﬁﬁ 
=
ﬁﬁ 
request
ﬁﬁ !
.
ﬁﬁ! "
ProductsList
ﬁﬁ" .
.
ﬁﬁ. /
FirstOrDefault
ﬁﬁ/ =
(
ﬁﬁ= >
x
ﬁﬁ> ?
=>
ﬁﬁ@ B
x
ﬁﬁC D
.
ﬁﬁD E
	IdProduct
ﬁﬁE N
==
ﬁﬁO Q
item
ﬁﬁR V
.
ﬁﬁV W
Id
ﬁﬁW Y
)
ﬁﬁY Z
;
ﬁﬁZ [
var
ﬂﬂ 
tax
ﬂﬂ 
=
ﬂﬂ 
item
ﬂﬂ 
.
ﬂﬂ 
Tax
ﬂﬂ "
;
ﬂﬂ" #
debit
‡‡ 
+=
‡‡ 
(
‡‡ 
int
‡‡ "
)
‡‡" #
(
‡‡# $
(
‡‡$ %
item
‡‡% )
.
‡‡) *
	SalePrice
‡‡* 3
*
‡‡4 5
product
‡‡6 =
!
‡‡= >
.
‡‡> ?
Count
‡‡? D
)
‡‡D E
*
‡‡F G
(
‡‡H I
$num
‡‡I J
+
‡‡K L
(
‡‡M N
tax
‡‡N Q
/
‡‡R S
$num
‡‡T W
)
‡‡W X
)
‡‡X Y
)
‡‡Y Z
;
‡‡Z [
points
·· 
+=
·· 
item
·· "
.
··" #
BinaryPoints
··# /
*
··0 1
product
··2 9
.
··9 :
Count
··: ?
;
··? @
commissionable
‚‚ 
+=
‚‚ 
item
‚‚ "
.
‚‚" #!
CommissionableValue
‚‚# 6
*
‚‚7 8
product
‚‚9 @
.
‚‚@ A
Count
‚‚A F
;
‚‚F G
if
„„ 
(
„„ 
item
„„ 
.
„„ 

CategoryId
„„ 
==
„„  "
$num
„„# $
)
„„$ %
{
‰‰ 
origin
ÂÂ 
=
ÂÂ 
$num
ÂÂ 
;
ÂÂ 
}
ÊÊ 
var
ËË 
invoiceDetail
ËË 
=
ËË 
new
ËË  #.
 InvoiceDetailsTransactionRequest
ËË$ D
{
ÈÈ 
	ProductId
ÍÍ 
=
ÍÍ& '
item
ÍÍ( ,
.
ÍÍ, -
Id
ÍÍ- /
,
ÍÍ/ 0
PaymentGroupId
ÎÎ 
=
ÎÎ& '
item
ÎÎ( ,
.
ÎÎ, -
PaymentGroup
ÎÎ- 9
,
ÎÎ9 :
AccumMinPurchase
ÏÏ  
=
ÏÏ& '
item
ÏÏ( ,
.
ÏÏ, -
AcumCompMin
ÏÏ- 8
,
ÏÏ8 9
ProductName
ÌÌ 
=
ÌÌ& '
item
ÌÌ( ,
.
ÌÌ, -
Name
ÌÌ- 1
!
ÌÌ1 2
,
ÌÌ2 3
ProductPrice
ÓÓ 
=
ÓÓ& '
item
ÓÓ( ,
.
ÓÓ, -
	SalePrice
ÓÓ- 6
,
ÓÓ6 7
ProductPriceBtc
ÔÔ 
=
ÔÔ& '
$num
ÔÔ( )
,
ÔÔ) *

ProductIva
 
=
& '
item
( ,
.
, -
Tax
- 0
,
0 1
ProductQuantity
ÒÒ 
=
ÒÒ& '
product
ÒÒ( /
.
ÒÒ/ 0
Count
ÒÒ0 5
,
ÒÒ5 6#
ProductCommissionable
ÚÚ %
=
ÚÚ& '
item
ÚÚ( ,
.
ÚÚ, -!
CommissionableValue
ÚÚ- @
,
ÚÚ@ A
BinaryPoints
ÛÛ 
=
ÛÛ& '
item
ÛÛ( ,
.
ÛÛ, -
BinaryPoints
ÛÛ- 9
,
ÛÛ9 :
ProductPoints
ÙÙ 
=
ÙÙ& '
item
ÙÙ( ,
.
ÙÙ, -
ValuePoints
ÙÙ- 8
,
ÙÙ8 9
ProductDiscount
ıı 
=
ıı& '
item
ıı( ,
.
ıı, -
ProductDiscount
ıı- <
,
ıı< =
CombinationId
ˆˆ 
=
ˆˆ& '
$num
ˆˆ( )
,
ˆˆ) *
ProductPack
˜˜ 
=
˜˜& '
item
˜˜( ,
.
˜˜, -
ProductPacks
˜˜- 9
,
˜˜9 :

BaseAmount
¯¯ 
=
¯¯& '
(
¯¯( )
item
¯¯) -
.
¯¯- .

BaseAmount
¯¯. 8
*
¯¯9 :
product
¯¯; B
.
¯¯B C
Count
¯¯C H
)
¯¯H I
,
¯¯I J
DailyPercentage
˘˘ 
=
˘˘& '
item
˘˘( ,
.
˘˘, -
DailyPercentage
˘˘- <
,
˘˘< =
WaitingDays
˙˙ 
=
˙˙& '
item
˙˙( ,
.
˙˙, -
DaysWait
˙˙- 5
,
˙˙5 6
DaysToPayQuantity
˚˚ !
=
˚˚& '
	Constants
˚˚( 1
.
˚˚1 2
DaysToPayQuantity
˚˚2 C
,
˚˚C D
ProductStart
¸¸ 
=
¸¸& '
false
¸¸( -
}
˝˝ 
;
˝˝ 
invoiceDetails
ˇˇ 
.
ˇˇ 
Add
ˇˇ 
(
ˇˇ 
invoiceDetail
ˇˇ ,
)
ˇˇ, -
;
ˇˇ- .
}
ÄÄ 	
if
ÇÇ 

(
ÇÇ 
debit
ÇÇ 
==
ÇÇ 
$num
ÇÇ 
)
ÇÇ 
return
ÉÉ 
false
ÉÉ 
;
ÉÉ 
if
ÖÖ 

(
ÖÖ 
invoiceDetails
ÖÖ 
.
ÖÖ 
Count
ÖÖ  
==
ÖÖ! #
$num
ÖÖ$ %
)
ÖÖ% &
return
ÜÜ 
false
ÜÜ 
;
ÜÜ 
var
àà %
debitTransactionRequest
àà #
=
àà$ %
new
àà& )%
DebitTransactionRequest
àà* A
{
ââ 	
Debit
ää 
=
ää 
debit
ää  %
,
ää% &
AffiliateId
ãã 
=
ãã 
request
ãã  '
.
ãã' (
AffiliateId
ãã( 3
,
ãã3 4
UserId
åå 
=
åå 
	Constants
åå  )
.
åå) *
AdminUserId
åå* 5
,
åå5 6
ConceptType
çç 
=
çç 
WalletConceptType
çç  1
.
çç1 2
purchasing_pool
çç2 A
.
ççA B
ToString
ççB J
(
ççJ K
)
ççK L
,
ççL M
Points
éé 
=
éé 
points
éé  &
,
éé& '
Concept
èè 
=
èè 
	Constants
èè  )
.
èè) *$
EcoPoolProductCategory
èè* @
,
èè@ A
Commissionable
êê 
=
êê 
commissionable
êê  .
,
êê. /
Bank
ëë 
=
ëë 
	Constants
ëë  )
.
ëë) *
WireTransfer
ëë* 6
,
ëë6 7
PaymentMethod
íí 
=
íí 
	Constants
íí  )
.
íí) *
WireTransfer
íí* 6
,
íí6 7
Origin
ìì 
=
ìì 
origin
ìì  &
,
ìì& '
Level
îî 
=
îî 
$num
îî  !
,
îî! "
AffiliateUserName
ïï 
=
ïï 
request
ïï  '
.
ïï' (
AffiliateUserName
ïï( 9
,
ïï9 :
AdminUserName
ññ 
=
ññ 
	Constants
ññ  )
.
ññ) *$
AdminEcosystemUserName
ññ* @
,
ññ@ A
ReceiptNumber
óó 
=
óó 
request
óó  '
.
óó' (
ReceiptNumber
óó( 5
,
óó5 6
Type
òò 
=
òò 
true
òò  $
,
òò$ %
	SecretKey
ôô 
=
ôô 
request
ôô  '
.
ôô' (
	SecretKey
ôô( 1
,
ôô1 2
invoices
öö 
=
öö 
invoiceDetails
öö  .
,
öö. /
Reason
õõ 
=
õõ 
string
õõ  &
.
õõ& '
Empty
õõ' ,
}
úú 	
;
úú	 

var
ûû 
	hasCourse
ûû 
=
ûû 
await
ûû  
_invoiceRepository
ûû 1
.
ûû1 23
%GetInvoicesForTradingAcademyPurchases
ûû2 W
(
ûûW X
request
ûûX _
.
ûû_ `
AffiliateId
ûû` k
)
ûûk l
;
ûûl m
var
üü 

spResponse
üü 
=
üü 
await
üü  
_invoiceRepository
üü 1
.
üü1 2$
HandleDebitTransaction
üü2 H
(
üüH I%
debitTransactionRequest
üüI `
)
üü` a
;
üüa b
if
°° 

(
°° 

spResponse
°° 
is
°° 
null
°° 
)
°° 
return
¢¢ 
false
¢¢ 
;
¢¢ 

Dictionary
§§ 
<
§§ 
string
§§ 
,
§§ 
byte
§§ 
[
§§  
]
§§  !
>
§§! "

allPdfData
§§# -
=
§§. /
new
§§0 3

Dictionary
§§4 >
<
§§> ?
string
§§? E
,
§§E F
byte
§§G K
[
§§K L
]
§§L M
>
§§M N
(
§§N O
)
§§O P
;
§§P Q
var
•• 

invoicePdf
•• 
=
•• 
await
•• "
_ecosystemPdfService
•• 3
.
••3 4
GenerateInvoice
••4 C
(
••C D
userInfoResponse
••D T
!
••T U
,
••U V%
debitTransactionRequest
••W n
,
••n o

spResponse
••p z
)
••z {
;
••{ |

allPdfData
ßß 
[
ßß 
$str
ßß  
]
ßß  !
=
ßß" #

invoicePdf
ßß$ .
;
ßß. /
if
©© 

(
©© 
!
©© 
	hasCourse
©© 
&&
©© 

invoicePdf
©© $
.
©©$ %
Length
©©% +
!=
©©, .
$num
©©/ 0
)
©©0 1
{
™™ 	
var
´´ 
pdfContents
´´ 
=
´´ 
await
´´ #,
GetPdfContentForTradingAcademy
´´$ B
(
´´B C
)
´´C D
;
´´D E
foreach
¨¨ 
(
¨¨ 
var
¨¨ 
pdf
¨¨ 
in
¨¨ 
pdfContents
¨¨  +
)
¨¨+ ,
{
≠≠ 

allPdfData
ÆÆ 
[
ÆÆ 
pdf
ÆÆ 
.
ÆÆ 
Key
ÆÆ "
]
ÆÆ" #
=
ÆÆ$ %
pdf
ÆÆ& )
.
ÆÆ) *
Value
ÆÆ* /
;
ÆÆ/ 0
}
ØØ 
await
∞∞  
_brevoEmailService
∞∞ $
.
∞∞$ %0
"SendEmailPurchaseConfirmForAcademy
∞∞% G
(
∞∞G H
userInfoResponse
∞∞H X
!
∞∞X Y
,
∞∞Y Z

allPdfData
∞∞[ e
,
∞∞e f

spResponse
∞∞g q
,
∞∞q r
request
∞∞r y
.
∞∞y z
BrandId∞∞z Å
)∞∞Å Ç
;∞∞Ç É
}
±± 	
else
≤≤ 
if
≤≤ 
(
≤≤ 

invoicePdf
≤≤ 
.
≤≤ 
Length
≤≤ "
!=
≤≤# %
$num
≤≤& '
)
≤≤' (
{
≥≥ 	
await
¥¥  
_brevoEmailService
¥¥ $
.
¥¥$ %&
SendEmailPurchaseConfirm
¥¥% =
(
¥¥= >
userInfoResponse
¥¥> N
!
¥¥N O
,
¥¥O P

allPdfData
¥¥Q [
,
¥¥[ \

spResponse
¥¥] g
,
¥¥g h
request
¥¥h o
.
¥¥o p
BrandId
¥¥p w
)
¥¥w x
;
¥¥x y
}
µµ 	
return
∑∑ 
true
∑∑ 
;
∑∑ 
}
∏∏ 
}ππ ±h
KC:\HeroSystem\walletService\WalletService.Core\Services\BaseEmailService.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Services

 %
;

% &
public 
abstract 
class 
BaseEmailService &
{ 
private 
readonly $
ApplicationConfiguration -
_appSettings. :
;: ;
	protected 
BaseEmailService 
( 
IOptions '
<' ($
ApplicationConfiguration( @
>@ A
appSettingsB M
)M N
{ 
_appSettings 
= 
appSettings "
." #
Value# (
;( )
Configuration 
. 
Default 
. 
	AddApiKey '
(' (
$str( 1
,1 2
_appSettings3 ?
.? @
SendingBlue@ K
!K L
.L M
ApiKeyM S
)S T
;T U
} 
private 
string 
GetSenderName  
(  !
long! %
brandId& -
)- .
{ 
return 
brandId 
switch 
{ 	
$num 
=> 
	Constants 
. 
EcosystemSenderName .
,. /
$num 
=> 
	Constants 
. 
RecyCoinSenderName -
,- .
$num 
=> 
	Constants 
. 
HouseCoinSenderName .
,. /
$num 
=> 
	Constants 
. !
ExitoJuntosSenderName 0
,0 1
_ 
=> 
throw 
new 
ArgumentException ,
(, -
$str- >
,> ?
nameof@ F
(F G
brandIdG N
)N O
)O P
} 	
;	 

}   
private"" 
string"" 
GetBrandFolderName"" %
(""% &
long""& *
brandId""+ 2
)""2 3
{## 
return$$ 
brandId$$ 
switch$$ 
{%% 	
$num&& 
=>&& 
$str&& 
,&& 
$num'' 
=>'' 
$str'' 
,'' 
$num(( 
=>(( 
$str(( 
,(( 
$num)) 
=>)) 
$str)) 
,)) 
_** 
=>** 
throw** 
new** 
ArgumentException** ,
(**, -
$str**- >
,**> ?
nameof**@ F
(**F G
brandId**G N
)**N O
)**O P
}++ 	
;++	 

},, 
	protected.. 
async.. 
Task.. 
<.. 
string.. 
>..  
GetEmailTemplate..! 1
(..1 2
string..2 8
templateName..9 E
,..E F
long..G K
brandId..L S
)..S T
{// 
var00 
brandFolder00 
=00 
GetBrandFolderName00 ,
(00, -
brandId00- 4
)004 5
;005 6
var11 
workingDirectory11 
=11 
Path11 #
.11# $
GetDirectoryName11$ 4
(114 5
Assembly115 =
.11= > 
GetExecutingAssembly11> R
(11R S
)11S T
.11T U
Location11U ]
)11] ^
;11^ _
var22 
	separator22 
=22 
Path22 
.22 "
DirectorySeparatorChar22 3
;223 4
var33 
pathFile33 
=33 
$"33 
{33 
workingDirectory33 *
}33* +
{33+ ,
	separator33, 5
}335 6
$str336 D
{33D E
	separator33E N
}33N O
{33O P
brandFolder33P [
}33[ \
{33\ ]
	separator33] f
}33f g
{33g h
templateName33h t
}33t u
"33u v
;33v w
return55 
await55 
File55 
.55 
ReadAllTextAsync55 *
(55* +
pathFile55+ 3
,553 4
Encoding555 =
.55= >
UTF855> B
)55B C
;55C D
}66 
	protected88 
async88 
Task88 
<88 
bool88 
>88 
	SendEmail88 (
(88( )
string88) /
toEmail880 7
,887 8
string889 ?
subject88@ G
,88G H
string88I O
body88P T
,88T U
long88V Z
brandId88[ b
)88b c
{99 
var:: 
apiInstance:: 
=:: 
new:: "
TransactionalEmailsApi:: 4
(::4 5
)::5 6
;::6 7
var;; 

nameSender;; 
=;; 
GetSenderName;; &
(;;& '
brandId;;' .
);;. /
;;;/ 0
var== 
sendSmtpEmail== 
=== 
new== 
SendSmtpEmail==  -
{>> 	
To?? 
=?? 
new?? 
List?? 
<?? 
SendSmtpEmailTo?? )
>??) *
{??+ ,
new??- 0
SendSmtpEmailTo??1 @
(??@ A
toEmail??A H
)??H I
}??J K
,??K L
Subject@@ 
=@@ 
subject@@ 
,@@ 
HtmlContentAA 
=AA 
bodyAA 
,AA 
SenderBB 
=BB 
newBB 
SendSmtpEmailSenderBB ,
(BB, -

nameSenderBB- 7
,BB7 8
_appSettingsBB9 E
.BBE F
EmailCredentialsBBF V
!BBV W
.BBW X
FromBBX \
)BB\ ]
}CC 	
;CC	 

tryEE 
{FF 	
varGG 
resultGG 
=GG 
awaitGG 
apiInstanceGG *
.GG* +!
SendTransacEmailAsyncGG+ @
(GG@ A
sendSmtpEmailGGA N
)GGN O
;GGO P
ConsoleHH 
.HH 
	WriteLineHH 
(HH 
$"HH  
$strHH  E
{HHE F
resultHHF L
.HHL M
	MessageIdHHM V
}HHV W
"HHW X
)HHX Y
;HHY Z
returnII 
trueII 
;II 
}JJ 	
catchKK 
(KK 
	ExceptionKK 
exKK 
)KK 
{LL 	
ConsoleMM 
.MM 
	WriteLineMM 
(MM 
$"MM  
$strMM  5
{MM5 6
exMM6 8
.MM8 9
MessageMM9 @
}MM@ A
"MMA B
)MMB C
;MMC D
returnNN 
falseNN 
;NN 
}OO 	
}PP 
	protectedRR 
asyncRR 
TaskRR 
<RR 
boolRR 
>RR  
SendEmailWithInvoiceRR 3
(RR3 4
stringRR4 :
toEmailRR; B
,RRB C
stringRRD J
subjectRRK R
,RRR S
stringRRT Z
bodyRR[ _
,RR_ `

DictionarySS 
<SS 
stringSS 
,SS 
byteSS 
[SS  
]SS  !
>SS! "
pdfDataDictSS# .
,SS. /
longSS0 4
brandIdSS5 <
)SS< =
{TT 
varUU 
apiInstanceUU 
=UU 
newUU "
TransactionalEmailsApiUU 4
(UU4 5
)UU5 6
;UU6 7
varVV 

nameSenderVV 
=VV 
GetSenderNameVV &
(VV& '
brandIdVV' .
)VV. /
;VV/ 0
varXX 
attachmentsXX 
=XX 
pdfDataDictXX %
.XX% &
SelectXX& ,
(XX, -
kvpXX- 0
=>XX1 3
newXX4 7#
SendSmtpEmailAttachmentXX8 O
{YY 	
ContentZZ 
=ZZ 
kvpZZ 
.ZZ 
ValueZZ 
,ZZ  
Name[[ 
=[[ 
kvp[[ 
.[[ 
Key[[ 
}\\ 	
)\\	 

.\\
 
ToList\\ 
(\\ 
)\\ 
;\\ 
var^^ 
sendSmtpEmail^^ 
=^^ 
new^^ 
SendSmtpEmail^^  -
{__ 	
To`` 
=`` 
new`` 
List`` 
<`` 
SendSmtpEmailTo`` )
>``) *
{``+ ,
new``- 0
SendSmtpEmailTo``1 @
(``@ A
toEmail``A H
)``H I
}``J K
,``K L
Subjectaa 
=aa 
subjectaa 
,aa 
HtmlContentbb 
=bb 
bodybb 
,bb 
Sendercc 
=cc 
newcc 
SendSmtpEmailSendercc ,
(cc, -

nameSendercc- 7
,cc7 8
_appSettingscc9 E
.ccE F
EmailCredentialsccF V
!ccV W
.ccW X
FromccX \
)cc\ ]
,cc] ^

Attachmentdd 
=dd 
attachmentsdd $
}ee 	
;ee	 

trygg 
{hh 	
varii 
resultii 
=ii 
awaitii 
apiInstanceii *
.ii* +!
SendTransacEmailAsyncii+ @
(ii@ A
sendSmtpEmailiiA N
)iiN O
;iiO P
Consolejj 
.jj 
	WriteLinejj 
(jj 
$"jj  
$strjj  V
{jjV W
resultjjW ]
.jj] ^
	MessageIdjj^ g
}jjg h
"jjh i
)jji j
;jjj k
returnkk 
truekk 
;kk 
}ll 	
catchmm 
(mm 
	Exceptionmm 
exmm 
)mm 
{nn 	
Consoleoo 
.oo 
	WriteLineoo 
(oo 
$"oo  
$stroo  F
{ooF G
exooG I
.ooI J
MessageooJ Q
}ooQ R
"ooR S
)ooS T
;ooT U
returnpp 
falsepp 
;pp 
}qq 	
}rr 
	protectedtt 
asynctt 
Tasktt 
<tt 
booltt 
>tt "
SendEmailForMembershiptt 5
(tt5 6
stringtt6 <
toEmailtt= D
,ttD E
stringttF L
subjectttM T
,ttT U
stringttV \
bodytt] a
,tta b
bytettc g
[ttg h
]tth i
pdfDatattj q
,ttq r
longuu 
brandIduu 
)uu 
{vv 
varww 
apiInstanceww 
=ww 
newww "
TransactionalEmailsApiww 4
(ww4 5
)ww5 6
;ww6 7
varxx 

senderNamexx 
=xx 
GetSenderNamexx &
(xx& '
brandIdxx' .
)xx. /
;xx/ 0
varyy 
sendSmtpEmailyy 
=yy 
newyy 
SendSmtpEmailyy  -
{zz 	
To{{ 
={{ 
new{{ 
List{{ 
<{{ 
SendSmtpEmailTo{{ )
>{{) *
{{{+ ,
new{{- 0
SendSmtpEmailTo{{1 @
({{@ A
toEmail{{A H
){{H I
}{{J K
,{{K L
Subject|| 
=|| 
subject|| 
,|| 
HtmlContent}} 
=}} 
body}} 
,}} 
Sender~~ 
=~~ 
new~~ 
SendSmtpEmailSender~~ ,
(~~, -

senderName~~- 7
,~~7 8
_appSettings~~9 E
.~~E F
EmailCredentials~~F V
!~~V W
.~~W X
From~~X \
)~~\ ]
,~~] ^

Attachment 
= 
new 
List !
<! "#
SendSmtpEmailAttachment" 9
>9 :
{
ÄÄ 
new
ÅÅ %
SendSmtpEmailAttachment
ÅÅ +
{
ÇÇ 
Content
ÉÉ 
=
ÉÉ 
pdfData
ÉÉ %
,
ÉÉ% &
Name
ÑÑ 
=
ÑÑ 
$str
ÑÑ (
}
ÖÖ 
}
ÜÜ 
}
áá 	
;
áá	 

try
ââ 
{
ää 	
var
ãã 
result
ãã 
=
ãã 
await
ãã 
apiInstance
ãã *
.
ãã* +#
SendTransacEmailAsync
ãã+ @
(
ãã@ A
sendSmtpEmail
ããA N
)
ããN O
;
ããO P
Console
åå 
.
åå 
	WriteLine
åå 
(
åå 
$"
åå  
$str
åå  U
{
ååU V
result
ååV \
.
åå\ ]
	MessageId
åå] f
}
ååf g
"
ååg h
)
ååh i
;
ååi j
return
çç 
true
çç 
;
çç 
}
éé 	
catch
èè 
(
èè 
	Exception
èè 
ex
èè 
)
èè 
{
êê 	
Console
ëë 
.
ëë 
	WriteLine
ëë 
(
ëë 
$"
ëë  
$str
ëë  E
{
ëëE F
ex
ëëF H
.
ëëH I
Message
ëëI P
}
ëëP Q
"
ëëQ R
)
ëëR S
;
ëëS T
return
íí 
false
íí 
;
íí 
}
ìì 	
}
îî 
}ïï ◊
FC:\HeroSystem\walletService\WalletService.Core\Services\BaseService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class 
BaseService 
{ 
	protected 
readonly 
IMapper 
Mapper %
;% &
	protected 
BaseService 
( 
IMapper !
mapper" (
)( )
=>		 

Mapper		 
=		 
mapper		 
;		 
}

 ¢
GC:\HeroSystem\walletService\WalletService.Core\Services\BrandService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class 
BrandService 
: 
BaseService '
,' (
IBrandService) 6
{ 
private		 
readonly		  
IHttpContextAccessor		 ) 
_httpContextAccessor		* >
;		> ?
public 

BrandService 
( 
IMapper 
mapper  &
,& ' 
IHttpContextAccessor( <
httpContextAccessor= P
)P Q
:R S
baseT X
(X Y
mapperY _
)_ `
=> 
 
_httpContextAccessor 
=  !
httpContextAccessor" 5
;5 6
public 

long 
BrandId 
{ 
get 
{ 	
var 
brandId 
=  
_httpContextAccessor .
.. /
HttpContext/ :
?: ;
.; <
Items< A
[A B
$strB K
]K L
;L M
if 
( 
brandId 
== 
null 
)  
return! '
$num( )
;) *
return 
Convert 
. 
ToInt64 "
(" #
brandId# *
)* +
;+ ,
} 	
} 
} Ø•
LC:\HeroSystem\walletService\WalletService.Core\Services\BrevoEmailService.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Services

 %
;

% &
public 
class 
BrevoEmailService 
:  
BaseEmailService! 1
,1 2
IBrevoEmailService3 E
{ 
public 

BrevoEmailService 
( 
IOptions %
<% &$
ApplicationConfiguration& >
>> ?
appSettings@ K
)K L
:M N
baseO S
(S T
appSettingsT _
)_ `
{a b
}c d
public 

async 
Task 
< 
bool 
> 
SendEmailWelcome ,
(, -
UserInfoResponse- =
user> B
,B C
InvoicesSpResponseD V

spResponseW a
,a b
longc g
brandIdh o
)o p
{ 
var 

dictionary 
= 
new 

Dictionary '
<' (
string( .
,. /
string0 6
>6 7
(7 8
)8 9
;9 :
var 

bodyString 
= 
await 
GetEmailTemplate /
(/ 0
$str0 >
,> ?
brandId@ G
)G H
;H I
if 

( 
string 
. 
IsNullOrEmpty  
(  !

bodyString! +
)+ ,
), -
return 
false 
; 
var 
fullName 
= 
$" 
{ 
user 
. 
Name #
}# $
$str$ %
{% &
user& *
.* +
LastName+ 3
}3 4
"4 5
;5 6
var 
date 
= 
DateTime 
. 
Now 
.  
ToString  (
(( )
$str) 5
)5 6
;6 7

dictionary 
. 
Add 
( 
$str 
, 
fullName &
)& '
;' (

dictionary 
. 
Add 
( 
$str 
, 
user "
." #
UserName# +
??, .
$str/ 1
)1 2
;2 3

dictionary 
. 
Add 
( 
$str 
, 
date "
)" #
;# $

dictionary 
. 
Add 
( 
$str 
, 

spResponse (
.( )
PaymentMethod) 6
??7 9
$str: <
)< =
;= >
var   
body   
=   

bodyString   
.   
ReplaceHtml   )
(  ) *

dictionary  * 4
)  4 5
;  5 6
return"" 
await"" 
	SendEmail"" 
("" 
user"" #
.""# $
Email""$ )
!"") *
,""* +
	Constants"", 5
.""5 6%
SubjectConfirmAffiliation""6 O
,""O P
body""Q U
,""U V
brandId""W ^
)""^ _
;""_ `
}## 
public%% 

async%% 
Task%% 
<%% 
bool%% 
>%% !
SendBonusConfirmation%% 1
(%%1 2
UserInfoResponse%%2 B
user%%C G
,%%G H
string%%I O
userName%%P X
,%%X Y
long%%Z ^
brandId%%_ f
)%%f g
{&& 
var'' 

dictionary'' 
='' 
new'' 

Dictionary'' '
<''' (
string''( .
,''. /
string''0 6
>''6 7
(''7 8
)''8 9
;''9 :
var)) 

bodyString)) 
=)) 
await)) 
GetEmailTemplate)) /
())/ 0
$str))0 D
,))D E
brandId))F M
)))M N
;))N O
if++ 

(++ 
string++ 
.++ 
IsNullOrEmpty++  
(++  !

bodyString++! +
)+++ ,
)++, -
return,, 
false,, 
;,, 
var.. 
fullName.. 
=.. 
$".. 
{.. 
user.. 
... 
Name.. #
}..# $
$str..$ %
{..% &
user..& *
...* +
LastName..+ 3
}..3 4
"..4 5
;..5 6

dictionary// 
.// 
Add// 
(// 
$str// 
,// 
fullName// &
)//& '
;//' (

dictionary00 
.00 
Add00 
(00 
$str00 
,00 
userName00 &
)00& '
;00' (
var22 
body22 
=22 

bodyString22 
.22 
ReplaceHtml22 )
(22) *

dictionary22* 4
)224 5
;225 6
return44 
await44 
	SendEmail44 
(44 
user44 #
.44# $
Email44$ )
!44) *
,44* +
	Constants44, 5
.445 6
SubjectConfirmBonus446 I
,44I J
body44K O
,44O P
brandId44Q X
)44X Y
;44Y Z
}55 
public77 

async77 
Task77 
<77 
bool77 
>77 $
SendEmailPurchaseConfirm77 4
(774 5
UserInfoResponse775 E
user77F J
,77J K

Dictionary77L V
<77V W
string77W ]
,77] ^
byte77_ c
[77c d
]77d e
>77e f
pdfDataDict77g r
,77r s
InvoicesSpResponse88 

spResponse88 %
,88% &
long88' +
brandId88, 3
)883 4
{99 
var:: 

dictionary:: 
=:: 
new:: 

Dictionary:: '
<::' (
string::( .
,::. /
string::0 6
>::6 7
(::7 8
)::8 9
;::9 :
var<< 

bodyString<< 
=<< 
await<< 
GetEmailTemplate<< /
(<</ 0
$str<<0 G
,<<G H
brandId<<I P
)<<P Q
;<<Q R
if>> 

(>> 
string>> 
.>> 
IsNullOrEmpty>>  
(>>  !

bodyString>>! +
)>>+ ,
)>>, -
return?? 
false?? 
;?? 
varAA 
fullNameAA 
=AA 
$"AA 
{AA 
userAA 
.AA 
NameAA #
}AA# $
$strAA$ %
{AA% &
userAA& *
.AA* +
LastNameAA+ 3
}AA3 4
"AA4 5
;AA5 6
varBB 
dateBB 
=BB 
DateTimeBB 
.BB 
NowBB 
.BB  
ToStringBB  (
(BB( )
$strBB) 5
)BB5 6
;BB6 7

dictionaryCC 
.CC 
AddCC 
(CC 
$strCC 
,CC 
fullNameCC &
)CC& '
;CC' (

dictionaryDD 
.DD 
AddDD 
(DD 
$strDD 
,DD 
dateDD "
)DD" #
;DD# $

dictionaryEE 
.EE 
AddEE 
(EE 
$strEE 
,EE 

spResponseEE (
.EE( )
PaymentMethodEE) 6
??EE7 9
$strEE: <
)EE< =
;EE= >

dictionaryFF 
.FF 
AddFF 
(FF 
$strFF 
,FF 

spResponseFF (
.FF( )
IdFF) +
.FF+ ,
ToStringFF, 4
(FF4 5
)FF5 6
)FF6 7
;FF7 8

dictionaryGG 
.GG 
AddGG 
(GG 
$strGG 
,GG 

spResponseGG (
.GG( )
TotalInvoiceGG) 5
.GG5 6
ToStringGG6 >
(GG> ?
)GG? @
??GGA C
$strGGD F
)GGF G
;GGG H
varII 
bodyII 
=II 

bodyStringII 
.II 
ReplaceHtmlII )
(II) *

dictionaryII* 4
)II4 5
;II5 6
returnKK 
awaitKK  
SendEmailWithInvoiceKK )
(KK) *
userKK* .
.KK. /
EmailKK/ 4
!KK4 5
,KK5 6
	ConstantsKK7 @
.KK@ A"
SubjectConfirmPurchaseKKA W
,KKW X
bodyKKY ]
,KK] ^
pdfDataDictKK_ j
,KKj k
brandIdKKl s
)KKs t
;KKt u
}LL 
publicNN 

asyncNN 
TaskNN 
<NN 
boolNN 
>NN 2
&SendEmailConfirmationEmailToThirdPartyNN B
(NNB C
UserInfoResponseNNC S
userNNT X
,NNX Y
stringNNZ `
nameOfPurchaserNNa p
,NNp q
ListOO 
<OO 
stringOO 
>OO 
productNamesOO !
,OO! "
longOO# '
brandIdOO( /
)OO/ 0
{PP 
varQQ 

dictionaryQQ 
=QQ 
newQQ 

DictionaryQQ '
<QQ' (
stringQQ( .
,QQ. /
stringQQ0 6
>QQ6 7
(QQ7 8
)QQ8 9
;QQ9 :
StringBuilderRR 
productNamesBuilderRR )
=RR* +
newRR, /
StringBuilderRR0 =
(RR= >
)RR> ?
;RR? @
varTT 

bodyStringTT 
=TT 
awaitTT 
GetEmailTemplateTT /
(TT/ 0
$strTT0 M
,TTM N
brandIdTTO V
)TTV W
;TTW X
ifVV 

(VV 
stringVV 
.VV 
IsNullOrEmptyVV  
(VV  !

bodyStringVV! +
)VV+ ,
)VV, -
returnWW 
falseWW 
;WW 
varYY 
fullNameYY 
=YY 
$"YY 
{YY 
userYY 
.YY 
NameYY #
}YY# $
$strYY$ %
{YY% &
userYY& *
.YY* +
LastNameYY+ 3
}YY3 4
"YY4 5
;YY5 6
varZZ 
dateZZ 
=ZZ 
DateTimeZZ 
.ZZ 
NowZZ 
.ZZ  
ToStringZZ  (
(ZZ( )
$strZZ) 5
)ZZ5 6
;ZZ6 7

dictionary[[ 
.[[ 
Add[[ 
([[ 
$str[[ 
,[[ 
fullName[[ &
)[[& '
;[[' (

dictionary\\ 
.\\ 
Add\\ 
(\\ 
$str\\ 
,\\ 
nameOfPurchaser\\ -
)\\- .
;\\. /

dictionary]] 
.]] 
Add]] 
(]] 
$str]] 
,]] 
date]] "
)]]" #
;]]# $
foreach__ 
(__ 
var__ 
productName__  
in__! #
productNames__$ 0
)__0 1
{`` 	
productNamesBuilderaa 
.aa  

AppendLineaa  *
(aa* +
productNameaa+ 6
+aa7 8
$straa9 ?
)aa? @
;aa@ A
}bb 	

dictionarydd 
.dd 
Adddd 
(dd 
$strdd 
,dd 
productNamesBuilderdd 1
.dd1 2
ToStringdd2 :
(dd: ;
)dd; <
)dd< =
;dd= >
varff 
bodyff 
=ff 

bodyStringff 
.ff 
ReplaceHtmlff )
(ff) *

dictionaryff* 4
)ff4 5
;ff5 6
returnhh 
awaithh 
	SendEmailhh 
(hh 
userhh #
.hh# $
Emailhh$ )
!hh) *
,hh* +
	Constantshh, 5
.hh5 6"
SubjectConfirmPurchasehh6 L
,hhL M
bodyhhN R
,hhR S
brandIdhhT [
)hh[ \
;hh\ ]
}ii 
publickk 

asynckk 
Taskkk 
<kk 
boolkk 
>kk &
SendEmailMembershipConfirmkk 6
(kk6 7
UserInfoResponsekk7 G
userkkH L
,kkL M
bytekkN R
[kkR S
]kkS T
pdfDatakkU \
,kk\ ]
InvoicesSpResponsell 

spResponsell %
,ll% &
longll' +
brandIdll, 3
)ll3 4
{mm 
varnn 

dictionarynn 
=nn 
newnn 

Dictionarynn '
<nn' (
stringnn( .
,nn. /
stringnn0 6
>nn6 7
(nn7 8
)nn8 9
;nn9 :
varpp 

bodyStringpp 
=pp 
awaitpp 
GetEmailTemplatepp /
(pp/ 0
$strpp0 G
,ppG H
brandIdppI P
)ppP Q
;ppQ R
ifrr 

(rr 
stringrr 
.rr 
IsNullOrEmptyrr  
(rr  !

bodyStringrr! +
)rr+ ,
)rr, -
returnss 
falsess 
;ss 
varuu 
fullNameuu 
=uu 
$"uu 
{uu 
useruu 
.uu 
Nameuu #
}uu# $
$struu$ %
{uu% &
useruu& *
.uu* +
LastNameuu+ 3
}uu3 4
"uu4 5
;uu5 6
varvv 
datevv 
=vv 
DateTimevv 
.vv 
Nowvv 
.vv  
ToStringvv  (
(vv( )
$strvv) 5
)vv5 6
;vv6 7

dictionaryww 
.ww 
Addww 
(ww 
$strww 
,ww 
fullNameww &
)ww& '
;ww' (

dictionaryxx 
.xx 
Addxx 
(xx 
$strxx 
,xx 
datexx "
)xx" #
;xx# $

dictionaryyy 
.yy 
Addyy 
(yy 
$stryy 
,yy 

spResponseyy (
.yy( )
PaymentMethodyy) 6
??yy7 9
$stryy: <
)yy< =
;yy= >

dictionaryzz 
.zz 
Addzz 
(zz 
$strzz 
,zz 

spResponsezz (
.zz( )
InvoiceNumberzz) 6
.zz6 7
ToStringzz7 ?
(zz? @
)zz@ A
)zzA B
;zzB C

dictionary{{ 
.{{ 
Add{{ 
({{ 
$str{{ 
,{{ 

spResponse{{ (
.{{( )
TotalInvoice{{) 5
.{{5 6
ToString{{6 >
({{> ?
){{? @
??{{A C
$str{{D F
){{F G
;{{G H
var}} 
body}} 
=}} 

bodyString}} 
.}} 
ReplaceHtml}} )
(}}) *

dictionary}}* 4
)}}4 5
;}}5 6
return 
await "
SendEmailForMembership +
(+ ,
user, 0
.0 1
Email1 6
!6 7
,7 8
	Constants9 B
.B C"
SubjectConfirmPurchaseC Y
,Y Z
body[ _
,_ `
pdfDataa h
,h i
brandIdj q
)q r
;r s
}
ÄÄ 
public
ÇÇ 

async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 
bool
ÇÇ 
>
ÇÇ 0
"SendEmailPurchaseConfirmForAcademy
ÇÇ >
(
ÇÇ> ?
UserInfoResponse
ÇÇ? O
user
ÇÇP T
,
ÇÇT U

Dictionary
ÉÉ 
<
ÉÉ 
string
ÉÉ 
,
ÉÉ 
byte
ÉÉ 
[
ÉÉ  
]
ÉÉ  !
>
ÉÉ! "
pdfDataDict
ÉÉ# .
,
ÉÉ. / 
InvoicesSpResponse
ÑÑ 

spResponse
ÑÑ %
,
ÑÑ% &
long
ÑÑ' +
brandId
ÑÑ, 3
)
ÑÑ3 4
{
ÖÖ 
var
ÜÜ 

dictionary
ÜÜ 
=
ÜÜ 
new
ÜÜ 

Dictionary
ÜÜ '
<
ÜÜ' (
string
ÜÜ( .
,
ÜÜ. /
string
ÜÜ0 6
>
ÜÜ6 7
(
ÜÜ7 8
)
ÜÜ8 9
;
ÜÜ9 :
var
àà 

bodyString
àà 
=
àà 
await
àà 
GetEmailTemplate
àà /
(
àà/ 0
$str
àà0 O
,
ààO P
brandId
ààQ X
)
ààX Y
;
ààY Z
if
ää 

(
ää 
string
ää 
.
ää 
IsNullOrEmpty
ää  
(
ää  !

bodyString
ää! +
)
ää+ ,
)
ää, -
return
ãã 
false
ãã 
;
ãã 
var
çç 
fullName
çç 
=
çç 
$"
çç 
{
çç 
user
çç 
.
çç 
Name
çç #
}
çç# $
$str
çç$ %
{
çç% &
user
çç& *
.
çç* +
LastName
çç+ 3
}
çç3 4
"
çç4 5
;
çç5 6
var
éé 
date
éé 
=
éé 
DateTime
éé 
.
éé 
Now
éé 
.
éé  
ToString
éé  (
(
éé( )
$str
éé) 5
)
éé5 6
;
éé6 7

dictionary
èè 
.
èè 
Add
èè 
(
èè 
$str
èè 
,
èè 
fullName
èè &
)
èè& '
;
èè' (

dictionary
êê 
.
êê 
Add
êê 
(
êê 
$str
êê 
,
êê 
date
êê "
)
êê" #
;
êê# $
var
íí 
body
íí 
=
íí 

bodyString
íí 
.
íí 
ReplaceHtml
íí )
(
íí) *

dictionary
íí* 4
)
íí4 5
;
íí5 6
return
îî 
await
îî "
SendEmailWithInvoice
îî )
(
îî) *
user
îî* .
.
îî. /
Email
îî/ 4
!
îî4 5
,
îî5 6
	Constants
îî7 @
.
îî@ A$
SubjectConfirmPurchase
îîA W
,
îîW X
body
îîY ]
,
îî] ^
pdfDataDict
îî_ j
,
îîj k
brandId
îîl s
)
îîs t
;
îît u
}
ïï 
public
óó 

async
óó 
Task
óó 
<
óó 
bool
óó 
>
óó .
 SendInvitationsForTradingAcademy
óó <
(
óó< =#
UserAffiliateResponse
óó= R
user
óóS W
,
óóW X
string
óóY _
link
óó` d
,
óód e
string
óóf l
code
óóm q
,
óóq r
long
òò 
brandId
òò 
)
òò 
{
ôô 
var
öö 

dictionary
öö 
=
öö 
new
öö 

Dictionary
öö '
<
öö' (
string
öö( .
,
öö. /
string
öö0 6
>
öö6 7
(
öö7 8
)
öö8 9
;
öö9 :
var
úú 

bodyString
úú 
=
úú 
await
úú 
GetEmailTemplate
úú /
(
úú/ 0
$str
úú0 Q
,
úúQ R
brandId
úúS Z
)
úúZ [
;
úú[ \
if
ûû 

(
ûû 
string
ûû 
.
ûû 
IsNullOrEmpty
ûû  
(
ûû  !

bodyString
ûû! +
)
ûû+ ,
)
ûû, -
return
üü 
false
üü 
;
üü 
var
°° 
fullName
°° 
=
°° 
$"
°° 
{
°° 
user
°° 
.
°° 
Data
°° #
!
°°# $
.
°°$ %
Name
°°% )
}
°°) *
$str
°°* +
{
°°+ ,
user
°°, 0
.
°°0 1
Data
°°1 5
.
°°5 6
LastName
°°6 >
}
°°> ?
"
°°? @
;
°°@ A

dictionary
££ 
.
££ 
Add
££ 
(
££ 
$str
££ 
,
££ 
fullName
££ &
)
££& '
;
££' (

dictionary
§§ 
.
§§ 
Add
§§ 
(
§§ 
$str
§§ 
,
§§ 
link
§§ "
)
§§" #
;
§§# $

dictionary
•• 
.
•• 
Add
•• 
(
•• 
$str
•• 
,
•• 
code
•• "
)
••" #
;
••# $
var
ßß 
body
ßß 
=
ßß 

bodyString
ßß 
.
ßß 
ReplaceHtml
ßß )
(
ßß) *

dictionary
ßß* 4
)
ßß4 5
;
ßß5 6
return
©© 
await
©© 
	SendEmail
©© 
(
©© 
user
©© #
.
©©# $
Data
©©$ (
.
©©( )
Email
©©) .
!
©©. /
,
©©/ 0
	Constants
©©1 :
.
©©: ;)
SubjectInvitationForAcademy
©©; V
,
©©V W
body
©©X \
,
©©\ ]
brandId
©©^ e
)
©©e f
;
©©f g
}
™™ 
}´´ ◊’
IC:\HeroSystem\walletService\WalletService.Core\Services\CoinPayService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class 
CoinPayService 
: 
BaseService )
,) *
ICoinPayService+ :
{ 
private 
readonly 
ICoinPayAdapter $
_coinPayAdapter% 4
;4 5
private 
readonly -
!ICoinPaymentTransactionRepository 6"
_transactionRepository7 M
;M N
private 
readonly 
ILogger 
< 
CoinPayService +
>+ ,
_logger- 4
;4 5
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter, B
;B C
private   
readonly   
IInvoiceRepository   '
_invoiceRepository  ( :
;  : ;
private!! 
readonly!! #
ICoinPayPaymentStrategy!! ,#
_coinPayPaymentStrategy!!- D
;!!D E
private"" 
readonly"" $
IInventoryServiceAdapter"" -$
_inventoryServiceAdapter"". F
;""F G
private## 
readonly## $
IWalletRequestRepository## -$
_walletRequestRepository##. F
;##F G
private$$ 
readonly$$ $
IWalletWithdrawalService$$ -$
_walletWithDrawalService$$. F
;$$F G
private%% 
readonly%% 
IBrandService%% "
_brandService%%# 0
;%%0 1
private&& 
readonly&& 

RedisCache&& 
_redisCache&&  +
;&&+ ,
private'' 
readonly'' 
IWalletRepository'' &
_walletRepository''' 8
;''8 9
public(( 

CoinPayService(( 
((( 
IMapper(( !
mapper((" (
,((( )
ICoinPayAdapter((* 9
coinPayAdapter((: H
,((H I-
!ICoinPaymentTransactionRepository)) )!
transactionRepository))* ?
,))? @
ILogger))A H
<))H I
CoinPayService))I W
>))W X
logger))Y _
,))_ `"
IAccountServiceAdapter** !
accountServiceAdapter** 4
,**4 5
IInvoiceRepository++ 
invoiceRepository++ ,
,++, -#
ICoinPayPaymentStrategy,, "
coinPayPaymentStrategy,,  6
,,,6 7$
IInventoryServiceAdapter--  #
inventoryServiceAdapter--! 8
,--8 9$
IWalletRequestRepository..  #
walletRequestRepository..! 8
,..8 9$
IWalletWithdrawalService//  #
walletWithDrawalService//! 8
,//8 9
IBrandService00 
brandService00 "
,00" #

RedisCache11 

redisCache11 
,11 
IWalletRepository22 
walletRepository22 *
)33 
:33 
base33 
(33 
mapper33 
)33 
{44 
_coinPayAdapter55 
=55 
coinPayAdapter55 (
;55( )"
_transactionRepository66 
=66  !
transactionRepository66! 6
;666 7
_logger77 
=77 
logger77 
;77 "
_accountServiceAdapter88 
=88  !
accountServiceAdapter88! 6
;886 7
_invoiceRepository99 
=99 
invoiceRepository99 .
;99. /#
_coinPayPaymentStrategy:: 
=::  !"
coinPayPaymentStrategy::" 8
;::8 9$
_inventoryServiceAdapter;;  
=;;! "#
inventoryServiceAdapter;;# :
;;;: ;$
_walletRequestRepository<<  
=<<! "#
walletRequestRepository<<# :
;<<: ;$
_walletWithDrawalService==  
===! "#
walletWithDrawalService==# :
;==: ;
_brandService>> 
=>> 
brandService>> $
;>>$ %
_redisCache?? 
=?? 

redisCache??  
;??  !
_walletRepository@@ 
=@@ 
walletRepository@@ ,
;@@, -
}AA 
privateEE 
asyncEE 
TaskEE $
ExecuteMembershipPaymentEE /
(EE/ 0
WalletRequestEE0 =
walletRequestEE> K
,EEK L
ICollectionEEM X
<EEX Y
ProductRequestEEY g
>EEg h
productsEEi q
)EEq r
{FF 
walletRequestGG 
.GG 
ProductsListGG "
=GG# $
productsGG% -
.GG- .
SelectGG. 4
(GG4 5
productGG5 <
=>GG= ?
newGG@ C
ProductsRequestsGGD T
{HH 	
	IdProductII 
=II 
productII 
.II  
	ProductIdII  )
,II) *
CountJJ 
=JJ 
productJJ 
.JJ 
QuantityJJ $
}KK 	
)KK	 

.KK
 
ToListKK 
(KK 
)KK 
;KK 
awaitMM #
_coinPayPaymentStrategyMM %
.MM% &$
ExecuteMembershipPaymentMM& >
(MM> ?
walletRequestMM? L
)MML M
;MMM N
}NN 
privatePP 
asyncPP 
TaskPP !
ExecuteEcoPoolPaymentPP ,
(PP, -
WalletRequestPP- :
walletRequestPP; H
,PPH I
ICollectionPPJ U
<PPU V
ProductRequestPPV d
>PPd e
productsPPf n
)PPn o
{QQ 
walletRequestRR 
.RR 
ProductsListRR "
=RR# $
productsRR% -
.RR- .
SelectRR. 4
(RR4 5
productRR5 <
=>RR= ?
newRR@ C
ProductsRequestsRRD T
{SS 	
	IdProductTT 
=TT 
productTT 
.TT  
	ProductIdTT  )
,TT) *
CountUU 
=UU 
productUU 
.UU 
QuantityUU $
}VV 	
)VV	 

.VV
 
ToListVV 
(VV 
)VV 
;VV 
awaitXX #
_coinPayPaymentStrategyXX %
.XX% &!
ExecuteEcoPoolPaymentXX& ;
(XX; <
walletRequestXX< I
)XXI J
;XXJ K
}YY 
private[[ 
async[[ 
Task[[ "
ExecuteRecyCoinPayment[[ -
([[- .
WalletRequest[[. ;
walletRequest[[< I
,[[I J
ICollection[[K V
<[[V W
ProductRequest[[W e
>[[e f
products[[g o
)[[o p
{\\ 
walletRequest]] 
.]] 
ProductsList]] "
=]]# $
products]]% -
.]]- .
Select]]. 4
(]]4 5
product]]5 <
=>]]= ?
new]]@ C
ProductsRequests]]D T
{^^ 	
	IdProduct__ 
=__ 
product__ 
.__  
	ProductId__  )
,__) *
Count`` 
=`` 
product`` 
.`` 
Quantity`` $
}aa 	
)aa	 

.aa
 
ToListaa 
(aa 
)aa 
;aa 
awaitcc #
_coinPayPaymentStrategycc %
.cc% &"
ExecuteRecyCoinPaymentcc& <
(cc< =
walletRequestcc= J
)ccJ K
;ccK L
}dd 
privateff 
asyncff 
Taskff '
ExecuteHouseCoinPlanPaymentff 2
(ff2 3
WalletRequestff3 @
walletRequestffA N
,ffN O
ICollectionffP [
<ff[ \
ProductRequestff\ j
>ffj k
productsffl t
)fft u
{gg 
walletRequesthh 
.hh 
ProductsListhh "
=hh# $
productshh% -
.hh- .
Selecthh. 4
(hh4 5
producthh5 <
=>hh= ?
newhh@ C
ProductsRequestshhD T
{ii 	
	IdProductjj 
=jj 
productjj 
.jj  
	ProductIdjj  )
,jj) *
Countkk 
=kk 
productkk 
.kk 
Quantitykk $
}ll 	
)ll	 

.ll
 
ToListll 
(ll 
)ll 
;ll 
awaitnn #
_coinPayPaymentStrategynn %
.nn% &#
ExecuteHouseCoinPaymentnn& =
(nn= >
walletRequestnn> K
)nnK L
;nnL M
}oo 
privateqq 
asyncqq 
Taskqq )
ExecuteExitoJuntosPlanPaymentqq 4
(qq4 5
WalletRequestqq5 B
walletRequestqqC P
,qqP Q
ICollectionqqR ]
<qq] ^
ProductRequestqq^ l
>qql m
productsqqn v
)qqv w
{rr 
walletRequestss 
.ss 
ProductsListss "
=ss# $
productsss% -
.ss- .
Selectss. 4
(ss4 5
productss5 <
=>ss= ?
newss@ C
ProductsRequestsssD T
{tt 	
	IdProductuu 
=uu 
productuu 
.uu  
	ProductIduu  )
,uu) *
Countvv 
=vv 
productvv 
.vv 
Quantityvv $
}ww 	
)ww	 

.ww
 
ToListww 
(ww 
)ww 
;ww 
awaityy #
_coinPayPaymentStrategyyy %
.yy% &%
ExecuteExitoJuntosPaymentyy& ?
(yy? @
walletRequestyy@ M
)yyM N
;yyN O
}zz 
private|| 
async|| 
Task||  
ExecuteCoursePayment|| +
(||+ ,
WalletRequest||, 9
walletRequest||: G
,||G H
ICollection||I T
<||T U
ProductRequest||U c
>||c d
products||e m
)||m n
{}} 
walletRequest~~ 
.~~ 
ProductsList~~ "
=~~# $
products~~% -
.~~- .
Select~~. 4
(~~4 5
product~~5 <
=>~~= ?
new~~@ C
ProductsRequests~~D T
{ 	
	IdProduct
ÄÄ 
=
ÄÄ 
product
ÄÄ 
.
ÄÄ  
	ProductId
ÄÄ  )
,
ÄÄ) *
Count
ÅÅ 
=
ÅÅ 
product
ÅÅ 
.
ÅÅ 
Quantity
ÅÅ $
}
ÇÇ 	
)
ÇÇ	 

.
ÇÇ
 
ToList
ÇÇ 
(
ÇÇ 
)
ÇÇ 
;
ÇÇ 
await
ÑÑ %
_coinPayPaymentStrategy
ÑÑ %
.
ÑÑ% &"
ExecuteCoursePayment
ÑÑ& :
(
ÑÑ: ;
walletRequest
ÑÑ; H
)
ÑÑH I
;
ÑÑI J
}
ÖÖ 
private
áá 
async
áá 
Task
áá 
<
áá 
ProductType
áá "
>
áá" #
GetProductType
áá$ 2
(
áá2 3
List
áá3 7
<
áá7 8
ProductRequest
áá8 F
>
ááF G
request
ááH O
,
ááO P
long
ááP T
brandId
ááU \
)
áá\ ]
{
àà 
if
ââ 

(
ââ 
request
ââ 
==
ââ 
null
ââ 
||
ââ 
!
ââ  
request
ââ  '
.
ââ' (
Any
ââ( +
(
ââ+ ,
)
ââ, -
)
ââ- .
{
ää 	
throw
ãã 
new
ãã 
ArgumentException
ãã '
(
ãã' (
$str
ãã( F
)
ããF G
;
ããG H
}
åå 	
var
éé 

productIds
éé 
=
éé 
request
éé  
.
éé  !
Select
éé! '
(
éé' (
p
éé( )
=>
éé* ,
p
éé- .
.
éé. /
	ProductId
éé/ 8
)
éé8 9
.
éé9 :
ToArray
éé: A
(
ééA B
)
ééB C
;
ééC D
var
èè 
responseList
èè 
=
èè 
await
èè  &
_inventoryServiceAdapter
èè! 9
.
èè9 :
GetProductsIds
èè: H
(
èèH I

productIds
èèI S
,
èèS T
brandId
èèU \
)
èè\ ]
;
èè] ^
var
ëë 
result
ëë 
=
ëë 
JsonSerializer
ëë #
.
ëë# $
Deserialize
ëë$ /
<
ëë/ 0
ProductsResponse
ëë0 @
>
ëë@ A
(
ëëA B
responseList
ëëB N
.
ëëN O
Content
ëëO V
!
ëëV W
)
ëëW X
;
ëëX Y
int
ìì "
firstProductCategory
ìì  
;
ìì  !
if
ïï 

(
ïï 
!
ïï 
result
ïï 
!
ïï 
.
ïï 
Data
ïï 
.
ïï 
IsNullOrEmpty
ïï '
(
ïï' (
)
ïï( )
)
ïï) *
{
ññ 	"
firstProductCategory
óó  
=
óó! "
result
óó# )
.
óó) *
Data
óó* .
.
óó. /
First
óó/ 4
(
óó4 5
)
óó5 6
.
óó6 7
PaymentGroup
óó7 C
;
óóC D
}
òò 	
else
ôô 
{
öö 	
var
õõ 
membershipResult
õõ  
=
õõ! "
await
õõ# (&
_inventoryServiceAdapter
õõ) A
.
õõA B
GetProductById
õõB P
(
õõP Q

productIds
õõQ [
.
õõ[ \
First
õõ\ a
(
õõa b
)
õõb c
,
õõc d
brandId
õõe l
)
õõl m
;
õõm n
var
úú 
productResult
úú 
=
úú 
JsonSerializer
úú  .
.
úú. /
Deserialize
úú/ :
<
úú: ;
ProductResponse
úú; J
>
úúJ K
(
úúK L
membershipResult
úúL \
.
úú\ ]
Content
úú] d
!
úúd e
)
úúe f
;
úúf g"
firstProductCategory
ùù  
=
ùù! "
productResult
ùù# 0
!
ùù0 1
.
ùù1 2
Data
ùù2 6
.
ùù6 7
PaymentGroup
ùù7 C
;
ùùC D
}
ûû 	
switch
†† 
(
†† "
firstProductCategory
†† $
)
††$ %
{
°° 	
case
¢¢ 
$num
¢¢ 
:
¢¢ 
return
¢¢ 
ProductType
¢¢ &
.
¢¢& '

Membership
¢¢' 1
;
¢¢1 2
case
££ 
$num
££ 
:
££ 
case
§§ 
$num
§§ 
:
§§ 
case
•• 
$num
•• 
:
•• 
return
¶¶ 
ProductType
¶¶ "
.
¶¶" #
EcoPool
¶¶# *
;
¶¶* +
case
ßß 
$num
ßß 
:
ßß 
return
ßß 
ProductType
ßß '
.
ßß' (
RecyCoin
ßß( 0
;
ßß0 1
case
®® 
$num
®® 
:
®® 
return
®® 
ProductType
®® '
.
®®' (
HouseCoinPlan
®®( 5
;
®®5 6
case
©© 
$num
©© 
:
©© 
return
©© 
ProductType
©© '
.
©©' (
ExitoJuntosPlan
©©( 7
;
©©7 8
default
™™ 
:
™™ 
return
´´ 
ProductType
´´ "
.
´´" #
Course
´´# )
;
´´) *
}
¨¨ 	
}
≠≠ 
private
ØØ 
async
ØØ 
Task
ØØ '
ProcessPaymentTransaction
ØØ 0
(
ØØ0 1$
CoinpaymentTransaction
ØØ1 G
transactionResult
ØØH Y
)
ØØY Z
{
∞∞ 
_logger
±± 
.
±± 
LogInformation
±± 
(
±± 
$"
≤≤ 
$str
≤≤ P
{
≤≤P Q
transactionResult
≤≤Q b
.
≤≤b c
ToJsonString
≤≤c o
(
≤≤o p
)
≤≤p q
}
≤≤q r
"
≤≤r s
)
≤≤s t
;
≤≤t u
var
¥¥ 
userInfo
¥¥ 
=
¥¥ 
await
¥¥ $
_accountServiceAdapter
¥¥ 3
.
¥¥3 4
GetUserInfo
¥¥4 ?
(
¥¥? @
transactionResult
¥¥@ Q
.
¥¥Q R
AffiliateId
¥¥R ]
,
¥¥] ^
transactionResult
¥¥_ p
.
¥¥p q
BrandId
¥¥q x
)
¥¥x y
;
¥¥y z
if
∂∂ 

(
∂∂ 
userInfo
∂∂ 
==
∂∂ 
null
∂∂ 
||
∂∂ 
userInfo
∂∂  (
.
∂∂( )
UserName
∂∂) 1
==
∂∂2 4
null
∂∂5 9
)
∂∂9 :
return
∑∑ 
;
∑∑ 
var
ππ 
productsList
ππ 
=
ππ 
new
ππ 
List
ππ #
<
ππ# $
ProductsRequests
ππ$ 4
>
ππ4 5
(
ππ5 6
)
ππ6 7
;
ππ7 8
if
ªª 

(
ªª 
!
ªª 
string
ªª 
.
ªª 
IsNullOrEmpty
ªª !
(
ªª! "
transactionResult
ªª" 3
.
ªª3 4
Products
ªª4 <
)
ªª< =
)
ªª= >
{
ºº 	
var
ΩΩ 
productRequests
ΩΩ 
=
ΩΩ  !
JsonSerializer
ΩΩ" 0
.
ΩΩ0 1
Deserialize
ΩΩ1 <
<
ΩΩ< =
List
ΩΩ= A
<
ΩΩA B
ProductRequest
ΩΩB P
>
ΩΩP Q
>
ΩΩQ R
(
ΩΩR S
transactionResult
ΩΩS d
.
ΩΩd e
Products
ΩΩe m
)
ΩΩm n
;
ΩΩn o
if
ææ 
(
ææ 
productRequests
ææ 
!=
ææ  "
null
ææ# '
)
ææ' (
{
øø 
productsList
¿¿ 
=
¿¿ 
productRequests
¿¿ .
.
¡¡ 
Select
¡¡ 
(
¡¡ 
p
¡¡ 
=>
¡¡  
new
¡¡! $
ProductsRequests
¡¡% 5
{
¡¡6 7
	IdProduct
¡¡8 A
=
¡¡B C
p
¡¡D E
.
¡¡E F
	ProductId
¡¡F O
,
¡¡O P
Count
¡¡Q V
=
¡¡W X
p
¡¡Y Z
.
¡¡Z [
Quantity
¡¡[ c
}
¡¡d e
)
¡¡e f
.
¬¬ 
ToList
¬¬ 
(
¬¬ 
)
¬¬ 
;
¬¬ 
}
√√ 
}
ƒƒ 	
var
∆∆ 
walletRequest
∆∆ 
=
∆∆ 
new
∆∆ 
WalletRequest
∆∆  -
{
«« 	
AffiliateId
»» 
=
»» 
transactionResult
»» +
.
»»+ ,
AffiliateId
»», 7
,
»»7 8
AffiliateUserName
…… 
=
…… 
userInfo
……  (
.
……( )
UserName
……) 1
,
……1 2
PurchaseFor
   
=
   
	Constants
   #
.
  # $

EmptyValue
  $ .
,
  . /
Bank
ÀÀ 
=
ÀÀ 
transactionResult
ÀÀ $
.
ÀÀ$ %
	Reference
ÀÀ% .
,
ÀÀ. /
PaymentMethod
ÃÃ 
=
ÃÃ 
$num
ÃÃ 
,
ÃÃ 
ReceiptNumber
ÕÕ 
=
ÕÕ 
transactionResult
ÕÕ -
.
ÕÕ- .
IdTransaction
ÕÕ. ;
,
ÕÕ; <
ProductsList
ŒŒ 
=
ŒŒ 
productsList
ŒŒ '
,
ŒŒ' (
BrandId
œœ 
=
œœ 
transactionResult
œœ '
.
œœ' (
BrandId
œœ( /
}
–– 	
;
––	 

var
““ 
products
““ 
=
““ 
JsonSerializer
““ %
.
““% &
Deserialize
““& 1
<
““1 2
List
““2 6
<
““6 7
ProductRequest
““7 E
>
““E F
>
““F G
(
““G H
transactionResult
““H Y
.
““Y Z
Products
““Z b
)
““b c
;
““c d
if
”” 

(
”” 
products
”” 
==
”” 
null
”” 
)
”” 
return
‘‘ 
;
‘‘ 
_logger
÷÷ 
.
÷÷ 
LogInformation
÷÷ 
(
÷÷ 
$"
÷÷ !
$str
÷÷! Z
{
÷÷Z [
products
÷÷[ c
.
÷÷c d
ToJsonString
÷÷d p
(
÷÷p q
)
÷÷q r
}
÷÷r s
"
÷÷s t
)
÷÷t u
;
÷÷u v
var
ÿÿ 
isExists
ÿÿ 
=
ÿÿ 
await
ÿÿ  
_invoiceRepository
ÿÿ /
.
ÿÿ/ 0*
InvoiceExistsByReceiptNumber
ÿÿ0 L
(
ÿÿL M
transactionResult
ÿÿM ^
.
ÿÿ^ _
IdTransaction
ÿÿ_ l
,
ÿÿl m
transactionResult
ÿÿn 
.ÿÿ Ä
BrandIdÿÿÄ á
)ÿÿá à
;ÿÿà â
if
ŸŸ 

(
ŸŸ 
isExists
ŸŸ 
)
ŸŸ 
return
⁄⁄ 
;
⁄⁄ 
var
‹‹ 
productType
‹‹ 
=
‹‹ 
await
‹‹ 
GetProductType
‹‹  .
(
‹‹. /
products
‹‹/ 7
,
‹‹7 8
transactionResult
‹‹8 I
.
‹‹I J
BrandId
‹‹J Q
)
‹‹Q R
;
‹‹R S
await
ﬁﬁ 
RemoveCacheKey
ﬁﬁ 
(
ﬁﬁ 
walletRequest
ﬁﬁ *
.
ﬁﬁ* +
AffiliateId
ﬁﬁ+ 6
,
ﬁﬁ6 7
	CacheKeys
ﬁﬁ8 A
.
ﬁﬁA B&
BalanceInformationModel2
ﬁﬁB Z
)
ﬁﬁZ [
;
ﬁﬁ[ \
await
ﬂﬂ 
RemoveCacheKey
ﬂﬂ 
(
ﬂﬂ 
walletRequest
ﬂﬂ *
.
ﬂﬂ* +
AffiliateId
ﬂﬂ+ 6
,
ﬂﬂ6 7
	CacheKeys
ﬂﬂ8 A
.
ﬂﬂA B'
BalanceInformationModel1A
ﬂﬂB [
)
ﬂﬂ[ \
;
ﬂﬂ\ ]
await
‡‡ 
RemoveCacheKey
‡‡ 
(
‡‡ 
walletRequest
‡‡ *
.
‡‡* +
AffiliateId
‡‡+ 6
,
‡‡6 7
	CacheKeys
‡‡8 A
.
‡‡A B'
BalanceInformationModel1B
‡‡B [
)
‡‡[ \
;
‡‡\ ]
switch
·· 
(
·· 
productType
·· 
)
·· 
{
‚‚ 	
case
„„ 
ProductType
„„ 
.
„„ 

Membership
„„ '
:
„„' (
await
‰‰ &
ExecuteMembershipPayment
‰‰ .
(
‰‰. /
walletRequest
‰‰/ <
,
‰‰< =
products
‰‰> F
)
‰‰F G
;
‰‰G H
_logger
ÂÂ 
.
ÂÂ 
LogInformation
ÂÂ &
(
ÂÂ& '
$"
ÂÂ' )
$str
ÂÂ) s
"
ÂÂs t
)
ÂÂt u
;
ÂÂu v
break
ÊÊ 
;
ÊÊ 
case
ÁÁ 
ProductType
ÁÁ 
.
ÁÁ 
EcoPool
ÁÁ $
:
ÁÁ$ %
await
ËË #
ExecuteEcoPoolPayment
ËË +
(
ËË+ ,
walletRequest
ËË, 9
,
ËË9 :
products
ËË; C
)
ËËC D
;
ËËD E
_logger
ÈÈ 
.
ÈÈ 
LogInformation
ÈÈ &
(
ÈÈ& '
$"
ÈÈ' )
$str
ÈÈ) p
"
ÈÈp q
)
ÈÈq r
;
ÈÈr s
break
ÍÍ 
;
ÍÍ 
case
ÎÎ 
ProductType
ÎÎ 
.
ÎÎ 
RecyCoin
ÎÎ %
:
ÎÎ% &
await
ÏÏ $
ExecuteRecyCoinPayment
ÏÏ ,
(
ÏÏ, -
walletRequest
ÏÏ- :
,
ÏÏ: ;
products
ÏÏ< D
)
ÏÏD E
;
ÏÏE F
_logger
ÌÌ 
.
ÌÌ 
LogInformation
ÌÌ &
(
ÌÌ& '
$"
ÌÌ' )
$str
ÌÌ) q
"
ÌÌq r
)
ÌÌr s
;
ÌÌs t
break
ÓÓ 
;
ÓÓ 
case
ÔÔ 
ProductType
ÔÔ 
.
ÔÔ 
HouseCoinPlan
ÔÔ *
:
ÔÔ* +
await
 )
ExecuteHouseCoinPlanPayment
 1
(
1 2
walletRequest
2 ?
,
? @
products
A I
)
I J
;
J K
_logger
ÒÒ 
.
ÒÒ 
LogInformation
ÒÒ &
(
ÒÒ& '
$"
ÒÒ' )
$str
ÒÒ) v
"
ÒÒv w
)
ÒÒw x
;
ÒÒx y
break
ÚÚ 
;
ÚÚ 
case
ÛÛ 
ProductType
ÛÛ 
.
ÛÛ 
ExitoJuntosPlan
ÛÛ ,
:
ÛÛ, -
await
ÙÙ +
ExecuteExitoJuntosPlanPayment
ÙÙ 3
(
ÙÙ3 4
walletRequest
ÙÙ4 A
,
ÙÙA B
products
ÙÙC K
)
ÙÙK L
;
ÙÙL M
_logger
ıı 
.
ıı 
LogInformation
ıı &
(
ıı& '
$"
ıı' )
$str
ıı) x
"
ııx y
)
ııy z
;
ıız {
break
ˆˆ 
;
ˆˆ 
case
˜˜ 
ProductType
˜˜ 
.
˜˜ 
Course
˜˜ #
:
˜˜# $
await
¯¯ "
ExecuteCoursePayment
¯¯ *
(
¯¯* +
walletRequest
¯¯+ 8
,
¯¯8 9
products
¯¯: B
)
¯¯B C
;
¯¯C D
_logger
˘˘ 
.
˘˘ 
LogInformation
˘˘ &
(
˘˘& '
$"
˘˘' )
$str
˘˘) o
"
˘˘o p
)
˘˘p q
;
˘˘q r
break
˙˙ 
;
˙˙ 
}
˚˚ 	
}
¸¸ 
public
˛˛ 

async
˛˛ 
Task
˛˛ 
<
˛˛ '
CreateTransactionResponse
˛˛ /
?
˛˛/ 0
>
˛˛0 1
CreateTransaction
˛˛2 C
(
˛˛C D&
CreateTransactionRequest
˛˛D \
request
˛˛] d
)
˛˛d e
{
ˇˇ 
var
ÄÄ 
today
ÄÄ 
=
ÄÄ 
DateTime
ÄÄ 
.
ÄÄ 
Now
ÄÄ  
;
ÄÄ  !
var
ÅÅ 
paymentRequest
ÅÅ 
=
ÅÅ 
new
ÅÅ  
PaymentRequest
ÅÅ! /
{
ÇÇ 	
Amount
ÉÉ 
=
ÉÉ 
request
ÉÉ 
.
ÉÉ 
Amount
ÉÉ #
,
ÉÉ# $

IdCurrency
ÑÑ 
=
ÑÑ 
	Constants
ÑÑ "
.
ÑÑ" #
UsdtIdCurrency
ÑÑ# 1
,
ÑÑ1 2
Details
ÖÖ 
=
ÖÖ 
JsonSerializer
ÖÖ $
.
ÖÖ$ %
	Serialize
ÖÖ% .
(
ÖÖ. /
request
ÖÖ/ 6
.
ÖÖ6 7
Products
ÖÖ7 ?
)
ÖÖ? @
}
ÜÜ 	
;
ÜÜ	 

var
àà 
response
àà 
=
àà 
await
àà 
_coinPayAdapter
àà ,
.
àà, -
CreateTransaction
àà- >
(
àà> ?
paymentRequest
àà? M
)
ààM N
;
ààN O
if
ää 

(
ää 
response
ää 
.
ää 
Content
ää 
is
ää 
null
ää  $
)
ää$ %
return
ãã 
new
ãã '
CreateTransactionResponse
ãã 0
(
ãã0 1
)
ãã1 2
;
ãã2 3
var
çç 
result
çç 
=
çç 
response
çç 
.
çç 
Content
çç %
!
çç% &
.
çç& '
ToJsonObject
çç' 3
<
çç3 4'
CreateTransactionResponse
çç4 M
>
ççM N
(
ççN O
)
ççO P
??
ççQ S
new
éé '
CreateTransactionResponse
éé 2
(
éé2 3
)
éé3 4
;
éé4 5
var
êê  
paymentTransaction
êê 
=
êê  
new
êê! $$
CoinpaymentTransaction
êê% ;
{
ëë 	
IdTransaction
íí 
=
íí 
result
íí "
.
íí" #
Data
íí# '
!
íí' (
.
íí( )
IdTransaction
íí) 6
.
íí6 7
ToString
íí7 ?
(
íí? @
)
íí@ A
,
ííA B
AffiliateId
ìì 
=
ìì 
request
ìì !
.
ìì! "
AffiliateId
ìì" -
,
ìì- .
Amount
îî 
=
îî 
result
îî 
.
îî 
Data
îî  
!
îî  !
.
îî! "
Amount
îî" (
,
îî( )
AmountReceived
ïï 
=
ïï 
	Constants
ïï &
.
ïï& '

EmptyValue
ïï' 1
,
ïï1 2
Products
ññ 
=
ññ 
result
ññ 
.
ññ 
Data
ññ "
.
ññ" #
Details
ññ# *
!
ññ* +
,
ññ+ ,
	Acredited
óó 
=
óó 
false
óó 
,
óó 
Status
òò 
=
òò 
result
òò 
.
òò 

StatusCode
òò &
,
òò& '
PaymentMethod
ôô 
=
ôô 
$str
ôô %
,
ôô% &
	CreatedAt
öö 
=
öö 
today
öö 
,
öö 
	UpdatedAt
õõ 
=
õõ 
today
õõ 
,
õõ 
BrandId
úú 
=
úú 
_brandService
úú %
.
úú% &
BrandId
úú& -
}
ùù 	
;
ùù	 

await
üü $
_transactionRepository
üü $
.
üü$ %*
CreateCoinPaymentTransaction
üü% A
(
üüA B 
paymentTransaction
üüB T
)
üüT U
;
üüU V
return
°° 
result
°° 
;
°° 
}
¢¢ 
public
§§ 

async
§§ 
Task
§§ 
<
§§ #
CreateChannelResponse
§§ +
?
§§+ ,
>
§§, -
CreateChannel
§§. ;
(
§§; <&
CreateTransactionRequest
§§< T
request
§§U \
)
§§\ ]
{
•• 
_logger
¶¶ 
.
¶¶ 
LogInformation
¶¶ 
(
¶¶ 
$str
¶¶ O
,
¶¶O P
request
¶¶Q X
.
¶¶X Y
ToJsonString
¶¶Y e
(
¶¶e f
)
¶¶f g
)
¶¶g h
;
¶¶h i
var
®® 
today
®® 
=
®® 
DateTime
®® 
.
®® 
Now
®®  
;
®®  !$
CoinpaymentTransaction
©© 
?
©© !
transactionResponse
©©  3
;
©©3 4
var
´´ 
channelRequest
´´ 
=
´´ 
new
´´  "
CreateChannelRequest
´´! 5
{
¨¨ 	

IdCurrency
≠≠ 
=
≠≠ 
request
≠≠  
.
≠≠  !

CurrencyId
≠≠! +
,
≠≠+ ,&
IdExternalIdentification
ÆÆ $
=
ÆÆ% &
CommonExtensions
ÆÆ' 7
.
ÆÆ7 8
GenerateUniqueId
ÆÆ8 H
(
ÆÆH I
request
ÆÆI P
.
ÆÆP Q
AffiliateId
ÆÆQ \
)
ÆÆ\ ]
,
ÆÆ] ^
	IdNetwork
ØØ 
=
ØØ 
request
ØØ 
.
ØØ  
	NetworkId
ØØ  )
,
ØØ) *
TagName
∞∞ 
=
∞∞ 
request
∞∞ 
.
∞∞ 
UserName
∞∞ &
,
∞∞& '
}
±± 	
;
±±	 

var
≥≥ 
channelResponse
≥≥ 
=
≥≥ 
await
≥≥ #
_coinPayAdapter
≥≥$ 3
.
≥≥3 4
CreateChannel
≥≥4 A
(
≥≥A B
channelRequest
≥≥B P
)
≥≥P Q
;
≥≥Q R
_logger
¥¥ 
.
¥¥ 
LogInformation
¥¥ 
(
¥¥ 
$str
¥¥ V
,
¥¥V W
channelResponse
¥¥X g
.
¥¥g h
ToJsonString
¥¥h t
(
¥¥t u
)
¥¥u v
)
¥¥v w
;
¥¥w x
if
∂∂ 

(
∂∂ 
channelResponse
∂∂ 
.
∂∂ 
Content
∂∂ #
is
∂∂$ &
null
∂∂' +
)
∂∂+ ,
{
∑∑ 	
_logger
∏∏ 
.
∏∏ 

LogWarning
∏∏ 
(
∏∏ 
$str
ππ m
,
ππm n
request
∫∫ 
.
∫∫ 
AffiliateId
∫∫ #
)
∫∫# $
;
∫∫$ %
return
ªª 
null
ªª 
;
ªª 
}
ºº 	
var
ææ 
channel
ææ 
=
ææ 
channelResponse
ææ %
.
ææ% &
Content
ææ& -
.
ææ- .
ToJsonObject
ææ. :
<
ææ: ;#
CreateChannelResponse
ææ; P
>
ææP Q
(
ææQ R
)
ææR S
;
ææS T
if
øø 

(
øø 
channel
øø 
is
øø 
null
øø 
||
øø 
channel
øø &
.
øø& '

StatusCode
øø' 1
!=
øø2 4
$num
øø5 6
)
øø6 7
{
¿¿ 	
_logger
¡¡ 
.
¡¡ 

LogWarning
¡¡ 
(
¡¡ 
$str¬¬ ç
,¬¬ç é
request
√√ 
.
√√ 
AffiliateId
√√ #
,
√√# $
channel
√√% ,
?
√√, -
.
√√- .

StatusCode
√√. 8
)
√√8 9
;
√√9 :
return
ƒƒ 
null
ƒƒ 
;
ƒƒ 
}
≈≈ 	
var
«« !
existingTransaction
«« 
=
««  !
await
»» $
_transactionRepository
»» (
.
»»( )6
(GetCoinPaymentTransactionByIdTransaction
»») Q
(
»»Q R
channel
»»R Y
.
»»Y Z
Data
»»Z ^
!
»»^ _
.
»»_ `
Id
»»` b
.
»»b c
ToString
»»c k
(
»»k l
)
»»l m
,
»»m n
_brandService
…… 
.
…… 
BrandId
…… %
)
……% &
;
……& '
_logger
   
.
   
LogInformation
   
(
   
$str
   [
,
  [ \
channel
  ] d
.
  d e
Data
  e i
!
  i j
.
  j k
Id
  k m
)
  m n
;
  n o
var
ÃÃ  
paymentTransaction
ÃÃ 
=
ÃÃ  
new
ÃÃ! $$
CoinpaymentTransaction
ÃÃ% ;
{
ÕÕ 	
IdTransaction
ŒŒ 
=
ŒŒ 
channel
ŒŒ #
.
ŒŒ# $
Data
ŒŒ$ (
.
ŒŒ( )
Id
ŒŒ) +
.
ŒŒ+ ,
ToString
ŒŒ, 4
(
ŒŒ4 5
)
ŒŒ5 6
,
ŒŒ6 7
AffiliateId
œœ 
=
œœ 
request
œœ !
.
œœ! "
AffiliateId
œœ" -
,
œœ- .
Amount
–– 
=
–– 
request
–– 
.
–– 
Amount
–– #
,
––# $
AmountReceived
—— 
=
—— 
	Constants
—— &
.
——& '

EmptyValue
——' 1
,
——1 2
Products
““ 
=
““ 
JsonSerializer
““ %
.
““% &
	Serialize
““& /
(
““/ 0
request
““0 7
.
““7 8
Products
““8 @
)
““@ A
,
““A B
	Acredited
”” 
=
”” 
false
”” 
,
”” 
Status
‘‘ 
=
‘‘ 
	Constants
‘‘ 
.
‘‘ 

EmptyValue
‘‘ )
,
‘‘) *
PaymentMethod
’’ 
=
’’ 
	Constants
’’ %
.
’’% &
CoinPay
’’& -
,
’’- .
	CreatedAt
÷÷ 
=
÷÷ 
today
÷÷ 
,
÷÷ 
	UpdatedAt
◊◊ 
=
◊◊ 
today
◊◊ 
,
◊◊ 
	Reference
ÿÿ 
=
ÿÿ 
channelRequest
ÿÿ &
.
ÿÿ& '&
IdExternalIdentification
ÿÿ' ?
.
ÿÿ? @
ToString
ÿÿ@ H
(
ÿÿH I
)
ÿÿI J
,
ÿÿJ K
BrandId
ŸŸ 
=
ŸŸ 
_brandService
ŸŸ %
.
ŸŸ% &
BrandId
ŸŸ& -
}
⁄⁄ 	
;
⁄⁄	 

if
‹‹ 

(
‹‹ !
existingTransaction
‹‹ 
!=
‹‹  "
null
‹‹# '
&&
‹‹( *
!
‹‹+ ,!
existingTransaction
‹‹, ?
.
‹‹? @
	Acredited
‹‹@ I
)
‹‹I J
{
›› 	
_logger
ﬁﬁ 
.
ﬁﬁ 
LogInformation
ﬁﬁ "
(
ﬁﬁ" #
$str
ﬁﬁ# v
,
ﬁﬁv w!
existingTransaction
ﬂﬂ #
.
ﬂﬂ# $
IdTransaction
ﬂﬂ$ 1
)
ﬂﬂ1 2
;
ﬂﬂ2 3!
existingTransaction
‡‡ 
.
‡‡  
Amount
‡‡  &
=
‡‡' (
request
‡‡) 0
.
‡‡0 1
Amount
‡‡1 7
;
‡‡7 8!
existingTransaction
·· 
.
··  
Products
··  (
=
··) *
JsonSerializer
··+ 9
.
··9 :
	Serialize
··: C
(
··C D
request
··D K
.
··K L
Products
··L T
)
··T U
;
··U V!
existingTransaction
‚‚ 
.
‚‚  
	UpdatedAt
‚‚  )
=
‚‚* +
today
‚‚, 1
;
‚‚1 2!
transactionResponse
„„ 
=
„„  !
await
„„" '$
_transactionRepository
„„( >
.
„„> ?/
!UpdateCoinPaymentTransactionAsync
„„? `
(
„„` a!
existingTransaction
„„a t
)
„„t u
;
„„u v
}
‰‰ 	
else
ÂÂ 
{
ÊÊ 	
_logger
ÁÁ 
.
ÁÁ 
LogInformation
ÁÁ "
(
ÁÁ" #
$str
ÁÁ# r
,
ÁÁr s 
paymentTransaction
ËË "
.
ËË" #
IdTransaction
ËË# 0
)
ËË0 1
;
ËË1 2!
transactionResponse
ÈÈ 
=
ÈÈ  !
await
ÈÈ" '$
_transactionRepository
ÈÈ( >
.
ÈÈ> ?*
CreateCoinPaymentTransaction
ÈÈ? [
(
ÈÈ[ \ 
paymentTransaction
ÈÈ\ n
)
ÈÈn o
;
ÈÈo p
}
ÍÍ 	
if
ÏÏ 

(
ÏÏ !
transactionResponse
ÏÏ 
==
ÏÏ  "
null
ÏÏ# '
)
ÏÏ' (
{
ÌÌ 	
_logger
ÓÓ 
.
ÓÓ 
LogError
ÓÓ 
(
ÓÓ 
$str
ÓÓ c
,
ÓÓc d
request
ÔÔ 
.
ÔÔ 
AffiliateId
ÔÔ #
)
ÔÔ# $
;
ÔÔ$ %
return
 
null
 
;
 
}
ÒÒ 	
_logger
ÛÛ 
.
ÛÛ 
LogInformation
ÛÛ 
(
ÛÛ 
$str
ÙÙ o
,
ÙÙo p
request
ıı 
.
ıı 
AffiliateId
ıı 
)
ıı  
;
ıı  !
return
ˆˆ 
channel
ˆˆ 
;
ˆˆ 
}
˜˜ 
public
˘˘ 

async
˘˘ 
Task
˘˘ 
<
˘˘  
GetNetworkResponse
˘˘ (
?
˘˘( )
>
˘˘) *%
GetNetworksByIdCurrency
˘˘+ B
(
˘˘B C
int
˘˘C F

idCurrency
˘˘G Q
)
˘˘Q R
{
˙˙ 
var
˚˚ 
result
˚˚ 
=
˚˚ 
await
˚˚ 
_coinPayAdapter
˚˚ *
.
˚˚* +%
GetNetworksByIdCurrency
˚˚+ B
(
˚˚B C

idCurrency
˚˚C M
)
˚˚M N
;
˚˚N O
if
˝˝ 

(
˝˝ 
result
˝˝ 
.
˝˝ 
Content
˝˝ 
is
˝˝ 
null
˝˝ "
)
˝˝" #
return
˛˛ 
null
˛˛ 
;
˛˛ 
var
ÄÄ 
networkResult
ÄÄ 
=
ÄÄ 
result
ÄÄ "
.
ÄÄ" #
Content
ÄÄ# *
.
ÄÄ* +
ToJsonObject
ÄÄ+ 7
<
ÄÄ7 8 
GetNetworkResponse
ÄÄ8 J
>
ÄÄJ K
(
ÄÄK L
)
ÄÄL M
;
ÄÄM N
return
ÇÇ 
networkResult
ÇÇ 
;
ÇÇ 
}
ÉÉ 
public
ÖÖ 

async
ÖÖ 
Task
ÖÖ 
<
ÖÖ #
CreateAddressResponse
ÖÖ +
?
ÖÖ+ ,
>
ÖÖ, -
CreateAddress
ÖÖ. ;
(
ÖÖ; <!
CreateAddresRequest
ÖÖ< O
request
ÖÖP W
)
ÖÖW X
{
ÜÜ 
var
áá 
result
áá 
=
áá 
await
áá 
_coinPayAdapter
áá *
.
áá* +
CreateAddress
áá+ 8
(
áá8 9
	Constants
áá9 B
.
ááB C
CoinPayIdWallet
ááC R
,
ááR S
request
ááT [
)
áá[ \
;
áá\ ]
if
ââ 

(
ââ 
result
ââ 
.
ââ 
Content
ââ 
is
ââ 
null
ââ "
)
ââ" #
return
ää 
null
ää 
;
ää 
var
åå 
address
åå 
=
åå 
result
åå 
.
åå 
Content
åå $
.
åå$ %
ToJsonObject
åå% 1
<
åå1 2#
CreateAddressResponse
åå2 G
>
ååG H
(
ååH I
)
ååI J
;
ååJ K
if
éé 

(
éé 
address
éé 
is
éé 
null
éé 
)
éé 
return
èè 
null
èè 
;
èè 
return
ëë 
address
ëë 
;
ëë 
}
íí 
public
îî 

async
îî 
Task
îî 
<
îî (
GetTransactionByIdResponse
îî 0
?
îî0 1
>
îî1 2 
GetTransactionById
îî3 E
(
îîE F
int
îîF I
idTransaction
îîJ W
)
îîW X
{
ïï 
var
ññ 
result
ññ 
=
ññ 
await
ññ 
_coinPayAdapter
ññ *
.
ññ* + 
GetTransactionById
ññ+ =
(
ññ= >
idTransaction
ññ> K
)
ññK L
;
ññL M
if
òò 

(
òò 
result
òò 
.
òò 
Content
òò 
is
òò 
null
òò "
)
òò" #
return
ôô 
null
ôô 
;
ôô 
var
õõ 
transaction
õõ 
=
õõ 
result
õõ  
.
õõ  !
Content
õõ! (
.
õõ( )
ToJsonObject
õõ) 5
<
õõ5 6(
GetTransactionByIdResponse
õõ6 P
>
õõP Q
(
õõQ R
)
õõR S
;
õõS T
return
ùù 
transaction
ùù 
;
ùù 
}
ûû 
public
†† 

async
†† 
Task
†† 
<
†† 
bool
†† 
>
†† )
ReceiveCoinPayNotifications
†† 7
(
††7 8
string
††8 >
requestBody
††? J
)
††J K
{
°° 
_logger
¢¢ 
.
¢¢ 
LogInformation
¢¢ 
(
¢¢ 
$"
¢¢ !
$str¢¢! É
{¢¢É Ñ
requestBody¢¢Ñ è
.¢¢è ê
ToJsonString¢¢ê ú
(¢¢ú ù
)¢¢ù û
}¢¢û ü
"¢¢ü †
)¢¢† °
;¢¢° ¢
if
§§ 

(
§§ 
string
§§ 
.
§§ 
IsNullOrEmpty
§§  
(
§§  !
requestBody
§§! ,
)
§§, -
)
§§- .
{
•• 	
_logger
¶¶ 
.
¶¶ 

LogWarning
¶¶ 
(
¶¶ 
$"
¶¶ !
$str
¶¶! i
"
¶¶i j
)
¶¶j k
;
¶¶k l
return
ßß 
false
ßß 
;
ßß 
}
®® 	
var
™™ 
request
™™ 
=
™™ 
JsonConvert
™™ !
.
™™! "
DeserializeObject
™™" 3
<
™™3 4(
WebhookNotificationRequest
™™4 N
>
™™N O
(
™™O P
requestBody
™™P [
)
™™[ \
;
™™\ ]
_logger
´´ 
.
´´ 
LogDebug
´´ 
(
´´ 
$"
¨¨ 
$str
¨¨ S
{
¨¨S T
request
¨¨T [
!
¨¨[ \
.
¨¨\ ]
ToJsonString
¨¨] i
(
¨¨i j
)
¨¨j k
}
¨¨k l
"
¨¨l m
)
¨¨m n
;
¨¨n o
if
ÆÆ 

(
ÆÆ 
request
ÆÆ 
is
ÆÆ 
null
ÆÆ 
)
ÆÆ 
return
ØØ 
false
ØØ 
;
ØØ 
if
≤≤ 

(
≤≤ 
request
≤≤ 
.
≤≤ 
UserChannel
≤≤ 
?
≤≤  
.
≤≤  !&
IdExternalIdentification
≤≤! 9
is
≤≤: <
null
≤≤= A
)
≤≤A B
{
≥≥ 	
_logger
¥¥ 
.
¥¥ 

LogWarning
¥¥ 
(
¥¥ 
$str
µµ z
)
µµz {
;
µµ{ |
return
∂∂ 
false
∂∂ 
;
∂∂ 
}
∑∑ 	
var
ππ !
existingTransaction
ππ 
=
ππ  !
await
∫∫ $
_transactionRepository
∫∫ (
.
∫∫( )'
GetTransactionByReference
∫∫) B
(
∫∫B C
request
∫∫C J
.
∫∫J K
UserChannel
∫∫K V
.
∫∫V W&
IdExternalIdentification
∫∫W o
)
∫∫o p
;
∫∫p q
if
ºº 

(
ºº !
existingTransaction
ºº 
is
ºº  "
null
ºº# '
)
ºº' (
{
ΩΩ 	
_logger
ææ 
.
ææ 

LogWarning
ææ 
(
ææ 
$"
øø 
$str
øø 
{øø Ä
requestøøÄ á
.øøá à
UserChanneløøà ì
.øøì î(
IdExternalIdentificationøøî ¨
}øø¨ ≠
"øø≠ Æ
)øøÆ Ø
;øøØ ∞
return
¿¿ 
false
¿¿ 
;
¿¿ 
}
¡¡ 	
if
√√ 

(
√√ 
request
√√ 
.
√√ 
Amount
√√ 
<
√√ !
existingTransaction
√√ 0
.
√√0 1
Amount
√√1 7
)
√√7 8
{
ƒƒ 	
_logger
≈≈ 
.
≈≈ 

LogWarning
≈≈ 
(
≈≈ 
$"
∆∆ 
$str
∆∆ q
{
∆∆q r
request
∆∆r y
.
∆∆y z
Amount∆∆z Ä
}∆∆Ä Å
$str∆∆Å †
{∆∆† °#
existingTransaction∆∆° ¥
.∆∆¥ µ
Amount∆∆µ ª
}∆∆ª º
"∆∆º Ω
)∆∆Ω æ
;∆∆æ ø
return
«« 
false
«« 
;
«« 
}
»» 	
_logger
   
.
   
LogInformation
   
(
   
$"
ÀÀ 
$str
ÀÀ d
{
ÀÀd e!
existingTransaction
ÀÀe x
.
ÀÀx y
Status
ÀÀy 
}ÀÀ Ä
$strÀÀÄ ç
{ÀÀç é#
existingTransactionÀÀé °
.ÀÀ° ¢
	AcreditedÀÀ¢ ´
}ÀÀ´ ¨
"ÀÀ¨ ≠
)ÀÀ≠ Æ
;ÀÀÆ Ø
if
ÕÕ 

(
ÕÕ !
existingTransaction
ÕÕ 
.
ÕÕ  
	Acredited
ÕÕ  )
||
ÕÕ* ,!
existingTransaction
ÕÕ- @
.
ÕÕ@ A
Status
ÕÕA G
==
ÕÕH J
	Constants
ÕÕK T
.
ÕÕT U!
CompletedStatusCode
ÕÕU h
)
ÕÕh i
{
ŒŒ 	
_logger
œœ 
.
œœ 
LogInformation
œœ "
(
œœ" #
$"
–– 
$str
–– y
{
––y z"
existingTransaction––z ç
.––ç é
Status––é î
}––î ï
$str––ï ¢
{––¢ £#
existingTransaction––£ ∂
.––∂ ∑
	Reference––∑ ¿
}––¿ ¡
"––¡ ¬
)––¬ √
;––√ ƒ
return
—— 
false
—— 
;
—— 
}
““ 	
switch
‘‘ 
(
‘‘ 
request
‘‘ 
.
‘‘ 
TransactionStatus
‘‘ )
.
‘‘) *
Id
‘‘* ,
)
‘‘, -
{
’’ 	
case
÷÷ 
	Constants
÷÷ 
.
÷÷ &
CoinPayPendingStatusCode
÷÷ 3
:
÷÷3 4!
existingTransaction
◊◊ #
.
◊◊# $
Status
◊◊$ *
=
◊◊+ ,
	Constants
◊◊- 6
.
◊◊6 7"
RegisteredStatusCode
◊◊7 K
;
◊◊K L!
existingTransaction
ÿÿ #
.
ÿÿ# $
	Acredited
ÿÿ$ -
=
ÿÿ. /
false
ÿÿ0 5
;
ÿÿ5 6!
existingTransaction
ŸŸ #
.
ŸŸ# $
IdTransaction
ŸŸ$ 1
=
ŸŸ2 3
request
ŸŸ4 ;
.
ŸŸ; <
IdTransaction
ŸŸ< I
.
ŸŸI J
ToString
ŸŸJ R
(
ŸŸR S
)
ŸŸS T
;
ŸŸT U
_logger
⁄⁄ 
.
⁄⁄ 
LogInformation
⁄⁄ &
(
⁄⁄& '
$"
€€ 
$str
€€ y
{
€€y z"
existingTransaction€€z ç
.€€ç é
	Reference€€é ó
}€€ó ò
"€€ò ô
)€€ô ö
;€€ö õ
break
‹‹ 
;
‹‹ 
case
ﬁﬁ 
	Constants
ﬁﬁ 
.
ﬁﬁ &
CoinPayExpiredStatusCode
ﬁﬁ 3
:
ﬁﬁ3 4!
existingTransaction
ﬂﬂ #
.
ﬂﬂ# $
Status
ﬂﬂ$ *
=
ﬂﬂ+ ,
	Constants
ﬂﬂ- 6
.
ﬂﬂ6 7
ExpiredStatusCode
ﬂﬂ7 H
;
ﬂﬂH I!
existingTransaction
‡‡ #
.
‡‡# $
	Acredited
‡‡$ -
=
‡‡. /
false
‡‡0 5
;
‡‡5 6
_logger
·· 
.
·· 
LogInformation
·· &
(
··& '
$"
‚‚ 
$str
‚‚ r
{
‚‚r s"
existingTransaction‚‚s Ü
.‚‚Ü á
	Reference‚‚á ê
}‚‚ê ë
"‚‚ë í
)‚‚í ì
;‚‚ì î
break
„„ 
;
„„ 
case
ÂÂ 
	Constants
ÂÂ 
.
ÂÂ &
CoinPaySuccessStatusCode
ÂÂ 3
:
ÂÂ3 4!
existingTransaction
ÊÊ #
.
ÊÊ# $
Status
ÊÊ$ *
=
ÊÊ+ ,
	Constants
ÊÊ- 6
.
ÊÊ6 7!
CompletedStatusCode
ÊÊ7 J
;
ÊÊJ K!
existingTransaction
ÁÁ #
.
ÁÁ# $
AmountReceived
ÁÁ$ 2
=
ÁÁ3 4
request
ÁÁ5 <
.
ÁÁ< =
Amount
ÁÁ= C
;
ÁÁC D!
existingTransaction
ËË #
.
ËË# $
	Acredited
ËË$ -
=
ËË. /
true
ËË0 4
;
ËË4 5!
existingTransaction
ÈÈ #
.
ÈÈ# $
IdTransaction
ÈÈ$ 1
=
ÈÈ2 3
request
ÈÈ4 ;
.
ÈÈ; <
IdTransaction
ÈÈ< I
.
ÈÈI J
ToString
ÈÈJ R
(
ÈÈR S
)
ÈÈS T
;
ÈÈT U
_logger
ÎÎ 
.
ÎÎ 
LogInformation
ÎÎ &
(
ÎÎ& '
$"
ÏÏ 
$str
ÏÏ r
{
ÏÏr s
request
ÏÏs z
.
ÏÏz {
AmountÏÏ{ Å
}ÏÏÅ Ç
$strÏÏÇ ê
{ÏÏê ë#
existingTransactionÏÏë §
.ÏÏ§ •
	ReferenceÏÏ• Æ
}ÏÏÆ Ø
"ÏÏØ ∞
)ÏÏ∞ ±
;ÏÏ± ≤
await
ÌÌ '
ProcessPaymentTransaction
ÌÌ /
(
ÌÌ/ 0!
existingTransaction
ÌÌ0 C
)
ÌÌC D
;
ÌÌD E
_logger
ÓÓ 
.
ÓÓ 
LogInformation
ÓÓ &
(
ÓÓ& '
$"
ÔÔ 
$str
ÔÔ q
{
ÔÔq r"
existingTransactionÔÔr Ö
.ÔÔÖ Ü
	ReferenceÔÔÜ è
}ÔÔè ê
"ÔÔê ë
)ÔÔë í
;ÔÔí ì
break
 
;
 
default
ÚÚ 
:
ÚÚ 
_logger
ÛÛ 
.
ÛÛ 

LogWarning
ÛÛ "
(
ÛÛ" #
$"
ÙÙ 
$str
ÙÙ f
{
ÙÙf g
request
ÙÙg n
.
ÙÙn o 
TransactionStatusÙÙo Ä
.ÙÙÄ Å
IdÙÙÅ É
}ÙÙÉ Ñ
"ÙÙÑ Ö
)ÙÙÖ Ü
;ÙÙÜ á
break
ıı 
;
ıı 
}
ˆˆ 	
await
¯¯ $
_transactionRepository
¯¯ $
.
¯¯$ %/
!UpdateCoinPaymentTransactionAsync
¯¯% F
(
¯¯F G!
existingTransaction
¯¯G Z
)
¯¯Z [
;
¯¯[ \
_logger
˘˘ 
.
˘˘ 
LogInformation
˘˘ 
(
˘˘ 
$"
˙˙ 
$str
˙˙ w
{
˙˙w x"
existingTransaction˙˙x ã
.˙˙ã å
	Reference˙˙å ï
}˙˙ï ñ
"˙˙ñ ó
)˙˙ó ò
;˙˙ò ô
return
¸¸ 
true
¸¸ 
;
¸¸ 
}
˝˝ 
public
ˇˇ 

async
ˇˇ 
Task
ˇˇ 
<
ˇˇ 
SendFundsDto
ˇˇ "
?
ˇˇ" #
>
ˇˇ# $
	SendFunds
ˇˇ% .
(
ˇˇ. /
WithDrawalRequest
ˇˇ/ @
[
ˇˇ@ A
]
ˇˇA B
requests
ˇˇC K
)
ˇˇK L
{
ÄÄ 
_logger
ÅÅ 
.
ÅÅ 
LogInformation
ÅÅ 
(
ÅÅ 
$"
ÇÇ 
$str
ÇÇ >
{
ÇÇ> ?
requests
ÇÇ? G
.
ÇÇG H
Length
ÇÇH N
}
ÇÇN O
$str
ÇÇO d
"
ÇÇd e
)
ÇÇe f
;
ÇÇf g
if
ÑÑ 

(
ÑÑ 
requests
ÑÑ 
.
ÑÑ 
Length
ÑÑ 
==
ÑÑ 
$num
ÑÑ  
)
ÑÑ  !
{
ÖÖ 	
_logger
ÜÜ 
.
ÜÜ 
LogInformation
ÜÜ "
(
ÜÜ" #
$"
ÜÜ# %
$str
ÜÜ% f
"
ÜÜf g
)
ÜÜg h
;
ÜÜh i
return
áá 
new
áá 
SendFundsDto
áá #
(
áá# $
)
áá$ %
;
áá% &
}
àà 	
var
ää 
response
ää 
=
ää 
new
ää 
SendFundsDto
ää '
(
ää' (
)
ää( )
;
ää) *
var
ãã 
successfulIds
ãã 
=
ãã 
new
ãã 
List
ãã  $
<
ãã$ %
long
ãã% )
>
ãã) *
(
ãã* +
)
ãã+ ,
;
ãã, -
foreach
çç 
(
çç 
var
çç 
request
çç 
in
çç 
requests
çç  (
)
çç( )
{
éé 	
_logger
èè 
.
èè 
LogInformation
èè "
(
èè" #
$"
êê 
$str
êê T
{
êêT U
request
êêU \
.
êê\ ]
ToJsonString
êê] i
(
êêi j
)
êêj k
}
êêk l
"
êêl m
)
êêm n
;
êên o
try
íí 
{
ìì 
var
îî  
withdrawalResponse
îî &
=
îî' (
await
îî) .
ProcessWithdrawal
îî/ @
(
îî@ A
request
îîA H
)
îîH I
;
îîI J
if
ññ 
(
ññ  
withdrawalResponse
ññ &
.
ññ& '

StatusCode
ññ' 1
==
ññ2 4
$num
ññ5 6
)
ññ6 7
{
óó 
_logger
òò 
.
òò 
LogInformation
òò *
(
òò* +
$"
ôô 
$str
ôô g
{
ôôg h
request
ôôh o
.
ôôo p
Id
ôôp r
}
ôôr s
"
ôôs t
)
ôôt u
;
ôôu v
response
öö 
.
öö !
SuccessfulResponses
öö 0
.
öö0 1
Add
öö1 4
(
öö4 5 
withdrawalResponse
öö5 G
)
ööG H
;
ööH I
successfulIds
õõ !
.
õõ! "
Add
õõ" %
(
õõ% &
request
õõ& -
.
õõ- .
Id
õõ. 0
)
õõ0 1
;
õõ1 2
}
úú 
else
ùù 
{
ûû 
_logger
üü 
.
üü 
LogInformation
üü *
(
üü* +
$"
†† 
$str
†† c
{
††c d
request
††d k
.
††k l
Id
††l n
}
††n o
"
††o p
)
††p q
;
††q r
response
°° 
.
°° 
FailedResponses
°° ,
.
°°, -
Add
°°- 0
(
°°0 1 
withdrawalResponse
°°1 C
)
°°C D
;
°°D E
}
¢¢ 
}
££ 
catch
§§ 
(
§§ 
	Exception
§§ 
ex
§§ 
)
§§  
{
•• 
_logger
¶¶ 
.
¶¶ 
LogError
¶¶  
(
¶¶  !
$"
ßß 
$str
ßß a
{
ßßa b
request
ßßb i
.
ßßi j
Id
ßßj l
}
ßßl m
$str
ßßm z
{
ßßz {
ex
ßß{ }
}
ßß} ~
"
ßß~ 
)ßß Ä
;ßßÄ Å
}
®® 
}
©© 	
if
´´ 

(
´´ 
successfulIds
´´ 
.
´´ 
Count
´´ 
!=
´´  "
	Constants
´´# ,
.
´´, -

EmptyValue
´´- 7
)
´´7 8
{
¨¨ 	
await
≠≠ )
UpdateSuccessfulWithdrawals
≠≠ -
(
≠≠- .
successfulIds
≠≠. ;
)
≠≠; <
;
≠≠< =
_logger
ÆÆ 
.
ÆÆ 
LogInformation
ÆÆ "
(
ÆÆ" #
$"
ØØ 
$str
ØØ b
{
ØØb c
string
ØØc i
.
ØØi j
Join
ØØj n
(
ØØn o
$str
ØØo s
,
ØØs t
successfulIdsØØu Ç
)ØØÇ É
}ØØÉ Ñ
"ØØÑ Ö
)ØØÖ Ü
;ØØÜ á
}
∞∞ 	
_logger
≤≤ 
.
≤≤ 
LogInformation
≤≤ 
(
≤≤ 
$"
≤≤ !
$str
≤≤! i
"
≤≤i j
)
≤≤j k
;
≤≤k l
return
¥¥ 
response
¥¥ 
;
¥¥ 
}
µµ 
private
∑∑ 
async
∑∑ 
Task
∑∑ 
<
∑∑ 
SendFundsResponse
∑∑ (
>
∑∑( )
ProcessWithdrawal
∑∑* ;
(
∑∑; <
WithDrawalRequest
∑∑< M
request
∑∑N U
)
∑∑U V
{
∏∏ 
_logger
ππ 
.
ππ 
LogInformation
ππ 
(
ππ 
$"
∫∫ 
$str
∫∫ [
{
∫∫[ \
request
∫∫\ c
.
∫∫c d
AffiliateId
∫∫d o
}
∫∫o p
"
∫∫p q
)
∫∫q r
;
∫∫r s
var
ºº 
user
ºº 
=
ºº 
await
ºº $
_accountServiceAdapter
ºº /
.
ºº/ 0
GetUserInfo
ºº0 ;
(
ºº; <
request
ºº< C
.
ººC D
AffiliateId
ººD O
,
ººO P
_brandService
ººQ ^
.
ºº^ _
BrandId
ºº_ f
)
ººf g
;
ººg h
var
ΩΩ 
trcResponse
ΩΩ 
=
ΩΩ 
await
ææ $
_accountServiceAdapter
ææ (
.
ææ( )*
GetAffiliateBtcByAffiliateId
ææ) E
(
ææE F
request
ææF M
.
ææM N
AffiliateId
ææN Y
,
ææY Z
_brandService
ææ[ h
.
ææh i
BrandId
ææi p
)
ææp q
;
ææq r 
TrcAddressResponse
¿¿ 
?
¿¿ 
userTrcAddress
¿¿ *
=
¿¿+ ,
null
¿¿- 1
;
¿¿1 2
_logger
¬¬ 
.
¬¬ 
LogInformation
¬¬ 
(
¬¬ 
$"
√√ 
$str
√√ ]
{
√√] ^
request
√√^ e
.
√√e f
AffiliateId
√√f q
}
√√q r
"
√√r s
)
√√s t
;
√√t u
var
≈≈ !
deserializeResponse
≈≈ 
=
≈≈  !
JsonConvert
≈≈" -
.
≈≈- .
DeserializeObject
≈≈. ?
<
≈≈? @
ServicesResponse
≈≈@ P
>
≈≈P Q
(
≈≈Q R
trcResponse
≈≈R ]
.
≈≈] ^
Content
≈≈^ e
!
≈≈e f
)
≈≈f g
;
≈≈g h
if
∆∆ 

(
∆∆ !
deserializeResponse
∆∆ 
!
∆∆  
.
∆∆  !
Data
∆∆! %
!=
∆∆& (
null
∆∆) -
)
∆∆- .
{
«« 	
var
»» 
addressArray
»» 
=
»» 
JsonConvert
»» *
.
»»* +
DeserializeObject
»»+ <
<
»»< = 
TrcAddressResponse
»»= O
[
»»O P
]
»»P Q
>
»»Q R
(
»»R S!
deserializeResponse
»»S f
.
»»f g
Data
»»g k
.
»»k l
ToString
»»l t
(
»»t u
)
»»u v
!
»»v w
)
»»w x
;
»»x y
userTrcAddress
…… 
=
…… 
addressArray
…… )
?
……) *
.
……* +
FirstOrDefault
……+ 9
(
……9 :
x
……: ;
=>
……< >
x
……? @
!=
……A C
null
……D H
)
……H I
;
……I J
_logger
   
.
   
LogInformation
   "
(
  " #
$"
ÀÀ 
$str
ÀÀ q
{
ÀÀq r
request
ÀÀr y
.
ÀÀy z
AffiliateIdÀÀz Ö
}ÀÀÖ Ü
"ÀÀÜ á
)ÀÀá à
;ÀÀà â
}
ÃÃ 	
if
ŒŒ 

(
ŒŒ 
user
ŒŒ 
==
ŒŒ 
null
ŒŒ 
)
ŒŒ 
{
œœ 	
_logger
–– 
.
–– 

LogWarning
–– 
(
–– 
$"
—— 
$str
—— Z
{
——Z [
request
——[ b
.
——b c
AffiliateId
——c n
}
——n o
"
——o p
)
——p q
;
——q r
return
““ 
new
““ 
SendFundsResponse
““ (
{
”” 

StatusCode
‘‘ 
=
‘‘ 
(
‘‘ 
int
‘‘ !
)
‘‘! "
HttpStatusCode
‘‘" 0
.
‘‘0 1
NotFound
‘‘1 9
,
‘‘9 :
Message
’’ 
=
’’ 
$str
’’ *
}
÷÷ 
;
÷÷ 
}
◊◊ 	
if
ŸŸ 

(
ŸŸ 
userTrcAddress
ŸŸ 
==
ŸŸ 
null
ŸŸ "
)
ŸŸ" #
{
⁄⁄ 	
_logger
€€ 
.
€€ 

LogWarning
€€ 
(
€€ 
$"
‹‹ 
$str
‹‹ f
{
‹‹f g
request
‹‹g n
.
‹‹n o
AffiliateId
‹‹o z
}
‹‹z {
"
‹‹{ |
)
‹‹| }
;
‹‹} ~
return
›› 
new
›› 
SendFundsResponse
›› (
{
ﬁﬁ 

StatusCode
ﬂﬂ 
=
ﬂﬂ 
(
ﬂﬂ 
int
ﬂﬂ !
)
ﬂﬂ! "
HttpStatusCode
ﬂﬂ" 0
.
ﬂﬂ0 1

BadRequest
ﬂﬂ1 ;
,
ﬂﬂ; <
Message
‡‡ 
=
‡‡ 
$str
‡‡ 2
}
·· 
;
·· 
}
‚‚ 	
var
‰‰ 
sendFundsRequest
‰‰ 
=
‰‰ 
new
‰‰ "
SendFundRequest
‰‰# 2
{
ÂÂ 	

IdCurrency
ÊÊ 
=
ÊÊ 
	Constants
ÊÊ "
.
ÊÊ" #
UsdtIdCurrency
ÊÊ# 1
,
ÊÊ1 2
	IdNetwork
ÁÁ 
=
ÁÁ 
_brandService
ÁÁ %
.
ÁÁ% &
BrandId
ÁÁ& -
switch
ÁÁ. 4
{
ËË 
$num
ÈÈ 
=>
ÈÈ 
	Constants
ÈÈ 
.
ÈÈ 
UsdtIdNetwork
ÈÈ ,
,
ÈÈ, -
$num
ÍÍ 
=>
ÍÍ 
	Constants
ÍÍ 
.
ÍÍ 
BnbIdNetwork
ÍÍ +
,
ÍÍ+ ,
$num
ÎÎ 
=>
ÎÎ 
	Constants
ÎÎ 
.
ÎÎ 
BnbIdNetwork
ÎÎ +
,
ÎÎ+ ,
$num
ÏÏ 
=>
ÏÏ 
	Constants
ÏÏ 
.
ÏÏ 
BnbIdNetwork
ÏÏ +
,
ÏÏ+ ,
_
ÌÌ 
=>
ÌÌ 
	Constants
ÌÌ 
.
ÌÌ 
BnbIdNetwork
ÌÌ +
}
ÓÓ 
,
ÓÓ 
Address
ÔÔ 
=
ÔÔ 
userTrcAddress
ÔÔ $
.
ÔÔ$ %
Address
ÔÔ% ,
,
ÔÔ, -
Amount
 
=
 
request
 
.
 
Amount
 #
,
# $
Details
ÒÒ 
=
ÒÒ 
	Constants
ÒÒ 
.
ÒÒ  
SendFundsConcept
ÒÒ  0
,
ÒÒ0 1
AmountPlusFee
ÚÚ 
=
ÚÚ 
false
ÚÚ !
}
ÛÛ 	
;
ÛÛ	 

_logger
ıı 
.
ıı 
LogInformation
ıı 
(
ıı 
$"
ıı !
$str
ıı! h
{
ııh i
request
ııi p
.
ııp q
AffiliateId
ııq |
}
ıı| }
"
ıı} ~
)
ıı~ 
;ıı Ä
var
˜˜ 
response
˜˜ 
=
˜˜ 
await
˜˜ 
_coinPayAdapter
˜˜ ,
.
˜˜, -
	SendFunds
˜˜- 6
(
˜˜6 7
sendFundsRequest
˜˜7 G
)
˜˜G H
;
˜˜H I
if
¯¯ 

(
¯¯ 
response
¯¯ 
is
¯¯ 
{
¯¯ 
IsSuccessful
¯¯ &
:
¯¯& '
true
¯¯( ,
,
¯¯, -
Content
¯¯. 5
:
¯¯5 6
not
¯¯7 :
null
¯¯; ?
}
¯¯@ A
)
¯¯A B
{
˘˘ 	
var
˙˙ 
servicesResponse
˙˙  
=
˙˙! "
JsonConvert
˙˙# .
.
˙˙. /
DeserializeObject
˙˙/ @
<
˙˙@ A
SendFundsResponse
˙˙A R
>
˙˙R S
(
˙˙S T
response
˙˙T \
.
˙˙\ ]
Content
˙˙] d
)
˙˙d e
;
˙˙e f
var
˚˚ 
today
˚˚ 
=
˚˚ 
DateTime
˚˚  
.
˚˚  !
Now
˚˚! $
;
˚˚$ %
var
¸¸ 
walletWithdrawal
¸¸  
=
¸¸! "
new
¸¸# &%
WalletWithDrawalRequest
¸¸' >
{
˝˝ 
AffiliateId
˛˛ 
=
˛˛ 
user
˛˛ "
.
˛˛" #
Id
˛˛# %
,
˛˛% &
AffiliateUserName
ˇˇ !
=
ˇˇ" #
user
ˇˇ$ (
.
ˇˇ( )
UserName
ˇˇ) 1
!
ˇˇ1 2
,
ˇˇ2 3
Amount
ÄÄ 
=
ÄÄ 
sendFundsRequest
ÄÄ )
.
ÄÄ) *
Amount
ÄÄ* 0
,
ÄÄ0 1
IsProcessed
ÅÅ 
=
ÅÅ 
true
ÅÅ "
,
ÅÅ" #
Observation
ÇÇ 
=
ÇÇ 
$"
ÇÇ  
{
ÇÇ  !
	Constants
ÇÇ! *
.
ÇÇ* +
SendFundsConcept
ÇÇ+ ;
}
ÇÇ; <
$str
ÇÇ< =
{
ÇÇ= >
request
ÇÇ> E
.
ÇÇE F
Id
ÇÇF H
}
ÇÇH I
"
ÇÇI J
,
ÇÇJ K
AdminObservation
ÉÉ  
=
ÉÉ! "
$"
ÑÑ 
{
ÑÑ 
servicesResponse
ÑÑ '
?
ÑÑ' (
.
ÑÑ( )
Data
ÑÑ) -
?
ÑÑ- .
.
ÑÑ. /
IdTransaction
ÑÑ/ <
}
ÑÑ< =
$str
ÑÑ= @
{
ÑÑ@ A
servicesResponse
ÑÑA Q
?
ÑÑQ R
.
ÑÑR S
Data
ÑÑS W
?
ÑÑW X
.
ÑÑX Y
Address
ÑÑY `
??
ÑÑa c
$str
ÑÑd p
}
ÑÑp q
"
ÑÑq r
,
ÑÑr s
Date
ÖÖ 
=
ÖÖ 
today
ÖÖ 
,
ÖÖ 
ResponseDate
ÜÜ 
=
ÜÜ 
today
ÜÜ $
,
ÜÜ$ %!
RetentionPercentage
áá #
=
áá$ %
	Constants
áá& /
.
áá/ 0

EmptyValue
áá0 :
,
áá: ;
Status
àà 
=
àà 
true
àà 
}
ââ 
;
ââ 
if
ãã 
(
ãã 
servicesResponse
ãã  
is
ãã! #
{
ãã$ %

StatusCode
ãã& 0
:
ãã0 1
$num
ãã2 3
}
ãã4 5
)
ãã5 6
{
åå 
_logger
çç 
.
çç 
LogInformation
çç &
(
çç& '
$"
çç' )
$str
çç) z
{
ççz {
requestçç{ Ç
.ççÇ É
AffiliateIdççÉ é
}ççé è
"ççè ê
)ççê ë
;ççë í
var
èè 
debitTransaction
èè $
=
èè% &
new
èè' *
Wallet
èè+ 1
{
êê 
AffiliateId
ëë 
=
ëë  !
request
ëë" )
.
ëë) *
AffiliateId
ëë* 5
,
ëë5 6
UserId
íí 
=
íí 
$num
íí 
,
íí 
Credit
ìì 
=
ìì 
$num
ìì 
,
ìì 
Debit
îî 
=
îî 
request
îî #
.
îî# $
Amount
îî$ *
,
îî* +
Deferred
ïï 
=
ïï 
$num
ïï  
,
ïï  !
Status
ññ 
=
ññ 
true
ññ !
,
ññ! "
Concept
óó 
=
óó 
	Constants
óó '
.
óó' (
SendFundsConcept
óó( 8
,
óó8 9
Support
òò 
=
òò 
$num
òò 
,
òò  
Date
ôô 
=
ôô 
today
ôô  
,
ôô  !
Compression
öö 
=
öö  !
true
öö" &
,
öö& '
Detail
õõ 
=
õõ 
$str
õõ :
,
õõ: ;
	CreatedAt
úú 
=
úú 
today
úú  %
,
úú% &
	UpdatedAt
ùù 
=
ùù 
today
ùù  %
,
ùù% &
AffiliateUserName
ûû %
=
ûû& '
user
ûû( ,
.
ûû, -
UserName
ûû- 5
!
ûû5 6
,
ûû6 7
AdminUserName
üü !
=
üü" #
_brandService
üü$ 1
.
üü1 2
BrandId
üü2 9
switch
üü: @
{
†† 
$num
°° 
=>
°° 
$str
°° -
,
°°- .
$num
¢¢ 
=>
¢¢ 
$str
¢¢ ,
,
¢¢, -
$num
££ 
=>
££ 
$str
££ -
,
££- .
$num
§§ 
=>
§§ 
$str
§§ /
,
§§/ 0
_
•• 
=>
•• 
$str
•• -
}
¶¶ 
,
¶¶ 
ConceptType
ßß 
=
ßß  !
WalletConceptType
ßß" 3
.
ßß3 4
balance_transfer
ßß4 D
.
ßßD E
ToString
ßßE M
(
ßßM N
)
ßßN O
,
ßßO P
BrandId
®® 
=
®® 
_brandService
®® +
.
®®+ ,
BrandId
®®, 3
,
®®3 4
}
©© 
;
©© 
try
´´ 
{
¨¨ 
await
≠≠ 
Task
≠≠ 
.
≠≠ 
WhenAll
≠≠ &
(
≠≠& '
_walletRepository
ÆÆ )
.
ÆÆ) *
CreateWalletAsync
ÆÆ* ;
(
ÆÆ; <
debitTransaction
ÆÆ< L
)
ÆÆL M
,
ÆÆM N&
_walletWithDrawalService
ØØ 0
.
ØØ0 1)
CreateWalletWithdrawalAsync
ØØ1 L
(
ØØL M
walletWithdrawal
ØØM ]
)
ØØ] ^
)
∞∞ 
;
∞∞ 
await
±± 
RemoveCacheKey
±± (
(
±±( )
request
±±) 0
.
±±0 1
AffiliateId
±±1 <
,
±±< =
	CacheKeys
±±> G
.
±±G H&
BalanceInformationModel2
±±H `
)
±±` a
;
±±a b
_logger
≥≥ 
.
≥≥ 
LogInformation
≥≥ *
(
≥≥* +
$"
¥¥ 
$str¥¥ â
{¥¥â ä
request¥¥ä ë
.¥¥ë í
AffiliateId¥¥í ù
}¥¥ù û
"¥¥û ü
)¥¥ü †
;¥¥† °
}
µµ 
catch
∂∂ 
(
∂∂ 
	Exception
∂∂  
ex
∂∂! #
)
∂∂# $
{
∑∑ 
_logger
∏∏ 
.
∏∏ 
LogError
∏∏ $
(
∏∏$ %
$"
∏∏% '
$str∏∏' Å
{∏∏Å Ç
request∏∏Ç â
.∏∏â ä
AffiliateId∏∏ä ï
}∏∏ï ñ
$str∏∏ñ ü
{∏∏ü †
ex∏∏† ¢
}∏∏¢ £
"∏∏£ §
)∏∏§ •
;∏∏• ¶
}
ππ 
return
ªª 
servicesResponse
ªª '
;
ªª' (
}
ºº 
else
ΩΩ 
{
ææ 
_logger
øø 
.
øø 

LogWarning
øø "
(
øø" #
$"
øø# %
$strøø% è
{øøè ê
requestøøê ó
.øøó ò
AffiliateIdøøò £
}øø£ §
$strøø§ •
{øø• ¶
responseøø¶ Æ
.øøÆ Ø
ToJsonStringøøØ ª
(øøª º
)øøº Ω
}øøΩ æ
"øøæ ø
)øøø ¿
;øø¿ ¡
return
¿¿ 
new
¿¿ 
SendFundsResponse
¿¿ ,
{
¡¡ 

StatusCode
¬¬ 
=
¬¬  
(
¬¬! "
int
¬¬" %
)
¬¬% &
response
¬¬& .
.
¬¬. /

StatusCode
¬¬/ 9
,
¬¬9 :
Message
√√ 
=
√√ 
$str
√√ a
}
ƒƒ 
;
ƒƒ 
}
≈≈ 
}
∆∆ 	
_logger
»» 
.
»» 

LogWarning
»» 
(
»» 
$"
»» 
$str
»» k
{
»»k l
request
»»l s
.
»»s t
AffiliateId
»»t 
}»» Ä
$str»»Ä Å
{»»Å Ç
response»»Ç ä
.»»ä ã
ToJsonString»»ã ó
(»»ó ò
)»»ò ô
}»»ô ö
"»»ö õ
)»»õ ú
;»»ú ù
return
…… 
new
…… 
SendFundsResponse
…… $
{
   	

StatusCode
ÀÀ 
=
ÀÀ 
(
ÀÀ 
int
ÀÀ 
)
ÀÀ 
response
ÀÀ &
.
ÀÀ& '

StatusCode
ÀÀ' 1
,
ÀÀ1 2
Message
ÃÃ 
=
ÃÃ 
$str
ÃÃ ,
}
ÕÕ 	
;
ÕÕ	 

}
ŒŒ 
private
–– 
async
–– 
Task
–– )
UpdateSuccessfulWithdrawals
–– 2
(
––2 3
List
––3 7
<
––7 8
long
––8 <
>
––< =%
successfulWithdrawalIds
––> U
)
––U V
{
—— 
_logger
““ 
.
““ 
LogInformation
““ 
(
““ 
$"
”” 
$str
”” R
{
””R S%
successfulWithdrawalIds
””S j
.
””j k
ToJsonString
””k w
(
””w x
)
””x y
}
””y z
$str””z í
"””í ì
)””ì î
;””î ï
var
‘‘ 
withdrawals
‘‘ 
=
‘‘ 
await
‘‘ &
_walletRequestRepository
‘‘  8
.
‘‘8 9$
GetWalletRequestsByIds
‘‘9 O
(
‘‘O P%
successfulWithdrawalIds
‘‘P g
)
‘‘g h
;
‘‘h i
foreach
÷÷ 
(
÷÷ 
var
÷÷ 

withdrawal
÷÷ 
in
÷÷  "
withdrawals
÷÷# .
)
÷÷. /
{
◊◊ 	
_logger
ÿÿ 
.
ÿÿ 
LogDebug
ÿÿ 
(
ÿÿ 
$"
ŸŸ 
$str
ŸŸ e
{
ŸŸe f

withdrawal
ŸŸf p
.
ŸŸp q
Id
ŸŸq s
}
ŸŸs t
"
ŸŸt u
)
ŸŸu v
;
ŸŸv w

withdrawal
⁄⁄ 
.
⁄⁄ 
Status
⁄⁄ 
=
⁄⁄ 
(
⁄⁄  !
int
⁄⁄! $
)
⁄⁄$ %
WithdrawalStatus
⁄⁄% 5
.
⁄⁄5 6
	Completed
⁄⁄6 ?
;
⁄⁄? @

withdrawal
€€ 
.
€€ 
	UpdatedAt
€€  
=
€€! "
DateTime
€€# +
.
€€+ ,
Now
€€, /
;
€€/ 0
}
‹‹ 	
await
ﬁﬁ &
_walletRequestRepository
ﬁﬁ &
.
ﬁﬁ& '+
UpdateBulkWalletRequestsAsync
ﬁﬁ' D
(
ﬁﬁD E
withdrawals
ﬁﬁE P
)
ﬁﬁP Q
;
ﬁﬁQ R
_logger
ﬂﬂ 
.
ﬂﬂ 
LogInformation
ﬂﬂ 
(
ﬂﬂ 
$"
ﬂﬂ !
$str
ﬂﬂ! r
"
ﬂﬂr s
)
ﬂﬂs t
;
ﬂﬂt u
}
‡‡ 
public
‚‚ 

async
‚‚ 
Task
‚‚ 
<
‚‚ 
bool
‚‚ 
>
‚‚ '
GetTransactionByReference
‚‚ 5
(
‚‚5 6
string
‚‚6 <
request
‚‚= D
)
‚‚D E
{
„„ 
if
‰‰ 

(
‰‰ 
string
‰‰ 
.
‰‰ 
IsNullOrEmpty
‰‰  
(
‰‰  !
request
‰‰! (
)
‰‰( )
)
‰‰) *
return
ÂÂ 
false
ÂÂ 
;
ÂÂ 
var
ÁÁ 
	reference
ÁÁ 
=
ÁÁ 
await
ÁÁ $
_transactionRepository
ÁÁ 4
.
ÁÁ4 5'
GetTransactionByReference
ÁÁ5 N
(
ÁÁN O
request
ÁÁO V
)
ÁÁV W
;
ÁÁW X
if
ÈÈ 

(
ÈÈ 
	reference
ÈÈ 
is
ÈÈ 
null
ÈÈ 
)
ÈÈ 
return
ÍÍ 
false
ÍÍ 
;
ÍÍ 
if
ÏÏ 

(
ÏÏ 
	reference
ÏÏ 
is
ÏÏ 
{
ÏÏ 
	Acredited
ÏÏ $
:
ÏÏ$ %
true
ÏÏ& *
,
ÏÏ* +
Status
ÏÏ, 2
:
ÏÏ2 3
	Constants
ÏÏ4 =
.
ÏÏ= >!
CompletedStatusCode
ÏÏ> Q
}
ÏÏR S
)
ÏÏS T
{
ÌÌ 	
return
ÓÓ 
true
ÓÓ 
;
ÓÓ 
}
ÔÔ 	
return
ÒÒ 
false
ÒÒ 
;
ÒÒ 
}
ÚÚ 
private
ÛÛ 
async
ÛÛ 
Task
ÛÛ 
RemoveCacheKey
ÛÛ %
(
ÛÛ% &
int
ÛÛ& )
affiliateId
ÛÛ* 5
,
ÛÛ5 6
string
ÛÛ7 =
	stringKey
ÛÛ> G
)
ÛÛG H
{
ÙÙ 
var
ıı 
key
ıı 
=
ıı 
string
ıı 
.
ıı 
Format
ıı 
(
ıı  
	stringKey
ıı  )
,
ıı) *
affiliateId
ıı+ 6
)
ıı6 7
;
ıı7 8
var
ˆˆ 
	existsKey
ˆˆ 
=
ˆˆ 
await
ˆˆ 
_redisCache
ˆˆ )
.
ˆˆ) *
	KeyExists
ˆˆ* 3
(
ˆˆ3 4
key
ˆˆ4 7
)
ˆˆ7 8
;
ˆˆ8 9
if
¯¯ 

(
¯¯ 
	existsKey
¯¯ 
)
¯¯ 
await
˘˘ 
_redisCache
˘˘ 
.
˘˘ 
Delete
˘˘ $
(
˘˘$ %
key
˘˘% (
)
˘˘( )
;
˘˘) *
}
˙˙ 
}¸¸ éÈ
LC:\HeroSystem\walletService\WalletService.Core\Services\ConPaymentService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class 
ConPaymentService 
:  
BaseService! ,
,, -
IConPaymentService. @
{ 
private 
readonly 
string 
_merchantId '
;' (
private 
readonly 
ConPaymentsApi #
.# $
ConPaymentsApi$ 2
_conPaymentsApi3 B
;B C
private 
readonly -
!ICoinPaymentTransactionRepository 6-
!_coinPaymentTransactionRepository7 X
;X Y
private   
readonly   
IInvoiceRepository   '
_invoiceRepository  ( :
;  : ;
private!! 
readonly!! "
IAccountServiceAdapter!! +"
_accountServiceAdapter!!, B
;!!B C
private"" 
readonly"" 
ILogger"" 
<"" 
ConPaymentService"" .
>"". /
_logger""0 7
;""7 8
private## 
readonly## 
IWalletRepository## &
_walletRepository##' 8
;##8 9
private$$ 
readonly$$ 
IBrevoEmailService$$ '
_brevoEmailService$$( :
;$$: ;
private%% 
readonly%% $
IWalletRequestRepository%% -$
_walletRequestRepository%%. F
;%%F G
private&& 
readonly&& $
IInventoryServiceAdapter&& -$
_inventoryServiceAdapter&&. F
;&&F G
private'' 
readonly'' (
ICoinPaymentsPaymentStrategy'' 1(
_coinPaymentsPaymentStrategy''2 N
;''N O
private(( 
readonly(( 

RedisCache(( 
_redisCache((  +
;((+ ,
private)) 
readonly)) 
IBrandService)) "
_brandService))# 0
;))0 1
private** 
readonly** $
IWalletWithdrawalService** -$
_walletWithDrawalService**. F
;**F G
public,, 

ConPaymentService,, 
(,, 
IMapper-- 
mapper-- 
,-- 
IOptions--  
<--  !$
ApplicationConfiguration--! 9
>--9 :
appSettings--; F
,--F G-
!ICoinPaymentTransactionRepository.. ),
 coinPaymentTransactionRepository..* J
,..J K
IInvoiceRepository// 
invoiceRepository// ,
,//, -
ILogger00 
<00 
ConPaymentService00 !
>00! "
logger00# )
,00) *"
IAccountServiceAdapter11 !
accountServiceAdapter11 4
,114 5
IWalletRepository22 
walletRepository22 *
,22* +
IBrevoEmailService33 
brevoEmailService33 ,
,33, -$
IWalletRequestRepository44  #
walletRequestRepository44! 8
,448 9$
IInventoryServiceAdapter55  #
inventoryServiceAdapter55! 8
,558 9(
ICoinPaymentsPaymentStrategy66 $'
coinPaymentsPaymentStrategy66% @
,66@ A

RedisCache77 

redisCache77 
,77 
IBrandService88 
brandService88 "
,88" #$
IWalletWithdrawalService99  #
walletWithDrawalService99! 8
):: 
::: 
base:: 
(:: 
mapper:: 
):: 
{;; 
_invoiceRepository<< 
=<< 
invoiceRepository<< .
;<<. /
var== 
appSettings1== 
=== 
appSettings== &
.==& '
Value==' ,
;==, -
_conPaymentsApi>> 
=>> 
new?? 
ConPaymentsApi?? 
.?? 
ConPaymentsApi?? -
(??- .
appSettings1??. :
.??: ;
ConPayments??; F
!??F G
.??G H
Secret??H N
,??N O
appSettings1??P \
.??\ ]
ConPayments??] h
.??h i
Key??i l
)??l m
;??m n
_merchantId@@ 
=@@ 
appSettings1@@ "
.@@" #
ConPayments@@# .
.@@. /

MerchantId@@/ 9
;@@9 :-
!_coinPaymentTransactionRepositoryAA )
=AA* +,
 coinPaymentTransactionRepositoryAA, L
;AAL M
_loggerBB 
=BB 
loggerBB 
;BB "
_accountServiceAdapterCC 
=CC  !
accountServiceAdapterCC! 6
;CC6 7
_walletRepositoryDD 
=DD 
walletRepositoryDD ,
;DD, -
_brevoEmailServiceEE 
=EE 
brevoEmailServiceEE .
;EE. /$
_walletRequestRepositoryFF  
=FF! "#
walletRequestRepositoryFF# :
;FF: ;$
_inventoryServiceAdapterGG  
=GG! "#
inventoryServiceAdapterGG# :
;GG: ;(
_coinPaymentsPaymentStrategyHH $
=HH% &'
coinPaymentsPaymentStrategyHH' B
;HHB C
_redisCacheII 
=II 

redisCacheII  
;II  !
_brandServiceJJ 
=JJ 
brandServiceJJ $
;JJ$ %$
_walletWithDrawalServiceKK  
=KK! "#
walletWithDrawalServiceKK# :
;KK: ;
}LL 
publicNN 

asyncNN 
TaskNN 
<NN '
GetPayByNameProfileResponseNN 1
>NN1 2
GetPayByNameProfileNN3 F
(NNF G
stringNNG M
nameTagNNN U
)NNU V
{OO 
_loggerPP 
.PP 
LogInformationPP 
(PP 
$"PP !
$strPP! ^
{PP^ _
nameTagPP_ f
}PPf g
"PPg h
)PPh i
;PPi j

SortedListQQ 
<QQ 
stringQQ 
,QQ 
stringQQ !
>QQ! "
parmsQQ# (
=QQ) *
newQQ+ .

SortedListQQ/ 9
<QQ9 :
stringQQ: @
,QQ@ A
stringQQB H
>QQH I
{RR 	
{SS 
$strSS 
,SS 
nameTagSS 
}SS  !
}TT 	
;TT	 

IRestResponseVV 
restResponseVV "
=VV# $
awaitVV% *
_conPaymentsApiVV+ :
.VV: ;
CallApiVV; B
(VVB C
$strVVC Q
,VVQ R
parmsVVS X
)VVX Y
;VVY Z
_loggerXX 
.XX 
LogInformationXX 
(XX 
$"XX !
$strXX! W
{XXW X
restResponseXXX d
.XXd e
ToJsonStringXXe q
(XXq r
)XXr s
}XXs t
"XXt u
)XXu v
;XXv w
ifZZ 

(ZZ 
restResponseZZ 
.ZZ 
IsSuccessfulZZ %
)ZZ% &
{[[ 	
var\\ 
result\\ 
=\\ 
restResponse\\ %
.\\% &
Content\\& -
!\\- .
.\\. /
ToJsonObject\\/ ;
<\\; <'
GetPayByNameProfileResponse\\< W
>\\W X
(\\X Y
)\\Y Z
;\\Z [
return]] 
result]] 
!]] 
;]] 
}^^ 	
else__ 
{`` 	
throwaa 
newaa 
	Exceptionaa 
(aa  
$"aa  "
$straa" 5
{aa5 6
restResponseaa6 B
.aaB C
StatusDescriptionaaC T
}aaT U
"aaU V
)aaV W
;aaW X
}bb 	
}cc 
publicee 

asyncee 
Taskee 
<ee %
GetDepositAddressResponseee /
?ee/ 0
>ee0 1
GetDepositAddressee2 C
(eeC D
stringeeD J
currencyeeK S
)eeS T
{ff 

SortedListgg 
<gg 
stringgg 
,gg 
stringgg !
>gg! "
parmsgg# (
=gg) *
newgg+ .

SortedListgg/ 9
<gg9 :
stringgg: @
,gg@ A
stringggB H
>ggH I
{hh 	
{ii 
$strii 
,ii 
currencyii "
}ii# $
}jj 	
;jj	 

IRestResponsell 
restResponsell "
=ll# $
awaitll% *
_conPaymentsApill+ :
.ll: ;
CallApill; B
(llB C
$strllC X
,llX Y
parmsllZ _
)ll_ `
;ll` a
ifnn 

(nn 
restResponsenn 
.nn 
IsSuccessfulnn %
)nn% &
{oo 	
varpp 
resultpp 
=pp 
restResponsepp %
.pp% &
Contentpp& -
!pp- .
.pp. /
ToJsonObjectpp/ ;
<pp; <%
GetDepositAddressResponsepp< U
>ppU V
(ppV W
)ppW X
!ppX Y
;ppY Z
returnqq 
resultqq 
;qq 
}rr 	
elsess 
{tt 	
throwuu 
newuu 
	Exceptionuu 
(uu  
$"uu  "
$struu" 5
{uu5 6
restResponseuu6 B
.uuB C
StatusDescriptionuuC T
}uuT U
"uuU V
)uuV W
;uuW X
}vv 	
}ww 
publicyy 

asyncyy 
Taskyy 
<yy #
GetCoinBalancesResponseyy -
>yy- .
GetCoinBalancesyy/ >
(yy> ?
boolyy? C
includeZeroBalancesyyD W
=yyX Y
falseyyZ _
)yy_ `
{zz 
var{{ 
parms{{ 
={{ 
new{{ 

SortedList{{ "
<{{" #
string{{# )
,{{) *
string{{+ 1
>{{1 2
({{2 3
){{3 4
;{{4 5
if|| 

(|| 
includeZeroBalances|| 
)||  
{}} 	
parms~~ 
.~~ 
Add~~ 
(~~ 
$str~~ 
,~~ 
$str~~  
)~~  !
;~~! "
} 	
var
ÅÅ 
restResponse
ÅÅ 
=
ÅÅ 
await
ÅÅ  
_conPaymentsApi
ÅÅ! 0
.
ÅÅ0 1
CallApi
ÅÅ1 8
(
ÅÅ8 9
$str
ÅÅ9 C
,
ÅÅC D
parms
ÅÅE J
)
ÅÅJ K
;
ÅÅK L
if
ÉÉ 

(
ÉÉ 
restResponse
ÉÉ 
.
ÉÉ 
IsSuccessful
ÉÉ %
)
ÉÉ% &
{
ÑÑ 	
var
ÖÖ 
result
ÖÖ 
=
ÖÖ 
restResponse
ÖÖ %
.
ÖÖ% &
Content
ÖÖ& -
!
ÖÖ- .
.
ÖÖ. /
ToJsonObject
ÖÖ/ ;
<
ÖÖ; <%
GetCoinBalancesResponse
ÖÖ< S
>
ÖÖS T
(
ÖÖT U
)
ÖÖU V
;
ÖÖV W
return
ÜÜ 
result
ÜÜ 
!
ÜÜ 
;
ÜÜ 
}
áá 	
else
àà 
{
ââ 	
throw
ää 
new
ää 
	Exception
ää 
(
ää  
$"
ää  "
$str
ää" 5
{
ää5 6
restResponse
ää6 B
.
ääB C
StatusDescription
ääC T
}
ääT U
"
ääU V
)
ääV W
;
ääW X
}
ãã 	
}
åå 
public
éé 

async
éé 
Task
éé 
<
éé 2
$CreateConPaymentsTransactionResponse
éé :
?
éé: ;
>
éé; <
CreatePayment
éé= J
(
ééJ K
ConPaymentRequest
ééK \
request
éé] d
)
ééd e
{
èè 
_logger
êê 
.
êê 
LogInformation
êê 
(
êê 
$"
êê !
$str
êê! X
{
êêX Y
request
êêY `
.
êê` a
ToJsonString
êêa m
(
êêm n
)
êên o
}
êêo p
"
êêp q
)
êêq r
;
êêr s 
SetRequestDefaults
ëë 
(
ëë 
request
ëë "
)
ëë" #
;
ëë# $
var
íí 
parms
íí 
=
íí 
ConfigureParms
íí "
(
íí" #
request
íí# *
)
íí* +
;
íí+ ,
var
îî 
restResponse
îî 
=
îî 
await
îî  
CallApiAsync
îî! -
(
îî- .
$str
îî. B
,
îîB C
parms
îîD I
)
îîI J
;
îîJ K
_logger
ïï 
.
ïï 
LogInformation
ïï 
(
ïï 
$"
ññ 
$str
ññ M
{
ññM N
restResponse
ññN Z
.
ññZ [
ToJsonString
ññ[ g
(
ññg h
)
ññh i
}
ññi j
"
ññj k
)
ññk l
;
ññl m
if
òò 

(
òò 
!
òò 
restResponse
òò 
.
òò 
IsSuccessful
òò &
)
òò& '
{
ôô 	
throw
öö 
new
öö 
	Exception
öö 
(
öö  
$"
öö  "
$str
öö" 5
{
öö5 6
restResponse
öö6 B
.
ööB C
StatusDescription
ööC T
}
ööT U
"
ööU V
)
ööV W
;
ööW X
}
õõ 	
return
ùù 
await
ùù &
HandleSuccessfulResponse
ùù -
(
ùù- .
restResponse
ùù. :
,
ùù: ;
request
ùù< C
)
ùùC D
;
ùùD E
}
ûû 
private
†† 
void
††  
SetRequestDefaults
†† #
(
††# $
ConPaymentRequest
††$ 5
request
††6 =
)
††= >
{
°° 
request
¢¢ 
.
¢¢ 
Address
¢¢ 
=
¢¢ 
	Constants
¢¢ #
.
¢¢# $
ConPaymentAddress
¢¢$ 5
;
¢¢5 6
request
££ 
.
££ 
	Currency1
££ 
=
££ 
	Constants
££ %
.
££% & 
ConPaymentCurrency
££& 8
;
££8 9
request
§§ 
.
§§ 
	Currency2
§§ 
=
§§ 
	Constants
§§ %
.
§§% & 
ConPaymentCurrency
§§& 8
;
§§8 9
if
¶¶ 

(
¶¶ 
request
¶¶ 
.
¶¶ 
Products
¶¶ 
.
¶¶ 
Count
¶¶ "
>
¶¶# $
$num
¶¶% &
)
¶¶& '
{
ßß 	
request
®® 
.
®® 
Custom
®® 
=
®® 
JsonConvert
®® (
.
®®( )
SerializeObject
®®) 8
(
®®8 9
request
®®9 @
.
®®@ A
Products
®®A I
)
®®I J
;
®®J K
}
©© 	
}
™™ 
private
¨¨ 

SortedList
¨¨ 
<
¨¨ 
string
¨¨ 
,
¨¨ 
string
¨¨ %
>
¨¨% &
ConfigureParms
¨¨' 5
(
¨¨5 6
ConPaymentRequest
¨¨6 G
request
¨¨H O
)
¨¨O P
{
≠≠ 
var
ÆÆ 
parms
ÆÆ 
=
ÆÆ 
new
ÆÆ 

SortedList
ÆÆ "
<
ÆÆ" #
string
ÆÆ# )
,
ÆÆ) *
string
ÆÆ+ 1
>
ÆÆ1 2
{
ØØ 	
{
∞∞ 
$str
∞∞ 
,
∞∞ 
$str
∞∞ )
}
∞∞* +
,
∞∞+ ,
{
±± 
$str
±± 
,
±± 
request
±± 
.
±±  
Amount
±±  &
.
±±& '
ToString
±±' /
(
±±/ 0
CultureInfo
±±0 ;
.
±±; <
InvariantCulture
±±< L
)
±±L M
}
±±N O
,
±±O P
{
≤≤ 
$str
≤≤ 
,
≤≤ 
request
≤≤ "
.
≤≤" #
	Currency1
≤≤# ,
}
≤≤- .
,
≤≤. /
{
≥≥ 
$str
≥≥ 
,
≥≥ 
request
≥≥ "
.
≥≥" #
	Currency2
≥≥# ,
}
≥≥- .
,
≥≥. /
{
¥¥ 
$str
¥¥ 
,
¥¥ 
request
¥¥ $
.
¥¥$ %

BuyerEmail
¥¥% /
}
¥¥0 1
,
¥¥1 2
{
µµ 
$str
µµ 
,
µµ 
request
µµ  
.
µµ  !
Address
µµ! (
}
µµ) *
}
∂∂ 	
;
∂∂	 

if
∏∏ 

(
∏∏ 
request
∏∏ 
.
∏∏ 
	BuyerName
∏∏ 
!=
∏∏  
null
∏∏! %
)
∏∏% &
parms
∏∏' ,
.
∏∏, -
Add
∏∏- 0
(
∏∏0 1
$str
∏∏1 =
,
∏∏= >
request
∏∏? F
.
∏∏F G
	BuyerName
∏∏G P
)
∏∏P Q
;
∏∏Q R
if
ππ 

(
ππ 
request
ππ 
.
ππ 
ItemName
ππ 
!=
ππ 
null
ππ  $
)
ππ$ %
parms
ππ& +
.
ππ+ ,
Add
ππ, /
(
ππ/ 0
$str
ππ0 ;
,
ππ; <
request
ππ= D
.
ππD E
ItemName
ππE M
)
ππM N
;
ππN O
if
∫∫ 

(
∫∫ 
request
∫∫ 
.
∫∫ 

ItemNumber
∫∫ 
!=
∫∫ !
null
∫∫" &
)
∫∫& '
parms
∫∫( -
.
∫∫- .
Add
∫∫. 1
(
∫∫1 2
$str
∫∫2 ?
,
∫∫? @
request
∫∫A H
.
∫∫H I

ItemNumber
∫∫I S
)
∫∫S T
;
∫∫T U
if
ªª 

(
ªª 
request
ªª 
.
ªª 
Invoice
ªª 
!=
ªª 
null
ªª #
)
ªª# $
parms
ªª% *
.
ªª* +
Add
ªª+ .
(
ªª. /
$str
ªª/ 8
,
ªª8 9
request
ªª: A
.
ªªA B
Invoice
ªªB I
)
ªªI J
;
ªªJ K
if
ºº 

(
ºº 
request
ºº 
.
ºº 
Custom
ºº 
!=
ºº 
null
ºº "
)
ºº" #
parms
ºº$ )
.
ºº) *
Add
ºº* -
(
ºº- .
$str
ºº. 6
,
ºº6 7
request
ºº8 ?
.
ºº? @
Custom
ºº@ F
)
ººF G
;
ººG H
if
ΩΩ 

(
ΩΩ 
request
ΩΩ 
.
ΩΩ 
IpnUrl
ΩΩ 
!=
ΩΩ 
null
ΩΩ "
)
ΩΩ" #
parms
ΩΩ$ )
.
ΩΩ) *
Add
ΩΩ* -
(
ΩΩ- .
$str
ΩΩ. 7
,
ΩΩ7 8
request
ΩΩ9 @
.
ΩΩ@ A
IpnUrl
ΩΩA G
)
ΩΩG H
;
ΩΩH I
if
ææ 

(
ææ 
request
ææ 
.
ææ 

SuccessUrl
ææ 
!=
ææ !
null
ææ" &
)
ææ& '
parms
ææ( -
.
ææ- .
Add
ææ. 1
(
ææ1 2
$str
ææ2 ?
,
ææ? @
request
ææA H
.
ææH I

SuccessUrl
ææI S
)
ææS T
;
ææT U
if
øø 

(
øø 
request
øø 
.
øø 
	CancelUrl
øø 
!=
øø  
null
øø! %
)
øø% &
parms
øø' ,
.
øø, -
Add
øø- 0
(
øø0 1
$str
øø1 =
,
øø= >
request
øø? F
.
øøF G
	CancelUrl
øøG P
)
øøP Q
;
øøQ R
return
¡¡ 
parms
¡¡ 
;
¡¡ 
}
¬¬ 
private
ƒƒ 
async
ƒƒ 
Task
ƒƒ 
<
ƒƒ 
IRestResponse
ƒƒ $
>
ƒƒ$ %
CallApiAsync
ƒƒ& 2
(
ƒƒ2 3
string
ƒƒ3 9
endpoint
ƒƒ: B
,
ƒƒB C

SortedList
ƒƒD N
<
ƒƒN O
string
ƒƒO U
,
ƒƒU V
string
ƒƒW ]
>
ƒƒ] ^
parms
ƒƒ_ d
)
ƒƒd e
{
≈≈ 
return
∆∆ 
await
∆∆ 
_conPaymentsApi
∆∆ $
.
∆∆$ %
CallApi
∆∆% ,
(
∆∆, -
endpoint
∆∆- 5
,
∆∆5 6
parms
∆∆7 <
)
∆∆< =
;
∆∆= >
}
«« 
private
…… 
async
…… 
Task
…… 
<
…… 2
$CreateConPaymentsTransactionResponse
…… ;
>
……; <&
HandleSuccessfulResponse
……= U
(
……U V
IRestResponse
……V c
restResponse
……d p
,
……p q
ConPaymentRequest
   
request
   !
)
  ! "
{
ÀÀ 
var
ÃÃ 
result
ÃÃ 
=
ÃÃ 
JsonConvert
ÃÃ  
.
ÃÃ  !
DeserializeObject
ÃÃ! 2
<
ÃÃ2 32
$CreateConPaymentsTransactionResponse
ÃÃ3 W
>
ÃÃW X
(
ÃÃX Y
restResponse
ÃÃY e
.
ÃÃe f
Content
ÃÃf m
!
ÃÃm n
)
ÃÃn o
;
ÃÃo p
var
ŒŒ  
paymentTransaction
ŒŒ 
=
ŒŒ  
new
ŒŒ! $$
CoinpaymentTransaction
ŒŒ% ;
{
œœ 	
IdTransaction
–– 
=
–– 
result
–– "
!
––" #
.
––# $
Result
––$ *
!
––* +
.
––+ ,
Txn_Id
––, 2
!
––2 3
,
––3 4
AffiliateId
—— 
=
—— 
Convert
—— !
.
——! "
ToInt32
——" )
(
——) *
request
——* 1
.
——1 2

ItemNumber
——2 <
)
——< =
,
——= >
Amount
““ 
=
““ 
request
““ 
.
““ 
Amount
““ #
,
““# $
AmountReceived
”” 
=
”” 
$num
”” 
,
”” 
Products
‘‘ 
=
‘‘ 
request
‘‘ 
.
‘‘ 
Custom
‘‘ %
!
‘‘% &
,
‘‘& '
	Acredited
’’ 
=
’’ 
false
’’ 
,
’’ 
Status
÷÷ 
=
÷÷ 
$num
÷÷ 
,
÷÷ 
PaymentMethod
◊◊ 
=
◊◊ 
$str
◊◊ )
,
◊◊) *
	CreatedAt
ÿÿ 
=
ÿÿ 
DateTime
ÿÿ  
.
ÿÿ  !
Now
ÿÿ! $
,
ÿÿ$ %
	UpdatedAt
ŸŸ 
=
ŸŸ 
DateTime
ŸŸ  
.
ŸŸ  !
Now
ŸŸ! $
,
ŸŸ$ %
BrandId
⁄⁄ 
=
⁄⁄ 
_brandService
⁄⁄ #
.
⁄⁄# $
BrandId
⁄⁄$ +
}
€€ 	
;
€€	 

await
›› /
!_coinPaymentTransactionRepository
›› /
.
››/ 0*
CreateCoinPaymentTransaction
››0 L
(
››L M 
paymentTransaction
››M _
)
››_ `
;
››` a
return
ﬂﬂ 
result
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 
public
‚‚ 

async
‚‚ 
Task
‚‚ 
<
‚‚ (
GetTransactionInfoResponse
‚‚ 0
>
‚‚0 1 
GetTransactionInfo
‚‚2 D
(
‚‚D E
string
‚‚E K
idTransaction
‚‚L Y
,
‚‚Y Z
bool
‚‚[ _
full
‚‚` d
=
‚‚e f
false
‚‚g l
)
‚‚l m
{
„„ 
var
‰‰ 
parms
‰‰ 
=
‰‰ 
new
‰‰ 

SortedList
‰‰ "
<
‰‰" #
string
‰‰# )
,
‰‰) *
string
‰‰+ 1
>
‰‰1 2
(
‰‰2 3
)
‰‰3 4
;
‰‰4 5
parms
ÊÊ 
.
ÊÊ 
Add
ÊÊ 
(
ÊÊ 
$str
ÊÊ 
,
ÊÊ 
idTransaction
ÊÊ '
)
ÊÊ' (
;
ÊÊ( )
if
ËË 

(
ËË 
full
ËË 
)
ËË 
parms
ÈÈ 
.
ÈÈ 
Add
ÈÈ 
(
ÈÈ 
$str
ÈÈ 
,
ÈÈ 
$str
ÈÈ !
)
ÈÈ! "
;
ÈÈ" #
var
ÎÎ 
restResponse
ÎÎ 
=
ÎÎ 
await
ÎÎ  
_conPaymentsApi
ÎÎ! 0
.
ÎÎ0 1
CallApi
ÎÎ1 8
(
ÎÎ8 9
$str
ÎÎ9 F
,
ÎÎF G
parms
ÎÎH M
)
ÎÎM N
;
ÎÎN O
if
ÌÌ 

(
ÌÌ 
restResponse
ÌÌ 
.
ÌÌ 
IsSuccessful
ÌÌ %
)
ÌÌ% &
{
ÓÓ 	
var
ÔÔ 
result
ÔÔ 
=
ÔÔ 
restResponse
ÔÔ %
.
ÔÔ% &
Content
ÔÔ& -
!
ÔÔ- .
.
ÔÔ. /
ToJsonObject
ÔÔ/ ;
<
ÔÔ; <(
GetTransactionInfoResponse
ÔÔ< V
>
ÔÔV W
(
ÔÔW X
)
ÔÔX Y
;
ÔÔY Z
return
 
result
 
!
 
;
 
}
ÒÒ 	
else
ÚÚ 
throw
ÛÛ 
new
ÛÛ 
	Exception
ÛÛ 
(
ÛÛ  
$"
ÛÛ  "
$str
ÛÛ" 5
{
ÛÛ5 6
restResponse
ÛÛ6 B
.
ÛÛB C
StatusDescription
ÛÛC T
}
ÛÛT U
"
ÛÛU V
)
ÛÛV W
;
ÛÛW X
}
ÙÙ 
public
ˆˆ 

async
ˆˆ 
Task
ˆˆ 
<
ˆˆ 
string
ˆˆ 
>
ˆˆ 
ProcessIpnAsync
ˆˆ -
(
ˆˆ- .

IpnRequest
ˆˆ. 8

ipnRequest
ˆˆ9 C
,
ˆˆC D
IHeaderDictionary
ˆˆE V
headers
ˆˆW ^
)
ˆˆ^ _
{
˜˜ 
_logger
¯¯ 
.
¯¯ 
LogInformation
¯¯ 
(
¯¯ 
$"
˘˘ 
$str
˘˘ B
{
˘˘B C

ipnRequest
˘˘C M
.
˘˘M N
ToJsonString
˘˘N Z
(
˘˘Z [
)
˘˘[ \
}
˘˘\ ]
$str
˘˘] i
{
˘˘i j
headers
˘˘j q
.
˘˘q r
ToJsonString
˘˘r ~
(
˘˘~ 
)˘˘ Ä
}˘˘Ä Å
"˘˘Å Ç
)˘˘Ç É
;˘˘É Ñ
if
˙˙ 

(
˙˙ 
!
˙˙ 
IsRequestValid
˙˙ 
(
˙˙ 

ipnRequest
˙˙ &
,
˙˙& '
headers
˙˙( /
)
˙˙/ 0
)
˙˙0 1
return
˚˚ 
$str
˚˚ (
;
˚˚( )
var
˝˝ 
transactionResult
˝˝ 
=
˝˝ 
await
˝˝  %/
!_coinPaymentTransactionRepository
˝˝& G
.
˝˝G H#
GetTransactionByTxnId
˝˝H ]
(
˝˝] ^

ipnRequest
˝˝^ h
.
˝˝h i
txn_id
˝˝i o
)
˝˝o p
;
˝˝p q
if
ˇˇ 

(
ˇˇ 
transactionResult
ˇˇ 
is
ˇˇ  
null
ˇˇ! %
)
ˇˇ% &
return
ÄÄ 
$str
ÄÄ *
;
ÄÄ* +
_logger
ÇÇ 
.
ÇÇ 
LogInformation
ÇÇ 
(
ÇÇ 
$"
ÉÉ 
$str
ÉÉ I
{
ÉÉI J
transactionResult
ÉÉJ [
.
ÉÉ[ \
ToJsonString
ÉÉ\ h
(
ÉÉh i
)
ÉÉi j
}
ÉÉj k
"
ÉÉk l
)
ÉÉl m
;
ÉÉm n
if
ÖÖ 

(
ÖÖ 
transactionResult
ÖÖ 
.
ÖÖ 
Status
ÖÖ $
==
ÖÖ% '
$num
ÖÖ( +
)
ÖÖ+ ,
return
ÜÜ 
$str
ÜÜ 2
;
ÜÜ2 3
transactionResult
àà 
.
àà 
Status
àà  
=
àà! "

ipnRequest
àà# -
.
àà- .
status
àà. 4
;
àà4 5
transactionResult
ââ 
.
ââ 
AmountReceived
ââ (
=
ââ) *

ipnRequest
ââ+ 5
.
ââ5 6
received_amount
ââ6 E
;
ââE F
if
ãã 

(
ãã 

ipnRequest
ãã 
.
ãã 
status
ãã 
==
ãã  
-
ãã! "
$num
ãã" #
)
ãã# $
{
åå 	
await
çç (
HandleCancelledTransaction
çç ,
(
çç, -
transactionResult
çç- >
,
çç> ?

ipnRequest
çç@ J
,
ççJ K
transactionResult
ççL ]
.
çç] ^
Products
çç^ f
)
ççf g
;
ççg h
return
éé 
$str
éé *
;
éé* +
}
èè 	
if
ëë 

(
ëë 
!
ëë 
transactionResult
ëë 
.
ëë 
	Acredited
ëë (
)
ëë( )
{
íí 	
await
ìì &
HandlePaymentTransaction
ìì *
(
ìì* +
transactionResult
ìì+ <
,
ìì< =

ipnRequest
ìì> H
)
ììH I
;
ììI J
}
îî 	
if
ññ 

(
ññ 

ipnRequest
ññ 
.
ññ 
status
ññ 
==
ññ  
$num
ññ! $
)
ññ$ %
{
óó 	
await
òò 
GrantWelcomeBonus
òò #
(
òò# $
transactionResult
òò$ 5
.
òò5 6
AffiliateId
òò6 A
,
òòA B
transactionResult
òòC T
.
òòT U
Products
òòU ]
)
òò] ^
;
òò^ _
}
ôô 	
await
õõ /
!_coinPaymentTransactionRepository
õõ /
.
õõ/ 0/
!UpdateCoinPaymentTransactionAsync
õõ0 Q
(
õõQ R
transactionResult
õõR c
)
õõc d
;
õõd e
return
úú 
$str
úú 
;
úú 
}
ùù 
private
üü 
async
üü 
Task
üü (
HandleCancelledTransaction
üü 1
(
üü1 2$
CoinpaymentTransaction
üü2 H
transactionResult
üüI Z
,
üüZ [

IpnRequest
üü\ f

ipnRequest
üüg q
,
üüq r
string
†† 
products
†† 
)
†† 
{
°° 
_logger
¢¢ 
.
¢¢ 
LogInformation
¢¢ 
(
¢¢ 
$"
££ 
$str
££ T
{
££T U
transactionResult
££U f
.
££f g
ToJsonString
££g s
(
££s t
)
££t u
}
££u v
"
££v w
)
££w x
;
££x y
await
§§ /
!_coinPaymentTransactionRepository
§§ /
.
§§/ 0/
!UpdateCoinPaymentTransactionAsync
§§0 Q
(
§§Q R
transactionResult
§§R c
)
§§c d
;
§§d e
await
¶¶ 3
%RevertUnconfirmedOrUnpaidTransactions
¶¶ 3
(
¶¶3 4

ipnRequest
¶¶4 >
.
¶¶> ?
txn_id
¶¶? E
,
¶¶E F
products
¶¶G O
)
¶¶O P
;
¶¶P Q
}
ßß 
private
©© 
async
©© 
Task
©© &
HandlePaymentTransaction
©© /
(
©©/ 0$
CoinpaymentTransaction
©©0 F
transactionResult
©©G X
,
©©X Y

IpnRequest
©©Z d

ipnRequest
©©e o
)
©©o p
{
™™ 
_logger
´´ 
.
´´ 
LogInformation
´´ 
(
´´ 
$"
¨¨ 
$str
¨¨ R
{
¨¨R S
transactionResult
¨¨S d
.
¨¨d e
ToJsonString
¨¨e q
(
¨¨q r
)
¨¨r s
}
¨¨s t
"
¨¨t u
)
¨¨u v
;
¨¨v w
var
≠≠ 
walletRequest
≠≠ 
=
≠≠  
BuildWalletRequest
≠≠ .
(
≠≠. /

ipnRequest
≠≠/ 9
,
≠≠9 :
transactionResult
≠≠; L
)
≠≠L M
;
≠≠M N
var
ØØ 
products
ØØ 
=
ØØ 
transactionResult
ØØ (
.
ØØ( )
Products
ØØ) 1
.
ØØ1 2
ToJsonObject
ØØ2 >
<
ØØ> ?
List
ØØ? C
<
ØØC D
ProductRequest
ØØD R
>
ØØR S
>
ØØS T
(
ØØT U
)
ØØU V
;
ØØV W
if
∞∞ 

(
∞∞ 
products
∞∞ 
is
∞∞ 
null
∞∞ 
)
∞∞ 
return
∞∞ $
;
∞∞$ %
_logger
≤≤ 
.
≤≤ 
LogInformation
≤≤ 
(
≤≤ 
$"
≤≤ !
$str
≤≤! \
{
≤≤\ ]
products
≤≤] e
.
≤≤e f
ToJsonString
≤≤f r
(
≤≤r s
)
≤≤s t
}
≤≤t u
"
≤≤u v
)
≤≤v w
;
≤≤w x
var
¥¥ 
isExists
¥¥ 
=
¥¥ 
await
µµ  
_invoiceRepository
µµ $
.
µµ$ %*
InvoiceExistsByReceiptNumber
µµ% A
(
µµA B
transactionResult
µµB S
.
µµS T
IdTransaction
µµT a
,
µµa b
_brandService
∂∂ 
.
∂∂ 
BrandId
∂∂ %
)
∂∂% &
;
∂∂& '
var
∑∑ 
productType
∑∑ 
=
∑∑ 
await
∑∑ 
GetProductType
∑∑  .
(
∑∑. /
products
∑∑/ 7
,
∑∑7 8
transactionResult
∑∑9 J
.
∑∑J K
BrandId
∑∑K R
)
∑∑R S
;
∑∑S T
if
ππ 

(
ππ 
!
ππ 
isExists
ππ 
&&
ππ 

ipnRequest
ππ #
.
ππ# $
status
ππ$ *
is
ππ+ -
$num
ππ. /
or
ππ0 2
$num
ππ3 6
)
ππ6 7
{
∫∫ 	
transactionResult
ªª 
.
ªª 
	Acredited
ªª '
=
ªª( )
true
ªª* .
;
ªª. /
await
ΩΩ 
RemoveCacheKey
ΩΩ  
(
ΩΩ  !
walletRequest
ΩΩ! .
.
ΩΩ. /
AffiliateId
ΩΩ/ :
,
ΩΩ: ;
	CacheKeys
ΩΩ< E
.
ΩΩE F&
BalanceInformationModel2
ΩΩF ^
)
ΩΩ^ _
;
ΩΩ_ `
await
ææ 
RemoveCacheKey
ææ  
(
ææ  !
walletRequest
ææ! .
.
ææ. /
AffiliateId
ææ/ :
,
ææ: ;
	CacheKeys
ææ< E
.
ææE F'
BalanceInformationModel1A
ææF _
)
ææ_ `
;
ææ` a
await
øø 
RemoveCacheKey
øø  
(
øø  !
walletRequest
øø! .
.
øø. /
AffiliateId
øø/ :
,
øø: ;
	CacheKeys
øø< E
.
øøE F'
BalanceInformationModel1B
øøF _
)
øø_ `
;
øø` a
switch
¿¿ 
(
¿¿ 
productType
¿¿ 
)
¿¿  
{
¡¡ 
case
¬¬ 
ProductType
¬¬  
.
¬¬  !

Membership
¬¬! +
:
¬¬+ ,
await
√√ &
ExecuteMembershipPayment
√√ 2
(
√√2 3
walletRequest
√√3 @
,
√√@ A
products
√√B J
)
√√J K
;
√√K L
break
ƒƒ 
;
ƒƒ 
case
≈≈ 
ProductType
≈≈  
.
≈≈  !
EcoPool
≈≈! (
:
≈≈( )
await
∆∆ #
ExecuteEcoPoolPayment
∆∆ /
(
∆∆/ 0
walletRequest
∆∆0 =
,
∆∆= >
products
∆∆? G
)
∆∆G H
;
∆∆H I
break
«« 
;
«« 
case
»» 
ProductType
»»  
.
»»  !
RecyCoin
»»! )
:
»») *
await
…… $
ExecuteRecyCoinPayment
…… 0
(
……0 1
walletRequest
……1 >
,
……> ?
products
……@ H
)
……H I
;
……I J
_logger
   
.
   
LogInformation
   *
(
  * +
$"
  + -
$str
  - u
"
  u v
)
  v w
;
  w x
break
ÀÀ 
;
ÀÀ 
case
ÃÃ 
ProductType
ÃÃ  
.
ÃÃ  !
Course
ÃÃ! '
:
ÃÃ' (
await
ÕÕ "
ExecuteCoursePayment
ÕÕ .
(
ÕÕ. /
walletRequest
ÕÕ/ <
,
ÕÕ< =
products
ÕÕ> F
)
ÕÕF G
;
ÕÕG H
break
ŒŒ 
;
ŒŒ 
}
œœ 
}
–– 	
}
—— 
private
”” 
async
”” 
Task
”” 
<
”” 
ProductType
”” "
>
””" #
GetProductType
””$ 2
(
””2 3
List
””3 7
<
””7 8
ProductRequest
””8 F
>
””F G
request
””H O
,
””O P
long
””Q U
brandId
””V ]
)
””] ^
{
‘‘ 
if
’’ 

(
’’ 
request
’’ 
==
’’ 
null
’’ 
||
’’ 
!
’’  
request
’’  '
.
’’' (
Any
’’( +
(
’’+ ,
)
’’, -
)
’’- .
{
÷÷ 	
throw
◊◊ 
new
◊◊ 
ArgumentException
◊◊ '
(
◊◊' (
$str
◊◊( F
)
◊◊F G
;
◊◊G H
}
ÿÿ 	
var
⁄⁄ 

productIds
⁄⁄ 
=
⁄⁄ 
request
⁄⁄  
.
⁄⁄  !
Select
⁄⁄! '
(
⁄⁄' (
p
⁄⁄( )
=>
⁄⁄* ,
p
⁄⁄- .
.
⁄⁄. /
	ProductId
⁄⁄/ 8
)
⁄⁄8 9
.
⁄⁄9 :
ToArray
⁄⁄: A
(
⁄⁄A B
)
⁄⁄B C
;
⁄⁄C D
var
€€ 
responseList
€€ 
=
€€ 
await
€€  &
_inventoryServiceAdapter
€€! 9
.
€€9 :
GetProductsIds
€€: H
(
€€H I

productIds
€€I S
,
€€S T
brandId
€€U \
)
€€\ ]
;
€€] ^
var
›› 
result
›› 
=
›› 
responseList
›› !
.
››! "
Content
››" )
!
››) *
.
››* +
ToJsonObject
››+ 7
<
››7 8
ProductsResponse
››8 H
>
››H I
(
››I J
)
››J K
;
››K L
int
ﬂﬂ "
firstProductCategory
ﬂﬂ  
;
ﬂﬂ  !
if
·· 

(
·· 
!
·· 
result
·· 
!
·· 
.
·· 
Data
·· 
.
·· 
IsNullOrEmpty
·· '
(
··' (
)
··( )
)
··) *
{
‚‚ 	"
firstProductCategory
„„  
=
„„! "
result
„„# )
.
„„) *
Data
„„* .
.
„„. /
First
„„/ 4
(
„„4 5
)
„„5 6
.
„„6 7
PaymentGroup
„„7 C
;
„„C D
}
‰‰ 	
else
ÂÂ 
{
ÊÊ 	
var
ÁÁ 
membershipResult
ÁÁ  
=
ÁÁ! "
await
ËË &
_inventoryServiceAdapter
ËË .
.
ËË. /
GetProductById
ËË/ =
(
ËË= >

productIds
ËË> H
.
ËËH I
First
ËËI N
(
ËËN O
)
ËËO P
,
ËËP Q
_brandService
ËËR _
.
ËË_ `
BrandId
ËË` g
)
ËËg h
;
ËËh i
var
ÈÈ 
productResult
ÈÈ 
=
ÈÈ 
membershipResult
ÈÈ  0
.
ÈÈ0 1
Content
ÈÈ1 8
!
ÈÈ8 9
.
ÈÈ9 :
ToJsonObject
ÈÈ: F
<
ÈÈF G
ProductResponse
ÈÈG V
>
ÈÈV W
(
ÈÈW X
)
ÈÈX Y
;
ÈÈY Z"
firstProductCategory
ÍÍ  
=
ÍÍ! "
productResult
ÍÍ# 0
!
ÍÍ0 1
.
ÍÍ1 2
Data
ÍÍ2 6
.
ÍÍ6 7
PaymentGroup
ÍÍ7 C
;
ÍÍC D
}
ÎÎ 	
switch
ÌÌ 
(
ÌÌ "
firstProductCategory
ÌÌ $
)
ÌÌ$ %
{
ÓÓ 	
case
ÔÔ 
$num
ÔÔ 
:
ÔÔ 
return
ÔÔ 
ProductType
ÔÔ &
.
ÔÔ& '

Membership
ÔÔ' 1
;
ÔÔ1 2
case
 
$num
 
:
 
case
ÒÒ 
$num
ÒÒ 
:
ÒÒ 
case
ÚÚ 
$num
ÚÚ 
:
ÚÚ 
return
ÛÛ 
ProductType
ÛÛ "
.
ÛÛ" #
EcoPool
ÛÛ# *
;
ÛÛ* +
case
ÙÙ 
$num
ÙÙ 
:
ÙÙ 
return
ÙÙ 
ProductType
ÙÙ '
.
ÙÙ' (
RecyCoin
ÙÙ( 0
;
ÙÙ0 1
default
ıı 
:
ıı 
return
ˆˆ 
ProductType
ˆˆ "
.
ˆˆ" #
Course
ˆˆ# )
;
ˆˆ) *
}
˜˜ 	
}
¯¯ 
private
˙˙ 
bool
˙˙ 
IsRequestValid
˙˙ 
(
˙˙  

IpnRequest
˙˙  *

ipnRequest
˙˙+ 5
,
˙˙5 6
IHeaderDictionary
˙˙7 H
headers
˙˙I P
)
˙˙P Q
{
˚˚ 
if
¸¸ 

(
¸¸ 
string
¸¸ 
.
¸¸ 
IsNullOrEmpty
¸¸  
(
¸¸  !

ipnRequest
¸¸! +
.
¸¸+ ,
ipn_mode
¸¸, 4
)
¸¸4 5
||
¸¸6 8

ipnRequest
¸¸9 C
.
¸¸C D
ipn_mode
¸¸D L
.
¸¸L M
ToLower
¸¸M T
(
¸¸T U
)
¸¸U V
!=
¸¸W Y
$str
¸¸Z `
)
¸¸` a
return
˝˝ 
false
˝˝ 
;
˝˝ 
if
ˇˇ 

(
ˇˇ 
!
ˇˇ 
headers
ˇˇ 
.
ˇˇ 
TryGetValue
ˇˇ  
(
ˇˇ  !
$str
ˇˇ! '
,
ˇˇ' (
out
ˇˇ) ,
var
ˇˇ- 0
receivedHmac
ˇˇ1 =
)
ˇˇ= >
||
ˇˇ? A
String
ˇˇB H
.
ˇˇH I
IsNullOrEmpty
ˇˇI V
(
ˇˇV W
receivedHmac
ˇˇW c
)
ˇˇc d
)
ˇˇd e
return
ÄÄ 
false
ÄÄ 
;
ÄÄ 
if
ÇÇ 

(
ÇÇ 
string
ÇÇ 
.
ÇÇ 
IsNullOrEmpty
ÇÇ  
(
ÇÇ  !

ipnRequest
ÇÇ! +
.
ÇÇ+ ,
merchant
ÇÇ, 4
)
ÇÇ4 5
||
ÇÇ6 8

ipnRequest
ÇÇ9 C
.
ÇÇC D
merchant
ÇÇD L
!=
ÇÇM O
_merchantId
ÇÇP [
)
ÇÇ[ \
return
ÉÉ 
false
ÉÉ 
;
ÉÉ 
if
ÖÖ 

(
ÖÖ 

ipnRequest
ÖÖ 
.
ÖÖ 
ipn_type
ÖÖ 
!=
ÖÖ  "
$str
ÖÖ# (
)
ÖÖ( )
return
ÜÜ 
false
ÜÜ 
;
ÜÜ 
if
àà 

(
àà 

ipnRequest
àà 
.
àà 
	currency1
àà  
!=
àà! #
$str
àà$ 0
)
àà0 1
return
ââ 
false
ââ 
;
ââ 
return
ãã 
true
ãã 
;
ãã 
}
åå 
private
éé 
WalletRequest
éé  
BuildWalletRequest
éé ,
(
éé, -

IpnRequest
éé- 7

ipnRequest
éé8 B
,
ééB C$
CoinpaymentTransaction
ééD Z
transaction
éé[ f
)
ééf g
{
èè 
return
êê 
new
êê 
WalletRequest
êê  
{
ëë 	
AffiliateId
íí 
=
íí 

ipnRequest
íí $
.
íí$ %
item_number
íí% 0
,
íí0 1
AffiliateUserName
ìì 
=
ìì 

ipnRequest
ìì  *
.
ìì* +
	item_name
ìì+ 4
,
ìì4 5
PurchaseFor
îî 
=
îî 
$num
îî 
,
îî 
Bank
ïï 
=
ïï 
	Constants
ïï 
.
ïï 
CoinPayments
ïï )
,
ïï) *
PaymentMethod
ññ 
=
ññ 
$num
ññ 
,
ññ 
	SecretKey
óó 
=
óó 
null
óó 
,
óó 
ReceiptNumber
òò 
=
òò 

ipnRequest
òò &
.
òò& '
txn_id
òò' -
,
òò- .
ProductsList
ôô 
=
ôô 
new
ôô 
List
ôô #
<
ôô# $
ProductsRequests
ôô$ 4
>
ôô4 5
(
ôô5 6
)
ôô6 7
,
ôô7 8
BrandId
öö 
=
öö 
transaction
öö !
.
öö! "
BrandId
öö" )
,
öö) *
}
õõ 	
;
õõ	 

}
úú 
private
ûû 
async
ûû 
Task
ûû #
ExecuteEcoPoolPayment
ûû ,
(
ûû, -
WalletRequest
ûû- :
walletRequest
ûû; H
,
ûûH I
ICollection
ûûJ U
<
ûûU V
ProductRequest
ûûV d
>
ûûd e
products
ûûf n
)
ûûn o
{
üü 
walletRequest
†† 
.
†† 
ProductsList
†† "
=
††# $
products
††% -
.
††- .
Select
††. 4
(
††4 5
product
††5 <
=>
††= ?
new
††@ C
ProductsRequests
††D T
{
°° 	
	IdProduct
¢¢ 
=
¢¢ 
product
¢¢ 
.
¢¢  
	ProductId
¢¢  )
,
¢¢) *
Count
££ 
=
££ 
product
££ 
.
££ 
Quantity
££ $
}
§§ 	
)
§§	 

.
§§
 
ToList
§§ 
(
§§ 
)
§§ 
;
§§ 
await
¶¶ *
_coinPaymentsPaymentStrategy
¶¶ *
.
¶¶* +#
ExecuteEcoPoolPayment
¶¶+ @
(
¶¶@ A
walletRequest
¶¶A N
)
¶¶N O
;
¶¶O P
}
ßß 
private
©© 
async
©© 
Task
©© $
ExecuteRecyCoinPayment
©© -
(
©©- .
WalletRequest
©©. ;
walletRequest
©©< I
,
©©I J
ICollection
©©K V
<
©©V W
ProductRequest
©©W e
>
©©e f
products
©©g o
)
©©o p
{
™™ 
walletRequest
´´ 
.
´´ 
ProductsList
´´ "
=
´´# $
products
´´% -
.
´´- .
Select
´´. 4
(
´´4 5
product
´´5 <
=>
´´= ?
new
´´@ C
ProductsRequests
´´D T
{
¨¨ 	
	IdProduct
≠≠ 
=
≠≠ 
product
≠≠ 
.
≠≠  
	ProductId
≠≠  )
,
≠≠) *
Count
ÆÆ 
=
ÆÆ 
product
ÆÆ 
.
ÆÆ 
Quantity
ÆÆ $
}
ØØ 	
)
ØØ	 

.
ØØ
 
ToList
ØØ 
(
ØØ 
)
ØØ 
;
ØØ 
await
±± *
_coinPaymentsPaymentStrategy
±± *
.
±±* +$
ExecuteRecyCoinPayment
±±+ A
(
±±A B
walletRequest
±±B O
)
±±O P
;
±±P Q
}
≤≤ 
private
¥¥ 
async
¥¥ 
Task
¥¥ "
ExecuteCoursePayment
¥¥ +
(
¥¥+ ,
WalletRequest
¥¥, 9
walletRequest
¥¥: G
,
¥¥G H
ICollection
¥¥I T
<
¥¥T U
ProductRequest
¥¥U c
>
¥¥c d
products
¥¥e m
)
¥¥m n
{
µµ 
walletRequest
∂∂ 
.
∂∂ 
ProductsList
∂∂ "
=
∂∂# $
products
∂∂% -
.
∂∂- .
Select
∂∂. 4
(
∂∂4 5
product
∂∂5 <
=>
∂∂= ?
new
∂∂@ C
ProductsRequests
∂∂D T
{
∑∑ 	
	IdProduct
∏∏ 
=
∏∏ 
product
∏∏ 
.
∏∏  
	ProductId
∏∏  )
,
∏∏) *
Count
ππ 
=
ππ 
product
ππ 
.
ππ 
Quantity
ππ $
}
∫∫ 	
)
∫∫	 

.
∫∫
 
ToList
∫∫ 
(
∫∫ 
)
∫∫ 
;
∫∫ 
await
ºº *
_coinPaymentsPaymentStrategy
ºº *
.
ºº* +"
ExecuteCoursePayment
ºº+ ?
(
ºº? @
walletRequest
ºº@ M
)
ººM N
;
ººN O
}
ΩΩ 
private
øø 
async
øø 
Task
øø 
GrantWelcomeBonus
øø (
(
øø( )
int
øø) ,
userId
øø- 3
,
øø3 4
string
øø5 ;
productsInfo
øø< H
)
øøH I
{
¿¿ 
var
¡¡ 
products
¡¡ 
=
¡¡ 
productsInfo
¡¡ #
.
¡¡# $
ToJsonObject
¡¡$ 0
<
¡¡0 1
List
¡¡1 5
<
¡¡5 6
ProductRequest
¡¡6 D
>
¡¡D E
>
¡¡E F
(
¡¡F G
)
¡¡G H
;
¡¡H I
if
¬¬ 

(
¬¬ 
products
¬¬ 
is
¬¬ 
null
¬¬ 
)
¬¬ 
return
¬¬ $
;
¬¬$ %
var
ƒƒ 
isMembership
ƒƒ 
=
ƒƒ 
products
ƒƒ #
.
ƒƒ# $
Any
ƒƒ$ '
(
ƒƒ' (
p
ƒƒ( )
=>
ƒƒ* ,
p
ƒƒ- .
.
ƒƒ. /
	ProductId
ƒƒ/ 8
==
ƒƒ9 ;
$num
ƒƒ< =
)
ƒƒ= >
;
ƒƒ> ?
if
≈≈ 

(
≈≈ 
!
≈≈ 
isMembership
≈≈ 
)
≈≈ 
return
∆∆ 
;
∆∆ 
var
»» 
userInfo
»» 
=
»» 
await
»» $
_accountServiceAdapter
»» 3
.
»»3 4
GetUserInfo
»»4 ?
(
»»? @
userId
»»@ F
,
»»F G
_brandService
»»H U
.
»»U V
BrandId
»»V ]
)
»»] ^
;
»»^ _
if
…… 

(
…… 
userInfo
…… 
is
…… 
null
…… 
)
…… 
return
   
;
   
var
ÃÃ "
affiliateBonusWinner
ÃÃ  
=
ÃÃ! "
await
ÃÃ# ($
_accountServiceAdapter
ÃÃ) ?
.
ÃÃ? @
GetUserInfo
ÃÃ@ K
(
ÃÃK L
userInfo
ÃÃL T
.
ÃÃT U
Father
ÃÃU [
,
ÃÃ[ \
_brandService
ÃÃ] j
.
ÃÃj k
BrandId
ÃÃk r
)
ÃÃr s
;
ÃÃs t
var
ŒŒ .
 creditTransactionForWinningBonus
ŒŒ ,
=
ŒŒ- .
new
ŒŒ/ 2&
CreditTransactionRequest
ŒŒ3 K
{
œœ 	
AffiliateId
–– 
=
–– "
affiliateBonusWinner
–– .
!
––. /
.
––/ 0
Id
––0 2
,
––2 3
UserId
—— 
=
—— 
	Constants
—— 
.
—— 
AdminUserId
—— *
,
——* +
Concept
““ 
=
““ 
	Constants
““ 
.
““  "
CommissionMembership
““  4
+
““5 6
$char
““7 :
+
““; <
userInfo
““= E
.
““E F
UserName
““F N
,
““N O
Credit
”” 
=
”” 
	Constants
”” 
.
”” 
MembershipBonus
”” .
,
””. /
AffiliateUserName
‘‘ 
=
‘‘ "
affiliateBonusWinner
‘‘  4
.
‘‘4 5
UserName
‘‘5 =
,
‘‘= >
ConceptType
’’ 
=
’’ 
WalletConceptType
’’ +
.
’’+ ,
membership_bonus
’’, <
.
’’< =
ToString
’’= E
(
’’E F
)
’’F G
,
’’G H
AdminUserName
÷÷ 
=
÷÷ 
	Constants
÷÷ %
.
÷÷% &$
AdminEcosystemUserName
÷÷& <
}
◊◊ 	
;
◊◊	 

var
ŸŸ  
bonusPaymentResult
ŸŸ 
=
ŸŸ  
await
ŸŸ! &
_walletRepository
ŸŸ' 8
.
ŸŸ8 9
CreditTransaction
ŸŸ9 J
(
ŸŸJ K.
 creditTransactionForWinningBonus
ŸŸK k
)
ŸŸk l
;
ŸŸl m
if
€€ 

(
€€  
bonusPaymentResult
€€ 
is
€€ !
false
€€" '
)
€€' (
return
‹‹ 
;
‹‹ 
await
ﬁﬁ 
RemoveCacheKey
ﬁﬁ 
(
ﬁﬁ "
affiliateBonusWinner
ﬁﬁ 1
.
ﬁﬁ1 2
Id
ﬁﬁ2 4
,
ﬁﬁ4 5
	CacheKeys
ﬁﬁ6 ?
.
ﬁﬁ? @&
BalanceInformationModel2
ﬁﬁ@ X
)
ﬁﬁX Y
;
ﬁﬁY Z
await
‡‡  
_brevoEmailService
‡‡  
.
‡‡  !#
SendBonusConfirmation
‡‡! 6
(
‡‡6 7"
affiliateBonusWinner
‡‡7 K
,
‡‡K L
userInfo
‡‡M U
.
‡‡U V
UserName
‡‡V ^
??
‡‡_ a
string
‡‡b h
.
‡‡h i
Empty
‡‡i n
,
‡‡n o
_brandService
·· 
.
·· 
BrandId
·· !
)
··! "
;
··" #
}
‚‚ 
private
‰‰ 
async
‰‰ 
Task
‰‰ &
ExecuteMembershipPayment
‰‰ /
(
‰‰/ 0
WalletRequest
‰‰0 =
walletRequest
‰‰> K
,
‰‰K L
ICollection
‰‰M X
<
‰‰X Y
ProductRequest
‰‰Y g
>
‰‰g h
products
‰‰i q
)
‰‰q r
{
ÂÂ 
walletRequest
ÊÊ 
.
ÊÊ 
ProductsList
ÊÊ "
=
ÊÊ# $
products
ÊÊ% -
.
ÊÊ- .
Select
ÊÊ. 4
(
ÊÊ4 5
product
ÊÊ5 <
=>
ÊÊ= ?
new
ÊÊ@ C
ProductsRequests
ÊÊD T
{
ÁÁ 	
	IdProduct
ËË 
=
ËË 
product
ËË 
.
ËË  
	ProductId
ËË  )
,
ËË) *
Count
ÈÈ 
=
ÈÈ 
product
ÈÈ 
.
ÈÈ 
Quantity
ÈÈ $
}
ÍÍ 	
)
ÍÍ	 

.
ÍÍ
 
ToList
ÍÍ 
(
ÍÍ 
)
ÍÍ 
;
ÍÍ 
await
ÏÏ *
_coinPaymentsPaymentStrategy
ÏÏ *
.
ÏÏ* +&
ExecuteMembershipPayment
ÏÏ+ C
(
ÏÏC D
walletRequest
ÏÏD Q
)
ÏÏQ R
;
ÏÏR S
}
ÌÌ 
private
ÔÔ 
async
ÔÔ 
Task
ÔÔ 3
%RevertUnconfirmedOrUnpaidTransactions
ÔÔ <
(
ÔÔ< =
string
ÔÔ= C
idTransaction
ÔÔD Q
,
ÔÔQ R
string
ÔÔS Y
productsInfo
ÔÔZ f
)
ÔÔf g
{
 
if
ÒÒ 

(
ÒÒ 
string
ÒÒ 
.
ÒÒ 
IsNullOrEmpty
ÒÒ  
(
ÒÒ  !
idTransaction
ÒÒ! .
)
ÒÒ. /
)
ÒÒ/ 0
{
ÚÚ 	
_logger
ÛÛ 
.
ÛÛ 

LogWarning
ÛÛ 
(
ÛÛ 
$"
ÙÙ 
$str
ÙÙ f
{
ÙÙf g
idTransaction
ÙÙg t
}
ÙÙt u
"
ÙÙu v
)
ÙÙv w
;
ÙÙw x
return
ıı 
;
ıı 
}
ˆˆ 	
var
¯¯ 
invoice
¯¯ 
=
¯¯ 
await
¯¯  
_invoiceRepository
¯¯ .
.
¯¯. /'
GetInvoiceByReceiptNumber
¯¯/ H
(
¯¯H I
idTransaction
¯¯I V
,
¯¯V W
_brandService
¯¯X e
.
¯¯e f
BrandId
¯¯f m
)
¯¯m n
;
¯¯n o
if
˘˘ 

(
˘˘ 
invoice
˘˘ 
is
˘˘ 
null
˘˘ 
)
˘˘ 
{
˙˙ 	
_logger
˚˚ 
.
˚˚ 

LogWarning
˚˚ 
(
˚˚ 
$"
¸¸ 
$str
¸¸ {
{
¸¸{ |
idTransaction¸¸| â
}¸¸â ä
"¸¸ä ã
)¸¸ã å
;¸¸å ç
return
˝˝ 
;
˝˝ 
}
˛˛ 	
var
ÄÄ 
products
ÄÄ 
=
ÄÄ 
productsInfo
ÄÄ #
.
ÄÄ# $
ToJsonObject
ÄÄ$ 0
<
ÄÄ0 1
List
ÄÄ1 5
<
ÄÄ5 6
ProductRequest
ÄÄ6 D
>
ÄÄD E
>
ÄÄE F
(
ÄÄF G
)
ÄÄG H
;
ÄÄH I
if
ÅÅ 

(
ÅÅ 
products
ÅÅ 
is
ÅÅ 
null
ÅÅ 
||
ÅÅ 
!
ÅÅ  !
products
ÅÅ! )
.
ÅÅ) *
Any
ÅÅ* -
(
ÅÅ- .
)
ÅÅ. /
)
ÅÅ/ 0
{
ÇÇ 	
_logger
ÉÉ 
.
ÉÉ 

LogWarning
ÉÉ 
(
ÉÉ 
$"
ÑÑ 
$str
ÑÑ s
{
ÑÑs t
productsInfoÑÑt Ä
}ÑÑÄ Å
"ÑÑÅ Ç
)ÑÑÇ É
;ÑÑÉ Ñ
return
ÖÖ 
;
ÖÖ 
}
ÜÜ 	
_logger
àà 
.
àà 
LogInformation
àà 
(
àà 
$"
ââ 
$str
ââ [
{
ââ[ \
idTransaction
ââ\ i
}
ââi j
$str
ââj w
{
ââw x
productsââx Ä
.ââÄ Å
ToJsonStringââÅ ç
(ââç é
)ââé è
}ââè ê
"ââê ë
)ââë í
;ââí ì
try
ãã 
{
åå 	
bool
çç 
isMembership
çç 
=
çç 
products
çç  (
.
çç( )
Any
çç) ,
(
çç, -
p
çç- .
=>
çç/ 1
p
çç2 3
.
çç3 4
	ProductId
çç4 =
==
çç> @
$num
ççA B
)
ççB C
;
ççC D
if
éé 
(
éé 
isMembership
éé 
)
éé 
{
èè 
await
êê $
_accountServiceAdapter
êê ,
.
êê, -"
RevertActivationUser
êê- A
(
êêA B
invoice
êêB I
.
êêI J
AffiliateId
êêJ U
,
êêU V
_brandService
êêW d
.
êêd e
BrandId
êêe l
)
êêl m
;
êêm n
}
ëë 
var
ìì 
invoiceNumber
ìì 
=
ìì 
new
ìì  #
InvoiceNumber
ìì$ 1
{
ìì2 3 
InvoiceNumberValue
ìì4 F
=
ììG H
invoice
ììI P
.
ììP Q
Id
ììQ S
}
ììT U
;
ììU V
await
îî  
_invoiceRepository
îî $
.
îî$ %+
RevertCoinPaymentTransactions
îî% B
(
îîB C
new
îîC F
List
îîG K
<
îîK L
InvoiceNumber
îîL Y
>
îîY Z
{
îî[ \
invoiceNumber
îî] j
}
îîk l
)
îîl m
;
îîm n
_logger
ññ 
.
ññ 
LogInformation
ññ "
(
ññ" #
$"
óó 
$str
óó t
{
óót u
idTransactionóóu Ç
}óóÇ É
"óóÉ Ñ
)óóÑ Ö
;óóÖ Ü
}
òò 	
catch
ôô 
(
ôô 
	Exception
ôô 
ex
ôô 
)
ôô 
{
öö 	
_logger
õõ 
.
õõ 
LogError
õõ 
(
õõ 
ex
õõ 
,
õõ  
$"
úú 
$str
úú o
{
úúo p
idTransaction
úúp }
}
úú} ~
"
úú~ 
)úú Ä
;úúÄ Å
}
ùù 	
}
ûû 
public
†† 

async
†† 
Task
†† 
<
†† +
CoinPaymentWithdrawalResponse
†† 3
?
††3 4
>
††4 5"
CreateMassWithdrawal
††6 J
(
††J K
WalletsRequest
††K Y
[
††Y Z
]
††Z [
requests
††\ d
)
††d e
{
°° 
_logger
¢¢ 
.
¢¢ 
LogInformation
¢¢ 
(
¢¢ 
$"
££ 
$str
££ M
{
££M N
requests
££N V
.
££V W
ToJsonString
££W c
(
££c d
)
££d e
}
££e f
"
££f g
)
££g h
;
££h i
var
•• 
withdrawals
•• 
=
•• 
await
•• '
GetAddressesByAffiliateId
••  9
(
••9 :
requests
••: B
)
••B C
;
••C D

SortedList
ßß 
<
ßß 
string
ßß 
,
ßß 
string
ßß !
>
ßß! "
parms
ßß# (
=
ßß) *
new
ßß+ .

SortedList
ßß/ 9
<
ßß9 :
string
ßß: @
,
ßß@ A
string
ßßB H
>
ßßH I
{
®® 	
{
©© 
$str
©© 
,
©© 
$str
©© -
}
©©. /
}
™™ 	
;
™™	 

var
¨¨ 
tax
¨¨ 
=
¨¨ 
	Constants
¨¨ 
.
¨¨ 
CoinPaymentTax
¨¨ *
;
¨¨* +
int
≠≠ 
count
≠≠ 
=
≠≠ 
$num
≠≠ 
;
≠≠ 
foreach
ÆÆ 
(
ÆÆ 
var
ÆÆ 
w
ÆÆ 
in
ÆÆ 
withdrawals
ÆÆ %
)
ÆÆ% &
{
ØØ 	
decimal
∞∞ 
amountAfterTax
∞∞ "
=
∞∞# $
w
∞∞% &
.
∞∞& '
Amount
∞∞' -
-
∞∞. /
tax
∞∞0 3
;
∞∞3 4
string
±± 
prefix
±± 
=
±± 
$"
±± 
$str
±± #
{
±±# $
count
±±$ )
}
±±) *
$str
±±* +
"
±±+ ,
;
±±, -
parms
≤≤ 
.
≤≤ 
Add
≤≤ 
(
≤≤ 
$"
≤≤ 
{
≤≤ 
prefix
≤≤ 
}
≤≤  
$str
≤≤  (
"
≤≤( )
,
≤≤) *
amountAfterTax
≤≤+ 9
.
≤≤9 :
ToString
≤≤: B
(
≤≤B C
CultureInfo
≤≤C N
.
≤≤N O
InvariantCulture
≤≤O _
)
≤≤_ `
)
≤≤` a
;
≤≤a b
parms
≥≥ 
.
≥≥ 
Add
≥≥ 
(
≥≥ 
$"
≥≥ 
{
≥≥ 
prefix
≥≥ 
}
≥≥  
$str
≥≥  )
"
≥≥) *
,
≥≥* +
w
≥≥, -
.
≥≥- .
Address
≥≥. 5
)
≥≥5 6
;
≥≥6 7
parms
¥¥ 
.
¥¥ 
Add
¥¥ 
(
¥¥ 
$"
¥¥ 
{
¥¥ 
prefix
¥¥ 
}
¥¥  
$str
¥¥  *
"
¥¥* +
,
¥¥+ ,
w
¥¥- .
.
¥¥. /
Currency
¥¥/ 7
)
¥¥7 8
;
¥¥8 9
count
µµ 
++
µµ 
;
µµ 
}
∂∂ 	
var
∏∏ 
restResponse
∏∏ 
=
∏∏ 
await
∏∏  
CallApiAsync
∏∏! -
(
∏∏- .
$str
∏∏. F
,
∏∏F G
parms
∏∏H M
)
∏∏M N
;
∏∏N O
if
ππ 

(
ππ 
!
ππ 
restResponse
ππ 
.
ππ 
IsSuccessful
ππ &
)
ππ& '
throw
∫∫ 
new
∫∫ 
	Exception
∫∫ 
(
∫∫  
$"
∫∫  "
$str
∫∫" 5
{
∫∫5 6
restResponse
∫∫6 B
.
∫∫B C
StatusDescription
∫∫C T
}
∫∫T U
"
∫∫U V
)
∫∫V W
;
∫∫W X
var
ºº 
withdrawalResults
ºº 
=
ºº 
restResponse
ºº  ,
.
ºº, -
Content
ºº- 4
!
ºº4 5
.
ºº5 6
ToJsonObject
ºº6 B
<
ººB C+
CoinPaymentWithdrawalResponse
ººC `
>
ºº` a
(
ººa b
)
ººb c
;
ººc d
if
ΩΩ 

(
ΩΩ 
withdrawalResults
ΩΩ 
?
ΩΩ 
.
ΩΩ 
Result
ΩΩ %
==
ΩΩ& (
null
ΩΩ) -
)
ΩΩ- .
{
ææ 	
_logger
øø 
.
øø 

LogWarning
øø 
(
øø 
$str
øø o
)
øøo p
;
øøp q
return
¿¿ 
null
¿¿ 
;
¿¿ 
}
¡¡ 	
var
√√  
successfulRequests
√√ 
=
√√  
new
√√! $
List
√√% )
<
√√) *
WalletsRequest
√√* 8
>
√√8 9
(
√√9 :
)
√√: ;
;
√√; <
var
ƒƒ 
successfulIds
ƒƒ 
=
ƒƒ 
new
ƒƒ 
List
ƒƒ  $
<
ƒƒ$ %
long
ƒƒ% )
>
ƒƒ) *
(
ƒƒ* +
)
ƒƒ+ ,
;
ƒƒ, -
int
≈≈ 
index
≈≈ 
=
≈≈ 
$num
≈≈ 
;
≈≈ 
foreach
«« 
(
«« 
var
«« 
key
«« 
in
«« 
withdrawalResults
«« -
.
««- .
Result
««. 4
.
««4 5
Keys
««5 9
)
««9 :
{
»» 	
var
…… 
responseData
…… 
=
…… 
withdrawalResults
…… 0
.
……0 1
Result
……1 7
[
……7 8
key
……8 ;
]
……; <
;
……< =
if
ÀÀ 
(
ÀÀ 
responseData
ÀÀ 
.
ÀÀ 
Error
ÀÀ "
==
ÀÀ# %
$str
ÀÀ& *
)
ÀÀ* +
{
ÃÃ 
var
ÕÕ 
originalRequest
ÕÕ #
=
ÕÕ$ %
requests
ÕÕ& .
[
ÕÕ. /
index
ÕÕ/ 4
]
ÕÕ4 5
;
ÕÕ5 6 
successfulRequests
ŒŒ "
.
ŒŒ" #
Add
ŒŒ# &
(
ŒŒ& '
originalRequest
ŒŒ' 6
)
ŒŒ6 7
;
ŒŒ7 8
successfulIds
œœ 
.
œœ 
Add
œœ !
(
œœ! "
originalRequest
œœ" 1
.
œœ1 2
Id
œœ2 4
)
œœ4 5
;
œœ5 6
}
–– 
index
““ 
++
““ 
;
““ 
}
”” 	
var
’’ 
today
’’ 
=
’’ 
DateTime
’’ 
.
’’ 
Now
’’  
;
’’  !
foreach
◊◊ 
(
◊◊ 
var
◊◊ 
successfulRequest
◊◊ &
in
◊◊' ) 
successfulRequests
◊◊* <
)
◊◊< =
{
ÿÿ 	
try
ŸŸ 
{
⁄⁄ 
var
€€ 
user
€€ 
=
€€ 
await
€€  $
_accountServiceAdapter
€€! 7
.
€€7 8
GetUserInfo
€€8 C
(
€€C D
successfulRequest
€€D U
.
€€U V
AffiliateId
€€V a
,
€€a b
_brandService
‹‹ !
.
‹‹! "
BrandId
‹‹" )
)
‹‹) *
;
‹‹* +
if
ﬁﬁ 
(
ﬁﬁ 
user
ﬁﬁ 
==
ﬁﬁ 
null
ﬁﬁ  
)
ﬁﬁ  !
{
ﬂﬂ 
_logger
‡‡ 
.
‡‡ 

LogWarning
‡‡ &
(
‡‡& '
$"
·· 
$str
·· \
{
··\ ]
successfulRequest
··] n
.
··n o
AffiliateId
··o z
}
··z {
"
··{ |
)
··| }
;
··} ~
continue
‚‚ 
;
‚‚ 
}
„„ 
var
ÂÂ 
debitTransaction
ÂÂ $
=
ÂÂ% &
new
ÂÂ' *
Wallet
ÂÂ+ 1
{
ÊÊ 
AffiliateId
ÁÁ 
=
ÁÁ  !
successfulRequest
ÁÁ" 3
.
ÁÁ3 4
AffiliateId
ÁÁ4 ?
,
ÁÁ? @
UserId
ËË 
=
ËË 
$num
ËË 
,
ËË 
Credit
ÈÈ 
=
ÈÈ 
$num
ÈÈ 
,
ÈÈ 
Debit
ÍÍ 
=
ÍÍ 
successfulRequest
ÍÍ -
.
ÍÍ- .
Amount
ÍÍ. 4
,
ÍÍ4 5
Deferred
ÎÎ 
=
ÎÎ 
$num
ÎÎ  
,
ÎÎ  !
Status
ÏÏ 
=
ÏÏ 
true
ÏÏ !
,
ÏÏ! "
Concept
ÌÌ 
=
ÌÌ 
	Constants
ÌÌ '
.
ÌÌ' (
SendFundsConcept
ÌÌ( 8
,
ÌÌ8 9
Support
ÓÓ 
=
ÓÓ 
$num
ÓÓ 
,
ÓÓ  
Date
ÔÔ 
=
ÔÔ 
today
ÔÔ  
,
ÔÔ  !
Compression
 
=
  !
true
" &
,
& '
Detail
ÒÒ 
=
ÒÒ 
$str
ÒÒ ?
,
ÒÒ? @
	CreatedAt
ÚÚ 
=
ÚÚ 
today
ÚÚ  %
,
ÚÚ% &
	UpdatedAt
ÛÛ 
=
ÛÛ 
today
ÛÛ  %
,
ÛÛ% &
AffiliateUserName
ÙÙ %
=
ÙÙ& '
user
ÙÙ( ,
.
ÙÙ, -
UserName
ÙÙ- 5
??
ÙÙ6 8
$str
ÙÙ9 B
,
ÙÙB C
AdminUserName
ıı !
=
ıı" #
_brandService
ıı$ 1
.
ıı1 2
BrandId
ıı2 9
switch
ıı: @
{
ˆˆ 
$num
˜˜ 
=>
˜˜ 
$str
˜˜ -
,
˜˜- .
$num
¯¯ 
=>
¯¯ 
$str
¯¯ ,
,
¯¯, -
$num
˘˘ 
=>
˘˘ 
$str
˘˘ -
,
˘˘- .
$num
˙˙ 
=>
˙˙ 
$str
˙˙ /
,
˙˙/ 0
_
˚˚ 
=>
˚˚ 
$str
˚˚ -
}
¸¸ 
,
¸¸ 
ConceptType
˝˝ 
=
˝˝  !
WalletConceptType
˝˝" 3
.
˝˝3 4
balance_transfer
˝˝4 D
.
˝˝D E
ToString
˝˝E M
(
˝˝M N
)
˝˝N O
,
˝˝O P
BrandId
˛˛ 
=
˛˛ 
_brandService
˛˛ +
.
˛˛+ ,
BrandId
˛˛, 3
}
ˇˇ 
;
ˇˇ 
var
ÅÅ 
walletWithdrawal
ÅÅ $
=
ÅÅ% &
new
ÅÅ' *%
WalletWithDrawalRequest
ÅÅ+ B
{
ÇÇ 
AffiliateId
ÉÉ 
=
ÉÉ  !
user
ÉÉ" &
.
ÉÉ& '
Id
ÉÉ' )
,
ÉÉ) *
AffiliateUserName
ÑÑ %
=
ÑÑ& '
user
ÑÑ( ,
.
ÑÑ, -
UserName
ÑÑ- 5
??
ÑÑ6 8
$str
ÑÑ9 B
,
ÑÑB C
Amount
ÖÖ 
=
ÖÖ 
successfulRequest
ÖÖ .
.
ÖÖ. /
Amount
ÖÖ/ 5
,
ÖÖ5 6
IsProcessed
ÜÜ 
=
ÜÜ  !
true
ÜÜ" &
,
ÜÜ& '
Observation
áá 
=
áá  !
$"
áá" $
{
áá$ %
	Constants
áá% .
.
áá. /
SendFundsConcept
áá/ ?
}
áá? @
$str
áá@ A
{
ááA B
successfulRequest
ááB S
.
ááS T
Id
ááT V
}
ááV W
"
ááW X
,
ááX Y
AdminObservation
àà $
=
àà% &
$str
àà' E
,
ààE F
Date
ââ 
=
ââ 
today
ââ  
,
ââ  !
ResponseDate
ää  
=
ää! "
today
ää# (
,
ää( )!
RetentionPercentage
ãã '
=
ãã( )
	Constants
ãã* 3
.
ãã3 4

EmptyValue
ãã4 >
,
ãã> ?
Status
åå 
=
åå 
true
åå !
}
çç 
;
çç 
await
èè 
_walletRepository
èè '
.
èè' (
CreateWalletAsync
èè( 9
(
èè9 :
debitTransaction
èè: J
)
èèJ K
;
èèK L
await
êê &
_walletWithDrawalService
êê .
.
êê. /)
CreateWalletWithdrawalAsync
êê/ J
(
êêJ K
walletWithdrawal
êêK [
)
êê[ \
;
êê\ ]
await
íí 
RemoveCacheKey
íí $
(
íí$ %
successfulRequest
íí% 6
.
íí6 7
AffiliateId
íí7 B
,
ííB C
	CacheKeys
ííD M
.
ííM N&
BalanceInformationModel2
ííN f
)
ííf g
;
ííg h
}
ìì 
catch
îî 
(
îî 
	Exception
îî 
ex
îî 
)
îî  
{
ïï 
_logger
ññ 
.
ññ 
LogError
ññ  
(
ññ  !
$"
óó 
$str
óó a
{
óóa b
successfulRequest
óób s
.
óós t
AffiliateId
óót 
}óó Ä
$stróóÄ Ç
{óóÇ É
exóóÉ Ö
}óóÖ Ü
"óóÜ á
)óóá à
;óóà â
}
òò 
}
ôô 	
if
õõ 

(
õõ 
successfulIds
õõ 
.
õõ 
Count
õõ 
>
õõ  !
$num
õõ" #
)
õõ# $
{
úú 	
await
ùù )
UpdateSuccessfulWithdrawals
ùù -
(
ùù- .
successfulIds
ùù. ;
)
ùù; <
;
ùù< =
}
ûû 	
return
†† 
withdrawalResults
††  
;
††  !
}
°° 
private
££ 
async
££ 
Task
££ 
<
££ 
List
££ 
<
££ .
 CoinPaymentMassWithdrawalRequest
££ <
>
££< =
>
££= >'
GetAddressesByAffiliateId
££? X
(
££X Y
WalletsRequest
££Y g
[
££g h
]
££h i
requests
££j r
)
££r s
{
§§ 
List
•• 
<
•• .
 CoinPaymentMassWithdrawalRequest
•• -
>
••- .
withdrawals
••/ :
=
••; <
new
••= @
List
••A E
<
••E F.
 CoinPaymentMassWithdrawalRequest
••F f
>
••f g
(
••g h
)
••h i
;
••i j
foreach
ßß 
(
ßß 
var
ßß 
request
ßß 
in
ßß 
requests
ßß  (
)
ßß( )
{
®® 	
try
©© 
{
™™ 
var
´´ 
response
´´ 
=
´´ 
await
´´ $$
_accountServiceAdapter
´´% ;
.
´´; <*
GetAffiliateBtcByAffiliateId
´´< X
(
´´X Y
request
´´Y `
.
´´` a
AffiliateId
´´a l
,
´´l m
_brandService
´´n {
.
´´{ |
BrandId´´| É
)´´É Ñ
;´´Ñ Ö
if
≠≠ 
(
≠≠ 
response
≠≠ 
?
≠≠ 
.
≠≠ 
Content
≠≠ %
==
≠≠& (
null
≠≠) -
)
≠≠- .
{
ÆÆ 
_logger
ØØ 
.
ØØ 

LogWarning
ØØ &
(
ØØ& '
$"
ØØ' )
$str
ØØ) E
{
ØØE F
request
ØØF M
.
ØØM N
AffiliateId
ØØN Y
}
ØØY Z
"
ØØZ [
)
ØØ[ \
;
ØØ\ ]
continue
∞∞ 
;
∞∞ 
}
±± 
var
≥≥ 
userInfo
≥≥ 
=
≥≥ 
JsonConvert
≥≥ *
.
≥≥* +
DeserializeObject
≥≥+ <
<
≥≥< ="
AffiliateBtcResponse
≥≥= Q
>
≥≥Q R
(
≥≥R S
response
≥≥S [
.
≥≥[ \
Content
≥≥\ c
)
≥≥c d
;
≥≥d e
if
µµ 
(
µµ 
userInfo
µµ 
?
µµ 
.
µµ 
Data
µµ "
==
µµ# %
null
µµ& *
)
µµ* +
{
∂∂ 
_logger
∑∑ 
.
∑∑ 

LogWarning
∑∑ &
(
∑∑& '
$"
∑∑' )
$str
∑∑) L
{
∑∑L M
request
∑∑M T
.
∑∑T U
AffiliateId
∑∑U `
}
∑∑` a
"
∑∑a b
)
∑∑b c
;
∑∑c d
continue
∏∏ 
;
∏∏ 
}
ππ 
var
ªª 
	validData
ªª 
=
ªª 
userInfo
ªª  (
.
ªª( )
Data
ªª) -
.
ªª- .
Where
ªª. 3
(
ªª3 4
x
ªª4 5
=>
ªª6 8
x
ªª9 :
!=
ªª; =
null
ªª> B
)
ªªB C
.
ªªC D
ToArray
ªªD K
(
ªªK L
)
ªªL M
;
ªªM N
if
ºº 
(
ºº 
	validData
ºº 
.
ºº 
Length
ºº $
==
ºº% '
$num
ºº( )
)
ºº) *
{
ΩΩ 
_logger
ææ 
.
ææ 

LogWarning
ææ &
(
ææ& '
$"
ææ' )
$str
ææ) E
{
ææE F
request
ææF M
.
ææM N
AffiliateId
ææN Y
}
ææY Z
"
ææZ [
)
ææ[ \
;
ææ\ ]
continue
øø 
;
øø 
}
¿¿ 
var
¬¬ 

btcAddress
¬¬ 
=
¬¬  
	validData
¬¬! *
.
¬¬* +
FirstOrDefault
¬¬+ 9
(
¬¬9 :
x
¬¬: ;
=>
¬¬< >
!
¬¬? @
string
¬¬@ F
.
¬¬F G
IsNullOrEmpty
¬¬G T
(
¬¬T U
x
¬¬U V
.
¬¬V W
Address
¬¬W ^
)
¬¬^ _
)
¬¬_ `
?
¬¬` a
.
¬¬a b
Address
¬¬b i
;
¬¬i j
if
ƒƒ 
(
ƒƒ 
string
ƒƒ 
.
ƒƒ 
IsNullOrEmpty
ƒƒ (
(
ƒƒ( )

btcAddress
ƒƒ) 3
)
ƒƒ3 4
)
ƒƒ4 5
{
≈≈ 
_logger
∆∆ 
.
∆∆ 

LogWarning
∆∆ &
(
∆∆& '
$"
∆∆' )
$str
∆∆) R
{
∆∆R S
request
∆∆S Z
.
∆∆Z [
AffiliateId
∆∆[ f
}
∆∆f g
"
∆∆g h
)
∆∆h i
;
∆∆i j
continue
«« 
;
«« 
}
»» 
var
   

withdrawal
   
=
    
new
  ! $.
 CoinPaymentMassWithdrawalRequest
  % E
{
ÀÀ 
Amount
ÃÃ 
=
ÃÃ 
request
ÃÃ $
.
ÃÃ$ %
Amount
ÃÃ% +
,
ÃÃ+ ,
Address
ÕÕ 
=
ÕÕ 

btcAddress
ÕÕ (
,
ÕÕ( )
Currency
ŒŒ 
=
ŒŒ 
	Constants
ŒŒ (
.
ŒŒ( )%
CoinPaymentsBnbCurrency
ŒŒ) @
}
œœ 
;
œœ 
withdrawals
—— 
.
—— 
Add
—— 
(
——  

withdrawal
——  *
)
——* +
;
——+ ,
_logger
““ 
.
““ 
LogInformation
““ %
(
““% &
$"
““& (
$str
““( Q
{
““Q R
request
““R Y
.
““Y Z
AffiliateId
““Z e
}
““e f
$str
““f v
{
““v w

btcAddress““w Å
}““Å Ç
"““Ç É
)““É Ñ
;““Ñ Ö
}
”” 
catch
‘‘ 
(
‘‘ 
	Exception
‘‘ 
ex
‘‘ 
)
‘‘  
{
’’ 
_logger
÷÷ 
.
÷÷ 
LogError
÷÷  
(
÷÷  !
ex
÷÷! #
,
÷÷# $
$"
÷÷% '
$str
÷÷' N
{
÷÷N O
request
÷÷O V
.
÷÷V W
AffiliateId
÷÷W b
}
÷÷b c
"
÷÷c d
)
÷÷d e
;
÷÷e f
}
◊◊ 
}
ÿÿ 	
return
⁄⁄ 
withdrawals
⁄⁄ 
;
⁄⁄ 
}
€€ 
private
›› 
async
›› 
Task
›› 
RemoveCacheKey
›› %
(
››% &
int
››& )
affiliateId
››* 5
,
››5 6
string
››7 =
	stringKey
››> G
)
››G H
{
ﬁﬁ 
var
ﬂﬂ 
key
ﬂﬂ 
=
ﬂﬂ 
string
ﬂﬂ 
.
ﬂﬂ 
Format
ﬂﬂ 
(
ﬂﬂ  
	stringKey
ﬂﬂ  )
,
ﬂﬂ) *
affiliateId
ﬂﬂ+ 6
)
ﬂﬂ6 7
;
ﬂﬂ7 8
var
‡‡ 
	existsKey
‡‡ 
=
‡‡ 
await
‡‡ 
_redisCache
‡‡ )
.
‡‡) *
	KeyExists
‡‡* 3
(
‡‡3 4
key
‡‡4 7
)
‡‡7 8
;
‡‡8 9
if
‚‚ 

(
‚‚ 
	existsKey
‚‚ 
)
‚‚ 
await
„„ 
_redisCache
„„ 
.
„„ 
Delete
„„ $
(
„„$ %
key
„„% (
)
„„( )
;
„„) *
}
‰‰ 
private
ÊÊ 
async
ÊÊ 
Task
ÊÊ )
UpdateSuccessfulWithdrawals
ÊÊ 2
(
ÊÊ2 3
List
ÊÊ3 7
<
ÊÊ7 8
long
ÊÊ8 <
>
ÊÊ< =%
successfulWithdrawalIds
ÊÊ> U
)
ÊÊU V
{
ÁÁ 
_logger
ËË 
.
ËË 
LogInformation
ËË 
(
ËË 
$"
ÈÈ 
$str
ÈÈ R
{
ÈÈR S%
successfulWithdrawalIds
ÈÈS j
.
ÈÈj k
ToJsonString
ÈÈk w
(
ÈÈw x
)
ÈÈx y
}
ÈÈy z
$strÈÈz í
"ÈÈí ì
)ÈÈì î
;ÈÈî ï
var
ÍÍ 
withdrawals
ÍÍ 
=
ÍÍ 
await
ÍÍ &
_walletRequestRepository
ÍÍ  8
.
ÍÍ8 9$
GetWalletRequestsByIds
ÍÍ9 O
(
ÍÍO P%
successfulWithdrawalIds
ÍÍP g
)
ÍÍg h
;
ÍÍh i
foreach
ÏÏ 
(
ÏÏ 
var
ÏÏ 

withdrawal
ÏÏ 
in
ÏÏ  "
withdrawals
ÏÏ# .
)
ÏÏ. /
{
ÌÌ 	
_logger
ÓÓ 
.
ÓÓ 
LogDebug
ÓÓ 
(
ÓÓ 
$"
ÔÔ 
$str
ÔÔ e
{
ÔÔe f

withdrawal
ÔÔf p
.
ÔÔp q
Id
ÔÔq s
}
ÔÔs t
"
ÔÔt u
)
ÔÔu v
;
ÔÔv w

withdrawal
 
.
 
Status
 
=
 
(
  !
int
! $
)
$ %
WithdrawalStatus
% 5
.
5 6
	Completed
6 ?
;
? @

withdrawal
ÒÒ 
.
ÒÒ 
	UpdatedAt
ÒÒ  
=
ÒÒ! "
DateTime
ÒÒ# +
.
ÒÒ+ ,
Now
ÒÒ, /
;
ÒÒ/ 0
}
ÚÚ 	
await
ÙÙ &
_walletRequestRepository
ÙÙ &
.
ÙÙ& '+
UpdateBulkWalletRequestsAsync
ÙÙ' D
(
ÙÙD E
withdrawals
ÙÙE P
)
ÙÙP Q
;
ÙÙQ R
_logger
ıı 
.
ıı 
LogInformation
ıı 
(
ıı 
$"
ıı !
$str
ıı! r
"
ıır s
)
ııs t
;
ııt u
}
ˆˆ 
}˜˜  X
VC:\HeroSystem\walletService\WalletService.Core\Services\EcoPoolConfigurationService.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Services

 %
;

% &
public 
class '
EcoPoolConfigurationService (
:) *
BaseService+ 6
,6 7(
IEcoPoolConfigurationService8 T
{ 
private 
readonly +
IEcoPoolConfigurationRepository 4(
_poolConfigurationRepository5 Q
;Q R
public 
'
EcoPoolConfigurationService &
(& '+
IEcoPoolConfigurationRepository ''
poolConfigurationRepository( C
,C D
IMapper 
mapper( .
). /
:0 1
base2 6
(6 7
mapper7 =
)= >
=> 
(
_poolConfigurationRepository '
=( )'
poolConfigurationRepository* E
;E F
public 

async 
Task 
< !
ModelConfigurationDto +
?+ ,
>, -*
GetEcoPoolDefaultConfiguration. L
(L M
)M N
{ 
var 
configuration 
= 
await !(
_poolConfigurationRepository" >
.> ?
GetConfiguration? O
(O P
)P Q
;Q R
return 
configuration 
is 
null  $
?% &
null' +
:, -
Mapper. 4
.4 5
Map5 8
<8 9!
ModelConfigurationDto9 N
>N O
(O P
configurationP ]
)] ^
;^ _
} 
public 

async 
Task 
< !
ModelConfigurationDto +
>+ ,.
"CreateOrUpdateEcoPoolConfiguration- O
(O P'
EcoPoolConfigurationRequestP k
requestl s
)s t
{ 
var 
configuration 
= 
await !(
_poolConfigurationRepository" >
.> ?
GetConfiguration? O
(O P
)P Q
;Q R
if!! 

(!! 
configuration!! 
is!! 
null!! !
)!!! "
configuration"" 
="" 
await"" !
CreateEcoPoolModel""" 4
(""4 5
request""5 <
)""< =
;""= >
else## 
configuration$$ 
=$$ 
await$$ !
UpdateEcoPoolModel$$" 4
($$4 5
request$$5 <
,$$< =
configuration$$> K
)$$K L
;$$L M
return&& 
Mapper&& 
.&& 
Map&& 
<&& !
ModelConfigurationDto&& /
>&&/ 0
(&&0 1
configuration&&1 >
)&&> ?
;&&? @
}'' 
private** 
async** 
Task** 
<** 
ModelConfiguration** )
>**) *
CreateEcoPoolModel**+ =
(**= >'
EcoPoolConfigurationRequest**> Y
request**Z a
)**a b
{++ 
var,, 

listLevels,, 
=,, 
new,, 
List,, !
<,,! "#
ModelConfigurationLevel,," 9
>,,9 :
(,,: ;
),,; <
;,,< =
var-- 
today-- 
=-- 
DateTime-- !
.--! "
Today--" '
;--' (
var// 
configuration// 
=// 
new// 
ModelConfiguration//  2
{00 	#
CompanyPercentageLevels11 #
=11$ %
request11& -
.11- .#
CompanyPercentageLevels11. E
,11E F
CompanyPercentage22 
=22$ %
request22& -
.22- .
CompanyPercentage22. ?
,22? @
ModelPercentage33 
=33" #
request33$ +
.33+ ,
EcoPoolPercentage33, =
,33= >
MaxGainLimit44 
=44$ %
request44& -
.44- .
MaxGainLimit44. :
,44: ;
DateInit55 
=55$ %
request55& -
.55- .
DateInit55. 6
,556 7
DateEnd66 
=66$ %
request66& -
.66- .
DateEnd66. 5
,665 6
Case77 
=77$ %
request77& -
.77- .
Case77. 2
,772 3
	CreatedAt88 
=88$ %
today88& +
,88+ ,
	UpdatedAt99 
=99$ %
today99& +
,99+ ,
}:: 	
;::	 

configuration<< 
=<< 
await<< (
_poolConfigurationRepository<< :
.<<: ;
CreateConfiguration<<; N
(<<N O
configuration<<O \
)<<\ ]
;<<] ^
var>> 
index>> 
=>> 
$num>> 
;>> 
foreach?? 
(?? 
var?? 
level?? 
in?? 
request?? %
.??% &
Levels??& ,
)??, -
{@@ 	
indexAA 
++AA 
;AA 
varBB 
ecoPoolLevelsBB 
=BB 
newBB  ##
ModelConfigurationLevelBB$ ;
{CC 
LevelDD 
=DD' (
indexDD) .
,DD. /"
EcopoolConfigurationIdEE &
=EE' (
configurationEE) 6
.EE6 7
IdEE7 9
,EE9 :
	CreatedAtFF 
=FF' (
todayFF) .
,FF. /
	UpdatedAtGG 
=GG' (
todayGG) .
,GG. /

PercentageHH 
=HH' (
levelHH) .
.HH. /

PercentageHH/ 9
}II 
;II 

listLevelsKK 
.KK 
AddKK 
(KK 
ecoPoolLevelsKK (
)KK( )
;KK) *
}LL 	
awaitNN (
_poolConfigurationRepositoryNN *
.NN* +%
CreateConfigurationLevelsNN+ D
(NND E

listLevelsNNE O
)NNO P
;NNP Q
returnPP 
configurationPP 
;PP 
}QQ 
privateTT 
asyncTT 
TaskTT 
<TT 
ModelConfigurationTT )
>TT) *
UpdateEcoPoolModelTT+ =
(TT= >'
EcoPoolConfigurationRequestTT> Y
requestTTZ a
,TTa b
ModelConfigurationTTc u
configuration	TTv É
)
TTÉ Ñ
{UU 
varVV 

listLevelsVV 
=VV 
newVV 
ListVV !
<VV! "#
ModelConfigurationLevelVV" 9
>VV9 :
(VV: ;
)VV; <
;VV< =
varWW 
todayWW 
=WW 
DateTimeWW !
.WW! "
TodayWW" '
;WW' (
configurationYY 
.YY #
CompanyPercentageLevelsYY -
=YY. /
requestYY0 7
.YY7 8#
CompanyPercentageLevelsYY8 O
;YYO P
configurationZZ 
.ZZ 
CompanyPercentageZZ '
=ZZ. /
requestZZ0 7
.ZZ7 8
CompanyPercentageZZ8 I
;ZZI J
configuration[[ 
.[[ 
ModelPercentage[[ %
=[[, -
request[[. 5
.[[5 6
EcoPoolPercentage[[6 G
;[[G H
configuration\\ 
.\\ 
MaxGainLimit\\ "
=\\. /
request\\0 7
.\\7 8
MaxGainLimit\\8 D
;\\D E
configuration]] 
.]] 
DateInit]] 
=]]. /
request]]0 7
.]]7 8
DateInit]]8 @
;]]@ A
configuration^^ 
.^^ 
DateEnd^^ 
=^^. /
request^^0 7
.^^7 8
DateEnd^^8 ?
;^^? @
configuration__ 
.__ 
Case__ 
=__. /
request__0 7
.__7 8
Case__8 <
;__< =
configuration`` 
.`` 
	CreatedAt`` 
=``. /
today``0 5
;``5 6
configurationaa 
.aa 
	UpdatedAtaa 
=aa. /
todayaa0 5
;aa5 6
configurationcc 
=cc 
awaitcc (
_poolConfigurationRepositorycc :
.cc: ;
UpdateConfigurationcc; N
(ccN O
configurationccO \
)cc\ ]
;cc] ^
awaitdd (
_poolConfigurationRepositorydd *
.dd* +(
DeleteAllLevelsConfigurationdd+ G
(ddG H
configurationddH U
.ddU V
IdddV X
)ddX Y
;ddY Z
varff 
indexff 
=ff 
$numff 
;ff 
foreachgg 
(gg 
vargg 
levelgg 
ingg 
requestgg %
.gg% &
Levelsgg& ,
)gg, -
{hh 	
indexii 
++ii 
;ii 
varjj 
ecoPoolLevelsjj 
=jj 
newjj  ##
ModelConfigurationLeveljj$ ;
{kk 
Levelll 
=ll' (
indexll) .
,ll. /"
EcopoolConfigurationIdmm &
=mm' (
configurationmm) 6
.mm6 7
Idmm7 9
,mm9 :
	CreatedAtnn 
=nn' (
todaynn) .
,nn. /
	UpdatedAtoo 
=oo' (
todayoo) .
,oo. /

Percentagepp 
=pp' (
levelpp) .
.pp. /

Percentagepp/ 9
}qq 
;qq 

listLevelsss 
.ss 
Addss 
(ss 
ecoPoolLevelsss (
)ss( )
;ss) *
}tt 	
awaitvv (
_poolConfigurationRepositoryvv *
.vv* +%
CreateConfigurationLevelsvv+ D
(vvD E

listLevelsvvE O
)vvO P
;vvP Q
returnxx 
configurationxx 
;xx 
}yy 
public{{ 

async{{ 
Task{{ 
<{{ 
int{{ 
>{{ !
GetProgressPercentage{{ 0
({{0 1
int{{1 4
configurationId{{5 D
){{D E
{|| 
var}} 
result}} 
=}} 
await}} (
_poolConfigurationRepository}} 7
.}}7 8!
GetProgressPercentage}}8 M
(}}M N
configurationId}}N ]
)}}] ^
;}}^ _
if 

( 
result 
is 
null 
|| 
result $
.$ %
	Processed% .
is/ 1
$num2 3
)3 4
return
ÄÄ 
$num
ÄÄ 
;
ÄÄ 
if
ÇÇ 

(
ÇÇ 
result
ÇÇ 
.
ÇÇ 
Totals
ÇÇ 
is
ÇÇ 
$num
ÇÇ 
)
ÇÇ 
return
ÉÉ 
$num
ÉÉ 
;
ÉÉ 
var
ÑÑ 
valueResult
ÑÑ 
=
ÑÑ 
(
ÑÑ 
result
ÑÑ !
.
ÑÑ! "
	Processed
ÑÑ" +
*
ÑÑ, -
$num
ÑÑ. 1
)
ÑÑ1 2
/
ÑÑ3 4
result
ÑÑ5 ;
.
ÑÑ; <
Totals
ÑÑ< B
;
ÑÑB C
return
ÖÖ 
valueResult
ÖÖ 
??
ÖÖ 
$num
ÖÖ 
;
ÖÖ  
}
ÜÜ 
}àà È∫
NC:\HeroSystem\walletService\WalletService.Core\Services\EcosystemPdfService.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Services

 %
;

% &
public 
class 
EcosystemPdfService  
:! " 
IEcosystemPdfService# 7
{ 
public 

async 
Task 
< 
byte 
[ 
] 
> 
GenerateInvoice -
(- .
UserInfoResponse. >
userInfo? G
,G H#
DebitTransactionRequestI `
invoicea h
,h i
InvoicesSpResponse 

spResponse %
)% &
{ 
var 
date 
= 
DateTime 
. 
Now 
.  
ToString  (
(( )
$str) 5
)5 6
;6 7
var 
totalTax 
= 
$num 
; 
var 
subTotal 
= 
$num 
; 
var 
totalDiscount 
= 
$num 
; 
var 
workingDirectory 
= 
Path #
.# $
GetDirectoryName$ 4
(4 5
Assembly5 =
.= > 
GetExecutingAssembly> R
(R S
)S T
.T U
LocationU ]
)] ^
;^ _
var 
	separator 
= 
Path 
. "
DirectorySeparatorChar 3
;3 4
var 
pathFile 
= 
$" 
{ 
workingDirectory *
}* +
{+ ,
	separator, 5
}5 6
$str6 <
{< =
	separator= F
}F G
$strG O
"O P
;P Q
return 
await 
Task 
. 
Run 
( 
( 
)  
=>! #
{ 	
var 
document 
= 
Document #
. 
Create 
( 
doc 
=> 
{ 
doc 
. 
Page 
( 
page !
=>" $
{ 
page   
.   
Margin   #
(  # $
$num  $ &
)  & '
;  ' (
page"" 
."" 
Header"" #
(""# $
)""$ %
.""% &
ShowOnce""& .
("". /
)""/ 0
.""0 1
Row""1 4
(""4 5
row""5 8
=>""9 ;
{## 
var$$ 
image$$  %
=$$& '
Image$$( -
.$$- .
FromFile$$. 6
($$6 7
pathFile$$7 ?
)$$? @
;$$@ A
row%% 
.%%  
ConstantItem%%  ,
(%%, -
$num%%- 0
)%%0 1
.%%1 2
	Container%%2 ;
(%%; <
)%%< =
.%%= >
Image%%> C
(%%C D
image%%D I
)%%I J
;%%J K
row'' 
.''  
RelativeItem''  ,
('', -
)''- .
.''. /
Column''/ 5
(''5 6
col''6 9
=>'': <
{(( 
col))  #
.))# $
Item))$ (
())( )
)))) *
.))* +

AlignRight))+ 5
())5 6
)))6 7
.))7 8

Background))8 B
())B C
$str))C L
)))L M
.))M N
Border))N T
())T U
$num))U V
)))V W
.))W X
BorderColor))X c
())c d
$str))d m
)))m n
.**$ %
AlignCenter**% 0
(**0 1
)**1 2
.++$ %
Text++% )
(++) *
$"++* ,
$str++, B
{++B C

spResponse++C M
.++M N
Id++N P
}++P Q
"++Q R
)++R S
.,,$ %
	FontColor,,% .
(,,. /
$str,,/ 5
),,5 6
;,,6 7
col..  #
...# $
Item..$ (
(..( )
)..) *
...* +

AlignRight..+ 5
(..5 6
)..6 7
...7 8
Text..8 <
(..< =
$str..= q
)..q r
.//$ %
FontSize//% -
(//- .
$num//. 0
)//0 1
;//1 2
col00  #
.00# $
Item00$ (
(00( )
)00) *
.00* +

AlignRight00+ 5
(005 6
)006 7
.007 8
Text008 <
(00< =
$str00= R
)00R S
.00S T
FontSize00T \
(00\ ]
$num00] _
)00_ `
;00` a
col11  #
.11# $
Item11$ (
(11( )
)11) *
.11* +

AlignRight11+ 5
(115 6
)116 7
.22$ %
Text22% )
(22) *
$str33( y
)33y z
.44$ %
FontSize44% -
(44- .
$num44. 0
)440 1
;441 2
col55  #
.55# $
Item55$ (
(55( )
)55) *
.55* +

AlignRight55+ 5
(555 6
)556 7
.557 8
Text558 <
(55< =
$str55= S
)55S T
.55T U
FontSize55U ]
(55] ^
$num55^ `
)55` a
;55a b
col66  #
.66# $
Item66$ (
(66( )
)66) *
.66* +

AlignRight66+ 5
(665 6
)666 7
.667 8
Text668 <
(66< =
$str66= b
)66b c
.66c d
FontSize66d l
(66l m
$num66m o
)66o p
;66p q
col77  #
.77# $
Item77$ (
(77( )
)77) *
.77* +

AlignRight77+ 5
(775 6
)776 7
.777 8
Text778 <
(77< =
date77= A
)77A B
.77B C
FontSize77C K
(77K L
$num77L N
)77N O
;77O P
}88 
)88 
;88 
}99 
)99 
;99 
page;; 
.;; 
Content;; $
(;;$ %
);;% &
.;;& '
PaddingVertical;;' 6
(;;6 7
$num;;7 9
);;9 :
.;;: ;
Column;;; A
(;;A B
col1;;B F
=>;;G I
{<< 
col1==  
.==  !
Item==! %
(==% &
)==& '
.==' (

PaddingTop==( 2
(==2 3
$num==3 5
)==5 6
.==6 7
Row==7 :
(==: ;
row==; >
=>==? A
{>> 
row??  #
.??# $
RelativeItem??$ 0
(??0 1
)??1 2
.??2 3
Column??3 9
(??9 :
col2??: >
=>??? A
{@@  !
col2AA$ (
.AA( )
ItemAA) -
(AA- .
)AA. /
.AA/ 0
	AlignLeftAA0 9
(AA9 :
)AA: ;
.AA; <
TextAA< @
(AA@ A
$strAAA T
)AAT U
.AAU V
	UnderlineAAV _
(AA_ `
)AA` a
.AAa b
BoldAAb f
(AAf g
)AAg h
;AAh i
col2CC$ (
.CC( )
ItemCC) -
(CC- .
)CC. /
.CC/ 0
TextCC0 4
(CC4 5
txtCC5 8
=>CC9 ;
{DD$ %
txtEE( +
.EE+ ,
SpanEE, 0
(EE0 1
$strEE1 ;
)EE; <
.EE< =
SemiBoldEE= E
(EEE F
)EEF G
.EEG H
FontSizeEEH P
(EEP Q
$numEEQ S
)EES T
;EET U
txtFF( +
.FF+ ,
SpanFF, 0
(FF0 1
$"FF1 3
{FF3 4
userInfoFF4 <
.FF< =
NameFF= A
}FFA B
$strFFB C
{FFC D
userInfoFFD L
.FFL M
LastNameFFM U
}FFU V
"FFV W
)FFW X
.FFX Y
FontSizeFFY a
(FFa b
$numFFb d
)FFd e
;FFe f
}GG$ %
)GG% &
;GG& '
col2II$ (
.II( )
ItemII) -
(II- .
)II. /
.II/ 0
TextII0 4
(II4 5
txtII5 8
=>II9 ;
{JJ$ %
txtKK( +
.KK+ ,
SpanKK, 0
(KK0 1
$strKK1 9
)KK9 :
.KK: ;
SemiBoldKK; C
(KKC D
)KKD E
.KKE F
FontSizeKKF N
(KKN O
$numKKO Q
)KKQ R
;KKR S
txtLL( +
.LL+ ,
SpanLL, 0
(LL0 1
userInfoLL1 9
.LL9 :
CountryLL: A
!LLA B
.LLB C
NameLLC G
)LLG H
.LLH I
FontSizeLLI Q
(LLQ R
$numLLR T
)LLT U
;LLU V
}MM$ %
)MM% &
;MM& '
col2OO$ (
.OO( )
ItemOO) -
(OO- .
)OO. /
.OO/ 0
TextOO0 4
(OO4 5
txtOO5 8
=>OO9 ;
{PP$ %
txtQQ( +
.QQ+ ,
SpanQQ, 0
(QQ0 1
$strQQ1 ;
)QQ; <
.QQ< =
SemiBoldQQ= E
(QQE F
)QQF G
.QQG H
FontSizeQQH P
(QQP Q
$numQQQ S
)QQS T
;QQT U
txtRR( +
.RR+ ,
SpanRR, 0
(RR0 1
userInfoRR1 9
.RR9 :
CityRR: >
)RR> ?
.RR? @
FontSizeRR@ H
(RRH I
$numRRI K
)RRK L
;RRL M
}SS$ %
)SS% &
;SS& '
}TT  !
)TT! "
;TT" #
rowVV  #
.VV# $
RelativeItemVV$ 0
(VV0 1
)VV1 2
.VV2 3
ColumnVV3 9
(VV9 :
col2VV: >
=>VV? A
{WW  !
col2XX$ (
.XX( )
ItemXX) -
(XX- .
)XX. /
.XX/ 0

AlignRightXX0 :
(XX: ;
)XX; <
.XX< =
TextXX= A
(XXA B
txtXXB E
=>XXF H
{YY$ %
txtZZ( +
.ZZ+ ,
SpanZZ, 0
(ZZ0 1
$strZZ1 <
)ZZ< =
.ZZ= >
SemiBoldZZ> F
(ZZF G
)ZZG H
.ZZH I
FontSizeZZI Q
(ZZQ R
$numZZR T
)ZZT U
;ZZU V
txt[[( +
.[[+ ,
Span[[, 0
([[0 1
userInfo[[1 9
.[[9 :
Phone[[: ?
)[[? @
.[[@ A
FontSize[[A I
([[I J
$num[[J L
)[[L M
;[[M N
}\\$ %
)\\% &
;\\& '
col2^^$ (
.^^( )
Item^^) -
(^^- .
)^^. /
.^^/ 0

AlignRight^^0 :
(^^: ;
)^^; <
.^^< =
Text^^= A
(^^A B
txt^^B E
=>^^F H
{__$ %
txt``( +
.``+ ,
Span``, 0
(``0 1
$str``1 O
)``O P
.``P Q
SemiBold``Q Y
(``Y Z
)``Z [
.``[ \
FontSize``\ d
(``d e
$num``e g
)``g h
;``h i
txtaa( +
.aa+ ,
Spanaa, 0
(aa0 1
userInfoaa1 9
.aa9 :
UserNameaa: B
)aaB C
.aaC D
FontSizeaaD L
(aaL M
$numaaM O
)aaO P
;aaP Q
}bb$ %
)bb% &
;bb& '
col2dd$ (
.dd( )
Itemdd) -
(dd- .
)dd. /
.dd/ 0

AlignRightdd0 :
(dd: ;
)dd; <
.dd< =
Textdd= A
(ddA B
txtddB E
=>ddF H
{ee$ %
txtff( +
.ff+ ,
Spanff, 0
(ff0 1
$strff1 :
)ff: ;
.ff; <
SemiBoldff< D
(ffD E
)ffE F
.ffF G
FontSizeffG O
(ffO P
$numffP R
)ffR S
;ffS T
txtgg( +
.gg+ ,
Spangg, 0
(gg0 1
userInfogg1 9
.gg9 :
Emailgg: ?
)gg? @
.gg@ A
FontSizeggA I
(ggI J
$numggJ L
)ggL M
;ggM N
}hh$ %
)hh% &
;hh& '
col2jj$ (
.jj( )
Itemjj) -
(jj- .
)jj. /
.jj/ 0

AlignRightjj0 :
(jj: ;
)jj; <
.jj< =
Textjj= A
(jjA B
txtjjB E
=>jjF H
{kk$ %
txtll( +
.ll+ ,
Spanll, 0
(ll0 1
$strll1 >
)ll> ?
.ll? @
SemiBoldll@ H
(llH I
)llI J
.llJ K
FontSizellK S
(llS T
$numllT V
)llV W
;llW X
txtmm( +
.mm+ ,
Spanmm, 0
(mm0 1
userInfomm1 9
.mm9 :
Addressmm: A
)mmA B
.mmB C
FontSizemmC K
(mmK L
$nummmL N
)mmN O
;mmO P
}nn$ %
)nn% &
;nn& '
col2pp$ (
.pp( )
Itempp) -
(pp- .
)pp. /
.pp/ 0

AlignRightpp0 :
(pp: ;
)pp; <
.pp< =
Textpp= A
(ppA B
txtppB E
=>ppF H
{qq$ %
ifrr( *
(rr+ ,
!rr, -
stringrr- 3
.rr3 4
IsNullOrEmptyrr4 A
(rrA B

spResponserrB L
.rrL M
ReasonrrM S
)rrS T
)rrT U
{ss( )
txttt, /
.tt/ 0
Spantt0 4
(tt4 5
$strtt5 K
)ttK L
.ttL M
SemiBoldttM U
(ttU V
)ttV W
.ttW X
FontSizettX `
(tt` a
$numtta c
)ttc d
;ttd e
txtuu, /
.uu/ 0
Spanuu0 4
(uu4 5

spResponseuu5 ?
.uu? @
Reasonuu@ F
)uuF G
.uuG H
FontSizeuuH P
(uuP Q
$numuuQ S
)uuS T
;uuT U
}vv( )
}ww$ %
)ww% &
;ww& '
}xx  !
)xx! "
;xx" #
}yy 
)yy 
;yy 
col1||  
.||  !
Item||! %
(||% &
)||& '
.||' (
LineHorizontal||( 6
(||6 7
$num||7 ;
)||; <
;||< =
col1~~  
.~~  !
Item~~! %
(~~% &
)~~& '
.~~' (
Table~~( -
(~~- .
tabla~~. 3
=>~~4 6
{ 
tabla
ÄÄ  %
.
ÄÄ% &
ColumnsDefinition
ÄÄ& 7
(
ÄÄ7 8
columns
ÄÄ8 ?
=>
ÄÄ@ B
{
ÅÅ  !
columns
ÇÇ$ +
.
ÇÇ+ ,
RelativeColumn
ÇÇ, :
(
ÇÇ: ;
$num
ÇÇ; <
)
ÇÇ< =
;
ÇÇ= >
columns
ÉÉ$ +
.
ÉÉ+ ,
RelativeColumn
ÉÉ, :
(
ÉÉ: ;
)
ÉÉ; <
;
ÉÉ< =
columns
ÑÑ$ +
.
ÑÑ+ ,
RelativeColumn
ÑÑ, :
(
ÑÑ: ;
)
ÑÑ; <
;
ÑÑ< =
columns
ÖÖ$ +
.
ÖÖ+ ,
RelativeColumn
ÖÖ, :
(
ÖÖ: ;
)
ÖÖ; <
;
ÖÖ< =
columns
ÜÜ$ +
.
ÜÜ+ ,
RelativeColumn
ÜÜ, :
(
ÜÜ: ;
)
ÜÜ; <
;
ÜÜ< =
}
áá  !
)
áá! "
;
áá" #
tabla
ââ  %
.
ââ% &
Header
ââ& ,
(
ââ, -
header
ââ- 3
=>
ââ4 6
{
ää  !
header
ãã$ *
.
ãã* +
Cell
ãã+ /
(
ãã/ 0
)
ãã0 1
.
ãã1 2

Background
ãã2 <
(
ãã< =
$str
ãã= F
)
ããF G
.
ããG H
Padding
ããH O
(
ããO P
$num
ããP Q
)
ããQ R
.
ããR S
Text
ããS W
(
ããW X
$str
ããX b
)
ããb c
.
ããc d
	FontColor
ããd m
(
ããm n
$str
ããn t
)
ããt u
;
ããu v
header
åå$ *
.
åå* +
Cell
åå+ /
(
åå/ 0
)
åå0 1
.
åå1 2

Background
åå2 <
(
åå< =
$str
åå= F
)
ååF G
.
ååG H
Padding
ååH O
(
ååO P
$num
ååP Q
)
ååQ R
.
ååR S
Text
ååS W
(
ååW X
$str
ååX b
)
ååb c
.
ååc d
	FontColor
ååd m
(
ååm n
$str
åån t
)
ååt u
;
ååu v
header
çç$ *
.
çç* +
Cell
çç+ /
(
çç/ 0
)
çç0 1
.
çç1 2

Background
çç2 <
(
çç< =
$str
çç= F
)
ççF G
.
ççG H
Padding
ççH O
(
ççO P
$num
ççP Q
)
ççQ R
.
ççR S
Text
ççS W
(
ççW X
$str
ççX `
)
çç` a
.
çça b
	FontColor
ççb k
(
ççk l
$str
ççl r
)
ççr s
;
ççs t
header
éé$ *
.
éé* +
Cell
éé+ /
(
éé/ 0
)
éé0 1
.
éé1 2

Background
éé2 <
(
éé< =
$str
éé= F
)
ééF G
.
ééG H
Padding
ééH O
(
ééO P
$num
ééP Q
)
ééQ R
.
ééR S
Text
ééS W
(
ééW X
$str
ééX c
)
ééc d
.
ééd e
	FontColor
éée n
(
één o
$str
ééo u
)
ééu v
;
éév w
header
èè$ *
.
èè* +
Cell
èè+ /
(
èè/ 0
)
èè0 1
.
èè1 2

Background
èè2 <
(
èè< =
$str
èè= F
)
èèF G
.
èèG H
Padding
èèH O
(
èèO P
$num
èèP Q
)
èèQ R
.
èèR S
Text
èèS W
(
èèW X
$str
èèX _
)
èè_ `
.
èè` a
	FontColor
èèa j
(
èèj k
$str
èèk q
)
èèq r
;
èèr s
}
êê  !
)
êê! "
;
êê" #
foreach
íí  '
(
íí( )
var
íí) ,
item
íí- 1
in
íí2 4
invoice
íí5 <
.
íí< =
invoices
íí= E
)
ííE F
{
ìì  !
var
îî$ '
conceptName
îî( 3
=
îî4 5
item
îî6 :
.
îî: ;
ProductName
îî; F
;
îîF G
var
ïï$ '
quantity
ïï( 0
=
ïï1 2
item
ïï3 7
.
ïï7 8
ProductQuantity
ïï8 G
;
ïïG H
var
ññ$ '
price
ññ( -
=
ññ. /
item
ññ0 4
.
ññ4 5
ProductPrice
ññ5 A
;
ññA B
var
óó$ '
tax
óó( +
=
óó, -
item
óó. 2
.
óó2 3

ProductIva
óó3 =
;
óó= >
var
òò$ '
discount
òò( 0
=
òò1 2
item
òò3 7
.
òò7 8
ProductDiscount
òò8 G
*
òòH I
quantity
òòJ R
;
òòR S
var
ôô$ '
total
ôô( -
=
ôô. /
quantity
ôô0 8
*
ôô9 :
price
ôô; @
;
ôô@ A
tabla
õõ$ )
.
õõ) *
Cell
õõ* .
(
õõ. /
)
õõ/ 0
.
õõ0 1
BorderBottom
õõ1 =
(
õõ= >
$num
õõ> B
)
õõB C
.
õõC D
BorderColor
õõD O
(
õõO P
$str
õõP Y
)
õõY Z
.
õõZ [
Padding
õõ[ b
(
õõb c
$num
õõc d
)
õõd e
.
õõe f
Text
õõf j
(
õõj k
conceptName
õõk v
)
õõv w
.
úú( )
FontSize
úú) 1
(
úú1 2
$num
úú2 4
)
úú4 5
;
úú5 6
tabla
ùù$ )
.
ùù) *
Cell
ùù* .
(
ùù. /
)
ùù/ 0
.
ùù0 1
BorderBottom
ùù1 =
(
ùù= >
$num
ùù> B
)
ùùB C
.
ùùC D
BorderColor
ùùD O
(
ùùO P
$str
ùùP Y
)
ùùY Z
.
ùùZ [
Padding
ùù[ b
(
ùùb c
$num
ùùc d
)
ùùd e
.
ûû( )
Text
ûû) -
(
ûû- .
quantity
ûû. 6
.
ûû6 7
ToString
ûû7 ?
(
ûû? @
)
ûû@ A
)
ûûA B
.
ûûB C
FontSize
ûûC K
(
ûûK L
$num
ûûL N
)
ûûN O
;
ûûO P
tabla
üü$ )
.
üü) *
Cell
üü* .
(
üü. /
)
üü/ 0
.
üü0 1
BorderBottom
üü1 =
(
üü= >
$num
üü> B
)
üüB C
.
üüC D
BorderColor
üüD O
(
üüO P
$str
üüP Y
)
üüY Z
.
üüZ [
Padding
üü[ b
(
üüb c
$num
üüc d
)
üüd e
.
††( )
Text
††) -
(
††- .
$"
††. 0
$str
††0 2
{
††2 3
price
††3 8
.
††8 9
ToString
††9 A
(
††A B
$str
††B H
)
††H I
}
††I J
"
††J K
)
††K L
.
††L M
FontSize
††M U
(
††U V
$num
††V X
)
††X Y
;
††Y Z
tabla
°°$ )
.
°°) *
Cell
°°* .
(
°°. /
)
°°/ 0
.
°°0 1
BorderBottom
°°1 =
(
°°= >
$num
°°> B
)
°°B C
.
°°C D
BorderColor
°°D O
(
°°O P
$str
°°P Y
)
°°Y Z
.
°°Z [
Padding
°°[ b
(
°°b c
$num
°°c d
)
°°d e
.
¢¢( )
Text
¢¢) -
(
¢¢- .
$"
¢¢. 0
$str
¢¢0 2
{
¢¢2 3
discount
¢¢3 ;
.
¢¢; <
ToString
¢¢< D
(
¢¢D E
$str
¢¢E K
)
¢¢K L
}
¢¢L M
"
¢¢M N
)
¢¢N O
.
¢¢O P
FontSize
¢¢P X
(
¢¢X Y
$num
¢¢Y [
)
¢¢[ \
;
¢¢\ ]
tabla
££$ )
.
££) *
Cell
££* .
(
££. /
)
££/ 0
.
££0 1
BorderBottom
££1 =
(
££= >
$num
££> B
)
££B C
.
££C D
BorderColor
££D O
(
££O P
$str
££P Y
)
££Y Z
.
££Z [
Padding
££[ b
(
££b c
$num
££c d
)
££d e
.
§§( )
Text
§§) -
(
§§- .
$"
§§. 0
$str
§§0 2
{
§§2 3
total
§§3 8
.
§§8 9
ToString
§§9 A
(
§§A B
$str
§§B H
)
§§H I
}
§§I J
"
§§J K
)
§§K L
.
§§L M
FontSize
§§M U
(
§§U V
$num
§§V X
)
§§X Y
;
§§Y Z
subTotal
¶¶$ ,
+=
¶¶- /
total
¶¶0 5
;
¶¶5 6
totalDiscount
ßß$ 1
+=
ßß2 4
discount
ßß5 =
;
ßß= >
totalTax
®®$ ,
=
®®- .
tax
®®/ 2
;
®®2 3
}
©©  !
}
™™ 
)
™™ 
;
™™ 
col1
¨¨  
.
¨¨  !
Item
¨¨! %
(
¨¨% &
)
¨¨& '
.
¨¨' (

PaddingTop
¨¨( 2
(
¨¨2 3
$num
¨¨3 5
)
¨¨5 6
.
¨¨6 7
Row
¨¨7 :
(
¨¨: ;
row
¨¨; >
=>
¨¨? A
{
≠≠ 
row
ÆÆ  #
.
ÆÆ# $
RelativeItem
ÆÆ$ 0
(
ÆÆ0 1
)
ÆÆ1 2
.
ÆÆ2 3
Column
ÆÆ3 9
(
ÆÆ9 :
col2
ÆÆ: >
=>
ÆÆ? A
{
ØØ  !
col2
∞∞$ (
.
∞∞( )
Item
∞∞) -
(
∞∞- .
)
∞∞. /
.
∞∞/ 0

AlignRight
∞∞0 :
(
∞∞: ;
)
∞∞; <
.
∞∞< =
Text
∞∞= A
(
∞∞A B
$str
∞∞B P
)
∞∞P Q
.
∞∞Q R
Bold
∞∞R V
(
∞∞V W
)
∞∞W X
.
∞∞X Y
FontSize
∞∞Y a
(
∞∞a b
$num
∞∞b d
)
∞∞d e
;
∞∞e f
col2
±±$ (
.
±±( )
Item
±±) -
(
±±- .
)
±±. /
.
±±/ 0

AlignRight
±±0 :
(
±±: ;
)
±±; <
.
±±< =
Text
±±= A
(
±±A B
$"
±±B D
$str
±±D L
{
±±L M
invoice
±±M T
.
±±T U
Debit
±±U Z
.
±±Z [
ToString
±±[ c
(
±±c d
$str
±±d j
)
±±j k
}
±±k l
"
±±l m
)
±±m n
.
≤≤( )
FontSize
≤≤) 1
(
≤≤1 2
$num
≤≤2 4
)
≤≤4 5
.
≤≤5 6
	FontColor
≤≤6 ?
(
≤≤? @
$str
≤≤@ H
)
≤≤H I
;
≤≤I J
col2
≥≥$ (
.
≥≥( )
Item
≥≥) -
(
≥≥- .
)
≥≥. /
.
≥≥/ 0

AlignRight
≥≥0 :
(
≥≥: ;
)
≥≥; <
.
≥≥< =
Text
≥≥= A
(
≥≥A B
$str
≥≥B R
)
≥≥R S
.
≥≥S T
FontSize
≥≥T \
(
≥≥\ ]
$num
≥≥] _
)
≥≥_ `
;
≥≥` a
col2
¥¥$ (
.
¥¥( )
Item
¥¥) -
(
¥¥- .
)
¥¥. /
.
¥¥/ 0

AlignRight
¥¥0 :
(
¥¥: ;
)
¥¥; <
.
¥¥< =
Text
¥¥= A
(
¥¥A B
date
¥¥B F
)
¥¥F G
.
¥¥G H
FontSize
¥¥H P
(
¥¥P Q
$num
¥¥Q S
)
¥¥S T
;
¥¥T U
}
µµ  !
)
µµ! "
;
µµ" #
}
∂∂ 
)
∂∂ 
;
∂∂ 
col1
∏∏  
.
∏∏  !
Spacing
∏∏! (
(
∏∏( )
$num
∏∏) +
)
∏∏+ ,
;
∏∏, -
}
ππ 
)
ππ 
;
ππ 
page
ªª 
.
ªª 
Footer
ªª #
(
ªª# $
)
ªª$ %
.
ºº 

AlignRight
ºº '
(
ºº' (
)
ºº( )
.
ΩΩ 
Text
ΩΩ !
(
ΩΩ! "
txt
ΩΩ" %
=>
ΩΩ& (
{
ææ 
txt
øø  #
.
øø# $
Span
øø$ (
(
øø( )
$str
øø) 2
)
øø2 3
.
øø3 4
FontSize
øø4 <
(
øø< =
$num
øø= ?
)
øø? @
;
øø@ A
txt
¿¿  #
.
¿¿# $
CurrentPageNumber
¿¿$ 5
(
¿¿5 6
)
¿¿6 7
.
¿¿7 8
FontSize
¿¿8 @
(
¿¿@ A
$num
¿¿A C
)
¿¿C D
;
¿¿D E
txt
¡¡  #
.
¡¡# $
Span
¡¡$ (
(
¡¡( )
$str
¡¡) /
)
¡¡/ 0
.
¡¡0 1
FontSize
¡¡1 9
(
¡¡9 :
$num
¡¡: <
)
¡¡< =
;
¡¡= >
txt
¬¬  #
.
¬¬# $

TotalPages
¬¬$ .
(
¬¬. /
)
¬¬/ 0
.
¬¬0 1
FontSize
¬¬1 9
(
¬¬9 :
$num
¬¬: <
)
¬¬< =
;
¬¬= >
}
√√ 
)
√√ 
;
√√ 
}
ƒƒ 
)
ƒƒ 
;
ƒƒ 
}
≈≈ 
)
≈≈ 
;
≈≈ 
byte
«« 
[
«« 
]
«« 
pdfBytes
«« 
=
«« 
document
«« &
.
««& '
GeneratePdf
««' 2
(
««2 3
)
««3 4
;
««4 5
using
…… 
var
…… 
memoryStream
…… "
=
……# $
new
……% (
MemoryStream
……) 5
(
……5 6
pdfBytes
……6 >
)
……> ?
;
……? @
return
   
memoryStream
   
.
    
ToArray
    '
(
  ' (
)
  ( )
;
  ) *
}
ÀÀ 	
)
ÀÀ	 

;
ÀÀ
 
}
ÃÃ 
public
ŒŒ 

async
ŒŒ 
Task
ŒŒ 
<
ŒŒ 
byte
ŒŒ 
[
ŒŒ 
]
ŒŒ 
>
ŒŒ 
RegenerateInvoice
ŒŒ /
(
ŒŒ/ 0
UserInfoResponse
ŒŒ0 @
userInfo
ŒŒA I
,
ŒŒI J
Invoice
ŒŒK R
invoice
ŒŒS Z
)
ŒŒZ [
{
œœ 
var
–– 
date
–– 
=
–– 
DateTime
–– 
.
–– 
Now
–– 
.
––  
ToString
––  (
(
––( )
$str
––) 5
)
––5 6
;
––6 7
var
—— 
totalTax
—— 
=
—— 
$num
—— 
;
—— 
var
““ 
subTotal
““ 
=
““ 
$num
““ 
;
““ 
decimal
”” 
?
”” 
totalDiscount
”” 
=
””  
$num
””! #
;
””# $
var
‘‘ 
workingDirectory
‘‘ 
=
‘‘ 
Path
‘‘ #
.
‘‘# $
GetDirectoryName
‘‘$ 4
(
‘‘4 5
Assembly
‘‘5 =
.
‘‘= >"
GetExecutingAssembly
‘‘> R
(
‘‘R S
)
‘‘S T
.
‘‘T U
Location
‘‘U ]
)
‘‘] ^
;
‘‘^ _
var
’’ 
	separator
’’ 
=
’’ 
Path
’’ 
.
’’ $
DirectorySeparatorChar
’’ 3
;
’’3 4
var
÷÷ 
pathFile
÷÷ 
=
÷÷ 
$"
÷÷ 
{
÷÷ 
workingDirectory
÷÷ *
}
÷÷* +
{
÷÷+ ,
	separator
÷÷, 5
}
÷÷5 6
$str
÷÷6 <
{
÷÷< =
	separator
÷÷= F
}
÷÷F G
$str
÷÷G O
"
÷÷O P
;
÷÷P Q
return
ÿÿ 
await
ÿÿ 
Task
ÿÿ 
.
ÿÿ 
Run
ÿÿ 
(
ÿÿ 
(
ÿÿ 
)
ÿÿ  
=>
ÿÿ! #
{
ŸŸ 	
var
⁄⁄ 
document
⁄⁄ 
=
⁄⁄ 
Document
⁄⁄ #
.
€€ 
Create
€€ 
(
€€ 
doc
€€ 
=>
€€ 
{
‹‹ 
doc
›› 
.
›› 
Page
›› 
(
›› 
page
›› !
=>
››" $
{
ﬁﬁ 
page
ﬂﬂ 
.
ﬂﬂ 
Margin
ﬂﬂ #
(
ﬂﬂ# $
$num
ﬂﬂ$ &
)
ﬂﬂ& '
;
ﬂﬂ' (
page
·· 
.
·· 
Header
·· #
(
··# $
)
··$ %
.
··% &
ShowOnce
··& .
(
··. /
)
··/ 0
.
··0 1
Row
··1 4
(
··4 5
row
··5 8
=>
··9 ;
{
‚‚ 
var
„„ 
image
„„  %
=
„„& '
Image
„„( -
.
„„- .
FromFile
„„. 6
(
„„6 7
pathFile
„„7 ?
)
„„? @
;
„„@ A
row
‰‰ 
.
‰‰  
ConstantItem
‰‰  ,
(
‰‰, -
$num
‰‰- 0
)
‰‰0 1
.
‰‰1 2
	Container
‰‰2 ;
(
‰‰; <
)
‰‰< =
.
‰‰= >
Image
‰‰> C
(
‰‰C D
image
‰‰D I
)
‰‰I J
;
‰‰J K
row
ÊÊ 
.
ÊÊ  
RelativeItem
ÊÊ  ,
(
ÊÊ, -
)
ÊÊ- .
.
ÊÊ. /
Column
ÊÊ/ 5
(
ÊÊ5 6
col
ÊÊ6 9
=>
ÊÊ: <
{
ÁÁ 
col
ËË  #
.
ËË# $
Item
ËË$ (
(
ËË( )
)
ËË) *
.
ËË* +

AlignRight
ËË+ 5
(
ËË5 6
)
ËË6 7
.
ËË7 8

Background
ËË8 B
(
ËËB C
$str
ËËC L
)
ËËL M
.
ËËM N
Border
ËËN T
(
ËËT U
$num
ËËU V
)
ËËV W
.
ËËW X
BorderColor
ËËX c
(
ËËc d
$str
ËËd m
)
ËËm n
.
ÈÈ$ %
AlignCenter
ÈÈ% 0
(
ÈÈ0 1
)
ÈÈ1 2
.
ÍÍ$ %
Text
ÍÍ% )
(
ÍÍ) *
$"
ÍÍ* ,
$str
ÍÍ, B
{
ÍÍB C
invoice
ÍÍC J
.
ÍÍJ K
Id
ÍÍK M
}
ÍÍM N
"
ÍÍN O
)
ÍÍO P
.
ÎÎ$ %
	FontColor
ÎÎ% .
(
ÎÎ. /
$str
ÎÎ/ 5
)
ÎÎ5 6
;
ÎÎ6 7
col
ÌÌ  #
.
ÌÌ# $
Item
ÌÌ$ (
(
ÌÌ( )
)
ÌÌ) *
.
ÌÌ* +

AlignRight
ÌÌ+ 5
(
ÌÌ5 6
)
ÌÌ6 7
.
ÌÌ7 8
Text
ÌÌ8 <
(
ÌÌ< =
$str
ÌÌ= q
)
ÌÌq r
.
ÓÓ$ %
FontSize
ÓÓ% -
(
ÓÓ- .
$num
ÓÓ. 0
)
ÓÓ0 1
;
ÓÓ1 2
col
ÔÔ  #
.
ÔÔ# $
Item
ÔÔ$ (
(
ÔÔ( )
)
ÔÔ) *
.
ÔÔ* +

AlignRight
ÔÔ+ 5
(
ÔÔ5 6
)
ÔÔ6 7
.
ÔÔ7 8
Text
ÔÔ8 <
(
ÔÔ< =
$str
ÔÔ= R
)
ÔÔR S
.
ÔÔS T
FontSize
ÔÔT \
(
ÔÔ\ ]
$num
ÔÔ] _
)
ÔÔ_ `
;
ÔÔ` a
col
  #
.
# $
Item
$ (
(
( )
)
) *
.
* +

AlignRight
+ 5
(
5 6
)
6 7
.
ÒÒ$ %
Text
ÒÒ% )
(
ÒÒ) *
$str
ÚÚ( y
)
ÚÚy z
.
ÛÛ$ %
FontSize
ÛÛ% -
(
ÛÛ- .
$num
ÛÛ. 0
)
ÛÛ0 1
;
ÛÛ1 2
col
ÙÙ  #
.
ÙÙ# $
Item
ÙÙ$ (
(
ÙÙ( )
)
ÙÙ) *
.
ÙÙ* +

AlignRight
ÙÙ+ 5
(
ÙÙ5 6
)
ÙÙ6 7
.
ÙÙ7 8
Text
ÙÙ8 <
(
ÙÙ< =
$str
ÙÙ= S
)
ÙÙS T
.
ÙÙT U
FontSize
ÙÙU ]
(
ÙÙ] ^
$num
ÙÙ^ `
)
ÙÙ` a
;
ÙÙa b
col
ıı  #
.
ıı# $
Item
ıı$ (
(
ıı( )
)
ıı) *
.
ıı* +

AlignRight
ıı+ 5
(
ıı5 6
)
ıı6 7
.
ıı7 8
Text
ıı8 <
(
ıı< =
$str
ıı= b
)
ııb c
.
ııc d
FontSize
ııd l
(
ııl m
$num
ıım o
)
ııo p
;
ııp q
col
ˆˆ  #
.
ˆˆ# $
Item
ˆˆ$ (
(
ˆˆ( )
)
ˆˆ) *
.
ˆˆ* +

AlignRight
ˆˆ+ 5
(
ˆˆ5 6
)
ˆˆ6 7
.
ˆˆ7 8
Text
ˆˆ8 <
(
ˆˆ< =
date
ˆˆ= A
)
ˆˆA B
.
ˆˆB C
FontSize
ˆˆC K
(
ˆˆK L
$num
ˆˆL N
)
ˆˆN O
;
ˆˆO P
}
˜˜ 
)
˜˜ 
;
˜˜ 
}
¯¯ 
)
¯¯ 
;
¯¯ 
page
˙˙ 
.
˙˙ 
Content
˙˙ $
(
˙˙$ %
)
˙˙% &
.
˙˙& '
PaddingVertical
˙˙' 6
(
˙˙6 7
$num
˙˙7 9
)
˙˙9 :
.
˙˙: ;
Column
˙˙; A
(
˙˙A B
col1
˙˙B F
=>
˙˙G I
{
˚˚ 
col1
¸¸  
.
¸¸  !
Item
¸¸! %
(
¸¸% &
)
¸¸& '
.
¸¸' (

PaddingTop
¸¸( 2
(
¸¸2 3
$num
¸¸3 5
)
¸¸5 6
.
¸¸6 7
Row
¸¸7 :
(
¸¸: ;
row
¸¸; >
=>
¸¸? A
{
˝˝ 
row
˛˛  #
.
˛˛# $
RelativeItem
˛˛$ 0
(
˛˛0 1
)
˛˛1 2
.
˛˛2 3
Column
˛˛3 9
(
˛˛9 :
col2
˛˛: >
=>
˛˛? A
{
ˇˇ  !
col2
ÄÄ$ (
.
ÄÄ( )
Item
ÄÄ) -
(
ÄÄ- .
)
ÄÄ. /
.
ÄÄ/ 0
	AlignLeft
ÄÄ0 9
(
ÄÄ9 :
)
ÄÄ: ;
.
ÄÄ; <
Text
ÄÄ< @
(
ÄÄ@ A
$str
ÄÄA T
)
ÄÄT U
.
ÄÄU V
	Underline
ÄÄV _
(
ÄÄ_ `
)
ÄÄ` a
.
ÄÄa b
Bold
ÄÄb f
(
ÄÄf g
)
ÄÄg h
;
ÄÄh i
col2
ÇÇ$ (
.
ÇÇ( )
Item
ÇÇ) -
(
ÇÇ- .
)
ÇÇ. /
.
ÇÇ/ 0
Text
ÇÇ0 4
(
ÇÇ4 5
txt
ÇÇ5 8
=>
ÇÇ9 ;
{
ÉÉ$ %
txt
ÑÑ( +
.
ÑÑ+ ,
Span
ÑÑ, 0
(
ÑÑ0 1
$str
ÑÑ1 ;
)
ÑÑ; <
.
ÑÑ< =
SemiBold
ÑÑ= E
(
ÑÑE F
)
ÑÑF G
.
ÑÑG H
FontSize
ÑÑH P
(
ÑÑP Q
$num
ÑÑQ S
)
ÑÑS T
;
ÑÑT U
txt
ÖÖ( +
.
ÖÖ+ ,
Span
ÖÖ, 0
(
ÖÖ0 1
$"
ÖÖ1 3
{
ÖÖ3 4
userInfo
ÖÖ4 <
.
ÖÖ< =
Name
ÖÖ= A
}
ÖÖA B
$str
ÖÖB C
{
ÖÖC D
userInfo
ÖÖD L
.
ÖÖL M
LastName
ÖÖM U
}
ÖÖU V
"
ÖÖV W
)
ÖÖW X
.
ÖÖX Y
FontSize
ÖÖY a
(
ÖÖa b
$num
ÖÖb d
)
ÖÖd e
;
ÖÖe f
}
ÜÜ$ %
)
ÜÜ% &
;
ÜÜ& '
col2
àà$ (
.
àà( )
Item
àà) -
(
àà- .
)
àà. /
.
àà/ 0
Text
àà0 4
(
àà4 5
txt
àà5 8
=>
àà9 ;
{
ââ$ %
txt
ää( +
.
ää+ ,
Span
ää, 0
(
ää0 1
$str
ää1 9
)
ää9 :
.
ää: ;
SemiBold
ää; C
(
ääC D
)
ääD E
.
ääE F
FontSize
ääF N
(
ääN O
$num
ääO Q
)
ääQ R
;
ääR S
txt
ãã( +
.
ãã+ ,
Span
ãã, 0
(
ãã0 1
userInfo
ãã1 9
.
ãã9 :
Country
ãã: A
!
ããA B
.
ããB C
Name
ããC G
)
ããG H
.
ããH I
FontSize
ããI Q
(
ããQ R
$num
ããR T
)
ããT U
;
ããU V
}
åå$ %
)
åå% &
;
åå& '
col2
éé$ (
.
éé( )
Item
éé) -
(
éé- .
)
éé. /
.
éé/ 0
Text
éé0 4
(
éé4 5
txt
éé5 8
=>
éé9 ;
{
èè$ %
txt
êê( +
.
êê+ ,
Span
êê, 0
(
êê0 1
$str
êê1 ;
)
êê; <
.
êê< =
SemiBold
êê= E
(
êêE F
)
êêF G
.
êêG H
FontSize
êêH P
(
êêP Q
$num
êêQ S
)
êêS T
;
êêT U
txt
ëë( +
.
ëë+ ,
Span
ëë, 0
(
ëë0 1
userInfo
ëë1 9
.
ëë9 :
City
ëë: >
)
ëë> ?
.
ëë? @
FontSize
ëë@ H
(
ëëH I
$num
ëëI K
)
ëëK L
;
ëëL M
}
íí$ %
)
íí% &
;
íí& '
}
ìì  !
)
ìì! "
;
ìì" #
row
ïï  #
.
ïï# $
RelativeItem
ïï$ 0
(
ïï0 1
)
ïï1 2
.
ïï2 3
Column
ïï3 9
(
ïï9 :
col2
ïï: >
=>
ïï? A
{
ññ  !
col2
óó$ (
.
óó( )
Item
óó) -
(
óó- .
)
óó. /
.
óó/ 0

AlignRight
óó0 :
(
óó: ;
)
óó; <
.
óó< =
Text
óó= A
(
óóA B
txt
óóB E
=>
óóF H
{
òò$ %
txt
ôô( +
.
ôô+ ,
Span
ôô, 0
(
ôô0 1
$str
ôô1 <
)
ôô< =
.
ôô= >
SemiBold
ôô> F
(
ôôF G
)
ôôG H
.
ôôH I
FontSize
ôôI Q
(
ôôQ R
$num
ôôR T
)
ôôT U
;
ôôU V
txt
öö( +
.
öö+ ,
Span
öö, 0
(
öö0 1
userInfo
öö1 9
.
öö9 :
Phone
öö: ?
)
öö? @
.
öö@ A
FontSize
ööA I
(
ööI J
$num
ööJ L
)
ööL M
;
ööM N
}
õõ$ %
)
õõ% &
;
õõ& '
col2
ùù$ (
.
ùù( )
Item
ùù) -
(
ùù- .
)
ùù. /
.
ùù/ 0

AlignRight
ùù0 :
(
ùù: ;
)
ùù; <
.
ùù< =
Text
ùù= A
(
ùùA B
txt
ùùB E
=>
ùùF H
{
ûû$ %
txt
üü( +
.
üü+ ,
Span
üü, 0
(
üü0 1
$str
üü1 O
)
üüO P
.
üüP Q
SemiBold
üüQ Y
(
üüY Z
)
üüZ [
.
üü[ \
FontSize
üü\ d
(
üüd e
$num
üüe g
)
üüg h
;
üüh i
txt
††( +
.
††+ ,
Span
††, 0
(
††0 1
userInfo
††1 9
.
††9 :
UserName
††: B
)
††B C
.
††C D
FontSize
††D L
(
††L M
$num
††M O
)
††O P
;
††P Q
}
°°$ %
)
°°% &
;
°°& '
col2
££$ (
.
££( )
Item
££) -
(
££- .
)
££. /
.
££/ 0

AlignRight
££0 :
(
££: ;
)
££; <
.
££< =
Text
££= A
(
££A B
txt
££B E
=>
££F H
{
§§$ %
txt
••( +
.
••+ ,
Span
••, 0
(
••0 1
$str
••1 :
)
••: ;
.
••; <
SemiBold
••< D
(
••D E
)
••E F
.
••F G
FontSize
••G O
(
••O P
$num
••P R
)
••R S
;
••S T
txt
¶¶( +
.
¶¶+ ,
Span
¶¶, 0
(
¶¶0 1
userInfo
¶¶1 9
.
¶¶9 :
Email
¶¶: ?
)
¶¶? @
.
¶¶@ A
FontSize
¶¶A I
(
¶¶I J
$num
¶¶J L
)
¶¶L M
;
¶¶M N
}
ßß$ %
)
ßß% &
;
ßß& '
col2
©©$ (
.
©©( )
Item
©©) -
(
©©- .
)
©©. /
.
©©/ 0

AlignRight
©©0 :
(
©©: ;
)
©©; <
.
©©< =
Text
©©= A
(
©©A B
txt
©©B E
=>
©©F H
{
™™$ %
txt
´´( +
.
´´+ ,
Span
´´, 0
(
´´0 1
$str
´´1 >
)
´´> ?
.
´´? @
SemiBold
´´@ H
(
´´H I
)
´´I J
.
´´J K
FontSize
´´K S
(
´´S T
$num
´´T V
)
´´V W
;
´´W X
txt
¨¨( +
.
¨¨+ ,
Span
¨¨, 0
(
¨¨0 1
userInfo
¨¨1 9
.
¨¨9 :
Address
¨¨: A
)
¨¨A B
.
¨¨B C
FontSize
¨¨C K
(
¨¨K L
$num
¨¨L N
)
¨¨N O
;
¨¨O P
}
≠≠$ %
)
≠≠% &
;
≠≠& '
col2
ØØ$ (
.
ØØ( )
Item
ØØ) -
(
ØØ- .
)
ØØ. /
.
ØØ/ 0

AlignRight
ØØ0 :
(
ØØ: ;
)
ØØ; <
.
ØØ< =
Text
ØØ= A
(
ØØA B
txt
ØØB E
=>
ØØF H
{
∞∞$ %
if
±±( *
(
±±+ ,
!
±±, -
string
±±- 3
.
±±3 4
IsNullOrEmpty
±±4 A
(
±±A B
invoice
±±B I
.
±±I J
Reason
±±J P
)
±±P Q
)
±±Q R
{
≤≤( )
txt
≥≥, /
.
≥≥/ 0
Span
≥≥0 4
(
≥≥4 5
$str
≥≥5 K
)
≥≥K L
.
≥≥L M
SemiBold
≥≥M U
(
≥≥U V
)
≥≥V W
.
≥≥W X
FontSize
≥≥X `
(
≥≥` a
$num
≥≥a c
)
≥≥c d
;
≥≥d e
txt
¥¥, /
.
¥¥/ 0
Span
¥¥0 4
(
¥¥4 5
invoice
¥¥5 <
.
¥¥< =
Reason
¥¥= C
)
¥¥C D
.
¥¥D E
FontSize
¥¥E M
(
¥¥M N
$num
¥¥N P
)
¥¥P Q
;
¥¥Q R
}
µµ( )
}
∂∂$ %
)
∂∂% &
;
∂∂& '
}
∑∑  !
)
∑∑! "
;
∑∑" #
}
∏∏ 
)
∏∏ 
;
∏∏ 
col1
ªª  
.
ªª  !
Item
ªª! %
(
ªª% &
)
ªª& '
.
ªª' (
LineHorizontal
ªª( 6
(
ªª6 7
$num
ªª7 ;
)
ªª; <
;
ªª< =
col1
ΩΩ  
.
ΩΩ  !
Item
ΩΩ! %
(
ΩΩ% &
)
ΩΩ& '
.
ΩΩ' (
Table
ΩΩ( -
(
ΩΩ- .
tabla
ΩΩ. 3
=>
ΩΩ4 6
{
ææ 
tabla
øø  %
.
øø% &
ColumnsDefinition
øø& 7
(
øø7 8
columns
øø8 ?
=>
øø@ B
{
¿¿  !
columns
¡¡$ +
.
¡¡+ ,
RelativeColumn
¡¡, :
(
¡¡: ;
$num
¡¡; <
)
¡¡< =
;
¡¡= >
columns
¬¬$ +
.
¬¬+ ,
RelativeColumn
¬¬, :
(
¬¬: ;
)
¬¬; <
;
¬¬< =
columns
√√$ +
.
√√+ ,
RelativeColumn
√√, :
(
√√: ;
)
√√; <
;
√√< =
columns
ƒƒ$ +
.
ƒƒ+ ,
RelativeColumn
ƒƒ, :
(
ƒƒ: ;
)
ƒƒ; <
;
ƒƒ< =
columns
≈≈$ +
.
≈≈+ ,
RelativeColumn
≈≈, :
(
≈≈: ;
)
≈≈; <
;
≈≈< =
}
∆∆  !
)
∆∆! "
;
∆∆" #
tabla
»»  %
.
»»% &
Header
»»& ,
(
»», -
header
»»- 3
=>
»»4 6
{
……  !
header
  $ *
.
  * +
Cell
  + /
(
  / 0
)
  0 1
.
  1 2

Background
  2 <
(
  < =
$str
  = F
)
  F G
.
  G H
Padding
  H O
(
  O P
$num
  P Q
)
  Q R
.
  R S
Text
  S W
(
  W X
$str
  X b
)
  b c
.
  c d
	FontColor
  d m
(
  m n
$str
  n t
)
  t u
;
  u v
header
ÀÀ$ *
.
ÀÀ* +
Cell
ÀÀ+ /
(
ÀÀ/ 0
)
ÀÀ0 1
.
ÀÀ1 2

Background
ÀÀ2 <
(
ÀÀ< =
$str
ÀÀ= F
)
ÀÀF G
.
ÀÀG H
Padding
ÀÀH O
(
ÀÀO P
$num
ÀÀP Q
)
ÀÀQ R
.
ÀÀR S
Text
ÀÀS W
(
ÀÀW X
$str
ÀÀX b
)
ÀÀb c
.
ÀÀc d
	FontColor
ÀÀd m
(
ÀÀm n
$str
ÀÀn t
)
ÀÀt u
;
ÀÀu v
header
ÃÃ$ *
.
ÃÃ* +
Cell
ÃÃ+ /
(
ÃÃ/ 0
)
ÃÃ0 1
.
ÃÃ1 2

Background
ÃÃ2 <
(
ÃÃ< =
$str
ÃÃ= F
)
ÃÃF G
.
ÃÃG H
Padding
ÃÃH O
(
ÃÃO P
$num
ÃÃP Q
)
ÃÃQ R
.
ÃÃR S
Text
ÃÃS W
(
ÃÃW X
$str
ÃÃX `
)
ÃÃ` a
.
ÃÃa b
	FontColor
ÃÃb k
(
ÃÃk l
$str
ÃÃl r
)
ÃÃr s
;
ÃÃs t
header
ÕÕ$ *
.
ÕÕ* +
Cell
ÕÕ+ /
(
ÕÕ/ 0
)
ÕÕ0 1
.
ÕÕ1 2

Background
ÕÕ2 <
(
ÕÕ< =
$str
ÕÕ= F
)
ÕÕF G
.
ÕÕG H
Padding
ÕÕH O
(
ÕÕO P
$num
ÕÕP Q
)
ÕÕQ R
.
ÕÕR S
Text
ÕÕS W
(
ÕÕW X
$str
ÕÕX c
)
ÕÕc d
.
ÕÕd e
	FontColor
ÕÕe n
(
ÕÕn o
$str
ÕÕo u
)
ÕÕu v
;
ÕÕv w
header
ŒŒ$ *
.
ŒŒ* +
Cell
ŒŒ+ /
(
ŒŒ/ 0
)
ŒŒ0 1
.
ŒŒ1 2

Background
ŒŒ2 <
(
ŒŒ< =
$str
ŒŒ= F
)
ŒŒF G
.
ŒŒG H
Padding
ŒŒH O
(
ŒŒO P
$num
ŒŒP Q
)
ŒŒQ R
.
ŒŒR S
Text
ŒŒS W
(
ŒŒW X
$str
ŒŒX _
)
ŒŒ_ `
.
ŒŒ` a
	FontColor
ŒŒa j
(
ŒŒj k
$str
ŒŒk q
)
ŒŒq r
;
ŒŒr s
}
œœ  !
)
œœ! "
;
œœ" #
foreach
——  '
(
——( )
var
——) ,
item
——- 1
in
——2 4
invoice
——5 <
.
——< =
InvoicesDetails
——= L
)
——L M
{
““  !
var
””$ '
conceptName
””( 3
=
””4 5
item
””6 :
.
””: ;
ProductName
””; F
;
””F G
var
‘‘$ '
quantity
‘‘( 0
=
‘‘1 2
item
‘‘3 7
.
‘‘7 8
ProductQuantity
‘‘8 G
;
‘‘G H
var
’’$ '
price
’’( -
=
’’. /
item
’’0 4
.
’’4 5

BaseAmount
’’5 ?
??
’’@ B
$num
’’C D
;
’’D E
var
÷÷$ '
tax
÷÷( +
=
÷÷, -
item
÷÷. 2
.
÷÷2 3

ProductIva
÷÷3 =
;
÷÷= >
var
◊◊$ '
discount
◊◊( 0
=
◊◊1 2
item
◊◊3 7
.
◊◊7 8
ProductDiscount
◊◊8 G
*
◊◊H I
quantity
◊◊J R
;
◊◊R S
var
ÿÿ$ '
total
ÿÿ( -
=
ÿÿ. /
quantity
ÿÿ0 8
*
ÿÿ9 :
price
ÿÿ; @
;
ÿÿ@ A
tabla
⁄⁄$ )
.
⁄⁄) *
Cell
⁄⁄* .
(
⁄⁄. /
)
⁄⁄/ 0
.
⁄⁄0 1
BorderBottom
⁄⁄1 =
(
⁄⁄= >
$num
⁄⁄> B
)
⁄⁄B C
.
⁄⁄C D
BorderColor
⁄⁄D O
(
⁄⁄O P
$str
⁄⁄P Y
)
⁄⁄Y Z
.
⁄⁄Z [
Padding
⁄⁄[ b
(
⁄⁄b c
$num
⁄⁄c d
)
⁄⁄d e
.
⁄⁄e f
Text
⁄⁄f j
(
⁄⁄j k
conceptName
⁄⁄k v
)
⁄⁄v w
.
€€( )
FontSize
€€) 1
(
€€1 2
$num
€€2 4
)
€€4 5
;
€€5 6
tabla
‹‹$ )
.
‹‹) *
Cell
‹‹* .
(
‹‹. /
)
‹‹/ 0
.
‹‹0 1
BorderBottom
‹‹1 =
(
‹‹= >
$num
‹‹> B
)
‹‹B C
.
‹‹C D
BorderColor
‹‹D O
(
‹‹O P
$str
‹‹P Y
)
‹‹Y Z
.
‹‹Z [
Padding
‹‹[ b
(
‹‹b c
$num
‹‹c d
)
‹‹d e
.
››( )
Text
››) -
(
››- .
quantity
››. 6
.
››6 7
ToString
››7 ?
(
››? @
)
››@ A
)
››A B
.
››B C
FontSize
››C K
(
››K L
$num
››L N
)
››N O
;
››O P
tabla
ﬁﬁ$ )
.
ﬁﬁ) *
Cell
ﬁﬁ* .
(
ﬁﬁ. /
)
ﬁﬁ/ 0
.
ﬁﬁ0 1
BorderBottom
ﬁﬁ1 =
(
ﬁﬁ= >
$num
ﬁﬁ> B
)
ﬁﬁB C
.
ﬁﬁC D
BorderColor
ﬁﬁD O
(
ﬁﬁO P
$str
ﬁﬁP Y
)
ﬁﬁY Z
.
ﬁﬁZ [
Padding
ﬁﬁ[ b
(
ﬁﬁb c
$num
ﬁﬁc d
)
ﬁﬁd e
.
ﬂﬂ( )
Text
ﬂﬂ) -
(
ﬂﬂ- .
$"
ﬂﬂ. 0
$str
ﬂﬂ0 2
{
ﬂﬂ2 3
price
ﬂﬂ3 8
.
ﬂﬂ8 9
ToString
ﬂﬂ9 A
(
ﬂﬂA B
$str
ﬂﬂB H
)
ﬂﬂH I
}
ﬂﬂI J
"
ﬂﬂJ K
)
ﬂﬂK L
.
ﬂﬂL M
FontSize
ﬂﬂM U
(
ﬂﬂU V
$num
ﬂﬂV X
)
ﬂﬂX Y
;
ﬂﬂY Z
tabla
‡‡$ )
.
‡‡) *
Cell
‡‡* .
(
‡‡. /
)
‡‡/ 0
.
‡‡0 1
BorderBottom
‡‡1 =
(
‡‡= >
$num
‡‡> B
)
‡‡B C
.
‡‡C D
BorderColor
‡‡D O
(
‡‡O P
$str
‡‡P Y
)
‡‡Y Z
.
‡‡Z [
Padding
‡‡[ b
(
‡‡b c
$num
‡‡c d
)
‡‡d e
.
··( )
Text
··) -
(
··- .
$"
··. 0
$str
··0 2
{
··2 3
discount
··3 ;
.
··; <
ToString
··< D
(
··D E
)
··E F
}
··F G
"
··G H
)
··H I
.
··I J
FontSize
··J R
(
··R S
$num
··S U
)
··U V
;
··V W
tabla
‚‚$ )
.
‚‚) *
Cell
‚‚* .
(
‚‚. /
)
‚‚/ 0
.
‚‚0 1
BorderBottom
‚‚1 =
(
‚‚= >
$num
‚‚> B
)
‚‚B C
.
‚‚C D
BorderColor
‚‚D O
(
‚‚O P
$str
‚‚P Y
)
‚‚Y Z
.
‚‚Z [
Padding
‚‚[ b
(
‚‚b c
$num
‚‚c d
)
‚‚d e
.
„„( )
Text
„„) -
(
„„- .
$"
„„. 0
$str
„„0 2
{
„„2 3
total
„„3 8
.
„„8 9
ToString
„„9 A
(
„„A B
$str
„„B H
)
„„H I
}
„„I J
"
„„J K
)
„„K L
.
„„L M
FontSize
„„M U
(
„„U V
$num
„„V X
)
„„X Y
;
„„Y Z
subTotal
ÂÂ$ ,
+=
ÂÂ- /
total
ÂÂ0 5
;
ÂÂ5 6
totalDiscount
ÊÊ$ 1
+=
ÊÊ2 4
discount
ÊÊ5 =
;
ÊÊ= >
totalTax
ÁÁ$ ,
=
ÁÁ- .
(
ÁÁ/ 0
decimal
ÁÁ0 7
)
ÁÁ7 8
tax
ÁÁ8 ;
!
ÁÁ; <
;
ÁÁ< =
}
ËË  !
}
ÈÈ 
)
ÈÈ 
;
ÈÈ 
col1
ÎÎ  
.
ÎÎ  !
Item
ÎÎ! %
(
ÎÎ% &
)
ÎÎ& '
.
ÎÎ' (

PaddingTop
ÎÎ( 2
(
ÎÎ2 3
$num
ÎÎ3 5
)
ÎÎ5 6
.
ÎÎ6 7
Row
ÎÎ7 :
(
ÎÎ: ;
row
ÎÎ; >
=>
ÎÎ? A
{
ÏÏ 
row
ÌÌ  #
.
ÌÌ# $
RelativeItem
ÌÌ$ 0
(
ÌÌ0 1
)
ÌÌ1 2
.
ÌÌ2 3
Column
ÌÌ3 9
(
ÌÌ9 :
col2
ÌÌ: >
=>
ÌÌ? A
{
ÓÓ  !
col2
ÔÔ$ (
.
ÔÔ( )
Item
ÔÔ) -
(
ÔÔ- .
)
ÔÔ. /
.
ÔÔ/ 0

AlignRight
ÔÔ0 :
(
ÔÔ: ;
)
ÔÔ; <
.
ÔÔ< =
Text
ÔÔ= A
(
ÔÔA B
$str
ÔÔB P
)
ÔÔP Q
.
ÔÔQ R
Bold
ÔÔR V
(
ÔÔV W
)
ÔÔW X
.
ÔÔX Y
FontSize
ÔÔY a
(
ÔÔa b
$num
ÔÔb d
)
ÔÔd e
;
ÔÔe f
col2
$ (
.
( )
Item
) -
(
- .
)
. /
.
/ 0

AlignRight
0 :
(
: ;
)
; <
.
< =
Text
= A
(
A B
$"
B D
$str
D L
{
L M
invoice
M T
.
T U
TotalInvoice
U a
.
a b
ToString
b j
(
j k
)
k l
}
l m
"
m n
)
n o
.
ÒÒ( )
FontSize
ÒÒ) 1
(
ÒÒ1 2
$num
ÒÒ2 4
)
ÒÒ4 5
.
ÒÒ5 6
	FontColor
ÒÒ6 ?
(
ÒÒ? @
$str
ÒÒ@ H
)
ÒÒH I
;
ÒÒI J
col2
ÚÚ$ (
.
ÚÚ( )
Item
ÚÚ) -
(
ÚÚ- .
)
ÚÚ. /
.
ÚÚ/ 0

AlignRight
ÚÚ0 :
(
ÚÚ: ;
)
ÚÚ; <
.
ÚÚ< =
Text
ÚÚ= A
(
ÚÚA B
$str
ÚÚB R
)
ÚÚR S
.
ÚÚS T
FontSize
ÚÚT \
(
ÚÚ\ ]
$num
ÚÚ] _
)
ÚÚ_ `
;
ÚÚ` a
col2
ÛÛ$ (
.
ÛÛ( )
Item
ÛÛ) -
(
ÛÛ- .
)
ÛÛ. /
.
ÛÛ/ 0

AlignRight
ÛÛ0 :
(
ÛÛ: ;
)
ÛÛ; <
.
ÛÛ< =
Text
ÛÛ= A
(
ÛÛA B
date
ÛÛB F
)
ÛÛF G
.
ÛÛG H
FontSize
ÛÛH P
(
ÛÛP Q
$num
ÛÛQ S
)
ÛÛS T
;
ÛÛT U
}
ÙÙ  !
)
ÙÙ! "
;
ÙÙ" #
}
ıı 
)
ıı 
;
ıı 
col1
˜˜  
.
˜˜  !
Spacing
˜˜! (
(
˜˜( )
$num
˜˜) +
)
˜˜+ ,
;
˜˜, -
}
¯¯ 
)
¯¯ 
;
¯¯ 
page
˙˙ 
.
˙˙ 
Footer
˙˙ #
(
˙˙# $
)
˙˙$ %
.
˚˚ 

AlignRight
˚˚ '
(
˚˚' (
)
˚˚( )
.
¸¸ 
Text
¸¸ !
(
¸¸! "
txt
¸¸" %
=>
¸¸& (
{
˝˝ 
txt
˛˛  #
.
˛˛# $
Span
˛˛$ (
(
˛˛( )
$str
˛˛) 2
)
˛˛2 3
.
˛˛3 4
FontSize
˛˛4 <
(
˛˛< =
$num
˛˛= ?
)
˛˛? @
;
˛˛@ A
txt
ˇˇ  #
.
ˇˇ# $
CurrentPageNumber
ˇˇ$ 5
(
ˇˇ5 6
)
ˇˇ6 7
.
ˇˇ7 8
FontSize
ˇˇ8 @
(
ˇˇ@ A
$num
ˇˇA C
)
ˇˇC D
;
ˇˇD E
txt
ÄÄ  #
.
ÄÄ# $
Span
ÄÄ$ (
(
ÄÄ( )
$str
ÄÄ) /
)
ÄÄ/ 0
.
ÄÄ0 1
FontSize
ÄÄ1 9
(
ÄÄ9 :
$num
ÄÄ: <
)
ÄÄ< =
;
ÄÄ= >
txt
ÅÅ  #
.
ÅÅ# $

TotalPages
ÅÅ$ .
(
ÅÅ. /
)
ÅÅ/ 0
.
ÅÅ0 1
FontSize
ÅÅ1 9
(
ÅÅ9 :
$num
ÅÅ: <
)
ÅÅ< =
;
ÅÅ= >
}
ÇÇ 
)
ÇÇ 
;
ÇÇ 
}
ÉÉ 
)
ÉÉ 
;
ÉÉ 
}
ÑÑ 
)
ÑÑ 
;
ÑÑ 
byte
ÜÜ 
[
ÜÜ 
]
ÜÜ 
pdfBytes
ÜÜ 
=
ÜÜ 
document
ÜÜ &
.
ÜÜ& '
GeneratePdf
ÜÜ' 2
(
ÜÜ2 3
)
ÜÜ3 4
;
ÜÜ4 5
using
àà 
var
àà 
memoryStream
àà "
=
àà# $
new
àà% (
MemoryStream
àà) 5
(
àà5 6
pdfBytes
àà6 >
)
àà> ?
;
àà? @
return
ââ 
memoryStream
ââ 
.
ââ  
ToArray
ââ  '
(
ââ' (
)
ââ( )
;
ââ) *
}
ää 	
)
ää	 

;
ää
 
}
ãã 
}åå ‹∑
PC:\HeroSystem\walletService\WalletService.Core\Services\ExitoJuntosPdfService.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Services

 %
;

% &
public 
class !
ExitoJuntosPdfService "
:# $"
IExitoJuntosPdfService% ;
{ 
public 

async 
Task 
< 
byte 
[ 
] 
> 
GenerateInvoice -
(- .
UserInfoResponse. >
userInfo? G
,G H#
DebitTransactionRequestI `
invoicea h
,h i
InvoicesSpResponse 

spResponse %
)% &
{ 
var 
date 
= 
DateTime 
. 
Now 
.  
ToString  (
(( )
$str) 5
)5 6
;6 7
var 
totalTax 
= 
$num 
; 
var 
subTotal 
= 
$num 
; 
var 
totalDiscount 
= 
$num 
; 
var 
workingDirectory 
= 
Path #
.# $
GetDirectoryName$ 4
(4 5
Assembly5 =
.= > 
GetExecutingAssembly> R
(R S
)S T
.T U
LocationU ]
)] ^
;^ _
var 
	separator 
= 
Path 
. "
DirectorySeparatorChar 3
;3 4
var 
pathFile 
= 
$" 
{ 
workingDirectory *
}* +
{+ ,
	separator, 5
}5 6
$str6 <
{< =
	separator= F
}F G
$strG W
"W X
;X Y
return 
await 
Task 
. 
Run 
( 
( 
)  
=>! #
{ 	
var 
document 
= 
Document #
. 
Create 
( 
doc 
=> 
{ 
doc 
. 
Page 
( 
page !
=>" $
{ 
page   
.   
Margin   #
(  # $
$num  $ &
)  & '
;  ' (
page!! 
.!! 
	PageColor!! &
(!!& '
$str!!' 0
)!!0 1
;!!1 2
page## 
.## 
Header## #
(### $
)##$ %
.##% &
ShowOnce##& .
(##. /
)##/ 0
.##0 1
Row##1 4
(##4 5
row##5 8
=>##9 ;
{$$ 
var%% 
image%%  %
=%%& '
Image%%( -
.%%- .
FromFile%%. 6
(%%6 7
pathFile%%7 ?
)%%? @
;%%@ A
row&& 
.&&  
ConstantItem&&  ,
(&&, -
$num&&- 0
)&&0 1
.&&1 2
	Container&&2 ;
(&&; <
)&&< =
.&&= >
Image&&> C
(&&C D
image&&D I
)&&I J
;&&J K
row(( 
.((  
RelativeItem((  ,
(((, -
)((- .
.((. /
Column((/ 5
(((5 6
col((6 9
=>((: <
{)) 
col**  #
.**# $
Item**$ (
(**( )
)**) *
.*** +

AlignRight**+ 5
(**5 6
)**6 7
.++$ %

Background++% /
(++/ 0
$str++0 9
)++9 :
.,,$ %
Padding,,% ,
(,,, -
$num,,- /
),,/ 0
.,,0 1
Border,,1 7
(,,7 8
$num,,8 9
),,9 :
.,,: ;
BorderColor,,; F
(,,F G
$str,,G P
),,P Q
.--$ %
AlignCenter--% 0
(--0 1
)--1 2
...$ %
Text..% )
(..) *
$"..* ,
$str.., 4
{..4 5

spResponse..5 ?
...? @
Id..@ B
}..B C
"..C D
)..D E
.//$ %
	FontColor//% .
(//. /
$str/// 8
)//8 9
;//9 :
col00  #
.00# $
Item00$ (
(00( )
)00) *
.00* +

AlignRight00+ 5
(005 6
)006 7
.11$ %
Text11% )
(11) *
$str11* =
)11= >
.22$ %
	FontColor22% .
(22. /
$str22/ 8
)228 9
.229 :
FontSize22: B
(22B C
$num22C E
)22E F
;22F G
col33  #
.33# $
Item33$ (
(33( )
)33) *
.33* +

AlignRight33+ 5
(335 6
)336 7
.337 8
Text338 <
(33< =
$str33= ^
)33^ _
.33_ `
	FontColor33` i
(33i j
$str33j s
)33s t
.44$ %
FontSize44% -
(44- .
$num44. 0
)440 1
;441 2
col55  #
.55# $
Item55$ (
(55( )
)55) *
.55* +

AlignRight55+ 5
(555 6
)556 7
.557 8
Text558 <
(55< =
date55= A
)55A B
.55B C
	FontColor55C L
(55L M
$str55M V
)55V W
.55W X
FontSize55X `
(55` a
$num55a c
)55c d
;55d e
}66 
)66 
;66 
}77 
)77 
;77 
page99 
.99 
Content99 $
(99$ %
)99% &
.99& '
PaddingVertical99' 6
(996 7
$num997 9
)999 :
.99: ;
Column99; A
(99A B
col199B F
=>99G I
{:: 
col1;;  
.;;  !
Item;;! %
(;;% &
);;& '
.;;' (

PaddingTop;;( 2
(;;2 3
$num;;3 5
);;5 6
.;;6 7
Row;;7 :
(;;: ;
row;;; >
=>;;? A
{<< 
row==  #
.==# $
RelativeItem==$ 0
(==0 1
)==1 2
.==2 3
Column==3 9
(==9 :
col2==: >
=>==? A
{>>  !
col2??$ (
.??( )
Item??) -
(??- .
)??. /
.??/ 0
	AlignLeft??0 9
(??9 :
)??: ;
.??; <
Text??< @
(??@ A
$str??A T
)??T U
.??U V
	Underline??V _
(??_ `
)??` a
.??a b
Bold??b f
(??f g
)??g h
.@@( )
	FontColor@@) 2
(@@2 3
$str@@3 <
)@@< =
;@@= >
col2BB$ (
.BB( )
ItemBB) -
(BB- .
)BB. /
.BB/ 0
TextBB0 4
(BB4 5
txtBB5 8
=>BB9 ;
{CC$ %
txtDD( +
.DD+ ,
SpanDD, 0
(DD0 1
$strDD1 ;
)DD; <
.DD< =
SemiBoldDD= E
(DDE F
)DDF G
.DDG H
FontSizeDDH P
(DDP Q
$numDDQ S
)DDS T
.DDT U
	FontColorDDU ^
(DD^ _
$strDD_ h
)DDh i
;DDi j
txtEE( +
.EE+ ,
SpanEE, 0
(EE0 1
$"EE1 3
{EE3 4
userInfoEE4 <
.EE< =
NameEE= A
}EEA B
$strEEB C
{EEC D
userInfoEED L
.EEL M
LastNameEEM U
}EEU V
"EEV W
)EEW X
.EEX Y
	FontColorEEY b
(EEb c
$strEEc l
)EEl m
.FF, -
FontSizeFF- 5
(FF5 6
$numFF6 8
)FF8 9
;FF9 :
}GG$ %
)GG% &
;GG& '
col2II$ (
.II( )
ItemII) -
(II- .
)II. /
.II/ 0
TextII0 4
(II4 5
txtII5 8
=>II9 ;
{JJ$ %
txtKK( +
.KK+ ,
SpanKK, 0
(KK0 1
$strKK1 9
)KK9 :
.KK: ;
SemiBoldKK; C
(KKC D
)KKD E
.KKE F
FontSizeKKF N
(KKN O
$numKKO Q
)KKQ R
.KKR S
	FontColorKKS \
(KK\ ]
$strKK] f
)KKf g
;KKg h
txtLL( +
.LL+ ,
SpanLL, 0
(LL0 1
userInfoLL1 9
.LL9 :
CountryLL: A
!LLA B
.LLB C
NameLLC G
)LLG H
.LLH I
	FontColorLLI R
(LLR S
$strLLS \
)LL\ ]
.LL] ^
FontSizeLL^ f
(LLf g
$numLLg i
)LLi j
;LLj k
}MM$ %
)MM% &
;MM& '
col2OO$ (
.OO( )
ItemOO) -
(OO- .
)OO. /
.OO/ 0
TextOO0 4
(OO4 5
txtOO5 8
=>OO9 ;
{PP$ %
txtQQ( +
.QQ+ ,
SpanQQ, 0
(QQ0 1
$strQQ1 ;
)QQ; <
.QQ< =
SemiBoldQQ= E
(QQE F
)QQF G
.QQG H
FontSizeQQH P
(QQP Q
$numQQQ S
)QQS T
.QQT U
	FontColorQQU ^
(QQ^ _
$strQQ_ h
)QQh i
;QQi j
txtRR( +
.RR+ ,
SpanRR, 0
(RR0 1
userInfoRR1 9
.RR9 :
CityRR: >
)RR> ?
.RR? @
	FontColorRR@ I
(RRI J
$strRRJ S
)RRS T
.RRT U
FontSizeRRU ]
(RR] ^
$numRR^ `
)RR` a
;RRa b
}SS$ %
)SS% &
;SS& '
}TT  !
)TT! "
;TT" #
}UU 
)UU 
;UU 
col1WW  
.WW  !
ItemWW! %
(WW% &
)WW& '
.WW' (
LineHorizontalWW( 6
(WW6 7
$numWW7 ;
)WW; <
.WW< =
	LineColorWW= F
(WWF G
$strWWG P
)WWP Q
;WWQ R
col1YY  
.YY  !
ItemYY! %
(YY% &
)YY& '
.YY' (
TableYY( -
(YY- .
tablaYY. 3
=>YY4 6
{ZZ 
tabla[[  %
.[[% &
ColumnsDefinition[[& 7
([[7 8
columns[[8 ?
=>[[@ B
{\\  !
columns]]$ +
.]]+ ,
RelativeColumn]], :
(]]: ;
$num]]; <
)]]< =
;]]= >
columns^^$ +
.^^+ ,
RelativeColumn^^, :
(^^: ;
)^^; <
;^^< =
columns__$ +
.__+ ,
RelativeColumn__, :
(__: ;
)__; <
;__< =
columns``$ +
.``+ ,
RelativeColumn``, :
(``: ;
)``; <
;``< =
columnsaa$ +
.aa+ ,
RelativeColumnaa, :
(aa: ;
)aa; <
;aa< =
}bb  !
)bb! "
;bb" #
tabladd  %
.dd% &
Headerdd& ,
(dd, -
headerdd- 3
=>dd4 6
{ee  !
headerff$ *
.ff* +
Cellff+ /
(ff/ 0
)ff0 1
.ff1 2

Backgroundff2 <
(ff< =
$strff= F
)ffF G
.ffG H
PaddingffH O
(ffO P
$numffP Q
)ffQ R
.ffR S
TextffS W
(ffW X
$strffX b
)ffb c
.gg( )
	FontColorgg) 2
(gg2 3
$strgg3 <
)gg< =
;gg= >
headerhh$ *
.hh* +
Cellhh+ /
(hh/ 0
)hh0 1
.hh1 2

Backgroundhh2 <
(hh< =
$strhh= F
)hhF G
.hhG H
PaddinghhH O
(hhO P
$numhhP Q
)hhQ R
.hhR S
TexthhS W
(hhW X
$strhhX b
)hhb c
.ii( )
	FontColorii) 2
(ii2 3
$strii3 <
)ii< =
;ii= >
headerjj$ *
.jj* +
Celljj+ /
(jj/ 0
)jj0 1
.jj1 2

Backgroundjj2 <
(jj< =
$strjj= F
)jjF G
.jjG H
PaddingjjH O
(jjO P
$numjjP Q
)jjQ R
.jjR S
TextjjS W
(jjW X
$strjjX `
)jj` a
.kk( )
	FontColorkk) 2
(kk2 3
$strkk3 <
)kk< =
;kk= >
headerll$ *
.ll* +
Cellll+ /
(ll/ 0
)ll0 1
.ll1 2

Backgroundll2 <
(ll< =
$strll= F
)llF G
.llG H
PaddingllH O
(llO P
$numllP Q
)llQ R
.llR S
TextllS W
(llW X
$strllX c
)llc d
.mm( )
	FontColormm) 2
(mm2 3
$strmm3 <
)mm< =
;mm= >
headernn$ *
.nn* +
Cellnn+ /
(nn/ 0
)nn0 1
.nn1 2

Backgroundnn2 <
(nn< =
$strnn= F
)nnF G
.nnG H
PaddingnnH O
(nnO P
$numnnP Q
)nnQ R
.nnR S
TextnnS W
(nnW X
$strnnX _
)nn_ `
.oo( )
	FontColoroo) 2
(oo2 3
$stroo3 <
)oo< =
;oo= >
}pp  !
)pp! "
;pp" #
foreachrr  '
(rr( )
varrr) ,
itemrr- 1
inrr2 4
invoicerr5 <
.rr< =
invoicesrr= E
)rrE F
{ss  !
vartt$ '
conceptNamett( 3
=tt4 5
itemtt6 :
.tt: ;
ProductNamett; F
;ttF G
varuu$ '
quantityuu( 0
=uu1 2
itemuu3 7
.uu7 8
ProductQuantityuu8 G
;uuG H
varvv$ '
pricevv( -
=vv. /
itemvv0 4
.vv4 5
ProductPricevv5 A
;vvA B
varww$ '
taxww( +
=ww, -
itemww. 2
.ww2 3

ProductIvaww3 =
;ww= >
varxx$ '
discountxx( 0
=xx1 2
itemxx3 7
.xx7 8
ProductDiscountxx8 G
*xxH I
quantityxxJ R
;xxR S
varyy$ '
totalyy( -
=yy. /
quantityyy0 8
*yy9 :
priceyy; @
;yy@ A
tabla{{$ )
.{{) *
Cell{{* .
({{. /
){{/ 0
.{{0 1
BorderBottom{{1 =
({{= >
$num{{> B
){{B C
.{{C D
BorderColor{{D O
({{O P
$str{{P Y
){{Y Z
.{{Z [
Padding{{[ b
({{b c
$num{{c d
){{d e
.||( )
Text||) -
(||- .
conceptName||. 9
)||9 :
.||: ;
	FontColor||; D
(||D E
$str||E N
)||N O
.||O P
FontSize||P X
(||X Y
$num||Y [
)||[ \
;||\ ]
tabla}}$ )
.}}) *
Cell}}* .
(}}. /
)}}/ 0
.}}0 1
BorderBottom}}1 =
(}}= >
$num}}> B
)}}B C
.}}C D
BorderColor}}D O
(}}O P
$str}}P Y
)}}Y Z
.}}Z [
Padding}}[ b
(}}b c
$num}}c d
)}}d e
.~~( )
Text~~) -
(~~- .
quantity~~. 6
.~~6 7
ToString~~7 ?
(~~? @
)~~@ A
)~~A B
.~~B C
	FontColor~~C L
(~~L M
$str~~M V
)~~V W
.~~W X
FontSize~~X `
(~~` a
$num~~a c
)~~c d
;~~d e
tabla$ )
.) *
Cell* .
(. /
)/ 0
.0 1
BorderBottom1 =
(= >
$num> B
)B C
.C D
BorderColorD O
(O P
$strP Y
)Y Z
.Z [
Padding[ b
(b c
$numc d
)d e
.
ÄÄ( )
Text
ÄÄ) -
(
ÄÄ- .
$"
ÄÄ. 0
$str
ÄÄ0 2
{
ÄÄ2 3
price
ÄÄ3 8
:
ÄÄ8 9
$str
ÄÄ9 =
}
ÄÄ= >
"
ÄÄ> ?
)
ÄÄ? @
.
ÄÄ@ A
	FontColor
ÄÄA J
(
ÄÄJ K
$str
ÄÄK T
)
ÄÄT U
.
ÄÄU V
FontSize
ÄÄV ^
(
ÄÄ^ _
$num
ÄÄ_ a
)
ÄÄa b
;
ÄÄb c
tabla
ÅÅ$ )
.
ÅÅ) *
Cell
ÅÅ* .
(
ÅÅ. /
)
ÅÅ/ 0
.
ÅÅ0 1
BorderBottom
ÅÅ1 =
(
ÅÅ= >
$num
ÅÅ> B
)
ÅÅB C
.
ÅÅC D
BorderColor
ÅÅD O
(
ÅÅO P
$str
ÅÅP Y
)
ÅÅY Z
.
ÅÅZ [
Padding
ÅÅ[ b
(
ÅÅb c
$num
ÅÅc d
)
ÅÅd e
.
ÇÇ( )
Text
ÇÇ) -
(
ÇÇ- .
$"
ÇÇ. 0
$str
ÇÇ0 2
{
ÇÇ2 3
discount
ÇÇ3 ;
:
ÇÇ; <
$str
ÇÇ< @
}
ÇÇ@ A
"
ÇÇA B
)
ÇÇB C
.
ÇÇC D
	FontColor
ÇÇD M
(
ÇÇM N
$str
ÇÇN W
)
ÇÇW X
.
ÇÇX Y
FontSize
ÇÇY a
(
ÇÇa b
$num
ÇÇb d
)
ÇÇd e
;
ÇÇe f
tabla
ÉÉ$ )
.
ÉÉ) *
Cell
ÉÉ* .
(
ÉÉ. /
)
ÉÉ/ 0
.
ÉÉ0 1
BorderBottom
ÉÉ1 =
(
ÉÉ= >
$num
ÉÉ> B
)
ÉÉB C
.
ÉÉC D
BorderColor
ÉÉD O
(
ÉÉO P
$str
ÉÉP Y
)
ÉÉY Z
.
ÉÉZ [
Padding
ÉÉ[ b
(
ÉÉb c
$num
ÉÉc d
)
ÉÉd e
.
ÑÑ( )
Text
ÑÑ) -
(
ÑÑ- .
$"
ÑÑ. 0
$str
ÑÑ0 2
{
ÑÑ2 3
total
ÑÑ3 8
:
ÑÑ8 9
$str
ÑÑ9 =
}
ÑÑ= >
"
ÑÑ> ?
)
ÑÑ? @
.
ÑÑ@ A
	FontColor
ÑÑA J
(
ÑÑJ K
$str
ÑÑK T
)
ÑÑT U
.
ÑÑU V
FontSize
ÑÑV ^
(
ÑÑ^ _
$num
ÑÑ_ a
)
ÑÑa b
;
ÑÑb c
subTotal
ÜÜ$ ,
+=
ÜÜ- /
total
ÜÜ0 5
;
ÜÜ5 6
totalDiscount
áá$ 1
+=
áá2 4
discount
áá5 =
;
áá= >
totalTax
àà$ ,
=
àà- .
tax
àà/ 2
;
àà2 3
}
ââ  !
}
ää 
)
ää 
;
ää 
col1
åå  
.
åå  !
Item
åå! %
(
åå% &
)
åå& '
.
åå' (

PaddingTop
åå( 2
(
åå2 3
$num
åå3 5
)
åå5 6
.
åå6 7
Row
åå7 :
(
åå: ;
row
åå; >
=>
åå? A
{
çç 
row
éé  #
.
éé# $
RelativeItem
éé$ 0
(
éé0 1
)
éé1 2
.
éé2 3
Column
éé3 9
(
éé9 :
col2
éé: >
=>
éé? A
{
èè  !
col2
êê$ (
.
êê( )
Item
êê) -
(
êê- .
)
êê. /
.
êê/ 0

AlignRight
êê0 :
(
êê: ;
)
êê; <
.
êê< =
Text
êê= A
(
êêA B
$str
êêB P
)
êêP Q
.
êêQ R
Bold
êêR V
(
êêV W
)
êêW X
.
êêX Y
FontSize
êêY a
(
êêa b
$num
êêb d
)
êêd e
.
ëë( )
	FontColor
ëë) 2
(
ëë2 3
$str
ëë3 <
)
ëë< =
;
ëë= >
col2
íí$ (
.
íí( )
Item
íí) -
(
íí- .
)
íí. /
.
íí/ 0

AlignRight
íí0 :
(
íí: ;
)
íí; <
.
íí< =
Text
íí= A
(
ííA B
$"
ííB D
$str
ííD L
{
ííL M
invoice
ííM T
.
ííT U
Debit
ííU Z
:
ííZ [
$str
íí[ _
}
íí_ `
"
íí` a
)
íía b
.
ìì( )
FontSize
ìì) 1
(
ìì1 2
$num
ìì2 4
)
ìì4 5
.
ìì5 6
	FontColor
ìì6 ?
(
ìì? @
$str
ìì@ I
)
ììI J
;
ììJ K
col2
îî$ (
.
îî( )
Item
îî) -
(
îî- .
)
îî. /
.
îî/ 0

AlignRight
îî0 :
(
îî: ;
)
îî; <
.
îî< =
Text
îî= A
(
îîA B
$str
îîB R
)
îîR S
.
îîS T
FontSize
îîT \
(
îî\ ]
$num
îî] _
)
îî_ `
.
îî` a
	FontColor
îîa j
(
îîj k
$str
îîk t
)
îît u
;
îîu v
col2
ïï$ (
.
ïï( )
Item
ïï) -
(
ïï- .
)
ïï. /
.
ïï/ 0

AlignRight
ïï0 :
(
ïï: ;
)
ïï; <
.
ïï< =
Text
ïï= A
(
ïïA B
date
ïïB F
)
ïïF G
.
ïïG H
FontSize
ïïH P
(
ïïP Q
$num
ïïQ S
)
ïïS T
.
ïïT U
	FontColor
ïïU ^
(
ïï^ _
$str
ïï_ h
)
ïïh i
;
ïïi j
}
ññ  !
)
ññ! "
;
ññ" #
}
óó 
)
óó 
;
óó 
}
òò 
)
òò 
;
òò 
page
öö 
.
öö 
Footer
öö #
(
öö# $
)
öö$ %
.
õõ 

AlignRight
õõ '
(
õõ' (
)
õõ( )
.
úú 
Text
úú !
(
úú! "
txt
úú" %
=>
úú& (
{
ùù 
txt
ûû  #
.
ûû# $
Span
ûû$ (
(
ûû( )
$str
ûû) 2
)
ûû2 3
.
ûû3 4
FontSize
ûû4 <
(
ûû< =
$num
ûû= ?
)
ûû? @
.
ûû@ A
	FontColor
ûûA J
(
ûûJ K
$str
ûûK T
)
ûûT U
;
ûûU V
txt
üü  #
.
üü# $
CurrentPageNumber
üü$ 5
(
üü5 6
)
üü6 7
.
üü7 8
FontSize
üü8 @
(
üü@ A
$num
üüA C
)
üüC D
.
üüD E
	FontColor
üüE N
(
üüN O
$str
üüO X
)
üüX Y
;
üüY Z
txt
††  #
.
††# $
Span
††$ (
(
††( )
$str
††) /
)
††/ 0
.
††0 1
FontSize
††1 9
(
††9 :
$num
††: <
)
††< =
.
††= >
	FontColor
††> G
(
††G H
$str
††H Q
)
††Q R
;
††R S
txt
°°  #
.
°°# $

TotalPages
°°$ .
(
°°. /
)
°°/ 0
.
°°0 1
FontSize
°°1 9
(
°°9 :
$num
°°: <
)
°°< =
.
°°= >
	FontColor
°°> G
(
°°G H
$str
°°H Q
)
°°Q R
;
°°R S
}
¢¢ 
)
¢¢ 
;
¢¢ 
}
££ 
)
££ 
;
££ 
}
§§ 
)
§§ 
;
§§ 
byte
¶¶ 
[
¶¶ 
]
¶¶ 
pdfBytes
¶¶ 
=
¶¶ 
document
¶¶ &
.
¶¶& '
GeneratePdf
¶¶' 2
(
¶¶2 3
)
¶¶3 4
;
¶¶4 5
using
ßß 
var
ßß 
memoryStream
ßß "
=
ßß# $
new
ßß% (
MemoryStream
ßß) 5
(
ßß5 6
pdfBytes
ßß6 >
)
ßß> ?
;
ßß? @
return
®® 
memoryStream
®® 
.
®®  
ToArray
®®  '
(
®®' (
)
®®( )
;
®®) *
}
©© 	
)
©©	 

;
©©
 
}
™™ 
}´´ ÚÓ
NC:\HeroSystem\walletService\WalletService.Core\Services\HouseCoinPdfService.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Services

 %
;

% &
public 
class 
HouseCoinPdfService  
:! " 
IHouseCoinPdfService# 7
{ 
public 

async 
Task 
< 
byte 
[ 
] 
> 
GenerateInvoice -
(- .
UserInfoResponse. >
userInfo? G
,G H#
DebitTransactionRequestI `
invoicea h
,h i
InvoicesSpResponse 

spResponse %
)% &
{ 
var 
date 
= 
DateTime 
. 
Now 
.  
ToString  (
(( )
$str) 5
)5 6
;6 7
var 
totalTax 
= 
$num 
; 
var 
subTotal 
= 
$num 
; 
var 
totalDiscount 
= 
$num 
; 
var 
workingDirectory 
= 
Path #
.# $
GetDirectoryName$ 4
(4 5
Assembly5 =
.= > 
GetExecutingAssembly> R
(R S
)S T
.T U
LocationU ]
)] ^
;^ _
var 
	separator 
= 
Path 
. "
DirectorySeparatorChar 3
;3 4
var 
pathFile 
= 
$" 
{ 
workingDirectory *
}* +
{+ ,
	separator, 5
}5 6
$str6 <
{< =
	separator= F
}F G
$strG Z
"Z [
;[ \
return 
await 
Task 
. 
Run 
( 
( 
)  
=>! #
{ 	
var 
document 
= 
Document #
. 
Create 
( 
doc 
=> 
{ 
doc 
. 
Page 
( 
page !
=>" $
{ 
page   
.   
Margin   #
(  # $
$num  $ &
)  & '
;  ' (
page!! 
.!! 
	PageColor!! &
(!!& '
$str!!' 0
)!!0 1
;!!1 2
page## 
.## 
Header## #
(### $
)##$ %
.##% &
ShowOnce##& .
(##. /
)##/ 0
.##0 1
Row##1 4
(##4 5
row##5 8
=>##9 ;
{$$ 
var%% 
image%%  %
=%%& '
Image%%( -
.%%- .
FromFile%%. 6
(%%6 7
pathFile%%7 ?
)%%? @
;%%@ A
row&& 
.&&  
ConstantItem&&  ,
(&&, -
$num&&- 0
)&&0 1
.&&1 2
	Container&&2 ;
(&&; <
)&&< =
.&&= >
Image&&> C
(&&C D
image&&D I
)&&I J
;&&J K
row(( 
.((  
RelativeItem((  ,
(((, -
)((- .
.((. /
Column((/ 5
(((5 6
col((6 9
=>((: <
{)) 
col**  #
.**# $
Item**$ (
(**( )
)**) *
.*** +

AlignRight**+ 5
(**5 6
)**6 7
.++$ %

Background++% /
(++/ 0
$str++0 9
)++9 :
.,,$ %
Padding,,% ,
(,,, -
$num,,- /
),,/ 0
.,,0 1
Border,,1 7
(,,7 8
$num,,8 9
),,9 :
.,,: ;
BorderColor,,; F
(,,F G
$str,,G P
),,P Q
.--$ %
AlignCenter--% 0
(--0 1
)--1 2
...$ %
Text..% )
(..) *
$"..* ,
$str.., 4
{..4 5

spResponse..5 ?
...? @
Id..@ B
}..B C
"..C D
)..D E
.//$ %
	FontColor//% .
(//. /
$str/// 8
)//8 9
;//9 :
col11  #
.11# $
Item11$ (
(11( )
)11) *
.11* +

AlignRight11+ 5
(115 6
)116 7
.117 8
Text118 <
(11< =
$str11= b
)11b c
.22$ %
	FontColor22% .
(22. /
$str22/ 8
)228 9
.229 :
FontSize22: B
(22B C
$num22C E
)22E F
;22F G
col33  #
.33# $
Item33$ (
(33( )
)33) *
.33* +

AlignRight33+ 5
(335 6
)336 7
.337 8
Text338 <
(33< =
$str33= K
)33K L
.33L M
	FontColor33M V
(33V W
$str33W `
)33` a
.33a b
FontSize33b j
(33j k
$num33k m
)33m n
;33n o
col44  #
.44# $
Item44$ (
(44( )
)44) *
.44* +

AlignRight44+ 5
(445 6
)446 7
.55$ %
Text55% )
(55) *
$str55* =
)55= >
.66$ %
	FontColor66% .
(66. /
$str66/ 8
)668 9
.669 :
FontSize66: B
(66B C
$num66C E
)66E F
;66F G
col77  #
.77# $
Item77$ (
(77( )
)77) *
.77* +

AlignRight77+ 5
(775 6
)776 7
.777 8
Text778 <
(77< =
$str77= V
)77V W
.77W X
	FontColor77X a
(77a b
$str77b k
)77k l
.88$ %
FontSize88% -
(88- .
$num88. 0
)880 1
;881 2
col99  #
.99# $
Item99$ (
(99( )
)99) *
.99* +

AlignRight99+ 5
(995 6
)996 7
.997 8
Text998 <
(99< =
$str99= _
)99_ `
.99` a
	FontColor99a j
(99j k
$str99k t
)99t u
.::$ %
FontSize::% -
(::- .
$num::. 0
)::0 1
;::1 2
col;;  #
.;;# $
Item;;$ (
(;;( )
);;) *
.;;* +

AlignRight;;+ 5
(;;5 6
);;6 7
.;;7 8
Text;;8 <
(;;< =
date;;= A
);;A B
.;;B C
	FontColor;;C L
(;;L M
$str;;M V
);;V W
.;;W X
FontSize;;X `
(;;` a
$num;;a c
);;c d
;;;d e
}<< 
)<< 
;<< 
}== 
)== 
;== 
page?? 
.?? 
Content?? $
(??$ %
)??% &
.??& '
PaddingVertical??' 6
(??6 7
$num??7 9
)??9 :
.??: ;
Column??; A
(??A B
col1??B F
=>??G I
{@@ 
col1AA  
.AA  !
ItemAA! %
(AA% &
)AA& '
.AA' (

PaddingTopAA( 2
(AA2 3
$numAA3 5
)AA5 6
.AA6 7
RowAA7 :
(AA: ;
rowAA; >
=>AA? A
{BB 
rowCC  #
.CC# $
RelativeItemCC$ 0
(CC0 1
)CC1 2
.CC2 3
ColumnCC3 9
(CC9 :
col2CC: >
=>CC? A
{DD  !
col2EE$ (
.EE( )
ItemEE) -
(EE- .
)EE. /
.EE/ 0
	AlignLeftEE0 9
(EE9 :
)EE: ;
.EE; <
TextEE< @
(EE@ A
$strEEA T
)EET U
.EEU V
	UnderlineEEV _
(EE_ `
)EE` a
.EEa b
BoldEEb f
(EEf g
)EEg h
.FF( )
	FontColorFF) 2
(FF2 3
$strFF3 <
)FF< =
;FF= >
col2HH$ (
.HH( )
ItemHH) -
(HH- .
)HH. /
.HH/ 0
TextHH0 4
(HH4 5
txtHH5 8
=>HH9 ;
{II$ %
txtJJ( +
.JJ+ ,
SpanJJ, 0
(JJ0 1
$strJJ1 ;
)JJ; <
.JJ< =
SemiBoldJJ= E
(JJE F
)JJF G
.JJG H
FontSizeJJH P
(JJP Q
$numJJQ S
)JJS T
.JJT U
	FontColorJJU ^
(JJ^ _
$strJJ_ h
)JJh i
;JJi j
txtKK( +
.KK+ ,
SpanKK, 0
(KK0 1
$"KK1 3
{KK3 4
userInfoKK4 <
.KK< =
NameKK= A
}KKA B
$strKKB C
{KKC D
userInfoKKD L
.KKL M
LastNameKKM U
}KKU V
"KKV W
)KKW X
.KKX Y
	FontColorKKY b
(KKb c
$strKKc l
)KKl m
.LL, -
FontSizeLL- 5
(LL5 6
$numLL6 8
)LL8 9
;LL9 :
}MM$ %
)MM% &
;MM& '
col2OO$ (
.OO( )
ItemOO) -
(OO- .
)OO. /
.OO/ 0
TextOO0 4
(OO4 5
txtOO5 8
=>OO9 ;
{PP$ %
txtQQ( +
.QQ+ ,
SpanQQ, 0
(QQ0 1
$strQQ1 9
)QQ9 :
.QQ: ;
SemiBoldQQ; C
(QQC D
)QQD E
.QQE F
FontSizeQQF N
(QQN O
$numQQO Q
)QQQ R
.QQR S
	FontColorQQS \
(QQ\ ]
$strQQ] f
)QQf g
;QQg h
txtRR( +
.RR+ ,
SpanRR, 0
(RR0 1
userInfoRR1 9
.RR9 :
CountryRR: A
!RRA B
.RRB C
NameRRC G
)RRG H
.RRH I
	FontColorRRI R
(RRR S
$strRRS \
)RR\ ]
.RR] ^
FontSizeRR^ f
(RRf g
$numRRg i
)RRi j
;RRj k
}SS$ %
)SS% &
;SS& '
col2UU$ (
.UU( )
ItemUU) -
(UU- .
)UU. /
.UU/ 0
TextUU0 4
(UU4 5
txtUU5 8
=>UU9 ;
{VV$ %
txtWW( +
.WW+ ,
SpanWW, 0
(WW0 1
$strWW1 ;
)WW; <
.WW< =
SemiBoldWW= E
(WWE F
)WWF G
.WWG H
FontSizeWWH P
(WWP Q
$numWWQ S
)WWS T
.WWT U
	FontColorWWU ^
(WW^ _
$strWW_ h
)WWh i
;WWi j
txtXX( +
.XX+ ,
SpanXX, 0
(XX0 1
userInfoXX1 9
.XX9 :
CityXX: >
)XX> ?
.XX? @
	FontColorXX@ I
(XXI J
$strXXJ S
)XXS T
.XXT U
FontSizeXXU ]
(XX] ^
$numXX^ `
)XX` a
;XXa b
}YY$ %
)YY% &
;YY& '
}ZZ  !
)ZZ! "
;ZZ" #
row\\  #
.\\# $
RelativeItem\\$ 0
(\\0 1
)\\1 2
.\\2 3
Column\\3 9
(\\9 :
col2\\: >
=>\\? A
{]]  !
col2^^$ (
.^^( )
Item^^) -
(^^- .
)^^. /
.^^/ 0

AlignRight^^0 :
(^^: ;
)^^; <
.^^< =
Text^^= A
(^^A B
txt^^B E
=>^^F H
{__$ %
txt``( +
.``+ ,
Span``, 0
(``0 1
$str``1 =
)``= >
.``> ?
SemiBold``? G
(``G H
)``H I
.``I J
FontSize``J R
(``R S
$num``S U
)``U V
.``V W
	FontColor``W `
(``` a
$str``a j
)``j k
;``k l
txtaa( +
.aa+ ,
Spanaa, 0
(aa0 1
userInfoaa1 9
.aa9 :
Phoneaa: ?
)aa? @
.aa@ A
	FontColoraaA J
(aaJ K
$straaK T
)aaT U
.aaU V
FontSizeaaV ^
(aa^ _
$numaa_ a
)aaa b
;aab c
}bb$ %
)bb% &
;bb& '
col2dd$ (
.dd( )
Itemdd) -
(dd- .
)dd. /
.dd/ 0

AlignRightdd0 :
(dd: ;
)dd; <
.dd< =
Textdd= A
(ddA B
txtddB E
=>ddF H
{ee$ %
txtff( +
.ff+ ,
Spanff, 0
(ff0 1
$strff1 P
)ffP Q
.ffQ R
SemiBoldffR Z
(ffZ [
)ff[ \
.ff\ ]
FontSizeff] e
(ffe f
$numfff h
)ffh i
.gg, -
	FontColorgg- 6
(gg6 7
$strgg7 @
)gg@ A
;ggA B
txthh( +
.hh+ ,
Spanhh, 0
(hh0 1
userInfohh1 9
.hh9 :
UserNamehh: B
)hhB C
.hhC D
	FontColorhhD M
(hhM N
$strhhN W
)hhW X
.hhX Y
FontSizehhY a
(hha b
$numhhb d
)hhd e
;hhe f
}ii$ %
)ii% &
;ii& '
col2kk$ (
.kk( )
Itemkk) -
(kk- .
)kk. /
.kk/ 0

AlignRightkk0 :
(kk: ;
)kk; <
.kk< =
Textkk= A
(kkA B
txtkkB E
=>kkF H
{ll$ %
txtmm( +
.mm+ ,
Spanmm, 0
(mm0 1
$strmm1 ;
)mm; <
.mm< =
SemiBoldmm= E
(mmE F
)mmF G
.mmG H
FontSizemmH P
(mmP Q
$nummmQ S
)mmS T
.mmT U
	FontColormmU ^
(mm^ _
$strmm_ h
)mmh i
;mmi j
txtnn( +
.nn+ ,
Spannn, 0
(nn0 1
userInfonn1 9
.nn9 :
Emailnn: ?
)nn? @
.nn@ A
	FontColornnA J
(nnJ K
$strnnK T
)nnT U
.nnU V
FontSizennV ^
(nn^ _
$numnn_ a
)nna b
;nnb c
}oo$ %
)oo% &
;oo& '
col2qq$ (
.qq( )
Itemqq) -
(qq- .
)qq. /
.qq/ 0

AlignRightqq0 :
(qq: ;
)qq; <
.qq< =
Textqq= A
(qqA B
txtqqB E
=>qqF H
{rr$ %
txtss( +
.ss+ ,
Spanss, 0
(ss0 1
$strss1 >
)ss> ?
.ss? @
SemiBoldss@ H
(ssH I
)ssI J
.ssJ K
FontSizessK S
(ssS T
$numssT V
)ssV W
.ssW X
	FontColorssX a
(ssa b
$strssb k
)ssk l
;ssl m
txttt( +
.tt+ ,
Spantt, 0
(tt0 1
userInfott1 9
.tt9 :
Addresstt: A
)ttA B
.ttB C
	FontColorttC L
(ttL M
$strttM V
)ttV W
.ttW X
FontSizettX `
(tt` a
$numtta c
)ttc d
;ttd e
}uu$ %
)uu% &
;uu& '
col2ww$ (
.ww( )
Itemww) -
(ww- .
)ww. /
.ww/ 0

AlignRightww0 :
(ww: ;
)ww; <
.ww< =
Textww= A
(wwA B
txtwwB E
=>wwF H
{xx$ %
ifyy( *
(yy+ ,
!yy, -
stringyy- 3
.yy3 4
IsNullOrEmptyyy4 A
(yyA B

spResponseyyB L
.yyL M
ReasonyyM S
)yyS T
)yyT U
{zz( )
txt{{, /
.{{/ 0
Span{{0 4
({{4 5
$str{{5 C
){{C D
.{{D E
SemiBold{{E M
({{M N
){{N O
.{{O P
FontSize{{P X
({{X Y
$num{{Y [
){{[ \
.{{\ ]
	FontColor{{] f
({{f g
$str{{g p
){{p q
;{{q r
txt||, /
.||/ 0
Span||0 4
(||4 5

spResponse||5 ?
.||? @
Reason||@ F
)||F G
.||G H
	FontColor||H Q
(||Q R
$str||R [
)||[ \
.||\ ]
FontSize||] e
(||e f
$num||f h
)||h i
;||i j
}}}( )
}~~$ %
)~~% &
;~~& '
}  !
)! "
;" #
}
ÄÄ 
)
ÄÄ 
;
ÄÄ 
col1
ÇÇ  
.
ÇÇ  !
Item
ÇÇ! %
(
ÇÇ% &
)
ÇÇ& '
.
ÇÇ' (
LineHorizontal
ÇÇ( 6
(
ÇÇ6 7
$num
ÇÇ7 ;
)
ÇÇ; <
.
ÇÇ< =
	LineColor
ÇÇ= F
(
ÇÇF G
$str
ÇÇG P
)
ÇÇP Q
;
ÇÇQ R
col1
ÑÑ  
.
ÑÑ  !
Item
ÑÑ! %
(
ÑÑ% &
)
ÑÑ& '
.
ÑÑ' (
Table
ÑÑ( -
(
ÑÑ- .
tabla
ÑÑ. 3
=>
ÑÑ4 6
{
ÖÖ 
tabla
ÜÜ  %
.
ÜÜ% &
ColumnsDefinition
ÜÜ& 7
(
ÜÜ7 8
columns
ÜÜ8 ?
=>
ÜÜ@ B
{
áá  !
columns
àà$ +
.
àà+ ,
RelativeColumn
àà, :
(
àà: ;
$num
àà; <
)
àà< =
;
àà= >
columns
ââ$ +
.
ââ+ ,
RelativeColumn
ââ, :
(
ââ: ;
)
ââ; <
;
ââ< =
columns
ää$ +
.
ää+ ,
RelativeColumn
ää, :
(
ää: ;
)
ää; <
;
ää< =
columns
ãã$ +
.
ãã+ ,
RelativeColumn
ãã, :
(
ãã: ;
)
ãã; <
;
ãã< =
columns
åå$ +
.
åå+ ,
RelativeColumn
åå, :
(
åå: ;
)
åå; <
;
åå< =
}
çç  !
)
çç! "
;
çç" #
tabla
èè  %
.
èè% &
Header
èè& ,
(
èè, -
header
èè- 3
=>
èè4 6
{
êê  !
header
ëë$ *
.
ëë* +
Cell
ëë+ /
(
ëë/ 0
)
ëë0 1
.
ëë1 2

Background
ëë2 <
(
ëë< =
$str
ëë= F
)
ëëF G
.
ëëG H
Padding
ëëH O
(
ëëO P
$num
ëëP Q
)
ëëQ R
.
ëëR S
Text
ëëS W
(
ëëW X
$str
ëëX b
)
ëëb c
.
íí( )
	FontColor
íí) 2
(
íí2 3
$str
íí3 <
)
íí< =
;
íí= >
header
ìì$ *
.
ìì* +
Cell
ìì+ /
(
ìì/ 0
)
ìì0 1
.
ìì1 2

Background
ìì2 <
(
ìì< =
$str
ìì= F
)
ììF G
.
ììG H
Padding
ììH O
(
ììO P
$num
ììP Q
)
ììQ R
.
ììR S
Text
ììS W
(
ììW X
$str
ììX b
)
ììb c
.
îî( )
	FontColor
îî) 2
(
îî2 3
$str
îî3 <
)
îî< =
;
îî= >
header
ïï$ *
.
ïï* +
Cell
ïï+ /
(
ïï/ 0
)
ïï0 1
.
ïï1 2

Background
ïï2 <
(
ïï< =
$str
ïï= F
)
ïïF G
.
ïïG H
Padding
ïïH O
(
ïïO P
$num
ïïP Q
)
ïïQ R
.
ïïR S
Text
ïïS W
(
ïïW X
$str
ïïX `
)
ïï` a
.
ññ( )
	FontColor
ññ) 2
(
ññ2 3
$str
ññ3 <
)
ññ< =
;
ññ= >
header
óó$ *
.
óó* +
Cell
óó+ /
(
óó/ 0
)
óó0 1
.
óó1 2

Background
óó2 <
(
óó< =
$str
óó= F
)
óóF G
.
óóG H
Padding
óóH O
(
óóO P
$num
óóP Q
)
óóQ R
.
óóR S
Text
óóS W
(
óóW X
$str
óóX c
)
óóc d
.
òò( )
	FontColor
òò) 2
(
òò2 3
$str
òò3 <
)
òò< =
;
òò= >
header
ôô$ *
.
ôô* +
Cell
ôô+ /
(
ôô/ 0
)
ôô0 1
.
ôô1 2

Background
ôô2 <
(
ôô< =
$str
ôô= F
)
ôôF G
.
ôôG H
Padding
ôôH O
(
ôôO P
$num
ôôP Q
)
ôôQ R
.
ôôR S
Text
ôôS W
(
ôôW X
$str
ôôX _
)
ôô_ `
.
öö( )
	FontColor
öö) 2
(
öö2 3
$str
öö3 <
)
öö< =
;
öö= >
}
õõ  !
)
õõ! "
;
õõ" #
foreach
ùù  '
(
ùù( )
var
ùù) ,
item
ùù- 1
in
ùù2 4
invoice
ùù5 <
.
ùù< =
invoices
ùù= E
)
ùùE F
{
ûû  !
var
üü$ '
conceptName
üü( 3
=
üü4 5
item
üü6 :
.
üü: ;
ProductName
üü; F
;
üüF G
var
††$ '
quantity
††( 0
=
††1 2
item
††3 7
.
††7 8
ProductQuantity
††8 G
;
††G H
var
°°$ '
price
°°( -
=
°°. /
item
°°0 4
.
°°4 5
ProductPrice
°°5 A
;
°°A B
var
¢¢$ '
tax
¢¢( +
=
¢¢, -
item
¢¢. 2
.
¢¢2 3

ProductIva
¢¢3 =
;
¢¢= >
var
££$ '
discount
££( 0
=
££1 2
item
££3 7
.
££7 8
ProductDiscount
££8 G
*
££H I
quantity
££J R
;
££R S
var
§§$ '
total
§§( -
=
§§. /
quantity
§§0 8
*
§§9 :
price
§§; @
;
§§@ A
tabla
¶¶$ )
.
¶¶) *
Cell
¶¶* .
(
¶¶. /
)
¶¶/ 0
.
¶¶0 1
BorderBottom
¶¶1 =
(
¶¶= >
$num
¶¶> B
)
¶¶B C
.
¶¶C D
BorderColor
¶¶D O
(
¶¶O P
$str
¶¶P Y
)
¶¶Y Z
.
¶¶Z [
Padding
¶¶[ b
(
¶¶b c
$num
¶¶c d
)
¶¶d e
.
ßß( )
Text
ßß) -
(
ßß- .
conceptName
ßß. 9
)
ßß9 :
.
ßß: ;
	FontColor
ßß; D
(
ßßD E
$str
ßßE N
)
ßßN O
.
ßßO P
FontSize
ßßP X
(
ßßX Y
$num
ßßY [
)
ßß[ \
;
ßß\ ]
tabla
®®$ )
.
®®) *
Cell
®®* .
(
®®. /
)
®®/ 0
.
®®0 1
BorderBottom
®®1 =
(
®®= >
$num
®®> B
)
®®B C
.
®®C D
BorderColor
®®D O
(
®®O P
$str
®®P Y
)
®®Y Z
.
®®Z [
Padding
®®[ b
(
®®b c
$num
®®c d
)
®®d e
.
©©( )
Text
©©) -
(
©©- .
quantity
©©. 6
.
©©6 7
ToString
©©7 ?
(
©©? @
)
©©@ A
)
©©A B
.
©©B C
	FontColor
©©C L
(
©©L M
$str
©©M V
)
©©V W
.
©©W X
FontSize
©©X `
(
©©` a
$num
©©a c
)
©©c d
;
©©d e
tabla
™™$ )
.
™™) *
Cell
™™* .
(
™™. /
)
™™/ 0
.
™™0 1
BorderBottom
™™1 =
(
™™= >
$num
™™> B
)
™™B C
.
™™C D
BorderColor
™™D O
(
™™O P
$str
™™P Y
)
™™Y Z
.
™™Z [
Padding
™™[ b
(
™™b c
$num
™™c d
)
™™d e
.
´´( )
Text
´´) -
(
´´- .
$"
´´. 0
$str
´´0 2
{
´´2 3
price
´´3 8
:
´´8 9
$str
´´9 =
}
´´= >
"
´´> ?
)
´´? @
.
´´@ A
	FontColor
´´A J
(
´´J K
$str
´´K T
)
´´T U
.
´´U V
FontSize
´´V ^
(
´´^ _
$num
´´_ a
)
´´a b
;
´´b c
tabla
¨¨$ )
.
¨¨) *
Cell
¨¨* .
(
¨¨. /
)
¨¨/ 0
.
¨¨0 1
BorderBottom
¨¨1 =
(
¨¨= >
$num
¨¨> B
)
¨¨B C
.
¨¨C D
BorderColor
¨¨D O
(
¨¨O P
$str
¨¨P Y
)
¨¨Y Z
.
¨¨Z [
Padding
¨¨[ b
(
¨¨b c
$num
¨¨c d
)
¨¨d e
.
≠≠( )
Text
≠≠) -
(
≠≠- .
$"
≠≠. 0
$str
≠≠0 2
{
≠≠2 3
discount
≠≠3 ;
:
≠≠; <
$str
≠≠< @
}
≠≠@ A
"
≠≠A B
)
≠≠B C
.
≠≠C D
	FontColor
≠≠D M
(
≠≠M N
$str
≠≠N W
)
≠≠W X
.
≠≠X Y
FontSize
≠≠Y a
(
≠≠a b
$num
≠≠b d
)
≠≠d e
;
≠≠e f
tabla
ÆÆ$ )
.
ÆÆ) *
Cell
ÆÆ* .
(
ÆÆ. /
)
ÆÆ/ 0
.
ÆÆ0 1
BorderBottom
ÆÆ1 =
(
ÆÆ= >
$num
ÆÆ> B
)
ÆÆB C
.
ÆÆC D
BorderColor
ÆÆD O
(
ÆÆO P
$str
ÆÆP Y
)
ÆÆY Z
.
ÆÆZ [
Padding
ÆÆ[ b
(
ÆÆb c
$num
ÆÆc d
)
ÆÆd e
.
ØØ( )
Text
ØØ) -
(
ØØ- .
$"
ØØ. 0
$str
ØØ0 2
{
ØØ2 3
total
ØØ3 8
:
ØØ8 9
$str
ØØ9 =
}
ØØ= >
"
ØØ> ?
)
ØØ? @
.
ØØ@ A
	FontColor
ØØA J
(
ØØJ K
$str
ØØK T
)
ØØT U
.
ØØU V
FontSize
ØØV ^
(
ØØ^ _
$num
ØØ_ a
)
ØØa b
;
ØØb c
subTotal
±±$ ,
+=
±±- /
total
±±0 5
;
±±5 6
totalDiscount
≤≤$ 1
+=
≤≤2 4
discount
≤≤5 =
;
≤≤= >
totalTax
≥≥$ ,
=
≥≥- .
tax
≥≥/ 2
;
≥≥2 3
}
¥¥  !
}
µµ 
)
µµ 
;
µµ 
col1
∑∑  
.
∑∑  !
Item
∑∑! %
(
∑∑% &
)
∑∑& '
.
∑∑' (

PaddingTop
∑∑( 2
(
∑∑2 3
$num
∑∑3 5
)
∑∑5 6
.
∑∑6 7
Row
∑∑7 :
(
∑∑: ;
row
∑∑; >
=>
∑∑? A
{
∏∏ 
row
ππ  #
.
ππ# $
RelativeItem
ππ$ 0
(
ππ0 1
)
ππ1 2
.
ππ2 3
Column
ππ3 9
(
ππ9 :
col2
ππ: >
=>
ππ? A
{
∫∫  !
col2
ªª$ (
.
ªª( )
Item
ªª) -
(
ªª- .
)
ªª. /
.
ªª/ 0

AlignRight
ªª0 :
(
ªª: ;
)
ªª; <
.
ªª< =
Text
ªª= A
(
ªªA B
$str
ªªB P
)
ªªP Q
.
ªªQ R
Bold
ªªR V
(
ªªV W
)
ªªW X
.
ªªX Y
FontSize
ªªY a
(
ªªa b
$num
ªªb d
)
ªªd e
.
ºº( )
	FontColor
ºº) 2
(
ºº2 3
$str
ºº3 <
)
ºº< =
;
ºº= >
col2
ΩΩ$ (
.
ΩΩ( )
Item
ΩΩ) -
(
ΩΩ- .
)
ΩΩ. /
.
ΩΩ/ 0

AlignRight
ΩΩ0 :
(
ΩΩ: ;
)
ΩΩ; <
.
ΩΩ< =
Text
ΩΩ= A
(
ΩΩA B
$"
ΩΩB D
$str
ΩΩD L
{
ΩΩL M
invoice
ΩΩM T
.
ΩΩT U
Debit
ΩΩU Z
:
ΩΩZ [
$str
ΩΩ[ _
}
ΩΩ_ `
"
ΩΩ` a
)
ΩΩa b
.
ææ( )
FontSize
ææ) 1
(
ææ1 2
$num
ææ2 4
)
ææ4 5
.
ææ5 6
	FontColor
ææ6 ?
(
ææ? @
$str
ææ@ I
)
ææI J
;
ææJ K
col2
øø$ (
.
øø( )
Item
øø) -
(
øø- .
)
øø. /
.
øø/ 0

AlignRight
øø0 :
(
øø: ;
)
øø; <
.
øø< =
Text
øø= A
(
øøA B
$str
øøB R
)
øøR S
.
øøS T
FontSize
øøT \
(
øø\ ]
$num
øø] _
)
øø_ `
.
øø` a
	FontColor
øøa j
(
øøj k
$str
øøk t
)
øøt u
;
øøu v
col2
¿¿$ (
.
¿¿( )
Item
¿¿) -
(
¿¿- .
)
¿¿. /
.
¿¿/ 0

AlignRight
¿¿0 :
(
¿¿: ;
)
¿¿; <
.
¿¿< =
Text
¿¿= A
(
¿¿A B
date
¿¿B F
)
¿¿F G
.
¿¿G H
FontSize
¿¿H P
(
¿¿P Q
$num
¿¿Q S
)
¿¿S T
.
¿¿T U
	FontColor
¿¿U ^
(
¿¿^ _
$str
¿¿_ h
)
¿¿h i
;
¿¿i j
}
¡¡  !
)
¡¡! "
;
¡¡" #
}
¬¬ 
)
¬¬ 
;
¬¬ 
col1
ƒƒ  
.
ƒƒ  !
Spacing
ƒƒ! (
(
ƒƒ( )
$num
ƒƒ) +
)
ƒƒ+ ,
;
ƒƒ, -
}
≈≈ 
)
≈≈ 
;
≈≈ 
page
«« 
.
«« 
Footer
«« #
(
««# $
)
««$ %
.
»» 

AlignRight
»» '
(
»»' (
)
»»( )
.
…… 
Text
…… !
(
……! "
txt
……" %
=>
……& (
{
   
txt
ÀÀ  #
.
ÀÀ# $
Span
ÀÀ$ (
(
ÀÀ( )
$str
ÀÀ) 2
)
ÀÀ2 3
.
ÀÀ3 4
FontSize
ÀÀ4 <
(
ÀÀ< =
$num
ÀÀ= ?
)
ÀÀ? @
.
ÀÀ@ A
	FontColor
ÀÀA J
(
ÀÀJ K
$str
ÀÀK T
)
ÀÀT U
;
ÀÀU V
txt
ÃÃ  #
.
ÃÃ# $
CurrentPageNumber
ÃÃ$ 5
(
ÃÃ5 6
)
ÃÃ6 7
.
ÃÃ7 8
FontSize
ÃÃ8 @
(
ÃÃ@ A
$num
ÃÃA C
)
ÃÃC D
.
ÃÃD E
	FontColor
ÃÃE N
(
ÃÃN O
$str
ÃÃO X
)
ÃÃX Y
;
ÃÃY Z
txt
ÕÕ  #
.
ÕÕ# $
Span
ÕÕ$ (
(
ÕÕ( )
$str
ÕÕ) /
)
ÕÕ/ 0
.
ÕÕ0 1
FontSize
ÕÕ1 9
(
ÕÕ9 :
$num
ÕÕ: <
)
ÕÕ< =
.
ÕÕ= >
	FontColor
ÕÕ> G
(
ÕÕG H
$str
ÕÕH Q
)
ÕÕQ R
;
ÕÕR S
txt
ŒŒ  #
.
ŒŒ# $

TotalPages
ŒŒ$ .
(
ŒŒ. /
)
ŒŒ/ 0
.
ŒŒ0 1
FontSize
ŒŒ1 9
(
ŒŒ9 :
$num
ŒŒ: <
)
ŒŒ< =
.
ŒŒ= >
	FontColor
ŒŒ> G
(
ŒŒG H
$str
ŒŒH Q
)
ŒŒQ R
;
ŒŒR S
}
œœ 
)
œœ 
;
œœ 
}
–– 
)
–– 
;
–– 
}
—— 
)
—— 
;
—— 
byte
”” 
[
”” 
]
”” 
pdfBytes
”” 
=
”” 
document
”” &
.
””& '
GeneratePdf
””' 2
(
””2 3
)
””3 4
;
””4 5
using
‘‘ 
var
‘‘ 
memoryStream
‘‘ "
=
‘‘# $
new
‘‘% (
MemoryStream
‘‘) 5
(
‘‘5 6
pdfBytes
‘‘6 >
)
‘‘> ?
;
‘‘? @
return
’’ 
memoryStream
’’ 
.
’’  
ToArray
’’  '
(
’’' (
)
’’( )
;
’’) *
}
÷÷ 	
)
÷÷	 

;
÷÷
 
}
◊◊ 
public
ŸŸ 

async
ŸŸ 
Task
ŸŸ 
<
ŸŸ 
byte
ŸŸ 
[
ŸŸ 
]
ŸŸ 
>
ŸŸ 
RegenerateInvoice
ŸŸ /
(
ŸŸ/ 0
UserInfoResponse
ŸŸ0 @
userInfo
ŸŸA I
,
ŸŸI J
Invoice
ŸŸK R
invoice
ŸŸS Z
)
ŸŸZ [
{
⁄⁄ 
var
€€ 
date
€€ 
=
€€ 
DateTime
€€ 
.
€€ 
Now
€€ 
.
€€  
ToString
€€  (
(
€€( )
$str
€€) 5
)
€€5 6
;
€€6 7
var
‹‹ 
totalTax
‹‹ 
=
‹‹ 
$num
‹‹ 
;
‹‹ 
var
›› 
subTotal
›› 
=
›› 
$num
›› 
;
›› 
decimal
ﬁﬁ 
?
ﬁﬁ 
totalDiscount
ﬁﬁ 
=
ﬁﬁ  
$num
ﬁﬁ! #
;
ﬁﬁ# $
var
ﬂﬂ 
workingDirectory
ﬂﬂ 
=
ﬂﬂ 
Path
ﬂﬂ #
.
ﬂﬂ# $
GetDirectoryName
ﬂﬂ$ 4
(
ﬂﬂ4 5
Assembly
ﬂﬂ5 =
.
ﬂﬂ= >"
GetExecutingAssembly
ﬂﬂ> R
(
ﬂﬂR S
)
ﬂﬂS T
.
ﬂﬂT U
Location
ﬂﬂU ]
)
ﬂﬂ] ^
;
ﬂﬂ^ _
var
‡‡ 
	separator
‡‡ 
=
‡‡ 
Path
‡‡ 
.
‡‡ $
DirectorySeparatorChar
‡‡ 3
;
‡‡3 4
var
·· 
pathFile
·· 
=
·· 
$"
·· 
{
·· 
workingDirectory
·· *
}
··* +
{
··+ ,
	separator
··, 5
}
··5 6
$str
··6 <
{
··< =
	separator
··= F
}
··F G
$str
··G Z
"
··Z [
;
··[ \
return
„„ 
await
„„ 
Task
„„ 
.
„„ 
Run
„„ 
(
„„ 
(
„„ 
)
„„  
=>
„„! #
{
‰‰ 	
var
ÂÂ 
document
ÂÂ 
=
ÂÂ 
Document
ÂÂ #
.
ÊÊ 
Create
ÊÊ 
(
ÊÊ 
doc
ÊÊ 
=>
ÊÊ 
{
ÁÁ 
doc
ËË 
.
ËË 
Page
ËË 
(
ËË 
page
ËË !
=>
ËË" $
{
ÈÈ 
page
ÍÍ 
.
ÍÍ 
Margin
ÍÍ #
(
ÍÍ# $
$num
ÍÍ$ &
)
ÍÍ& '
;
ÍÍ' (
page
ÎÎ 
.
ÎÎ 
	PageColor
ÎÎ &
(
ÎÎ& '
$str
ÎÎ' 0
)
ÎÎ0 1
;
ÎÎ1 2
page
ÌÌ 
.
ÌÌ 
Header
ÌÌ #
(
ÌÌ# $
)
ÌÌ$ %
.
ÌÌ% &
ShowOnce
ÌÌ& .
(
ÌÌ. /
)
ÌÌ/ 0
.
ÌÌ0 1
Row
ÌÌ1 4
(
ÌÌ4 5
row
ÌÌ5 8
=>
ÌÌ9 ;
{
ÓÓ 
var
ÔÔ 
image
ÔÔ  %
=
ÔÔ& '
Image
ÔÔ( -
.
ÔÔ- .
FromFile
ÔÔ. 6
(
ÔÔ6 7
pathFile
ÔÔ7 ?
)
ÔÔ? @
;
ÔÔ@ A
row
 
.
  
ConstantItem
  ,
(
, -
$num
- 0
)
0 1
.
1 2
	Container
2 ;
(
; <
)
< =
.
= >
Image
> C
(
C D
image
D I
)
I J
;
J K
row
ÚÚ !
.
ÚÚ! "
RelativeItem
ÚÚ" .
(
ÚÚ. /
)
ÚÚ/ 0
.
ÚÚ0 1
Column
ÚÚ1 7
(
ÚÚ7 8
col
ÚÚ8 ;
=>
ÚÚ< >
{
ÛÛ 
col
ÙÙ  #
.
ÙÙ# $
Item
ÙÙ$ (
(
ÙÙ( )
)
ÙÙ) *
.
ÙÙ* +

AlignRight
ÙÙ+ 5
(
ÙÙ5 6
)
ÙÙ6 7
.
ıı$ %

Background
ıı% /
(
ıı/ 0
$str
ıı0 9
)
ıı9 :
.
ˆˆ$ %
Padding
ˆˆ% ,
(
ˆˆ, -
$num
ˆˆ- /
)
ˆˆ/ 0
.
ˆˆ0 1
Border
ˆˆ1 7
(
ˆˆ7 8
$num
ˆˆ8 9
)
ˆˆ9 :
.
ˆˆ: ;
BorderColor
ˆˆ; F
(
ˆˆF G
$str
ˆˆG P
)
ˆˆP Q
.
˜˜$ %
AlignCenter
˜˜% 0
(
˜˜0 1
)
˜˜1 2
.
¯¯$ %
Text
¯¯% )
(
¯¯) *
$"
¯¯* ,
$str
¯¯, 4
{
¯¯4 5
invoice
¯¯5 <
.
¯¯< =
Id
¯¯= ?
}
¯¯? @
"
¯¯@ A
)
¯¯A B
.
˘˘$ %
	FontColor
˘˘% .
(
˘˘. /
$str
˘˘/ 8
)
˘˘8 9
;
˘˘9 :
col
˚˚  #
.
˚˚# $
Item
˚˚$ (
(
˚˚( )
)
˚˚) *
.
˚˚* +

AlignRight
˚˚+ 5
(
˚˚5 6
)
˚˚6 7
.
˚˚7 8
Text
˚˚8 <
(
˚˚< =
$str
˚˚= b
)
˚˚b c
.
¸¸$ %
	FontColor
¸¸% .
(
¸¸. /
$str
¸¸/ 8
)
¸¸8 9
.
¸¸9 :
FontSize
¸¸: B
(
¸¸B C
$num
¸¸C E
)
¸¸E F
;
¸¸F G
col
˝˝  #
.
˝˝# $
Item
˝˝$ (
(
˝˝( )
)
˝˝) *
.
˝˝* +

AlignRight
˝˝+ 5
(
˝˝5 6
)
˝˝6 7
.
˝˝7 8
Text
˝˝8 <
(
˝˝< =
$str
˝˝= K
)
˝˝K L
.
˝˝L M
	FontColor
˝˝M V
(
˝˝V W
$str
˝˝W `
)
˝˝` a
.
˝˝a b
FontSize
˝˝b j
(
˝˝j k
$num
˝˝k m
)
˝˝m n
;
˝˝n o
col
˛˛  #
.
˛˛# $
Item
˛˛$ (
(
˛˛( )
)
˛˛) *
.
˛˛* +

AlignRight
˛˛+ 5
(
˛˛5 6
)
˛˛6 7
.
ˇˇ$ %
Text
ˇˇ% )
(
ˇˇ) *
$str
ˇˇ* =
)
ˇˇ= >
.
ÄÄ$ %
	FontColor
ÄÄ% .
(
ÄÄ. /
$str
ÄÄ/ 8
)
ÄÄ8 9
.
ÄÄ9 :
FontSize
ÄÄ: B
(
ÄÄB C
$num
ÄÄC E
)
ÄÄE F
;
ÄÄF G
col
ÅÅ  #
.
ÅÅ# $
Item
ÅÅ$ (
(
ÅÅ( )
)
ÅÅ) *
.
ÅÅ* +

AlignRight
ÅÅ+ 5
(
ÅÅ5 6
)
ÅÅ6 7
.
ÅÅ7 8
Text
ÅÅ8 <
(
ÅÅ< =
$str
ÅÅ= V
)
ÅÅV W
.
ÅÅW X
	FontColor
ÅÅX a
(
ÅÅa b
$str
ÅÅb k
)
ÅÅk l
.
ÇÇ$ %
FontSize
ÇÇ% -
(
ÇÇ- .
$num
ÇÇ. 0
)
ÇÇ0 1
;
ÇÇ1 2
col
ÉÉ  #
.
ÉÉ# $
Item
ÉÉ$ (
(
ÉÉ( )
)
ÉÉ) *
.
ÉÉ* +

AlignRight
ÉÉ+ 5
(
ÉÉ5 6
)
ÉÉ6 7
.
ÉÉ7 8
Text
ÉÉ8 <
(
ÉÉ< =
$str
ÉÉ= _
)
ÉÉ_ `
.
ÉÉ` a
	FontColor
ÉÉa j
(
ÉÉj k
$str
ÉÉk t
)
ÉÉt u
.
ÑÑ$ %
FontSize
ÑÑ% -
(
ÑÑ- .
$num
ÑÑ. 0
)
ÑÑ0 1
;
ÑÑ1 2
col
ÖÖ  #
.
ÖÖ# $
Item
ÖÖ$ (
(
ÖÖ( )
)
ÖÖ) *
.
ÖÖ* +

AlignRight
ÖÖ+ 5
(
ÖÖ5 6
)
ÖÖ6 7
.
ÖÖ7 8
Text
ÖÖ8 <
(
ÖÖ< =
date
ÖÖ= A
)
ÖÖA B
.
ÖÖB C
	FontColor
ÖÖC L
(
ÖÖL M
$str
ÖÖM V
)
ÖÖV W
.
ÖÖW X
FontSize
ÖÖX `
(
ÖÖ` a
$num
ÖÖa c
)
ÖÖc d
;
ÖÖd e
}
ÜÜ 
)
ÜÜ 
;
ÜÜ 
}
áá 
)
áá 
;
áá 
page
ââ 
.
ââ 
Content
ââ $
(
ââ$ %
)
ââ% &
.
ââ& '
PaddingVertical
ââ' 6
(
ââ6 7
$num
ââ7 9
)
ââ9 :
.
ââ: ;
Column
ââ; A
(
ââA B
col1
ââB F
=>
ââG I
{
ää 
col1
ãã  
.
ãã  !
Item
ãã! %
(
ãã% &
)
ãã& '
.
ãã' (

PaddingTop
ãã( 2
(
ãã2 3
$num
ãã3 5
)
ãã5 6
.
ãã6 7
Row
ãã7 :
(
ãã: ;
row
ãã; >
=>
ãã? A
{
åå 
row
çç  #
.
çç# $
RelativeItem
çç$ 0
(
çç0 1
)
çç1 2
.
çç2 3
Column
çç3 9
(
çç9 :
col2
çç: >
=>
çç? A
{
éé  !
col2
èè$ (
.
èè( )
Item
èè) -
(
èè- .
)
èè. /
.
èè/ 0
	AlignLeft
èè0 9
(
èè9 :
)
èè: ;
.
èè; <
Text
èè< @
(
èè@ A
$str
èèA T
)
èèT U
.
èèU V
	Underline
èèV _
(
èè_ `
)
èè` a
.
èèa b
Bold
èèb f
(
èèf g
)
èèg h
.
êê( )
	FontColor
êê) 2
(
êê2 3
$str
êê3 <
)
êê< =
;
êê= >
col2
íí$ (
.
íí( )
Item
íí) -
(
íí- .
)
íí. /
.
íí/ 0
Text
íí0 4
(
íí4 5
txt
íí5 8
=>
íí9 ;
{
ìì$ %
txt
îî( +
.
îî+ ,
Span
îî, 0
(
îî0 1
$str
îî1 ;
)
îî; <
.
îî< =
SemiBold
îî= E
(
îîE F
)
îîF G
.
îîG H
FontSize
îîH P
(
îîP Q
$num
îîQ S
)
îîS T
.
îîT U
	FontColor
îîU ^
(
îî^ _
$str
îî_ h
)
îîh i
;
îîi j
txt
ïï( +
.
ïï+ ,
Span
ïï, 0
(
ïï0 1
$"
ïï1 3
{
ïï3 4
userInfo
ïï4 <
.
ïï< =
Name
ïï= A
}
ïïA B
$str
ïïB C
{
ïïC D
userInfo
ïïD L
.
ïïL M
LastName
ïïM U
}
ïïU V
"
ïïV W
)
ïïW X
.
ïïX Y
	FontColor
ïïY b
(
ïïb c
$str
ïïc l
)
ïïl m
.
ññ, -
FontSize
ññ- 5
(
ññ5 6
$num
ññ6 8
)
ññ8 9
;
ññ9 :
}
óó$ %
)
óó% &
;
óó& '
col2
ôô$ (
.
ôô( )
Item
ôô) -
(
ôô- .
)
ôô. /
.
ôô/ 0
Text
ôô0 4
(
ôô4 5
txt
ôô5 8
=>
ôô9 ;
{
öö$ %
txt
õõ( +
.
õõ+ ,
Span
õõ, 0
(
õõ0 1
$str
õõ1 9
)
õõ9 :
.
õõ: ;
SemiBold
õõ; C
(
õõC D
)
õõD E
.
õõE F
FontSize
õõF N
(
õõN O
$num
õõO Q
)
õõQ R
.
õõR S
	FontColor
õõS \
(
õõ\ ]
$str
õõ] f
)
õõf g
;
õõg h
txt
úú( +
.
úú+ ,
Span
úú, 0
(
úú0 1
userInfo
úú1 9
.
úú9 :
Country
úú: A
!
úúA B
.
úúB C
Name
úúC G
)
úúG H
.
úúH I
	FontColor
úúI R
(
úúR S
$str
úúS \
)
úú\ ]
.
úú] ^
FontSize
úú^ f
(
úúf g
$num
úúg i
)
úúi j
;
úúj k
}
ùù$ %
)
ùù% &
;
ùù& '
col2
üü$ (
.
üü( )
Item
üü) -
(
üü- .
)
üü. /
.
üü/ 0
Text
üü0 4
(
üü4 5
txt
üü5 8
=>
üü9 ;
{
††$ %
txt
°°( +
.
°°+ ,
Span
°°, 0
(
°°0 1
$str
°°1 ;
)
°°; <
.
°°< =
SemiBold
°°= E
(
°°E F
)
°°F G
.
°°G H
FontSize
°°H P
(
°°P Q
$num
°°Q S
)
°°S T
.
°°T U
	FontColor
°°U ^
(
°°^ _
$str
°°_ h
)
°°h i
;
°°i j
txt
¢¢( +
.
¢¢+ ,
Span
¢¢, 0
(
¢¢0 1
userInfo
¢¢1 9
.
¢¢9 :
City
¢¢: >
)
¢¢> ?
.
¢¢? @
	FontColor
¢¢@ I
(
¢¢I J
$str
¢¢J S
)
¢¢S T
.
¢¢T U
FontSize
¢¢U ]
(
¢¢] ^
$num
¢¢^ `
)
¢¢` a
;
¢¢a b
}
££$ %
)
££% &
;
££& '
}
§§  !
)
§§! "
;
§§" #
row
¶¶  #
.
¶¶# $
RelativeItem
¶¶$ 0
(
¶¶0 1
)
¶¶1 2
.
¶¶2 3
Column
¶¶3 9
(
¶¶9 :
col2
¶¶: >
=>
¶¶? A
{
ßß  !
col2
®®$ (
.
®®( )
Item
®®) -
(
®®- .
)
®®. /
.
®®/ 0

AlignRight
®®0 :
(
®®: ;
)
®®; <
.
®®< =
Text
®®= A
(
®®A B
txt
®®B E
=>
®®F H
{
©©$ %
txt
™™( +
.
™™+ ,
Span
™™, 0
(
™™0 1
$str
™™1 =
)
™™= >
.
™™> ?
SemiBold
™™? G
(
™™G H
)
™™H I
.
™™I J
FontSize
™™J R
(
™™R S
$num
™™S U
)
™™U V
.
™™V W
	FontColor
™™W `
(
™™` a
$str
™™a j
)
™™j k
;
™™k l
txt
´´( +
.
´´+ ,
Span
´´, 0
(
´´0 1
userInfo
´´1 9
.
´´9 :
Phone
´´: ?
)
´´? @
.
´´@ A
	FontColor
´´A J
(
´´J K
$str
´´K T
)
´´T U
.
´´U V
FontSize
´´V ^
(
´´^ _
$num
´´_ a
)
´´a b
;
´´b c
}
¨¨$ %
)
¨¨% &
;
¨¨& '
col2
ÆÆ$ (
.
ÆÆ( )
Item
ÆÆ) -
(
ÆÆ- .
)
ÆÆ. /
.
ÆÆ/ 0

AlignRight
ÆÆ0 :
(
ÆÆ: ;
)
ÆÆ; <
.
ÆÆ< =
Text
ÆÆ= A
(
ÆÆA B
txt
ÆÆB E
=>
ÆÆF H
{
ØØ$ %
txt
∞∞( +
.
∞∞+ ,
Span
∞∞, 0
(
∞∞0 1
$str
∞∞1 P
)
∞∞P Q
.
∞∞Q R
SemiBold
∞∞R Z
(
∞∞Z [
)
∞∞[ \
.
∞∞\ ]
FontSize
∞∞] e
(
∞∞e f
$num
∞∞f h
)
∞∞h i
.
±±, -
	FontColor
±±- 6
(
±±6 7
$str
±±7 @
)
±±@ A
;
±±A B
txt
≤≤( +
.
≤≤+ ,
Span
≤≤, 0
(
≤≤0 1
userInfo
≤≤1 9
.
≤≤9 :
UserName
≤≤: B
)
≤≤B C
.
≤≤C D
	FontColor
≤≤D M
(
≤≤M N
$str
≤≤N W
)
≤≤W X
.
≤≤X Y
FontSize
≤≤Y a
(
≤≤a b
$num
≤≤b d
)
≤≤d e
;
≤≤e f
}
≥≥$ %
)
≥≥% &
;
≥≥& '
col2
µµ$ (
.
µµ( )
Item
µµ) -
(
µµ- .
)
µµ. /
.
µµ/ 0

AlignRight
µµ0 :
(
µµ: ;
)
µµ; <
.
µµ< =
Text
µµ= A
(
µµA B
txt
µµB E
=>
µµF H
{
∂∂$ %
txt
∑∑( +
.
∑∑+ ,
Span
∑∑, 0
(
∑∑0 1
$str
∑∑1 ;
)
∑∑; <
.
∑∑< =
SemiBold
∑∑= E
(
∑∑E F
)
∑∑F G
.
∑∑G H
FontSize
∑∑H P
(
∑∑P Q
$num
∑∑Q S
)
∑∑S T
.
∑∑T U
	FontColor
∑∑U ^
(
∑∑^ _
$str
∑∑_ h
)
∑∑h i
;
∑∑i j
txt
∏∏( +
.
∏∏+ ,
Span
∏∏, 0
(
∏∏0 1
userInfo
∏∏1 9
.
∏∏9 :
Email
∏∏: ?
)
∏∏? @
.
∏∏@ A
	FontColor
∏∏A J
(
∏∏J K
$str
∏∏K T
)
∏∏T U
.
∏∏U V
FontSize
∏∏V ^
(
∏∏^ _
$num
∏∏_ a
)
∏∏a b
;
∏∏b c
}
ππ$ %
)
ππ% &
;
ππ& '
col2
ªª$ (
.
ªª( )
Item
ªª) -
(
ªª- .
)
ªª. /
.
ªª/ 0

AlignRight
ªª0 :
(
ªª: ;
)
ªª; <
.
ªª< =
Text
ªª= A
(
ªªA B
txt
ªªB E
=>
ªªF H
{
ºº$ %
txt
ΩΩ( +
.
ΩΩ+ ,
Span
ΩΩ, 0
(
ΩΩ0 1
$str
ΩΩ1 >
)
ΩΩ> ?
.
ΩΩ? @
SemiBold
ΩΩ@ H
(
ΩΩH I
)
ΩΩI J
.
ΩΩJ K
FontSize
ΩΩK S
(
ΩΩS T
$num
ΩΩT V
)
ΩΩV W
.
ΩΩW X
	FontColor
ΩΩX a
(
ΩΩa b
$str
ΩΩb k
)
ΩΩk l
;
ΩΩl m
txt
ææ( +
.
ææ+ ,
Span
ææ, 0
(
ææ0 1
userInfo
ææ1 9
.
ææ9 :
Address
ææ: A
)
ææA B
.
ææB C
	FontColor
ææC L
(
ææL M
$str
ææM V
)
ææV W
.
ææW X
FontSize
ææX `
(
ææ` a
$num
ææa c
)
ææc d
;
ææd e
}
øø$ %
)
øø% &
;
øø& '
col2
¡¡$ (
.
¡¡( )
Item
¡¡) -
(
¡¡- .
)
¡¡. /
.
¡¡/ 0

AlignRight
¡¡0 :
(
¡¡: ;
)
¡¡; <
.
¡¡< =
Text
¡¡= A
(
¡¡A B
txt
¡¡B E
=>
¡¡F H
{
¬¬$ %
if
√√( *
(
√√+ ,
!
√√, -
string
√√- 3
.
√√3 4
IsNullOrEmpty
√√4 A
(
√√A B
invoice
√√B I
.
√√I J
Reason
√√J P
)
√√P Q
)
√√Q R
{
ƒƒ( )
txt
≈≈, /
.
≈≈/ 0
Span
≈≈0 4
(
≈≈4 5
$str
≈≈5 C
)
≈≈C D
.
≈≈D E
SemiBold
≈≈E M
(
≈≈M N
)
≈≈N O
.
≈≈O P
FontSize
≈≈P X
(
≈≈X Y
$num
≈≈Y [
)
≈≈[ \
.
≈≈\ ]
	FontColor
≈≈] f
(
≈≈f g
$str
≈≈g p
)
≈≈p q
;
≈≈q r
txt
∆∆, /
.
∆∆/ 0
Span
∆∆0 4
(
∆∆4 5
invoice
∆∆5 <
.
∆∆< =
Reason
∆∆= C
)
∆∆C D
.
∆∆D E
	FontColor
∆∆E N
(
∆∆N O
$str
∆∆O X
)
∆∆X Y
.
∆∆Y Z
FontSize
∆∆Z b
(
∆∆b c
$num
∆∆c e
)
∆∆e f
;
∆∆f g
}
««( )
}
»»$ %
)
»»% &
;
»»& '
}
……  !
)
……! "
;
……" #
}
   
)
   
;
   
col1
ÃÃ  
.
ÃÃ  !
Item
ÃÃ! %
(
ÃÃ% &
)
ÃÃ& '
.
ÃÃ' (
LineHorizontal
ÃÃ( 6
(
ÃÃ6 7
$num
ÃÃ7 ;
)
ÃÃ; <
.
ÃÃ< =
	LineColor
ÃÃ= F
(
ÃÃF G
$str
ÃÃG P
)
ÃÃP Q
;
ÃÃQ R
col1
ŒŒ  
.
ŒŒ  !
Item
ŒŒ! %
(
ŒŒ% &
)
ŒŒ& '
.
ŒŒ' (
Table
ŒŒ( -
(
ŒŒ- .
tabla
ŒŒ. 3
=>
ŒŒ4 6
{
œœ 
tabla
––  %
.
––% &
ColumnsDefinition
––& 7
(
––7 8
columns
––8 ?
=>
––@ B
{
——  !
columns
““$ +
.
““+ ,
RelativeColumn
““, :
(
““: ;
$num
““; <
)
““< =
;
““= >
columns
””$ +
.
””+ ,
RelativeColumn
””, :
(
””: ;
)
””; <
;
””< =
columns
‘‘$ +
.
‘‘+ ,
RelativeColumn
‘‘, :
(
‘‘: ;
)
‘‘; <
;
‘‘< =
columns
’’$ +
.
’’+ ,
RelativeColumn
’’, :
(
’’: ;
)
’’; <
;
’’< =
columns
÷÷$ +
.
÷÷+ ,
RelativeColumn
÷÷, :
(
÷÷: ;
)
÷÷; <
;
÷÷< =
}
◊◊  !
)
◊◊! "
;
◊◊" #
tabla
ŸŸ  %
.
ŸŸ% &
Header
ŸŸ& ,
(
ŸŸ, -
header
ŸŸ- 3
=>
ŸŸ4 6
{
⁄⁄  !
header
€€$ *
.
€€* +
Cell
€€+ /
(
€€/ 0
)
€€0 1
.
€€1 2

Background
€€2 <
(
€€< =
$str
€€= F
)
€€F G
.
€€G H
Padding
€€H O
(
€€O P
$num
€€P Q
)
€€Q R
.
€€R S
Text
€€S W
(
€€W X
$str
€€X b
)
€€b c
.
‹‹( )
	FontColor
‹‹) 2
(
‹‹2 3
$str
‹‹3 <
)
‹‹< =
;
‹‹= >
header
››$ *
.
››* +
Cell
››+ /
(
››/ 0
)
››0 1
.
››1 2

Background
››2 <
(
››< =
$str
››= F
)
››F G
.
››G H
Padding
››H O
(
››O P
$num
››P Q
)
››Q R
.
››R S
Text
››S W
(
››W X
$str
››X b
)
››b c
.
ﬁﬁ( )
	FontColor
ﬁﬁ) 2
(
ﬁﬁ2 3
$str
ﬁﬁ3 <
)
ﬁﬁ< =
;
ﬁﬁ= >
header
ﬂﬂ$ *
.
ﬂﬂ* +
Cell
ﬂﬂ+ /
(
ﬂﬂ/ 0
)
ﬂﬂ0 1
.
ﬂﬂ1 2

Background
ﬂﬂ2 <
(
ﬂﬂ< =
$str
ﬂﬂ= F
)
ﬂﬂF G
.
ﬂﬂG H
Padding
ﬂﬂH O
(
ﬂﬂO P
$num
ﬂﬂP Q
)
ﬂﬂQ R
.
ﬂﬂR S
Text
ﬂﬂS W
(
ﬂﬂW X
$str
ﬂﬂX `
)
ﬂﬂ` a
.
‡‡( )
	FontColor
‡‡) 2
(
‡‡2 3
$str
‡‡3 <
)
‡‡< =
;
‡‡= >
header
··$ *
.
··* +
Cell
··+ /
(
··/ 0
)
··0 1
.
··1 2

Background
··2 <
(
··< =
$str
··= F
)
··F G
.
··G H
Padding
··H O
(
··O P
$num
··P Q
)
··Q R
.
··R S
Text
··S W
(
··W X
$str
··X c
)
··c d
.
‚‚( )
	FontColor
‚‚) 2
(
‚‚2 3
$str
‚‚3 <
)
‚‚< =
;
‚‚= >
header
„„$ *
.
„„* +
Cell
„„+ /
(
„„/ 0
)
„„0 1
.
„„1 2

Background
„„2 <
(
„„< =
$str
„„= F
)
„„F G
.
„„G H
Padding
„„H O
(
„„O P
$num
„„P Q
)
„„Q R
.
„„R S
Text
„„S W
(
„„W X
$str
„„X _
)
„„_ `
.
‰‰( )
	FontColor
‰‰) 2
(
‰‰2 3
$str
‰‰3 <
)
‰‰< =
;
‰‰= >
}
ÂÂ  !
)
ÂÂ! "
;
ÂÂ" #
foreach
ÁÁ  '
(
ÁÁ( )
var
ÁÁ) ,
item
ÁÁ- 1
in
ÁÁ2 4
invoice
ÁÁ5 <
.
ÁÁ< =
InvoicesDetails
ÁÁ= L
)
ÁÁL M
{
ËË  !
var
ÈÈ$ '
conceptName
ÈÈ( 3
=
ÈÈ4 5
item
ÈÈ6 :
.
ÈÈ: ;
ProductName
ÈÈ; F
;
ÈÈF G
var
ÍÍ$ '
quantity
ÍÍ( 0
=
ÍÍ1 2
item
ÍÍ3 7
.
ÍÍ7 8
ProductQuantity
ÍÍ8 G
;
ÍÍG H
var
ÎÎ$ '
price
ÎÎ( -
=
ÎÎ. /
item
ÎÎ0 4
.
ÎÎ4 5
ProductPrice
ÎÎ5 A
;
ÎÎA B
var
ÏÏ$ '
tax
ÏÏ( +
=
ÏÏ, -
item
ÏÏ. 2
.
ÏÏ2 3

ProductIva
ÏÏ3 =
;
ÏÏ= >
var
ÌÌ$ '
discount
ÌÌ( 0
=
ÌÌ1 2
item
ÌÌ3 7
.
ÌÌ7 8
ProductDiscount
ÌÌ8 G
*
ÌÌH I
quantity
ÌÌJ R
;
ÌÌR S
var
ÓÓ$ '
total
ÓÓ( -
=
ÓÓ. /
quantity
ÓÓ0 8
*
ÓÓ9 :
price
ÓÓ; @
;
ÓÓ@ A
tabla
$ )
.
) *
Cell
* .
(
. /
)
/ 0
.
0 1
BorderBottom
1 =
(
= >
$num
> B
)
B C
.
C D
BorderColor
D O
(
O P
$str
P Y
)
Y Z
.
Z [
Padding
[ b
(
b c
$num
c d
)
d e
.
ÒÒ( )
Text
ÒÒ) -
(
ÒÒ- .
conceptName
ÒÒ. 9
)
ÒÒ9 :
.
ÒÒ: ;
	FontColor
ÒÒ; D
(
ÒÒD E
$str
ÒÒE N
)
ÒÒN O
.
ÒÒO P
FontSize
ÒÒP X
(
ÒÒX Y
$num
ÒÒY [
)
ÒÒ[ \
;
ÒÒ\ ]
tabla
ÚÚ$ )
.
ÚÚ) *
Cell
ÚÚ* .
(
ÚÚ. /
)
ÚÚ/ 0
.
ÚÚ0 1
BorderBottom
ÚÚ1 =
(
ÚÚ= >
$num
ÚÚ> B
)
ÚÚB C
.
ÚÚC D
BorderColor
ÚÚD O
(
ÚÚO P
$str
ÚÚP Y
)
ÚÚY Z
.
ÚÚZ [
Padding
ÚÚ[ b
(
ÚÚb c
$num
ÚÚc d
)
ÚÚd e
.
ÛÛ( )
Text
ÛÛ) -
(
ÛÛ- .
quantity
ÛÛ. 6
.
ÛÛ6 7
ToString
ÛÛ7 ?
(
ÛÛ? @
)
ÛÛ@ A
)
ÛÛA B
.
ÛÛB C
	FontColor
ÛÛC L
(
ÛÛL M
$str
ÛÛM V
)
ÛÛV W
.
ÛÛW X
FontSize
ÛÛX `
(
ÛÛ` a
$num
ÛÛa c
)
ÛÛc d
;
ÛÛd e
tabla
ÙÙ$ )
.
ÙÙ) *
Cell
ÙÙ* .
(
ÙÙ. /
)
ÙÙ/ 0
.
ÙÙ0 1
BorderBottom
ÙÙ1 =
(
ÙÙ= >
$num
ÙÙ> B
)
ÙÙB C
.
ÙÙC D
BorderColor
ÙÙD O
(
ÙÙO P
$str
ÙÙP Y
)
ÙÙY Z
.
ÙÙZ [
Padding
ÙÙ[ b
(
ÙÙb c
$num
ÙÙc d
)
ÙÙd e
.
ıı( )
Text
ıı) -
(
ıı- .
$"
ıı. 0
$str
ıı0 2
{
ıı2 3
price
ıı3 8
:
ıı8 9
$str
ıı9 =
}
ıı= >
"
ıı> ?
)
ıı? @
.
ıı@ A
	FontColor
ııA J
(
ııJ K
$str
ııK T
)
ııT U
.
ııU V
FontSize
ııV ^
(
ıı^ _
$num
ıı_ a
)
ııa b
;
ııb c
tabla
ˆˆ$ )
.
ˆˆ) *
Cell
ˆˆ* .
(
ˆˆ. /
)
ˆˆ/ 0
.
ˆˆ0 1
BorderBottom
ˆˆ1 =
(
ˆˆ= >
$num
ˆˆ> B
)
ˆˆB C
.
ˆˆC D
BorderColor
ˆˆD O
(
ˆˆO P
$str
ˆˆP Y
)
ˆˆY Z
.
ˆˆZ [
Padding
ˆˆ[ b
(
ˆˆb c
$num
ˆˆc d
)
ˆˆd e
.
˜˜( )
Text
˜˜) -
(
˜˜- .
$"
˜˜. 0
$str
˜˜0 2
{
˜˜2 3
discount
˜˜3 ;
:
˜˜; <
$str
˜˜< @
}
˜˜@ A
"
˜˜A B
)
˜˜B C
.
˜˜C D
	FontColor
˜˜D M
(
˜˜M N
$str
˜˜N W
)
˜˜W X
.
˜˜X Y
FontSize
˜˜Y a
(
˜˜a b
$num
˜˜b d
)
˜˜d e
;
˜˜e f
tabla
¯¯$ )
.
¯¯) *
Cell
¯¯* .
(
¯¯. /
)
¯¯/ 0
.
¯¯0 1
BorderBottom
¯¯1 =
(
¯¯= >
$num
¯¯> B
)
¯¯B C
.
¯¯C D
BorderColor
¯¯D O
(
¯¯O P
$str
¯¯P Y
)
¯¯Y Z
.
¯¯Z [
Padding
¯¯[ b
(
¯¯b c
$num
¯¯c d
)
¯¯d e
.
˘˘( )
Text
˘˘) -
(
˘˘- .
$"
˘˘. 0
$str
˘˘0 2
{
˘˘2 3
total
˘˘3 8
:
˘˘8 9
$str
˘˘9 =
}
˘˘= >
"
˘˘> ?
)
˘˘? @
.
˘˘@ A
	FontColor
˘˘A J
(
˘˘J K
$str
˘˘K T
)
˘˘T U
.
˘˘U V
FontSize
˘˘V ^
(
˘˘^ _
$num
˘˘_ a
)
˘˘a b
;
˘˘b c
subTotal
˚˚$ ,
+=
˚˚- /
total
˚˚0 5
;
˚˚5 6
totalDiscount
¸¸$ 1
+=
¸¸2 4
discount
¸¸5 =
;
¸¸= >
totalTax
˝˝$ ,
=
˝˝- .
(
˝˝/ 0
decimal
˝˝0 7
)
˝˝7 8
tax
˝˝8 ;
!
˝˝; <
;
˝˝< =
}
˛˛  !
}
ˇˇ 
)
ˇˇ 
;
ˇˇ 
col1
ÅÅ  
.
ÅÅ  !
Item
ÅÅ! %
(
ÅÅ% &
)
ÅÅ& '
.
ÅÅ' (

PaddingTop
ÅÅ( 2
(
ÅÅ2 3
$num
ÅÅ3 5
)
ÅÅ5 6
.
ÅÅ6 7
Row
ÅÅ7 :
(
ÅÅ: ;
row
ÅÅ; >
=>
ÅÅ? A
{
ÇÇ 
row
ÉÉ  #
.
ÉÉ# $
RelativeItem
ÉÉ$ 0
(
ÉÉ0 1
)
ÉÉ1 2
.
ÉÉ2 3
Column
ÉÉ3 9
(
ÉÉ9 :
col2
ÉÉ: >
=>
ÉÉ? A
{
ÑÑ  !
col2
ÖÖ$ (
.
ÖÖ( )
Item
ÖÖ) -
(
ÖÖ- .
)
ÖÖ. /
.
ÖÖ/ 0

AlignRight
ÖÖ0 :
(
ÖÖ: ;
)
ÖÖ; <
.
ÖÖ< =
Text
ÖÖ= A
(
ÖÖA B
$str
ÖÖB P
)
ÖÖP Q
.
ÖÖQ R
Bold
ÖÖR V
(
ÖÖV W
)
ÖÖW X
.
ÖÖX Y
FontSize
ÖÖY a
(
ÖÖa b
$num
ÖÖb d
)
ÖÖd e
.
ÜÜ( )
	FontColor
ÜÜ) 2
(
ÜÜ2 3
$str
ÜÜ3 <
)
ÜÜ< =
;
ÜÜ= >
col2
áá$ (
.
áá( )
Item
áá) -
(
áá- .
)
áá. /
.
áá/ 0

AlignRight
áá0 :
(
áá: ;
)
áá; <
.
áá< =
Text
áá= A
(
ááA B
$"
ááB D
$str
ááD L
{
ááL M
invoice
ááM T
.
ááT U
TotalInvoice
ááU a
}
ááa b
"
ááb c
)
áác d
.
àà( )
FontSize
àà) 1
(
àà1 2
$num
àà2 4
)
àà4 5
.
àà5 6
	FontColor
àà6 ?
(
àà? @
$str
àà@ I
)
ààI J
;
ààJ K
col2
ââ$ (
.
ââ( )
Item
ââ) -
(
ââ- .
)
ââ. /
.
ââ/ 0

AlignRight
ââ0 :
(
ââ: ;
)
ââ; <
.
ââ< =
Text
ââ= A
(
ââA B
$str
ââB R
)
ââR S
.
ââS T
FontSize
ââT \
(
ââ\ ]
$num
ââ] _
)
ââ_ `
.
ââ` a
	FontColor
ââa j
(
ââj k
$str
ââk t
)
âât u
;
ââu v
col2
ää$ (
.
ää( )
Item
ää) -
(
ää- .
)
ää. /
.
ää/ 0

AlignRight
ää0 :
(
ää: ;
)
ää; <
.
ää< =
Text
ää= A
(
ääA B
date
ääB F
)
ääF G
.
ääG H
FontSize
ääH P
(
ääP Q
$num
ääQ S
)
ääS T
.
ääT U
	FontColor
ääU ^
(
ää^ _
$str
ää_ h
)
ääh i
;
ääi j
}
ãã  !
)
ãã! "
;
ãã" #
}
åå 
)
åå 
;
åå 
col1
éé  
.
éé  !
Spacing
éé! (
(
éé( )
$num
éé) +
)
éé+ ,
;
éé, -
}
èè 
)
èè 
;
èè 
page
ëë 
.
ëë 
Footer
ëë #
(
ëë# $
)
ëë$ %
.
íí 

AlignRight
íí '
(
íí' (
)
íí( )
.
ìì 
Text
ìì !
(
ìì! "
txt
ìì" %
=>
ìì& (
{
îî 
txt
ïï  #
.
ïï# $
Span
ïï$ (
(
ïï( )
$str
ïï) 2
)
ïï2 3
.
ïï3 4
FontSize
ïï4 <
(
ïï< =
$num
ïï= ?
)
ïï? @
.
ïï@ A
	FontColor
ïïA J
(
ïïJ K
$str
ïïK T
)
ïïT U
;
ïïU V
txt
ññ  #
.
ññ# $
CurrentPageNumber
ññ$ 5
(
ññ5 6
)
ññ6 7
.
ññ7 8
FontSize
ññ8 @
(
ññ@ A
$num
ññA C
)
ññC D
.
ññD E
	FontColor
ññE N
(
ññN O
$str
ññO X
)
ññX Y
;
ññY Z
txt
óó  #
.
óó# $
Span
óó$ (
(
óó( )
$str
óó) /
)
óó/ 0
.
óó0 1
FontSize
óó1 9
(
óó9 :
$num
óó: <
)
óó< =
.
óó= >
	FontColor
óó> G
(
óóG H
$str
óóH Q
)
óóQ R
;
óóR S
txt
òò  #
.
òò# $

TotalPages
òò$ .
(
òò. /
)
òò/ 0
.
òò0 1
FontSize
òò1 9
(
òò9 :
$num
òò: <
)
òò< =
.
òò= >
	FontColor
òò> G
(
òòG H
$str
òòH Q
)
òòQ R
;
òòR S
}
ôô 
)
ôô 
;
ôô 
}
öö 
)
öö 
;
öö 
}
õõ 
)
õõ 
;
õõ 
byte
ùù 
[
ùù 
]
ùù 
pdfBytes
ùù 
=
ùù 
document
ùù &
.
ùù& '
GeneratePdf
ùù' 2
(
ùù2 3
)
ùù3 4
;
ùù4 5
using
ûû 
var
ûû 
memoryStream
ûû "
=
ûû# $
new
ûû% (
MemoryStream
ûû) 5
(
ûû5 6
pdfBytes
ûû6 >
)
ûû> ?
;
ûû? @
return
üü 
memoryStream
üü 
.
üü  
ToArray
üü  '
(
üü' (
)
üü( )
;
üü) *
}
†† 	
)
††	 

;
††
 
}
°° 
}¢¢ •
OC:\HeroSystem\walletService\WalletService.Core\Services\InvoiceDetailService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class  
InvoiceDetailService !
:! "
BaseService" -
,- .!
IInvoiceDetailService. C
{		 
private

 
readonly

 $
IInvoiceDetailRepository

 -$
_invoiceDetailRepository

. F
;

F G
public 
 
InvoiceDetailService 
(  
IMapper  '
mapper( .
,. /$
IInvoiceDetailRepository0 H#
invoiceDetailRepositoryI `
)` a
:b c
based h
(h i
mapperi o
)o p
{ $
_invoiceDetailRepository  
=! "#
invoiceDetailRepository# :
;: ;
} 
public 

async 
Task 
< 
IEnumerable !
<! "
InvoiceDetailDto" 2
>2 3
>3 4$
GetAllInvoiceDetailAsync5 M
(M N
)N O
{ 
var 
response 
= 
await $
_invoiceDetailRepository 5
.5 6$
GetAllInvoiceDetailAsync6 N
(N O
)O P
;P Q
return 
Mapper 
. 
Map 
< 
IEnumerable %
<% &
InvoiceDetailDto& 6
>6 7
>7 8
(8 9
response9 A
)A B
;B C
} 
} ì’
IC:\HeroSystem\walletService\WalletService.Core\Services\InvoiceService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class 
InvoiceService 
: 
BaseService )
,) *
IInvoiceService+ :
{ 
private 
readonly 
IInvoiceRepository '
_invoiceRepository( :
;: ;
private 
readonly -
!ICoinPaymentTransactionRepository 6-
!_coinPaymentTransactionRepository7 X
;X Y
private 
readonly 
ILogger 
< 
InvoiceService +
>+ ,
_logger- 4
;4 5
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter, B
;B C
private 
readonly 
IBrevoEmailService '
_brevoEmailService( :
;: ;
private 
readonly $
IWalletModel1ARepository -$
_walletModel1ARepository. F
;F G
private 
readonly $
IWalletModel1BRepository -$
_walletModel1BRepository. F
;F G
private   
readonly   
IWalletRepository   &
_walletRepository  ' 8
;  8 9
private!! 
readonly!!  
IEcosystemPdfService!! ) 
_ecosystemPdfService!!* >
;!!> ?
private"" 
readonly"" 

RedisCache"" 
_redisCache""  +
;""+ ,
private## 
readonly## 
IBrandService## "
_brandService### 0
;##0 1
private$$ 
readonly$$ 
IRecyCoinPdfService$$ (
_recyCoinPdfService$$) <
;$$< =
public&& 

InvoiceService&& 
(&& 
IMapper&& !
mapper&&" (
,&&( )
IInvoiceRepository&&* <
invoiceRepository&&= N
,&&N O-
!ICoinPaymentTransactionRepository'' ),
 coinPaymentTransactionRepository''* J
,''J K
ILogger(( 
<(( 
InvoiceService(( 
>(( 
logger((  &
,((& '"
IAccountServiceAdapter((( >!
accountServiceAdapter((? T
,((T U
IBrevoEmailService)) 
brevoEmailService)) ,
,)), -$
IWalletModel1ARepository)). F#
walletModel1ARepository))G ^
,))^ _$
IWalletModel1BRepository**  #
walletModel1BRepository**! 8
,**8 9
IWalletRepository**: K
walletRepository**L \
,**\ ] 
IEcosystemPdfService++ 
ecosystemPdfService++ 0
,++0 1

RedisCache++2 <

redisCache++= G
,++G H
IBrandService++I V
brandService++W c
,++c d
IRecyCoinPdfService,, 
recyCoinPdfService,, .
),,. /
:,,0 1
base,,2 6
(,,6 7
mapper,,7 =
),,= >
{-- 
_invoiceRepository.. 
=.. 
invoiceRepository.. .
;... /-
!_coinPaymentTransactionRepository// )
=//* +,
 coinPaymentTransactionRepository//, L
;//L M
_logger00 
=00 
logger00 
;00 "
_accountServiceAdapter11 
=11  !
accountServiceAdapter11! 6
;116 7
_brevoEmailService22 
=22 
brevoEmailService22 .
;22. /$
_walletModel1ARepository33  
=33! "#
walletModel1ARepository33# :
;33: ;$
_walletModel1BRepository44  
=44! "#
walletModel1BRepository44# :
;44: ;
_walletRepository55 
=55 
walletRepository55 ,
;55, - 
_ecosystemPdfService66 
=66 
ecosystemPdfService66 2
;662 3
_redisCache77 
=77 

redisCache77  
;77  !
_brandService88 
=88 
brandService88 $
;88$ %
_recyCoinPdfService99 
=99 
recyCoinPdfService99 0
;990 1
}:: 
public<< 

async<< 
Task<< 
<<< 
IEnumerable<< !
<<<! "

InvoiceDto<<" ,
><<, -
><<- ."
GetAllInvoiceUserAsync<</ E
(<<E F
int<<F I
id<<J L
)<<L M
{== 
var>> 
response>> 
=>> 
await>> 
_invoiceRepository>> /
.>>/ 0
GetAllInvoicesUser>>0 B
(>>B C
id>>C E
,>>E F
_brandService>>G T
.>>T U
BrandId>>U \
)>>\ ]
;>>] ^
var?? 

mappedList?? 
=?? 
Mapper?? 
.??  
Map??  #
<??# $
IEnumerable??$ /
<??/ 0

InvoiceDto??0 :
>??: ;
>??; <
(??< =
response??= E
)??E F
.??F G
ToList??G M
(??M N
)??N O
;??O P

mappedList@@ 
.@@ 
Reverse@@ 
(@@ 
)@@ 
;@@ 
returnBB 

mappedListBB 
;BB 
}CC 
publicEE 

asyncEE 
TaskEE 
<EE 

InvoiceDtoEE  
>EE  !
CreateInvoiceAsyncEE" 4
(EE4 5
InvoiceRequestEE5 C
requestEED K
)EEK L
{FF 
varGG 
invoiceGG 
=GG 
MapperGG 
.GG 
MapGG  
<GG  !
InvoiceGG! (
>GG( )
(GG) *
requestGG* 1
)GG1 2
;GG2 3
invoiceHH 
=HH 
awaitHH 
_invoiceRepositoryHH *
.HH* +
CreateInvoiceAsyncHH+ =
(HH= >
invoiceHH> E
)HHE F
;HHF G
returnII 
MapperII 
.II 
MapII 
<II 

InvoiceDtoII $
>II$ %
(II% &
invoiceII& -
)II- .
;II. /
}JJ 
publicLL 

asyncLL 
TaskLL 
<LL 
PaginationDtoLL #
<LL# $

InvoiceDtoLL$ .
>LL. /
>LL/ 0
GetAllInvoicesLL1 ?
(LL? @
PaginationRequestLL@ Q
requestLLR Y
)LLY Z
{MM 
ValidateDateRangeNN 
(NN 
requestNN !
.NN! "
	StartDateNN" +
,NN+ ,
requestNN- 4
.NN4 5
EndDateNN5 <
)NN< =
;NN= >
varPP 
responsePP 
=PP 
awaitPP 
_invoiceRepositoryPP /
.PP/ 0
GetAllInvoicesPP0 >
(PP> ?
_brandServicePP? L
.PPL M
BrandIdPPM T
,PPT U
requestPPV ]
)PP] ^
;PP^ _
varQQ 
mappedItemsQQ 
=QQ 
MapperQQ  
.QQ  !
MapQQ! $
<QQ$ %
ListQQ% )
<QQ) *

InvoiceDtoQQ* 4
>QQ4 5
>QQ5 6
(QQ6 7
responseQQ7 ?
.QQ? @
ItemsQQ@ E
)QQE F
;QQF G
varSS 
	userTasksSS 
=SS 
mappedItemsSS #
.SS# $
SelectSS$ *
(SS* +
asyncSS+ 0
invoiceSS1 8
=>SS9 ;
{TT 	
tryUU 
{VV 
varWW 
userWW 
=WW 
awaitWW  "
_accountServiceAdapterWW! 7
.WW7 8
GetUserInfoWW8 C
(WWC D
invoiceWWD K
.WWK L
AffiliateIdWWL W
,WWW X
_brandServiceWWY f
.WWf g
BrandIdWWg n
)WWn o
;WWo p
invoiceXX 
.XX 
UserNameXX  
=XX! "
userXX# '
?XX' (
.XX( )
UserNameXX) 1
;XX1 2
invoiceYY 
.YY 
NameYY 
=YY 
userYY #
?YY# $
.YY$ %
NameYY% )
;YY) *
invoiceZZ 
.ZZ 
LastNameZZ  
=ZZ! "
userZZ# '
?ZZ' (
.ZZ( )
LastNameZZ) 1
;ZZ1 2
}[[ 
catch\\ 
(\\ 
	Exception\\ 
e\\ 
)\\ 
{]] 
_logger^^ 
.^^ 
LogError^^  
(^^  !
e^^! "
,^^" #
$"^^$ &
$str^^& L
{^^L M
invoice^^M T
.^^T U
AffiliateId^^U `
}^^` a
"^^a b
)^^b c
;^^c d
throw__ 
;__ 
}`` 
}aa 	
)aa	 

;aa
 
awaitcc 
Taskcc 
.cc 
WhenAllcc 
(cc 
	userTaskscc $
)cc$ %
;cc% &
returnee 
newee 
PaginationDtoee  
<ee  !

InvoiceDtoee! +
>ee+ ,
{ff 	
CurrentPagegg 
=gg 
responsegg "
.gg" #
CurrentPagegg# .
,gg. /
PageSizehh 
=hh 
responsehh 
.hh  
PageSizehh  (
,hh( )

TotalCountii 
=ii 
responseii !
.ii! "

TotalCountii" ,
,ii, -

TotalPagesjj 
=jj 
responsejj !
.jj! "

TotalPagesjj" ,
,jj, -
Itemskk 
=kk 
mappedItemskk 
}ll 	
;ll	 

}mm 
privateoo 
voidoo 
ValidateDateRangeoo "
(oo" #
DateTimeoo# +
?oo+ ,
	startDateoo- 6
,oo6 7
DateTimeoo8 @
?oo@ A
endDateooB I
)ooI J
{pp 
ifqq 

(qq 
	startDateqq 
.qq 
HasValueqq 
&&qq !
endDateqq" )
.qq) *
HasValueqq* 2
&&qq3 5
	startDateqq6 ?
>qq@ A
endDateqqB I
)qqI J
{rr 	
throwss 
newss 
ArgumentExceptionss '
(ss' (
$strss( U
)ssU V
;ssV W
}tt 	
}uu 
publicww 

asyncww 
Taskww 
<ww 
boolww 
>ww 1
%RevertUnconfirmedOrUnpaidTransactionsww A
(wwA B
)wwB C
{xx 
varyy 
builderyy 
=yy 
newyy 
StringBuilderyy '
(yy' (
)yy( )
;yy) *
builder{{ 
.{{ 

AppendLine{{ 
({{ 
$"{{ 
$str{{ _
"{{_ `
){{` a
;{{a b
var|| 
transactionsResults|| 
=||  !
await}} -
!_coinPaymentTransactionRepository}} 3
.}}3 41
%GetAllUnconfirmedOrUnpaidTransactions}}4 Y
(}}Y Z
_brandService}}Z g
.}}g h
BrandId}}h o
)}}o p
;}}p q
var~~ 
idsTransactions~~ 
=~~ 
transactionsResults~~ 1
.~~1 2
Select~~2 8
(~~8 9
e~~9 :
=>~~; =
e~~> ?
.~~? @
IdTransaction~~@ M
)~~M N
.~~N O
ToList~~O U
(~~U V
)~~V W
;~~W X
if
ÄÄ 

(
ÄÄ 
idsTransactions
ÄÄ 
is
ÄÄ 
{
ÄÄ  
Count
ÄÄ! &
:
ÄÄ& '
$num
ÄÄ( )
}
ÄÄ* +
)
ÄÄ+ ,
{
ÅÅ 	
_logger
ÇÇ 
.
ÇÇ 

LogWarning
ÇÇ 
(
ÇÇ 
builder
ÇÇ &
.
ÇÇ& '
ToString
ÇÇ' /
(
ÇÇ/ 0
)
ÇÇ0 1
)
ÇÇ1 2
;
ÇÇ2 3
return
ÉÉ 
false
ÉÉ 
;
ÉÉ 
}
ÑÑ 	
builder
ÜÜ 
.
ÜÜ 

AppendLine
ÜÜ 
(
ÜÜ 
$"
áá 
$str
áá Y
{
ááY Z
idsTransactions
ááZ i
.
áái j
ToJsonString
ááj v
(
ááv w
)
ááw x
}
ááx y
"
ááy z
)
ááz {
;
áá{ |
var
àà 
invoicesResult
àà 
=
àà 
await
àà " 
_invoiceRepository
àà# 5
.
àà5 6(
GetInvoicesByReceiptNumber
àà6 P
(
ààP Q
idsTransactions
ààQ `
)
àà` a
;
ààa b
var
ââ 
invoicesToRevert
ââ 
=
ââ 
invoicesResult
ââ -
.
ââ- .
Select
ââ. 4
(
ââ4 5
e
ââ5 6
=>
ââ7 9
new
ââ: =
InvoiceNumber
ââ> K
{
ââL M 
InvoiceNumberValue
ââN `
=
ââa b
e
ââc d
.
ââd e
Id
ââe g
}
ââh i
)
ââi j
.
ââj k
ToList
ââk q
(
ââq r
)
ââr s
;
ââs t
if
ãã 

(
ãã 
invoicesToRevert
ãã 
is
ãã 
{
ãã  !
Count
ãã" '
:
ãã' (
$num
ãã) *
}
ãã+ ,
)
ãã, -
{
åå 	
_logger
çç 
.
çç 

LogWarning
çç 
(
çç 
builder
çç &
.
çç& '
ToString
çç' /
(
çç/ 0
)
çç0 1
)
çç1 2
;
çç2 3
return
éé 
false
éé 
;
éé 
}
èè 	
builder
ëë 
.
ëë 

AppendLine
ëë 
(
ëë 
$"
íí 
$str
íí Z
{
ííZ [
idsTransactions
íí[ j
.
ííj k
ToJsonString
íík w
(
ííw x
)
ííx y
}
ííy z
"
ííz {
)
íí{ |
;
íí| }
await
ìì  
_invoiceRepository
ìì  
.
ìì  !+
RevertCoinPaymentTransactions
ìì! >
(
ìì> ?
invoicesToRevert
ìì? O
)
ììO P
;
ììP Q
builder
ïï 
.
ïï 

AppendLine
ïï 
(
ïï 
$"
ïï 
$str
ïï a
"
ïïa b
)
ïïb c
;
ïïc d
_logger
óó 
.
óó 
LogInformation
óó 
(
óó 
builder
óó &
.
óó& '
ToString
óó' /
(
óó/ 0
)
óó0 1
)
óó1 2
;
óó2 3
return
ôô 
true
ôô 
;
ôô 
}
öö 
public
úú 

async
úú 
Task
úú 
<
úú 
IEnumerable
úú !
<
úú! "&
InvoiceTradingAcademyDto
úú" :
?
úú: ;
>
úú; <
>
úú< =6
(GetAllInvoicesForTradingAcademyPurchases
úú> f
(
úúf g
)
úúg h
{
ùù 
var
ûû 
response
ûû 
=
ûû 
await
ûû  
_invoiceRepository
ûû /
.
ûû/ 06
(GetAllInvoicesForTradingAcademyPurchases
ûû0 X
(
ûûX Y
)
ûûY Z
;
ûûZ [
if
†† 

(
†† 
response
†† 
is
†† 
null
†† 
)
†† 
return
°° 
new
°° 
List
°° 
<
°° &
InvoiceTradingAcademyDto
°° 4
>
°°4 5
(
°°5 6
)
°°6 7
;
°°7 8
var
££ 

mappedList
££ 
=
££ 
Mapper
££ 
.
££  
Map
££  #
<
££# $
List
££$ (
<
££( )&
InvoiceTradingAcademyDto
££) A
>
££A B
>
££B C
(
££C D
response
££D L
)
££L M
;
££M N
if
•• 

(
•• 

mappedList
•• 
is
•• 
null
•• 
)
•• 
return
¶¶ 
new
¶¶ 
List
¶¶ 
<
¶¶ &
InvoiceTradingAcademyDto
¶¶ 4
>
¶¶4 5
(
¶¶5 6
)
¶¶6 7
;
¶¶7 8
foreach
®® 
(
®® 
var
®® 
invoice
®® 
in
®® 

mappedList
®®  *
)
®®* +
{
©© 	
if
™™ 
(
™™ 
invoice
™™ 
.
™™ 
	ProductId
™™ !
==
™™" $
$num
™™% '
)
™™' (
{
´´ 
var
¨¨ 
(
¨¨ 
	startDate
¨¨ 
,
¨¨ 
endDate
¨¨  '
)
¨¨' (
=
¨¨) *
CommonExtensions
¨¨+ ;
.
¨¨; <)
CalculateMonthlyCourseDates
¨¨< W
(
¨¨W X
invoice
¨¨X _
.
¨¨_ `
	CreatedAt
¨¨` i
)
¨¨i j
;
¨¨j k
invoice
≠≠ 
.
≠≠ 
StartDay
≠≠  
=
≠≠! "
	startDate
≠≠# ,
.
≠≠, -
Date
≠≠- 1
.
≠≠1 2
ToString
≠≠2 :
(
≠≠: ;
$str
≠≠; G
)
≠≠G H
;
≠≠H I
invoice
ÆÆ 
.
ÆÆ 
EndDay
ÆÆ 
=
ÆÆ  
endDate
ÆÆ! (
.
ÆÆ( )
Date
ÆÆ) -
.
ÆÆ- .
ToString
ÆÆ. 6
(
ÆÆ6 7
$str
ÆÆ7 C
)
ÆÆC D
;
ÆÆD E
}
ØØ 
else
∞∞ 
if
∞∞ 
(
∞∞ 
invoice
∞∞ 
.
∞∞ 
	ProductId
∞∞ &
==
∞∞' )
$num
∞∞* ,
)
∞∞, -
{
±± 
var
≤≤ 
(
≤≤ 
	startDate
≤≤ 
,
≤≤ 
endDate
≤≤  '
)
≤≤' (
=
≤≤) *
CommonExtensions
≤≤+ ;
.
≤≤; <(
CalculateWeeklyCourseDates
≤≤< V
(
≤≤V W
invoice
≤≤W ^
.
≤≤^ _
	CreatedAt
≤≤_ h
)
≤≤h i
;
≤≤i j
invoice
≥≥ 
.
≥≥ 
StartDay
≥≥  
=
≥≥! "
	startDate
≥≥# ,
.
≥≥, -
Date
≥≥- 1
.
≥≥1 2
ToString
≥≥2 :
(
≥≥: ;
$str
≥≥; G
)
≥≥G H
;
≥≥H I
invoice
¥¥ 
.
¥¥ 
EndDay
¥¥ 
=
¥¥  
endDate
¥¥! (
.
¥¥( )
Date
¥¥) -
.
¥¥- .
ToString
¥¥. 6
(
¥¥6 7
$str
¥¥7 C
)
¥¥C D
;
¥¥D E
}
µµ 
}
∂∂ 	
return
∏∏ 

mappedList
∏∏ 
;
∏∏ 
}
ππ 
public
ªª 

async
ªª 
Task
ªª 
<
ªª 
IEnumerable
ªª !
<
ªª! "#
UserAffiliateResponse
ªª" 7
>
ªª7 8
>
ªª8 9/
!SendInvitationsForUpcomingCourses
ªª: [
(
ªª[ \
string
ªª\ b
link
ªªc g
,
ªªg h
string
ªªi o
code
ªªp t
)
ªªt u
{
ºº 
var
ΩΩ 
allInvoices
ΩΩ 
=
ΩΩ 
await
ΩΩ  
_invoiceRepository
ΩΩ  2
.
ΩΩ2 36
(GetAllInvoicesForTradingAcademyPurchases
ΩΩ3 [
(
ΩΩ[ \
)
ΩΩ\ ]
;
ΩΩ] ^
var
ææ 

nextMonday
ææ 
=
ææ 
CommonExtensions
ææ )
.
ææ) *!
CalculateNextMonday
ææ* =
(
ææ= >
DateTime
ææ> F
.
ææF G
Today
ææG L
)
ææL M
;
ææM N
if
¿¿ 

(
¿¿ 
allInvoices
¿¿ 
is
¿¿ 
null
¿¿ 
)
¿¿  
return
¡¡ 
new
¡¡ 
List
¡¡ 
<
¡¡ #
UserAffiliateResponse
¡¡ 1
>
¡¡1 2
(
¡¡2 3
)
¡¡3 4
;
¡¡4 5
var
√√ 
tasks
√√ 
=
√√ 
allInvoices
√√ 
.
√√  
Where
√√  %
(
√√% &
invoice
√√& -
=>
√√. 0
invoice
ƒƒ 
.
ƒƒ 
	ProductId
ƒƒ !
==
ƒƒ" $
	Constants
ƒƒ% .
.
ƒƒ. /
ForMonth
ƒƒ/ 7
||
ƒƒ8 :
invoice
ƒƒ; B
.
ƒƒB C
	ProductId
ƒƒC L
==
ƒƒM O
	Constants
ƒƒP Y
.
ƒƒY Z
ForWeek
ƒƒZ a
)
ƒƒa b
.
≈≈ 
Select
≈≈ 
(
≈≈ 
async
≈≈ 
invoice
≈≈ !
=>
≈≈" $
{
∆∆ 
var
«« 
endDate
«« 
=
«« 
invoice
«« %
.
««% &
	ProductId
««& /
==
««0 2
	Constants
««3 <
.
««< =
ForMonth
««= E
?
»» 
CommonExtensions
»» &
.
»»& ')
CalculateMonthlyCourseDates
»»' B
(
»»B C
invoice
»»C J
.
»»J K
	CreatedAt
»»K T
)
»»T U
.
»»U V
EndDate
»»V ]
:
…… 
CommonExtensions
…… &
.
……& '(
CalculateWeeklyCourseDates
……' A
(
……A B
invoice
……B I
.
……I J
	CreatedAt
……J S
)
……S T
.
……T U
EndDate
……U \
;
……\ ]
if
ÀÀ 
(
ÀÀ 
endDate
ÀÀ 
.
ÀÀ 
Date
ÀÀ  
<
ÀÀ! "

nextMonday
ÀÀ# -
)
ÀÀ- .
return
ÃÃ 
null
ÃÃ 
;
ÃÃ  
var
ŒŒ 
userResponse
ŒŒ  
=
ŒŒ! "
await
œœ $
_accountServiceAdapter
œœ 0
.
œœ0 1$
GetAffiliateByUserName
œœ1 G
(
œœG H
invoice
œœH O
.
œœO P
UserName
œœP X
,
œœX Y
_brandService
œœZ g
.
œœg h
BrandId
œœh o
)
œœo p
;
œœp q
if
–– 
(
–– 
userResponse
––  
.
––  !
Content
––! (
is
––) +
null
––, 0
)
––0 1
return
—— 
null
—— 
;
——  
var
”” 
user
”” 
=
”” 
userResponse
”” '
.
””' (
Content
””( /
.
””/ 0
ToJsonObject
””0 <
<
””< =#
UserAffiliateResponse
””= R
>
””R S
(
””S T
)
””T U
;
””U V
await
‘‘  
_brevoEmailService
‘‘ (
.
‘‘( ).
 SendInvitationsForTradingAcademy
‘‘) I
(
‘‘I J
user
‘‘J N
!
‘‘N O
,
‘‘O P
link
‘‘Q U
,
‘‘U V
code
‘‘W [
,
‘‘[ \
_brandService
‘‘] j
.
‘‘j k
BrandId
‘‘k r
)
‘‘r s
;
‘‘s t
return
’’ 
user
’’ 
?
’’ 
.
’’ 
Data
’’ !
is
’’" $
null
’’% )
?
’’* +
null
’’, 0
:
’’1 2
user
’’3 7
;
’’7 8
}
÷÷ 
)
÷÷ 
;
÷÷ 
var
ÿÿ 
results
ÿÿ 
=
ÿÿ 
await
ÿÿ 
Task
ÿÿ  
.
ÿÿ  !
WhenAll
ÿÿ! (
(
ÿÿ( )
tasks
ÿÿ) .
)
ÿÿ. /
;
ÿÿ/ 0
return
ŸŸ 
results
ŸŸ 
.
ŸŸ 
Where
ŸŸ 
(
ŸŸ 
user
ŸŸ !
=>
ŸŸ" $
user
ŸŸ% )
!=
ŸŸ* ,
null
ŸŸ- 1
)
ŸŸ1 2
.
ŸŸ2 3
Select
ŸŸ3 9
(
ŸŸ9 :
user
ŸŸ: >
=>
ŸŸ? A
user
ŸŸB F
!
ŸŸF G
)
ŸŸG H
;
ŸŸH I
}
⁄⁄ 
public
‹‹ 

async
‹‹ 
Task
‹‹ 
<
‹‹ 
IEnumerable
‹‹ !
<
‹‹! "&
InvoiceModelOneAndTwoDto
‹‹" :
>
‹‹: ;
>
‹‹; <*
GetAllInvoicesModelOneAndTwo
‹‹= Y
(
‹‹Y Z
)
‹‹Z [
{
›› 
var
ﬁﬁ 
response
ﬁﬁ 
=
ﬁﬁ 
await
ﬁﬁ  
_invoiceRepository
ﬁﬁ /
.
ﬁﬁ/ 0*
GetAllInvoicesModelOneAndTwo
ﬁﬁ0 L
(
ﬁﬁL M
)
ﬁﬁM N
;
ﬁﬁN O
if
‡‡ 

(
‡‡ 
response
‡‡ 
is
‡‡ 
null
‡‡ 
)
‡‡ 
return
·· 
new
·· 
List
·· 
<
·· &
InvoiceModelOneAndTwoDto
·· 4
>
··4 5
(
··5 6
)
··6 7
;
··7 8
var
„„ 
invoices
„„ 
=
„„ 
Mapper
„„ 
.
„„ 
Map
„„ !
<
„„! "
IEnumerable
„„" -
<
„„- .&
InvoiceModelOneAndTwoDto
„„. F
>
„„F G
>
„„G H
(
„„H I
response
„„I Q
)
„„Q R
;
„„R S
var
‰‰ 
invoicesOrdered
‰‰ 
=
‰‰ 
invoices
‰‰ &
.
‰‰& '
OrderByDescending
‰‰' 8
(
‰‰8 9
e
‰‰9 :
=>
‰‰; =
e
‰‰> ?
.
‰‰? @
	CreatedAt
‰‰@ I
)
‰‰I J
.
‰‰J K
ToList
‰‰K Q
(
‰‰Q R
)
‰‰R S
;
‰‰S T
return
ÊÊ 
invoicesOrdered
ÊÊ 
;
ÊÊ 
}
ÁÁ 
public
ÈÈ 

async
ÈÈ 
Task
ÈÈ 
<
ÈÈ )
ModelBalancesAndInvoicesDto
ÈÈ 1
?
ÈÈ1 2
>
ÈÈ2 34
&ProcessAndReturnBalancesForModels1A1B2
ÈÈ4 Z
(
ÈÈZ [-
ModelBalancesAndInvoicesRequest
ÍÍ '
request
ÍÍ( /
)
ÍÍ/ 0
{
ÎÎ 
var
ÏÏ 
totalModels
ÏÏ 
=
ÏÏ 
request
ÏÏ !
.
ÏÏ! "
Model1AAmount
ÏÏ" /
+
ÏÏ0 1
request
ÏÏ2 9
.
ÏÏ9 :
Model1BAmount
ÏÏ: G
+
ÏÏH I
request
ÏÏJ Q
.
ÏÏQ R
Model2Amount
ÏÏR ^
;
ÏÏ^ _
if
ÌÌ 

(
ÌÌ 
request
ÌÌ 
.
ÌÌ 
	InvoiceId
ÌÌ 
.
ÌÌ 
Length
ÌÌ $
==
ÌÌ% '
$num
ÌÌ( )
)
ÌÌ) *
return
ÓÓ 
null
ÓÓ 
;
ÓÓ 
var
 
(
 
validInvoiceIds
 
,
 
affiliateId
 )
,
) *
totalInvoices
+ 8
)
8 9
=
: ;
await
< A
ProcessInvoices
B Q
(
Q R
request
R Y
.
Y Z
	InvoiceId
Z c
)
c d
;
d e
if
ÚÚ 

(
ÚÚ 
affiliateId
ÚÚ 
==
ÚÚ 
$num
ÚÚ 
||
ÚÚ 
totalModels
ÚÚ  +
>
ÚÚ, -
totalInvoices
ÚÚ. ;
)
ÚÚ; <
return
ÛÛ 
null
ÛÛ 
;
ÛÛ 
bool
ıı .
 isAnyCreditTransactionSuccessful
ıı -
=
ıı. /
false
ıı0 5
;
ıı5 6
if
˜˜ 

(
˜˜ 
request
˜˜ 
.
˜˜ 
Model1AAmount
˜˜ !
>
˜˜" #
$num
˜˜$ %
)
˜˜% &.
 isAnyCreditTransactionSuccessful
¯¯ ,
|=
¯¯- /
await
˘˘ "
CreditAmountToWallet
˘˘ *
(
˘˘* +
affiliateId
˘˘+ 6
,
˘˘6 7
request
˘˘8 ?
.
˘˘? @
UserName
˘˘@ H
,
˘˘H I
request
˘˘J Q
.
˘˘Q R
Model1AAmount
˘˘R _
,
˘˘_ `
$str
˘˘a j
)
˘˘j k
;
˘˘k l
if
˚˚ 

(
˚˚ 
request
˚˚ 
.
˚˚ 
Model1BAmount
˚˚ !
>
˚˚" #
$num
˚˚$ %
)
˚˚% &.
 isAnyCreditTransactionSuccessful
¸¸ ,
|=
¸¸- /
await
˝˝ "
CreditAmountToWallet
˝˝ *
(
˝˝* +
affiliateId
˝˝+ 6
,
˝˝6 7
request
˝˝8 ?
.
˝˝? @
UserName
˝˝@ H
,
˝˝H I
request
˝˝J Q
.
˝˝Q R
Model1BAmount
˝˝R _
,
˝˝_ `
$str
˝˝a j
)
˝˝j k
;
˝˝k l
if
ˇˇ 

(
ˇˇ 
request
ˇˇ 
.
ˇˇ 
Model2Amount
ˇˇ  
>
ˇˇ! "
$num
ˇˇ# $
)
ˇˇ$ %.
 isAnyCreditTransactionSuccessful
ÄÄ ,
|=
ÄÄ- /
await
ÅÅ "
CreditAmountToWallet
ÅÅ *
(
ÅÅ* +
affiliateId
ÅÅ+ 6
,
ÅÅ6 7
request
ÅÅ8 ?
.
ÅÅ? @
UserName
ÅÅ@ H
,
ÅÅH I
request
ÅÅJ Q
.
ÅÅQ R
Model2Amount
ÅÅR ^
,
ÅÅ^ _
$str
ÅÅ` h
)
ÅÅh i
;
ÅÅi j
if
ÉÉ 

(
ÉÉ .
 isAnyCreditTransactionSuccessful
ÉÉ ,
&&
ÉÉ- /
validInvoiceIds
ÉÉ0 ?
.
ÉÉ? @
Any
ÉÉ@ C
(
ÉÉC D
)
ÉÉD E
)
ÉÉE F
{
ÑÑ 	
await
ÖÖ  
_invoiceRepository
ÖÖ $
.
ÖÖ$ %3
%DeleteMultipleInvoicesAndDetailsAsync
ÖÖ% J
(
ÖÖJ K
validInvoiceIds
ÖÖK Z
.
ÖÖZ [
ToArray
ÖÖ[ b
(
ÖÖb c
)
ÖÖc d
,
ÖÖd e
_brandService
ÜÜ 
.
ÜÜ 
BrandId
ÜÜ %
)
ÜÜ% &
;
ÜÜ& '
}
áá 	
return
ââ 
new
ââ )
ModelBalancesAndInvoicesDto
ââ .
{
ää 	
UserName
ãã 
=
ãã 
request
ãã 
.
ãã 
UserName
ãã '
,
ãã' (
Model1AAmount
åå 
=
åå 
request
åå #
.
åå# $
Model1AAmount
åå$ 1
,
åå1 2
Model1BAmount
çç 
=
çç 
request
çç #
.
çç# $
Model1BAmount
çç$ 1
,
çç1 2
Model2Amount
éé 
=
éé 
request
éé "
.
éé" #
Model2Amount
éé# /
,
éé/ 0
	InvoiceId
èè 
=
èè 
validInvoiceIds
èè '
.
èè' (
ToArray
èè( /
(
èè/ 0
)
èè0 1
}
êê 	
;
êê	 

}
ëë 
private
ìì 
async
ìì 
Task
ìì 
<
ìì 
(
ìì 
List
ìì 
<
ìì 
long
ìì !
>
ìì! "
,
ìì" #
int
ìì$ '
,
ìì' (
decimal
ìì) 0
)
ìì0 1
>
ìì1 2
ProcessInvoices
ìì3 B
(
ììB C
long
ììC G
[
ììG H
]
ììH I

invoiceIds
ììJ T
)
ììT U
{
îî 
var
ïï 
totalInvoices
ïï 
=
ïï 
$num
ïï 
;
ïï 
var
ññ 
validInvoiceIds
ññ 
=
ññ 
new
ññ !
HashSet
ññ" )
<
ññ) *
long
ññ* .
>
ññ. /
(
ññ/ 0
)
ññ0 1
;
ññ1 2
int
óó 
affiliateId
óó 
=
óó 
$num
óó 
;
óó 
foreach
ôô 
(
ôô 
var
ôô 
	invoiceId
ôô 
in
ôô !

invoiceIds
ôô" ,
)
ôô, -
{
öö 	
if
õõ 
(
õõ 
!
õõ 
validInvoiceIds
õõ  
.
õõ  !
Contains
õõ! )
(
õõ) *
	invoiceId
õõ* 3
)
õõ3 4
)
õõ4 5
{
úú 
var
ùù 
invoice
ùù 
=
ùù 
await
ùù # 
_invoiceRepository
ùù$ 6
.
ùù6 7
GetInvoiceById
ùù7 E
(
ùùE F
	invoiceId
ùùF O
,
ùùO P
_brandService
ùùQ ^
.
ùù^ _
BrandId
ùù_ f
)
ùùf g
;
ùùg h
if
üü 
(
üü 
invoice
üü 
!=
üü 
null
üü #
)
üü# $
{
†† 
if
°° 
(
°° 
affiliateId
°° #
==
°°$ &
$num
°°' (
)
°°( )
affiliateId
¢¢ #
=
¢¢$ %
invoice
¢¢& -
.
¢¢- .
AffiliateId
¢¢. 9
;
¢¢9 :
else
££ 
if
££ 
(
££ 
affiliateId
££ (
!=
££) +
invoice
££, 3
.
££3 4
AffiliateId
££4 ?
)
££? @
{
§§ 
return
•• 
(
••  
new
••  #
List
••$ (
<
••( )
long
••) -
>
••- .
(
••. /
)
••/ 0
,
••0 1
$num
••2 3
,
••3 4
$num
••5 7
)
••7 8
;
••8 9
}
¶¶ 
totalInvoices
®® !
+=
®®" $
invoice
®®% ,
.
®®, -
TotalInvoice
®®- 9
??
®®: <
$num
®®= >
;
®®> ?
validInvoiceIds
©© #
.
©©# $
Add
©©$ '
(
©©' (
	invoiceId
©©( 1
)
©©1 2
;
©©2 3
}
™™ 
}
´´ 
}
¨¨ 	
return
ÆÆ 
(
ÆÆ 
validInvoiceIds
ÆÆ 
.
ÆÆ  
ToList
ÆÆ  &
(
ÆÆ& '
)
ÆÆ' (
,
ÆÆ( )
affiliateId
ÆÆ* 5
,
ÆÆ5 6
totalInvoices
ÆÆ7 D
)
ÆÆD E
;
ÆÆE F
}
ØØ 
private
±± 
async
±± 
Task
±± 
<
±± 
bool
±± 
>
±± "
CreditAmountToWallet
±± 1
(
±±1 2
int
±±2 5
affiliateId
±±6 A
,
±±A B
string
±±C I
userName
±±J R
,
±±R S
decimal
±±T [
amount
±±\ b
,
±±b c
string
±±d j
model
±±k p
)
±±p q
{
≤≤ 
if
≥≥ 

(
≥≥ 
amount
≥≥ 
<=
≥≥ 
$num
≥≥ 
)
≥≥ 
return
≥≥ 
false
≥≥  %
;
≥≥% &
var
µµ &
creditTransactionRequest
µµ $
=
µµ% &
new
µµ' *&
CreditTransactionRequest
µµ+ C
{
∂∂ 	
AffiliateId
∑∑ 
=
∑∑ 
affiliateId
∑∑ %
,
∑∑% &
UserId
∏∏ 
=
∏∏ 
	Constants
∏∏ 
.
∏∏ 
AdminUserId
∏∏ *
,
∏∏* +
Concept
ππ 
=
ππ 
	Constants
ππ 
.
ππ  
BalanceRefunds
ππ  .
,
ππ. /
Credit
∫∫ 
=
∫∫ 
Convert
∫∫ 
.
∫∫ 
ToDouble
∫∫ %
(
∫∫% &
amount
∫∫& ,
)
∫∫, -
,
∫∫- .
AffiliateUserName
ªª 
=
ªª 
userName
ªª  (
,
ªª( )
AdminUserName
ºº 
=
ºº 
	Constants
ºº %
.
ºº% &$
AdminEcosystemUserName
ºº& <
,
ºº< =
ConceptType
ΩΩ 
=
ΩΩ 
WalletConceptType
ΩΩ +
.
ΩΩ+ ,
revert_pool
ΩΩ, 7
.
ΩΩ7 8
ToString
ΩΩ8 @
(
ΩΩ@ A
)
ΩΩA B
}
ææ 	
;
ææ	 

try
¿¿ 
{
¡¡ 	
switch
¬¬ 
(
¬¬ 
model
¬¬ 
)
¬¬ 
{
√√ 
case
ƒƒ 
$str
ƒƒ 
:
ƒƒ 
await
≈≈ 
RemoveCacheKey
≈≈ (
(
≈≈( )
affiliateId
≈≈) 4
,
≈≈4 5
	CacheKeys
≈≈6 ?
.
≈≈? @'
BalanceInformationModel1A
≈≈@ Y
)
≈≈Y Z
;
≈≈Z [
await
∆∆ 
RemoveCacheKey
∆∆ (
(
∆∆( )
affiliateId
∆∆) 4
,
∆∆4 5
	CacheKeys
∆∆6 ?
.
∆∆? @'
BalanceInformationModel1B
∆∆@ Y
)
∆∆Y Z
;
∆∆Z [
await
«« 
RemoveCacheKey
«« (
(
««( )
affiliateId
««) 4
,
««4 5
	CacheKeys
««6 ?
.
««? @&
BalanceInformationModel2
««@ X
)
««X Y
;
««Y Z
return
»» 
await
»»  &
_walletModel1ARepository
»»! 9
.
»»9 :
CreditTransaction
»»: K
(
»»K L&
creditTransactionRequest
»»L d
)
»»d e
;
»»e f
case
…… 
$str
…… 
:
…… 
await
   
RemoveCacheKey
   (
(
  ( )
affiliateId
  ) 4
,
  4 5
	CacheKeys
  6 ?
.
  ? @'
BalanceInformationModel1A
  @ Y
)
  Y Z
;
  Z [
await
ÀÀ 
RemoveCacheKey
ÀÀ (
(
ÀÀ( )
affiliateId
ÀÀ) 4
,
ÀÀ4 5
	CacheKeys
ÀÀ6 ?
.
ÀÀ? @'
BalanceInformationModel1B
ÀÀ@ Y
)
ÀÀY Z
;
ÀÀZ [
await
ÃÃ 
RemoveCacheKey
ÃÃ (
(
ÃÃ( )
affiliateId
ÃÃ) 4
,
ÃÃ4 5
	CacheKeys
ÃÃ6 ?
.
ÃÃ? @&
BalanceInformationModel2
ÃÃ@ X
)
ÃÃX Y
;
ÃÃY Z
return
ÕÕ 
await
ÕÕ  &
_walletModel1BRepository
ÕÕ! 9
.
ÕÕ9 :
CreditTransaction
ÕÕ: K
(
ÕÕK L&
creditTransactionRequest
ÕÕL d
)
ÕÕd e
;
ÕÕe f
case
ŒŒ 
$str
ŒŒ 
:
ŒŒ 
await
œœ 
RemoveCacheKey
œœ (
(
œœ( )
affiliateId
œœ) 4
,
œœ4 5
	CacheKeys
œœ6 ?
.
œœ? @'
BalanceInformationModel1A
œœ@ Y
)
œœY Z
;
œœZ [
await
–– 
RemoveCacheKey
–– (
(
––( )
affiliateId
––) 4
,
––4 5
	CacheKeys
––6 ?
.
––? @'
BalanceInformationModel1B
––@ Y
)
––Y Z
;
––Z [
await
—— 
RemoveCacheKey
—— (
(
——( )
affiliateId
——) 4
,
——4 5
	CacheKeys
——6 ?
.
——? @&
BalanceInformationModel2
——@ X
)
——X Y
;
——Y Z
return
““ 
await
““  
_walletRepository
““! 2
.
““2 3
CreditTransaction
““3 D
(
““D E&
creditTransactionRequest
““E ]
)
““] ^
;
““^ _
}
”” 
return
’’ 
false
’’ 
;
’’ 
}
÷÷ 	
catch
◊◊ 
{
ÿÿ 	
return
ŸŸ 
false
ŸŸ 
;
ŸŸ 
}
⁄⁄ 	
}
€€ 
public
›› 

async
›› 
Task
›› 
<
›› 
byte
›› 
[
›› 
]
›› 
>
›› 
CreateInvoice
›› +
(
››+ ,
int
››, /
	invoiceId
››0 9
)
››9 :
{
ﬁﬁ 
var
ﬂﬂ 
invoice
ﬂﬂ 
=
ﬂﬂ 
await
ﬂﬂ  
_invoiceRepository
ﬂﬂ .
.
ﬂﬂ. /
GetInvoiceById
ﬂﬂ/ =
(
ﬂﬂ= >
	invoiceId
ﬂﬂ> G
,
ﬂﬂG H
_brandService
ﬂﬂI V
.
ﬂﬂV W
BrandId
ﬂﬂW ^
)
ﬂﬂ^ _
;
ﬂﬂ_ `
if
‡‡ 

(
‡‡ 
invoice
‡‡ 
is
‡‡ 
null
‡‡ 
)
‡‡ 
return
·· 
Array
·· 
.
·· 
Empty
·· 
<
·· 
byte
·· #
>
··# $
(
··$ %
)
··% &
;
··& '
var
„„ 
user
„„ 
=
„„ 
await
„„ $
_accountServiceAdapter
„„ /
.
„„/ 0
GetUserInfo
„„0 ;
(
„„; <
invoice
„„< C
.
„„C D
AffiliateId
„„D O
,
„„O P
_brandService
„„Q ^
.
„„^ _
BrandId
„„_ f
)
„„f g
;
„„g h
if
ÂÂ 

(
ÂÂ 
user
ÂÂ 
is
ÂÂ 
null
ÂÂ 
)
ÂÂ 
return
ÊÊ 
Array
ÊÊ 
.
ÊÊ 
Empty
ÊÊ 
<
ÊÊ 
byte
ÊÊ #
>
ÊÊ# $
(
ÊÊ$ %
)
ÊÊ% &
;
ÊÊ& '
var
ËË 
generatedInvoice
ËË 
=
ËË 
Array
ËË $
.
ËË$ %
Empty
ËË% *
<
ËË* +
byte
ËË+ /
>
ËË/ 0
(
ËË0 1
)
ËË1 2
;
ËË2 3
if
ÈÈ 

(
ÈÈ 
	Constants
ÈÈ 
.
ÈÈ 
	Ecosystem
ÈÈ 
==
ÈÈ  "
_brandService
ÈÈ# 0
.
ÈÈ0 1
BrandId
ÈÈ1 8
)
ÈÈ8 9
{
ÍÍ 	
generatedInvoice
ÎÎ 
=
ÎÎ 
await
ÎÎ $"
_ecosystemPdfService
ÎÎ% 9
.
ÎÎ9 :
RegenerateInvoice
ÎÎ: K
(
ÎÎK L
user
ÎÎL P
,
ÎÎP Q
invoice
ÎÎR Y
)
ÎÎY Z
;
ÎÎZ [
}
ÏÏ 	
else
ÌÌ 
if
ÌÌ 
(
ÌÌ 
	Constants
ÌÌ 
.
ÌÌ 
RecyCoin
ÌÌ #
==
ÌÌ$ &
_brandService
ÌÌ' 4
.
ÌÌ4 5
BrandId
ÌÌ5 <
)
ÌÌ< =
{
ÓÓ 	
generatedInvoice
ÔÔ 
=
ÔÔ 
await
ÔÔ $!
_recyCoinPdfService
ÔÔ% 8
.
ÔÔ8 9
RegenerateInvoice
ÔÔ9 J
(
ÔÔJ K
user
ÔÔK O
,
ÔÔO P
invoice
ÔÔQ X
)
ÔÔX Y
;
ÔÔY Z
}
 	
return
ÚÚ 
generatedInvoice
ÚÚ 
;
ÚÚ  
}
ÛÛ 
public
ıı 

async
ıı 
Task
ıı 
<
ıı 
InvoiceResultDto
ıı &
?
ıı& '
>
ıı' (&
CreateInvoiceByReference
ıı) A
(
ııA B
string
ııB H
	reference
ııI R
)
ııR S
{
ˆˆ 
var
˜˜ 
invoice
˜˜ 
=
˜˜ 
await
˜˜  
_invoiceRepository
˜˜ .
.
˜˜. /'
GetInvoiceByReceiptNumber
˜˜/ H
(
˜˜H I
	reference
˜˜I R
,
˜˜R S
_brandService
˜˜T a
.
˜˜a b
BrandId
˜˜b i
)
˜˜i j
;
˜˜j k
if
¯¯ 

(
¯¯ 
invoice
¯¯ 
is
¯¯ 
null
¯¯ 
)
¯¯ 
return
˘˘ 
null
˘˘ 
;
˘˘ 
var
˚˚ 
user
˚˚ 
=
˚˚ 
await
˚˚ $
_accountServiceAdapter
˚˚ /
.
˚˚/ 0
GetUserInfo
˚˚0 ;
(
˚˚; <
invoice
˚˚< C
.
˚˚C D
AffiliateId
˚˚D O
,
˚˚O P
_brandService
˚˚Q ^
.
˚˚^ _
BrandId
˚˚_ f
)
˚˚f g
;
˚˚g h
if
˝˝ 

(
˝˝ 
user
˝˝ 
is
˝˝ 
null
˝˝ 
)
˝˝ 
return
˛˛ 
null
˛˛ 
;
˛˛ 
byte
ÄÄ 
[
ÄÄ 
]
ÄÄ 
generatedInvoice
ÄÄ 
;
ÄÄ  
if
ÅÅ 

(
ÅÅ 
	Constants
ÅÅ 
.
ÅÅ 
	Ecosystem
ÅÅ 
==
ÅÅ  "
_brandService
ÅÅ# 0
.
ÅÅ0 1
BrandId
ÅÅ1 8
)
ÅÅ8 9
{
ÇÇ 	
generatedInvoice
ÉÉ 
=
ÉÉ 
await
ÉÉ $"
_ecosystemPdfService
ÉÉ% 9
.
ÉÉ9 :
RegenerateInvoice
ÉÉ: K
(
ÉÉK L
user
ÉÉL P
,
ÉÉP Q
invoice
ÉÉR Y
)
ÉÉY Z
;
ÉÉZ [
}
ÑÑ 	
else
ÖÖ 
if
ÖÖ 
(
ÖÖ 
	Constants
ÖÖ 
.
ÖÖ 
RecyCoin
ÖÖ #
==
ÖÖ$ &
_brandService
ÖÖ' 4
.
ÖÖ4 5
BrandId
ÖÖ5 <
)
ÖÖ< =
{
ÜÜ 	
generatedInvoice
áá 
=
áá 
await
áá $!
_recyCoinPdfService
áá% 8
.
áá8 9
RegenerateInvoice
áá9 J
(
ááJ K
user
ááK O
,
ááO P
invoice
ááQ X
)
ááX Y
;
ááY Z
}
àà 	
else
ââ 
{
ää 	
return
ãã 
null
ãã 
;
ãã 
}
åå 	
return
éé 
new
éé 
InvoiceResultDto
éé #
{
èè 	

PdfContent
êê 
=
êê 
generatedInvoice
êê )
,
êê) *
BrandId
ëë 
=
ëë 
_brandService
ëë #
.
ëë# $
BrandId
ëë$ +
}
íí 	
;
íí	 

}
ìì 
private
ïï 
async
ïï 
Task
ïï 
RemoveCacheKey
ïï %
(
ïï% &
int
ïï& )
affiliateId
ïï* 5
,
ïï5 6
string
ïï7 =
	stringKey
ïï> G
)
ïïG H
{
ññ 
var
óó 
key
óó 
=
óó 
string
óó 
.
óó 
Format
óó 
(
óó  
	stringKey
óó  )
,
óó) *
affiliateId
óó+ 6
)
óó6 7
;
óó7 8
var
òò 
	existsKey
òò 
=
òò 
await
òò 
_redisCache
òò )
.
òò) *
	KeyExists
òò* 3
(
òò3 4
key
òò4 7
)
òò7 8
;
òò8 9
if
öö 

(
öö 
	existsKey
öö 
)
öö 
await
õõ 
_redisCache
õõ 
.
õõ 
Delete
õõ $
(
õõ$ %
key
õõ% (
)
õõ( )
;
õõ) *
}
úú 
public
ûû 

async
ûû 
Task
ûû 
<
ûû  
InvoicesSpResponse
ûû (
?
ûû( )
>
ûû) *$
HandleDebitTransaction
ûû+ A
(
ûûA B%
DebitTransactionRequest
ûûB Y
request
ûûZ a
)
ûûa b
{
üü 
try
†† 
{
°° 	
var
¢¢ 
result
¢¢ 
=
¢¢ 
await
¢¢  
_invoiceRepository
¢¢ 1
.
¢¢1 2$
HandleDebitTransaction
¢¢2 H
(
¢¢H I
request
¢¢I P
)
¢¢P Q
;
¢¢Q R
if
§§ 
(
§§ 
result
§§ 
==
§§ 
null
§§ 
)
§§ 
{
•• 
_logger
¶¶ 
.
¶¶ 

LogWarning
¶¶ "
(
¶¶" #
$str
¶¶# q
,
¶¶q r
request
ßß 
.
ßß 
AffiliateId
ßß '
)
ßß' (
;
ßß( )
return
®® 
null
®® 
;
®® 
}
©© 
return
´´ 
result
´´ 
;
´´ 
}
¨¨ 	
catch
≠≠ 
(
≠≠ 
	Exception
≠≠ 
e
≠≠ 
)
≠≠ 
{
ÆÆ 	
_logger
ØØ 
.
ØØ 
LogError
ØØ 
(
ØØ 
e
ØØ 
,
ØØ 
$str
ØØ  l
,
ØØl m
request
∞∞ 
.
∞∞ 
AffiliateId
∞∞ #
)
∞∞# $
;
∞∞$ %
throw
±± 
;
±± 
}
≤≤ 	
}
≥≥ 
public
µµ 

async
µµ 
Task
µµ 
<
µµ 
MemoryStream
µµ "
>
µµ" #!
GenerateExcelReport
µµ$ 7
(
µµ7 8
DateTime
µµ8 @
?
µµ@ A
	startDate
µµB K
,
µµK L
DateTime
µµM U
?
µµU V
endDate
µµW ^
)
µµ^ _
{
∂∂ 
const
∑∑ 
int
∑∑ 
	batchSize
∑∑ 
=
∑∑ 
$num
∑∑  
;
∑∑  !
var
∏∏ 
stream
∏∏ 
=
∏∏ 
new
∏∏ 
MemoryStream
∏∏ %
(
∏∏% &
)
∏∏& '
;
∏∏' (
using
∫∫ 
var
∫∫ 
workbook
∫∫ 
=
∫∫ 
new
∫∫  

XLWorkbook
∫∫! +
(
∫∫+ ,
)
∫∫, -
;
∫∫- .
var
ªª 
	worksheet
ªª 
=
ªª 
workbook
ªª  
.
ªª  !

Worksheets
ªª! +
.
ªª+ ,
Add
ªª, /
(
ªª/ 0
$str
ªª0 9
)
ªª9 :
;
ªª: ;
int
ΩΩ 

currentRow
ΩΩ 
=
ΩΩ 
$num
ΩΩ 
;
ΩΩ 
ConfigureHeaders
ææ 
(
ææ 
	worksheet
ææ "
)
ææ" #
;
ææ# $
decimal
¿¿ 
totalSum
¿¿ 
=
¿¿ 
$num
¿¿ 
;
¿¿ 

currentRow
¡¡ 
=
¡¡ 
$num
¡¡ 
;
¡¡ 
await
√√ 
foreach
√√ 
(
√√ 
var
√√ 
invoiceBatch
√√ '
in
√√( * 
_invoiceRepository
√√+ =
.
√√= >"
GetInvoicesInBatches
√√> R
(
√√R S
	startDate
√√S \
,
√√\ ]
endDate
√√^ e
,
√√e f
	batchSize
√√g p
,
√√p q
_brandService
ƒƒ (
.
ƒƒ( )
BrandId
ƒƒ) 0
)
ƒƒ0 1
)
ƒƒ1 2
{
≈≈ 	
var
∆∆ 
	userTasks
∆∆ 
=
∆∆ 
invoiceBatch
∆∆ (
.
∆∆( )
Select
∆∆) /
(
∆∆/ 0
invoice
∆∆0 7
=>
∆∆8 :$
_accountServiceAdapter
«« &
.
««& '
GetUserInfo
««' 2
(
««2 3
invoice
««3 :
.
««: ;
AffiliateId
««; F
,
««F G
_brandService
««H U
.
««U V
BrandId
««V ]
)
««] ^
)
»» 
.
»» 
ToList
»» 
(
»» 
)
»» 
;
»» 
var
   
users
   
=
   
await
   
Task
   "
.
  " #
WhenAll
  # *
(
  * +
	userTasks
  + 4
)
  4 5
;
  5 6
for
ÃÃ 
(
ÃÃ 
int
ÃÃ 
i
ÃÃ 
=
ÃÃ 
$num
ÃÃ 
;
ÃÃ 
i
ÃÃ 
<
ÃÃ 
invoiceBatch
ÃÃ  ,
.
ÃÃ, -
Count
ÃÃ- 2
;
ÃÃ2 3
i
ÃÃ4 5
++
ÃÃ5 7
)
ÃÃ7 8
{
ÕÕ 
var
ŒŒ 
invoice
ŒŒ 
=
ŒŒ 
invoiceBatch
ŒŒ *
[
ŒŒ* +
i
ŒŒ+ ,
]
ŒŒ, -
;
ŒŒ- .
var
œœ 
user
œœ 
=
œœ 
users
œœ  
[
œœ  !
i
œœ! "
]
œœ" #
;
œœ# $
	worksheet
—— 
.
—— 
Cell
—— 
(
—— 

currentRow
—— )
,
——) *
$num
——+ ,
)
——, -
.
——- .
Value
——. 3
=
——4 5
user
——6 :
?
——: ;
.
——; <
UserName
——< D
??
——E G
$str
——H M
;
——M N
	worksheet
““ 
.
““ 
Cell
““ 
(
““ 

currentRow
““ )
,
““) *
$num
““+ ,
)
““, -
.
““- .
Value
““. 3
=
““4 5
$"
““6 8
{
““8 9
user
““9 =
?
““= >
.
““> ?
Name
““? C
??
““D F
$str
““G L
}
““L M
$str
““M N
{
““N O
user
““O S
?
““S T
.
““T U
LastName
““U ]
??
““^ `
$str
““a c
}
““c d
"
““d e
;
““e f
	worksheet
”” 
.
”” 
Cell
”” 
(
”” 

currentRow
”” )
,
””) *
$num
””+ ,
)
””, -
.
””- .
Value
””. 3
=
””4 5
invoice
””6 =
.
””= >
Id
””> @
;
””@ A
	worksheet
‘‘ 
.
‘‘ 
Cell
‘‘ 
(
‘‘ 

currentRow
‘‘ )
,
‘‘) *
$num
‘‘+ ,
)
‘‘, -
.
‘‘- .
Value
‘‘. 3
=
‘‘4 5
invoice
‘‘6 =
.
‘‘= >
Status
‘‘> D
?
‘‘E F
$str
‘‘G O
:
‘‘P Q
$str
‘‘R d
;
‘‘d e
	worksheet
’’ 
.
’’ 
Cell
’’ 
(
’’ 

currentRow
’’ )
,
’’) *
$num
’’+ ,
)
’’, -
.
’’- .
Value
’’. 3
=
’’4 5
invoice
’’6 =
.
’’= >
TotalInvoice
’’> J
;
’’J K
	worksheet
÷÷ 
.
÷÷ 
Cell
÷÷ 
(
÷÷ 

currentRow
÷÷ )
,
÷÷) *
$num
÷÷+ ,
)
÷÷, -
.
÷÷- .
Value
÷÷. 3
=
÷÷4 5
invoice
÷÷6 =
.
÷÷= >
PaymentMethod
÷÷> K
;
÷÷K L
	worksheet
◊◊ 
.
◊◊ 
Cell
◊◊ 
(
◊◊ 

currentRow
◊◊ )
,
◊◊) *
$num
◊◊+ ,
)
◊◊, -
.
◊◊- .
Value
◊◊. 3
=
◊◊4 5
invoice
◊◊6 =
.
◊◊= >
Bank
◊◊> B
;
◊◊B C
	worksheet
ÿÿ 
.
ÿÿ 
Cell
ÿÿ 
(
ÿÿ 

currentRow
ÿÿ )
,
ÿÿ) *
$num
ÿÿ+ ,
)
ÿÿ, -
.
ÿÿ- .
Value
ÿÿ. 3
=
ÿÿ4 5
invoice
ÿÿ6 =
.
ÿÿ= >
ReceiptNumber
ÿÿ> K
;
ÿÿK L
	worksheet
ŸŸ 
.
ŸŸ 
Cell
ŸŸ 
(
ŸŸ 

currentRow
ŸŸ )
,
ŸŸ) *
$num
ŸŸ+ ,
)
ŸŸ, -
.
ŸŸ- .
Value
ŸŸ. 3
=
ŸŸ4 5
invoice
ŸŸ6 =
.
ŸŸ= >
DepositDate
ŸŸ> I
.
ŸŸI J
ToString
ŸŸJ R
(
ŸŸR S
)
ŸŸS T
;
ŸŸT U
totalSum
€€ 
+=
€€ 
invoice
€€ #
.
€€# $
TotalInvoice
€€$ 0
??
€€1 3
$num
€€4 5
;
€€5 6

currentRow
‹‹ 
++
‹‹ 
;
‹‹ 
}
›› 
}
ﬁﬁ 	
	worksheet
‡‡ 
.
‡‡ 
Cell
‡‡ 
(
‡‡ 

currentRow
‡‡ !
+
‡‡" #
$num
‡‡$ %
,
‡‡% &
$num
‡‡' (
)
‡‡( )
.
‡‡) *
Value
‡‡* /
=
‡‡0 1
$str
‡‡2 :
;
‡‡: ;
	worksheet
·· 
.
·· 
Cell
·· 
(
·· 

currentRow
·· !
+
··" #
$num
··$ %
,
··% &
$num
··' (
)
··( )
.
··) *
Value
··* /
=
··0 1
totalSum
··2 :
;
··: ;
FormatWorksheet
„„ 
(
„„ 
	worksheet
„„ !
,
„„! "

currentRow
„„# -
)
„„- .
;
„„. /
workbook
ÂÂ 
.
ÂÂ 
SaveAs
ÂÂ 
(
ÂÂ 
stream
ÂÂ 
)
ÂÂ 
;
ÂÂ  
stream
ÊÊ 
.
ÊÊ 
Position
ÊÊ 
=
ÊÊ 
$num
ÊÊ 
;
ÊÊ 
return
ÁÁ 
stream
ÁÁ 
;
ÁÁ 
}
ËË 
private
ÍÍ 
void
ÍÍ 
ConfigureHeaders
ÍÍ !
(
ÍÍ! "
IXLWorksheet
ÍÍ" .
	worksheet
ÍÍ/ 8
)
ÍÍ8 9
{
ÎÎ 
var
ÏÏ 
headers
ÏÏ 
=
ÏÏ 
new
ÏÏ 
[
ÏÏ 
]
ÏÏ 
{
ÌÌ 	
$str
ÓÓ 
,
ÓÓ 
$str
ÔÔ 
,
ÔÔ  
$str
 
,
 
$str
ÒÒ 
,
ÒÒ 
$str
ÚÚ 
,
ÚÚ 
$str
ÛÛ 
,
ÛÛ 
$str
ÙÙ 
,
ÙÙ 
$str
ıı 
,
ıı 
$str
ˆˆ 
}
˜˜ 	
;
˜˜	 

for
˘˘ 
(
˘˘ 
int
˘˘ 
i
˘˘ 
=
˘˘ 
$num
˘˘ 
;
˘˘ 
i
˘˘ 
<
˘˘ 
headers
˘˘ #
.
˘˘# $
Length
˘˘$ *
;
˘˘* +
i
˘˘, -
++
˘˘- /
)
˘˘/ 0
{
˙˙ 	
var
˚˚ 
cell
˚˚ 
=
˚˚ 
	worksheet
˚˚  
.
˚˚  !
Cell
˚˚! %
(
˚˚% &
$num
˚˚& '
,
˚˚' (
i
˚˚) *
+
˚˚+ ,
$num
˚˚- .
)
˚˚. /
;
˚˚/ 0
cell
¸¸ 
.
¸¸ 
Value
¸¸ 
=
¸¸ 
headers
¸¸  
[
¸¸  !
i
¸¸! "
]
¸¸" #
;
¸¸# $
cell
˝˝ 
.
˝˝ 
Style
˝˝ 
.
˝˝ 
Font
˝˝ 
.
˝˝ 
Bold
˝˝  
=
˝˝! "
true
˝˝# '
;
˝˝' (
cell
˛˛ 
.
˛˛ 
Style
˛˛ 
.
˛˛ 
Fill
˛˛ 
.
˛˛ 
BackgroundColor
˛˛ +
=
˛˛, -
XLColor
˛˛. 5
.
˛˛5 6
	LightGray
˛˛6 ?
;
˛˛? @
}
ˇˇ 	
}
ÄÄ 
private
ÇÇ 
void
ÇÇ 
FormatWorksheet
ÇÇ  
(
ÇÇ  !
IXLWorksheet
ÇÇ! -
	worksheet
ÇÇ. 7
,
ÇÇ7 8
int
ÇÇ9 <
lastRow
ÇÇ= D
)
ÇÇD E
{
ÉÉ 
	worksheet
ÑÑ 
.
ÑÑ 
Column
ÑÑ 
(
ÑÑ 
$num
ÑÑ 
)
ÑÑ 
.
ÑÑ 
Width
ÑÑ !
=
ÑÑ" #
$num
ÑÑ$ &
;
ÑÑ& '
	worksheet
ÖÖ 
.
ÖÖ 
Column
ÖÖ 
(
ÖÖ 
$num
ÖÖ 
)
ÖÖ 
.
ÖÖ 
Width
ÖÖ !
=
ÖÖ" #
$num
ÖÖ$ &
;
ÖÖ& '
	worksheet
ÜÜ 
.
ÜÜ 
Column
ÜÜ 
(
ÜÜ 
$num
ÜÜ 
)
ÜÜ 
.
ÜÜ 
Width
ÜÜ !
=
ÜÜ" #
$num
ÜÜ$ &
;
ÜÜ& '
	worksheet
áá 
.
áá 
Column
áá 
(
áá 
$num
áá 
)
áá 
.
áá 
Width
áá !
=
áá" #
$num
áá$ &
;
áá& '
	worksheet
àà 
.
àà 
Column
àà 
(
àà 
$num
àà 
)
àà 
.
àà 
Width
àà !
=
àà" #
$num
àà$ &
;
àà& '
	worksheet
ââ 
.
ââ 
Column
ââ 
(
ââ 
$num
ââ 
)
ââ 
.
ââ 
Width
ââ !
=
ââ" #
$num
ââ$ &
;
ââ& '
	worksheet
ää 
.
ää 
Column
ää 
(
ää 
$num
ää 
)
ää 
.
ää 
Width
ää !
=
ää" #
$num
ää$ &
;
ää& '
	worksheet
ãã 
.
ãã 
Column
ãã 
(
ãã 
$num
ãã 
)
ãã 
.
ãã 
Width
ãã !
=
ãã" #
$num
ãã$ &
;
ãã& '
	worksheet
åå 
.
åå 
Column
åå 
(
åå 
$num
åå 
)
åå 
.
åå 
Width
åå !
=
åå" #
$num
åå$ &
;
åå& '
	worksheet
éé 
.
éé 
Column
éé 
(
éé 
$num
éé 
)
éé 
.
éé 
Style
éé !
.
éé! "
NumberFormat
éé" .
.
éé. /
Format
éé/ 5
=
éé6 7
$str
éé8 C
;
ééC D
	worksheet
èè 
.
èè 
Column
èè 
(
èè 
$num
èè 
)
èè 
.
èè 
Style
èè !
.
èè! "
NumberFormat
èè" .
.
èè. /
Format
èè/ 5
=
èè6 7
$str
èè8 D
;
èèD E
var
ëë 
table
ëë 
=
ëë 
	worksheet
ëë 
.
ëë 
Range
ëë #
(
ëë# $
$num
ëë$ %
,
ëë% &
$num
ëë' (
,
ëë( )
lastRow
ëë* 1
,
ëë1 2
$num
ëë3 4
)
ëë4 5
;
ëë5 6
table
íí 
.
íí 
Style
íí 
.
íí 
Border
íí 
.
íí 
OutsideBorder
íí (
=
íí) *!
XLBorderStyleValues
íí+ >
.
íí> ?
Thin
íí? C
;
ííC D
table
ìì 
.
ìì 
Style
ìì 
.
ìì 
Border
ìì 
.
ìì 
InsideBorder
ìì '
=
ìì( )!
XLBorderStyleValues
ìì* =
.
ìì= >
Thin
ìì> B
;
ììB C
var
ïï 
totalRow
ïï 
=
ïï 
	worksheet
ïï  
.
ïï  !
Range
ïï! &
(
ïï& '
lastRow
ïï' .
+
ïï/ 0
$num
ïï1 2
,
ïï2 3
$num
ïï4 5
,
ïï5 6
lastRow
ïï7 >
+
ïï? @
$num
ïïA B
,
ïïB C
$num
ïïD E
)
ïïE F
;
ïïF G
totalRow
ññ 
.
ññ 
Style
ññ 
.
ññ 
Font
ññ 
.
ññ 
Bold
ññ  
=
ññ! "
true
ññ# '
;
ññ' (
totalRow
óó 
.
óó 
Style
óó 
.
óó 
Fill
óó 
.
óó 
BackgroundColor
óó +
=
óó, -
XLColor
óó. 5
.
óó5 6
	LightGray
óó6 ?
;
óó? @
}
òò 
}ôô ¬
RC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IBrandService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface 
IBrandService 
{ 
long 
BrandId	 
{ 
get 
; 
} 
} Ç
WC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IBrevoEmailService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface 
IBrevoEmailService #
{ 
Task 
< 	
bool	 
> 
SendEmailWelcome 
(  
UserInfoResponse  0
user1 5
,5 6
InvoicesSpResponse7 I

spResponseJ T
,T U
longV Z
brandId[ b
)b c
;c d
Task		 
<		 	
bool			 
>		 !
SendBonusConfirmation		 $
(		$ %
UserInfoResponse		% 5
user		6 :
,		: ;
string		< B
userName		C K
,		K L
long		M Q
brandId		R Y
)		Y Z
;		Z [
Task 
< 	
bool	 
> $
SendEmailPurchaseConfirm '
(' (
UserInfoResponse( 8
user9 =
,= >

Dictionary? I
<I J
stringJ P
,P Q
byteR V
[V W
]W X
>X Y
pdfDataDictZ e
,e f
InvoicesSpResponse 

spResponse %
,% &
long' +
brandId, 3
)3 4
;4 5
Task 
< 	
bool	 
> 2
&SendEmailConfirmationEmailToThirdParty 5
(5 6
UserInfoResponse6 F
userG K
,K L
stringM S
nameOfPurchaserT c
,c d
List 
< 
string 
> 
productNames !
,! "
long# '
brandId( /
)/ 0
;0 1
Task 
< 	
bool	 
> &
SendEmailMembershipConfirm )
() *
UserInfoResponse* :
user; ?
,? @
byteA E
[E F
]F G
pdfDataH O
,O P
InvoicesSpResponseQ c

spResponsed n
,n o
longp t
brandIdu |
)| }
;} ~
Task 
< 	
bool	 
> .
"SendEmailPurchaseConfirmForAcademy 1
(1 2
UserInfoResponse2 B
userC G
,G H

DictionaryI S
<S T
stringT Z
,Z [
byte\ `
[` a
]a b
>b c
pdfDataDictd o
,o p
InvoicesSpResponse 

spResponse %
,% &
long' +
brandId, 3
)3 4
;4 5
Task 
< 	
bool	 
> ,
 SendInvitationsForTradingAcademy /
(/ 0!
UserAffiliateResponse0 E
userF J
,J K
stringL R
linkS W
,W X
stringY _
code` d
,d e
longf j
brandIdk r
)r s
;s t
} ¿
TC:\HeroSystem\walletService\WalletService.Core\Services\IServices\ICoinPayService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface 
ICoinPayService  
{		 
Task 
< 	%
CreateTransactionResponse	 "
?" #
># $
CreateTransaction% 6
(6 7$
CreateTransactionRequest7 O
requestP W
)W X
;X Y
Task 
< 	!
CreateChannelResponse	 
? 
>  
CreateChannel  -
(- .$
CreateTransactionRequest. F
requestG N
)N O
;O P
Task 
< 	
GetNetworkResponse	 
? 
> #
GetNetworksByIdCurrency 5
(5 6
int6 9

idCurrency: D
)D E
;E F
Task 
< 	!
CreateAddressResponse	 
? 
>  
CreateAddress! .
(. /
CreateAddresRequest/ B
requestC J
)J K
;K L
Task 
< 	&
GetTransactionByIdResponse	 #
?# $
>$ %
GetTransactionById& 8
(8 9
int9 <
idTransaction= J
)J K
;K L
Task 
< 	
bool	 
> '
ReceiveCoinPayNotifications *
(* +
string+ 1
requestBody2 =
)= >
;> ?
Task 
< 	
SendFundsDto	 
? 
> 
	SendFunds !
(! "
WithDrawalRequest" 3
[3 4
]4 5
request6 =
)= >
;> ?
Task 
< 	
bool	 
> %
GetTransactionByReference (
(( )
string) /
request0 7
)7 8
;8 9
} ù
WC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IConPaymentService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface 
IConPaymentService #
{		 
Task

 
<

 	'
GetPayByNameProfileResponse

	 $
>

$ %
GetPayByNameProfile

& 9
(

9 :
string

: @
pbntag

P V
)

V W
;

W X
Task 
< 	%
GetDepositAddressResponse	 "
?" #
># $
GetDepositAddress% 6
(6 7
string7 =
currencyP X
)X Y
;Y Z
Task 
< 	#
GetCoinBalancesResponse	  
>  !
GetCoinBalances" 1
(1 2
bool2 6
includeZeroBalancesP c
=d e
falsef k
)k l
;l m
Task 
< 	0
$CreateConPaymentsTransactionResponse	 -
?- .
>. /
CreatePayment0 =
(= >
ConPaymentRequest> O
requestP W
)W X
;X Y
Task 
< 	&
GetTransactionInfoResponse	 #
># $
GetTransactionInfo% 7
(7 8
string8 >
txidP T
,T U
boolV Z
full[ _
=` a
falseb g
)g h
;h i
Task 
< 	
string	 
> 
ProcessIpnAsync  
(  !

IpnRequest! +

ipnRequest, 6
,6 7
IHeaderDictionary8 I
headersJ Q
)Q R
;R S
Task 
< 	)
CoinPaymentWithdrawalResponse	 &
?& '
>' ( 
CreateMassWithdrawal) =
(= >
WalletsRequest> L
[L M
]M N
requestsO W
)W X
;X Y
} „
aC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IEcoPoolConfigurationService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface (
IEcoPoolConfigurationService -
{ 
Task 
< 	!
ModelConfigurationDto	 
? 
>  *
GetEcoPoolDefaultConfiguration! ?
(? @
)@ A
;A B
Task		 
<		 	!
ModelConfigurationDto			 
>		 .
"CreateOrUpdateEcoPoolConfiguration		  B
(		B C'
EcoPoolConfigurationRequest		C ^
request		_ f
)		f g
;		g h
Task

 
<

 	
int

	 
>

 !
GetProgressPercentage

 #
(

# $
int

$ '
configurationId

a p
)

p q
;

q r
} Ú
YC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IEcosystemPdfService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface  
IEcosystemPdfService %
{		 
Task

 
<

 	
byte

	 
[

 
]

 
>

 
GenerateInvoice

  
(

  !
UserInfoResponse

! 1
userInfo

2 :
,

: ;#
DebitTransactionRequest

< S
invoice

T [
,

[ \
InvoicesSpResponse

] o

spResponse

p z
)

z {
;

{ |
Task 
< 	
byte	 
[ 
] 
> 
RegenerateInvoice "
(" #
UserInfoResponse# 3
userInfo4 <
,< =
Invoice> E
invoiceF M
)M N
;N O
} ›
[C:\HeroSystem\walletService\WalletService.Core\Services\IServices\IExitoJuntosPdfService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface "
IExitoJuntosPdfService '
{ 
Task		 
<		 	
byte			 
[		 
]		 
>		 
GenerateInvoice		  
(		  !
UserInfoResponse		! 1
userInfo		2 :
,		: ;#
DebitTransactionRequest		< S
invoice		T [
,		[ \
InvoicesSpResponse		] o

spResponse		p z
)		z {
;		{ |
}

 Ú
YC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IHouseCoinPdfService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface  
IHouseCoinPdfService %
{		 
Task

 
<

 	
byte

	 
[

 
]

 
>

 
GenerateInvoice

  
(

  !
UserInfoResponse

! 1
userInfo

2 :
,

: ;#
DebitTransactionRequest

< S
invoice

T [
,

[ \
InvoicesSpResponse

] o

spResponse

p z
)

z {
;

{ |
Task 
< 	
byte	 
[ 
] 
> 
RegenerateInvoice "
(" #
UserInfoResponse# 3
userInfo4 <
,< =
Invoice> E
invoiceF M
)M N
;N O
} ≈
ZC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IInvoiceDetailService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface !
IInvoiceDetailService &
{ 
Task 
< 	
IEnumerable	 
< 
InvoiceDetailDto %
>% &
>& '$
GetAllInvoiceDetailAsync( @
(@ A
)A B
;B C
} ô
TC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IInvoiceService.cs
	namespace		 	
WalletService		
 
.		 
Core		 
.		 
Services		 %
.		% &
	IServices		& /
;		/ 0
public 
	interface 
IInvoiceService  
{ 
Task 
< 	
IEnumerable	 
< 

InvoiceDto 
>  
>  !"
GetAllInvoiceUserAsync" 8
(8 9
int9 <
id= ?
)? @
;@ A
Task 
< 	

InvoiceDto	 
> 
CreateInvoiceAsync '
(' (
InvoiceRequest( 6
request7 >
)> ?
;? @
Task 
< 	
PaginationDto	 
< 

InvoiceDto !
>! "
>" #
GetAllInvoices$ 2
(2 3
PaginationRequest3 D
requestE L
)L M
;M N
Task 
< 	
bool	 
> 1
%RevertUnconfirmedOrUnpaidTransactions 4
(4 5
)5 6
;6 7
Task 
< 	
IEnumerable	 
< $
InvoiceTradingAcademyDto -
?- .
>. /
>/ 04
(GetAllInvoicesForTradingAcademyPurchases1 Y
(Y Z
)Z [
;[ \
Task 
< 	
IEnumerable	 
< !
UserAffiliateResponse *
>* +
>+ ,-
!SendInvitationsForUpcomingCourses- N
(N O
stringO U
linkV Z
,Z [
string\ b
codec g
)g h
;h i
Task 
< 	
IEnumerable	 
< $
InvoiceModelOneAndTwoDto -
>- .
>. /(
GetAllInvoicesModelOneAndTwo0 L
(L M
)M N
;N O
Task 
< 	'
ModelBalancesAndInvoicesDto	 $
?$ %
>% &2
&ProcessAndReturnBalancesForModels1A1B2' M
(M N+
ModelBalancesAndInvoicesRequest '
request( /
)/ 0
;0 1
Task 
< 	
byte	 
[ 
] 
> 
CreateInvoice 
( 
int "
	invoiceId# ,
), -
;- .
Task 
< 	
InvoiceResultDto	 
? 
> $
CreateInvoiceByReference 4
(4 5
string5 ;
	reference< E
)E F
;F G
Task 
< 	
InvoicesSpResponse	 
? 
> "
HandleDebitTransaction 4
(4 5#
DebitTransactionRequest5 L
requestM T
)T U
;U V
Task 
< 	
MemoryStream	 
> 
GenerateExcelReport *
(* +
DateTime+ 3
?3 4
	startDate5 >
,> ?
DateTime@ H
?H I
endDateJ Q
)Q R
;R S
} ï
UC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IPagaditoService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface 
IPagaditoService !
{		 
Task

 
<

 	
string

	 
?

 
>

 
CreateTransaction

 #
(

# $,
 CreatePagaditoTransactionRequest

$ D
request

E L
)

L M
;

M N
Task 
< 	
bool	 
> 
VerifySignature 
( 
IHeaderDictionary 0
headers1 8
,8 9
string: @
requestBodyA L
)L M
;M N
Task 
< 	
bool	 
> #
UpdateTransactionStatus &
(& '
WebHookRequest' 5
?5 6
request7 >
)> ?
;? @
} í
_C:\HeroSystem\walletService\WalletService.Core\Services\IServices\IPaymentTransactionService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface &
IPaymentTransactionService +
{ 
Task 
< 	!
PaymentTransactionDto	 
? 
>  )
CreatePaymentTransactionAsync- J
(J K%
PaymentTransactionRequestK d
requeste l
)l m
;m n
Task		 
<		 	
IEnumerable			 
<		 !
PaymentTransactionDto		 *
>		* +
>		+ ,
GetAllWireTransfer		- ?
(		? @
)		@ A
;		A B
Task

 
<

 	
bool

	 
>

 
ConfirmPayment

- ;
(

; <,
 ConfirmPaymentTransactionRequest

< \
request

] d
)

d e
;

e f
} ∞
[C:\HeroSystem\walletService\WalletService.Core\Services\IServices\IProcessGradingService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface "
IProcessGradingService '
{ 
Task 
ExecuteFirstProcess	 
( 
) 
; 
Task  
ExecuteSecondProcess	 
( 
) 
;  
}		 
XC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IRecyCoinPdfService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface 
IRecyCoinPdfService $
{		 
Task

 
<

 	
byte

	 
[

 
]

 
>

 
GenerateInvoice

  
(

  !
UserInfoResponse

! 1
userInfo

2 :
,

: ;#
DebitTransactionRequest

< S
invoice

T [
,

[ \
InvoicesSpResponse

] o

spResponse

p z
)

z {
;

{ |
Task 
< 	
byte	 
[ 
] 
> 
RegenerateInvoice "
(" #
UserInfoResponse# 3
userInfo4 <
,< =
Invoice> E
invoiceF M
)M N
;N O
} Œ
^C:\HeroSystem\walletService\WalletService.Core\Services\IServices\IRedisCacheCleanupService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface %
IRedisCacheCleanupService *
{ 
Task 
CleanupAsync	 
( 
) 
; 
} …
[C:\HeroSystem\walletService\WalletService.Core\Services\IServices\IResultsEcoPoolService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface "
IResultsEcoPoolService '
{ 
Task 
< 	
IEnumerable	 
< 
ResultsEcoPoolDto &
>& '
>' (%
GetAllResultsEcoPoolAsync) B
(B C
)C D
;D E
} ±
[C:\HeroSystem\walletService\WalletService.Core\Services\IServices\IUserStatisticsService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface "
IUserStatisticsService '
{ 
Task 
< 	
UserStatistics	 
> "
GetUserStatisticsAsync /
(/ 0
int0 3
userId4 :
): ;
;; <
} Ò
ZC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IWalletHistoryService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface !
IWalletHistoryService &
{ 
Task 
< 	
IEnumerable	 
< 
WalletHistoryDto %
>% &
>& ''
GetAllWalletsHistoriesAsync( C
(C D
)D E
;E F
Task		 
<		 	
WalletHistoryDto			 
?		 
>		 '
GetWalletHistoriesByIdAsync		 7
(		7 8
int		8 ;
id		< >
)		> ?
;		? @
Task

 
<

 	
WalletHistoryDto

	 
?

 
>

 &
CreateWalletHistoriesAsync

 6
(

6 7 
WalletHistoryRequest

7 K
request

L S
)

S T
;

T U
Task 
< 	
WalletHistoryDto	 
? 
> &
UpdateWalletHistoriesAsync 6
(6 7
int7 :
id; =
,= > 
WalletHistoryRequest? S
requestT [
)[ \
;\ ]
Task 
< 	
WalletHistoryDto	 
? 
> &
DeleteWalletHistoriesAsync 6
(6 7
int7 :
id; =
)= >
;> ?
} •	
ZC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IWalletModel1AService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface !
IWalletModel1AService &
{ 
Task 
< 	(
BalanceInformationModel1ADto	 %
>% &.
"GetBalanceInformationByAffiliateId' I
(I J
intJ M
affiliateIdN Y
)Y Z
;Z [
Task		 
<		 	
bool			 
>		 
PayWithMyBalance		' 7
(		7 8
WalletRequest		8 E
request		N U
)		U V
;		V W
Task

 
<

 	
bool

	 
>

 #
PayWithMyServiceBalance

 &
(

& '
WalletRequest

' 4
request

5 <
)

< =
;

= >
Task 
< 	
bool	 
> %
CreateServiceBalanceAdmin (
(( ))
CreditTransactionAdminRequest) F
requestG N
)N O
;O P
} •	
ZC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IWalletModel1BService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface !
IWalletModel1BService &
{ 
Task 
< 	(
BalanceInformationModel1BDto	 %
>% &.
"GetBalanceInformationByAffiliateId' I
(I J
intJ M
affiliateIdN Y
)Y Z
;Z [
Task		 
<		 	
bool			 
>		 
PayWithMyBalance		' 7
(		7 8
WalletRequest		8 E
request		N U
)		U V
;		V W
Task

 
<

 	
bool

	 
>

 #
PayWithMyServiceBalance

 &
(

& '
WalletRequest

' 4
request

5 <
)

< =
;

= >
Task 
< 	
bool	 
> %
CreateServiceBalanceAdmin (
(( ))
CreditTransactionAdminRequest) F
requestG N
)N O
;O P
} õ

YC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IWalletPeriodService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface  
IWalletPeriodService %
{ 
Task		 
<		 	
IEnumerable			 
<		 
WalletPeriodDto		 $
>		$ %
>		% & 
GetAllWalletsPeriods		' ;
(		; <
)		< =
;		= >
Task

 
<

 	
WalletPeriodDto

	 
?

 
>

 
GetWalletPeriodById

 .
(

. /
int

/ 2
id

` b
)

b c
;

c d
Task 
< 	
IEnumerable	 
< 
WalletPeriodDto $
>$ %
>% &#
CreateWalletPeriodAsync' >
(> ?
IEnumerable? J
<J K
WalletPeriodRequestK ^
>^ _
request` g
)g h
;h i
Task 
< 	
WalletPeriodDto	 
? 
> #
DeleteWalletPeriodAsync 2
(2 3
int3 6
id7 9
)9 :
;: ;
} ›
ZC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IWalletRequestService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface !
IWalletRequestService &
{		 
Task

 
<

 	
IEnumerable

	 
<

 
WalletRequestDto

 %
>

% &
>

& '!
GetAllWalletsRequests

( =
(

= >
)

> ?
;

? @
Task 
< 	
IEnumerable	 
< 
WalletRequestDto %
>% &
?& '
>' ( 
GetWalletRequestById) =
(= >
int> A
idU W
)W X
;X Y
Task 
< 	
WalletRequestDto	 
? 
> $
CreateWalletRequestAsync 4
(4 5 
WalletRequestRequest5 I
requestU \
)\ ]
;] ^
Task %
CancelWalletRequestsAsync	 "
(" #
List# '
<' (
long( ,
>, -
idV X
)X Y
;Y Z
Task 
< 	
ServicesResponse	 
? 
> 
ProcessOption )
() *
int* -
optionU [
,[ \
List] a
<a b
longb f
>f g
idsh k
)k l
;l m
Task 
< 	
WalletRequestDto	 
? 
> %
CreateWalletRequestRevert 5
(5 6*
WalletRequestRevertTransaction6 T
requestU \
)\ ]
;] ^
Task 
< 	
IEnumerable	 
< 
WalletRequestDto %
>% &
?& '
>' (0
$GetAllWalletRequestRevertTransaction) M
(M N
)N O
;O P
Task 
< 	
bool	 
> &
AdministrativePaymentAsync )
() *
WalletsRequest* 8
[8 9
]9 :
requests; C
)C D
;D E
} Ç
bC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IWalletRetentionConfigService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface )
IWalletRetentionConfigService .
{ 
Task		 
<		 	
IEnumerable			 
<		 $
WalletRetentionConfigDto		 -
>		- .
>		. /(
GetAllWalletsRetentionConfig		0 L
(		L M
)		M N
;		N O
Task

 
<

 	$
WalletRetentionConfigDto

	 !
?

! "
>

" #(
GetWalletRetentionConfigById

$ @
(

@ A
int

A D
id

{ }
)

} ~
;

~ 
Task 
< 	
IEnumerable	 
< $
WalletRetentionConfigDto -
>- .
>. /,
 CreateWalletRetentionConfigAsync0 P
(P Q
IEnumerableQ \
<\ ](
WalletRetentionConfigRequest] y
>y z
request	{ Ç
)
Ç É
;
É Ñ
Task 
< 	$
WalletRetentionConfigDto	 !
?! "
>" #,
 DeleteWalletRetentionConfigAsync$ D
(D E
intE H
idI K
)K L
;L M
} Ÿ&
SC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IWalletService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface 
IWalletService 
{ 
Task 
< 	
IEnumerable	 
< 
	WalletDto 
? 
>  
>  !
GetWalletByUserId" 3
(3 4
int4 7
userId= C
)C D
;D E
Task 
< 	
IEnumerable	 
< 
	WalletDto 
? 
>  
>  !"
GetWalletByAffiliateId" 8
(8 9
int9 <
affiliateId= H
)H I
;I J
Task 
< 	
IEnumerable	 
< 
	WalletDto 
> 
>  
GetAllWallets! .
(. /
)/ 0
;0 1
Task 
< 	
IEnumerable	 
< 
	WalletDto 
> 
>  
GetWalletsRequest! 2
(2 3
int3 6
userId7 =
)= >
;> ?
Task 
< 	
	WalletDto	 
? 
> 
GetWalletById "
(" #
int# &
id' )
)) *
;* +
Task 
< 	
	WalletDto	 
? 
> 
DeleteWalletAsync &
(& '
int' *
idG I
)I J
;J K
Task 
< 	!
BalanceInformationDto	 
> .
"GetBalanceInformationByAffiliateId  B
(B C
intC F
affiliateIdG R
)R S
;S T
Task 
< 	&
BalanceInformationAdminDto	 #
># $&
GetBalanceInformationAdmin% ?
(? @
)@ A
;A B
Task 
< 	
bool	 
> *
TransferBalanceForNewAffiliate -
(- ."
TransferBalanceRequest. D
nameE I
)I J
;J K
Task 
< 	
ServicesResponse	 
> 
TransferBalance *
(* +
string+ 1
	encryptedE N
)N O
;O P
Task   
<   	
bool  	 
>   5
)HandleWalletRequestRevertTransactionAsync   8
(  8 9
int  9 <
option  E K
,  K L
int  M P
	invoiceId  Q Z
)  Z [
;  [ \
Task"" 
<"" 	
(""	 

List""
 
<""  
PurchasesPerMonthDto"" #
>""# $ 
CurrentYearPurchases""% 9
,""9 :
List""; ?
<""? @ 
PurchasesPerMonthDto""@ T
>""T U!
PreviousYearPurchases""V k
)""k l
?""l m
>""m n'
GetPurchasesMadeInMyNetwork## #
(### $
int##$ '
affiliateId##( 3
)##3 4
;##4 5
Task%% 
<%% 	
bool%%	 
>%% 
AdminPaymentHandler%% "
(%%" #
WalletRequest%%# 0
request%%1 8
)%%8 9
;%%9 :
Task&& 
<&& 	
IEnumerable&&	 
<&& 
AffiliateBalance&& %
>&&% &
>&&& '/
#GetAllAffiliatesWithPositiveBalance&&( K
(&&K L
)&&L M
;&&M N
Task'' 
<'' 	
bool''	 
>'' 
CreateBalanceAdmin'' !
(''! ")
CreditTransactionAdminRequest''" ?
request''@ G
)''G H
;''H I
Task(( 
<(( 	
bool((	 
>((  
CoursePaymentHandler(( #
(((# $
WalletRequest(($ 1
request((@ G
)((G H
;((H I
Task)) 
<)) 	
bool))	 
>)) 
PayWithMyBalance)) 
())  
WalletRequest))  -
request))@ G
)))G H
;))H I
Task** 
<** 	
bool**	 
>** "
PayWithMyBalanceModel2** %
(**% &
WalletRequest**& 3
request**@ G
)**G H
;**H I
Task++ 
<++ 	
bool++	 
>++ &
PayMembershipWithMyBalance++ )
(++) *
WalletRequest++* 7
request++@ G
)++G H
;++H I
Task,, 

RemoveKeys,,	 
(,, 
DeleteKeysRequest,, %
request,,. 5
),,5 6
;,,6 7
Task-- 
<-- 	
bool--	 
>-- %
PayWithMyBalanceForOthers-- (
(--( )
WalletRequest--) 6
request--7 >
)--> ?
;--? @
}00 ¥
WC:\HeroSystem\walletService\WalletService.Core\Services\IServices\IWalletWaitService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface 
IWalletWaitService #
{ 
Task 
< 	
IEnumerable	 
< 
WalletWaitDto "
>" #
># $
GetAllWalletsWaits% 7
(7 8
)8 9
;9 :
Task		 
<		 	
WalletWaitDto			 
?		 
>		 
GetWalletWaitById		 *
(		* +
int		+ .
id		/ 1
)		1 2
;		2 3
Task

 
<

 	
WalletWaitDto

	 
?

 
>

 !
CreateWalletWaitAsync

 .
(

. /
WalletWaitRequest

/ @
request

A H
)

H I
;

I J
Task 
< 	
WalletWaitDto	 
? 
> !
UpdateWalletWaitAsync .
(. /
int/ 2
id3 5
,5 6
WalletWaitRequest7 H
requestI P
)P Q
;Q R
Task 
< 	
WalletWaitDto	 
? 
> !
DeleteWalletWaitAsync .
(. /
int/ 2
id3 5
)5 6
;6 7
} à
]C:\HeroSystem\walletService\WalletService.Core\Services\IServices\IWalletWithDrawalService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
.% &
	IServices& /
;/ 0
public 
	interface $
IWalletWithdrawalService )
{ 
Task		 
<		 	
IEnumerable			 
<		 
WalletWithDrawalDto		 (
>		( )
>		) *$
GetAllWalletsWithdrawals		+ C
(		C D
)		D E
;		E F
Task

 
<

 	
WalletWithDrawalDto

	 
?

 
>

 #
GetWalletWithdrawalById

 6
(

6 7
int

7 :
id

; =
)

= >
;

> ?
Task 
< 	
WalletWithDrawalDto	 
? 
> '
CreateWalletWithdrawalAsync :
(: ;#
WalletWithDrawalRequest; R
requestS Z
)Z [
;[ \
Task 
< 	
WalletWithDrawalDto	 
? 
> '
UpdateWalletWithdrawalAsync :
(: ;
int; >
id? A
,A B#
WalletWithDrawalRequestC Z
request[ b
)b c
;c d
Task 
< 	
WalletWithDrawalDto	 
? 
> '
DeleteWalletWithdrawalAsync :
(: ;
int; >
id? A
)A B
;B C
} ∏¶
JC:\HeroSystem\walletService\WalletService.Core\Services\PagaditoService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class 
PagaditoService 
: 
BaseService *
,* +
IPagaditoService, <
{ 
private   
readonly   
IPagaditoAdapter   %
_pagaditoAdapter  & 6
;  6 7
private!! 
readonly!! $
ApplicationConfiguration!! -
_appSettings!!. :
;!!: ;
private"" 
readonly"" -
!ICoinPaymentTransactionRepository"" 6"
_transactionRepository""7 M
;""M N
private## 
readonly## $
IPagaditoPaymentStrategy## -$
_pagaditoPaymentStrategy##. F
;##F G
private$$ 
readonly$$ $
IInventoryServiceAdapter$$ -$
_inventoryServiceAdapter$$. F
;$$F G
private%% 
readonly%% 
ILogger%% 
<%% 
PagaditoService%% ,
>%%, -
_logger%%. 5
;%%5 6
private&& 
readonly&& "
IAccountServiceAdapter&& +"
_accountServiceAdapter&&, B
;&&B C
private'' 
readonly'' 
IInvoiceRepository'' '
_invoiceRepository''( :
;'': ;
private(( 
readonly(( 
IBrandService(( "
_brandService((# 0
;((0 1
public)) 

PagaditoService)) 
()) 
IOptions)) #
<))# $$
ApplicationConfiguration))$ <
>))< =
appSettings))> I
,))I J
IMapper))K R
mapper))S Y
,))Y Z
IPagaditoAdapter** 
pagaditoAdapter** (
,**( )-
!ICoinPaymentTransactionRepository*** K!
transactionRepository**L a
,**a b$
IPagaditoPaymentStrategy++  #
pagaditoPaymentStrategy++! 8
,++8 9$
IInventoryServiceAdapter,,  #
inventoryServiceAdapter,,! 8
,,,8 9
ILogger,,: A
<,,A B
PagaditoService,,B Q
>,,Q R
logger,,S Y
,,,Y Z"
IAccountServiceAdapter-- !
accountServiceAdapter-- 4
,--4 5
IInvoiceRepository--6 H
invoiceRepository--I Z
,--Z [
IBrandService--[ h
brandService--i u
)--u v
:--w x
base--y }
(--} ~
mapper	--~ Ñ
)
--Ñ Ö
{.. 
_pagaditoAdapter// 
=// 
pagaditoAdapter// *
;//* +
_appSettings00 
=00 
appSettings00 "
.00" #
Value00# (
;00( )"
_transactionRepository11 
=11  !
transactionRepository11! 6
;116 7$
_pagaditoPaymentStrategy22  
=22! "#
pagaditoPaymentStrategy22# :
;22: ;$
_inventoryServiceAdapter33  
=33! "#
inventoryServiceAdapter33# :
;33: ;
_logger44 
=44 
logger44 
;44 "
_accountServiceAdapter55 
=55  !
accountServiceAdapter55! 6
;556 7
_invoiceRepository66 
=66 
invoiceRepository66 .
;66. /
_brandService77 
=77 
brandService77 $
;77$ %
}88 
private:: 
async:: 
Task:: $
ExecuteMembershipPayment:: /
(::/ 0
WalletRequest::0 =
walletRequest::> K
,::K L
ICollection::M X
<::X Y
ProductRequest::Y g
>::g h
products::i q
)::q r
{;; 
walletRequest<< 
.<< 
ProductsList<< "
=<<# $
products<<% -
.<<- .
Select<<. 4
(<<4 5
product<<5 <
=><<= ?
new<<@ C
ProductsRequests<<D T
{== 	
	IdProduct>> 
=>> 
product>> 
.>>  
	ProductId>>  )
,>>) *
Count?? 
=?? 
product?? 
.?? 
Quantity?? $
}@@ 	
)@@	 

.@@
 
ToList@@ 
(@@ 
)@@ 
;@@ 
awaitBB $
_pagaditoPaymentStrategyBB &
.BB& '$
ExecuteMembershipPaymentBB' ?
(BB? @
walletRequestBB@ M
)BBM N
;BBN O
}CC 
privateEE 
asyncEE 
TaskEE !
ExecuteEcoPoolPaymentEE ,
(EE, -
WalletRequestEE- :
walletRequestEE; H
,EEH I
ICollectionEEJ U
<EEU V
ProductRequestEEV d
>EEd e
productsEEf n
)EEn o
{FF 
walletRequestGG 
.GG 
ProductsListGG "
=GG# $
productsGG% -
.GG- .
SelectGG. 4
(GG4 5
productGG5 <
=>GG= ?
newGG@ C
ProductsRequestsGGD T
{HH 	
	IdProductII 
=II 
productII 
.II  
	ProductIdII  )
,II) *
CountJJ 
=JJ 
productJJ 
.JJ 
QuantityJJ $
}KK 	
)KK	 

.KK
 
ToListKK 
(KK 
)KK 
;KK 
awaitMM $
_pagaditoPaymentStrategyMM &
.MM& '!
ExecuteEcoPoolPaymentMM' <
(MM< =
walletRequestMM= J
)MMJ K
;MMK L
}NN 
privatePP 
asyncPP 
TaskPP "
ExecuteRecyCoinPaymentPP -
(PP- .
WalletRequestPP. ;
walletRequestPP< I
,PPI J
ICollectionPPK V
<PPV W
ProductRequestPPW e
>PPe f
productsPPg o
)PPo p
{QQ 
walletRequestRR 
.RR 
ProductsListRR "
=RR# $
productsRR% -
.RR- .
SelectRR. 4
(RR4 5
productRR5 <
=>RR= ?
newRR@ C
ProductsRequestsRRD T
{SS 	
	IdProductTT 
=TT 
productTT 
.TT  
	ProductIdTT  )
,TT) *
CountUU 
=UU 
productUU 
.UU 
QuantityUU $
}VV 	
)VV	 

.VV
 
ToListVV 
(VV 
)VV 
;VV 
awaitXX $
_pagaditoPaymentStrategyXX &
.XX& '"
ExecuteRecyCoinPaymentXX' =
(XX= >
walletRequestXX> K
)XXK L
;XXL M
}YY 
privateZZ 
asyncZZ 
TaskZZ  
ExecuteCoursePaymentZZ +
(ZZ+ ,
WalletRequestZZ, 9
walletRequestZZ: G
,ZZG H
ICollectionZZI T
<ZZT U
ProductRequestZZU c
>ZZc d
productsZZe m
)ZZm n
{[[ 
walletRequest\\ 
.\\ 
ProductsList\\ "
=\\# $
products\\% -
.\\- .
Select\\. 4
(\\4 5
product\\5 <
=>\\= ?
new\\@ C
ProductsRequests\\D T
{]] 	
	IdProduct^^ 
=^^ 
product^^ 
.^^  
	ProductId^^  )
,^^) *
Count__ 
=__ 
product__ 
.__ 
Quantity__ $
}`` 	
)``	 

.``
 
ToList`` 
(`` 
)`` 
;`` 
awaitbb $
_pagaditoPaymentStrategybb &
.bb& ' 
ExecuteCoursePaymentbb' ;
(bb; <
walletRequestbb< I
)bbI J
;bbJ K
}cc 
privateee 
asyncee 
Taskee 
<ee 
ProductTypeee "
>ee" #
GetProductTypeee$ 2
(ee2 3
Listee3 7
<ee7 8
ProductRequestee8 F
>eeF G
requesteeH O
,eeO P
longeeQ U
brandIdeeV ]
)ee] ^
{ff 
ifgg 

(gg 
requestgg 
==gg 
nullgg 
||gg 
!gg  
requestgg  '
.gg' (
Anygg( +
(gg+ ,
)gg, -
)gg- .
{hh 	
throwii 
newii 
ArgumentExceptionii '
(ii' (
$strii( F
)iiF G
;iiG H
}jj 	
varll 

productIdsll 
=ll 
requestll  
.ll  !
Selectll! '
(ll' (
pll( )
=>ll* ,
pll- .
.ll. /
	ProductIdll/ 8
)ll8 9
.ll9 :
ToArrayll: A
(llA B
)llB C
;llC D
varmm 
responseListmm 
=mm 
awaitmm  $
_inventoryServiceAdaptermm! 9
.mm9 :
GetProductsIdsmm: H
(mmH I

productIdsmmI S
,mmS T
brandIdmmT [
)mm[ \
;mm\ ]
varoo 
resultoo 
=oo 
JsonSerializeroo #
.oo# $
Deserializeoo$ /
<oo/ 0
ProductsResponseoo0 @
>oo@ A
(ooA B
responseListooB N
.ooN O
ContentooO V
!ooV W
)ooW X
;ooX Y
intqq  
firstProductCategoryqq  
;qq  !
ifss 

(ss 
!ss 
resultss 
!ss 
.ss 
Datass 
.ss 
IsNullOrEmptyss '
(ss' (
)ss( )
)ss) *
{tt 	 
firstProductCategoryuu  
=uu! "
resultuu# )
.uu) *
Datauu* .
.uu. /
Firstuu/ 4
(uu4 5
)uu5 6
.uu6 7
PaymentGroupuu7 C
;uuC D
}vv 	
elseww 
{xx 	
varyy 
membershipResultyy  
=yy! "
awaityy# ($
_inventoryServiceAdapteryy) A
.yyA B
GetProductByIdyyB P
(yyP Q

productIdsyyQ [
.yy[ \
Firstyy\ a
(yya b
)yyb c
,yyc d
_brandServiceyyd q
.yyq r
BrandIdyyr y
)yyy z
;yyz {
varzz 
productResultzz 
=zz 
JsonSerializerzz  .
.zz. /
Deserializezz/ :
<zz: ;
ProductResponsezz; J
>zzJ K
(zzK L
membershipResultzzL \
.zz\ ]
Contentzz] d
!zzd e
)zze f
;zzf g 
firstProductCategory{{  
={{! "
productResult{{# 0
!{{0 1
.{{1 2
Data{{2 6
.{{6 7
PaymentGroup{{7 C
;{{C D
}|| 	
switch~~ 
(~~  
firstProductCategory~~ $
)~~$ %
{ 	
case
ÄÄ 
$num
ÄÄ 
:
ÄÄ 
return
ÄÄ 
ProductType
ÄÄ &
.
ÄÄ& '

Membership
ÄÄ' 1
;
ÄÄ1 2
case
ÅÅ 
$num
ÅÅ 
:
ÅÅ 
case
ÇÇ 
$num
ÇÇ 
:
ÇÇ 
case
ÉÉ 
$num
ÉÉ 
:
ÉÉ 
return
ÑÑ 
ProductType
ÑÑ "
.
ÑÑ" #
EcoPool
ÑÑ# *
;
ÑÑ* +
case
ÖÖ 
$num
ÖÖ 
:
ÖÖ 
return
ÖÖ 
ProductType
ÖÖ '
.
ÖÖ' (
RecyCoin
ÖÖ( 0
;
ÖÖ0 1
default
ÜÜ 
:
ÜÜ 
return
áá 
ProductType
áá "
.
áá" #
Course
áá# )
;
áá) *
}
àà 	
}
ââ 
private
ãã 
async
ãã 
Task
ãã '
ProcessPaymentTransaction
ãã 0
(
ãã0 1$
CoinpaymentTransaction
ãã1 G
transactionResult
ããH Y
)
ããY Z
{
åå 
_logger
çç 
.
çç 
LogInformation
çç 
(
çç 
$"
éé 
$str
éé Q
{
ééQ R
transactionResult
ééR c
.
ééc d
ToJsonString
ééd p
(
éép q
)
ééq r
}
éér s
"
éés t
)
éét u
;
ééu v
var
êê 
userInfo
êê 
=
êê 
await
êê $
_accountServiceAdapter
êê 3
.
êê3 4
GetUserInfo
êê4 ?
(
êê? @
transactionResult
êê@ Q
.
êêQ R
AffiliateId
êêR ]
,
êê] ^
transactionResult
êê^ o
.
êêo p
BrandId
êêp w
)
êêw x
;
êêx y
if
íí 

(
íí 
userInfo
íí 
==
íí 
null
íí 
||
íí 
userInfo
íí  (
.
íí( )
UserName
íí) 1
==
íí2 4
null
íí5 9
)
íí9 :
return
ìì 
;
ìì 
var
ïï 
productsList
ïï 
=
ïï 
new
ïï 
List
ïï #
<
ïï# $
ProductsRequests
ïï$ 4
>
ïï4 5
(
ïï5 6
)
ïï6 7
;
ïï7 8
if
óó 

(
óó 
!
óó 
string
óó 
.
óó 
IsNullOrEmpty
óó !
(
óó! "
transactionResult
óó" 3
.
óó3 4
Products
óó4 <
)
óó< =
)
óó= >
{
òò 	
var
ôô 
productRequests
ôô 
=
ôô  !
JsonSerializer
ôô" 0
.
ôô0 1
Deserialize
ôô1 <
<
ôô< =
List
ôô= A
<
ôôA B
ProductRequest
ôôB P
>
ôôP Q
>
ôôQ R
(
ôôR S
transactionResult
ôôS d
.
ôôd e
Products
ôôe m
)
ôôm n
;
ôôn o
if
öö 
(
öö 
productRequests
öö 
!=
öö  "
null
öö# '
)
öö' (
{
õõ 
productsList
úú 
=
úú 
productRequests
úú .
.
ùù 
Select
ùù 
(
ùù 
p
ùù 
=>
ùù  
new
ùù! $
ProductsRequests
ùù% 5
{
ùù6 7
	IdProduct
ùù8 A
=
ùùB C
p
ùùD E
.
ùùE F
	ProductId
ùùF O
,
ùùO P
Count
ùùQ V
=
ùùW X
p
ùùY Z
.
ùùZ [
Quantity
ùù[ c
}
ùùd e
)
ùùe f
.
ûû 
ToList
ûû 
(
ûû 
)
ûû 
;
ûû 
}
üü 
}
†† 	
var
¢¢ 
walletRequest
¢¢ 
=
¢¢ 
new
¢¢ 
WalletRequest
¢¢  -
{
££ 	
AffiliateId
§§ 
=
§§ 
transactionResult
§§ +
.
§§+ ,
AffiliateId
§§, 7
,
§§7 8
AffiliateUserName
•• 
=
•• 
userInfo
••  (
.
••( )
UserName
••) 1
,
••1 2
PurchaseFor
¶¶ 
=
¶¶ 
	Constants
¶¶ #
.
¶¶# $

EmptyValue
¶¶$ .
,
¶¶. /
Bank
ßß 
=
ßß 
transactionResult
ßß $
.
ßß$ %
	Reference
ßß% .
,
ßß. /
PaymentMethod
®® 
=
®® 
$num
®® 
,
®® 
ReceiptNumber
©© 
=
©© 
transactionResult
©© -
.
©©- .
IdTransaction
©©. ;
,
©©; <
ProductsList
™™ 
=
™™ 
productsList
™™ '
,
™™' (
BrandId
´´ 
=
´´ 
transactionResult
´´ '
.
´´' (
BrandId
´´( /
}
¨¨ 	
;
¨¨	 

var
ÆÆ 
products
ÆÆ 
=
ÆÆ 
JsonSerializer
ÆÆ %
.
ÆÆ% &
Deserialize
ÆÆ& 1
<
ÆÆ1 2
List
ÆÆ2 6
<
ÆÆ6 7
ProductRequest
ÆÆ7 E
>
ÆÆE F
>
ÆÆF G
(
ÆÆG H
transactionResult
ÆÆH Y
.
ÆÆY Z
Products
ÆÆZ b
)
ÆÆb c
;
ÆÆc d
if
ØØ 

(
ØØ 
products
ØØ 
==
ØØ 
null
ØØ 
)
ØØ 
return
∞∞ 
;
∞∞ 
_logger
≤≤ 
.
≤≤ 
LogInformation
≤≤ 
(
≤≤ 
$"
≤≤ !
$str
≤≤! [
{
≤≤[ \
products
≤≤\ d
.
≤≤d e
ToJsonString
≤≤e q
(
≤≤q r
)
≤≤r s
}
≤≤s t
"
≤≤t u
)
≤≤u v
;
≤≤v w
var
¥¥ 
isExists
¥¥ 
=
¥¥ 
await
¥¥  
_invoiceRepository
¥¥ /
.
¥¥/ 0*
InvoiceExistsByReceiptNumber
¥¥0 L
(
¥¥L M
transactionResult
¥¥M ^
.
¥¥^ _
IdTransaction
¥¥_ l
,
¥¥l m
_brandService
¥¥m z
.
¥¥z {
BrandId¥¥{ Ç
)¥¥Ç É
;¥¥É Ñ
if
µµ 

(
µµ 
isExists
µµ 
)
µµ 
return
∂∂ 
;
∂∂ 
var
∏∏ 
productType
∏∏ 
=
∏∏ 
await
∏∏ 
GetProductType
∏∏  .
(
∏∏. /
products
∏∏/ 7
,
∏∏7 8
transactionResult
∏∏8 I
.
∏∏I J
BrandId
∏∏J Q
)
∏∏Q R
;
∏∏R S
switch
∫∫ 
(
∫∫ 
productType
∫∫ 
)
∫∫ 
{
ªª 	
case
ºº 
ProductType
ºº 
.
ºº 

Membership
ºº '
:
ºº' (
await
ΩΩ &
ExecuteMembershipPayment
ΩΩ .
(
ΩΩ. /
walletRequest
ΩΩ/ <
,
ΩΩ< =
products
ΩΩ> F
)
ΩΩF G
;
ΩΩG H
_logger
ææ 
.
ææ 
LogInformation
ææ &
(
ææ& '
$"
ææ' )
$str
ææ) t
"
ææt u
)
ææu v
;
ææv w
break
øø 
;
øø 
case
¿¿ 
ProductType
¿¿ 
.
¿¿ 
EcoPool
¿¿ $
:
¿¿$ %
await
¡¡ #
ExecuteEcoPoolPayment
¡¡ +
(
¡¡+ ,
walletRequest
¡¡, 9
,
¡¡9 :
products
¡¡; C
)
¡¡C D
;
¡¡D E
_logger
¬¬ 
.
¬¬ 
LogInformation
¬¬ &
(
¬¬& '
$"
¬¬' )
$str
¬¬) q
"
¬¬q r
)
¬¬r s
;
¬¬s t
break
√√ 
;
√√ 
case
ƒƒ 
ProductType
ƒƒ 
.
ƒƒ 
RecyCoin
ƒƒ %
:
ƒƒ% &
await
≈≈ $
ExecuteRecyCoinPayment
≈≈ ,
(
≈≈, -
walletRequest
≈≈- :
,
≈≈: ;
products
≈≈< D
)
≈≈D E
;
≈≈E F
_logger
∆∆ 
.
∆∆ 
LogInformation
∆∆ &
(
∆∆& '
$"
∆∆' )
$str
∆∆) q
"
∆∆q r
)
∆∆r s
;
∆∆s t
break
«« 
;
«« 
case
»» 
ProductType
»» 
.
»» 
Course
»» #
:
»»# $
await
…… "
ExecuteCoursePayment
…… *
(
……* +
walletRequest
……+ 8
,
……8 9
products
……: B
)
……B C
;
……C D
_logger
   
.
   
LogInformation
   &
(
  & '
$"
  ' )
$str
  ) p
"
  p q
)
  q r
;
  r s
break
ÀÀ 
;
ÀÀ 
}
ÃÃ 	
}
ÕÕ 
public
œœ 

async
œœ 
Task
œœ 
<
œœ 
string
œœ 
?
œœ 
>
œœ 
CreateTransaction
œœ 0
(
œœ0 1.
 CreatePagaditoTransactionRequest
œœ1 Q
request
œœR Y
)
œœY Z
{
–– 
_logger
—— 
.
—— 
LogInformation
—— 
(
—— 
$"
—— !
$str
——! R
{
——R S
request
——S Z
.
——Z [
ToJsonString
——[ g
(
——g h
)
——h i
}
——i j
"
——j k
)
——k l
;
——l m
var
““ 
today
““ 
=
““ 
DateTime
““ 
.
““ 
Now
““  
;
““  !
var
”” 
connectResponse
”” 
=
”” 
await
”” #
_pagaditoAdapter
””$ 4
.
””4 5
ConnectAsync
””5 A
(
””A B
)
””B C
;
””C D
if
’’ 

(
’’ 
connectResponse
’’ 
==
’’ 
null
’’ #
||
’’$ &
string
’’' -
.
’’- .
IsNullOrEmpty
’’. ;
(
’’; <
connectResponse
’’< K
.
’’K L
Value
’’L Q
)
’’Q R
)
’’R S
return
÷÷ 
$str
÷÷ .
;
÷÷. /
var
ÿÿ !
pagaditoTransaction
ÿÿ 
=
ÿÿ  !
Mapper
ÿÿ" (
.
ÿÿ( )
Map
ÿÿ) ,
<
ÿÿ, -'
CreatePagaditoTransaction
ÿÿ- F
>
ÿÿF G
(
ÿÿG H
request
ÿÿH O
)
ÿÿO P
;
ÿÿP Q!
pagaditoTransaction
ŸŸ 
.
ŸŸ 
Token
ŸŸ !
=
ŸŸ" #
connectResponse
ŸŸ$ 3
.
ŸŸ3 4
Value
ŸŸ4 9
;
ŸŸ9 :!
pagaditoTransaction
⁄⁄ 
.
⁄⁄ 
Ern
⁄⁄ 
=
⁄⁄  !
Guid
⁄⁄" &
.
⁄⁄& '
NewGuid
⁄⁄' .
(
⁄⁄. /
)
⁄⁄/ 0
.
⁄⁄0 1
ToString
⁄⁄1 9
(
⁄⁄9 :
)
⁄⁄: ;
;
⁄⁄; <
var
‹‹  
executeTransaction
‹‹ 
=
‹‹  
await
‹‹! &
_pagaditoAdapter
‹‹' 7
.
‹‹7 8 
ExecuteTransaction
‹‹8 J
(
‹‹J K!
pagaditoTransaction
‹‹K ^
)
‹‹^ _
;
‹‹_ `
_logger
ﬁﬁ 
.
ﬁﬁ 
LogInformation
ﬁﬁ 
(
ﬁﬁ 
$"
ﬂﬂ 
$str
ﬂﬂ J
{
ﬂﬂJ K 
executeTransaction
ﬂﬂK ]
?
ﬂﬂ] ^
.
ﬂﬂ^ _
ToJsonString
ﬂﬂ_ k
(
ﬂﬂk l
)
ﬂﬂl m
}
ﬂﬂm n
"
ﬂﬂn o
)
ﬂﬂo p
;
ﬂﬂp q
if
·· 

(
·· 
string
·· 
.
·· 
IsNullOrEmpty
··  
(
··  ! 
executeTransaction
··! 3
?
··3 4
.
··4 5
Value
··5 :
)
··: ;
)
··; <
return
‚‚ 
$str
‚‚ 2
;
‚‚2 3
var
‰‰ 
productDetails
‰‰ 
=
‰‰ 
request
‰‰ $
.
‰‰$ %
Details
‰‰% ,
.
‰‰, -
Select
‰‰- 3
(
‰‰3 4
detail
‰‰4 :
=>
‰‰; =
new
‰‰> A
ProductRequest
‰‰B P
{
ÂÂ 	
	ProductId
ÊÊ 
=
ÊÊ 
int
ÊÊ 
.
ÊÊ 
Parse
ÊÊ !
(
ÊÊ! "
detail
ÊÊ" (
.
ÊÊ( )

UrlProduct
ÊÊ) 3
!
ÊÊ3 4
)
ÊÊ4 5
,
ÊÊ5 6
Quantity
ÁÁ 
=
ÁÁ 
detail
ÁÁ 
.
ÁÁ 
Quantity
ÁÁ &
,
ÁÁ& '
}
ËË 	
)
ËË	 

.
ËË
 
ToList
ËË 
(
ËË 
)
ËË 
;
ËË 
var
ÍÍ 
productsJson
ÍÍ 
=
ÍÍ 
JsonSerializer
ÍÍ )
.
ÍÍ) *
	Serialize
ÍÍ* 3
(
ÍÍ3 4
productDetails
ÍÍ4 B
)
ÍÍB C
;
ÍÍC D
var
ÏÏ  
paymentTransaction
ÏÏ 
=
ÏÏ  
new
ÏÏ! $$
CoinpaymentTransaction
ÏÏ% ;
{
ÌÌ 	
IdTransaction
ÓÓ 
=
ÓÓ !
pagaditoTransaction
ÓÓ /
.
ÓÓ/ 0
Ern
ÓÓ0 3
,
ÓÓ3 4
AffiliateId
ÔÔ 
=
ÔÔ 
request
ÔÔ !
.
ÔÔ! "
AffiliateId
ÔÔ" -
,
ÔÔ- .
Amount
 
=
 !
pagaditoTransaction
 (
.
( )
Amount
) /
,
/ 0
AmountReceived
ÒÒ 
=
ÒÒ 
	Constants
ÒÒ &
.
ÒÒ& '

EmptyValue
ÒÒ' 1
,
ÒÒ1 2
Products
ÚÚ 
=
ÚÚ 
productsJson
ÚÚ #
,
ÚÚ# $
PaymentMethod
ÛÛ 
=
ÛÛ 
	Constants
ÛÛ %
.
ÛÛ% &
Pagadito
ÛÛ& .
,
ÛÛ. /
Status
ÙÙ 
=
ÙÙ 
	Constants
ÙÙ 
.
ÙÙ 

EmptyValue
ÙÙ )
,
ÙÙ) *
	Acredited
ıı 
=
ıı 
false
ıı 
,
ıı 
	CreatedAt
ˆˆ 
=
ˆˆ 
today
ˆˆ 
,
ˆˆ 
	UpdatedAt
˜˜ 
=
˜˜ 
today
˜˜ 
,
˜˜ 
BrandId
¯¯ 
=
¯¯ 
_brandService
¯¯ %
.
¯¯% &
BrandId
¯¯& -
}
˘˘ 	
;
˘˘	 

await
˚˚ $
_transactionRepository
˚˚ $
.
˚˚$ %*
CreateCoinPaymentTransaction
˚˚% A
(
˚˚A B 
paymentTransaction
˚˚B T
)
˚˚T U
;
˚˚U V
return
˝˝  
executeTransaction
˝˝ !
.
˝˝! "
Value
˝˝" '
;
˝˝' (
}
˛˛ 
public
ÄÄ 

async
ÄÄ 
Task
ÄÄ 
<
ÄÄ 
bool
ÄÄ 
>
ÄÄ 
VerifySignature
ÄÄ +
(
ÄÄ+ ,
IHeaderDictionary
ÄÄ, =
headers
ÄÄ> E
,
ÄÄE F
string
ÄÄG M
requestBody
ÄÄN Y
)
ÄÄY Z
{
ÅÅ 
_logger
ÇÇ 
.
ÇÇ 
LogInformation
ÇÇ 
(
ÇÇ 
$"
ÇÇ !
$str
ÇÇ! h
{
ÇÇh i
requestBody
ÇÇi t
.
ÇÇt u
ToJsonStringÇÇu Å
(ÇÇÅ Ç
)ÇÇÇ É
}ÇÇÉ Ñ
"ÇÇÑ Ö
)ÇÇÖ Ü
;ÇÇÜ á
var
ÑÑ 
notificationId
ÑÑ 
=
ÑÑ 
headers
ÑÑ $
[
ÑÑ$ %
$str
ÑÑ% ?
]
ÑÑ? @
;
ÑÑ@ A
var
ÖÖ #
notificationTimestamp
ÖÖ !
=
ÖÖ" #
headers
ÖÖ$ +
[
ÖÖ+ ,
$str
ÖÖ, M
]
ÖÖM N
;
ÖÖN O
var
ÜÜ 
certUrl
ÜÜ 
=
ÜÜ 
headers
ÜÜ 
[
ÜÜ 
$str
ÜÜ 1
]
ÜÜ1 2
;
ÜÜ2 3
var
áá #
notificationSignature
áá !
=
áá" #
headers
áá$ +
[
áá+ ,
$str
áá, @
]
áá@ A
;
ááA B
var
àà 
wsk
àà 
=
àà 
_appSettings
àà 
.
àà 
Pagadito
àà '
!
àà' (
.
àà( )
Wsk
àà) ,
;
àà, -
_logger
ää 
.
ää 
LogInformation
ää 
(
ää 
$"
ää !
$str
ää! 1
{
ää1 2
notificationId
ää2 @
}
ää@ A
$str
ääA N
{
ääN O#
notificationTimestamp
ääO d
}
ääd e
$str
ääe p
{
ääp q
certUrl
ääq x
}
ääx y
"
ääy z
)
ääz {
;
ää{ |
var
åå 

jsonObject
åå 
=
åå 
JObject
åå  
.
åå  !
Parse
åå! &
(
åå& '
requestBody
åå' 2
)
åå2 3
;
åå3 4
var
çç 
eventId
çç 
=
çç 

jsonObject
çç  
[
çç  !
$str
çç! %
]
çç% &
?
çç& '
.
çç' (
ToString
çç( 0
(
çç0 1
)
çç1 2
;
çç2 3
_logger
èè 
.
èè 
LogInformation
èè 
(
èè 
$"
èè !
$str
èè! *
{
èè* +
eventId
èè+ 2
}
èè2 3
"
èè3 4
)
èè4 5
;
èè5 6
var
ëë 
crc32
ëë 
=
ëë 
CommonExtensions
ëë $
.
ëë$ %
Crc32
ëë% *
(
ëë* +
requestBody
ëë+ 6
)
ëë6 7
;
ëë7 8
var
íí 

dataSigned
íí 
=
íí 
string
íí 
.
íí  
Join
íí  $
(
íí$ %
$str
íí% (
,
íí( )
notificationId
íí* 8
,
íí8 9#
notificationTimestamp
íí: O
,
ííO P
eventId
ííQ X
,
ííX Y
crc32
ííZ _
,
íí_ `
wsk
íía d
)
ííd e
;
ííe f
_logger
îî 
.
îî 
LogInformation
îî 
(
îî 
$"
îî !
$str
îî! -
{
îî- .

dataSigned
îî. 8
}
îî8 9
"
îî9 :
)
îî: ;
;
îî; <
try
ññ 
{
óó 	
byte
òò 
[
òò 
]
òò 
certContent
òò 
;
òò 
using
ôô 
(
ôô 
var
ôô 

httpClient
ôô !
=
ôô" #
new
ôô$ '

HttpClient
ôô( 2
(
ôô2 3
)
ôô3 4
)
ôô4 5
{
öö 
certContent
õõ 
=
õõ 
await
õõ #

httpClient
õõ$ .
.
õõ. /
GetByteArrayAsync
õõ/ @
(
õõ@ A
certUrl
õõA H
)
õõH I
;
õõI J
}
úú 
using
ûû 
var
ûû 
cert
ûû 
=
ûû 
new
ûû  
X509Certificate2
ûû! 1
(
ûû1 2
certContent
ûû2 =
)
ûû= >
;
ûû> ?
_logger
üü 
.
üü 
LogInformation
üü "
(
üü" #
$"
üü# %
$str
üü% =
{
üü= >
cert
üü> B
.
üüB C

Thumbprint
üüC M
}
üüM N
"
üüN O
)
üüO P
;
üüP Q
using
°° 
var
°° 
pubkey
°° 
=
°° 
cert
°° #
.
°°# $
GetRSAPublicKey
°°$ 3
(
°°3 4
)
°°4 5
;
°°5 6
var
££ 
signatureBytes
££ 
=
££  
Convert
££! (
.
££( )
FromBase64String
££) 9
(
££9 :#
notificationSignature
££: O
)
££O P
;
££P Q
var
§§ 
signatureResult
§§ 
=
§§  !
pubkey
§§" (
!
§§( )
.
§§) *

VerifyData
§§* 4
(
§§4 5
Encoding
•• 
.
•• 
UTF8
•• 
.
•• 
GetBytes
•• &
(
••& '

dataSigned
••' 1
)
••1 2
,
••2 3
signatureBytes
¶¶ 
,
¶¶ 
HashAlgorithmName
ßß !
.
ßß! "
SHA256
ßß" (
,
ßß( )!
RSASignaturePadding
®® #
.
®®# $
Pkcs1
®®$ )
)
®®) *
;
®®* +
_logger
™™ 
.
™™ 
LogInformation
™™ "
(
™™" #
$"
™™# %
$str
™™% D
{
™™D E
signatureResult
™™E T
}
™™T U
"
™™U V
)
™™V W
;
™™W X
var
¨¨ 
request
¨¨ 
=
¨¨ 
JsonConvert
¨¨ %
.
¨¨% &
DeserializeObject
¨¨& 7
<
¨¨7 8
WebHookRequest
¨¨8 F
>
¨¨F G
(
¨¨G H
requestBody
¨¨H S
)
¨¨S T
;
¨¨T U
return
ÆÆ 
await
ÆÆ %
UpdateTransactionStatus
ÆÆ 2
(
ÆÆ2 3
request
ÆÆ3 :
)
ÆÆ: ;
;
ÆÆ; <
}
ØØ 	
catch
∞∞ 
(
∞∞ 
	Exception
∞∞ 
ex
∞∞ 
)
∞∞ 
{
±± 	
_logger
≤≤ 
.
≤≤ 
LogError
≤≤ 
(
≤≤ 
$"
≤≤ 
$str
≤≤ D
{
≤≤D E
ex
≤≤E G
.
≤≤G H
Message
≤≤H O
}
≤≤O P
"
≤≤P Q
)
≤≤Q R
;
≤≤R S
return
≥≥ 
false
≥≥ 
;
≥≥ 
}
¥¥ 	
}
µµ 
public
∑∑ 

async
∑∑ 
Task
∑∑ 
<
∑∑ 
bool
∑∑ 
>
∑∑ %
UpdateTransactionStatus
∑∑ 3
(
∑∑3 4
WebHookRequest
∑∑4 B
?
∑∑B C
purchaseRequest
∑∑D S
)
∑∑S T
{
∏∏ 
_logger
ππ 
.
ππ 
LogInformation
ππ 
(
ππ 
$"
ππ !
$str
ππ! q
"
ππq r
)
ππr s
;
ππs t
if
ªª 

(
ªª 
purchaseRequest
ªª 
is
ªª 
null
ªª #
)
ªª# $
{
ºº 	
_logger
ΩΩ 
.
ΩΩ 

LogWarning
ΩΩ 
(
ΩΩ 
$"
ΩΩ !
$str
ΩΩ! f
"
ΩΩf g
)
ΩΩg h
;
ΩΩh i
return
ææ 
false
ææ 
;
ææ 
}
øø 	
long
¡¡ 
brandId
¡¡ 
=
¡¡ 
(
¡¡ 
long
¡¡ 
)
¡¡ 
_brandService
¡¡ *
.
¡¡* +
BrandId
¡¡+ 2
;
¡¡2 3
var
¬¬ !
existingTransaction
¬¬ 
=
¬¬  !
await
√√ $
_transactionRepository
√√ (
.
√√( )6
(GetCoinPaymentTransactionByIdTransaction
√√) Q
(
√√Q R
purchaseRequest
√√R a
.
√√a b
Resource
√√b j
!
√√j k
.
√√k l
Ern
√√l o
!
√√o p
,
√√p q
brandId
√√q x
)
√√x y
;
√√y z
if
≈≈ 

(
≈≈ !
existingTransaction
≈≈ 
is
≈≈  "
null
≈≈# '
)
≈≈' (
{
∆∆ 	
_logger
«« 
.
«« 

LogWarning
«« 
(
«« 
$"
«« !
$str
««! l
"
««l m
)
««m n
;
««n o
return
»» 
false
»» 
;
»» 
}
…… 	
if
ÀÀ 

(
ÀÀ !
existingTransaction
ÀÀ 
.
ÀÀ  
	Acredited
ÀÀ  )
)
ÀÀ) *
{
ÃÃ 	
_logger
ÕÕ 
.
ÕÕ 
LogInformation
ÕÕ "
(
ÕÕ" #
$"
ŒŒ 
$str
ŒŒ j
"
ŒŒj k
)
ŒŒk l
;
ŒŒl m
return
œœ 
false
œœ 
;
œœ 
}
–– 	
if
““ 

(
““ 
purchaseRequest
““ 
.
““ 
Resource
““ $
.
““$ %
Status
““% +
==
““, .
	Constants
““/ 8
.
““8 9
RegisteredStatus
““9 I
)
““I J
{
”” 	!
existingTransaction
‘‘ 
.
‘‘  
Status
‘‘  &
=
‘‘' (
	Constants
‘‘) 2
.
‘‘2 3"
RegisteredStatusCode
‘‘3 G
;
‘‘G H!
existingTransaction
’’ 
.
’’  
	Acredited
’’  )
=
’’* +
false
’’, 1
;
’’1 2
}
÷÷ 	
else
◊◊ 
if
◊◊ 
(
◊◊ 
purchaseRequest
◊◊  
.
◊◊  !
Resource
◊◊! )
.
◊◊) *
Status
◊◊* 0
==
◊◊1 3
	Constants
◊◊4 =
.
◊◊= >
ExpiredStatus
◊◊> K
)
◊◊K L
{
ÿÿ 	!
existingTransaction
ŸŸ 
.
ŸŸ  
Status
ŸŸ  &
=
ŸŸ' (
	Constants
ŸŸ) 2
.
ŸŸ2 3
ExpiredStatusCode
ŸŸ3 D
;
ŸŸD E!
existingTransaction
⁄⁄ 
.
⁄⁄  
	Acredited
⁄⁄  )
=
⁄⁄* +
false
⁄⁄, 1
;
⁄⁄1 2
}
€€ 	
else
‹‹ 
if
‹‹ 
(
‹‹ 
purchaseRequest
‹‹  
.
‹‹  !
Resource
‹‹! )
.
‹‹) *
Status
‹‹* 0
==
‹‹1 3
	Constants
‹‹4 =
.
‹‹= >
CompletedStatus
‹‹> M
&&
‹‹N P!
existingTransaction
‹‹Q d
.
‹‹d e
	Acredited
‹‹e n
==
‹‹o q
false
‹‹r w
)
‹‹w x
{
›› 	!
existingTransaction
ﬁﬁ 
.
ﬁﬁ  
Status
ﬁﬁ  &
=
ﬁﬁ' (
	Constants
ﬁﬁ) 2
.
ﬁﬁ2 3!
CompletedStatusCode
ﬁﬁ3 F
;
ﬁﬁF G
decimal
ﬂﬂ 
.
ﬂﬂ 
TryParse
ﬂﬂ 
(
ﬂﬂ 
purchaseRequest
ﬂﬂ ,
.
ﬂﬂ, -
Resource
ﬂﬂ- 5
.
ﬂﬂ5 6
Amount
ﬂﬂ6 <
!
ﬂﬂ< =
.
ﬂﬂ= >
Total
ﬂﬂ> C
!
ﬂﬂC D
,
ﬂﬂD E
NumberStyles
ﬂﬂF R
.
ﬂﬂR S
Any
ﬂﬂS V
,
ﬂﬂV W
CultureInfo
ﬂﬂX c
.
ﬂﬂc d
InvariantCulture
ﬂﬂd t
,
ﬂﬂt u
out
‡‡ 
decimal
‡‡ 
amountReceived
‡‡ *
)
‡‡* +
;
‡‡+ ,!
existingTransaction
·· 
.
··  
AmountReceived
··  .
=
··/ 0
amountReceived
··1 ?
;
··? @!
existingTransaction
‚‚ 
.
‚‚  
	Acredited
‚‚  )
=
‚‚* +
true
‚‚, 0
;
‚‚0 1!
existingTransaction
„„ 
.
„„  
	Reference
„„  )
=
„„* +
purchaseRequest
„„, ;
.
„„; <
Resource
„„< D
.
„„D E
	Reference
„„E N
;
„„N O
await
‰‰ '
ProcessPaymentTransaction
‰‰ +
(
‰‰+ ,!
existingTransaction
‰‰, ?
)
‰‰? @
;
‰‰@ A
_logger
ÂÂ 
.
ÂÂ 
LogInformation
ÂÂ "
(
ÂÂ" #
$"
ÂÂ# %
$str
ÂÂ% h
"
ÂÂh i
)
ÂÂi j
;
ÂÂj k
}
ÊÊ 	
await
ËË $
_transactionRepository
ËË $
.
ËË$ %/
!UpdateCoinPaymentTransactionAsync
ËË% F
(
ËËF G!
existingTransaction
ËËG Z
)
ËËZ [
;
ËË[ \
_logger
ÈÈ 
.
ÈÈ 
LogInformation
ÈÈ 
(
ÈÈ 
$"
ÈÈ !
$str
ÈÈ! i
"
ÈÈi j
)
ÈÈj k
;
ÈÈk l
return
ÎÎ 
true
ÎÎ 
;
ÎÎ 
}
ÏÏ 
}ÌÌ åù
TC:\HeroSystem\walletService\WalletService.Core\Services\PaymentTransactionService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class %
PaymentTransactionService &
:' (
BaseService) 4
,4 5&
IPaymentTransactionService6 P
{ 
private 
readonly -
!ICoinPaymentTransactionRepository 6)
_paymentTransactionRepository7 T
;T U
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter7 M
;M N
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter7 O
;O P
private 
readonly !
IWireTransferStrategy *!
_wireTransferStrategy7 L
;L M
private 
readonly 
IBrandService "
_brandService7 D
;D E
public 
%
PaymentTransactionService $
($ %
IMapper% ,
mapper- 3
,3 4-
!ICoinPaymentTransactionRepositoryD e)
paymentTransactionRepository	f Ç
,
Ç É"
IAccountServiceAdapter !
accountServiceAdapter- B
,B C$
IInventoryServiceAdapterD \#
inventoryServiceAdapterf }
,} ~!
IWireTransferStrategy  
wireTransferStrategy- A
,A B
IBrandServiceB O
brandServiceP \
)\ ]
:^ _
base 
( 
mapper 
) 
{ )
_paymentTransactionRepository %
=& '(
paymentTransactionRepository( D
;D E"
_accountServiceAdapter 
=& '!
accountServiceAdapter( =
;= >$
_inventoryServiceAdapter    
=  & '#
inventoryServiceAdapter  ( ?
;  ? @!
_wireTransferStrategy!! 
=!!& ' 
wireTransferStrategy!!( <
;!!< =
_brandService"" 
=""& '
brandService""( 4
;""4 5
}## 
public%% 

async%% 
Task%% 
<%% !
PaymentTransactionDto%% +
?%%+ ,
>%%, -)
CreatePaymentTransactionAsync%%. K
(%%K L%
PaymentTransactionRequest%%L e
request%%f m
)%%m n
{&& 
var'' 
user'' 
='' 
await'' "
_accountServiceAdapter'' /
.''/ 0
GetUserInfo''0 ;
(''; <
request''< C
.''C D
AffiliateId''D O
,''O P
_brandService''P ]
.''] ^
BrandId''^ e
)''e f
;''f g
if)) 

()) 
user)) 
is)) 
null)) 
))) 
return** 
null** 
;** 
var,, 
transaction,, 
=,, 
Mapper,,  
.,,  !
Map,,! $
<,,$ %"
CoinpaymentTransaction,,% ;
>,,; <
(,,< =
request,,= D
),,D E
;,,E F
transaction.. 
... 
	Acredited.. 
=..# $
false..% *
;..* +
transaction// 
.// 
Status// 
=//# $
	Constants//% .
.//. /

EmptyValue/// 9
;//9 :
transaction00 
.00 
AmountReceived00 "
=00# $
	Constants00% .
.00. /

EmptyValue00/ 9
;009 :
transaction11 
.11 
PaymentMethod11 !
=11# $
$str11% 4
;114 5
var33 
response33 
=33 
await33 )
_paymentTransactionRepository33 :
.33: ;(
CreateCoinPaymentTransaction33; W
(33W X
transaction33X c
)33c d
;33d e
if55 

(55 
response55 
is55 
null55 
)55 
return66 
null66 
;66 
var88 
transactionResponse88 
=88  !
new88" %!
PaymentTransactionDto88& ;
{99 	
Id:: 
=:: 
response:: %
.::% &
Id::& (
,::( )
IdTransaction;; 
=;; 
response;; %
.;;% &
IdTransaction;;& 3
,;;3 4
AffiliateId<< 
=<< 
response<< %
.<<% &
AffiliateId<<& 1
,<<1 2
Amount== 
=== 
response== %
.==% &
Amount==& ,
,==, -
AmountReceived>> 
=>> 
response>> %
.>>% &
AmountReceived>>& 4
,>>4 5
Products?? 
=?? 
response?? %
.??% &
Products??& .
,??. /
Status@@ 
=@@ 
response@@ %
.@@% &
Status@@& ,
,@@, -
	AcreditedAA 
=AA 
responseAA %
.AA% &
	AcreditedAA& /
,AA/ 0
	CreatedAtBB 
=BB 
responseBB %
.BB% &
	CreatedAtBB& /
,BB/ 0
	UpdatedAtCC 
=CC 
responseCC %
.CC% &
	UpdatedAtCC& /
,CC/ 0
	DeletedAtDD 
=DD 
responseDD %
.DD% &
	DeletedAtDD& /
,DD/ 0
PaymentMethodEE 
=EE 
responseEE %
.EE% &
PaymentMethodEE& 3
}FF 	
;FF	 

returnHH 
transactionResponseHH "
;HH" #
}II 
publicKK 

asyncKK 
TaskKK 
<KK 
IEnumerableKK !
<KK! "!
PaymentTransactionDtoKK" 7
>KK7 8
>KK8 9
GetAllWireTransferKK: L
(KKL M
)KKM N
{LL 
varMM 
transactionsMM 
=MM  
awaitMM! &)
_paymentTransactionRepositoryMM' D
.MMD E
GetAllWireTransferMME W
(MMW X
_brandServiceMMX e
.MMe f
BrandIdMMf m
)MMm n
;MMn o
varNN 
uniqueAffiliateIdsNN 
=NN  
transactionsNN! -
.NN- .
SelectNN. 4
(NN4 5
transNN5 :
=>NN; =
transNN> C
.NNC D
AffiliateIdNND O
)NNO P
.NNP Q
DistinctNNQ Y
(NNY Z
)NNZ [
;NN[ \
varPP 
	userTasksPP 
=PP 
uniqueAffiliateIdsPP .
.PP. /
SelectPP/ 5
(PP5 6
idPP6 8
=>PP9 ;"
_accountServiceAdapterPP< R
.PPR S
GetUserInfoPPS ^
(PP^ _
idPP_ a
,PPa b
_brandServicePPc p
.PPp q
BrandIdPPq x
)PPx y
)PPy z
.PPz {
ToList	PP{ Å
(
PPÅ Ç
)
PPÇ É
;
PPÉ Ñ
varQQ 
userResponsesQQ 
=QQ 
awaitQQ !
TaskQQ" &
.QQ& '
WhenAllQQ' .
(QQ. /
	userTasksQQ/ 8
)QQ8 9
;QQ9 :
varSS 
	usersInfoSS 
=SS 
userResponsesSS %
.TT 
WhereTT 
(TT 
userTT 
=>TT 
userTT 
!=TT  "
nullTT# '
)TT' (
.UU 
ToDictionaryUU 
(UU 
userUU 
=>UU !
userUU" &
!UU& '
.UU' (
IdUU( *
,UU* +
userUU, 0
=>UU1 3
userUU4 8
)UU8 9
;UU9 :
ifWW 

(WW 
!WW 
	usersInfoWW 
.WW 
AnyWW 
(WW 
)WW 
)WW 
returnXX 

EnumerableXX 
.XX 
EmptyXX #
<XX# $!
PaymentTransactionDtoXX$ 9
>XX9 :
(XX: ;
)XX; <
;XX< =
varZZ 
transactionsDtoZZ 
=ZZ 
transactionsZZ *
.ZZ* +
SelectZZ+ 1
(ZZ1 2
transZZ2 7
=>ZZ8 :
newZZ; >!
PaymentTransactionDtoZZ? T
{[[ 	
Id\\ 
=\\ 
trans\\ "
.\\" #
Id\\# %
,\\% &
IdTransaction]] 
=]] 
trans]] "
.]]" #
IdTransaction]]# 0
,]]0 1
AffiliateId^^ 
=^^ 
trans^^ "
.^^" #
AffiliateId^^# .
,^^. /
Amount__ 
=__ 
trans__ "
.__" #
Amount__# )
,__) *
AmountReceived`` 
=`` 
trans`` "
.``" #
AmountReceived``# 1
,``1 2
Productsaa 
=aa 
transaa "
.aa" #
Productsaa# +
,aa+ ,
Statusbb 
=bb 
transbb "
.bb" #
Statusbb# )
,bb) *
	Acreditedcc 
=cc 
transcc "
.cc" #
	Acreditedcc# ,
,cc, -
	CreatedAtdd 
=dd 
transdd "
.dd" #
	CreatedAtdd# ,
,dd, -
	UpdatedAtee 
=ee 
transee "
.ee" #
	UpdatedAtee# ,
,ee, -
	DeletedAtff 
=ff 
transff "
.ff" #
	DeletedAtff# ,
,ff, -
PaymentMethodgg 
=gg 
transgg "
.gg" #
PaymentMethodgg# 0
,gg0 1
UserNamehh 
=hh 
	usersInfohh &
.hh& '
TryGetValuehh' 2
(hh2 3
transhh3 8
.hh8 9
AffiliateIdhh9 D
,hhD E
outhhF I
varhhJ M
valuehhN S
)hhS T
?hhU V
valuehhW \
!hh\ ]
.hh] ^
UserNamehh^ f
:hhg h
nullhhi m
}ii 	
)ii	 

.ii
 
ToListii 
(ii 
)ii 
;ii 
returnkk 
transactionsDtokk 
;kk 
}ll 
publicnn 

asyncnn 
Tasknn 
<nn 
boolnn 
>nn 
ConfirmPaymentnn *
(nn* +,
 ConfirmPaymentTransactionRequestnn+ K
requestnnL S
)nnS T
{oo 
varpp 
paymentTransactionpp 
=pp  
awaitpp! &)
_paymentTransactionRepositorypp' D
.ppD E%
GetPaymentTransactionByIdppE ^
(pp^ _
requestpp_ f
.ppf g
Idppg i
,ppi j
_brandServiceppk x
.ppx y
BrandId	ppy Ä
)
ppÄ Å
;
ppÅ Ç
ifrr 

(rr 
paymentTransactionrr 
isrr !
nullrr" &
)rr& '
returnss 
falsess 
;ss 
varuu 
productsuu 
=uu 
paymentTransactionuu )
.uu) *
Productsuu* 2
.uu2 3
ToJsonObjectuu3 ?
<uu? @
Listuu@ D
<uuD E
ProductRequestuuE S
>uuS T
>uuT U
(uuU V
)uuV W
;uuW X
ifvv 

(vv 
productsvv 
isvv 
nullvv 
)vv 
returnvv $
falsevv% *
;vv* +
varxx 
walletRequestxx 
=xx 
BuildWalletRequestxx .
(xx. /
paymentTransactionxx/ A
,xxA B
requestxxC J
)xxJ K
;xxK L
varzz 
productTypezz 
=zz 
awaitzz  
GetProductTypezz! /
(zz/ 0
productszz0 8
)zz8 9
;zz9 :
bool{{ 
paymentResult{{ 
;{{ 
switch}} 
(}} 
productType}} 
)}} 
{~~ 	
case 
ProductType 
. 
EcoPool $
:$ %
paymentResult
ÄÄ 
=
ÄÄ 
await
ÄÄ  %#
ExecuteEcoPoolPayment
ÄÄ& ;
(
ÄÄ; <
walletRequest
ÄÄ< I
)
ÄÄI J
;
ÄÄJ K
break
ÅÅ 
;
ÅÅ 
default
ÇÇ 
:
ÇÇ 
paymentResult
ÉÉ 
=
ÉÉ 
await
ÉÉ  %"
ExecuteCoursePayment
ÉÉ& :
(
ÉÉ: ;
walletRequest
ÉÉ; H
)
ÉÉH I
;
ÉÉI J
break
ÑÑ 
;
ÑÑ 
}
ÖÖ 	
if
áá 

(
áá 
paymentResult
áá 
)
áá 
{
àà 	
return
ââ 
await
ââ &
UpdatePaymentTransaction
ââ 1
(
ââ1 2 
paymentTransaction
ââ2 D
)
ââD E
;
ââE F
}
ää 	
return
åå 
false
åå 
;
åå 
}
çç 
private
èè 
WalletRequest
èè  
BuildWalletRequest
èè ,
(
èè, -$
CoinpaymentTransaction
èè- C
payment
èèD K
,
èèK L.
 ConfirmPaymentTransactionRequest
èèM m
request
èèn u
)
èèu v
{
êê 
var
ëë 
products
ëë 
=
ëë 
payment
ëë 
.
ëë 
Products
ëë '
.
ëë' (
ToJsonObject
ëë( 4
<
ëë4 5
List
ëë5 9
<
ëë9 :
ProductRequest
ëë: H
>
ëëH I
>
ëëI J
(
ëëJ K
)
ëëK L
;
ëëL M
return
ìì 
new
ìì 
WalletRequest
ìì  
{
îî 	
AffiliateId
ïï 
=
ïï 
payment
ïï  '
.
ïï' (
AffiliateId
ïï( 3
,
ïï3 4
AffiliateUserName
ññ 
=
ññ 
request
ññ  '
.
ññ' (
UserName
ññ( 0
,
ññ0 1
PurchaseFor
óó 
=
óó 
	Constants
óó  )
.
óó) *

EmptyValue
óó* 4
,
óó4 5
Bank
òò 
=
òò 
	Constants
òò  )
.
òò) *
WireTransfer
òò* 6
,
òò6 7
PaymentMethod
ôô 
=
ôô 
	Constants
ôô  )
.
ôô) *

EmptyValue
ôô* 4
,
ôô4 5
	SecretKey
öö 
=
öö 
null
öö  $
,
öö$ %
ReceiptNumber
õõ 
=
õõ 
payment
õõ  '
.
õõ' (
IdTransaction
õõ( 5
,
õõ5 6
ProductsList
úú 
=
úú 
products
úú #
?
úú# $
.
úú$ %
Select
úú% +
(
úú+ ,
p
úú, -
=>
úú. 0
new
úú1 4
ProductsRequests
úú5 E
{
ùù 
	IdProduct
ûû 
=
ûû 
p
ûû 
.
ûû 
	ProductId
ûû '
,
ûû' (
Count
üü 
=
üü 
p
üü 
.
üü 
Quantity
üü &
}
†† 
)
†† 
.
†† 
ToList
†† 
(
†† 
)
†† 
??
†† 
new
†† 
List
†† #
<
††# $
ProductsRequests
††$ 4
>
††4 5
(
††5 6
)
††6 7
}
°° 	
;
°°	 

}
¢¢ 
private
§§ 
async
§§ 
Task
§§ 
<
§§ 
ProductType
§§ "
>
§§" #
GetProductType
§§$ 2
(
§§2 3
List
§§3 7
<
§§7 8
ProductRequest
§§8 F
>
§§F G
request
§§H O
)
§§O P
{
•• 
var
¶¶ 

productIds
¶¶ 
=
¶¶ 
request
¶¶ "
.
¶¶" #
Select
¶¶# )
(
¶¶) *
p
¶¶* +
=>
¶¶, .
p
¶¶/ 0
.
¶¶0 1
	ProductId
¶¶1 :
)
¶¶: ;
.
¶¶; <
ToArray
¶¶< C
(
¶¶C D
)
¶¶D E
;
¶¶E F
var
ßß 
responseList
ßß 
=
ßß 
await
ßß  &
_inventoryServiceAdapter
ßß! 9
.
ßß9 :
GetProductsIds
ßß: H
(
ßßH I

productIds
ßßI S
,
ßßS T
_brandService
ßßT a
.
ßßa b
BrandId
ßßb i
)
ßßi j
;
ßßj k
var
©© 
result
©© 
=
©© 
responseList
©© !
.
©©! "
Content
©©" )
!
©©) *
.
©©* +
ToJsonObject
©©+ 7
<
©©7 8
ProductsResponse
©©8 H
>
©©H I
(
©©I J
)
©©J K
;
©©K L
var
´´ "
firstProductCategory
´´  
=
´´! "
result
´´# )
!
´´) *
.
´´* +
Data
´´+ /
.
´´/ 0
First
´´0 5
(
´´5 6
)
´´6 7
.
´´7 8
PaymentGroup
´´8 D
;
´´D E
switch
≠≠ 
(
≠≠ "
firstProductCategory
≠≠ $
)
≠≠$ %
{
ÆÆ 	
case
ØØ 
$num
ØØ 
:
ØØ 
return
ØØ 
ProductType
ØØ &
.
ØØ& '

Membership
ØØ' 1
;
ØØ1 2
case
∞∞ 
$num
∞∞ 
:
∞∞ 
return
∞∞ 
ProductType
∞∞ &
.
∞∞& '
EcoPool
∞∞' .
;
∞∞. /
default
±± 
:
±± 
return
≤≤ 
ProductType
≤≤ "
.
≤≤" #
Course
≤≤# )
;
≤≤) *
}
≥≥ 	
}
¥¥ 
private
∂∂ 
async
∂∂ 
Task
∂∂ 
<
∂∂ 
bool
∂∂ 
>
∂∂ #
ExecuteEcoPoolPayment
∂∂ 2
(
∂∂2 3
WalletRequest
∂∂3 @
walletRequest
∂∂A N
)
∂∂N O
{
∑∑ 
try
ππ 
{
∫∫ 	
await
ªª #
_wireTransferStrategy
ªª '
.
ªª' (#
ExecuteEcoPoolPayment
ªª( =
(
ªª= >
walletRequest
ªª> K
)
ªªK L
;
ªªL M
return
ºº 
true
ºº 
;
ºº 
}
ΩΩ 	
catch
ææ 
(
ææ 
	Exception
ææ 
)
ææ 
{
øø 	
return
¿¿ 
false
¿¿ 
;
¿¿ 
}
¡¡ 	
}
¬¬ 
private
ƒƒ 
async
ƒƒ 
Task
ƒƒ 
<
ƒƒ 
bool
ƒƒ 
>
ƒƒ "
ExecuteCoursePayment
ƒƒ 1
(
ƒƒ1 2
WalletRequest
ƒƒ2 ?
walletRequest
ƒƒ@ M
)
ƒƒM N
{
≈≈ 
try
∆∆ 
{
«« 	
await
»» #
_wireTransferStrategy
»» '
.
»»' (#
ExecutePaymentCourses
»»( =
(
»»= >
walletRequest
»»> K
)
»»K L
;
»»L M
return
…… 
true
…… 
;
…… 
}
   	
catch
ÀÀ 
(
ÀÀ 
	Exception
ÀÀ 
)
ÀÀ 
{
ÃÃ 	
return
ÕÕ 
false
ÕÕ 
;
ÕÕ 
}
ŒŒ 	
}
œœ 
private
—— 
async
—— 
Task
—— 
<
—— 
bool
—— 
>
—— &
UpdatePaymentTransaction
—— 5
(
——5 6$
CoinpaymentTransaction
——6 L
payment
——M T
)
——T U
{
““ 
payment
”” 
.
”” 
	Acredited
”” 
=
””  
true
””! %
;
””% &
payment
‘‘ 
.
‘‘ 
Status
‘‘ 
=
‘‘  
$num
‘‘! $
;
‘‘$ %
payment
’’ 
.
’’ 
AmountReceived
’’ 
=
’’  
payment
’’! (
.
’’( )
Amount
’’) /
;
’’/ 0
var
◊◊ 
transaction
◊◊ 
=
◊◊ 
await
◊◊ +
_paymentTransactionRepository
◊◊  =
.
◊◊= >/
!UpdateCoinPaymentTransactionAsync
◊◊> _
(
◊◊_ `
payment
◊◊` g
)
◊◊g h
;
◊◊h i
return
ŸŸ 
transaction
ŸŸ 
is
ŸŸ 
not
ŸŸ !
null
ŸŸ" &
;
ŸŸ& '
}
⁄⁄ 
}€€ ñ—
PC:\HeroSystem\walletService\WalletService.Core\Services\ProcessGradingService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class !
ProcessGradingService "
:# $
BaseService% 0
,0 1"
IProcessGradingService2 H
{ 
private 
readonly 
KafkaProducer "
_kafkaProducer# 1
;1 2
private 
readonly +
IEcoPoolConfigurationRepository 4$
_configurationRepository5 M
;M N
private 
readonly 
IWalletRepository &
_walletRepository' 8
;8 9
private 
readonly !
IConfigurationAdapter *!
_configurationAdapter+ @
;@ A
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter, B
;B C
private 
readonly $
IInventoryServiceAdapter -$
_inventoryServiceAdapter. F
;F G
private 
readonly 
IBrandService "
_brandService# 0
;0 1
public 
!
ProcessGradingService  
(  !
IMapper 
mapper( .
,. /
KafkaProducer 
kafkaProducer( 5
,5 6+
IEcoPoolConfigurationRepository   '#
configurationRepository  ( ?
,  ? @
IWalletRepository!! 
walletRepository!!( 8
,!!8 9!
IConfigurationAdapter""  
configurationAdapter""( <
,""< ="
IAccountServiceAdapter## !
accountServiceAdapter##( =
,##= >$
IInventoryServiceAdapter$$  #
inventoryServiceAdapter$$( ?
,$$? @
IBrandService%% 
brandService%%( 4
)&& 
:&& 
base&& 
(&& 
mapper&& 
)&& 
{'' $
_configurationRepository((  
=((! "#
configurationRepository((# :
;((: ;
_kafkaProducer)) 
=))! "
kafkaProducer))# 0
;))0 1
_walletRepository** 
=**! "
walletRepository**# 3
;**3 4!
_configurationAdapter++ 
=++! " 
configurationAdapter++# 7
;++7 8"
_accountServiceAdapter,, 
=,,! "!
accountServiceAdapter,,# 8
;,,8 9$
_inventoryServiceAdapter--  
=--! "#
inventoryServiceAdapter--# :
;--: ;
_brandService.. 
=..! "
brandService..# /
;../ 0
}// 
public22 

async22 
Task22 
ExecuteFirstProcess22 )
(22) *
)22* +
{33 
var44  
model1AConfiguration44  
=44! "
await44# ($
_configurationRepository44) A
.44A B"
GetConfigurationByType44B X
(44X Y"
ModelTypeConfiguration44Y o
.44o p
Model_1A44p x
.44x y
ToString	44y Å
(
44Å Ç
)
44Ç É
)
44É Ñ
;
44Ñ Ö
var55  
model1BConfiguration55  
=55! "
await55# ($
_configurationRepository55) A
.55A B"
GetConfigurationByType55B X
(55X Y"
ModelTypeConfiguration55Y o
.55o p
Model_1B55p x
.55x y
ToString	55y Å
(
55Å Ç
)
55Ç É
)
55É Ñ
;
55Ñ Ö
var66 
model2Configuration66 
=66! "
await66# ($
_configurationRepository66) A
.66A B
GetConfiguration66B R
(66R S
)66S T
;66T U
var77 
model3Configuration77 
=77! "
await77# ($
_configurationRepository77) A
.77A B"
GetConfigurationByType77B X
(77X Y"
ModelTypeConfiguration77Y o
.77o p
Model_377p w
.77w x
ToString	77x Ä
(
77Ä Å
)
77Å Ç
)
77Ç É
;
77É Ñ
var88 
listAccounts88 
=88 
new88 
List88 #
<88# $
int88$ '
>88' (
(88( )
)88) *
;88* +
if99 

(99  
model1AConfiguration99  
is99! #
not99$ '
null99( ,
)99, -
await:: 
ProcessModel1A::  
(::  ! 
model1AConfiguration::! 5
,::5 6
listAccounts::7 C
)::C D
;::D E
if;; 

(;;  
model1BConfiguration;;  
is;;! #
not;;$ '
null;;( ,
);;, -
await<< 
ProcessModel1B<<  
(<<  ! 
model1BConfiguration<<! 5
,<<5 6
listAccounts<<7 C
)<<C D
;<<D E
if== 

(== 
model2Configuration== 
is==  "
not==# &
null==' +
)==+ ,
await>> 
ProcessModel2>> 
(>>  
model2Configuration>>  3
,>>3 4
listAccounts>>5 A
)>>A B
;>>B C
if?? 

(?? 
model3Configuration?? 
is??  "
not??# &
null??' +
)??+ ,
await@@ 
ProcessModel3@@ 
(@@  
model3Configuration@@  3
,@@3 4
listAccounts@@5 A
)@@A B
;@@B C
varBB 
usersJsonStringBB 
=BB 
listAccountsBB *
.BB* +
SelectBB+ 1
(BB1 2
xBB2 3
=>BB4 6
xBB7 8
.BB8 9
ToStringBB9 A
(BBA B
)BBB C
)BBC D
.BBD E
ToJsonStringBBE Q
(BBQ R
)BBR S
;BBS T
}CC 
privateEE 
asyncEE 
TaskEE 
ProcessModel2EE $
(EE$ %
ModelConfigurationEE% 7
model2ConfigurationEE8 K
,EEK L
ListEEM Q
<EEQ R
intEER U
>EEU V
listAccountsEEW c
)EEc d
{FF 
varGG  
configuration2MappedGG  
=GG! "
MapperGG# )
.GG) *
MapGG* -
<GG- .!
ModelConfigurationDtoGG. C
>GGC D
(GGD E
model2ConfigurationGGE X
)GGX Y
;GGY Z
varHH 
starDateHH 
=HH 
newHH 
DateTimeHH #
(HH# $
model2ConfigurationHH$ 7
.HH7 8
DateInitHH8 @
.HH@ A
YearHHA E
,HHE F
model2ConfigurationHHG Z
.HHZ [
DateInitHH[ c
.HHc d
MonthHHd i
,HHi j
model2ConfigurationHHk ~
.HH~ 
DateInit	HH á
.
HHá à
Day
HHà ã
,
HHã å
$numII 
,II 
$numII 
,II 
$numII 
)II 
;II 
varJJ 
endDateJJ 
=JJ 
newJJ 
DateTimeJJ "
(JJ" #
model2ConfigurationJJ# 6
.JJ6 7
DateEndJJ7 >
.JJ> ?
YearJJ? C
,JJC D
model2ConfigurationJJE X
.JJX Y
DateEndJJY `
.JJ` a
MonthJJa f
,JJf g
model2ConfigurationJJh {
.JJ{ |
DateEnd	JJ| É
.
JJÉ Ñ
Day
JJÑ á
,
JJá à
$num
JJâ ã
,
JJã å
$numKK 
,KK 
$numKK 
)KK 
;KK 
varMM 
poolsModel2WithinMM 
=MM  
awaitMM! &
_walletRepositoryMM' 8
.MM8 9&
GetDebitsModel2WithinMonthMM9 S
(MMS T
starDateMMT \
,MM\ ]
model2ConfigurationMM^ q
.MMq r
DateEndMMr y
)MMy z
;MMz {
varNN 
poolsModel2OutsideNN 
=NN  
awaitNN! &
_walletRepositoryNN' 8
.NN8 9'
GetDebitsModel2OutsideMonthNN9 T
(NNT U
starDateNNU ]
)NN] ^
;NN^ _
varPP 
accountsModel2PP 
=PP 
poolsModel2WithinPP .
.PP. /
UnionPP/ 4
(PP4 5
poolsModel2OutsidePP5 G
)PPG H
.QQ 
SelectQQ 
(QQ 
xQQ 
=>QQ 
xQQ 
.QQ 
InvoiceQQ #
.QQ# $
AffiliateIdQQ$ /
)QQ/ 0
.QQ0 1
DistinctQQ1 9
(QQ9 :
)QQ: ;
.QQ; <
ToArrayQQ< C
(QQC D
)QQD E
;QQE F
varRR 
productsModel2RR 
=RR 
poolsModel2WithinRR .
.RR. /
UnionRR/ 4
(RR4 5
poolsModel2OutsideRR5 G
)RRG H
.SS 
SelectSS 
(SS 
xSS 
=>SS 
xSS 
.SS 
	ProductIdSS $
)SS$ %
.SS% &
DistinctSS& .
(SS. /
)SS/ 0
.SS0 1
ToArraySS1 8
(SS8 9
)SS9 :
;SS: ;
model2ConfigurationUU 
.UU 
TotalsUU "
=UU# $
poolsModel2WithinUU% 6
.UU6 7
CountUU7 <
+UU= >
poolsModel2OutsideUU? Q
.UUQ R
CountUUR W
;UUW X
awaitVV $
_configurationRepositoryVV &
.VV& '
UpdateConfigurationVV' :
(VV: ;
model2ConfigurationVV; N
)VVN O
;VVO P
varXX $
listResultModel2ProductsXX $
=XX' (
awaitXX) .
GetListProductsXX/ >
(XX> ?
productsModel2XX? M
)XXM N
;XXN O
varYY $
listResultModel2AccountsYY $
=YY' (
awaitYY) .
GetListAccountYY/ =
(YY= >
accountsModel2YY> L
,YYL M
model2ConfigurationYYN a
)YYa b
;YYb c
listAccountsZZ 
.ZZ 
AddRangeZZ 
(ZZ 
accountsModel2ZZ ,
.ZZ, -
ToListZZ- 3
(ZZ3 4
)ZZ4 5
)ZZ5 6
;ZZ6 7
var[[ &
pointConfigurationResponse[[ &
=[[' (
await[[) .!
_configurationAdapter[[/ D
.[[D E"
GetPointsConfiguration[[E [
([[[ \
_brandService[[\ i
.[[i j
BrandId[[j q
)[[q r
;[[r s
var\\ 
points\\ 
=\\' (&
pointConfigurationResponse\\) C
.\\C D
Content\\D K
?\\K L
.\\L M
	ToDecimal\\M V
(\\V W
)\\W X
;\\X Y
var^^ !
poolsWithinMothMapped^^ !
=^^# $
Mapper^^% +
.^^+ ,
Map^^, /
<^^/ 0
ICollection^^0 ;
<^^; <
InvoiceDetailDto^^< L
>^^L M
>^^M N
(^^N O
poolsModel2Within^^O `
)^^` a
;^^a b
var__ "
poolsWithoutMothMapped__ "
=__# $
Mapper__% +
.__+ ,
Map__, /
<__/ 0
ICollection__0 ;
<__; <
InvoiceDetailDto__< L
>__L M
>__M N
(__N O
poolsModel2Outside__O a
)__a b
;__b c
awaitaa 
SendModel2Processaa 
(aa  !
poolsWithinMothMappedaa  5
,aa5 6"
poolsWithoutMothMappedaa7 M
,aaM N 
configuration2MappedaaO c
,aac d
pointsaae k
,aak l
endDateaam t
,aat u
starDateaav ~
,aa~ &
listResultModel2Accounts
aaÄ ò
,
aaò ô$
listResultModel2Productsbb $
,bb$ %
KafkaTopicscc 
.cc 
ProcessModel2Topiccc *
)cc* +
;cc+ ,
}ee 
privateff 
asyncff 
Taskff 
ProcessModel1Aff %
(ff% &
ModelConfigurationff& 8 
model1AConfigurationff9 M
,ffM N
ListffO S
<ffS T
intffT W
>ffW X
listAccountsffY e
)ffe f
{gg 
varhh !
configuration1AMappedhh !
=hh" #
Mapperhh$ *
.hh* +
Maphh+ .
<hh. /!
ModelConfigurationDtohh/ D
>hhD E
(hhE F 
model1AConfigurationhhF Z
)hhZ [
;hh[ \
varii 
starDateii 
=ii 
newii 
DateTimeii #
(ii# $ 
model1AConfigurationii$ 8
.ii8 9
DateInitii9 A
.iiA B
YeariiB F
,iiF G 
model1AConfigurationiiH \
.ii\ ]
DateInitii] e
.iie f
Monthiif k
,iik l!
model1AConfiguration	iim Å
.
iiÅ Ç
DateInit
iiÇ ä
.
iiä ã
Day
iiã é
,
iié è
$numjj 
,jj 
$numjj 
,jj 
$numjj 
)jj 
;jj 
varkk 
endDatekk 
=kk 
newkk 
DateTimekk "
(kk" # 
model1AConfigurationkk# 7
.kk7 8
DateEndkk8 ?
.kk? @
Yearkk@ D
,kkD E 
model1AConfigurationkkF Z
.kkZ [
DateEndkk[ b
.kkb c
Monthkkc h
,kkh i 
model1AConfigurationkkj ~
.kk~ 
DateEnd	kk Ü
.
kkÜ á
Day
kká ä
,
kkä ã
$num
kkå é
,
kké è
$numll 
,ll 
$numll 
)ll 
;ll 
varnn 
itemsModel1AWithinnn 
=nn  !
awaitnn" '
_walletRepositorynn( 9
.nn9 :'
GetDebitsModel1AWithinMonthnn: U
(nnU V
starDatennV ^
,nn^ _ 
model1AConfigurationnn` t
.nnt u
DateEndnnu |
)nn| }
;nn} ~
varoo 
itemsModel1AOutsideoo 
=oo  !
awaitoo" '
_walletRepositoryoo( 9
.oo9 :(
GetDebitsModel1AOutsideMonthoo: V
(ooV W
starDateooW _
)oo_ `
;oo` a
varqq 
accountsModel1Aqq 
=qq 
itemsModel1AWithinqq 0
.qq0 1
Unionqq1 6
(qq6 7
itemsModel1AOutsideqq7 J
)qqJ K
.rr 
Selectrr 
(rr 
xrr 
=>rr 
xrr 
.rr 
Invoicerr "
.rr" #
AffiliateIdrr# .
)rr. /
.rr/ 0
Distinctrr0 8
(rr8 9
)rr9 :
.rr: ;
ToArrayrr; B
(rrB C
)rrC D
;rrD E
varss 
productsModel1Ass 
=ss 
itemsModel1AWithinss 0
.ss0 1
Unionss1 6
(ss6 7
itemsModel1AOutsidess7 J
)ssJ K
.tt 
Selecttt 
(tt 
xtt 
=>tt 
xtt 
.tt 
	ProductIdtt $
)tt$ %
.tt% &
Distincttt& .
(tt. /
)tt/ 0
.tt0 1
ToArraytt1 8
(tt8 9
)tt9 :
;tt: ; 
model1AConfigurationvv 
.vv 
Totalsvv #
=vv$ %
itemsModel1AWithinvv& 8
.vv8 9
Countvv9 >
+vv? @
itemsModel1AOutsidevvA T
.vvT U
CountvvU Z
;vvZ [
awaitww $
_configurationRepositoryww &
.ww& '
UpdateConfigurationww' :
(ww: ; 
model1AConfigurationww; O
)wwO P
;wwP Q
varyy %
listResultModel1AProductsyy %
=yy( )
awaityy* /
GetListProductsyy0 ?
(yy? @
productsModel1Ayy@ O
)yyO P
;yyP Q
varzz %
listResultModel1AAccountszz %
=zz( )
awaitzz* /
GetListAccountzz0 >
(zz> ?
accountsModel1Azz? N
,zzN O 
model1AConfigurationzzP d
)zzd e
;zze f
listAccounts{{ 
.{{ 
AddRange{{ 
({{ 
accountsModel1A{{ -
.{{- .
ToList{{. 4
({{4 5
){{5 6
){{6 7
;{{7 8
var|| &
pointConfigurationResponse|| &
=||' (
await||) .!
_configurationAdapter||/ D
.||D E"
GetPointsConfiguration||E [
(||[ \
_brandService||\ i
.||i j
BrandId||j q
)||q r
;||r s
var}} 
points}} 
=}}' (&
pointConfigurationResponse}}) C
.}}C D
Content}}D K
?}}K L
.}}L M
	ToDecimal}}M V
(}}V W
)}}W X
;}}X Y
var !
itemsWithinMothMapped !
=# $
Mapper% +
.+ ,
Map, /
</ 0
ICollection0 ;
<; <
InvoiceDetailDto< L
>L M
>M N
(N O
itemsModel1AWithinO a
)a b
;b c
var
ÄÄ $
itemsWithoutMothMapped
ÄÄ "
=
ÄÄ# $
Mapper
ÄÄ% +
.
ÄÄ+ ,
Map
ÄÄ, /
<
ÄÄ/ 0
ICollection
ÄÄ0 ;
<
ÄÄ; <
InvoiceDetailDto
ÄÄ< L
>
ÄÄL M
>
ÄÄM N
(
ÄÄN O!
itemsModel1AOutside
ÄÄO b
)
ÄÄb c
;
ÄÄc d
await
ÇÇ  
SendModel1AProcess
ÇÇ  
(
ÇÇ  !#
itemsWithinMothMapped
ÇÇ! 6
,
ÇÇ6 7$
itemsWithoutMothMapped
ÇÇ8 N
,
ÇÇN O#
configuration1AMapped
ÇÇO d
,
ÇÇd e
points
ÇÇf l
,
ÇÇl m
endDate
ÇÇn u
,
ÇÇu v
starDate
ÇÇw 
,ÇÇ Ä)
listResultModel1AAccountsÇÇÅ ö
,ÇÇö õ'
listResultModel1AProducts
ÉÉ %
,
ÉÉ% &
KafkaTopics
ÑÑ 
.
ÑÑ !
ProcessModel1ATopic
ÑÑ +
)
ÑÑ+ ,
;
ÑÑ, -
}
ÜÜ 
private
áá 
async
áá 
Task
áá 
ProcessModel1B
áá %
(
áá% & 
ModelConfiguration
áá& 8"
model1BConfiguration
áá9 M
,
ááM N
List
ááO S
<
ááS T
int
ááT W
>
ááW X
listAccounts
ááY e
)
ááe f
{
àà 
var
ââ #
configuration1BMapped
ââ !
=
ââ" #
Mapper
ââ$ *
.
ââ* +
Map
ââ+ .
<
ââ. /#
ModelConfigurationDto
ââ/ D
>
ââD E
(
ââE F"
model1BConfiguration
ââF Z
)
ââZ [
;
ââ[ \
var
ää 
starDate
ää 
=
ää 
new
ää 
DateTime
ää #
(
ää# $"
model1BConfiguration
ää$ 8
.
ää8 9
DateInit
ää9 A
.
ääA B
Year
ääB F
,
ääF G"
model1BConfiguration
ääH \
.
ää\ ]
DateInit
ää] e
.
ääe f
Month
ääf k
,
ääk l#
model1BConfigurationääm Å
.ääÅ Ç
DateInitääÇ ä
.äää ã
Dayääã é
,ääé è
$num
ãã 
,
ãã 
$num
ãã 
,
ãã 
$num
ãã 
)
ãã 
;
ãã 
var
åå 
endDate
åå 
=
åå 
new
åå 
DateTime
åå "
(
åå" #"
model1BConfiguration
åå# 7
.
åå7 8
DateEnd
åå8 ?
.
åå? @
Year
åå@ D
,
ååD E"
model1BConfiguration
ååF Z
.
ååZ [
DateEnd
åå[ b
.
ååb c
Month
ååc h
,
ååh i"
model1BConfiguration
ååj ~
.
åå~ 
DateEndåå Ü
.ååÜ á
Dayååá ä
,ååä ã
$numååå é
,ååé è
$num
çç 
,
çç 
$num
çç 
)
çç 
;
çç 
var
èè  
itemsModel1BWithin
èè 
=
èè  !
await
èè" '
_walletRepository
èè( 9
.
èè9 :)
GetDebitsModel1BWithinMonth
èè: U
(
èèU V
starDate
èèV ^
,
èè^ _"
model1BConfiguration
èè` t
.
èèt u
DateEnd
èèu |
)
èè| }
;
èè} ~
var
êê !
itemsModel1BOutside
êê 
=
êê  !
await
êê" '
_walletRepository
êê( 9
.
êê9 :*
GetDebitsModel1BOutsideMonth
êê: V
(
êêV W
starDate
êêW _
)
êê_ `
;
êê` a
var
íí 
accountsModel1B
íí 
=
íí  
itemsModel1BWithin
íí 0
.
íí0 1
Union
íí1 6
(
íí6 7!
itemsModel1BOutside
íí7 J
)
ííJ K
.
ìì 
Select
ìì 
(
ìì 
x
ìì 
=>
ìì 
x
ìì 
.
ìì 
Invoice
ìì "
.
ìì" #
AffiliateId
ìì# .
)
ìì. /
.
ìì/ 0
Distinct
ìì0 8
(
ìì8 9
)
ìì9 :
.
ìì: ;
ToArray
ìì; B
(
ììB C
)
ììC D
;
ììD E
var
îî 
productsModel1B
îî 
=
îî  
itemsModel1BWithin
îî 0
.
îî0 1
Union
îî1 6
(
îî6 7!
itemsModel1BOutside
îî7 J
)
îîJ K
.
ïï 
Select
ïï 
(
ïï 
x
ïï 
=>
ïï 
x
ïï 
.
ïï 
	ProductId
ïï $
)
ïï$ %
.
ïï% &
Distinct
ïï& .
(
ïï. /
)
ïï/ 0
.
ïï0 1
ToArray
ïï1 8
(
ïï8 9
)
ïï9 :
;
ïï: ;"
model1BConfiguration
óó 
.
óó 
Totals
óó #
=
óó$ % 
itemsModel1BWithin
óó& 8
.
óó8 9
Count
óó9 >
+
óó? @!
itemsModel1BOutside
óóA T
.
óóT U
Count
óóU Z
;
óóZ [
await
òò &
_configurationRepository
òò &
.
òò& '!
UpdateConfiguration
òò' :
(
òò: ;"
model1BConfiguration
òò; O
)
òòO P
;
òòP Q
var
öö '
listResultModel1BProducts
öö %
=
öö( )
await
öö* /
GetListProducts
öö0 ?
(
öö? @
productsModel1B
öö@ O
)
ööO P
;
ööP Q
var
õõ '
listResultModel1BAccounts
õõ %
=
õõ( )
await
õõ* /
GetListAccount
õõ0 >
(
õõ> ?
accountsModel1B
õõ? N
,
õõN O"
model1BConfiguration
õõP d
)
õõd e
;
õõe f
listAccounts
úú 
.
úú 
AddRange
úú 
(
úú 
accountsModel1B
úú -
.
úú- .
ToList
úú. 4
(
úú4 5
)
úú5 6
)
úú6 7
;
úú7 8
var
ùù (
pointConfigurationResponse
ùù &
=
ùù' (
await
ùù) .#
_configurationAdapter
ùù/ D
.
ùùD E$
GetPointsConfiguration
ùùE [
(
ùù[ \
_brandService
ùù\ i
.
ùùi j
BrandId
ùùj q
)
ùùq r
;
ùùr s
var
ûû 
points
ûû 
=
ûû' ((
pointConfigurationResponse
ûû) C
.
ûûC D
Content
ûûD K
?
ûûK L
.
ûûL M
	ToDecimal
ûûM V
(
ûûV W
)
ûûW X
;
ûûX Y
var
†† #
itemsWithinMothMapped
†† !
=
††# $
Mapper
††% +
.
††+ ,
Map
††, /
<
††/ 0
ICollection
††0 ;
<
††; <
InvoiceDetailDto
††< L
>
††L M
>
††M N
(
††N O 
itemsModel1BWithin
††O a
)
††a b
;
††b c
var
°° $
itemsWithoutMothMapped
°° "
=
°°# $
Mapper
°°% +
.
°°+ ,
Map
°°, /
<
°°/ 0
ICollection
°°0 ;
<
°°; <
InvoiceDetailDto
°°< L
>
°°L M
>
°°M N
(
°°N O!
itemsModel1BOutside
°°O b
)
°°b c
;
°°c d
await
££  
SendModel1BProcess
££  
(
££  !#
itemsWithinMothMapped
££! 6
,
££6 7$
itemsWithoutMothMapped
££8 N
,
££N O#
configuration1BMapped
££O d
,
££d e
points
££f l
,
££l m
endDate
££n u
,
££u v
starDate
££w 
,££ Ä)
listResultModel1BAccounts££Å ö
,££ö õ'
listResultModel1BProducts
§§ %
,
§§% &
KafkaTopics
•• 
.
•• !
ProcessModel1BTopic
•• +
)
••+ ,
;
••, -
}
¶¶ 
private
®® 
async
®® 
Task
®® 
ProcessModel3
®® $
(
®®$ % 
ModelConfiguration
®®% 7!
model3Configuration
®®8 K
,
®®K L
List
®®M Q
<
®®Q R
int
®®R U
>
®®U V
listAccounts
®®W c
)
®®c d
{
©© 
var
™™ "
configuration3Mapped
™™  
=
™™! "
Mapper
™™# )
.
™™) *
Map
™™* -
<
™™- .#
ModelConfigurationDto
™™. C
>
™™C D
(
™™D E!
model3Configuration
™™E X
)
™™X Y
;
™™Y Z
var
¨¨ 
starDate
¨¨ 
=
¨¨ 
new
¨¨ 
DateTime
¨¨ #
(
¨¨# $!
model3Configuration
¨¨$ 7
.
¨¨7 8
DateInit
¨¨8 @
.
¨¨@ A
Year
¨¨A E
,
¨¨E F!
model3Configuration
¨¨G Z
.
¨¨Z [
DateInit
¨¨[ c
.
¨¨c d
Month
¨¨d i
,
¨¨i j!
model3Configuration
¨¨k ~
.
¨¨~ 
DateInit¨¨ á
.¨¨á à
Day¨¨à ã
,¨¨ã å
$num
≠≠ 
,
≠≠ 
$num
≠≠ 
,
≠≠ 
$num
≠≠ 
)
≠≠ 
;
≠≠ 
var
ØØ 
endDate
ØØ 
=
ØØ 
new
ØØ 
DateTime
ØØ "
(
ØØ" #!
model3Configuration
ØØ# 6
.
ØØ6 7
DateEnd
ØØ7 >
.
ØØ> ?
Year
ØØ? C
,
ØØC D!
model3Configuration
ØØE X
.
ØØX Y
DateEnd
ØØY `
.
ØØ` a
Month
ØØa f
,
ØØf g!
model3Configuration
ØØh {
.
ØØ{ |
DateEndØØ| É
.ØØÉ Ñ
DayØØÑ á
,ØØá à
$numØØâ ã
,ØØã å
$num
∞∞ 
,
∞∞ 
$num
∞∞ 
)
∞∞ 
;
∞∞ 
var
≤≤ 
itemForModel3
≤≤ 
=
≤≤! "
await
≤≤# (
_walletRepository
≤≤) :
.
≤≤: ;.
 GetInvoicesDetailsItemsForModel3
≤≤; [
(
≤≤[ \
starDate
≤≤\ d
,
≤≤d e
endDate
≤≤f m
)
≤≤m n
;
≤≤n o
var
¥¥ 
accountsModel3
¥¥ 
=
¥¥ 
itemForModel3
¥¥ *
.
¥¥* +
Select
¥¥+ 1
(
¥¥1 2
x
¥¥2 3
=>
¥¥4 6
x
¥¥7 8
.
¥¥8 9
Invoice
¥¥9 @
.
¥¥@ A
AffiliateId
¥¥A L
)
¥¥L M
.
¥¥M N
Distinct
¥¥N V
(
¥¥V W
)
¥¥W X
.
¥¥X Y
ToArray
¥¥Y `
(
¥¥` a
)
¥¥a b
;
¥¥b c
var
µµ 
productsModel3
µµ 
=
µµ 
itemForModel3
µµ *
.
µµ* +
Select
µµ+ 1
(
µµ1 2
x
µµ2 3
=>
µµ4 6
x
µµ7 8
.
µµ8 9
	ProductId
µµ9 B
)
µµB C
.
µµC D
Distinct
µµD L
(
µµL M
)
µµM N
.
µµN O
ToArray
µµO V
(
µµV W
)
µµW X
;
µµX Y!
model3Configuration
∑∑ 
.
∑∑ 
Totals
∑∑ "
=
∑∑# $
itemForModel3
∑∑% 2
.
∑∑2 3
Count
∑∑3 8
;
∑∑8 9
await
∏∏ &
_configurationRepository
∏∏ &
.
∏∏& '!
UpdateConfiguration
∏∏' :
(
∏∏: ;!
model3Configuration
∏∏; N
)
∏∏N O
;
∏∏O P
var
∫∫ &
listResultModel3Products
∫∫ $
=
∫∫% &
await
∫∫' ,
GetListProducts
∫∫- <
(
∫∫< =
productsModel3
∫∫= K
)
∫∫K L
;
∫∫L M
var
ªª &
listResultModel3Accounts
ªª $
=
ªª% &
await
ªª' ,
GetListAccount
ªª- ;
(
ªª; <
accountsModel3
ªª< J
,
ªªJ K!
model3Configuration
ªªL _
)
ªª_ `
;
ªª` a
listAccounts
ºº 
.
ºº 
AddRange
ºº 
(
ºº 
accountsModel3
ºº ,
.
ºº, -
ToList
ºº- 3
(
ºº3 4
)
ºº4 5
)
ºº5 6
;
ºº6 7
var
ΩΩ !
itemForModel3Mapped
ΩΩ 
=
ΩΩ  !
Mapper
ΩΩ" (
.
ΩΩ( )
Map
ΩΩ) ,
<
ΩΩ, -
ICollection
ΩΩ- 8
<
ΩΩ8 9
InvoiceDetailDto
ΩΩ9 I
>
ΩΩI J
>
ΩΩJ K
(
ΩΩK L
itemForModel3
ΩΩL Y
)
ΩΩY Z
;
ΩΩZ [
await
øø 
SendModel3Process
øø 
(
øø  !
itemForModel3Mapped
øø  3
,
øø3 4"
configuration3Mapped
øø5 I
,
øøI J&
listResultModel3Accounts
øøK c
,
øøc d&
listResultModel3Products
øøe }
,
øø} ~
KafkaTopics
¿¿ 
.
¿¿  
ProcessModel3Topic
¿¿ *
)
¿¿* +
;
¿¿+ ,
}
¡¡ 
private
√√ 
Task
√√ 
SendModel2Process
√√ "
(
√√" #
ICollection
ƒƒ 
<
ƒƒ 
InvoiceDetailDto
ƒƒ $
>
ƒƒ$ %

itemWithIn
ƒƒ' 1
,
ƒƒ1 2
ICollection
≈≈ 
<
≈≈ 
InvoiceDetailDto
≈≈ $
>
≈≈$ %
itemWithOut
≈≈' 2
,
≈≈2 3#
ModelConfigurationDto
∆∆ 
configuration
∆∆' 4
,
∆∆4 5
decimal
«« 
?
«« 
points
««' -
,
««- .
DateTime
»» 
endDate
»»' .
,
»». /
DateTime
…… 
starDate
……' /
,
……/ 0
ICollection
   
<
   
UserModelResponse
   %
>
  % & 
listResultAccounts
  ' 9
,
  9 :
ICollection
ÀÀ 
<
ÀÀ 
ProductWalletDto
ÀÀ $
>
ÀÀ$ % 
listResultProducts
ÀÀ' 9
,
ÀÀ9 :
string
ÃÃ 
topic
ÃÃ' ,
)
ÃÃ, -
{
ÕÕ 
if
ŒŒ 

(
ŒŒ 

itemWithIn
ŒŒ 
is
ŒŒ 
{
ŒŒ 
Count
ŒŒ !
:
ŒŒ! "
>
ŒŒ# $
$num
ŒŒ% &
}
ŒŒ' (
)
ŒŒ( )
{
œœ 	
var
–– 
batchesSize
–– 
=
–– 
(
–– 
decimal
–– &
)
––& '

itemWithIn
––' 1
.
––1 2
Count
––2 7
/
––8 9
	Constants
––: C
.
––C D
Batches
––D K
;
––K L
for
““ 
(
““ 
var
““ 
i
““ 
=
““ 
$num
““ 
;
““ 
i
““ 
<
““ 
batchesSize
““  +
;
““+ ,
i
““- .
++
““. 0
)
““0 1
{
”” 
var
‘‘ 
packListPool
‘‘  
=
‘‘! "

itemWithIn
‘‘# -
.
‘‘- .
Skip
‘‘. 2
(
‘‘2 3
i
‘‘3 4
*
‘‘5 6
	Constants
‘‘7 @
.
‘‘@ A
Batches
‘‘A H
)
‘‘H I
.
‘‘I J
Take
‘‘J N
(
‘‘N O
	Constants
‘‘O X
.
‘‘X Y
Batches
‘‘Y `
)
‘‘` a
.
‘‘a b
ToList
‘‘b h
(
‘‘h i
)
‘‘i j
;
‘‘j k
var
’’ 
key
’’ 
=
’’! "
	Constants
’’# ,
.
’’, -
PartitionKeys
’’- :
[
’’: ;
i
’’; <
%
’’= >
$num
’’? @
]
’’@ A
;
’’A B
_
÷÷ 
=
÷÷ 
Task
÷÷ 
.
÷÷ 
Run
÷÷ 
(
÷÷ 
async
◊◊ 
(
◊◊ 
)
◊◊ 
=>
ÿÿ 
await
ÿÿ  
_kafkaProducer
ÿÿ! /
.
ÿÿ/ 0!
ProduceWithKeyAsync
ÿÿ0 C
(
ÿÿC D
topic
ÿÿD I
,
ÿÿI J
new
ÿÿK N
Model2Message
ÿÿO \
{
ŸŸ 
Configuration
⁄⁄ )
=
⁄⁄/ 0
configuration
⁄⁄1 >
,
⁄⁄> ?
ItemWithInMonth
€€ +
=
€€/ 0
packListPool
€€1 =
,
€€= >
Points
‹‹ "
=
‹‹/ 0
points
‹‹1 7
??
‹‹8 :
$num
‹‹; <
,
‹‹< =
EndDate
›› #
=
››/ 0
endDate
››1 8
,
››8 9
StarDate
ﬁﬁ $
=
ﬁﬁ/ 0
starDate
ﬁﬁ1 9
,
ﬁﬁ9 : 
ListResultAccounts
ﬂﬂ .
=
ﬂﬂ/ 0 
listResultAccounts
ﬂﬂ1 C
,
ﬂﬂC D 
ListResultProducts
‡‡ .
=
‡‡/ 0 
listResultProducts
‡‡1 C
}
·· 
,
·· 
key
·· 
)
·· 
)
··  
;
··  !
}
‚‚ 
}
„„ 	
if
‰‰ 

(
‰‰ 
itemWithOut
‰‰ 
is
‰‰ 
{
‰‰ 
Count
‰‰ "
:
‰‰" #
>
‰‰$ %
$num
‰‰& '
}
‰‰( )
)
‰‰) *
{
ÂÂ 	
var
ÊÊ 
batchesSize
ÊÊ 
=
ÊÊ 
(
ÊÊ 
decimal
ÊÊ &
)
ÊÊ& '
itemWithOut
ÊÊ' 2
.
ÊÊ2 3
Count
ÊÊ3 8
/
ÊÊ9 :
	Constants
ÊÊ; D
.
ÊÊD E
Batches
ÊÊE L
;
ÊÊL M
for
ËË 
(
ËË 
var
ËË 
i
ËË 
=
ËË 
$num
ËË 
;
ËË 
i
ËË 
<
ËË 
batchesSize
ËË  +
;
ËË+ ,
i
ËË- .
++
ËË. 0
)
ËË0 1
{
ÈÈ 
var
ÍÍ 
packListPool
ÍÍ  
=
ÍÍ! "
itemWithOut
ÍÍ# .
.
ÍÍ. /
Skip
ÍÍ/ 3
(
ÍÍ3 4
i
ÍÍ4 5
*
ÍÍ6 7
	Constants
ÍÍ8 A
.
ÍÍA B
Batches
ÍÍB I
)
ÍÍI J
.
ÍÍJ K
Take
ÍÍK O
(
ÍÍO P
	Constants
ÍÍP Y
.
ÍÍY Z
Batches
ÍÍZ a
)
ÍÍa b
.
ÍÍb c
ToList
ÍÍc i
(
ÍÍi j
)
ÍÍj k
;
ÍÍk l
var
ÎÎ 
key
ÎÎ 
=
ÎÎ! "
	Constants
ÎÎ# ,
.
ÎÎ, -
PartitionKeys
ÎÎ- :
[
ÎÎ: ;
i
ÎÎ; <
%
ÎÎ= >
$num
ÎÎ? @
]
ÎÎ@ A
;
ÎÎA B
_
ÏÏ 
=
ÏÏ 
Task
ÏÏ 
.
ÏÏ 
Run
ÏÏ 
(
ÏÏ 
async
ÌÌ 
(
ÌÌ 
)
ÌÌ 
=>
ÓÓ 
await
ÓÓ  
_kafkaProducer
ÓÓ! /
.
ÓÓ/ 0!
ProduceWithKeyAsync
ÓÓ0 C
(
ÓÓC D
topic
ÓÓD I
,
ÓÓI J
new
ÓÓK N
Model2Message
ÓÓO \
{
ÔÔ 
Configuration
 )
=
/ 0
configuration
1 >
,
> ?
ItemWithOutMonth
ÒÒ ,
=
ÒÒ0 1
packListPool
ÒÒ2 >
,
ÒÒ> ?
Points
ÚÚ "
=
ÚÚ/ 0
points
ÚÚ1 7
??
ÚÚ8 :
$num
ÚÚ; <
,
ÚÚ< =
EndDate
ÛÛ #
=
ÛÛ/ 0
endDate
ÛÛ1 8
,
ÛÛ8 9
StarDate
ÙÙ $
=
ÙÙ/ 0
starDate
ÙÙ1 9
,
ÙÙ9 : 
ListResultAccounts
ıı .
=
ıı/ 0 
listResultAccounts
ıı1 C
,
ııC D 
ListResultProducts
ˆˆ .
=
ˆˆ/ 0 
listResultProducts
ˆˆ1 C
}
˜˜ 
,
˜˜ 
key
˜˜ 
)
˜˜ 
)
˜˜  
;
˜˜  !
}
¯¯ 
}
˘˘ 	
return
˚˚ 
Task
˚˚ 
.
˚˚ 
CompletedTask
˚˚ !
;
˚˚! "
}
¸¸ 
private
˛˛ 
Task
˛˛  
SendModel1BProcess
˛˛ #
(
˛˛# $
ICollection
ˇˇ 
<
ˇˇ 
InvoiceDetailDto
ˇˇ $
>
ˇˇ$ %

itemWithIn
ˇˇ/ 9
,
ˇˇ9 :
ICollection
ÄÄ 
<
ÄÄ 
InvoiceDetailDto
ÄÄ $
>
ÄÄ$ %
itemWithOut
ÄÄ/ :
,
ÄÄ: ;#
ModelConfigurationDto
ÅÅ 
configuration
ÅÅ/ <
,
ÅÅ< =
decimal
ÇÇ 
?
ÇÇ 
points
ÇÇ/ 5
,
ÇÇ5 6
DateTime
ÉÉ 
endDate
ÉÉ/ 6
,
ÉÉ6 7
DateTime
ÑÑ 
starDate
ÑÑ/ 7
,
ÑÑ7 8
ICollection
ÖÖ 
<
ÖÖ 
UserModelResponse
ÖÖ %
>
ÖÖ% & 
listResultAccounts
ÖÖ/ A
,
ÖÖA B
ICollection
ÜÜ 
<
ÜÜ 
ProductWalletDto
ÜÜ $
>
ÜÜ$ % 
listResultProducts
ÜÜ/ A
,
ÜÜA B
string
áá 
topic
áá/ 4
)
áá4 5
{
àà 
if
ââ 

(
ââ 

itemWithIn
ââ 
is
ââ 
{
ââ 
Count
ââ !
:
ââ! "
>
ââ# $
$num
ââ% &
}
ââ' (
)
ââ( )
{
ää 	
var
ãã 
batchesSize
ãã 
=
ãã 
(
ãã 
decimal
ãã &
)
ãã& '

itemWithIn
ãã' 1
.
ãã1 2
Count
ãã2 7
/
ãã8 9
	Constants
ãã: C
.
ããC D
Batches
ããD K
;
ããK L
for
çç 
(
çç 
var
çç 
i
çç 
=
çç 
$num
çç 
;
çç 
i
çç 
<
çç 
batchesSize
çç  +
;
çç+ ,
i
çç- .
++
çç. 0
)
çç0 1
{
éé 
var
èè 
packListPool
èè  
=
èè! "

itemWithIn
èè# -
.
èè- .
Skip
èè. 2
(
èè2 3
i
èè3 4
*
èè5 6
	Constants
èè7 @
.
èè@ A
Batches
èèA H
)
èèH I
.
èèI J
Take
èèJ N
(
èèN O
	Constants
èèO X
.
èèX Y
Batches
èèY `
)
èè` a
.
èèa b
ToList
èèb h
(
èèh i
)
èèi j
;
èèj k
var
êê 
key
êê 
=
êê! "
	Constants
êê# ,
.
êê, -
PartitionKeys
êê- :
[
êê: ;
i
êê; <
%
êê= >
$num
êê? @
]
êê@ A
;
êêA B
_
ëë 
=
ëë 
Task
ëë 
.
ëë 
Run
ëë 
(
ëë 
async
íí 
(
íí 
)
íí 
=>
ìì 
await
ìì  
_kafkaProducer
ìì! /
.
ìì/ 0!
ProduceWithKeyAsync
ìì0 C
(
ììC D
topic
ììD I
,
ììI J
new
ììK N
Model1BMessage
ììO ]
{
îî 
Configuration
ïï )
=
ïï/ 0
configuration
ïï1 >
,
ïï> ?
ItemWithInMonth
ññ +
=
ññ/ 0
packListPool
ññ1 =
,
ññ= >
Points
óó "
=
óó/ 0
points
óó1 7
??
óó8 :
$num
óó; <
,
óó< =
EndDate
òò #
=
òò/ 0
endDate
òò1 8
,
òò8 9
StarDate
ôô $
=
ôô/ 0
starDate
ôô1 9
,
ôô9 : 
ListResultAccounts
öö .
=
öö/ 0 
listResultAccounts
öö1 C
,
ööC D 
ListResultProducts
õõ .
=
õõ/ 0 
listResultProducts
õõ1 C
}
úú 
,
úú 
key
úú 
)
úú 
)
úú  
;
úú  !
}
ùù 
}
ûû 	
if
üü 

(
üü 
itemWithOut
üü 
is
üü 
{
üü 
Count
üü "
:
üü" #
>
üü$ %
$num
üü& '
}
üü( )
)
üü) *
{
†† 	
var
°° 
batchesSize
°° 
=
°° 
(
°° 
decimal
°° &
)
°°& '
itemWithOut
°°' 2
.
°°2 3
Count
°°3 8
/
°°9 :
	Constants
°°; D
.
°°D E
Batches
°°E L
;
°°L M
for
££ 
(
££ 
var
££ 
i
££ 
=
££ 
$num
££ 
;
££ 
i
££ 
<
££ 
batchesSize
££  +
;
££+ ,
i
££- .
++
££. 0
)
££0 1
{
§§ 
var
•• 
packListPool
••  
=
••! "
itemWithOut
••# .
.
••. /
Skip
••/ 3
(
••3 4
i
••4 5
*
••6 7
	Constants
••8 A
.
••A B
Batches
••B I
)
••I J
.
••J K
Take
••K O
(
••O P
	Constants
••P Y
.
••Y Z
Batches
••Z a
)
••a b
.
••b c
ToList
••c i
(
••i j
)
••j k
;
••k l
var
¶¶ 
key
¶¶ 
=
¶¶! "
	Constants
¶¶# ,
.
¶¶, -
PartitionKeys
¶¶- :
[
¶¶: ;
i
¶¶; <
%
¶¶= >
$num
¶¶? @
]
¶¶@ A
;
¶¶A B
_
ßß 
=
ßß 
Task
ßß 
.
ßß 
Run
ßß 
(
ßß 
async
®® 
(
®® 
)
®® 
=>
©© 
await
©©  
_kafkaProducer
©©! /
.
©©/ 0!
ProduceWithKeyAsync
©©0 C
(
©©C D
topic
©©D I
,
©©I J
new
©©K N
Model1BMessage
©©O ]
{
™™ 
Configuration
´´ )
=
´´/ 0
configuration
´´1 >
,
´´> ?
ItemWithOutMonth
¨¨ ,
=
¨¨0 1
packListPool
¨¨2 >
,
¨¨> ?
Points
≠≠ "
=
≠≠/ 0
points
≠≠1 7
??
≠≠8 :
$num
≠≠; <
,
≠≠< =
EndDate
ÆÆ #
=
ÆÆ/ 0
endDate
ÆÆ1 8
,
ÆÆ8 9
StarDate
ØØ $
=
ØØ/ 0
starDate
ØØ1 9
,
ØØ9 : 
ListResultAccounts
∞∞ .
=
∞∞/ 0 
listResultAccounts
∞∞1 C
,
∞∞C D 
ListResultProducts
±± .
=
±±/ 0 
listResultProducts
±±1 C
}
≤≤ 
,
≤≤ 
key
≤≤ 
)
≤≤ 
)
≤≤  
;
≤≤  !
}
≥≥ 
}
¥¥ 	
return
∂∂ 
Task
∂∂ 
.
∂∂ 
CompletedTask
∂∂ !
;
∂∂! "
}
∑∑ 
private
∑∑	 
Task
∑∑  
SendModel1AProcess
∑∑ (
(
∑∑( )
ICollection
∏∏ 
<
∏∏ 
InvoiceDetailDto
∏∏ $
>
∏∏$ %

itemWithIn
∏∏/ 9
,
∏∏9 :
ICollection
ππ 
<
ππ 
InvoiceDetailDto
ππ $
>
ππ$ %
itemWithOut
ππ/ :
,
ππ: ;#
ModelConfigurationDto
∫∫ 
configuration
∫∫/ <
,
∫∫< =
decimal
ªª 
?
ªª 
points
ªª/ 5
,
ªª5 6
DateTime
ºº 
endDate
ºº/ 6
,
ºº6 7
DateTime
ΩΩ 
starDate
ΩΩ/ 7
,
ΩΩ7 8
ICollection
ææ 
<
ææ 
UserModelResponse
ææ %
>
ææ% & 
listResultAccounts
ææ/ A
,
ææA B
ICollection
øø 
<
øø 
ProductWalletDto
øø $
>
øø$ % 
listResultProducts
øø/ A
,
øøA B
string
¿¿ 
topic
¿¿/ 4
)
¿¿4 5
{
¡¡ 
if
¬¬ 

(
¬¬ 

itemWithIn
¬¬ 
is
¬¬ 
{
¬¬ 
Count
¬¬ !
:
¬¬! "
>
¬¬# $
$num
¬¬% &
}
¬¬' (
)
¬¬( )
{
√√ 	
var
ƒƒ 
batchesSize
ƒƒ 
=
ƒƒ 
(
ƒƒ 
decimal
ƒƒ &
)
ƒƒ& '

itemWithIn
ƒƒ' 1
.
ƒƒ1 2
Count
ƒƒ2 7
/
ƒƒ8 9
	Constants
ƒƒ: C
.
ƒƒC D
Batches
ƒƒD K
;
ƒƒK L
for
∆∆ 
(
∆∆ 
var
∆∆ 
i
∆∆ 
=
∆∆ 
$num
∆∆ 
;
∆∆ 
i
∆∆ 
<
∆∆ 
batchesSize
∆∆  +
;
∆∆+ ,
i
∆∆- .
++
∆∆. 0
)
∆∆0 1
{
«« 
var
»» 
packListPool
»»  
=
»»! "

itemWithIn
»»# -
.
»»- .
Skip
»». 2
(
»»2 3
i
»»3 4
*
»»5 6
	Constants
»»7 @
.
»»@ A
Batches
»»A H
)
»»H I
.
»»I J
Take
»»J N
(
»»N O
	Constants
»»O X
.
»»X Y
Batches
»»Y `
)
»»` a
.
»»a b
ToList
»»b h
(
»»h i
)
»»i j
;
»»j k
var
…… 
key
…… 
=
……! "
	Constants
……# ,
.
……, -
PartitionKeys
……- :
[
……: ;
i
……; <
%
……= >
$num
……? @
]
……@ A
;
……A B
_
   
=
   
Task
   
.
   
Run
   
(
   
async
ÀÀ 
(
ÀÀ 
)
ÀÀ 
=>
ÃÃ 
await
ÃÃ  
_kafkaProducer
ÃÃ! /
.
ÃÃ/ 0!
ProduceWithKeyAsync
ÃÃ0 C
(
ÃÃC D
topic
ÃÃD I
,
ÃÃI J
new
ÃÃK N
Model1AMessage
ÃÃO ]
{
ÕÕ 
Configuration
ŒŒ )
=
ŒŒ/ 0
configuration
ŒŒ1 >
,
ŒŒ> ?
ItemWithInMonth
œœ +
=
œœ/ 0
packListPool
œœ1 =
,
œœ= >
Points
–– "
=
––/ 0
points
––1 7
??
––8 :
$num
––; <
,
––< =
EndDate
—— #
=
——/ 0
endDate
——1 8
,
——8 9
StarDate
““ $
=
““/ 0
starDate
““1 9
,
““9 : 
ListResultAccounts
”” .
=
””/ 0 
listResultAccounts
””1 C
,
””C D 
ListResultProducts
‘‘ .
=
‘‘/ 0 
listResultProducts
‘‘1 C
}
’’ 
,
’’ 
key
’’ 
)
’’ 
)
’’  
;
’’  !
}
÷÷ 
}
◊◊ 	
if
ŸŸ 

(
ŸŸ 
itemWithOut
ŸŸ 
is
ŸŸ 
{
ŸŸ 
Count
ŸŸ "
:
ŸŸ" #
>
ŸŸ$ %
$num
ŸŸ& '
}
ŸŸ( )
)
ŸŸ) *
{
⁄⁄ 	
var
€€ 
batchesSize
€€ 
=
€€ 
(
€€ 
decimal
€€ &
)
€€& '
itemWithOut
€€' 2
.
€€2 3
Count
€€3 8
/
€€9 :
	Constants
€€; D
.
€€D E
Batches
€€E L
;
€€L M
for
›› 
(
›› 
var
›› 
i
›› 
=
›› 
$num
›› 
;
›› 
i
›› 
<
›› 
batchesSize
››  +
;
››+ ,
i
››- .
++
››. 0
)
››0 1
{
ﬁﬁ 
var
ﬂﬂ 
packListPool
ﬂﬂ  
=
ﬂﬂ! "
itemWithOut
ﬂﬂ# .
.
ﬂﬂ. /
Skip
ﬂﬂ/ 3
(
ﬂﬂ3 4
i
ﬂﬂ4 5
*
ﬂﬂ6 7
	Constants
ﬂﬂ8 A
.
ﬂﬂA B
Batches
ﬂﬂB I
)
ﬂﬂI J
.
ﬂﬂJ K
Take
ﬂﬂK O
(
ﬂﬂO P
	Constants
ﬂﬂP Y
.
ﬂﬂY Z
Batches
ﬂﬂZ a
)
ﬂﬂa b
.
ﬂﬂb c
ToList
ﬂﬂc i
(
ﬂﬂi j
)
ﬂﬂj k
;
ﬂﬂk l
var
‡‡ 
key
‡‡ 
=
‡‡! "
	Constants
‡‡# ,
.
‡‡, -
PartitionKeys
‡‡- :
[
‡‡: ;
i
‡‡; <
%
‡‡= >
$num
‡‡? @
]
‡‡@ A
;
‡‡A B
_
·· 
=
·· 
Task
·· 
.
·· 
Run
·· 
(
·· 
async
‚‚ 
(
‚‚ 
)
‚‚ 
=>
„„ 
await
„„  
_kafkaProducer
„„! /
.
„„/ 0!
ProduceWithKeyAsync
„„0 C
(
„„C D
topic
„„D I
,
„„I J
new
„„K N
Model1AMessage
„„O ]
{
‰‰ 
Configuration
ÂÂ )
=
ÂÂ/ 0
configuration
ÂÂ1 >
,
ÂÂ> ?
ItemWithOutMonth
ÊÊ ,
=
ÊÊ/ 0
packListPool
ÊÊ1 =
,
ÊÊ= >
Points
ÁÁ "
=
ÁÁ/ 0
points
ÁÁ1 7
??
ÁÁ8 :
$num
ÁÁ; <
,
ÁÁ< =
EndDate
ËË #
=
ËË/ 0
endDate
ËË1 8
,
ËË8 9
StarDate
ÈÈ $
=
ÈÈ/ 0
starDate
ÈÈ1 9
,
ÈÈ9 : 
ListResultAccounts
ÍÍ .
=
ÍÍ/ 0 
listResultAccounts
ÍÍ1 C
,
ÍÍC D 
ListResultProducts
ÎÎ .
=
ÎÎ/ 0 
listResultProducts
ÎÎ1 C
}
ÏÏ 
,
ÏÏ 
key
ÏÏ 
)
ÏÏ 
)
ÏÏ  
;
ÏÏ  !
}
ÌÌ 
}
ÓÓ 	
return
 
Task
 
.
 
CompletedTask
 !
;
! "
}
ÒÒ 
private
ÛÛ 
Task
ÛÛ 
SendModel3Process
ÛÛ "
(
ÛÛ" #
ICollection
ÙÙ 
<
ÙÙ 
InvoiceDetailDto
ÙÙ $
>
ÙÙ$ %
itemsModelTwo
ÙÙ0 =
,
ÙÙ= >#
ModelConfigurationDto
ıı 
configuration
ıı- :
,
ıı: ;
ICollection
ˆˆ 
<
ˆˆ 
UserModelResponse
ˆˆ %
>
ˆˆ% & 
listResultAccounts
ˆˆ' 9
,
ˆˆ9 :
ICollection
˜˜ 
<
˜˜ 
ProductWalletDto
˜˜ $
>
˜˜$ % 
listResultProducts
˜˜/ A
,
˜˜A B
string
¯¯ 
topic
¯¯/ 4
)
¯¯4 5
{
˘˘ 
var
˙˙ 
batchesSize
˙˙ 
=
˙˙ 
(
˙˙ 
decimal
˙˙ "
)
˙˙" #
itemsModelTwo
˙˙# 0
.
˙˙0 1
Count
˙˙1 6
/
˙˙7 8
	Constants
˙˙9 B
.
˙˙B C
Batches
˙˙C J
;
˙˙J K
for
¸¸ 
(
¸¸ 
var
¸¸ 
i
¸¸ 
=
¸¸ 
$num
¸¸ 
;
¸¸ 
i
¸¸ 
<
¸¸ 
batchesSize
¸¸ '
;
¸¸' (
i
¸¸) *
++
¸¸* ,
)
¸¸, -
{
˝˝ 	
var
˛˛ 
batchModelTwo
˛˛ 
=
˛˛ 
itemsModelTwo
˛˛  -
.
˛˛- .
Skip
˛˛. 2
(
˛˛2 3
i
˛˛3 4
*
˛˛5 6
	Constants
˛˛7 @
.
˛˛@ A
Batches
˛˛A H
)
˛˛H I
.
˛˛I J
Take
˛˛J N
(
˛˛N O
	Constants
˛˛O X
.
˛˛X Y
Batches
˛˛Y `
)
˛˛` a
.
˛˛a b
ToList
˛˛b h
(
˛˛h i
)
˛˛i j
;
˛˛j k
var
ˇˇ 
key
ˇˇ 
=
ˇˇ 
	Constants
ˇˇ (
.
ˇˇ( )
PartitionKeys
ˇˇ) 6
[
ˇˇ6 7
i
ˇˇ7 8
%
ˇˇ9 :
$num
ˇˇ; <
]
ˇˇ< =
;
ˇˇ= >
_
ÄÄ 
=
ÄÄ 
Task
ÄÄ 
.
ÄÄ 
Run
ÄÄ 
(
ÄÄ 
async
ÅÅ 
(
ÅÅ 
)
ÅÅ 
=>
ÇÇ 
await
ÇÇ 
_kafkaProducer
ÇÇ +
.
ÇÇ+ ,!
ProduceWithKeyAsync
ÇÇ, ?
(
ÇÇ? @
topic
ÇÇ@ E
,
ÇÇE F
new
ÇÇG J
Model3Message
ÇÇK X
(
ÇÇX Y
)
ÇÇY Z
{
ÉÉ 
EducatedCourses
ÑÑ '
=
ÑÑ+ ,
batchModelTwo
ÑÑ- :
,
ÑÑ: ;
Configuration
ÖÖ %
=
ÖÖ+ ,
configuration
ÖÖ- :
,
ÖÖ: ; 
ListResultAccounts
ÜÜ *
=
ÜÜ+ , 
listResultAccounts
ÜÜ- ?
,
ÜÜ? @ 
ListResultProducts
áá *
=
áá+ , 
listResultProducts
áá- ?
}
àà 
,
àà 
key
àà 
)
àà 
)
àà 
;
àà 
}
ââ 	
return
ãã 
Task
ãã 
.
ãã 
CompletedTask
ãã !
;
ãã! "
}
åå 
private
èè 
async
èè 
Task
èè 
<
èè 
ICollection
èè "
<
èè" #
UserModelResponse
èè# 4
>
èè4 5
>
èè5 6
GetListAccount
èè7 E
(
èèE F!
IReadOnlyCollection
êê 
<
êê 
int
êê 
>
êê  
accounts
êê! )
,
êê) * 
ModelConfiguration
ëë 
configuration
ëë ,
)
ëë, -
{
íí 
const
ìì 
int
ìì 
limit
ìì 
=
ìì! "
$num
ìì# &
;
ìì& '
var
îî 
batchesAccount
îî  
=
îî! "
(
îî# $
decimal
îî$ +
)
îî+ ,
accounts
îî, 4
.
îî4 5
Count
îî5 :
/
îî; <
limit
îî= B
;
îîB C
var
ññ  
listResultAccounts
ññ 
=
ññ  
new
ññ! $
List
ññ% )
<
ññ) *
UserModelResponse
ññ* ;
>
ññ; <
(
ññ< =
)
ññ= >
;
ññ> ?
for
òò 
(
òò 
var
òò 
i
òò 
=
òò 
$num
òò 
;
òò 
i
òò 
<
òò 
batchesAccount
òò *
;
òò* +
i
òò, -
++
òò- /
)
òò/ 0
{
ôô 	
try
öö 
{
õõ 
var
úú 
	batchList
úú 
=
úú 
accounts
úú  (
.
úú( )
Skip
úú) -
(
úú- .
i
úú. /
*
úú0 1
limit
úú2 7
)
úú7 8
.
úú8 9
Take
úú9 =
(
úú= >
limit
úú> C
)
úúC D
.
úúD E
ToArray
úúE L
(
úúL M
)
úúM N
;
úúN O
var
ùù 
accountResponse
ùù #
=
ùù$ %
await
ùù& +$
_accountServiceAdapter
ùù, B
.
ûû "
GetAccountsToEcoPool
ûû )
(
ûû) *
	batchList
ûû* 3
,
ûû3 4
configuration
ûû5 B
.
ûûB C&
ModelConfigurationLevels
ûûC [
.
ûû[ \
Count
ûû\ a
,
ûûa b
_brandService
ûûb o
.
ûûo p
BrandId
ûûp w
)
ûûw x
;
ûûx y
if
†† 
(
†† 
!
†† 
accountResponse
†† $
.
††$ %
IsSuccessful
††% 1
)
††1 2
continue
°° 
;
°° 
if
££ 
(
££ 
accountResponse
££ #
.
££# $
Content
££$ +
is
££, .
null
££/ 3
)
££3 4
continue
§§ 
;
§§ 
var
¶¶ 
response
¶¶ 
=
¶¶ 

Newtonsoft
¶¶ )
.
¶¶) *
Json
¶¶* .
.
¶¶. /
JsonConvert
¶¶/ :
.
¶¶: ;
DeserializeObject
¶¶; L
<
¶¶L M(
GetAccountsEcoPoolResponse
¶¶M g
>
¶¶g h
(
¶¶h i
accountResponse
¶¶i x
.
¶¶x y
Content¶¶y Ä
)¶¶Ä Å
;¶¶Å Ç 
listResultAccounts
®® "
.
®®" #
AddRange
®®# +
(
®®+ ,
response
®®, 4
!
®®4 5
.
®®5 6
data
®®6 :
)
®®: ;
;
®®; <
}
©© 
catch
™™ 
(
™™ 
	Exception
™™ 
e
™™ 
)
™™ 
{
´´ 
Console
¨¨ 
.
¨¨ 
	WriteLine
¨¨ !
(
¨¨! "
e
¨¨" #
)
¨¨# $
;
¨¨$ %
throw
≠≠ 
;
≠≠ 
}
ÆÆ 
}
ØØ 	
return
±±  
listResultAccounts
±± !
;
±±! "
}
≤≤ 
private
¥¥ 
async
¥¥ 
Task
¥¥ 
<
¥¥ 
ICollection
¥¥ "
<
¥¥" #
ProductWalletDto
¥¥# 3
>
¥¥3 4
>
¥¥4 5
GetListProducts
¥¥6 E
(
¥¥E F!
IReadOnlyCollection
µµ 
<
µµ 
int
µµ 
>
µµ  
products
µµ! )
)
µµ) *
{
∂∂ 
const
∑∑ 
int
∑∑ 
limit
∑∑ 
=
∑∑! "
$num
∑∑# &
;
∑∑& '
var
∏∏ 
batchesProduct
∏∏  
=
∏∏! "
(
∏∏# $
decimal
∏∏$ +
)
∏∏+ ,
products
∏∏, 4
.
∏∏4 5
Count
∏∏5 :
/
∏∏; <
limit
∏∏= B
;
∏∏B C
var
∫∫  
listResultProducts
∫∫ 
=
∫∫  
new
∫∫! $
List
∫∫% )
<
∫∫) *
ProductWalletDto
∫∫* :
>
∫∫: ;
(
∫∫; <
)
∫∫< =
;
∫∫= >
for
ºº 
(
ºº 
var
ºº 
i
ºº 
=
ºº 
$num
ºº 
;
ºº 
i
ºº 
<
ºº 
batchesProduct
ºº *
;
ºº* +
i
ºº, -
++
ºº- /
)
ºº/ 0
{
ΩΩ 	
var
ææ 
	batchList
ææ 
=
ææ  !
products
ææ" *
.
ææ* +
Skip
ææ+ /
(
ææ/ 0
i
ææ0 1
*
ææ2 3
limit
ææ4 9
)
ææ9 :
.
ææ: ;
Take
ææ; ?
(
ææ? @
limit
ææ@ E
)
ææE F
.
ææF G
ToArray
ææG N
(
ææN O
)
ææO P
;
ææP Q
var
øø 
productResponse
øø 
=
øø  !
await
øø" '&
_inventoryServiceAdapter
øø( @
.
øø@ A
GetProductsIds
øøA O
(
øøO P
	batchList
øøP Y
,
øøY Z
_brandService
øøZ g
.
øøg h
BrandId
øøh o
)
øøo p
;
øøp q
if
¡¡ 
(
¡¡ 
!
¡¡ 
productResponse
¡¡  
.
¡¡  !
IsSuccessful
¡¡! -
)
¡¡- .
continue
¬¬ 
;
¬¬ 
var
ƒƒ 
response
ƒƒ 
=
ƒƒ 
productResponse
ƒƒ *
.
ƒƒ* +
Content
ƒƒ+ 2
!
ƒƒ2 3
.
ƒƒ3 4
ToJsonObject
ƒƒ4 @
<
ƒƒ@ A
ProductsResponse
ƒƒA Q
>
ƒƒQ R
(
ƒƒR S
)
ƒƒS T
;
ƒƒT U 
listResultProducts
≈≈ 
.
≈≈ 
AddRange
≈≈ '
(
≈≈' (
response
≈≈( 0
!
≈≈0 1
.
≈≈1 2
Data
≈≈2 6
)
≈≈6 7
;
≈≈7 8
}
∆∆ 	
return
»»  
listResultProducts
»» !
;
»»! "
}
…… 
public
ÀÀ 

Task
ÀÀ "
ExecuteSecondProcess
ÀÀ $
(
ÀÀ$ %
)
ÀÀ% &
{
ÃÃ 
_
ÕÕ 	
=
ÕÕ
 
Task
ÕÕ 
.
ÕÕ 
Run
ÕÕ 
(
ÕÕ 
async
ÕÕ 
(
ÕÕ 
)
ÕÕ 
=>
ŒŒ 
await
ŒŒ 
_kafkaProducer
ŒŒ '
.
ŒŒ' (
ProduceAsync
ŒŒ( 4
(
ŒŒ4 5
KafkaTopics
ŒŒ5 @
.
ŒŒ@ A.
 ProcessPaymentModelTwoThreeTopic
ŒŒA a
,
ŒŒa b
string
ŒŒc i
.
ŒŒi j
Empty
ŒŒj o
)
ŒŒo p
)
ŒŒp q
;
ŒŒq r
return
œœ 
Task
œœ 
.
œœ 
CompletedTask
œœ !
;
œœ! "
}
–– 
}—— ˇÒ
MC:\HeroSystem\walletService\WalletService.Core\Services\RecyCoinPdfService.cs
	namespace

 	
WalletService


 
.

 
Core

 
.

 
Services

 %
;

% &
public 
class 
RecyCoinPdfService 
:  !
IRecyCoinPdfService" 5
{ 
public 

async 
Task 
< 
byte 
[ 
] 
> 
GenerateInvoice -
(- .
UserInfoResponse. >
userInfo? G
,G H#
DebitTransactionRequestI `
invoicea h
,h i
InvoicesSpResponsej |

spResponse	} á
)
á à
{ 
var 
date 
= 
DateTime 
. 
Now 
.  
ToString  (
(( )
$str) 5
)5 6
;6 7
var 
totalTax 
= 
$num 
; 
var 
subTotal 
= 
$num 
; 
var 
totalDiscount 
= 
$num 
; 
var 
workingDirectory 
= 
Path #
.# $
GetDirectoryName$ 4
(4 5
Assembly5 =
.= > 
GetExecutingAssembly> R
(R S
)S T
.T U
LocationU ]
)] ^
;^ _
var 
	separator 
= 
Path 
. "
DirectorySeparatorChar 3
;3 4
var 
pathFile 
= 
$" 
{ 
workingDirectory *
}* +
{+ ,
	separator, 5
}5 6
$str6 <
{< =
	separator= F
}F G
$strG T
"T U
;U V
return 
await 
Task 
. 
Run 
( 
( 
)  
=>! #
{ 	
var 
document 
= 
Document #
. 
Create 
( 
doc 
=> 
{ 
doc 
. 
Page 
( 
page !
=>" $
{ 
page 
. 
Margin #
(# $
$num$ &
)& '
;' (
page   
.   
	PageColor   &
(  & '
$str  ' 0
)  0 1
;  1 2
page"" 
."" 
Header"" #
(""# $
)""$ %
.""% &
ShowOnce""& .
("". /
)""/ 0
.""0 1
Row""1 4
(""4 5
row""5 8
=>""9 ;
{## 
var$$ 
image$$  %
=$$& '
Image$$( -
.$$- .
FromFile$$. 6
($$6 7
pathFile$$7 ?
)$$? @
;$$@ A
row%% 
.%%  
ConstantItem%%  ,
(%%, -
$num%%- 0
)%%0 1
.%%1 2
	Container%%2 ;
(%%; <
)%%< =
.%%= >
Image%%> C
(%%C D
image%%D I
)%%I J
;%%J K
row'' 
.''  
RelativeItem''  ,
('', -
)''- .
.''. /
Column''/ 5
(''5 6
col''6 9
=>'': <
{(( 
col))  #
.))# $
Item))$ (
())( )
)))) *
.))* +

AlignRight))+ 5
())5 6
)))6 7
.**$ %

Background**% /
(**/ 0
$str**0 9
)**9 :
.++$ %
Padding++% ,
(++, -
$num++- /
)++/ 0
.++0 1
Border++1 7
(++7 8
$num++8 9
)++9 :
.++: ;
BorderColor++; F
(++F G
$str++G P
)++P Q
.,,$ %
AlignCenter,,% 0
(,,0 1
),,1 2
.--$ %
Text--% )
(--) *
$"--* ,
$str--, 4
{--4 5

spResponse--5 ?
.--? @
Id--@ B
}--B C
"--C D
)--D E
...$ %
	FontColor..% .
(... /
$str../ 8
)..8 9
;..9 :
col00  #
.00# $
Item00$ (
(00( )
)00) *
.00* +

AlignRight00+ 5
(005 6
)006 7
.007 8
Text008 <
(00< =
$str00= g
)00g h
.11$ %
	FontColor11% .
(11. /
$str11/ 8
)118 9
.119 :
FontSize11: B
(11B C
$num11C E
)11E F
;11F G
col22  #
.22# $
Item22$ (
(22( )
)22) *
.22* +

AlignRight22+ 5
(225 6
)226 7
.227 8
Text228 <
(22< =
$str22= R
)22R S
.22S T
	FontColor22T ]
(22] ^
$str22^ g
)22g h
.22h i
FontSize22i q
(22q r
$num22r t
)22t u
;22u v
col33  #
.33# $
Item33$ (
(33( )
)33) *
.33* +

AlignRight33+ 5
(335 6
)336 7
.44$ %
Text44% )
(44) *
$str55( y
)55y z
.66$ %
	FontColor66% .
(66. /
$str66/ 8
)668 9
.669 :
FontSize66: B
(66B C
$num66C E
)66E F
;66F G
col77  #
.77# $
Item77$ (
(77( )
)77) *
.77* +

AlignRight77+ 5
(775 6
)776 7
.777 8
Text778 <
(77< =
$str77= S
)77S T
.77T U
	FontColor77U ^
(77^ _
$str77_ h
)77h i
.77i j
FontSize77j r
(77r s
$num77s u
)77u v
;77v w
col88  #
.88# $
Item88$ (
(88( )
)88) *
.88* +

AlignRight88+ 5
(885 6
)886 7
.887 8
Text888 <
(88< =
$str88= [
)88[ \
.88\ ]
	FontColor88] f
(88f g
$str88g p
)88p q
.99$ %
FontSize99% -
(99- .
$num99. 0
)990 1
;991 2
col::  #
.::# $
Item::$ (
(::( )
)::) *
.::* +

AlignRight::+ 5
(::5 6
)::6 7
.::7 8
Text::8 <
(::< =
date::= A
)::A B
.::B C
	FontColor::C L
(::L M
$str::M V
)::V W
.::W X
FontSize::X `
(::` a
$num::a c
)::c d
;::d e
};; 
);; 
;;; 
}<< 
)<< 
;<< 
page>> 
.>> 
Content>> $
(>>$ %
)>>% &
.>>& '
PaddingVertical>>' 6
(>>6 7
$num>>7 9
)>>9 :
.>>: ;
Column>>; A
(>>A B
col1>>B F
=>>>G I
{?? 
col1@@  
.@@  !
Item@@! %
(@@% &
)@@& '
.@@' (

PaddingTop@@( 2
(@@2 3
$num@@3 5
)@@5 6
.@@6 7
Row@@7 :
(@@: ;
row@@; >
=>@@? A
{AA 
rowBB  #
.BB# $
RelativeItemBB$ 0
(BB0 1
)BB1 2
.BB2 3
ColumnBB3 9
(BB9 :
col2BB: >
=>BB? A
{CC  !
col2DD$ (
.DD( )
ItemDD) -
(DD- .
)DD. /
.DD/ 0
	AlignLeftDD0 9
(DD9 :
)DD: ;
.DD; <
TextDD< @
(DD@ A
$strDDA T
)DDT U
.DDU V
	UnderlineDDV _
(DD_ `
)DD` a
.DDa b
BoldDDb f
(DDf g
)DDg h
.EE( )
	FontColorEE) 2
(EE2 3
$strEE3 <
)EE< =
;EE= >
col2GG$ (
.GG( )
ItemGG) -
(GG- .
)GG. /
.GG/ 0
TextGG0 4
(GG4 5
txtGG5 8
=>GG9 ;
{HH$ %
txtII( +
.II+ ,
SpanII, 0
(II0 1
$strII1 ;
)II; <
.II< =
SemiBoldII= E
(IIE F
)IIF G
.IIG H
FontSizeIIH P
(IIP Q
$numIIQ S
)IIS T
.IIT U
	FontColorIIU ^
(II^ _
$strII_ h
)IIh i
;IIi j
txtJJ( +
.JJ+ ,
SpanJJ, 0
(JJ0 1
$"JJ1 3
{JJ3 4
userInfoJJ4 <
.JJ< =
NameJJ= A
}JJA B
$strJJB C
{JJC D
userInfoJJD L
.JJL M
LastNameJJM U
}JJU V
"JJV W
)JJW X
.JJX Y
	FontColorJJY b
(JJb c
$strJJc l
)JJl m
.KK, -
FontSizeKK- 5
(KK5 6
$numKK6 8
)KK8 9
;KK9 :
}LL$ %
)LL% &
;LL& '
col2NN$ (
.NN( )
ItemNN) -
(NN- .
)NN. /
.NN/ 0
TextNN0 4
(NN4 5
txtNN5 8
=>NN9 ;
{OO$ %
txtPP( +
.PP+ ,
SpanPP, 0
(PP0 1
$strPP1 9
)PP9 :
.PP: ;
SemiBoldPP; C
(PPC D
)PPD E
.PPE F
FontSizePPF N
(PPN O
$numPPO Q
)PPQ R
.PPR S
	FontColorPPS \
(PP\ ]
$strPP] f
)PPf g
;PPg h
txtQQ( +
.QQ+ ,
SpanQQ, 0
(QQ0 1
userInfoQQ1 9
.QQ9 :
CountryQQ: A
!QQA B
.QQB C
NameQQC G
)QQG H
.QQH I
	FontColorQQI R
(QQR S
$strQQS \
)QQ\ ]
.QQ] ^
FontSizeQQ^ f
(QQf g
$numQQg i
)QQi j
;QQj k
}RR$ %
)RR% &
;RR& '
col2TT$ (
.TT( )
ItemTT) -
(TT- .
)TT. /
.TT/ 0
TextTT0 4
(TT4 5
txtTT5 8
=>TT9 ;
{UU$ %
txtVV( +
.VV+ ,
SpanVV, 0
(VV0 1
$strVV1 ;
)VV; <
.VV< =
SemiBoldVV= E
(VVE F
)VVF G
.VVG H
FontSizeVVH P
(VVP Q
$numVVQ S
)VVS T
.VVT U
	FontColorVVU ^
(VV^ _
$strVV_ h
)VVh i
;VVi j
txtWW( +
.WW+ ,
SpanWW, 0
(WW0 1
userInfoWW1 9
.WW9 :
CityWW: >
)WW> ?
.WW? @
	FontColorWW@ I
(WWI J
$strWWJ S
)WWS T
.WWT U
FontSizeWWU ]
(WW] ^
$numWW^ `
)WW` a
;WWa b
}XX$ %
)XX% &
;XX& '
}YY  !
)YY! "
;YY" #
row[[  #
.[[# $
RelativeItem[[$ 0
([[0 1
)[[1 2
.[[2 3
Column[[3 9
([[9 :
col2[[: >
=>[[? A
{\\  !
col2]]$ (
.]]( )
Item]]) -
(]]- .
)]]. /
.]]/ 0

AlignRight]]0 :
(]]: ;
)]]; <
.]]< =
Text]]= A
(]]A B
txt]]B E
=>]]F H
{^^$ %
txt__( +
.__+ ,
Span__, 0
(__0 1
$str__1 <
)__< =
.__= >
SemiBold__> F
(__F G
)__G H
.__H I
FontSize__I Q
(__Q R
$num__R T
)__T U
.__U V
	FontColor__V _
(___ `
$str__` i
)__i j
;__j k
txt``( +
.``+ ,
Span``, 0
(``0 1
userInfo``1 9
.``9 :
Phone``: ?
)``? @
.``@ A
	FontColor``A J
(``J K
$str``K T
)``T U
.``U V
FontSize``V ^
(``^ _
$num``_ a
)``a b
;``b c
}aa$ %
)aa% &
;aa& '
col2cc$ (
.cc( )
Itemcc) -
(cc- .
)cc. /
.cc/ 0

AlignRightcc0 :
(cc: ;
)cc; <
.cc< =
Textcc= A
(ccA B
txtccB E
=>ccF H
{dd$ %
txtee( +
.ee+ ,
Spanee, 0
(ee0 1
$stree1 O
)eeO P
.eeP Q
SemiBoldeeQ Y
(eeY Z
)eeZ [
.ee[ \
FontSizeee\ d
(eed e
$numeee g
)eeg h
.ff, -
	FontColorff- 6
(ff6 7
$strff7 @
)ff@ A
;ffA B
txtgg( +
.gg+ ,
Spangg, 0
(gg0 1
userInfogg1 9
.gg9 :
UserNamegg: B
)ggB C
.ggC D
	FontColorggD M
(ggM N
$strggN W
)ggW X
.ggX Y
FontSizeggY a
(gga b
$numggb d
)ggd e
;gge f
}hh$ %
)hh% &
;hh& '
col2jj$ (
.jj( )
Itemjj) -
(jj- .
)jj. /
.jj/ 0

AlignRightjj0 :
(jj: ;
)jj; <
.jj< =
Textjj= A
(jjA B
txtjjB E
=>jjF H
{kk$ %
txtll( +
.ll+ ,
Spanll, 0
(ll0 1
$strll1 :
)ll: ;
.ll; <
SemiBoldll< D
(llD E
)llE F
.llF G
FontSizellG O
(llO P
$numllP R
)llR S
.llS T
	FontColorllT ]
(ll] ^
$strll^ g
)llg h
;llh i
txtmm( +
.mm+ ,
Spanmm, 0
(mm0 1
userInfomm1 9
.mm9 :
Emailmm: ?
)mm? @
.mm@ A
	FontColormmA J
(mmJ K
$strmmK T
)mmT U
.mmU V
FontSizemmV ^
(mm^ _
$nummm_ a
)mma b
;mmb c
}nn$ %
)nn% &
;nn& '
col2pp$ (
.pp( )
Itempp) -
(pp- .
)pp. /
.pp/ 0

AlignRightpp0 :
(pp: ;
)pp; <
.pp< =
Textpp= A
(ppA B
txtppB E
=>ppF H
{qq$ %
txtrr( +
.rr+ ,
Spanrr, 0
(rr0 1
$strrr1 >
)rr> ?
.rr? @
SemiBoldrr@ H
(rrH I
)rrI J
.rrJ K
FontSizerrK S
(rrS T
$numrrT V
)rrV W
.rrW X
	FontColorrrX a
(rra b
$strrrb k
)rrk l
;rrl m
txtss( +
.ss+ ,
Spanss, 0
(ss0 1
userInfoss1 9
.ss9 :
Addressss: A
)ssA B
.ssB C
	FontColorssC L
(ssL M
$strssM V
)ssV W
.ssW X
FontSizessX `
(ss` a
$numssa c
)ssc d
;ssd e
}tt$ %
)tt% &
;tt& '
col2vv$ (
.vv( )
Itemvv) -
(vv- .
)vv. /
.vv/ 0

AlignRightvv0 :
(vv: ;
)vv; <
.vv< =
Textvv= A
(vvA B
txtvvB E
=>vvF H
{ww$ %
ifxx( *
(xx+ ,
!xx, -
stringxx- 3
.xx3 4
IsNullOrEmptyxx4 A
(xxA B

spResponsexxB L
.xxL M
ReasonxxM S
)xxS T
)xxT U
{yy( )
txtzz, /
.zz/ 0
Spanzz0 4
(zz4 5
$strzz5 B
)zzB C
.zzC D
SemiBoldzzD L
(zzL M
)zzM N
.zzN O
FontSizezzO W
(zzW X
$numzzX Z
)zzZ [
.zz[ \
	FontColorzz\ e
(zze f
$strzzf o
)zzo p
;zzp q
txt{{, /
.{{/ 0
Span{{0 4
({{4 5

spResponse{{5 ?
.{{? @
Reason{{@ F
){{F G
.{{G H
	FontColor{{H Q
({{Q R
$str{{R [
){{[ \
.{{\ ]
FontSize{{] e
({{e f
$num{{f h
){{h i
;{{i j
}||( )
}}}$ %
)}}% &
;}}& '
}~~  !
)~~! "
;~~" #
} 
) 
; 
col1
ÅÅ  
.
ÅÅ  !
Item
ÅÅ! %
(
ÅÅ% &
)
ÅÅ& '
.
ÅÅ' (
LineHorizontal
ÅÅ( 6
(
ÅÅ6 7
$num
ÅÅ7 ;
)
ÅÅ; <
.
ÅÅ< =
	LineColor
ÅÅ= F
(
ÅÅF G
$str
ÅÅG P
)
ÅÅP Q
;
ÅÅQ R
col1
ÉÉ  
.
ÉÉ  !
Item
ÉÉ! %
(
ÉÉ% &
)
ÉÉ& '
.
ÉÉ' (
Table
ÉÉ( -
(
ÉÉ- .
tabla
ÉÉ. 3
=>
ÉÉ4 6
{
ÑÑ 
tabla
ÖÖ  %
.
ÖÖ% &
ColumnsDefinition
ÖÖ& 7
(
ÖÖ7 8
columns
ÖÖ8 ?
=>
ÖÖ@ B
{
ÜÜ  !
columns
áá$ +
.
áá+ ,
RelativeColumn
áá, :
(
áá: ;
$num
áá; <
)
áá< =
;
áá= >
columns
àà$ +
.
àà+ ,
RelativeColumn
àà, :
(
àà: ;
)
àà; <
;
àà< =
columns
ââ$ +
.
ââ+ ,
RelativeColumn
ââ, :
(
ââ: ;
)
ââ; <
;
ââ< =
columns
ää$ +
.
ää+ ,
RelativeColumn
ää, :
(
ää: ;
)
ää; <
;
ää< =
columns
ãã$ +
.
ãã+ ,
RelativeColumn
ãã, :
(
ãã: ;
)
ãã; <
;
ãã< =
}
åå  !
)
åå! "
;
åå" #
tabla
éé  %
.
éé% &
Header
éé& ,
(
éé, -
header
éé- 3
=>
éé4 6
{
èè  !
header
êê$ *
.
êê* +
Cell
êê+ /
(
êê/ 0
)
êê0 1
.
êê1 2

Background
êê2 <
(
êê< =
$str
êê= F
)
êêF G
.
êêG H
Padding
êêH O
(
êêO P
$num
êêP Q
)
êêQ R
.
êêR S
Text
êêS W
(
êêW X
$str
êêX b
)
êêb c
.
ëë( )
	FontColor
ëë) 2
(
ëë2 3
$str
ëë3 <
)
ëë< =
;
ëë= >
header
íí$ *
.
íí* +
Cell
íí+ /
(
íí/ 0
)
íí0 1
.
íí1 2

Background
íí2 <
(
íí< =
$str
íí= F
)
ííF G
.
ííG H
Padding
ííH O
(
ííO P
$num
ííP Q
)
ííQ R
.
ííR S
Text
ííS W
(
ííW X
$str
ííX b
)
ííb c
.
ìì( )
	FontColor
ìì) 2
(
ìì2 3
$str
ìì3 <
)
ìì< =
;
ìì= >
header
îî$ *
.
îî* +
Cell
îî+ /
(
îî/ 0
)
îî0 1
.
îî1 2

Background
îî2 <
(
îî< =
$str
îî= F
)
îîF G
.
îîG H
Padding
îîH O
(
îîO P
$num
îîP Q
)
îîQ R
.
îîR S
Text
îîS W
(
îîW X
$str
îîX `
)
îî` a
.
ïï( )
	FontColor
ïï) 2
(
ïï2 3
$str
ïï3 <
)
ïï< =
;
ïï= >
header
ññ$ *
.
ññ* +
Cell
ññ+ /
(
ññ/ 0
)
ññ0 1
.
ññ1 2

Background
ññ2 <
(
ññ< =
$str
ññ= F
)
ññF G
.
ññG H
Padding
ññH O
(
ññO P
$num
ññP Q
)
ññQ R
.
ññR S
Text
ññS W
(
ññW X
$str
ññX c
)
ññc d
.
óó( )
	FontColor
óó) 2
(
óó2 3
$str
óó3 <
)
óó< =
;
óó= >
header
òò$ *
.
òò* +
Cell
òò+ /
(
òò/ 0
)
òò0 1
.
òò1 2

Background
òò2 <
(
òò< =
$str
òò= F
)
òòF G
.
òòG H
Padding
òòH O
(
òòO P
$num
òòP Q
)
òòQ R
.
òòR S
Text
òòS W
(
òòW X
$str
òòX _
)
òò_ `
.
ôô( )
	FontColor
ôô) 2
(
ôô2 3
$str
ôô3 <
)
ôô< =
;
ôô= >
}
öö  !
)
öö! "
;
öö" #
foreach
úú  '
(
úú( )
var
úú) ,
item
úú- 1
in
úú2 4
invoice
úú5 <
.
úú< =
invoices
úú= E
)
úúE F
{
ùù  !
var
ûû$ '
conceptName
ûû( 3
=
ûû4 5
item
ûû6 :
.
ûû: ;
ProductName
ûû; F
;
ûûF G
var
üü$ '
quantity
üü( 0
=
üü1 2
item
üü3 7
.
üü7 8
ProductQuantity
üü8 G
;
üüG H
var
††$ '
price
††( -
=
††. /
item
††0 4
.
††4 5
ProductPrice
††5 A
;
††A B
var
°°$ '
tax
°°( +
=
°°, -
item
°°. 2
.
°°2 3

ProductIva
°°3 =
;
°°= >
var
¢¢$ '
discount
¢¢( 0
=
¢¢1 2
item
¢¢3 7
.
¢¢7 8
ProductDiscount
¢¢8 G
*
¢¢H I
quantity
¢¢J R
;
¢¢R S
var
££$ '
total
££( -
=
££. /
quantity
££0 8
*
££9 :
price
££; @
;
££@ A
tabla
••$ )
.
••) *
Cell
••* .
(
••. /
)
••/ 0
.
••0 1
BorderBottom
••1 =
(
••= >
$num
••> B
)
••B C
.
••C D
BorderColor
••D O
(
••O P
$str
••P Y
)
••Y Z
.
••Z [
Padding
••[ b
(
••b c
$num
••c d
)
••d e
.
¶¶( )
Text
¶¶) -
(
¶¶- .
conceptName
¶¶. 9
)
¶¶9 :
.
¶¶: ;
	FontColor
¶¶; D
(
¶¶D E
$str
¶¶E N
)
¶¶N O
.
¶¶O P
FontSize
¶¶P X
(
¶¶X Y
$num
¶¶Y [
)
¶¶[ \
;
¶¶\ ]
tabla
ßß$ )
.
ßß) *
Cell
ßß* .
(
ßß. /
)
ßß/ 0
.
ßß0 1
BorderBottom
ßß1 =
(
ßß= >
$num
ßß> B
)
ßßB C
.
ßßC D
BorderColor
ßßD O
(
ßßO P
$str
ßßP Y
)
ßßY Z
.
ßßZ [
Padding
ßß[ b
(
ßßb c
$num
ßßc d
)
ßßd e
.
®®( )
Text
®®) -
(
®®- .
quantity
®®. 6
.
®®6 7
ToString
®®7 ?
(
®®? @
)
®®@ A
)
®®A B
.
®®B C
	FontColor
®®C L
(
®®L M
$str
®®M V
)
®®V W
.
®®W X
FontSize
®®X `
(
®®` a
$num
®®a c
)
®®c d
;
®®d e
tabla
©©$ )
.
©©) *
Cell
©©* .
(
©©. /
)
©©/ 0
.
©©0 1
BorderBottom
©©1 =
(
©©= >
$num
©©> B
)
©©B C
.
©©C D
BorderColor
©©D O
(
©©O P
$str
©©P Y
)
©©Y Z
.
©©Z [
Padding
©©[ b
(
©©b c
$num
©©c d
)
©©d e
.
™™( )
Text
™™) -
(
™™- .
$"
™™. 0
$str
™™0 2
{
™™2 3
price
™™3 8
:
™™8 9
$str
™™9 =
}
™™= >
"
™™> ?
)
™™? @
.
™™@ A
	FontColor
™™A J
(
™™J K
$str
™™K T
)
™™T U
.
™™U V
FontSize
™™V ^
(
™™^ _
$num
™™_ a
)
™™a b
;
™™b c
tabla
´´$ )
.
´´) *
Cell
´´* .
(
´´. /
)
´´/ 0
.
´´0 1
BorderBottom
´´1 =
(
´´= >
$num
´´> B
)
´´B C
.
´´C D
BorderColor
´´D O
(
´´O P
$str
´´P Y
)
´´Y Z
.
´´Z [
Padding
´´[ b
(
´´b c
$num
´´c d
)
´´d e
.
¨¨( )
Text
¨¨) -
(
¨¨- .
$"
¨¨. 0
$str
¨¨0 2
{
¨¨2 3
discount
¨¨3 ;
.
¨¨; <
ToString
¨¨< D
(
¨¨D E
$str
¨¨E K
)
¨¨K L
}
¨¨L M
"
¨¨M N
)
¨¨N O
.
¨¨O P
	FontColor
¨¨P Y
(
¨¨Y Z
$str
¨¨Z c
)
¨¨c d
.
¨¨d e
FontSize
¨¨e m
(
¨¨m n
$num
¨¨n p
)
¨¨p q
;
¨¨q r
tabla
≠≠$ )
.
≠≠) *
Cell
≠≠* .
(
≠≠. /
)
≠≠/ 0
.
≠≠0 1
BorderBottom
≠≠1 =
(
≠≠= >
$num
≠≠> B
)
≠≠B C
.
≠≠C D
BorderColor
≠≠D O
(
≠≠O P
$str
≠≠P Y
)
≠≠Y Z
.
≠≠Z [
Padding
≠≠[ b
(
≠≠b c
$num
≠≠c d
)
≠≠d e
.
ÆÆ( )
Text
ÆÆ) -
(
ÆÆ- .
$"
ÆÆ. 0
$str
ÆÆ0 2
{
ÆÆ2 3
total
ÆÆ3 8
.
ÆÆ8 9
ToString
ÆÆ9 A
(
ÆÆA B
$str
ÆÆB H
)
ÆÆH I
}
ÆÆI J
"
ÆÆJ K
)
ÆÆK L
.
ÆÆL M
	FontColor
ÆÆM V
(
ÆÆV W
$str
ÆÆW `
)
ÆÆ` a
.
ÆÆa b
FontSize
ÆÆb j
(
ÆÆj k
$num
ÆÆk m
)
ÆÆm n
;
ÆÆn o
subTotal
∞∞$ ,
+=
∞∞- /
total
∞∞0 5
;
∞∞5 6
totalDiscount
±±$ 1
+=
±±2 4
discount
±±5 =
;
±±= >
totalTax
≤≤$ ,
=
≤≤- .
tax
≤≤/ 2
;
≤≤2 3
}
≥≥  !
}
¥¥ 
)
¥¥ 
;
¥¥ 
col1
∂∂  
.
∂∂  !
Item
∂∂! %
(
∂∂% &
)
∂∂& '
.
∂∂' (

PaddingTop
∂∂( 2
(
∂∂2 3
$num
∂∂3 5
)
∂∂5 6
.
∂∂6 7
Row
∂∂7 :
(
∂∂: ;
row
∂∂; >
=>
∂∂? A
{
∑∑ 
row
∏∏  #
.
∏∏# $
RelativeItem
∏∏$ 0
(
∏∏0 1
)
∏∏1 2
.
∏∏2 3
Column
∏∏3 9
(
∏∏9 :
col2
∏∏: >
=>
∏∏? A
{
ππ  !
col2
∫∫$ (
.
∫∫( )
Item
∫∫) -
(
∫∫- .
)
∫∫. /
.
∫∫/ 0

AlignRight
∫∫0 :
(
∫∫: ;
)
∫∫; <
.
∫∫< =
Text
∫∫= A
(
∫∫A B
$str
∫∫B P
)
∫∫P Q
.
∫∫Q R
Bold
∫∫R V
(
∫∫V W
)
∫∫W X
.
∫∫X Y
FontSize
∫∫Y a
(
∫∫a b
$num
∫∫b d
)
∫∫d e
.
ªª( )
	FontColor
ªª) 2
(
ªª2 3
$str
ªª3 <
)
ªª< =
;
ªª= >
col2
ºº$ (
.
ºº( )
Item
ºº) -
(
ºº- .
)
ºº. /
.
ºº/ 0

AlignRight
ºº0 :
(
ºº: ;
)
ºº; <
.
ºº< =
Text
ºº= A
(
ººA B
$"
ººB D
$str
ººD L
{
ººL M
invoice
ººM T
.
ººT U
Debit
ººU Z
.
ººZ [
ToString
ºº[ c
(
ººc d
$str
ººd j
)
ººj k
}
ººk l
"
ººl m
)
ººm n
.
ΩΩ( )
FontSize
ΩΩ) 1
(
ΩΩ1 2
$num
ΩΩ2 4
)
ΩΩ4 5
.
ΩΩ5 6
	FontColor
ΩΩ6 ?
(
ΩΩ? @
$str
ΩΩ@ I
)
ΩΩI J
;
ΩΩJ K
col2
ææ$ (
.
ææ( )
Item
ææ) -
(
ææ- .
)
ææ. /
.
ææ/ 0

AlignRight
ææ0 :
(
ææ: ;
)
ææ; <
.
ææ< =
Text
ææ= A
(
ææA B
$str
ææB R
)
ææR S
.
ææS T
FontSize
ææT \
(
ææ\ ]
$num
ææ] _
)
ææ_ `
.
ææ` a
	FontColor
ææa j
(
ææj k
$str
ææk t
)
ææt u
;
ææu v
col2
øø$ (
.
øø( )
Item
øø) -
(
øø- .
)
øø. /
.
øø/ 0

AlignRight
øø0 :
(
øø: ;
)
øø; <
.
øø< =
Text
øø= A
(
øøA B
date
øøB F
)
øøF G
.
øøG H
FontSize
øøH P
(
øøP Q
$num
øøQ S
)
øøS T
.
øøT U
	FontColor
øøU ^
(
øø^ _
$str
øø_ h
)
øøh i
;
øøi j
}
¿¿  !
)
¿¿! "
;
¿¿" #
}
¡¡ 
)
¡¡ 
;
¡¡ 
col1
√√  
.
√√  !
Spacing
√√! (
(
√√( )
$num
√√) +
)
√√+ ,
;
√√, -
}
ƒƒ 
)
ƒƒ 
;
ƒƒ 
page
∆∆ 
.
∆∆ 
Footer
∆∆ #
(
∆∆# $
)
∆∆$ %
.
«« 

AlignRight
«« '
(
««' (
)
««( )
.
»» 
Text
»» !
(
»»! "
txt
»»" %
=>
»»& (
{
…… 
txt
    #
.
  # $
Span
  $ (
(
  ( )
$str
  ) 2
)
  2 3
.
  3 4
FontSize
  4 <
(
  < =
$num
  = ?
)
  ? @
.
  @ A
	FontColor
  A J
(
  J K
$str
  K T
)
  T U
;
  U V
txt
ÀÀ  #
.
ÀÀ# $
CurrentPageNumber
ÀÀ$ 5
(
ÀÀ5 6
)
ÀÀ6 7
.
ÀÀ7 8
FontSize
ÀÀ8 @
(
ÀÀ@ A
$num
ÀÀA C
)
ÀÀC D
.
ÀÀD E
	FontColor
ÀÀE N
(
ÀÀN O
$str
ÀÀO X
)
ÀÀX Y
;
ÀÀY Z
txt
ÃÃ  #
.
ÃÃ# $
Span
ÃÃ$ (
(
ÃÃ( )
$str
ÃÃ) /
)
ÃÃ/ 0
.
ÃÃ0 1
FontSize
ÃÃ1 9
(
ÃÃ9 :
$num
ÃÃ: <
)
ÃÃ< =
.
ÃÃ= >
	FontColor
ÃÃ> G
(
ÃÃG H
$str
ÃÃH Q
)
ÃÃQ R
;
ÃÃR S
txt
ÕÕ  #
.
ÕÕ# $

TotalPages
ÕÕ$ .
(
ÕÕ. /
)
ÕÕ/ 0
.
ÕÕ0 1
FontSize
ÕÕ1 9
(
ÕÕ9 :
$num
ÕÕ: <
)
ÕÕ< =
.
ÕÕ= >
	FontColor
ÕÕ> G
(
ÕÕG H
$str
ÕÕH Q
)
ÕÕQ R
;
ÕÕR S
}
ŒŒ 
)
ŒŒ 
;
ŒŒ 
}
œœ 
)
œœ 
;
œœ 
}
–– 
)
–– 
;
–– 
byte
““ 
[
““ 
]
““ 
pdfBytes
““ 
=
““ 
document
““ &
.
““& '
GeneratePdf
““' 2
(
““2 3
)
““3 4
;
““4 5
using
‘‘ 
var
‘‘ 
memoryStream
‘‘ "
=
‘‘# $
new
‘‘% (
MemoryStream
‘‘) 5
(
‘‘5 6
pdfBytes
‘‘6 >
)
‘‘> ?
;
‘‘? @
return
’’ 
memoryStream
’’ 
.
’’  
ToArray
’’  '
(
’’' (
)
’’( )
;
’’) *
}
÷÷ 	
)
÷÷	 

;
÷÷
 
}
◊◊ 
public
ŸŸ 

async
ŸŸ 
Task
ŸŸ 
<
ŸŸ 
byte
ŸŸ 
[
ŸŸ 
]
ŸŸ 
>
ŸŸ 
RegenerateInvoice
ŸŸ /
(
ŸŸ/ 0
UserInfoResponse
ŸŸ0 @
userInfo
ŸŸA I
,
ŸŸI J
Invoice
ŸŸK R
invoice
ŸŸS Z
)
ŸŸZ [
{
⁄⁄ 
var
€€ 
date
€€ 
=
€€ 
DateTime
€€ 
.
€€ 
Now
€€ 
.
€€  
ToString
€€  (
(
€€( )
$str
€€) 5
)
€€5 6
;
€€6 7
var
‹‹ 
totalTax
‹‹ 
=
‹‹ 
$num
‹‹ 
;
‹‹ 
var
›› 
subTotal
›› 
=
›› 
$num
›› 
;
›› 
decimal
ﬁﬁ 
?
ﬁﬁ 
totalDiscount
ﬁﬁ 
=
ﬁﬁ  
$num
ﬁﬁ! #
;
ﬁﬁ# $
var
ﬂﬂ 
workingDirectory
ﬂﬂ 
=
ﬂﬂ 
Path
ﬂﬂ #
.
ﬂﬂ# $
GetDirectoryName
ﬂﬂ$ 4
(
ﬂﬂ4 5
Assembly
ﬂﬂ5 =
.
ﬂﬂ= >"
GetExecutingAssembly
ﬂﬂ> R
(
ﬂﬂR S
)
ﬂﬂS T
.
ﬂﬂT U
Location
ﬂﬂU ]
)
ﬂﬂ] ^
;
ﬂﬂ^ _
var
‡‡ 
	separator
‡‡ 
=
‡‡ 
Path
‡‡ 
.
‡‡ $
DirectorySeparatorChar
‡‡ 3
;
‡‡3 4
var
·· 
pathFile
·· 
=
·· 
$"
·· 
{
·· 
workingDirectory
·· *
}
··* +
{
··+ ,
	separator
··, 5
}
··5 6
$str
··6 <
{
··< =
	separator
··= F
}
··F G
$str
··G T
"
··T U
;
··U V
return
„„ 
await
„„ 
Task
„„ 
.
„„ 
Run
„„ 
(
„„ 
(
„„ 
)
„„  
=>
„„! #
{
‰‰ 	
var
ÂÂ 
document
ÂÂ 
=
ÂÂ 
Document
ÂÂ #
.
ÊÊ 
Create
ÊÊ 
(
ÊÊ 
doc
ÊÊ 
=>
ÊÊ 
{
ÁÁ 
doc
ËË 
.
ËË 
Page
ËË 
(
ËË 
page
ËË !
=>
ËË" $
{
ÈÈ 
page
ÍÍ 
.
ÍÍ 
Margin
ÍÍ #
(
ÍÍ# $
$num
ÍÍ$ &
)
ÍÍ& '
;
ÍÍ' (
page
ÎÎ 
.
ÎÎ 
	PageColor
ÎÎ &
(
ÎÎ& '
$str
ÎÎ' 0
)
ÎÎ0 1
;
ÎÎ1 2
page
ÌÌ 
.
ÌÌ 
Header
ÌÌ #
(
ÌÌ# $
)
ÌÌ$ %
.
ÌÌ% &
ShowOnce
ÌÌ& .
(
ÌÌ. /
)
ÌÌ/ 0
.
ÌÌ0 1
Row
ÌÌ1 4
(
ÌÌ4 5
row
ÌÌ5 8
=>
ÌÌ9 ;
{
ÓÓ 
var
ÔÔ 
image
ÔÔ  %
=
ÔÔ& '
Image
ÔÔ( -
.
ÔÔ- .
FromFile
ÔÔ. 6
(
ÔÔ6 7
pathFile
ÔÔ7 ?
)
ÔÔ? @
;
ÔÔ@ A
row
 
.
  
ConstantItem
  ,
(
, -
$num
- 0
)
0 1
.
1 2
	Container
2 ;
(
; <
)
< =
.
= >
Image
> C
(
C D
image
D I
)
I J
;
J K
row
ÚÚ 
.
ÚÚ  
RelativeItem
ÚÚ  ,
(
ÚÚ, -
)
ÚÚ- .
.
ÚÚ. /
Column
ÚÚ/ 5
(
ÚÚ5 6
col
ÚÚ6 9
=>
ÚÚ: <
{
ÛÛ 
col
ÙÙ  #
.
ÙÙ# $
Item
ÙÙ$ (
(
ÙÙ( )
)
ÙÙ) *
.
ÙÙ* +

AlignRight
ÙÙ+ 5
(
ÙÙ5 6
)
ÙÙ6 7
.
ıı$ %

Background
ıı% /
(
ıı/ 0
$str
ıı0 9
)
ıı9 :
.
ˆˆ$ %
Padding
ˆˆ% ,
(
ˆˆ, -
$num
ˆˆ- /
)
ˆˆ/ 0
.
ˆˆ0 1
Border
ˆˆ1 7
(
ˆˆ7 8
$num
ˆˆ8 9
)
ˆˆ9 :
.
ˆˆ: ;
BorderColor
ˆˆ; F
(
ˆˆF G
$str
ˆˆG P
)
ˆˆP Q
.
˜˜$ %
AlignCenter
˜˜% 0
(
˜˜0 1
)
˜˜1 2
.
¯¯$ %
Text
¯¯% )
(
¯¯) *
$"
¯¯* ,
$str
¯¯, 4
{
¯¯4 5
invoice
¯¯5 <
.
¯¯< =
Id
¯¯= ?
}
¯¯? @
"
¯¯@ A
)
¯¯A B
.
˘˘$ %
	FontColor
˘˘% .
(
˘˘. /
$str
˘˘/ 8
)
˘˘8 9
;
˘˘9 :
col
˚˚  #
.
˚˚# $
Item
˚˚$ (
(
˚˚( )
)
˚˚) *
.
˚˚* +

AlignRight
˚˚+ 5
(
˚˚5 6
)
˚˚6 7
.
˚˚7 8
Text
˚˚8 <
(
˚˚< =
$str
˚˚= g
)
˚˚g h
.
¸¸$ %
	FontColor
¸¸% .
(
¸¸. /
$str
¸¸/ 8
)
¸¸8 9
.
¸¸9 :
FontSize
¸¸: B
(
¸¸B C
$num
¸¸C E
)
¸¸E F
;
¸¸F G
col
˝˝  #
.
˝˝# $
Item
˝˝$ (
(
˝˝( )
)
˝˝) *
.
˝˝* +

AlignRight
˝˝+ 5
(
˝˝5 6
)
˝˝6 7
.
˝˝7 8
Text
˝˝8 <
(
˝˝< =
$str
˝˝= R
)
˝˝R S
.
˝˝S T
	FontColor
˝˝T ]
(
˝˝] ^
$str
˝˝^ g
)
˝˝g h
.
˝˝h i
FontSize
˝˝i q
(
˝˝q r
$num
˝˝r t
)
˝˝t u
;
˝˝u v
col
˛˛  #
.
˛˛# $
Item
˛˛$ (
(
˛˛( )
)
˛˛) *
.
˛˛* +

AlignRight
˛˛+ 5
(
˛˛5 6
)
˛˛6 7
.
ˇˇ$ %
Text
ˇˇ% )
(
ˇˇ) *
$str
ÄÄ( y
)
ÄÄy z
.
ÅÅ$ %
	FontColor
ÅÅ% .
(
ÅÅ. /
$str
ÅÅ/ 8
)
ÅÅ8 9
.
ÅÅ9 :
FontSize
ÅÅ: B
(
ÅÅB C
$num
ÅÅC E
)
ÅÅE F
;
ÅÅF G
col
ÇÇ  #
.
ÇÇ# $
Item
ÇÇ$ (
(
ÇÇ( )
)
ÇÇ) *
.
ÇÇ* +

AlignRight
ÇÇ+ 5
(
ÇÇ5 6
)
ÇÇ6 7
.
ÇÇ7 8
Text
ÇÇ8 <
(
ÇÇ< =
$str
ÇÇ= S
)
ÇÇS T
.
ÇÇT U
	FontColor
ÇÇU ^
(
ÇÇ^ _
$str
ÇÇ_ h
)
ÇÇh i
.
ÇÇi j
FontSize
ÇÇj r
(
ÇÇr s
$num
ÇÇs u
)
ÇÇu v
;
ÇÇv w
col
ÉÉ  #
.
ÉÉ# $
Item
ÉÉ$ (
(
ÉÉ( )
)
ÉÉ) *
.
ÉÉ* +

AlignRight
ÉÉ+ 5
(
ÉÉ5 6
)
ÉÉ6 7
.
ÉÉ7 8
Text
ÉÉ8 <
(
ÉÉ< =
$str
ÉÉ= [
)
ÉÉ[ \
.
ÉÉ\ ]
	FontColor
ÉÉ] f
(
ÉÉf g
$str
ÉÉg p
)
ÉÉp q
.
ÑÑ$ %
FontSize
ÑÑ% -
(
ÑÑ- .
$num
ÑÑ. 0
)
ÑÑ0 1
;
ÑÑ1 2
col
ÖÖ  #
.
ÖÖ# $
Item
ÖÖ$ (
(
ÖÖ( )
)
ÖÖ) *
.
ÖÖ* +

AlignRight
ÖÖ+ 5
(
ÖÖ5 6
)
ÖÖ6 7
.
ÖÖ7 8
Text
ÖÖ8 <
(
ÖÖ< =
date
ÖÖ= A
)
ÖÖA B
.
ÖÖB C
	FontColor
ÖÖC L
(
ÖÖL M
$str
ÖÖM V
)
ÖÖV W
.
ÖÖW X
FontSize
ÖÖX `
(
ÖÖ` a
$num
ÖÖa c
)
ÖÖc d
;
ÖÖd e
}
ÜÜ 
)
ÜÜ 
;
ÜÜ 
}
áá 
)
áá 
;
áá 
page
ââ 
.
ââ 
Content
ââ $
(
ââ$ %
)
ââ% &
.
ââ& '
PaddingVertical
ââ' 6
(
ââ6 7
$num
ââ7 9
)
ââ9 :
.
ââ: ;
Column
ââ; A
(
ââA B
col1
ââB F
=>
ââG I
{
ää 
col1
ãã  
.
ãã  !
Item
ãã! %
(
ãã% &
)
ãã& '
.
ãã' (

PaddingTop
ãã( 2
(
ãã2 3
$num
ãã3 5
)
ãã5 6
.
ãã6 7
Row
ãã7 :
(
ãã: ;
row
ãã; >
=>
ãã? A
{
åå 
row
çç  #
.
çç# $
RelativeItem
çç$ 0
(
çç0 1
)
çç1 2
.
çç2 3
Column
çç3 9
(
çç9 :
col2
çç: >
=>
çç? A
{
éé  !
col2
èè$ (
.
èè( )
Item
èè) -
(
èè- .
)
èè. /
.
èè/ 0
	AlignLeft
èè0 9
(
èè9 :
)
èè: ;
.
èè; <
Text
èè< @
(
èè@ A
$str
èèA T
)
èèT U
.
èèU V
	Underline
èèV _
(
èè_ `
)
èè` a
.
èèa b
Bold
èèb f
(
èèf g
)
èèg h
.
êê( )
	FontColor
êê) 2
(
êê2 3
$str
êê3 <
)
êê< =
;
êê= >
col2
íí$ (
.
íí( )
Item
íí) -
(
íí- .
)
íí. /
.
íí/ 0
Text
íí0 4
(
íí4 5
txt
íí5 8
=>
íí9 ;
{
ìì$ %
txt
îî( +
.
îî+ ,
Span
îî, 0
(
îî0 1
$str
îî1 ;
)
îî; <
.
îî< =
SemiBold
îî= E
(
îîE F
)
îîF G
.
îîG H
FontSize
îîH P
(
îîP Q
$num
îîQ S
)
îîS T
.
îîT U
	FontColor
îîU ^
(
îî^ _
$str
îî_ h
)
îîh i
;
îîi j
txt
ïï( +
.
ïï+ ,
Span
ïï, 0
(
ïï0 1
$"
ïï1 3
{
ïï3 4
userInfo
ïï4 <
.
ïï< =
Name
ïï= A
}
ïïA B
$str
ïïB C
{
ïïC D
userInfo
ïïD L
.
ïïL M
LastName
ïïM U
}
ïïU V
"
ïïV W
)
ïïW X
.
ïïX Y
	FontColor
ïïY b
(
ïïb c
$str
ïïc l
)
ïïl m
.
ññ, -
FontSize
ññ- 5
(
ññ5 6
$num
ññ6 8
)
ññ8 9
;
ññ9 :
}
óó$ %
)
óó% &
;
óó& '
col2
ôô$ (
.
ôô( )
Item
ôô) -
(
ôô- .
)
ôô. /
.
ôô/ 0
Text
ôô0 4
(
ôô4 5
txt
ôô5 8
=>
ôô9 ;
{
öö$ %
txt
õõ( +
.
õõ+ ,
Span
õõ, 0
(
õõ0 1
$str
õõ1 9
)
õõ9 :
.
õõ: ;
SemiBold
õõ; C
(
õõC D
)
õõD E
.
õõE F
FontSize
õõF N
(
õõN O
$num
õõO Q
)
õõQ R
.
õõR S
	FontColor
õõS \
(
õõ\ ]
$str
õõ] f
)
õõf g
;
õõg h
txt
úú( +
.
úú+ ,
Span
úú, 0
(
úú0 1
userInfo
úú1 9
.
úú9 :
Country
úú: A
!
úúA B
.
úúB C
Name
úúC G
)
úúG H
.
úúH I
	FontColor
úúI R
(
úúR S
$str
úúS \
)
úú\ ]
.
úú] ^
FontSize
úú^ f
(
úúf g
$num
úúg i
)
úúi j
;
úúj k
}
ùù$ %
)
ùù% &
;
ùù& '
col2
üü$ (
.
üü( )
Item
üü) -
(
üü- .
)
üü. /
.
üü/ 0
Text
üü0 4
(
üü4 5
txt
üü5 8
=>
üü9 ;
{
††$ %
txt
°°( +
.
°°+ ,
Span
°°, 0
(
°°0 1
$str
°°1 ;
)
°°; <
.
°°< =
SemiBold
°°= E
(
°°E F
)
°°F G
.
°°G H
FontSize
°°H P
(
°°P Q
$num
°°Q S
)
°°S T
.
°°T U
	FontColor
°°U ^
(
°°^ _
$str
°°_ h
)
°°h i
;
°°i j
txt
¢¢( +
.
¢¢+ ,
Span
¢¢, 0
(
¢¢0 1
userInfo
¢¢1 9
.
¢¢9 :
City
¢¢: >
)
¢¢> ?
.
¢¢? @
	FontColor
¢¢@ I
(
¢¢I J
$str
¢¢J S
)
¢¢S T
.
¢¢T U
FontSize
¢¢U ]
(
¢¢] ^
$num
¢¢^ `
)
¢¢` a
;
¢¢a b
}
££$ %
)
££% &
;
££& '
}
§§  !
)
§§! "
;
§§" #
row
¶¶  #
.
¶¶# $
RelativeItem
¶¶$ 0
(
¶¶0 1
)
¶¶1 2
.
¶¶2 3
Column
¶¶3 9
(
¶¶9 :
col2
¶¶: >
=>
¶¶? A
{
ßß  !
col2
®®$ (
.
®®( )
Item
®®) -
(
®®- .
)
®®. /
.
®®/ 0

AlignRight
®®0 :
(
®®: ;
)
®®; <
.
®®< =
Text
®®= A
(
®®A B
txt
®®B E
=>
®®F H
{
©©$ %
txt
™™( +
.
™™+ ,
Span
™™, 0
(
™™0 1
$str
™™1 <
)
™™< =
.
™™= >
SemiBold
™™> F
(
™™F G
)
™™G H
.
™™H I
FontSize
™™I Q
(
™™Q R
$num
™™R T
)
™™T U
.
™™U V
	FontColor
™™V _
(
™™_ `
$str
™™` i
)
™™i j
;
™™j k
txt
´´( +
.
´´+ ,
Span
´´, 0
(
´´0 1
userInfo
´´1 9
.
´´9 :
Phone
´´: ?
)
´´? @
.
´´@ A
	FontColor
´´A J
(
´´J K
$str
´´K T
)
´´T U
.
´´U V
FontSize
´´V ^
(
´´^ _
$num
´´_ a
)
´´a b
;
´´b c
}
¨¨$ %
)
¨¨% &
;
¨¨& '
col2
ÆÆ$ (
.
ÆÆ( )
Item
ÆÆ) -
(
ÆÆ- .
)
ÆÆ. /
.
ÆÆ/ 0

AlignRight
ÆÆ0 :
(
ÆÆ: ;
)
ÆÆ; <
.
ÆÆ< =
Text
ÆÆ= A
(
ÆÆA B
txt
ÆÆB E
=>
ÆÆF H
{
ØØ$ %
txt
∞∞( +
.
∞∞+ ,
Span
∞∞, 0
(
∞∞0 1
$str
∞∞1 O
)
∞∞O P
.
∞∞P Q
SemiBold
∞∞Q Y
(
∞∞Y Z
)
∞∞Z [
.
∞∞[ \
FontSize
∞∞\ d
(
∞∞d e
$num
∞∞e g
)
∞∞g h
.
±±, -
	FontColor
±±- 6
(
±±6 7
$str
±±7 @
)
±±@ A
;
±±A B
txt
≤≤( +
.
≤≤+ ,
Span
≤≤, 0
(
≤≤0 1
userInfo
≤≤1 9
.
≤≤9 :
UserName
≤≤: B
)
≤≤B C
.
≤≤C D
	FontColor
≤≤D M
(
≤≤M N
$str
≤≤N W
)
≤≤W X
.
≤≤X Y
FontSize
≤≤Y a
(
≤≤a b
$num
≤≤b d
)
≤≤d e
;
≤≤e f
}
≥≥$ %
)
≥≥% &
;
≥≥& '
col2
µµ$ (
.
µµ( )
Item
µµ) -
(
µµ- .
)
µµ. /
.
µµ/ 0

AlignRight
µµ0 :
(
µµ: ;
)
µµ; <
.
µµ< =
Text
µµ= A
(
µµA B
txt
µµB E
=>
µµF H
{
∂∂$ %
txt
∑∑( +
.
∑∑+ ,
Span
∑∑, 0
(
∑∑0 1
$str
∑∑1 :
)
∑∑: ;
.
∑∑; <
SemiBold
∑∑< D
(
∑∑D E
)
∑∑E F
.
∑∑F G
FontSize
∑∑G O
(
∑∑O P
$num
∑∑P R
)
∑∑R S
.
∑∑S T
	FontColor
∑∑T ]
(
∑∑] ^
$str
∑∑^ g
)
∑∑g h
;
∑∑h i
txt
∏∏( +
.
∏∏+ ,
Span
∏∏, 0
(
∏∏0 1
userInfo
∏∏1 9
.
∏∏9 :
Email
∏∏: ?
)
∏∏? @
.
∏∏@ A
	FontColor
∏∏A J
(
∏∏J K
$str
∏∏K T
)
∏∏T U
.
∏∏U V
FontSize
∏∏V ^
(
∏∏^ _
$num
∏∏_ a
)
∏∏a b
;
∏∏b c
}
ππ$ %
)
ππ% &
;
ππ& '
col2
ªª$ (
.
ªª( )
Item
ªª) -
(
ªª- .
)
ªª. /
.
ªª/ 0

AlignRight
ªª0 :
(
ªª: ;
)
ªª; <
.
ªª< =
Text
ªª= A
(
ªªA B
txt
ªªB E
=>
ªªF H
{
ºº$ %
txt
ΩΩ( +
.
ΩΩ+ ,
Span
ΩΩ, 0
(
ΩΩ0 1
$str
ΩΩ1 >
)
ΩΩ> ?
.
ΩΩ? @
SemiBold
ΩΩ@ H
(
ΩΩH I
)
ΩΩI J
.
ΩΩJ K
FontSize
ΩΩK S
(
ΩΩS T
$num
ΩΩT V
)
ΩΩV W
.
ΩΩW X
	FontColor
ΩΩX a
(
ΩΩa b
$str
ΩΩb k
)
ΩΩk l
;
ΩΩl m
txt
ææ( +
.
ææ+ ,
Span
ææ, 0
(
ææ0 1
userInfo
ææ1 9
.
ææ9 :
Address
ææ: A
)
ææA B
.
ææB C
	FontColor
ææC L
(
ææL M
$str
ææM V
)
ææV W
.
ææW X
FontSize
ææX `
(
ææ` a
$num
ææa c
)
ææc d
;
ææd e
}
øø$ %
)
øø% &
;
øø& '
col2
¡¡$ (
.
¡¡( )
Item
¡¡) -
(
¡¡- .
)
¡¡. /
.
¡¡/ 0

AlignRight
¡¡0 :
(
¡¡: ;
)
¡¡; <
.
¡¡< =
Text
¡¡= A
(
¡¡A B
txt
¡¡B E
=>
¡¡F H
{
¬¬$ %
if
√√( *
(
√√+ ,
!
√√, -
string
√√- 3
.
√√3 4
IsNullOrEmpty
√√4 A
(
√√A B
invoice
√√B I
.
√√I J
Reason
√√J P
)
√√P Q
)
√√Q R
{
ƒƒ( )
txt
≈≈, /
.
≈≈/ 0
Span
≈≈0 4
(
≈≈4 5
$str
≈≈5 B
)
≈≈B C
.
≈≈C D
SemiBold
≈≈D L
(
≈≈L M
)
≈≈M N
.
≈≈N O
FontSize
≈≈O W
(
≈≈W X
$num
≈≈X Z
)
≈≈Z [
.
≈≈[ \
	FontColor
≈≈\ e
(
≈≈e f
$str
≈≈f o
)
≈≈o p
;
≈≈p q
txt
∆∆, /
.
∆∆/ 0
Span
∆∆0 4
(
∆∆4 5
invoice
∆∆5 <
.
∆∆< =
Reason
∆∆= C
)
∆∆C D
.
∆∆D E
	FontColor
∆∆E N
(
∆∆N O
$str
∆∆O X
)
∆∆X Y
.
∆∆Y Z
FontSize
∆∆Z b
(
∆∆b c
$num
∆∆c e
)
∆∆e f
;
∆∆f g
}
««( )
}
»»$ %
)
»»% &
;
»»& '
}
……  !
)
……! "
;
……" #
}
   
)
   
;
   
col1
ÃÃ  
.
ÃÃ  !
Item
ÃÃ! %
(
ÃÃ% &
)
ÃÃ& '
.
ÃÃ' (
LineHorizontal
ÃÃ( 6
(
ÃÃ6 7
$num
ÃÃ7 ;
)
ÃÃ; <
.
ÃÃ< =
	LineColor
ÃÃ= F
(
ÃÃF G
$str
ÃÃG P
)
ÃÃP Q
;
ÃÃQ R
col1
ŒŒ  
.
ŒŒ  !
Item
ŒŒ! %
(
ŒŒ% &
)
ŒŒ& '
.
ŒŒ' (
Table
ŒŒ( -
(
ŒŒ- .
tabla
ŒŒ. 3
=>
ŒŒ4 6
{
œœ 
tabla
––  %
.
––% &
ColumnsDefinition
––& 7
(
––7 8
columns
––8 ?
=>
––@ B
{
——  !
columns
““$ +
.
““+ ,
RelativeColumn
““, :
(
““: ;
$num
““; <
)
““< =
;
““= >
columns
””$ +
.
””+ ,
RelativeColumn
””, :
(
””: ;
)
””; <
;
””< =
columns
‘‘$ +
.
‘‘+ ,
RelativeColumn
‘‘, :
(
‘‘: ;
)
‘‘; <
;
‘‘< =
columns
’’$ +
.
’’+ ,
RelativeColumn
’’, :
(
’’: ;
)
’’; <
;
’’< =
columns
÷÷$ +
.
÷÷+ ,
RelativeColumn
÷÷, :
(
÷÷: ;
)
÷÷; <
;
÷÷< =
}
◊◊  !
)
◊◊! "
;
◊◊" #
tabla
ŸŸ  %
.
ŸŸ% &
Header
ŸŸ& ,
(
ŸŸ, -
header
ŸŸ- 3
=>
ŸŸ4 6
{
⁄⁄  !
header
€€$ *
.
€€* +
Cell
€€+ /
(
€€/ 0
)
€€0 1
.
€€1 2

Background
€€2 <
(
€€< =
$str
€€= F
)
€€F G
.
€€G H
Padding
€€H O
(
€€O P
$num
€€P Q
)
€€Q R
.
€€R S
Text
€€S W
(
€€W X
$str
€€X b
)
€€b c
.
‹‹( )
	FontColor
‹‹) 2
(
‹‹2 3
$str
‹‹3 <
)
‹‹< =
;
‹‹= >
header
››$ *
.
››* +
Cell
››+ /
(
››/ 0
)
››0 1
.
››1 2

Background
››2 <
(
››< =
$str
››= F
)
››F G
.
››G H
Padding
››H O
(
››O P
$num
››P Q
)
››Q R
.
››R S
Text
››S W
(
››W X
$str
››X b
)
››b c
.
ﬁﬁ( )
	FontColor
ﬁﬁ) 2
(
ﬁﬁ2 3
$str
ﬁﬁ3 <
)
ﬁﬁ< =
;
ﬁﬁ= >
header
ﬂﬂ$ *
.
ﬂﬂ* +
Cell
ﬂﬂ+ /
(
ﬂﬂ/ 0
)
ﬂﬂ0 1
.
ﬂﬂ1 2

Background
ﬂﬂ2 <
(
ﬂﬂ< =
$str
ﬂﬂ= F
)
ﬂﬂF G
.
ﬂﬂG H
Padding
ﬂﬂH O
(
ﬂﬂO P
$num
ﬂﬂP Q
)
ﬂﬂQ R
.
ﬂﬂR S
Text
ﬂﬂS W
(
ﬂﬂW X
$str
ﬂﬂX `
)
ﬂﬂ` a
.
‡‡( )
	FontColor
‡‡) 2
(
‡‡2 3
$str
‡‡3 <
)
‡‡< =
;
‡‡= >
header
··$ *
.
··* +
Cell
··+ /
(
··/ 0
)
··0 1
.
··1 2

Background
··2 <
(
··< =
$str
··= F
)
··F G
.
··G H
Padding
··H O
(
··O P
$num
··P Q
)
··Q R
.
··R S
Text
··S W
(
··W X
$str
··X c
)
··c d
.
‚‚( )
	FontColor
‚‚) 2
(
‚‚2 3
$str
‚‚3 <
)
‚‚< =
;
‚‚= >
header
„„$ *
.
„„* +
Cell
„„+ /
(
„„/ 0
)
„„0 1
.
„„1 2

Background
„„2 <
(
„„< =
$str
„„= F
)
„„F G
.
„„G H
Padding
„„H O
(
„„O P
$num
„„P Q
)
„„Q R
.
„„R S
Text
„„S W
(
„„W X
$str
„„X _
)
„„_ `
.
‰‰( )
	FontColor
‰‰) 2
(
‰‰2 3
$str
‰‰3 <
)
‰‰< =
;
‰‰= >
}
ÂÂ  !
)
ÂÂ! "
;
ÂÂ" #
foreach
ÁÁ  '
(
ÁÁ( )
var
ÁÁ) ,
item
ÁÁ- 1
in
ÁÁ2 4
invoice
ÁÁ5 <
.
ÁÁ< =
InvoicesDetails
ÁÁ= L
)
ÁÁL M
{
ËË  !
var
ÈÈ$ '
conceptName
ÈÈ( 3
=
ÈÈ4 5
item
ÈÈ6 :
.
ÈÈ: ;
ProductName
ÈÈ; F
;
ÈÈF G
var
ÍÍ$ '
quantity
ÍÍ( 0
=
ÍÍ1 2
item
ÍÍ3 7
.
ÍÍ7 8
ProductQuantity
ÍÍ8 G
;
ÍÍG H
var
ÎÎ$ '
price
ÎÎ( -
=
ÎÎ. /
item
ÎÎ0 4
.
ÎÎ4 5
ProductPrice
ÎÎ5 A
;
ÎÎA B
var
ÏÏ$ '
tax
ÏÏ( +
=
ÏÏ, -
item
ÏÏ. 2
.
ÏÏ2 3

ProductIva
ÏÏ3 =
;
ÏÏ= >
var
ÌÌ$ '
discount
ÌÌ( 0
=
ÌÌ1 2
item
ÌÌ3 7
.
ÌÌ7 8
ProductDiscount
ÌÌ8 G
*
ÌÌH I
quantity
ÌÌJ R
;
ÌÌR S
var
ÓÓ$ '
total
ÓÓ( -
=
ÓÓ. /
quantity
ÓÓ0 8
*
ÓÓ9 :
price
ÓÓ; @
;
ÓÓ@ A
tabla
$ )
.
) *
Cell
* .
(
. /
)
/ 0
.
0 1
BorderBottom
1 =
(
= >
$num
> B
)
B C
.
C D
BorderColor
D O
(
O P
$str
P Y
)
Y Z
.
Z [
Padding
[ b
(
b c
$num
c d
)
d e
.
ÒÒ( )
Text
ÒÒ) -
(
ÒÒ- .
conceptName
ÒÒ. 9
)
ÒÒ9 :
.
ÒÒ: ;
	FontColor
ÒÒ; D
(
ÒÒD E
$str
ÒÒE N
)
ÒÒN O
.
ÒÒO P
FontSize
ÒÒP X
(
ÒÒX Y
$num
ÒÒY [
)
ÒÒ[ \
;
ÒÒ\ ]
tabla
ÚÚ$ )
.
ÚÚ) *
Cell
ÚÚ* .
(
ÚÚ. /
)
ÚÚ/ 0
.
ÚÚ0 1
BorderBottom
ÚÚ1 =
(
ÚÚ= >
$num
ÚÚ> B
)
ÚÚB C
.
ÚÚC D
BorderColor
ÚÚD O
(
ÚÚO P
$str
ÚÚP Y
)
ÚÚY Z
.
ÚÚZ [
Padding
ÚÚ[ b
(
ÚÚb c
$num
ÚÚc d
)
ÚÚd e
.
ÛÛ( )
Text
ÛÛ) -
(
ÛÛ- .
quantity
ÛÛ. 6
.
ÛÛ6 7
ToString
ÛÛ7 ?
(
ÛÛ? @
)
ÛÛ@ A
)
ÛÛA B
.
ÛÛB C
	FontColor
ÛÛC L
(
ÛÛL M
$str
ÛÛM V
)
ÛÛV W
.
ÛÛW X
FontSize
ÛÛX `
(
ÛÛ` a
$num
ÛÛa c
)
ÛÛc d
;
ÛÛd e
tabla
ÙÙ$ )
.
ÙÙ) *
Cell
ÙÙ* .
(
ÙÙ. /
)
ÙÙ/ 0
.
ÙÙ0 1
BorderBottom
ÙÙ1 =
(
ÙÙ= >
$num
ÙÙ> B
)
ÙÙB C
.
ÙÙC D
BorderColor
ÙÙD O
(
ÙÙO P
$str
ÙÙP Y
)
ÙÙY Z
.
ÙÙZ [
Padding
ÙÙ[ b
(
ÙÙb c
$num
ÙÙc d
)
ÙÙd e
.
ıı( )
Text
ıı) -
(
ıı- .
$"
ıı. 0
$str
ıı0 2
{
ıı2 3
price
ıı3 8
.
ıı8 9
ToString
ıı9 A
(
ııA B
$str
ııB H
)
ııH I
}
ııI J
"
ııJ K
)
ııK L
.
ııL M
	FontColor
ııM V
(
ııV W
$str
ııW `
)
ıı` a
.
ııa b
FontSize
ııb j
(
ııj k
$num
ıık m
)
ıım n
;
ıın o
tabla
ˆˆ$ )
.
ˆˆ) *
Cell
ˆˆ* .
(
ˆˆ. /
)
ˆˆ/ 0
.
ˆˆ0 1
BorderBottom
ˆˆ1 =
(
ˆˆ= >
$num
ˆˆ> B
)
ˆˆB C
.
ˆˆC D
BorderColor
ˆˆD O
(
ˆˆO P
$str
ˆˆP Y
)
ˆˆY Z
.
ˆˆZ [
Padding
ˆˆ[ b
(
ˆˆb c
$num
ˆˆc d
)
ˆˆd e
.
˜˜( )
Text
˜˜) -
(
˜˜- .
$"
˜˜. 0
$str
˜˜0 2
{
˜˜2 3
discount
˜˜3 ;
.
˜˜; <
ToString
˜˜< D
(
˜˜D E
)
˜˜E F
}
˜˜F G
"
˜˜G H
)
˜˜H I
.
˜˜I J
	FontColor
˜˜J S
(
˜˜S T
$str
˜˜T ]
)
˜˜] ^
.
˜˜^ _
FontSize
˜˜_ g
(
˜˜g h
$num
˜˜h j
)
˜˜j k
;
˜˜k l
tabla
¯¯$ )
.
¯¯) *
Cell
¯¯* .
(
¯¯. /
)
¯¯/ 0
.
¯¯0 1
BorderBottom
¯¯1 =
(
¯¯= >
$num
¯¯> B
)
¯¯B C
.
¯¯C D
BorderColor
¯¯D O
(
¯¯O P
$str
¯¯P Y
)
¯¯Y Z
.
¯¯Z [
Padding
¯¯[ b
(
¯¯b c
$num
¯¯c d
)
¯¯d e
.
˘˘( )
Text
˘˘) -
(
˘˘- .
$"
˘˘. 0
$str
˘˘0 2
{
˘˘2 3
total
˘˘3 8
.
˘˘8 9
ToString
˘˘9 A
(
˘˘A B
$str
˘˘B H
)
˘˘H I
}
˘˘I J
"
˘˘J K
)
˘˘K L
.
˘˘L M
	FontColor
˘˘M V
(
˘˘V W
$str
˘˘W `
)
˘˘` a
.
˘˘a b
FontSize
˘˘b j
(
˘˘j k
$num
˘˘k m
)
˘˘m n
;
˘˘n o
subTotal
˚˚$ ,
+=
˚˚- /
total
˚˚0 5
;
˚˚5 6
totalDiscount
¸¸$ 1
+=
¸¸2 4
discount
¸¸5 =
;
¸¸= >
totalTax
˝˝$ ,
=
˝˝- .
(
˝˝/ 0
decimal
˝˝0 7
)
˝˝7 8
tax
˝˝8 ;
!
˝˝; <
;
˝˝< =
}
˛˛  !
}
ˇˇ 
)
ˇˇ 
;
ˇˇ 
col1
ÅÅ  
.
ÅÅ  !
Item
ÅÅ! %
(
ÅÅ% &
)
ÅÅ& '
.
ÅÅ' (

PaddingTop
ÅÅ( 2
(
ÅÅ2 3
$num
ÅÅ3 5
)
ÅÅ5 6
.
ÅÅ6 7
Row
ÅÅ7 :
(
ÅÅ: ;
row
ÅÅ; >
=>
ÅÅ? A
{
ÇÇ 
row
ÉÉ  #
.
ÉÉ# $
RelativeItem
ÉÉ$ 0
(
ÉÉ0 1
)
ÉÉ1 2
.
ÉÉ2 3
Column
ÉÉ3 9
(
ÉÉ9 :
col2
ÉÉ: >
=>
ÉÉ? A
{
ÑÑ  !
col2
ÖÖ$ (
.
ÖÖ( )
Item
ÖÖ) -
(
ÖÖ- .
)
ÖÖ. /
.
ÖÖ/ 0

AlignRight
ÖÖ0 :
(
ÖÖ: ;
)
ÖÖ; <
.
ÖÖ< =
Text
ÖÖ= A
(
ÖÖA B
$str
ÖÖB P
)
ÖÖP Q
.
ÖÖQ R
Bold
ÖÖR V
(
ÖÖV W
)
ÖÖW X
.
ÖÖX Y
FontSize
ÖÖY a
(
ÖÖa b
$num
ÖÖb d
)
ÖÖd e
.
ÜÜ( )
	FontColor
ÜÜ) 2
(
ÜÜ2 3
$str
ÜÜ3 <
)
ÜÜ< =
;
ÜÜ= >
col2
áá$ (
.
áá( )
Item
áá) -
(
áá- .
)
áá. /
.
áá/ 0

AlignRight
áá0 :
(
áá: ;
)
áá; <
.
áá< =
Text
áá= A
(
ááA B
$"
ááB D
$str
ááD L
{
ááL M
invoice
ááM T
.
ááT U
TotalInvoice
ááU a
.
ááa b
ToString
ááb j
(
ááj k
)
áák l
}
áál m
"
áám n
)
áán o
.
àà( )
FontSize
àà) 1
(
àà1 2
$num
àà2 4
)
àà4 5
.
àà5 6
	FontColor
àà6 ?
(
àà? @
$str
àà@ I
)
ààI J
;
ààJ K
col2
ââ$ (
.
ââ( )
Item
ââ) -
(
ââ- .
)
ââ. /
.
ââ/ 0

AlignRight
ââ0 :
(
ââ: ;
)
ââ; <
.
ââ< =
Text
ââ= A
(
ââA B
$str
ââB R
)
ââR S
.
ââS T
FontSize
ââT \
(
ââ\ ]
$num
ââ] _
)
ââ_ `
.
ââ` a
	FontColor
ââa j
(
ââj k
$str
ââk t
)
âât u
;
ââu v
col2
ää$ (
.
ää( )
Item
ää) -
(
ää- .
)
ää. /
.
ää/ 0

AlignRight
ää0 :
(
ää: ;
)
ää; <
.
ää< =
Text
ää= A
(
ääA B
date
ääB F
)
ääF G
.
ääG H
FontSize
ääH P
(
ääP Q
$num
ääQ S
)
ääS T
.
ääT U
	FontColor
ääU ^
(
ää^ _
$str
ää_ h
)
ääh i
;
ääi j
}
ãã  !
)
ãã! "
;
ãã" #
}
åå 
)
åå 
;
åå 
col1
éé  
.
éé  !
Spacing
éé! (
(
éé( )
$num
éé) +
)
éé+ ,
;
éé, -
}
èè 
)
èè 
;
èè 
page
ëë 
.
ëë 
Footer
ëë #
(
ëë# $
)
ëë$ %
.
íí 

AlignRight
íí '
(
íí' (
)
íí( )
.
ìì 
Text
ìì !
(
ìì! "
txt
ìì" %
=>
ìì& (
{
îî 
txt
ïï  #
.
ïï# $
Span
ïï$ (
(
ïï( )
$str
ïï) 2
)
ïï2 3
.
ïï3 4
FontSize
ïï4 <
(
ïï< =
$num
ïï= ?
)
ïï? @
.
ïï@ A
	FontColor
ïïA J
(
ïïJ K
$str
ïïK T
)
ïïT U
;
ïïU V
txt
ññ  #
.
ññ# $
CurrentPageNumber
ññ$ 5
(
ññ5 6
)
ññ6 7
.
ññ7 8
FontSize
ññ8 @
(
ññ@ A
$num
ññA C
)
ññC D
.
ññD E
	FontColor
ññE N
(
ññN O
$str
ññO X
)
ññX Y
;
ññY Z
txt
óó  #
.
óó# $
Span
óó$ (
(
óó( )
$str
óó) /
)
óó/ 0
.
óó0 1
FontSize
óó1 9
(
óó9 :
$num
óó: <
)
óó< =
.
óó= >
	FontColor
óó> G
(
óóG H
$str
óóH Q
)
óóQ R
;
óóR S
txt
òò  #
.
òò# $

TotalPages
òò$ .
(
òò. /
)
òò/ 0
.
òò0 1
FontSize
òò1 9
(
òò9 :
$num
òò: <
)
òò< =
.
òò= >
	FontColor
òò> G
(
òòG H
$str
òòH Q
)
òòQ R
;
òòR S
}
ôô 
)
ôô 
;
ôô 
}
öö 
)
öö 
;
öö 
}
õõ 
)
õõ 
;
õõ 
byte
ùù 
[
ùù 
]
ùù 
pdfBytes
ùù 
=
ùù 
document
ùù &
.
ùù& '
GeneratePdf
ùù' 2
(
ùù2 3
)
ùù3 4
;
ùù4 5
using
üü 
var
üü 
memoryStream
üü "
=
üü# $
new
üü% (
MemoryStream
üü) 5
(
üü5 6
pdfBytes
üü6 >
)
üü> ?
;
üü? @
return
†† 
memoryStream
†† 
.
††  
ToArray
††  '
(
††' (
)
††( )
;
††) *
}
°° 	
)
°°	 

;
°°
 
}
¢¢ 
}££ „
SC:\HeroSystem\walletService\WalletService.Core\Services\RedisCacheCleanupService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class $
RedisCacheCleanupService %
:% &%
IRedisCacheCleanupService& ?
{ 
private		 
readonly		 "
IConnectionMultiplexer		 +"
_connectionMultiplexer		, B
;		B C
private

 
readonly

 
ILogger

 
<

 $
RedisCacheCleanupService

 5
>

5 6
_logger

7 >
;

> ?
private 
readonly 
	IDatabase 
_db "
;" #
public 
$
RedisCacheCleanupService #
(# $"
IConnectionMultiplexer$ :!
connectionMultiplexer; P
,P Q
ILoggerR Y
<Y Z$
RedisCacheCleanupServiceZ r
>r s
loggert z
)z {
{ "
_connectionMultiplexer 
= !
connectionMultiplexer  5
;5 6
_logger 
= 
logger 
; 
_db 

= !
connectionMultiplexer "
." #
GetDatabase# .
(. /
)/ 0
;0 1
} 
public 

async 
Task 
CleanupAsync "
(" #
)# $
{ 
try 
{ 	
var 
	endpoints 
= "
_connectionMultiplexer 2
.2 3
GetEndPoints3 ?
(? @
)@ A
;A B
foreach 
( 
var 
endpoint !
in" $
	endpoints% .
). /
{ 
var 
server 
= "
_connectionMultiplexer 3
.3 4
	GetServer4 =
(= >
endpoint> F
)F G
;G H
var 
keys 
= 
server !
.! "
Keys" &
(& '
)' (
;( )
foreach 
( 
var 
key  
in! #
keys$ (
)( )
{ 
await   
_db   
.   
KeyDeleteAsync   ,
(  , -
key  - 0
)  0 1
;  1 2
}!! 
_logger"" 
."" 
LogInformation"" &
(""& '
$"""' )
$str"") V
{""V W
endpoint""W _
}""_ `
"""` a
)""a b
;""b c
}## 
}$$ 	
catch%% 
(%% 
	Exception%% 
ex%% 
)%% 
{&& 	
_logger'' 
.'' 
LogError'' 
('' 
ex'' 
,''  
$str''! S
)''S T
;''T U
}(( 	
})) 
}** ≠
PC:\HeroSystem\walletService\WalletService.Core\Services\ResultsEcoPoolService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public		 
class		 !
ResultsEcoPoolService		 "
:		" #
BaseService		# .
,		. /"
IResultsEcoPoolService		/ E
{

 
private 
readonly %
IResultsEcoPoolRepository .%
_resultsEcoPoolRepository/ H
;H I
public 
!
ResultsEcoPoolService  
(  !
IMapper! (
mapper) /
,/ 0%
IResultsEcoPoolRepository1 J$
resultsEcoPoolRepositoryK c
)c d
:e f
baseg k
(k l
mapperl r
)r s
{ %
_resultsEcoPoolRepository !
=" #$
resultsEcoPoolRepository$ <
;< =
} 
public 

async 
Task 
< 
IEnumerable !
<! "
ResultsEcoPoolDto" 3
>3 4
>4 5%
GetAllResultsEcoPoolAsync6 O
(O P
)P Q
{ 
var 
results 
= 
await %
_resultsEcoPoolRepository 5
.5 6 
GetAllResultsEcoPool6 J
(J K
)K L
;L M
return 
Mapper 
. 
Map 
< 
IEnumerable %
<% &
ResultsEcoPoolDto& 7
>7 8
>8 9
(9 :
results: A
)A B
;B C
} 
} ¶R
PC:\HeroSystem\walletService\WalletService.Core\Services\UserStatisticsService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public

 
class

 !
UserStatisticsService

 "
:

# $"
IUserStatisticsService

% ;
{ 
private 
readonly 
IInvoiceRepository '
_invoiceRepository( :
;: ;
private 
readonly %
IResultsEcoPoolRepository .%
_resultsEcoPoolRepository/ H
;H I
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter, B
;B C
private 
readonly 

RedisCache 
_redisCache. 9
;9 :
private 
readonly 
IBrandService "
_brandService. ;
;; <
public 
!
UserStatisticsService  
(  !
IInvoiceRepository! 3
invoiceRepository4 E
,E F"
IAccountServiceAdapter !
accountServiceAdapter 4
,4 5%
IResultsEcoPoolRepository !$
resultsEcoPoolRepository" :
,: ;

RedisCache< F

redisCacheG Q
,Q R
IBrandServiceR _
brandService` l
)l m
{ 
_invoiceRepository 
= 
invoiceRepository .
;. /"
_accountServiceAdapter 
=  !
accountServiceAdapter! 6
;6 7%
_resultsEcoPoolRepository !
=" #$
resultsEcoPoolRepository$ <
;< =
_redisCache 
= 

redisCache  
;  !
_brandService 
= 
brandService $
;$ %
} 
public 

async 
Task 
< 
UserStatistics $
>$ %"
GetUserStatisticsAsync& <
(< =
int= @
userIdA G
)G H
{ 
var 
key 
= 
string 
. 
Format 
(  
	CacheKeys  )
.) *
ModelInformation* :
,: ;
userId< B
)B C
;C D
var 
isExists 
= 
await 
_redisCache (
.( )
	KeyExists) 2
(2 3
key3 6
)6 7
;7 8
UserStatistics   
result   
;   
if!! 

(!! 
!!! 
isExists!! 
)!! 
{"" 	
var## 
pointsModel4## 
=## 
await## $
_invoiceRepository##% 7
.##7 8"
Model4StatisticsByUser##8 N
(##N O
userId##O U
)##U V
;##V W
var$$ 
amountModel1A$$ 
=$$ 
await$$  %
_invoiceRepository$$& 8
.$$8 9&
CountDetailsByPaymentGroup$$9 S
($$S T
$num$$T U
,$$U V
userId$$W ]
,$$] ^
_brandService$$^ k
.$$k l
BrandId$$l s
)$$s t
;$$t u
var%% 
amountModel1B%% 
=%% 
await%%  %
_invoiceRepository%%& 8
.%%8 9&
CountDetailsByPaymentGroup%%9 S
(%%S T
$num%%T U
,%%U V
userId%%W ]
,%%] ^
_brandService%%^ k
.%%k l
BrandId%%l s
)%%s t
;%%t u
var&& 
amountModel2&& 
=&& 
await&& $
_invoiceRepository&&% 7
.&&7 8&
CountDetailsByPaymentGroup&&8 R
(&&R S
$num&&S T
,&&T U
userId&&V \
,&&\ ]
_brandService&&] j
.&&j k
BrandId&&k r
)&&r s
;&&s t
var'' 
amountModel3'' 
='' 
await'' $
_invoiceRepository''% 7
.''7 8,
 CountDetailsModel3ByPaymentGroup''8 X
(''X Y
userId''Y _
,''_ `
_brandService''a n
.''n o
BrandId''o v
)''v w
;''w x
var(( 
accountInformation(( "
=((# $
await((% *"
_accountServiceAdapter((+ A
.((A B
NetworkDetails((B P
(((P Q
userId((Q W
,((W X
_brandService((X e
.((e f
BrandId((f m
)((m n
;((n o
var)) 
residualModel1A)) 
=))  
await))! &%
_resultsEcoPoolRepository))' @
.))@ A&
SumResidualModel1AByUserId))A [
())[ \
userId))\ b
)))b c
;))c d
var** 
passiveModel1A** 
=** 
await**  %%
_resultsEcoPoolRepository**& ?
.**? @%
SumPassiveModel1AByUserId**@ Y
(**Y Z
userId**Z `
)**` a
;**a b
var++ 
residualModel1B++ 
=++  
await++! &%
_resultsEcoPoolRepository++' @
.++@ A&
SumResidualModel1BByUserId++A [
(++[ \
userId++\ b
)++b c
;++c d
var,, 
passiveModel1B,, 
=,, 
await,,  %%
_resultsEcoPoolRepository,,& ?
.,,? @%
SumPassiveModel1BByUserId,,@ Y
(,,Y Z
userId,,Z `
),,` a
;,,a b
var-- 
residualModel2-- 
=-- 
await--  %%
_resultsEcoPoolRepository--& ?
.--? @%
SumResidualModel2ByUserId--@ Y
(--Y Z
userId--Z `
)--` a
;--a b
var.. 
passiveModel2.. 
=.. 
await.. $%
_resultsEcoPoolRepository..% >
...> ?$
SumPassiveModel2ByUserId..? W
(..W X
userId..X ^
)..^ _
;.._ `
var// 
residualModel3// 
=// 
await//  %%
_resultsEcoPoolRepository//& ?
.//? @%
SumResidualModel3ByUserId//@ Y
(//Y Z
userId//Z `
)//` a
;//a b
var00 
percentageModel300  
=00  !
await00" '%
_resultsEcoPoolRepository00( A
.00A B'
SumPercentageModel3ByUserId00B ]
(00] ^
userId00^ d
)00d e
;00e f
result22 
=22 
new22 
UserStatistics22 '
{33 
AmountPoolModel1A44 !
=44" #
amountModel1A44$ 1
,441 2
AmountPoolModel1B55 !
=55" #
amountModel1B55$ 1
,551 2
AmountPoolModel266  
=66! "
amountModel266# /
,66/ 0
AmountPoolModel377  
=77! "
amountModel377# /
,77/ 0
VolumeLeftModel488  
=88! "
pointsModel488# /
.88/ 0
Sum880 3
(883 4
s884 5
=>886 8
s889 :
.88: ;

CreditLeft88; E
-88F G
s88H I
.88I J
	DebitLeft88J S
)88S T
,88T U
VolumeRightModel499 !
=99" #
pointsModel499$ 0
.990 1
Sum991 4
(994 5
s995 6
=>997 9
s99: ;
.99; <
CreditRight99< G
-99H I
s99J K
.99K L

DebitRight99L V
)99V W
,99W X$
AmountChildrenLeftModel4:: (
=::) *
accountInformation::+ =
.::= >
Model4::> D
.::D E
	LeftCount::E N
,::N O%
AmountChildrenRightModel4;; )
=;;* +
accountInformation;;, >
.;;> ?
Model4;;? E
.;;E F

RightCount;;F P
,;;P Q%
AmountUsersDirectModel123<< )
=<<* +
accountInformation<<, >
.<<> ?
Model123<<? G
.<<G H
DirectAffiliates<<H X
,<<X Y&
AmountUsersNetworkModel123== *
===+ ,
accountInformation==- ?
.==? @
Model123==@ H
.==H I
IndirectAffiliates==I [
,==[ \#
AmountUsersDirectModel5>> '
=>>( )
accountInformation>>* <
.>>< =
Model5>>= C
.>>C D
DirectAffiliates>>D T
,>>T U$
AmountUsersNetworkModel5?? (
=??) *
accountInformation??+ =
.??= >
Model5??> D
.??D E
IndirectAffiliates??E W
,??W X#
AmountUsersDirectModel6@@ '
=@@( )
accountInformation@@* <
.@@< =
Model6@@= C
.@@C D
DirectAffiliates@@D T
,@@T U$
AmountUsersNetworkModel6AA (
=AA) *
accountInformationAA+ =
.AA= >
Model6AA> D
.AAD E
IndirectAffiliatesAAE W
,AAW X!
AmountResidualModel1ABB %
=BB& '
residualModel1ABB( 7
,BB7 8 
AmountPassiveModel1ACC $
=CC% &
passiveModel1ACC' 5
,CC5 6!
AmountResidualModel1BDD %
=DD& '
residualModel1BDD( 7
,DD7 8 
AmountPassiveModel1BEE $
=EE% &
passiveModel1BEE' 5
,EE5 6 
AmountResidualModel2FF $
=FF% &
residualModel2FF' 5
,FF5 6
AmountPassiveModel2GG #
=GG$ %
passiveModel2GG& 3
,GG3 4 
AmountResidualModel3HH $
=HH% &
residualModel3HH' 5
,HH5 6"
AmountPercentageModel3II &
=II' (
percentageModel3II) 9
}JJ 
;JJ 
awaitKK 
_redisCacheKK 
.KK 
SetKK !
(KK! "
keyKK" %
,KK% &
resultKK' -
,KK- .
TimeSpanKK/ 7
.KK7 8
	FromHoursKK8 A
(KKA B
$numKKB C
)KKC D
)KKD E
;KKE F
returnLL 
resultLL 
;LL 
}MM 	
resultNN 
=NN 
awaitNN 
_redisCacheNN "
.NN" #
GetNN# &
<NN& '
UserStatisticsNN' 5
>NN5 6
(NN6 7
keyNN7 :
)NN: ;
??NN< >
newNN? B
UserStatisticsNNC Q
(NNQ R
)NNR S
;NNS T
returnPP 
resultPP 
;PP 
}QQ 
}RR Ò5
OC:\HeroSystem\walletService\WalletService.Core\Services\WalletHistoryService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public

 
class

  
WalletHistoryService

 !
:

" #
BaseService

$ /
,

/ 0!
IWalletHistoryService

1 F
{ 
private 
readonly $
IWalletHistoryRepository -$
_walletHistoryRepository. F
;F G
public 
 
WalletHistoryService 
(  
IMapper  '
mapper( .
,. /$
IWalletHistoryRepository0 H#
walletHistoryRepositoryI `
)` a
:b c
based h
(h i
mapperi o
)o p
=> 
$
_walletHistoryRepository #
=$ %#
walletHistoryRepository& =
;= >
public 

async 
Task 
< 
IEnumerable !
<! "
WalletHistoryDto" 2
>2 3
>3 4'
GetAllWalletsHistoriesAsync5 P
(P Q
)Q R
{ 
var 
response 
= 
await $
_walletHistoryRepository 5
.5 6'
GetAllWalletsHistoriesAsync6 Q
(Q R
)R S
;S T
return 
Mapper 
. 
Map 
< 
IEnumerable %
<% &
WalletHistoryDto& 6
>6 7
>7 8
(8 9
response9 A
)A B
;B C
} 
public 

async 
Task 
< 
WalletHistoryDto &
?& '
>' ('
GetWalletHistoriesByIdAsync) D
(D E
intE H
idI K
)K L
{ 
var 
response 
= 
await $
_walletHistoryRepository 5
.5 6'
GetWalletHistoriesByIdAsync6 Q
(Q R
idR T
)T U
;U V
return 
Mapper 
. 
Map 
< 
WalletHistoryDto *
>* +
(+ ,
response, 4
)4 5
;5 6
} 
public   

async   
Task   
<   
WalletHistoryDto   &
?  & '
>  ' (&
CreateWalletHistoriesAsync  ) C
(  C D 
WalletHistoryRequest  D X
request  Y `
)  ` a
{!! 
var"" 
history"" 
="" 
Mapper"" 
."" 
Map""  
<""  !
WalletsHistory""! /
>""/ 0
(""0 1
request""1 8
)""8 9
;""9 :
history## 
=## 
await## $
_walletHistoryRepository## 0
.##0 1&
CreateWalletHistoriesAsync##1 K
(##K L
history##L S
)##S T
;##T U
return%% 
Mapper%% 
.%% 
Map%% 
<%% 
WalletHistoryDto%% *
>%%* +
(%%+ ,
history%%, 3
)%%3 4
;%%4 5
}&& 
public(( 

async(( 
Task(( 
<(( 
WalletHistoryDto(( &
?((& '
>((' (&
UpdateWalletHistoriesAsync(() C
(((C D
int((D G
id((H J
,((J K 
WalletHistoryRequest((L `
request((a h
)((h i
{)) 
var** 
history** 
=** 
await** $
_walletHistoryRepository** 4
.**4 5'
GetWalletHistoriesByIdAsync**5 P
(**P Q
id**Q S
)**S T
;**T U
if,, 

(,, 
history,, 
is,, 
null,, 
),, 
return-- 
null-- 
;-- 
history.. 
... 
AffiliateId.. 
=.. 
request.. %
...% &
AffiliateId..& 1
;..1 2
history// 
.// 
UserId// 
=// 
request// %
.//% &
UserId//& ,
;//, -
history00 
.00 
Credit00 
=00 
request00 %
.00% &
Credit00& ,
;00, -
history11 
.11 
Debit11 
=11 
request11 %
.11% &
Debit11& +
;11+ ,
history22 
.22 
Deferred22 
=22 
request22 %
.22% &
Deferred22& .
;22. /
history33 
.33 
Status33 
=33 
request33 %
.33% &
Status33& ,
;33, -
history44 
.44 
Concept44 
=44 
request44 %
.44% &
Concept44& -
;44- .
history55 
.55 
Support55 
=55 
request55 %
.55% &
Support55& -
;55- .
history66 
.66 
Date66 
=66 
request66 %
.66% &
Date66& *
;66* +
history77 
.77 
	UpdatedAt77 
=77 
DateTime77 &
.77& '
Now77' *
;77* +
history:: 
=:: 
await:: $
_walletHistoryRepository:: 0
.::0 1&
UpdateWalletHistoriesAsync::1 K
(::K L
history::L S
)::S T
;::T U
return<< 
Mapper<< 
.<< 
Map<< 
<<< 
WalletHistoryDto<< *
><<* +
(<<+ ,
history<<, 3
)<<3 4
;<<4 5
}== 
public?? 

async?? 
Task?? 
<?? 
WalletHistoryDto?? &
???& '
>??' (&
DeleteWalletHistoriesAsync??) C
(??C D
int??D G
id??H J
)??J K
{@@ 
varAA 
historyAA 
=AA 
awaitAA $
_walletHistoryRepositoryAA 4
.AA4 5'
GetWalletHistoriesByIdAsyncAA5 P
(AAP Q
idAAQ S
)AAS T
;AAT U
ifCC 

(CC 
historyCC 
isCC 
nullCC 
)CC 
returnDD 
nullDD 
;DD 
awaitFF $
_walletHistoryRepositoryFF &
.FF& '&
DeleteWalletHistoriesAsyncFF' A
(FFA B
historyFFB I
)FFI J
;FFJ K
returnHH 
MapperHH 
.HH 
MapHH 
<HH 
WalletHistoryDtoHH *
>HH* +
(HH+ ,
historyHH, 3
)HH3 4
;HH4 5
}II 
}MM ¨[
OC:\HeroSystem\walletService\WalletService.Core\Services\WalletModel1AService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class  
WalletModel1AService !
:" #
BaseService$ /
,/ 0!
IWalletModel1AService1 F
{ 
private 
readonly $
IWalletModel1ARepository -$
_walletModel1ARepository4 L
;L M
private 
readonly *
IBalancePaymentStrategyModel1A 3*
_balancePaymentStrategyModel1A4 R
;R S
private 
readonly 

RedisCache 
_redisCache3 >
;> ?
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter3 I
;I J
private 
readonly $
IWalletModel1ARepository -$
_walletRepositoryModel1A3 K
;K L
private 
readonly 
IBrandService "
_brandService3 @
;@ A
public 
 
WalletModel1AService 
(  
IMapper 
mapper( .
,. /$
IWalletModel1ARepository  #
walletModel1ARepository( ?
,? @

RedisCache 

redisCache( 2
,2 3*
IBalancePaymentStrategyModel1A &)
balancePaymentStrategyModel1A( E
,E F"
IAccountServiceAdapter !
accountServiceAdapter 4
,4 5$
IWalletModel1ARepository  #
walletRepositoryModel1A! 8
,8 9
IBrandService9 F
brandServiceG S
)S T
:U V
baseW [
([ \
mapper\ b
)b c
{ $
_walletModel1ARepository  
=' (#
walletModel1ARepository) @
;@ A*
_balancePaymentStrategyModel1A &
=' ()
balancePaymentStrategyModel1A) F
;F G
_redisCache 
=' (

redisCache) 3
;3 4"
_accountServiceAdapter   
=  ' (!
accountServiceAdapter  ) >
;  > ?$
_walletRepositoryModel1A!!  
=!!' (#
walletRepositoryModel1A!!) @
;!!@ A
}"" 
public$$ 

async$$ 
Task$$ 
<$$ (
BalanceInformationModel1ADto$$ 2
>$$2 3.
"GetBalanceInformationByAffiliateId$$4 V
($$V W
int$$W Z
affiliateId$$[ f
)$$f g
{%% 
var&& 
key&&% (
=&&/ 0
string&&1 7
.&&7 8
Format&&8 >
(&&> ?
	CacheKeys&&? H
.&&H I%
BalanceInformationModel1A&&I b
,&&b c
affiliateId&&d o
)&&o p
;&&p q
var'' 
	existsKey''% .
=''/ 0
await''2 7
_redisCache''8 C
.''C D
	KeyExists''D M
(''M N
key''N Q
)''Q R
;''R S(
BalanceInformationModel1ADto(( $
response((% -
;((- .
if)) 

()) 
!)) 
	existsKey)) 
))) 
{** 	
var++ 
availableBalance++  
=++% &
await++' ,$
_walletModel1ARepository++- E
.++E F,
 GetAvailableBalanceByAffiliateId++F f
(++f g
affiliateId++g r
)++r s
;++s t
var,, 
totalAcquisitions,, !
=,,% &
await,,' ,$
_walletModel1ARepository,,- E
.,,E F-
!GetTotalAcquisitionsByAffiliateId,,F g
(,,g h
affiliateId,,h s
),,s t
;,,t u
var-- 
reverseBalance-- 
=--% &
await--' ,$
_walletModel1ARepository--- E
.--E F*
GetReverseBalanceByAffiliateId--F d
(--d e
affiliateId--e p
)--p q
;--q r
var.. 
serviceBalance.. 
=..% &
await..' ,$
_walletModel1ARepository..- E
...E F"
GetTotalServiceBalance..F \
(..\ ]
affiliateId..] h
)..h i
;..i j
var//  
totalCommissionsPaid// $
=//% &
await//' ,$
_walletModel1ARepository//- E
.//E F*
GetTotalCommissionsPaidBalance//F d
(//d e
affiliateId//e p
)//p q
;//q r
response11 
=11 
new11 (
BalanceInformationModel1ADto11 7
{22 
AvailableBalance33  
=33% &
availableBalance33' 7
,337 8
ReverseBalance44 
=44% &
reverseBalance44' 5
??446 8
$num449 :
,44: ;
TotalAcquisitions55 !
=55% &
totalAcquisitions55' 8
??559 ;
$num55< =
,55= > 
TotalCommissionsPaid66 $
=66% & 
totalCommissionsPaid66' ;
??66< >
$num66? @
,66@ A
ServiceBalance77 
=77% &
serviceBalance77' 5
??776 8
$num779 :
}88 
;88 
if:: 
(:: 
response:: 
.:: 
ReverseBalance:: '
!=::( *
$num::+ -
)::- .
response;; 
.;; 
AvailableBalance;; )
-=;;* ,
response;;- 5
.;;5 6
ReverseBalance;;6 D
;;;D E
await== 
_redisCache== 
.== 
Set== !
(==! "
key==" %
,==% &
response==' /
,==/ 0
TimeSpan==1 9
.==9 :
	FromHours==: C
(==C D
$num==D E
)==E F
)==F G
;==G H
return>> 
response>> 
;>> 
}?? 	
responseAA 
=AA 
awaitAA 
_redisCacheAA $
.AA$ %
GetAA% (
<AA( )(
BalanceInformationModel1ADtoAA) E
>AAE F
(AAF G
keyAAG J
)AAJ K
??AAL N
newAAO R(
BalanceInformationModel1ADtoAAS o
(AAo p
)AAp q
;AAq r
returnBB 
responseBB 
;BB 
}CC 
publicEE 

asyncEE 
TaskEE 
<EE 
boolEE 
>EE 
PayWithMyBalanceEE ,
(EE, -
WalletRequestEE- :
requestEE; B
)EEB C
{FF 
ifGG 

(GG
 
requestGG 
.GG 
ProductsListGG 
.GG  
CountGG  %
==GG& (
$numGG) *
)GG* +
returnHH 
falseHH 
;HH 
varJJ 
responseJJ 
=JJ 
awaitJJ *
_balancePaymentStrategyModel1AJJ ;
.JJ; <!
ExecuteEcoPoolPaymentJJ< Q
(JJQ R
requestJJR Y
)JJY Z
;JJZ [
ifLL 

(LL 
responseLL 
)LL 
awaitMM 
RemoveCacheKeyMM  
(MM  !
requestMM! (
.MM( )
AffiliateIdMM) 4
)MM4 5
;MM5 6
returnOO 
responseOO 
;OO 
}PP 
publicRR 

asyncRR 
TaskRR 
<RR 
boolRR 
>RR #
PayWithMyServiceBalanceRR 3
(RR3 4
WalletRequestRR4 A
requestRRB I
)RRI J
{SS 
ifTT 

(TT 
requestTT 
.TT 
ProductsListTT  
.TT  !
CountTT! &
==TT' )
$numTT* +
)TT+ ,
returnUU 
falseUU 
;UU 
varWW 
responseWW 
=WW 
awaitWW *
_balancePaymentStrategyModel1AWW ;
.WW; <3
'ExecuteEcoPoolPaymentWithServiceBalanceWW< c
(WWc d
requestWWd k
)WWk l
;WWl m
ifYY 

(YY 
responseYY 
)YY 
awaitZZ 
RemoveCacheKeyZZ  
(ZZ  !
requestZZ! (
.ZZ( )
AffiliateIdZZ) 4
)ZZ4 5
;ZZ5 6
return\\ 
response\\ 
;\\ 
}]] 
private__ 
async__ 
Task__ 
RemoveCacheKey__ %
(__% &
int__& )
affiliateId__* 5
)__5 6
{`` 
varaa 
keyaa 
=aa 
stringaa 
.aa 
Formataa %
(aa% &
	CacheKeysaa& /
.aa/ 0%
BalanceInformationModel1Aaa0 I
,aaI J
affiliateIdaaK V
)aaV W
;aaW X
varbb 
	existsKeybb 
=bb 
awaitbb 
_redisCachebb )
.bb) *
	KeyExistsbb* 3
(bb3 4
keybb4 7
)bb7 8
;bb8 9
ifdd 

(dd 
	existsKeydd 
)dd 
awaitee 
_redisCacheee 
.ee 
Deleteee $
(ee$ %
keyee% (
)ee( )
;ee) *
}ff 
publichh 

asynchh 
Taskhh 
<hh 
boolhh 
>hh %
CreateServiceBalanceAdminhh 5
(hh5 6)
CreditTransactionAdminRequesthh6 S
requesthhT [
)hh[ \
{ii 
ifjj 

(jj 
requestjj 
.jj 
Amountjj 
==jj 
$numjj 
)jj  
returnkk 
falsekk 
;kk 
varmm 
usermm 
=mm 
awaitmm "
_accountServiceAdaptermm /
.mm/ 0
GetUserInfomm0 ;
(mm; <
requestmm< C
.mmC D
AffiliateIdmmD O
,mmO P
_brandServicemmP ]
.mm] ^
BrandIdmm^ e
)mme f
;mmf g
ifoo 

(oo 
useroo 
isoo 
nulloo 
)oo 
returnpp 
falsepp 
;pp 
varrr 
creditrr 
=rr 
newrr $
CreditTransactionRequestrr 1
{ss 	
AdminUserNamett 
=tt 
	Constantstt  )
.tt) *"
AdminEcosystemUserNamett* @
,tt@ A
AffiliateIduu 
=uu 
useruu  $
.uu$ %
Iduu% '
,uu' (
Conceptvv 
=vv 
	Constantsvv  )
.vv) *
AdminCreditvv* 5
,vv5 6
Creditww 
=ww 
requestww  '
.ww' (
Amountww( .
,ww. /
AffiliateUserNamexx 
=xx 
userxx  $
.xx$ %
UserNamexx% -
,xx- .
ConceptTypeyy 
=yy 
	Constantsyy  )
.yy) *
AdminCredityy* 5
,yy5 6
UserIdzz 
=zz 
	Constantszz  )
.zz) *
AdminUserIdzz* 5
}{{ 	
;{{	 

var}} 
result}} 
=}} 
await}} $
_walletRepositoryModel1A}} 3
.}}3 4+
CreditServiceBalanceTransaction}}4 S
(}}S T
credit}}T Z
)}}Z [
;}}[ \
if~~ 

(~~ 
!~~ 
result~~ 
)~~ 
return 
false 
; 
await
ÅÅ 
RemoveCacheKey
ÅÅ 
(
ÅÅ 
user
ÅÅ !
.
ÅÅ! "
Id
ÅÅ" $
)
ÅÅ$ %
;
ÅÅ% &
return
ÇÇ 
true
ÇÇ 
;
ÇÇ 
}
ÉÉ 
}ÑÑ ØY
OC:\HeroSystem\walletService\WalletService.Core\Services\WalletModel1BService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class  
WalletModel1BService !
:" #
BaseService$ /
,/ 0!
IWalletModel1BService1 F
{ 
private 
readonly $
IWalletModel1BRepository -$
_walletModel1BRepository4 L
;L M
private 
readonly *
IBalancePaymentStrategyModel1B 3*
_balancePaymentStrategyModel1B4 R
;R S
private 
readonly 

RedisCache 
_redisCache4 ?
;? @
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter3 I
;I J
private 
readonly 
IBrandService "
_brandService3 @
;@ A
public 
 
WalletModel1BService 
(  
IMapper 
mapper 
, $
IWalletModel1BRepository  #
walletModel1BRepository! 8
,8 9*
IBalancePaymentStrategyModel1B &)
balancePaymentStrategyModel1B' D
,D E

RedisCache 

redisCache 
, "
IAccountServiceAdapter 4!
accountServiceAdapter5 J
,J K
IBrandServiceK X
brandServiceY e
)e f
:g h
basei m
(m n
mappern t
)t u
{ $
_walletModel1BRepository  
=' (#
walletModel1BRepository) @
;@ A*
_balancePaymentStrategyModel1B &
=' ()
balancePaymentStrategyModel1B) F
;F G
_redisCache 
=' (

redisCache) 3
;3 4"
_accountServiceAdapter 
=' (!
accountServiceAdapter) >
;> ?
_brandService 
=' (
brandService) 5
;5 6
} 
public!! 

async!! 
Task!! 
<!! (
BalanceInformationModel1BDto!! 2
>!!2 3.
"GetBalanceInformationByAffiliateId!!4 V
(!!V W
int!!W Z
affiliateId!![ f
)!!f g
{"" 
var## 
key##% (
=##/ 0
string##1 7
.##7 8
Format##8 >
(##> ?
	CacheKeys##? H
.##H I%
BalanceInformationModel1B##I b
,##b c
affiliateId##d o
)##o p
;##p q
var$$ 
	existsKey$$% .
=$$/ 0
await$$2 7
_redisCache$$8 C
.$$C D
	KeyExists$$D M
($$M N
key$$N Q
)$$Q R
;$$R S(
BalanceInformationModel1BDto%% $
response%%% -
;%%- .
if&& 

(&& 
!&& 
	existsKey&& 
)&& 
{'' 	
var(( 
availableBalance((  
=((% &
await((' ,$
_walletModel1BRepository((- E
.((E F,
 GetAvailableBalanceByAffiliateId((F f
(((f g
affiliateId((g r
)((r s
;((s t
var)) 
totalAcquisitions)) !
=))% &
await))' ,$
_walletModel1BRepository))- E
.))E F-
!GetTotalAcquisitionsByAffiliateId))F g
())g h
affiliateId))h s
)))s t
;))t u
var** 
reverseBalance** 
=**% &
await**' ,$
_walletModel1BRepository**- E
.**E F*
GetReverseBalanceByAffiliateId**F d
(**d e
affiliateId**e p
)**p q
;**q r
var++ 
serviceBalance++ 
=++% &
await++' ,$
_walletModel1BRepository++- E
.++E F"
GetTotalServiceBalance++F \
(++\ ]
affiliateId++] h
)++h i
;++i j
var,,  
totalCommissionsPaid,, $
=,,% &
await,,' ,$
_walletModel1BRepository,,- E
.,,E F*
GetTotalCommissionsPaidBalance,,F d
(,,d e
affiliateId,,e p
),,p q
;,,q r
response.. 
=.. 
new.. (
BalanceInformationModel1BDto.. 7
{// 
AvailableBalance00  
=00% &
availableBalance00' 7
,007 8
ReverseBalance11 
=11% &
reverseBalance11' 5
??116 8
$num119 :
,11: ;
TotalAcquisitions22 !
=22% &
totalAcquisitions22' 8
??229 ;
$num22< =
,22= > 
TotalCommissionsPaid33 $
=33% & 
totalCommissionsPaid33' ;
??33< >
$num33? @
,33@ A
ServiceBalance44 
=44% &
serviceBalance44' 5
??446 8
$num449 :
,44: ;
}55 
;55 
if77 
(77 
response77 
.77 
ReverseBalance77 '
!=77( *
$num77+ -
)77- .
response88 
.88 
AvailableBalance88 )
-=88* ,
response88- 5
.885 6
ReverseBalance886 D
;88D E
await:: 
_redisCache:: 
.:: 
Set:: !
(::! "
key::" %
,::% &
response::' /
,::/ 0
TimeSpan::1 9
.::9 :
	FromHours::: C
(::C D
$num::D E
)::E F
)::F G
;::G H
return;; 
response;; 
;;; 
}<< 	
response>> 
=>> 
await>> 
_redisCache>> $
.>>$ %
Get>>% (
<>>( )(
BalanceInformationModel1BDto>>) E
>>>E F
(>>F G
key>>G J
)>>J K
??>>L N
new>>O R(
BalanceInformationModel1BDto>>S o
(>>o p
)>>p q
;>>q r
return?? 
response?? 
;?? 
}@@ 
publicBB 

asyncBB 
TaskBB 
<BB 
boolBB 
>BB 
PayWithMyBalanceBB ,
(BB, -
WalletRequestBB- :
requestBB; B
)BBB C
{CC 
ifDD 

(DD 
requestDD 
.DD 
ProductsListDD  
.DD  !
CountDD! &
==DD' )
$numDD* +
)DD+ ,
returnEE 
falseEE 
;EE 
varGG 
responseGG 
=GG 
awaitGG *
_balancePaymentStrategyModel1BGG ;
.GG; <!
ExecuteEcoPoolPaymentGG< Q
(GGQ R
requestGGR Y
)GGY Z
;GGZ [
ifII 

(II 
responseII 
)II 
awaitJJ 
RemoveCacheKeyJJ  
(JJ  !
requestJJ! (
.JJ( )
AffiliateIdJJ) 4
)JJ4 5
;JJ5 6
returnLL 
responseLL 
;LL 
}MM 
publicOO 

asyncOO 
TaskOO 
<OO 
boolOO 
>OO #
PayWithMyServiceBalanceOO 3
(OO3 4
WalletRequestOO4 A
requestOOB I
)OOI J
{PP 
ifQQ 

(QQ 
requestQQ 
.QQ 
ProductsListQQ  
.QQ  !
CountQQ! &
==QQ' )
$numQQ* +
)QQ+ ,
returnRR 
falseRR 
;RR 
varTT 
responseTT 
=TT 
awaitTT *
_balancePaymentStrategyModel1BTT ;
.TT; <3
'ExecuteEcoPoolPaymentWithServiceBalanceTT< c
(TTc d
requestTTd k
)TTk l
;TTl m
ifVV 

(VV 
responseVV 
)VV 
awaitWW 
RemoveCacheKeyWW  
(WW  !
requestWW! (
.WW( )
AffiliateIdWW) 4
)WW4 5
;WW5 6
returnYY 
responseYY 
;YY 
}ZZ 
private\\ 
async\\ 
Task\\ 
RemoveCacheKey\\ %
(\\% &
int\\& )
affiliateId\\* 5
)\\5 6
{]] 
var^^ 
key^^ 
=^^ 
string^^ 
.^^ 
Format^^ %
(^^% &
	CacheKeys^^& /
.^^/ 0%
BalanceInformationModel1B^^0 I
,^^I J
affiliateId^^K V
)^^V W
;^^W X
var__ 
	existsKey__ 
=__ 
await__ 
_redisCache__ )
.__) *
	KeyExists__* 3
(__3 4
key__4 7
)__7 8
;__8 9
ifaa 

(aa 
	existsKeyaa 
)aa 
awaitbb 
_redisCachebb 
.bb 
Deletebb $
(bb$ %
keybb% (
)bb( )
;bb) *
}cc 
publicee 

asyncee 
Taskee 
<ee 
boolee 
>ee %
CreateServiceBalanceAdminee 5
(ee5 6)
CreditTransactionAdminRequestee6 S
requesteeT [
)ee[ \
{ff 
ifgg 

(gg 
requestgg 
.gg 
Amountgg 
==gg 
$numgg 
)gg  
returnhh 
falsehh 
;hh 
varjj 
userjj 
=jj 
awaitjj "
_accountServiceAdapterjj /
.jj/ 0
GetUserInfojj0 ;
(jj; <
requestjj< C
.jjC D
AffiliateIdjjD O
,jjO P
_brandServicejjP ]
.jj] ^
BrandIdjj^ e
)jje f
;jjf g
ifll 

(ll 
userll 
isll 
nullll 
)ll 
returnmm 
falsemm 
;mm 
varoo 
creditoo 
=oo 
newoo $
CreditTransactionRequestoo 1
{pp 	
AdminUserNameqq 
=qq 
	Constantsqq  )
.qq) *"
AdminEcosystemUserNameqq* @
,qq@ A
AffiliateIdrr 
=rr 
userrr  $
.rr$ %
Idrr% '
,rr' (
Conceptss 
=ss 
	Constantsss  )
.ss) *
AdminCreditss* 5
,ss5 6
Credittt 
=tt 
requesttt  '
.tt' (
Amounttt( .
,tt. /
AffiliateUserNameuu 
=uu 
useruu  $
.uu$ %
UserNameuu% -
,uu- .
ConceptTypevv 
=vv 
	Constantsvv  )
.vv) *
AdminCreditvv* 5
,vv5 6
UserIdww 
=ww 
	Constantsww  )
.ww) *
AdminUserIdww* 5
}xx 	
;xx	 

varzz 
resultzz 
=zz 
awaitzz $
_walletModel1BRepositoryzz 3
.zz3 4+
CreditServiceBalanceTransactionzz4 S
(zzS T
creditzzT Z
)zzZ [
;zz[ \
if{{ 

({{ 
!{{ 
result{{ 
){{ 
return|| 
false|| 
;|| 
await~~ 
RemoveCacheKey~~ 
(~~ 
user~~ !
.~~! "
Id~~" $
)~~$ %
;~~% &
return 
true 
; 
}
ÄÄ 
}ÅÅ ‘4
NC:\HeroSystem\walletService\WalletService.Core\Services\WalletPeriodService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public

 
class

 
WalletPeriodService

  
:

! "
BaseService

# .
,

. / 
IWalletPeriodService

0 D
{ 
private 
readonly #
IWalletPeriodRepository ,#
_walletPeriodRepository- D
;D E
public 

WalletPeriodService 
( 
IMapper &
mapper' -
,- .#
IWalletPeriodRepository/ F"
walletPeriodRepositoryG ]
)] ^
:_ `
basea e
(e f
mapperf l
)l m
=> 
#
_walletPeriodRepository "
=# $"
walletPeriodRepository% ;
;; <
public 

async 
Task 
< 
IEnumerable !
<! "
WalletPeriodDto" 1
>1 2
>2 3 
GetAllWalletsPeriods4 H
(H I
)I J
{ 
var 
response 
= 
await #
_walletPeriodRepository 4
.4 5 
GetAllWalletsPeriods5 I
(I J
)J K
;K L
return 
Mapper 
. 
Map 
< 
IEnumerable %
<% &
WalletPeriodDto& 5
>5 6
>6 7
(7 8
response8 @
)@ A
;A B
} 
public 

async 
Task 
< 
WalletPeriodDto %
?% &
>& '
GetWalletPeriodById( ;
(; <
int< ?
id@ B
)B C
{ 
var 
response 
= 
await #
_walletPeriodRepository 4
.4 5
GetWalletPeriodById5 H
(H I
idI K
)K L
;L M
return 
Mapper 
. 
Map 
< 
WalletPeriodDto )
>) *
(* +
response+ 3
)3 4
;4 5
} 
public 

async 
Task 
< 
IEnumerable !
<! "
WalletPeriodDto" 1
>1 2
>2 3#
CreateWalletPeriodAsync4 K
(K L
IEnumerableL W
<W X
WalletPeriodRequestX k
>k l
requestm t
)t u
{ 
var 
createdPeriods 
= 
new  
List! %
<% &
WalletPeriodDto& 5
>5 6
(6 7
)7 8
;8 9
foreach!! 
(!! 
var!! 

periodData!! 
in!!  "
request!!# *
)!!* +
{"" 	
var## 
existingPeriod## 
=##  
await##! &#
_walletPeriodRepository##' >
.##> ?
GetWalletPeriodById##? R
(##R S

periodData##S ]
.##] ^
Id##^ `
)##` a
;##a b
if%% 
(%% 
existingPeriod%% 
!=%% !
null%%" &
)%%& '
{&& 
existingPeriod'' 
.'' 
Date'' #
='') *

periodData''+ 5
.''5 6
Date''6 :
;'': ;
existingPeriod(( 
.(( 
Status(( %
=(() *

periodData((+ 5
.((5 6
Status((6 <
;((< =
existingPeriod)) 
.)) 
	UpdatedAt)) (
=))) *
DateTime))+ 3
.))3 4
Now))4 7
;))7 8
await++ #
_walletPeriodRepository++ -
.++- .$
UpdateWalletPeriodsAsync++. F
(++F G
new++G J
List++K O
<++O P
WalletsPeriod++P ]
>++] ^
{++_ `
existingPeriod++a o
}++p q
)++q r
;++r s
createdPeriods-- 
.-- 
Add-- "
(--" #
Mapper--# )
.--) *
Map--* -
<--- .
WalletPeriodDto--. =
>--= >
(--> ?
existingPeriod--? M
)--M N
)--N O
;--O P
}.. 
else// 
{00 
var11 
	newPeriod11 
=11 
new11  #
WalletsPeriod11$ 1
{22 
Date33 
=33 

periodData33  *
.33* +
Date33+ /
,33/ 0
Status44 
=44 

periodData44  *
.44* +
Status44+ 1
,441 2
	CreatedAt55 
=55 
DateTime55  (
.55( )
Now55) ,
,55, -
	UpdatedAt66 
=66 
DateTime66  (
.66( )
Now66) ,
}77 
;77 
await99 #
_walletPeriodRepository99 -
.99- .#
CreateWalletPeriodAsync99. E
(99E F
new99F I
List99J N
<99N O
WalletsPeriod99O \
>99\ ]
{99^ _
	newPeriod99` i
}99j k
)99k l
;99l m
createdPeriods;; 
.;; 
Add;; "
(;;" #
Mapper;;# )
.;;) *
Map;;* -
<;;- .
WalletPeriodDto;;. =
>;;= >
(;;> ?
	newPeriod;;? H
);;H I
);;I J
;;;J K
}<< 
}== 	
return?? 
createdPeriods?? 
;?? 
}@@ 
publicCC 

asyncCC 
TaskCC 
<CC 
WalletPeriodDtoCC %
?CC% &
>CC& '#
DeleteWalletPeriodAsyncCC( ?
(CC? @
intCC@ C
idCCD F
)CCF G
{DD 
varEE 
periodEE 
=EE 
awaitEE #
_walletPeriodRepositoryEE 2
.EE2 3
GetWalletPeriodByIdEE3 F
(EEF G
idEEG I
)EEI J
;EEJ K
ifGG 

(GG 
periodGG 
isGG 
nullGG 
)GG 
returnHH 
nullHH 
;HH 
awaitJJ #
_walletPeriodRepositoryJJ %
.JJ% &#
DeleteWalletPeriodAsyncJJ& =
(JJ= >
periodJJ> D
)JJD E
;JJE F
returnKK 
MapperKK 
.KK 
MapKK 
<KK 
WalletPeriodDtoKK )
>KK) *
(KK* +
periodKK+ 1
)KK1 2
;KK2 3
}LL 
}MM ƒÀ
OC:\HeroSystem\walletService\WalletService.Core\Services\WalletRequestService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class  
WalletRequestService !
:" #
BaseService$ /
,/ 0!
IWalletRequestService1 F
{ 
private 
readonly $
IWalletRequestRepository -$
_walletRequestRepository. F
;F G
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter. D
;D E
private 
readonly 
IInvoiceRepository '
_invoiceRepository. @
;@ A
private 
readonly $
IInvoiceDetailRepository -$
_invoiceDetailRepository. F
;F G
private 
readonly 
IWalletRepository &
_walletRepository. ?
;? @
private 
readonly #
IWalletPeriodRepository ,#
_walletPeriodRepository. E
;E F
private 
readonly #
IBalancePaymentStrategy ,#
_balancePaymentStrategy/ F
;F G
private 
readonly 
IBrandService "
_brandService/ <
;< =
private 
readonly 

RedisCache 
_redisCache/ :
;: ;
public   
 
WalletRequestService   
(    
IMapper!! 
mapper!!! '
,!!' ($
IWalletRequestRepository""  #
walletRequestRepository""! 8
,""8 9"
IAccountServiceAdapter## !
accountServiceAdapter##! 6
,##6 7
IInvoiceRepository$$ 
invoiceRepository$$! 2
,$$2 3$
IInvoiceDetailRepository%%  
invoicesDetails%%! 0
,%%0 1
IWalletRepository&& 
walletRepository&&! 1
,&&1 2#
IWalletPeriodRepository'' "
walletPeriodRepository''! 7
,''7 8#
IBalancePaymentStrategy''9 P"
balancePaymentStrategy''Q g
,''g h
IBrandService(( 
brandService((" .
,((. /

RedisCache)) 

redisCache))" ,
)** 
:** 
base** 
(** 
mapper** 
)** 
{++ $
_walletRequestRepository,,  
=,,! "#
walletRequestRepository,,# :
;,,: ;"
_accountServiceAdapter-- 
=--! "!
accountServiceAdapter--# 8
;--8 9
_invoiceRepository.. 
=..! "
invoiceRepository..# 4
;..4 5$
_invoiceDetailRepository//  
=//! "
invoicesDetails//# 2
;//2 3
_walletRepository00 
=00! "
walletRepository00# 3
;003 4#
_walletPeriodRepository11 
=11! ""
walletPeriodRepository11# 9
;119 :#
_balancePaymentStrategy22 
=22! ""
balancePaymentStrategy22# 9
;229 :
_brandService33 
=33! "
brandService33# /
;33/ 0
_redisCache44 
=44! "

redisCache44# -
;44- .
}55 
public77 

async77 
Task77 
<77 
IEnumerable77 !
<77! "
WalletRequestDto77" 2
>772 3
>773 4!
GetAllWalletsRequests775 J
(77J K
)77K L
{88 
var99 
response99 
=99 
await99 $
_walletRequestRepository99 5
.995 6!
GetAllWalletsRequests996 K
(99K L
_brandService99L Y
.99Y Z
BrandId99Z a
)99a b
;99b c
response:: 
.:: 
Reverse:: 
(:: 
):: 
;:: 
return<< 
Mapper<< 
.<< 
Map<< 
<<< 
IEnumerable<< %
<<<% &
WalletRequestDto<<& 6
><<6 7
><<7 8
(<<8 9
response<<9 A
)<<A B
;<<B C
}== 
public?? 

async?? 
Task?? 
<?? 
IEnumerable?? !
<??! "
WalletRequestDto??" 2
>??2 3
???3 4
>??4 50
$GetAllWalletRequestRevertTransaction??6 Z
(??Z [
)??[ \
{@@ 
varAA 
responseAA 
=AA 
awaitAA $
_walletRequestRepositoryAA 5
.AA5 60
$GetAllWalletRequestRevertTransactionAA6 Z
(AAZ [
_brandServiceAA[ h
.AAh i
BrandIdAAi p
)AAp q
;AAq r
returnCC 
MapperCC 
.CC 
MapCC 
<CC 
IEnumerableCC %
<CC% &
WalletRequestDtoCC& 6
>CC6 7
>CC7 8
(CC8 9
responseCC9 A
)CCA B
;CCB C
}DD 
publicFF 

asyncFF 
TaskFF 
<FF 
IEnumerableFF !
<FF! "
WalletRequestDtoFF" 2
>FF2 3
?FF3 4
>FF4 5 
GetWalletRequestByIdFF6 J
(FFJ K
intFFK N
idFFO Q
)FFQ R
{GG 
varHH 
responseHH 
=HH 
awaitHH $
_walletRequestRepositoryHH 5
.HH5 6,
 GetAllWalletRequestByAffiliateIdHH6 V
(HHV W
idHHW Y
)HHY Z
;HHZ [
returnJJ 
MapperJJ 
.JJ 
MapJJ 
<JJ 
IEnumerableJJ %
<JJ% &
WalletRequestDtoJJ& 6
>JJ6 7
>JJ7 8
(JJ8 9
responseJJ9 A
)JJA B
;JJB C
}KK 
publicMM 

asyncMM 
TaskMM 
<MM 
WalletRequestDtoMM &
?MM& '
>MM' ($
CreateWalletRequestAsyncMM) A
(MMA B 
WalletRequestRequestMMB V
requestMMW ^
)MM^ _
{NN 
boolOO 
isDateValidOO 
=OO 
falseOO  
;OO  !
varPP 
cacheKeyPP 
=PP 
stringPP 
.PP 
FormatPP $
(PP$ %
	CacheKeysPP% .
.PP. /$
BalanceInformationModel2PP/ G
,PPG H
requestPPI P
.PPP Q
AffiliateIdPPQ \
)PP\ ]
;PP] ^
ifRR 

(RR 
_brandServiceRR 
.RR 
BrandIdRR !
isRR" $
$numRR% &
)RR& '
{SS 	
isDateValidTT 
=TT 
awaitTT #
IsWithdrawalDateAllowedTT  7
(TT7 8
)TT8 9
;TT9 :
}UU 	
elseVV 
ifVV 
(VV 
_brandServiceVV 
.VV 
BrandIdVV &
isVV' )
$numVV* +
)VV+ ,
{WW 	
isDateValidXX 
=XX &
IsWithdrawalUtcDateAllowedXX 6
(XX6 7
)XX7 8
;XX8 9
}YY 	
var[[ 
hasWalletBtc[[ 
=[[ 
await[[  
HasWalletAddress[[! 1
([[1 2
request[[2 9
.[[9 :
AffiliateId[[: E
)[[E F
;[[F G
if]] 

(]] 
!]] 
isDateValid]] 
&&]] 
_brandService]] )
.]]) *
BrandId]]* 1
is]]2 4
$num]]5 6
or]]7 9
$num]]: ;
)]]; <
return^^ 
null^^ 
;^^ 
if`` 

(`` 
!`` 
hasWalletBtc`` 
)`` 
returnaa 
nullaa 
;aa 
varcc 
responsecc 
=cc 
awaitdd "
_accountServiceAdapterdd (
.dd( )
VerificationCodedd) 9
(dd9 :
requestdd: A
.ddA B
VerificationCodeddB R
,ddR S
requestddT [
.dd[ \
UserPassworddd\ h
,ddh i
requestddj q
.ddq r
AffiliateIdddr }
,dd} ~
_brandService	dd~ ã
.
ddã å
BrandId
ddå ì
)
ddì î
;
ddî ï
varee  
userAvailableBalanceee  
=ee! "
awaitee# (
_walletRepositoryee) :
.ee: ;,
 GetAvailableBalanceByAffiliateIdee; [
(ee[ \
requestee\ c
.eec d
AffiliateIdeed o
,eeo p
_brandServiceeep }
.ee} ~
BrandId	ee~ Ö
)
eeÖ Ü
;
eeÜ á
varff 
userReverseBalanceff 
=ff! "
awaitff# (
_walletRepositoryff) :
.ff: ;*
GetReverseBalanceByAffiliateIdff; Y
(ffY Z
requestffZ a
.ffa b
AffiliateIdffb m
,ffm n
_brandServiceffn {
.ff{ |
BrandId	ff| É
)
ffÉ Ñ
;
ffÑ Ö
vargg 
isActivePoolgg 
=gg! "
awaitgg# (
_walletRepositorygg) :
.gg: ;.
"IsActivePoolGreaterThanOrEqualTo25gg; ]
(gg] ^
requestgg^ e
.gge f
AffiliateIdggf q
,ggq r
_brandServiceggr 
.	gg Ä
BrandId
ggÄ á
)
ggá à
;
ggà â
ifii 

(ii 
!ii 
isActivePoolii 
&&ii 
_brandServiceii *
.ii* +
BrandIdii+ 2
isii3 5
$numii6 7
)ii7 8
returnjj 
nulljj 
;jj 
ifll 

(ll 
!ll 
responsell 
.ll 
IsSuccessfulll "
)ll" #
returnmm 
nullmm 
;mm 
ifoo 

(oo 
stringoo 
.oo 
IsNullOrEmptyoo  
(oo  !
responseoo! )
.oo) *
Contentoo* 1
)oo1 2
)oo2 3
returnpp 
nullpp 
;pp 
varrr 
resultrr 
=rr 
JsonConvertrr  
.rr  !
DeserializeObjectrr! 2
<rr2 3,
 ServicesValidCodeAccountResponserr3 S
>rrS T
(rrT U
responserrU ]
.rr] ^
Contentrr^ e
)rre f
;rrf g
ifss 

(ss 
resultss 
isss 
{ss 
Datass 
:ss 
falsess #
}ss$ %
)ss% &
returntt 
nulltt 
;tt  
userAvailableBalancevv 
-=vv 
userReverseBalancevv  2
??vv3 5
$numvv6 7
;vv7 8
ifxx 

(xx 
requestxx 
.xx 
Amountxx 
>xx  
userAvailableBalancexx 1
)xx1 2
returnyy 
nullyy 
;yy 
var{{ 
walletRequest{{ 
={{ 
new{{ 
WalletsRequest{{  .
{|| 	
Amount}} 
=}} 
request}} #
.}}# $
Amount}}$ *
,}}* +
Concept~~ 
=~~ 
request~~ #
.~~# $
Concept~~$ +
!~~+ ,
,~~, -
Status 
= 
WalletRequestStatus /
./ 0
pending0 7
.7 8
ToByte8 >
(> ?
)? @
,@ A
AffiliateId
ÄÄ 
=
ÄÄ 
request
ÄÄ #
.
ÄÄ# $
AffiliateId
ÄÄ$ /
,
ÄÄ/ 0
AdminUserName
ÅÅ 
=
ÅÅ 
request
ÅÅ #
.
ÅÅ# $
AffiliateName
ÅÅ$ 1
,
ÅÅ1 2
CreationDate
ÇÇ 
=
ÇÇ 
DateTime
ÇÇ $
.
ÇÇ$ %
Now
ÇÇ% (
,
ÇÇ( )
AttentionDate
ÉÉ 
=
ÉÉ 
null
ÉÉ  
,
ÉÉ  !
OrderNumber
ÑÑ 
=
ÑÑ 
CommonExtensions
ÑÑ ,
.
ÑÑ, -!
GenerateOrderNumber
ÑÑ- @
(
ÑÑ@ A
request
ÑÑA H
.
ÑÑH I
AffiliateId
ÑÑI T
)
ÑÑT U
,
ÑÑU V
Type
ÖÖ 
=
ÖÖ 
WalletRequestType
ÖÖ -
.
ÖÖ- . 
withdrawal_request
ÖÖ. @
.
ÖÖ@ A
ToString
ÖÖA I
(
ÖÖI J
)
ÖÖJ K
,
ÖÖK L
InvoiceNumber
ÜÜ 
=
ÜÜ 
	Constants
ÜÜ %
.
ÜÜ% &

EmptyValue
ÜÜ& 0
,
ÜÜ0 1
BrandId
áá 
=
áá 
_brandService
áá )
.
áá) *
BrandId
áá* 1
,
áá1 2
}
àà 	
;
àà	 

walletRequest
ää 
=
ää 
await
ää &
_walletRequestRepository
ää 6
.
ää6 7&
CreateWalletRequestAsync
ää7 O
(
ääO P
walletRequest
ääP ]
)
ää] ^
;
ää^ _
await
ãã 
_redisCache
ãã 
.
ãã 
Delete
ãã  
(
ãã  !
cacheKey
ãã! )
)
ãã) *
;
ãã* +
return
åå 
Mapper
åå 
.
åå 
Map
åå 
<
åå 
WalletRequestDto
åå *
>
åå* +
(
åå+ ,
walletRequest
åå, 9
)
åå9 :
;
åå: ;
}
çç 
public
èè 

async
èè 
Task
èè 
<
èè 
ServicesResponse
èè &
?
èè& '
>
èè' (
ProcessOption
èè) 6
(
èè6 7
int
èè7 :
pOption
èè; B
,
èèB C
List
èèD H
<
èèH I
long
èèI M
>
èèM N
ids
èèO R
)
èèR S
{
êê 
var
ëë 
response
ëë 
=
ëë 
new
ëë 
ServicesResponse
ëë +
(
ëë+ ,
)
ëë, -
;
ëë- .
switch
ìì 
(
ìì 
pOption
ìì 
)
ìì 
{
îî 	
case
ïï 
$num
ïï 
:
ïï 
await
ññ '
CancelWalletRequestsAsync
ññ /
(
ññ/ 0
ids
ññ0 3
)
ññ3 4
;
ññ4 5
response
óó 
.
óó 
Success
óó  
=
óó! "
true
óó# '
;
óó' (
response
òò 
.
òò 
Message
òò  
=
òò! "
$str
òò# M
;
òòM N
break
ôô 
;
ôô 
case
õõ 
$num
õõ 
:
õõ 
response
ùù 
.
ùù 
Success
ùù  
=
ùù! "
true
ùù# '
;
ùù' (
break
üü 
;
üü 
case
°° 
$num
°° 
:
°° 
response
££ 
.
££ 
Success
££  
=
££! "
true
££# '
;
££' (
break
•• 
;
•• 
case
ßß 
$num
ßß 
:
ßß 
response
©© 
.
©© 
Success
©©  
=
©©! "
true
©©# '
;
©©' (
break
´´ 
;
´´ 
}
¨¨ 	
return
ÆÆ 
response
ÆÆ 
;
ÆÆ 
}
ØØ 
public
±± 

async
±± 
Task
±± '
CancelWalletRequestsAsync
±± /
(
±±/ 0
List
±±0 4
<
±±4 5
long
±±5 9
>
±±9 :
ids
±±; >
)
±±> ?
{
≤≤ 
var
≥≥ 
idsList
≥≥ 
=
≥≥ 
await
≥≥ &
_walletRequestRepository
≥≥ 4
.
≥≥4 5$
GetWalletRequestsByIds
≥≥5 K
(
≥≥K L
ids
≥≥L O
)
≥≥O P
;
≥≥P Q
if
µµ 

(
µµ 
idsList
µµ 
is
µµ 
{
µµ 
Count
µµ 
:
µµ 
$num
µµ  !
}
µµ" #
)
µµ# $
return
∂∂ 
;
∂∂ 
var
∏∏ 
today
∏∏ 
=
∏∏ 
DateTime
∏∏ 
.
∏∏ 
Now
∏∏  
;
∏∏  !
Parallel
∫∫ 
.
∫∫ 
ForEach
∫∫ 
(
∫∫ 
idsList
∫∫  
,
∫∫  !
item
∫∫" &
=>
∫∫' )
{
ªª 	
item
ºº 
.
ºº 
AttentionDate
ºº 
=
ºº  
today
ºº! &
;
ºº& '
item
ΩΩ 
.
ΩΩ 
	UpdatedAt
ΩΩ 
=
ΩΩ  
today
ΩΩ! &
;
ΩΩ& '
item
ææ 
.
ææ 
Status
ææ 
=
ææ  !
WalletRequestStatus
ææ! 4
.
ææ4 5
cancel
ææ5 ;
.
ææ; <
ToByte
ææ< B
(
ææB C
)
ææC D
;
ææD E
}
øø 	
)
øø	 

;
øø
 
foreach
¡¡ 
(
¡¡ 
var
¡¡ 
userId
¡¡ 
in
¡¡ 
ids
¡¡ "
)
¡¡" #
{
¬¬ 	
var
√√ 
cacheKey
√√ 
=
√√ 
string
√√ !
.
√√! "
Format
√√" (
(
√√( )
	CacheKeys
√√) 2
.
√√2 3&
BalanceInformationModel2
√√3 K
,
√√K L
userId
√√M S
)
√√S T
;
√√T U
await
ƒƒ 
_redisCache
ƒƒ 
.
ƒƒ 
Delete
ƒƒ $
(
ƒƒ$ %
cacheKey
ƒƒ% -
)
ƒƒ- .
;
ƒƒ. /
}
≈≈ 	
await
«« &
_walletRequestRepository
«« &
.
««& '+
UpdateBulkWalletRequestsAsync
««' D
(
««D E
idsList
««E L
.
««L M
ToList
««M S
(
««S T
)
««T U
)
««U V
;
««V W
}
»» 
public
   

async
   
Task
   
<
   
WalletRequestDto
   &
?
  & '
>
  ' ('
CreateWalletRequestRevert
  ) B
(
  B C,
WalletRequestRevertTransaction
  C a
request
  b i
)
  i j
{
ÀÀ 
var
ÃÃ 
response
ÃÃ 
=
ÃÃ 
await
ÃÃ $ 
_invoiceRepository
ÃÃ% 7
.
ÃÃ7 8
GetInvoiceById
ÃÃ8 F
(
ÃÃF G
request
ÃÃG N
.
ÃÃN O
	InvoiceId
ÃÃO X
,
ÃÃX Y
_brandService
ÃÃY f
.
ÃÃf g
BrandId
ÃÃg n
)
ÃÃn o
;
ÃÃo p
var
ÕÕ 
userInfoResponse
ÕÕ 
=
ÕÕ 
await
ÕÕ $$
_accountServiceAdapter
ÕÕ% ;
.
ÕÕ; <
GetUserInfo
ÕÕ< G
(
ÕÕG H
response
ÕÕH P
!
ÕÕP Q
.
ÕÕQ R
AffiliateId
ÕÕR ]
,
ÕÕ] ^
_brandService
ÕÕ^ k
.
ÕÕk l
BrandId
ÕÕl s
)
ÕÕs t
;
ÕÕt u
var
œœ 
amountReverted
œœ 
=
œœ 
response
œœ &
.
œœ& '
TotalInvoice
œœ' 3
*
œœ4 5
(
œœ6 7
decimal
œœ7 >
?
œœ> ?
)
œœ? @
$num
œœ@ D
;
œœD E
var
–– 
leftOverBalance
–– 
=
–– 
response
–– &
.
––& '
TotalInvoice
––' 3
-
––4 5
amountReverted
––6 D
;
––D E
var
““ 
creditRequest
““ 
=
““ 
new
““ &
CreditTransactionRequest
““  8
{
”” 	
AffiliateId
‘‘ 
=
‘‘ 
request
‘‘  '
.
‘‘' (
AffiliateId
‘‘( 3
,
‘‘3 4
UserId
’’ 
=
’’ 
	Constants
’’  )
.
’’) *
AdminUserId
’’* 5
,
’’5 6
Concept
÷÷ 
=
÷÷ 
	Constants
÷÷  )
.
÷÷) *"
RevertEcoPoolConcept
÷÷* >
+
÷÷? @
$"
÷÷A C
$str
÷÷C M
{
÷÷M N
request
÷÷N U
.
÷÷U V
	InvoiceId
÷÷V _
}
÷÷_ `
"
÷÷` a
,
÷÷a b
Credit
◊◊ 
=
◊◊ 
Convert
◊◊  '
.
◊◊' (
ToDouble
◊◊( 0
(
◊◊0 1
amountReverted
◊◊1 ?
)
◊◊? @
,
◊◊@ A
AffiliateUserName
ÿÿ 
=
ÿÿ 
userInfoResponse
ÿÿ  0
!
ÿÿ0 1
.
ÿÿ1 2
UserName
ÿÿ2 :
,
ÿÿ: ;
AdminUserName
ŸŸ 
=
ŸŸ 
	Constants
ŸŸ  )
.
ŸŸ) *$
AdminEcosystemUserName
ŸŸ* @
,
ŸŸ@ A
ConceptType
⁄⁄ 
=
⁄⁄ 
WalletConceptType
⁄⁄  1
.
⁄⁄1 2
revert_pool
⁄⁄2 =
.
⁄⁄= >
ToString
⁄⁄> F
(
⁄⁄F G
)
⁄⁄G H
,
⁄⁄H I
BrandId
€€ 
=
€€ 
_brandService
€€  -
.
€€- .
BrandId
€€. 5
}
‹‹ 	
;
‹‹	 

var
ﬁﬁ 
walletRequest
ﬁﬁ 
=
ﬁﬁ 
new
ﬁﬁ 
WalletsRequest
ﬁﬁ  .
{
ﬂﬂ 	
AffiliateId
‡‡ 
=
‡‡ 
response
‡‡ $
.
‡‡$ %
AffiliateId
‡‡% 0
,
‡‡0 1
AdminUserName
·· 
=
·· 
userInfoResponse
·· ,
.
··, -
UserName
··- 5
,
··5 6
OrderNumber
‚‚ 
=
‚‚ 
CommonExtensions
‚‚ ,
.
‚‚, -!
GenerateOrderNumber
‚‚- @
(
‚‚@ A
request
‚‚A H
.
‚‚H I
AffiliateId
‚‚I T
)
‚‚T U
,
‚‚U V
InvoiceNumber
„„ 
=
„„ 
response
„„ $
.
„„$ %
Id
„„% '
,
„„' (
Amount
‰‰ 
=
‰‰ 
response
‰‰ $
.
‰‰$ %
TotalInvoice
‰‰% 1
??
‰‰2 4
$num
‰‰5 6
,
‰‰6 7
Concept
ÂÂ 
=
ÂÂ 
request
ÂÂ #
.
ÂÂ# $
Concept
ÂÂ$ +
,
ÂÂ+ ,
Type
ÊÊ 
=
ÊÊ 
WalletRequestType
ÊÊ -
.
ÊÊ- .$
revert_invoice_request
ÊÊ. D
.
ÊÊD E
ToString
ÊÊE M
(
ÊÊM N
)
ÊÊN O
,
ÊÊO P
Status
ÁÁ 
=
ÁÁ !
WalletRequestStatus
ÁÁ /
.
ÁÁ/ 0
pending
ÁÁ0 7
.
ÁÁ7 8
ToByte
ÁÁ8 >
(
ÁÁ> ?
)
ÁÁ? @
,
ÁÁ@ A
CreationDate
ËË 
=
ËË 
DateTime
ËË $
.
ËË$ %
Now
ËË% (
,
ËË( )
AttentionDate
ÈÈ 
=
ÈÈ 
null
ÈÈ  
,
ÈÈ  !
BrandId
ÍÍ 
=
ÍÍ 
_brandService
ÍÍ )
.
ÍÍ) *
BrandId
ÍÍ* 1
}
ÎÎ 	
;
ÎÎ	 

walletRequest
ÌÌ 
=
ÌÌ 
await
ÌÌ &
_walletRequestRepository
ÌÌ 6
.
ÌÌ6 7&
CreateWalletRequestAsync
ÌÌ7 O
(
ÌÌO P
walletRequest
ÌÌP ]
)
ÌÌ] ^
;
ÌÌ^ _
var
ÔÔ 
walletMovement
ÔÔ 
=
ÔÔ 
await
ÔÔ "&
_walletRequestRepository
ÔÔ# ;
.
ÔÔ; <.
 GetWalletRequestsByInvoiceNumber
ÔÔ< \
(
ÔÔ\ ]
request
ÔÔ] d
.
ÔÔd e
	InvoiceId
ÔÔe n
)
ÔÔn o
;
ÔÔo p
if
ÒÒ 

(
ÒÒ 
walletMovement
ÒÒ 
==
ÒÒ 
null
ÒÒ "
)
ÒÒ" #
return
ÚÚ 
null
ÚÚ 
;
ÚÚ 
if
ÙÙ 

(
ÙÙ 
walletRequest
ÙÙ 
!=
ÙÙ 
null
ÙÙ !
)
ÙÙ! "
{
ıı 	
await
ˆˆ %
DeleteInvoiceAndDetails
ˆˆ )
(
ˆˆ) *
request
ˆˆ* 1
.
ˆˆ1 2
	InvoiceId
ˆˆ2 ;
)
ˆˆ; <
;
ˆˆ< =
await
˜˜ 
_walletRepository
˜˜ #
.
˜˜# $
CreditTransaction
˜˜$ 5
(
˜˜5 6
creditRequest
˜˜6 C
)
˜˜C D
;
˜˜D E
await
¯¯ !
CreateCustomEcoPool
¯¯ %
(
¯¯% &
userInfoResponse
¯¯& 6
,
¯¯6 7
leftOverBalance
¯¯8 G
)
¯¯G H
;
¯¯H I
walletMovement
˘˘ 
.
˘˘ 
Status
˘˘ !
=
˘˘" #!
WalletRequestStatus
˘˘$ 7
.
˘˘7 8
approved
˘˘8 @
.
˘˘@ A
ToByte
˘˘A G
(
˘˘G H
)
˘˘H I
;
˘˘I J
await
˙˙ &
UpdateWalletRequestAsync
˙˙ *
(
˙˙* +
walletMovement
˙˙+ 9
)
˙˙9 :
;
˙˙: ;
}
˚˚ 	
return
˛˛ 
Mapper
˛˛ 
.
˛˛ 
Map
˛˛ 
<
˛˛ 
WalletRequestDto
˛˛ *
>
˛˛* +
(
˛˛+ ,
walletRequest
˛˛, 9
)
˛˛9 :
;
˛˛: ;
}
ˇˇ 
private
ÅÅ 
async
ÅÅ 
Task
ÅÅ 
<
ÅÅ 
bool
ÅÅ 
>
ÅÅ !
CreateCustomEcoPool
ÅÅ 0
(
ÅÅ0 1
UserInfoResponse
ÅÅ1 A
user
ÅÅB F
,
ÅÅF G
decimal
ÅÅH O
?
ÅÅO P
leftOverBalance
ÅÅQ `
)
ÅÅ` a
{
ÇÇ 
if
ÉÉ 

(
ÉÉ 
user
ÉÉ 
is
ÉÉ 
null
ÉÉ 
)
ÉÉ 
return
ÑÑ 
false
ÑÑ 
;
ÑÑ 
var
ÜÜ 
walletRequest
ÜÜ 
=
ÜÜ 
new
ÜÜ 
WalletRequest
ÜÜ  -
{
áá 	
AffiliateId
àà 
=
àà 
user
àà  $
.
àà$ %
Id
àà% '
,
àà' (
AffiliateUserName
ââ 
=
ââ 
user
ââ  $
.
ââ$ %
UserName
ââ% -
!
ââ- .
,
ââ. /
PurchaseFor
ää 
=
ää 
$num
ää  !
,
ää! "
Bank
ãã 
=
ãã 
	Constants
ãã  )
.
ãã) *
WalletBalance
ãã* 7
,
ãã7 8
PaymentMethod
åå 
=
åå 
$num
åå  !
,
åå! "
	SecretKey
çç 
=
çç 
null
çç  $
,
çç$ %
ReceiptNumber
éé 
=
éé 
leftOverBalance
éé  /
.
éé/ 0
ToString
éé0 8
(
éé8 9
)
éé9 :
,
éé: ;
BrandId
èè 
=
èè 
_brandService
èè  -
.
èè- .
BrandId
èè. 5
,
èè5 6
ProductsList
êê 
=
êê 
new
êê 
List
êê #
<
êê# $
ProductsRequests
êê$ 4
>
êê4 5
{
ëë 
new
íí 
ProductsRequests
íí $
{
ìì 
Count
îî 
=
îî 
$num
îî  !
,
îî! "
	IdProduct
ïï 
=
ïï 
$num
ïï  "
}
ññ 
}
óó 
,
óó 
}
òò 	
;
òò	 

return
öö 
await
öö %
_balancePaymentStrategy
öö ,
.
öö, -"
ExecuteCustomPayment
öö- A
(
ööA B
walletRequest
ööB O
)
ööO P
;
ööP Q
}
õõ 
private
ùù 
async
ùù 
Task
ùù 
<
ùù 
bool
ùù 
>
ùù %
DeleteInvoiceAndDetails
ùù 4
(
ùù4 5
int
ùù5 8
invoiceNumber
ùù9 F
)
ùùF G
{
ûû 
try
üü 
{
†† 	
var
°° 
invoiceResponse
°° 
=
°°& '
await
°°( - 
_invoiceRepository
°°. @
.
°°@ A
GetInvoiceById
°°A O
(
°°O P
invoiceNumber
°°P ]
,
°°] ^
_brandService
°°^ k
.
°°k l
BrandId
°°l s
)
°°s t
;
°°t u
var
¢¢ #
invoiceDetailResponse
¢¢ %
=
¢¢& '
await
¢¢( -&
_invoiceDetailRepository
¢¢. F
.
¢¢F G.
 GetInvoiceDetailByInvoiceIdAsync
¢¢G g
(
¢¢g h
invoiceNumber
¢¢h u
)
¢¢u v
;
¢¢v w
if
§§ 
(
§§ 
invoiceResponse
§§ 
is
§§  "
null
§§# '
||
§§( *#
invoiceDetailResponse
§§+ @
.
§§@ A
Any
§§A D
(
§§D E
)
§§E F
==
§§G I
false
§§J O
)
§§O P
return
•• 
false
•• 
;
•• 
await
ßß  
_invoiceRepository
ßß $
.
ßß$ % 
DeleteInvoiceAsync
ßß% 7
(
ßß7 8
invoiceResponse
ßß8 G
)
ßßG H
;
ßßH I
await
®® &
_invoiceDetailRepository
®® *
.
®®* +*
DeleteBulkInvoiceDetailAsync
®®+ G
(
®®G H#
invoiceDetailResponse
®®H ]
)
®®] ^
;
®®^ _
return
™™ 
true
™™ 
;
™™ 
}
´´ 	
catch
≠≠ 
(
≠≠ 
	Exception
≠≠ 
)
≠≠ 
{
ÆÆ 	
return
ØØ 
false
ØØ 
;
ØØ 
}
∞∞ 	
}
±± 
private
≤≤ 
async
≤≤ 
Task
≤≤ &
UpdateWalletRequestAsync
≤≤ /
(
≤≤/ 0
WalletsRequest
≤≤0 >
walletRequest
≤≤? L
)
≤≤L M
{
≥≥ 
walletRequest
¥¥ 
.
¥¥ 
AttentionDate
¥¥ #
=
¥¥$ %
DateTime
¥¥& .
.
¥¥. /
Now
¥¥/ 2
;
¥¥2 3
await
µµ &
_walletRequestRepository
µµ &
.
µµ& ''
UpdateWalletRequestsAsync
µµ' @
(
µµ@ A
walletRequest
µµA N
)
µµN O
;
µµO P
}
∂∂ 
public
∑∑ 

async
∑∑ 
Task
∑∑ 
<
∑∑ 
bool
∑∑ 
>
∑∑ (
AdministrativePaymentAsync
∑∑ 6
(
∑∑6 7
WalletsRequest
∑∑7 E
[
∑∑E F
]
∑∑F G
requests
∑∑H P
)
∑∑P Q
{
∏∏ 
if
ππ 

(
ππ 
requests
ππ 
.
ππ 
Length
ππ 
is
ππ 
$num
ππ  
)
ππ  !
return
∫∫ 
false
∫∫ 
;
∫∫ 
var
ºº 
userIds
ºº 
=
ºº 
requests
ºº 
.
ºº 
Select
ºº %
(
ºº% &
x
ºº& '
=>
ºº( *
x
ºº+ ,
.
ºº, -
AffiliateId
ºº- 8
)
ºº8 9
.
ºº9 :
Distinct
ºº: B
(
ººB C
)
ººC D
.
ººD E
ToList
ººE K
(
ººK L
)
ººL M
;
ººM N
var
ææ 
tasks
ææ 
=
ææ 
userIds
ææ #
.
ææ# $
Select
ææ$ *
(
ææ* +
id
ææ+ -
=>
ææ. 0$
_accountServiceAdapter
ææ1 G
.
ææG H
GetUserInfo
ææH S
(
ææS T
id
ææT V
,
ææV W
_brandService
ææW d
.
ææd e
BrandId
ææe l
)
ææl m
)
ææm n
.
ææn o
ToArray
ææo v
(
ææv w
)
ææw x
;
ææx y
var
øø 
userInfoArray
øø 
=
øø 
await
øø !
Task
øø" &
.
øø& '
WhenAll
øø' .
(
øø. /
tasks
øø/ 4
)
øø4 5
;
øø5 6
var
¿¿ 
userInfoList
¿¿ 
=
¿¿ 
userInfoArray
¿¿ )
.
¿¿) *
Where
¿¿* /
(
¿¿/ 0
u
¿¿0 1
=>
¿¿2 4
u
¿¿5 6
!=
¿¿7 9
null
¿¿: >
)
¿¿> ?
.
¿¿? @
ToList
¿¿@ F
(
¿¿F G
)
¿¿G H
;
¿¿H I
var
¡¡ 
today
¡¡ 
=
¡¡ 
DateTime
¡¡ $
.
¡¡$ %
Now
¡¡% (
;
¡¡( )
var
√√ 
walletsList
√√ 
=
√√ 
new
√√ 
List
√√ "
<
√√" #
Wallet
√√# )
>
√√) *
(
√√* +
)
√√+ ,
;
√√, -
var
ƒƒ 
idsList
ƒƒ 
=
ƒƒ 
new
ƒƒ 
List
ƒƒ "
<
ƒƒ" #
WalletsRequest
ƒƒ# 1
>
ƒƒ1 2
(
ƒƒ2 3
)
ƒƒ3 4
;
ƒƒ4 5
foreach
∆∆ 
(
∆∆ 
var
∆∆ 
user
∆∆ 
in
∆∆ 
userInfoList
∆∆ )
)
∆∆) *
{
«« 	
var
»» "
correspondingRequest
»» $
=
»»% &
requests
»»' /
.
»»/ 0
FirstOrDefault
»»0 >
(
»»> ?
r
»»? @
=>
»»A C
r
»»D E
.
»»E F
AffiliateId
»»F Q
==
»»R T
user
»»U Y
!
»»Y Z
.
»»Z [
Id
»»[ ]
)
»»] ^
;
»»^ _
if
…… 
(
…… "
correspondingRequest
…… $
!=
……% '
null
……( ,
)
……, -
{
   
var
ÀÀ 
walletEntry
ÀÀ 
=
ÀÀ  !
new
ÀÀ" %
Wallet
ÀÀ& ,
{
ÃÃ 
AffiliateId
ÕÕ 
=
ÕÕ& '
user
ÕÕ( ,
!
ÕÕ, -
.
ÕÕ- .
Id
ÕÕ. 0
,
ÕÕ0 1
AffiliateUserName
ŒŒ %
=
ŒŒ& '
user
ŒŒ( ,
.
ŒŒ, -
UserName
ŒŒ- 5
,
ŒŒ5 6
AdminUserName
œœ !
=
œœ& '
	Constants
œœ( 1
.
œœ1 2$
AdminEcosystemUserName
œœ2 H
,
œœH I
UserId
–– 
=
––& '
	Constants
––( 1
.
––1 2
AdminUserId
––2 =
,
––= >
Credit
—— 
=
——& '
	Constants
——( 1
.
——1 2

EmptyValue
——2 <
,
——< =
Debit
““ 
=
““& '"
correspondingRequest
““( <
.
““< =
Amount
““= C
,
““C D
Deferred
”” 
=
””& '
	Constants
””( 1
.
””1 2

EmptyValue
””2 <
,
””< =
Status
‘‘ 
=
‘‘& '
true
‘‘( ,
,
‘‘, -
Concept
’’ 
=
’’& '
	Constants
’’( 1
.
’’1 2
WithdrawalBalance
’’2 C
,
’’C D
ConceptType
÷÷ 
=
÷÷& '
WalletConceptType
÷÷( 9
.
÷÷9 :'
wallet_withdrawal_request
÷÷: S
.
÷÷S T
ToString
÷÷T \
(
÷÷\ ]
)
÷÷] ^
,
÷÷^ _
Support
◊◊ 
=
◊◊& '
	Constants
◊◊( 1
.
◊◊1 2

EmptyValue
◊◊2 <
,
◊◊< =
Date
ÿÿ 
=
ÿÿ& '
today
ÿÿ( -
,
ÿÿ- .
Compression
ŸŸ 
=
ŸŸ& '
false
ŸŸ( -
,
ŸŸ- .
Detail
⁄⁄ 
=
⁄⁄& '
null
⁄⁄( ,
,
⁄⁄, -
	CreatedAt
€€ 
=
€€& '
today
€€( -
,
€€- .
	UpdatedAt
‹‹ 
=
‹‹& '
today
‹‹( -
,
‹‹- .
	DeletedAt
›› 
=
››& '
null
››( ,
,
››, -
BrandId
ﬁﬁ 
=
ﬁﬁ& '
_brandService
ﬁﬁ( 5
.
ﬁﬁ5 6
BrandId
ﬁﬁ6 =
,
ﬁﬁ= >
}
ﬂﬂ 
;
ﬂﬂ 
walletsList
·· 
.
·· 
Add
·· 
(
··  
walletEntry
··  +
)
··+ ,
;
··, -
idsList
‚‚ 
.
‚‚ 
Add
‚‚ 
(
‚‚ "
correspondingRequest
‚‚ 0
)
‚‚0 1
;
‚‚1 2
}
„„ 
}
‰‰ 	
if
ÊÊ 

(
ÊÊ 
!
ÊÊ 
idsList
ÊÊ 
.
ÊÊ 
Any
ÊÊ 
(
ÊÊ 
)
ÊÊ 
)
ÊÊ 
return
ÁÁ 
false
ÁÁ 
;
ÁÁ 
var
ÈÈ 
result
ÈÈ 
=
ÈÈ 
await
ÈÈ 
_walletRepository
ÈÈ ,
.
ÈÈ, -0
"BulkAdministrativeDebitTransaction
ÈÈ- O
(
ÈÈO P
walletsList
ÈÈP [
.
ÈÈ[ \
ToArray
ÈÈ\ c
(
ÈÈc d
)
ÈÈd e
)
ÈÈe f
;
ÈÈf g
if
ÎÎ 

(
ÎÎ 
!
ÎÎ 
result
ÎÎ 
)
ÎÎ 
return
ÏÏ 
false
ÏÏ 
;
ÏÏ 
Parallel
ÓÓ 
.
ÓÓ 
ForEach
ÓÓ 
(
ÓÓ 
idsList
ÓÓ  
,
ÓÓ  !
item
ÓÓ" &
=>
ÓÓ' )
{
ÔÔ 	
item
 
.
 
AttentionDate
 
=
  
today
! &
;
& '
item
ÒÒ 
.
ÒÒ 
	UpdatedAt
ÒÒ 
=
ÒÒ  
today
ÒÒ! &
;
ÒÒ& '
item
ÚÚ 
.
ÚÚ 
Status
ÚÚ 
=
ÚÚ  !
WalletRequestStatus
ÚÚ! 4
.
ÚÚ4 5
approved
ÚÚ5 =
.
ÚÚ= >
ToByte
ÚÚ> D
(
ÚÚD E
)
ÚÚE F
;
ÚÚF G
}
ÛÛ 	
)
ÛÛ	 

;
ÛÛ
 
await
ıı &
_walletRequestRepository
ıı &
.
ıı& '+
UpdateBulkWalletRequestsAsync
ıı' D
(
ııD E
idsList
ııE L
)
ııL M
;
ııM N
return
˜˜ 
true
˜˜ 
;
˜˜ 
}
¯¯ 
private
˙˙ 
async
˙˙ 
Task
˙˙ 
<
˙˙ 
bool
˙˙ 
>
˙˙ %
IsWithdrawalDateAllowed
˙˙ 4
(
˙˙4 5
)
˙˙5 6
{
˚˚ 
var
¸¸ 
defaultZone
¸¸ 
=
¸¸ 
	Constants
¸¸ #
.
¸¸# $#
DefaultWithdrawalZone
¸¸$ 9
;
¸¸9 :
var
˛˛ 
timeZone
˛˛ 
=
˛˛ 
TimeZoneInfo
˛˛ (
.
˛˛( )$
FindSystemTimeZoneById
˛˛) ?
(
˛˛? @
defaultZone
˛˛@ K
)
˛˛K L
;
˛˛L M
var
ˇˇ 
localDateTime
ˇˇ 
=
ˇˇ 
TimeZoneInfo
ˇˇ (
.
ˇˇ( ) 
ConvertTimeFromUtc
ˇˇ) ;
(
ˇˇ; <
DateTime
ˇˇ< D
.
ˇˇD E
UtcNow
ˇˇE K
,
ˇˇK L
timeZone
ˇˇM U
)
ˇˇU V
;
ˇˇV W
if
ÅÅ 

(
ÅÅ 
localDateTime
ÅÅ 
.
ÅÅ 
	TimeOfDay
ÅÅ #
<
ÅÅ$ %
new
ÅÅ& )
TimeSpan
ÅÅ* 2
(
ÅÅ2 3
$num
ÅÅ3 4
,
ÅÅ4 5
$num
ÅÅ6 7
,
ÅÅ7 8
$num
ÅÅ9 :
)
ÅÅ: ;
||
ÅÅ< >
localDateTime
ÅÅ? L
.
ÅÅL M
	TimeOfDay
ÅÅM V
>
ÅÅW X
new
ÅÅY \
TimeSpan
ÅÅ] e
(
ÅÅe f
$num
ÅÅf h
,
ÅÅh i
$num
ÅÅj k
,
ÅÅk l
$num
ÅÅm n
)
ÅÅn o
)
ÅÅo p
return
ÇÇ 
false
ÇÇ 
;
ÇÇ 
var
ÑÑ !
allowedDatesObjects
ÑÑ 
=
ÑÑ  !
await
ÑÑ" '%
_walletPeriodRepository
ÑÑ( ?
.
ÑÑ? @"
GetAllWalletsPeriods
ÑÑ@ T
(
ÑÑT U
)
ÑÑU V
;
ÑÑV W
var
ÜÜ 
allowedDates
ÜÜ 
=
ÜÜ !
allowedDatesObjects
ÜÜ .
.
ÜÜ. /
Select
ÜÜ/ 5
(
ÜÜ5 6
wp
ÜÜ6 8
=>
ÜÜ9 ;
wp
ÜÜ< >
.
ÜÜ> ?
Date
ÜÜ? C
)
ÜÜC D
.
ÜÜD E
ToList
ÜÜE K
(
ÜÜK L
)
ÜÜL M
;
ÜÜM N
var
àà 
localDateOnly
àà 
=
àà 
DateOnly
àà $
.
àà$ %
FromDateTime
àà% 1
(
àà1 2
localDateTime
àà2 ?
.
àà? @
Date
àà@ D
)
ààD E
;
ààE F
return
ââ 
allowedDates
ââ 
.
ââ 
Contains
ââ $
(
ââ$ %
localDateOnly
ââ% 2
)
ââ2 3
;
ââ3 4
}
ää 
private
åå 
bool
åå (
IsWithdrawalUtcDateAllowed
åå +
(
åå+ ,
)
åå, -
{
çç 
var
éé 
utcNow
éé 
=
éé 
DateTime
éé 
.
éé 
UtcNow
éé $
;
éé$ %
if
êê 

(
êê 
utcNow
êê 
.
êê 
	DayOfWeek
êê 
!=
êê 
	DayOfWeek
êê  )
.
êê) *
Friday
êê* 0
)
êê0 1
return
ëë 
false
ëë 
;
ëë 
var
ìì 
	startTime
ìì 
=
ìì 
new
ìì 
TimeSpan
ìì $
(
ìì$ %
$num
ìì% &
,
ìì& '
$num
ìì( )
,
ìì) *
$num
ìì+ ,
)
ìì, -
;
ìì- .
var
îî 
endTime
îî 
=
îî 
new
îî 
TimeSpan
îî "
(
îî" #
$num
îî# %
,
îî% &
$num
îî' (
,
îî( )
$num
îî* +
)
îî+ ,
;
îî, -
var
óó 
currentTime
óó 
=
óó 
utcNow
óó  
.
óó  !
	TimeOfDay
óó! *
;
óó* +
return
òò 
currentTime
òò 
>=
òò 
	startTime
òò '
&&
òò( *
currentTime
òò+ 6
<=
òò7 9
endTime
òò: A
;
òòA B
}
ôô 
private
õõ 
async
õõ 
Task
õõ 
<
õõ 
bool
õõ 
>
õõ 
HasWalletAddress
õõ -
(
õõ- .
int
õõ. 1
affiliateId
õõ2 =
)
õõ= >
{
úú 
var
ùù 
response
ùù 
=
ùù 
await
ùù $
_accountServiceAdapter
ùù 3
.
ùù3 4*
GetAffiliateBtcByAffiliateId
ùù4 P
(
ùùP Q
affiliateId
ùùQ \
,
ùù\ ]
_brandService
ùù] j
.
ùùj k
BrandId
ùùk r
)
ùùr s
;
ùùs t
if
üü 

(
üü 
response
üü 
.
üü 
Content
üü 
is
üü 
null
üü  $
)
üü$ %
return
†† 
false
†† 
;
†† 
var
¢¢ 
userInfo
¢¢ 
=
¢¢ 
JsonConvert
¢¢ "
.
¢¢" #
DeserializeObject
¢¢# 4
<
¢¢4 5"
AffiliateBtcResponse
¢¢5 I
>
¢¢I J
(
¢¢J K
response
¢¢K S
.
¢¢S T
Content
¢¢T [
)
¢¢[ \
;
¢¢\ ]
if
§§ 

(
§§ 
userInfo
§§ 
?
§§ 
.
§§ 
Data
§§ 
is
§§ 
null
§§ "
)
§§" #
return
•• 
false
•• 
;
•• 
if
ßß 

(
ßß 
userInfo
ßß 
.
ßß 
Data
ßß 
.
ßß 
Length
ßß  
==
ßß! #
$num
ßß$ %
)
ßß% &
return
®® 
false
®® 
;
®® 
return
™™ 
true
™™ 
;
™™ 
}
´´ 
}¨¨ ÁA
WC:\HeroSystem\walletService\WalletService.Core\Services\WalletRetentionConfigService.cs
	namespace		 	
WalletService		
 
.		 
Core		 
.		 
Services		 %
;		% &
public 
class (
WalletRetentionConfigService )
:* +
BaseService, 7
,7 8)
IWalletRetentionConfigService9 V
{ 
private 
readonly ,
 IWalletRetentionConfigRepository 5,
 _walletRetentionConfigRepository6 V
;V W
public 
(
WalletRetentionConfigService '
(' (
IMapper( /
mapper0 6
,6 7,
 IWalletRetentionConfigRepository8 X+
walletRetentionConfigRepositoryY x
)x y
:z {
base	| Ä
(
Ä Å
mapper
Å á
)
á à
=> 
,
 _walletRetentionConfigRepository +
=, -+
walletRetentionConfigRepository. M
;M N
public 

async 
Task 
< 
IEnumerable !
<! "$
WalletRetentionConfigDto" :
>: ;
>; <(
GetAllWalletsRetentionConfig= Y
(Y Z
)Z [
{ 
var 
response 
= 
await ,
 _walletRetentionConfigRepository =
.= >(
GetAllWalletsRetentionConfig> Z
(Z [
)[ \
;\ ]
return 
Mapper 
. 
Map 
< 
IEnumerable %
<% &$
WalletRetentionConfigDto& >
>> ?
>? @
(@ A
responseA I
)I J
;J K
} 
public 

async 
Task 
< $
WalletRetentionConfigDto .
?. /
>/ 0(
GetWalletRetentionConfigById1 M
(M N
intN Q
idR T
)T U
{ 
var 
response 
= 
await ,
 _walletRetentionConfigRepository =
.= >(
GetWalletRetentionConfigById> Z
(Z [
id[ ]
)] ^
;^ _
return 
Mapper 
. 
Map 
< $
WalletRetentionConfigDto 2
>2 3
(3 4
response4 <
)< =
;= >
} 
public 

async 
Task 
< 
IEnumerable !
<! "$
WalletRetentionConfigDto" :
>: ;
>; <,
 CreateWalletRetentionConfigAsync= ]
(] ^
IEnumerable 
< (
WalletRetentionConfigRequest 0
>0 1
request2 9
)9 :
{   
var!! 
createdPeriods!! 
=!! 
new!!  
List!!! %
<!!% &$
WalletRetentionConfigDto!!& >
>!!> ?
(!!? @
)!!@ A
;!!A B
foreach## 
(## 
var## 

periodData## 
in##  "
request### *
)##* +
{$$ 	
var%% #
existingPeriodRetention%% '
=%%( )
await%%* /,
 _walletRetentionConfigRepository%%0 P
.%%P Q(
GetWalletRetentionConfigById%%Q m
(%%m n

periodData%%n x
.%%x y
Id%%y {
)%%{ |
;%%| }
if'' 
('' #
existingPeriodRetention'' '
!=''( *
null''+ /
)''/ 0
{(( #
existingPeriodRetention)) '
.))' (
WithdrawalTo))( 4
=))7 8

periodData))9 C
.))C D
WithdrawalTo))D P
;))P Q#
existingPeriodRetention** '
.**' (
WithdrawalFrom**( 6
=**7 8

periodData**9 C
.**C D
WithdrawalFrom**D R
;**R S#
existingPeriodRetention++ '
.++' (
DisableDate++( 3
=++7 8

periodData++9 C
.++C D
DisableDate++D O
;++O P#
existingPeriodRetention,, '
.,,' (

Percentage,,( 2
=,,7 8

periodData,,9 C
.,,C D

Percentage,,D N
;,,N O#
existingPeriodRetention-- '
.--' (
Date--( ,
=--7 8

periodData--9 C
.--C D
Date--D H
;--H I#
existingPeriodRetention.. '
...' (
Status..( .
=..7 8

periodData..9 C
...C D
Status..D J
;..J K#
existingPeriodRetention// '
.//' (
	UpdatedAt//( 1
=//7 8
DateTime//9 A
.//A B
Now//B E
;//E F
await11 ,
 _walletRetentionConfigRepository11 6
.116 7,
 UpdateWalletRetentionConfigAsync117 W
(11W X
new11X [
List11\ `
<11` a#
WalletsRetentionsConfig11a x
>11x y
{22 #
existingPeriodRetention22 -
}22. /
)22/ 0
;220 1
createdPeriods33 
.33 
Add33 "
(33" #
Mapper33# )
.33) *
Map33* -
<33- .$
WalletRetentionConfigDto33. F
>33F G
(33G H#
existingPeriodRetention33H _
)33_ `
)33` a
;33a b
}44 
else55 
{66 
var77 
newPeriodRetention77 &
=77' (
new77) ,#
WalletsRetentionsConfig77- D
{88 
WithdrawalFrom99 "
=99# $

periodData99% /
.99/ 0
WithdrawalFrom990 >
,99> ?
WithdrawalTo::  
=::# $

periodData::% /
.::/ 0
WithdrawalTo::0 <
,::< =

Percentage;; 
=;;# $

periodData;;% /
.;;/ 0

Percentage;;0 :
,;;: ;
DisableDate<< 
=<<# $

periodData<<% /
.<</ 0
DisableDate<<0 ;
,<<; <
Date== 
===# $

periodData==% /
.==/ 0
Date==0 4
,==4 5
Status>> 
=>># $

periodData>>% /
.>>/ 0
Status>>0 6
,>>6 7
	CreatedAt?? 
=??# $
DateTime??% -
.??- .
Now??. 1
,??1 2
	UpdatedAt@@ 
=@@# $
DateTime@@% -
.@@- .
Now@@. 1
}AA 
;AA 
awaitCC ,
 _walletRetentionConfigRepositoryCC 6
.CC6 7,
 CreateWalletRetentionConfigAsyncCC7 W
(CCW X
newCCX [
ListCC\ `
<CC` a#
WalletsRetentionsConfigCCa x
>CCx y
{DD 
newPeriodRetentionDD (
}DD) *
)DD* +
;DD+ ,
createdPeriodsEE 
.EE 
AddEE "
(EE" #
MapperEE# )
.EE) *
MapEE* -
<EE- .$
WalletRetentionConfigDtoEE. F
>EEF G
(EEG H
newPeriodRetentionEEH Z
)EEZ [
)EE[ \
;EE\ ]
}FF 
}GG 	
returnII 
createdPeriodsII 
;II 
}JJ 
publicLL 

asyncLL 
TaskLL 
<LL $
WalletRetentionConfigDtoLL .
?LL. /
>LL/ 0,
 DeleteWalletRetentionConfigAsyncLL1 Q
(LLQ R
intLLR U
idLLV X
)LLX Y
{MM 
varNN 
retentionConfigNN 
=NN 
awaitNN #,
 _walletRetentionConfigRepositoryNN$ D
.NND E(
GetWalletRetentionConfigByIdNNE a
(NNa b
idNNb d
)NNd e
;NNe f
ifPP 

(PP 
retentionConfigPP 
isPP 
nullPP #
)PP# $
returnQQ 
nullQQ 
;QQ 
awaitSS ,
 _walletRetentionConfigRepositorySS .
.SS. /,
 DeleteWalletRetentionConfigAsyncSS/ O
(SSO P
retentionConfigSSP _
)SS_ `
;SS` a
returnTT 
MapperTT 
.TT 
MapTT 
<TT $
WalletRetentionConfigDtoTT 2
>TT2 3
(TT3 4
retentionConfigTT4 C
)TTC D
;TTD E
}UU 
}VV –
HC:\HeroSystem\walletService\WalletService.Core\Services\WalletService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public 
class 
WalletService 
: 
BaseService (
,( )
IWalletService* 8
{ 
private 
readonly "
IAccountServiceAdapter +"
_accountServiceAdapter, B
;B C
private 
readonly $
IInvoiceDetailRepository -$
_invoiceDetailRepository. F
;F G
private 
readonly 
IInvoiceRepository '
_invoiceRepository( :
;: ;
private 
readonly &
INetworkPurchaseRepository /&
_networkPurchaseRepository0 J
;J K
private 
readonly 
IWalletRepository &
_walletRepository' 8
;8 9
private 
readonly $
IWalletRequestRepository -$
_walletRequestRepository. F
;F G
private   
readonly   #
IBalancePaymentStrategy   ,#
_balancePaymentStrategy  - D
;  D E
private!! 
readonly!! 

RedisCache!! 
_redisCache!!  +
;!!+ ,
private"" 
readonly"" )
IBalancePaymentStrategyModel2"" 2)
_balancePaymentStrategyModel2""3 P
;""P Q
private## 
readonly## 
IBrandService## "
_brandService### 0
;##0 1
private$$ 
readonly$$ 
IBonusRepository$$ %
_bonusRepository$$& 6
;$$6 7
private%% 
readonly%% )
ToThirdPartiesPaymentStrategy%% 2*
_toThirdPartiesPaymentStrategy%%3 Q
;%%Q R
private&& 
readonly&& 
ICreditRepository&& &
_creditRepository&&' 8
;&&8 9
private'' 
readonly'' 
IUnitOfWork''  
_unitOfWork''! ,
;'', -
public)) 

WalletService)) 
()) 
IMapper** 
mapper** 
,** 
IWalletRepository++ 
walletRepository++ *
,++* +$
IWalletRequestRepository,,  #
walletRequestRepository,,! 8
,,,8 9"
IAccountServiceAdapter-- !
accountServiceAdapter-- 4
,--4 5
IInvoiceRepository.. 
invoiceRepository.. ,
,.., -$
IInvoiceDetailRepository//  #
invoiceDetailRepository//! 8
,//8 9&
INetworkPurchaseRepository00 "%
networkPurchaseRepository00# <
,00< =#
IBalancePaymentStrategy11 "
balancePaymentStrategy11  6
,116 7)
IBalancePaymentStrategyModel222 %(
balancePaymentStrategyModel222& B
,22B C

RedisCache33 

redisCache33 
,33 )
ToThirdPartiesPaymentStrategy44 %)
toThirdPartiesPaymentStrategy44& C
,44C D
IBrandService55 
brandService55 "
,55" #
IBonusRepository55$ 4
bonusRepository555 D
,55D E
ICreditRepository66 
creditRepository66 *
,66* +
IUnitOfWork77 

unitOfWork77 
)77 
:77  !
base88 
(88 
mapper88 
)88 
{99 
_walletRepository:: 
=:: 
walletRepository:: ,
;::, -$
_walletRequestRepository;;  
=;;! "#
walletRequestRepository;;# :
;;;: ;
_invoiceRepository<< 
=<< 
invoiceRepository<< .
;<<. /$
_invoiceDetailRepository==  
===! "#
invoiceDetailRepository==# :
;==: ;"
_accountServiceAdapter>> 
=>>  !
accountServiceAdapter>>! 6
;>>6 7&
_networkPurchaseRepository?? "
=??# $%
networkPurchaseRepository??% >
;??> ?#
_balancePaymentStrategy@@ 
=@@  !"
balancePaymentStrategy@@" 8
;@@8 9)
_balancePaymentStrategyModel2AA %
=AA& '(
balancePaymentStrategyModel2AA( D
;AAD E
_redisCacheBB 
=BB 

redisCacheBB  
;BB  !
_brandServiceCC 
=CC 
brandServiceCC $
;CC$ %
_bonusRepositoryDD 
=DD 
bonusRepositoryDD *
;DD* +*
_toThirdPartiesPaymentStrategyEE &
=EE' ()
toThirdPartiesPaymentStrategyEE) F
;EEF G
_creditRepositoryFF 
=FF 
creditRepositoryFF ,
;FF, -
_unitOfWorkGG 
=GG 

unitOfWorkGG  
;GG  !
}HH 
publicLL 

asyncLL 
TaskLL 
<LL 
IEnumerableLL !
<LL! "
	WalletDtoLL" +
>LL+ ,
>LL, -
GetAllWalletsLL. ;
(LL; <
)LL< =
{MM 
varNN 
responseNN 
=NN 
awaitNN 
_walletRepositoryNN .
.NN. /
GetAllWalletsNN/ <
(NN< =
_brandServiceNN= J
.NNJ K
BrandIdNNK R
)NNR S
;NNS T
returnPP 
MapperPP 
.PP 
MapPP 
<PP 
IEnumerablePP %
<PP% &
	WalletDtoPP& /
>PP/ 0
>PP0 1
(PP1 2
responsePP2 :
)PP: ;
;PP; <
}QQ 
publicSS 

asyncSS 
TaskSS 
<SS 
IEnumerableSS !
<SS! "
	WalletDtoSS" +
>SS+ ,
>SS, -
GetWalletsRequestSS. ?
(SS? @
intSS@ C
userIdSSD J
)SSJ K
{TT 
varUU 
responseUU 
=UU 
awaitUU 
_walletRepositoryUU .
.UU. /
GetWalletsRequestUU/ @
(UU@ A
userIdUUA G
,UUG H
_brandServiceUUI V
.UUV W
BrandIdUUW ^
)UU^ _
;UU_ `
returnWW 
MapperWW 
.WW 
MapWW 
<WW 
IEnumerableWW %
<WW% &
	WalletDtoWW& /
>WW/ 0
>WW0 1
(WW1 2
responseWW2 :
)WW: ;
;WW; <
}XX 
publicZZ 

asyncZZ 
TaskZZ 
<ZZ 
	WalletDtoZZ 
?ZZ  
>ZZ  !
GetWalletByIdZZ" /
(ZZ/ 0
intZZ0 3
idZZ4 6
)ZZ6 7
{[[ 
var\\ 
response\\ 
=\\ 
await\\ 
_walletRepository\\ .
.\\. /
GetWalletById\\/ <
(\\< =
id\\= ?
,\\? @
_brandService\\A N
.\\N O
BrandId\\O V
)\\V W
;\\W X
return^^ 
Mapper^^ 
.^^ 
Map^^ 
<^^ 
	WalletDto^^ #
>^^# $
(^^$ %
response^^% -
)^^- .
;^^. /
}__ 
publicaa 

asyncaa 
Taskaa 
<aa 
IEnumerableaa !
<aa! "
	WalletDtoaa" +
?aa+ ,
>aa, -
>aa- ."
GetWalletByAffiliateIdaa/ E
(aaE F
intaaF I
affiliateIdaaJ U
)aaU V
{bb 
varcc 
responsecc 
=cc 
awaitcc 
_walletRepositorycc .
.cc. /"
GetWalletByAffiliateIdcc/ E
(ccE F
affiliateIdccF Q
,ccQ R
_brandServiceccS `
.cc` a
BrandIdcca h
)cch i
;cci j
vardd 

mappedListdd 
=dd 
Mapperdd 
.dd  
Mapdd  #
<dd# $
IEnumerabledd$ /
<dd/ 0
	WalletDtodd0 9
?dd9 :
>dd: ;
>dd; <
(dd< =
responsedd= E
)ddE F
.ddF G
ToListddG M
(ddM N
)ddN O
;ddO P

mappedListee 
.ee 
Reverseee 
(ee 
)ee 
;ee 
returngg 

mappedListgg 
;gg 
}hh 
publicjj 

asyncjj 
Taskjj 
<jj 
IEnumerablejj !
<jj! "
	WalletDtojj" +
?jj+ ,
>jj, -
>jj- .
GetWalletByUserIdjj/ @
(jj@ A
intjjA D
userIdjjE K
)jjK L
{kk 
varll 
responsell 
=ll 
awaitll 
_walletRepositoryll .
.ll. /
GetWalletByUserIdll/ @
(ll@ A
userIdllA G
,llG H
_brandServicellI V
.llV W
BrandIdllW ^
)ll^ _
;ll_ `
returnnn 
Mappernn 
.nn 
Mapnn 
<nn 
IEnumerablenn %
<nn% &
	WalletDtonn& /
?nn/ 0
>nn0 1
>nn1 2
(nn2 3
responsenn3 ;
)nn; <
;nn< =
}oo 
publicqq 

asyncqq 
Taskqq 
<qq 
	WalletDtoqq 
?qq  
>qq  !
DeleteWalletAsyncqq" 3
(qq3 4
intqq4 7
idqq8 :
)qq: ;
{rr 
varss 
walletss 
=ss 
awaitss 
_walletRepositoryss ,
.ss, -
GetWalletByIdss- :
(ss: ;
idss; =
,ss= >
_brandServicess? L
.ssL M
BrandIdssM T
)ssT U
;ssU V
ifuu 

(uu 
walletuu 
isuu 
nulluu 
)uu 
returnvv 
nullvv 
;vv 
awaitxx 
_walletRepositoryxx 
.xx  
DeleteWalletAsyncxx  1
(xx1 2
walletxx2 8
)xx8 9
;xx9 :
returnzz 
Mapperzz 
.zz 
Mapzz 
<zz 
	WalletDtozz #
>zz# $
(zz$ %
walletzz% +
)zz+ ,
;zz, -
}{{ 
public}} 

async}} 
Task}} 
<}} !
BalanceInformationDto}} +
>}}+ ,.
"GetBalanceInformationByAffiliateId}}- O
(}}O P
int}}P S
affiliateId}}T _
)}}_ `
{~~ 
var 
key 
= 
string 
. 
Format 
(  
	CacheKeys  )
.) *$
BalanceInformationModel2* B
,B C
affiliateIdD O
)O P
;P Q
var
ÄÄ 
	existsKey
ÄÄ 
=
ÄÄ 
await
ÄÄ 
_redisCache
ÄÄ )
.
ÄÄ) *
	KeyExists
ÄÄ* 3
(
ÄÄ3 4
key
ÄÄ4 7
)
ÄÄ7 8
;
ÄÄ8 9#
BalanceInformationDto
ÅÅ 
response
ÅÅ &
;
ÅÅ& '
if
ÇÇ 

(
ÇÇ 
!
ÇÇ 
	existsKey
ÇÇ 
)
ÇÇ 
{
ÉÉ 	
var
ÑÑ 
amountRequests
ÑÑ 
=
ÑÑ  
await
ÖÖ &
_walletRequestRepository
ÖÖ .
.
ÖÖ. /6
(GetTotalWalletRequestAmountByAffiliateId
ÖÖ/ W
(
ÖÖW X
affiliateId
ÖÖX c
,
ÖÖc d
_brandService
ÜÜ !
.
ÜÜ! "
BrandId
ÜÜ" )
)
ÜÜ) *
;
ÜÜ* +
var
áá 
availableBalance
áá  
=
áá! "
await
àà 
_walletRepository
àà '
.
àà' (.
 GetAvailableBalanceByAffiliateId
àà( H
(
ààH I
affiliateId
ààI T
,
ààT U
_brandService
ààV c
.
ààc d
BrandId
ààd k
)
ààk l
;
ààl m
var
ââ 
reverseBalance
ââ 
=
ââ  
await
ää 
_walletRepository
ää '
.
ää' (,
GetReverseBalanceByAffiliateId
ää( F
(
ääF G
affiliateId
ääG R
,
ääR S
_brandService
ääT a
.
ääa b
BrandId
ääb i
)
ääi j
;
ääj k
var
ãã 
totalAcquisitions
ãã !
=
ãã" #
await
åå 
_walletRepository
åå '
.
åå' (/
!GetTotalAcquisitionsByAffiliateId
åå( I
(
ååI J
affiliateId
ååJ U
,
ååU V
_brandService
ååW d
.
ååd e
BrandId
ååe l
)
åål m
;
ååm n
var
çç "
totalCommissionsPaid
çç $
=
çç% &
await
éé 
_walletRepository
éé '
.
éé' (%
GetTotalCommissionsPaid
éé( ?
(
éé? @
affiliateId
éé@ K
,
ééK L
_brandService
ééM Z
.
ééZ [
BrandId
éé[ b
)
ééb c
;
ééc d
var
èè !
totalServiceBalance
èè #
=
èè$ %
await
êê 
_walletRepository
êê '
.
êê' ($
GetTotalServiceBalance
êê( >
(
êê> ?
affiliateId
êê? J
,
êêJ K
_brandService
êêL Y
.
êêY Z
BrandId
êêZ a
)
êêa b
;
êêb c
var
ëë 
bonusAmount
ëë 
=
ëë 
await
ëë #
_bonusRepository
ëë$ 4
.
ëë4 5)
GetBonusAmountByAffiliateId
ëë5 P
(
ëëP Q
affiliateId
ëëQ \
)
ëë\ ]
;
ëë] ^
response
ìì 
=
ìì 
new
ìì #
BalanceInformationDto
ìì 0
{
îî 
AvailableBalance
ïï  
=
ïï! "
availableBalance
ïï# 3
,
ïï3 4
ReverseBalance
ññ 
=
ññ  
reverseBalance
ññ! /
??
ññ0 2
$num
ññ3 4
,
ññ4 5
TotalAcquisitions
óó !
=
óó" #
Math
óó$ (
.
óó( )
Round
óó) .
(
óó. /
totalAcquisitions
óó/ @
??
óóA C
$num
óóD E
,
óóE F
$num
óóG H
)
óóH I
,
óóI J"
TotalCommissionsPaid
òò $
=
òò% &"
totalCommissionsPaid
òò' ;
??
òò< >
$num
òò? @
,
òò@ A
ServiceBalance
ôô 
=
ôô  !
totalServiceBalance
ôô! 4
??
ôô5 7
$num
ôô8 9
,
ôô9 :
BonusAmount
öö 
=
öö 
bonusAmount
öö )
,
öö) *
}
õõ 
;
õõ 
if
ùù 
(
ùù 
amountRequests
ùù 
!=
ùù !
$num
ùù" $
||
ùù% '
response
ùù( 0
.
ùù0 1
ReverseBalance
ùù1 ?
!=
ùù@ B
$num
ùùC E
)
ùùE F
{
ûû 
response
üü 
.
üü 
AvailableBalance
üü )
-=
üü* ,
amountRequests
üü- ;
;
üü; <
response
†† 
.
†† 
AvailableBalance
†† )
-=
††* ,
response
††- 5
.
††5 6
ReverseBalance
††6 D
;
††D E
}
°° 
await
££ 
_redisCache
££ 
.
££ 
Set
££ !
(
££! "
key
££" %
,
££% &
response
££' /
,
££/ 0
TimeSpan
££1 9
.
££9 :
	FromHours
££: C
(
££C D
$num
££D E
)
££E F
)
££F G
;
££G H
return
§§ 
response
§§ 
;
§§ 
}
•• 	
response
ßß 
=
ßß 
await
ßß 
_redisCache
ßß $
.
ßß$ %
Get
ßß% (
<
ßß( )#
BalanceInformationDto
ßß) >
>
ßß> ?
(
ßß? @
key
ßß@ C
)
ßßC D
??
ßßE G
new
ßßH K#
BalanceInformationDto
ßßL a
(
ßßa b
)
ßßb c
;
ßßc d
return
®® 
response
®® 
;
®® 
}
©© 
public
´´ 

async
´´ 
Task
´´ 
<
´´ (
BalanceInformationAdminDto
´´ 0
>
´´0 1(
GetBalanceInformationAdmin
´´2 L
(
´´L M
)
´´M N
{
¨¨ 
var
≠≠  
responseAffiliates
≠≠ 
=
≠≠  
await
≠≠! &$
_accountServiceAdapter
≠≠' =
.
≠≠= >#
GetTotalActiveMembers
≠≠> S
(
≠≠S T
_brandService
≠≠T a
.
≠≠a b
BrandId
≠≠b i
)
≠≠i j
;
≠≠j k
var
ÆÆ 
response
ÆÆ 
=
ÆÆ  
responseAffiliates
ÆÆ )
.
ÆÆ) *
Content
ÆÆ* 1
!
ÆÆ1 2
.
ÆÆ2 3
ToJsonObject
ÆÆ3 ?
<
ÆÆ? @+
GetTotalActiveMembersResponse
ÆÆ@ ]
>
ÆÆ] ^
(
ÆÆ^ _
)
ÆÆ_ `
;
ÆÆ` a
var
∞∞ 
paymentGroupId
∞∞ 
=
∞∞ 
_brandService
∞∞ *
.
∞∞* +
BrandId
∞∞+ 2
switch
∞∞3 9
{
±± 	
$num
≤≤ 
=>
≤≤ 
$num
≤≤ 
,
≤≤ 
$num
≥≥ 
=>
≥≥ 
$num
≥≥ 
,
≥≥ 
$num
¥¥ 
=>
¥¥ 
$num
¥¥ 
,
¥¥ 
$num
µµ 
=>
µµ 
$num
µµ 
,
µµ 
_
∂∂ 
=>
∂∂ 
$num
∂∂ 
}
∑∑ 	
;
∑∑	 

var
ππ 
enabledAffiliates
ππ 
=
ππ 
response
ππ  (
!
ππ( )
.
ππ) *
Data
ππ* .
;
ππ. /
var
∫∫ 
walletProfit
∫∫ 
=
∫∫ 
await
∫∫  
_walletRepository
∫∫! 2
.
∫∫2 3&
GetAvailableBalanceAdmin
∫∫3 K
(
∫∫K L
_brandService
∫∫L Y
.
∫∫Y Z
BrandId
∫∫Z a
)
∫∫a b
;
∫∫b c
var
ªª 
amountRequests
ªª 
=
ªª 
await
ªª "&
_walletRequestRepository
ªª# ;
.
ªª; <)
GetTotalWalletRequestAmount
ªª< W
(
ªªW X
_brandService
ªªX e
.
ªªe f
BrandId
ªªf m
)
ªªm n
;
ªªn o
var
ºº 
reverseBalance
ºº 
=
ºº 
await
ºº "
_walletRepository
ºº# 4
.
ºº4 5$
GetTotalReverseBalance
ºº5 K
(
ººK L
_brandService
ººL Y
.
ººY Z
BrandId
ººZ a
)
ººa b
;
ººb c
var
ΩΩ 
paidCommissions
ΩΩ 
=
ΩΩ 
await
ΩΩ #
_walletRepository
ΩΩ$ 5
.
ΩΩ5 6%
GetTotalCommissionsPaid
ΩΩ6 M
(
ΩΩM N
_brandService
ΩΩN [
.
ΩΩ[ \
BrandId
ΩΩ\ c
)
ΩΩc d
;
ΩΩd e
var
ææ #
calculatedCommissions
ææ !
=
ææ" #
await
øø  
_invoiceRepository
øø $
.
øø$ %'
GetTotalAdquisitionsAdmin
øø% >
(
øø> ?
_brandService
øø? L
.
øøL M
BrandId
øøM T
,
øøT U
paymentGroupId
øøV d
)
øød e
;
øøe f
var
¿¿ $
totalCommissionsEarned
¿¿ "
=
¿¿# $
await
¿¿% *
_walletRepository
¿¿+ <
.
¿¿< =)
GetCommissionsForAdminAsync
¿¿= X
(
¿¿X Y
_brandService
¿¿Y f
.
¿¿f g
BrandId
¿¿g n
)
¿¿n o
;
¿¿o p
var
¬¬ 
information
¬¬ 
=
¬¬ 
new
¬¬ (
BalanceInformationAdminDto
¬¬ 8
{
√√ 	
EnabledAffiliates
ƒƒ 
=
ƒƒ 
enabledAffiliates
ƒƒ  1
,
ƒƒ1 2
WalletProfit
≈≈ 
=
≈≈ 
walletProfit
≈≈ '
,
≈≈' (
CommissionsPaid
∆∆ 
=
∆∆ 
paidCommissions
∆∆ -
,
∆∆- .#
CalculatedCommissions
«« !
=
««" ##
calculatedCommissions
««$ 9
,
««9 :!
TotalReverseBalance
»» 
=
»»  !
reverseBalance
»»" 0
,
»»0 1$
TotalCommissionsEarned
…… "
=
……# $$
totalCommissionsEarned
……% ;
}
   	
;
  	 

if
ÃÃ 

(
ÃÃ 
amountRequests
ÃÃ 
==
ÃÃ 
$num
ÃÃ  
&&
ÃÃ! #
reverseBalance
ÃÃ$ 2
==
ÃÃ3 5
$num
ÃÃ6 7
)
ÃÃ7 8
return
ÃÃ9 ?
information
ÃÃ@ K
;
ÃÃK L
information
ŒŒ 
.
ŒŒ 
WalletProfit
ŒŒ  
-=
ŒŒ! #
amountRequests
ŒŒ$ 2
;
ŒŒ2 3
information
œœ 
.
œœ 
WalletProfit
œœ  
-=
œœ! #
reverseBalance
œœ$ 2
;
œœ2 3
return
—— 
information
—— 
;
—— 
}
““ 
public
‘‘ 

async
‘‘ 
Task
‘‘ 
<
‘‘ 
bool
‘‘ 
>
‘‘ 
PayWithMyBalance
‘‘ ,
(
‘‘, -
WalletRequest
‘‘- :
request
‘‘; B
)
‘‘B C
{
’’ 
if
÷÷ 

(
÷÷ 
request
÷÷ 
.
÷÷ 
ProductsList
÷÷  
.
÷÷  !
Count
÷÷! &
==
÷÷' )
$num
÷÷* +
)
÷÷+ ,
return
◊◊ 
false
◊◊ 
;
◊◊ 
request
ŸŸ 
.
ŸŸ 
BrandId
ŸŸ 
=
ŸŸ 
_brandService
ŸŸ '
.
ŸŸ' (
BrandId
ŸŸ( /
;
ŸŸ/ 0
var
⁄⁄ 
response
⁄⁄ 
=
⁄⁄ 
await
⁄⁄ %
_balancePaymentStrategy
⁄⁄ 4
.
⁄⁄4 5#
ExecuteEcoPoolPayment
⁄⁄5 J
(
⁄⁄J K
request
⁄⁄K R
)
⁄⁄R S
;
⁄⁄S T
return
‹‹ 
response
‹‹ 
;
‹‹ 
}
›› 
public
ﬂﬂ 

async
ﬂﬂ 
Task
ﬂﬂ 
<
ﬂﬂ 
bool
ﬂﬂ 
>
ﬂﬂ '
PayWithMyBalanceForOthers
ﬂﬂ 5
(
ﬂﬂ5 6
WalletRequest
ﬂﬂ6 C
request
ﬂﬂD K
)
ﬂﬂK L
{
‡‡ 
if
·· 

(
·· 
request
·· 
.
·· 
ProductsList
··  
.
··  !
Count
··! &
==
··' )
$num
··* +
)
··+ ,
return
‚‚ 
false
‚‚ 
;
‚‚ 
request
‰‰ 
.
‰‰ 
BrandId
‰‰ 
=
‰‰ 
_brandService
‰‰ '
.
‰‰' (
BrandId
‰‰( /
;
‰‰/ 0
var
ÂÂ 
response
ÂÂ 
=
ÂÂ 
await
ÂÂ ,
_toThirdPartiesPaymentStrategy
ÂÂ ;
.
ÂÂ; <
ExecutePayment
ÂÂ< J
(
ÂÂJ K
request
ÂÂK R
)
ÂÂR S
;
ÂÂS T
return
ÁÁ 
response
ÁÁ 
;
ÁÁ 
}
ËË 
public
ÍÍ 

async
ÍÍ 
Task
ÍÍ 
<
ÍÍ 
bool
ÍÍ 
>
ÍÍ $
PayWithMyBalanceModel2
ÍÍ 2
(
ÍÍ2 3
WalletRequest
ÍÍ3 @
request
ÍÍA H
)
ÍÍH I
{
ÎÎ 
if
ÏÏ 

(
ÏÏ 
request
ÏÏ 
.
ÏÏ 
ProductsList
ÏÏ  
.
ÏÏ  !
Count
ÏÏ! &
==
ÏÏ' )
$num
ÏÏ* +
)
ÏÏ+ ,
return
ÌÌ 
false
ÌÌ 
;
ÌÌ 
var
ÔÔ 
response
ÔÔ 
=
ÔÔ 
await
ÔÔ +
_balancePaymentStrategyModel2
ÔÔ :
.
ÔÔ: ;
ExecutePayment
ÔÔ; I
(
ÔÔI J
request
ÔÔJ Q
)
ÔÔQ R
;
ÔÔR S
return
ÒÒ 
response
ÒÒ 
;
ÒÒ 
}
ÚÚ 
public
ÙÙ 

async
ÙÙ 
Task
ÙÙ 
<
ÙÙ 
bool
ÙÙ 
>
ÙÙ (
PayMembershipWithMyBalance
ÙÙ 6
(
ÙÙ6 7
WalletRequest
ÙÙ7 D
request
ÙÙE L
)
ÙÙL M
{
ıı 
if
ˆˆ 

(
ˆˆ 
request
ˆˆ 
.
ˆˆ 
ProductsList
ˆˆ  
.
ˆˆ  !
Count
ˆˆ! &
==
ˆˆ' )
$num
ˆˆ* +
)
ˆˆ+ ,
return
˜˜ 
false
˜˜ 
;
˜˜ 
var
˘˘ 
response
˘˘ 
=
˘˘ 
await
˘˘ %
_balancePaymentStrategy
˘˘ 4
.
˘˘4 5&
ExecuteMembershipPayment
˘˘5 M
(
˘˘M N
request
˘˘N U
)
˘˘U V
;
˘˘V W
return
˚˚ 
response
˚˚ 
;
˚˚ 
}
¸¸ 
public
˛˛ 

async
˛˛ 
Task
˛˛ 

RemoveKeys
˛˛  
(
˛˛  !
DeleteKeysRequest
˛˛! 2
request
˛˛3 :
)
˛˛: ;
{
ˇˇ 
foreach
ÄÄ 
(
ÄÄ 
var
ÄÄ 
user
ÄÄ 
in
ÄÄ 
request
ÄÄ $
.
ÄÄ$ %
Users
ÄÄ% *
)
ÄÄ* +
{
ÅÅ 	
var
ÇÇ 
	keyModel2
ÇÇ 
=
ÇÇ 
string
ÇÇ "
.
ÇÇ" #
Format
ÇÇ# )
(
ÇÇ) *
	CacheKeys
ÇÇ* 3
.
ÇÇ3 4&
BalanceInformationModel2
ÇÇ4 L
,
ÇÇL M
user
ÇÇN R
)
ÇÇR S
;
ÇÇS T
var
ÉÉ 

keyModel1A
ÉÉ 
=
ÉÉ 
string
ÉÉ #
.
ÉÉ# $
Format
ÉÉ$ *
(
ÉÉ* +
	CacheKeys
ÉÉ+ 4
.
ÉÉ4 5'
BalanceInformationModel1A
ÉÉ5 N
,
ÉÉN O
user
ÉÉP T
)
ÉÉT U
;
ÉÉU V
var
ÑÑ 

keyModel1B
ÑÑ 
=
ÑÑ 
string
ÑÑ #
.
ÑÑ# $
Format
ÑÑ$ *
(
ÑÑ* +
	CacheKeys
ÑÑ+ 4
.
ÑÑ4 5'
BalanceInformationModel1B
ÑÑ5 N
,
ÑÑN O
user
ÑÑP T
)
ÑÑT U
;
ÑÑU V
var
ÖÖ 
existsModel2
ÖÖ 
=
ÖÖ 
await
ÖÖ $
_redisCache
ÖÖ% 0
.
ÖÖ0 1
	KeyExists
ÖÖ1 :
(
ÖÖ: ;
	keyModel2
ÖÖ; D
)
ÖÖD E
;
ÖÖE F
if
ÜÜ 
(
ÜÜ 
existsModel2
ÜÜ 
)
ÜÜ 
await
áá 
_redisCache
áá !
.
áá! "
Delete
áá" (
(
áá( )
	keyModel2
áá) 2
)
áá2 3
;
áá3 4
var
ââ 
existsModel1A
ââ 
=
ââ 
await
ââ  %
_redisCache
ââ& 1
.
ââ1 2
	KeyExists
ââ2 ;
(
ââ; <

keyModel1A
ââ< F
)
ââF G
;
ââG H
if
ää 
(
ää 
existsModel1A
ää 
)
ää 
await
ãã 
_redisCache
ãã !
.
ãã! "
Delete
ãã" (
(
ãã( )

keyModel1A
ãã) 3
)
ãã3 4
;
ãã4 5
var
çç 
existsModel1B
çç 
=
çç 
await
çç  %
_redisCache
çç& 1
.
çç1 2
	KeyExists
çç2 ;
(
çç; <

keyModel1B
çç< F
)
ççF G
;
ççG H
if
éé 
(
éé 
existsModel1B
éé 
)
éé 
await
èè 
_redisCache
èè !
.
èè! "
Delete
èè" (
(
èè( )

keyModel1B
èè) 3
)
èè3 4
;
èè4 5
}
êê 	
}
ëë 
public
ìì 

async
ìì 
Task
ìì 
<
ìì 
bool
ìì 
>
ìì "
CoursePaymentHandler
ìì 0
(
ìì0 1
WalletRequest
ìì1 >
request
ìì? F
)
ììF G
{
îî 
return
ïï 
await
ïï %
_balancePaymentStrategy
ïï ,
.
ïï, -#
ExecutePaymentCourses
ïï- B
(
ïïB C
request
ïïC J
)
ïïJ K
;
ïïK L
}
ññ 
public
òò 

async
òò 
Task
òò 
<
òò 
bool
òò 
>
òò !
AdminPaymentHandler
òò /
(
òò/ 0
WalletRequest
òò0 =
request
òò> E
)
òòE F
{
ôô 
return
öö 
await
öö %
_balancePaymentStrategy
öö ,
.
öö, -!
ExecuteAdminPayment
öö- @
(
öö@ A
request
ööA H
)
ööH I
;
ööI J
}
õõ 
public
ùù 

async
ùù 
Task
ùù 
<
ùù 
bool
ùù 
>
ùù ,
TransferBalanceForNewAffiliate
ùù :
(
ùù: ;$
TransferBalanceRequest
ùù; Q
request
ùùR Y
)
ùùY Z
{
ûû 
var
üü 
today
üü 
=
üü 
DateTime
üü 
.
üü 
Now
üü  
;
üü  !
var
†† 
amount
†† 
=
†† 
$num
†† 
;
†† 
var
°° 
userInfo
°° 
=
°° 
await
°° $
_accountServiceAdapter
°° 3
.
°°3 4$
GetAffiliateByUserName
°°4 J
(
°°J K
request
°°K R
.
°°R S

ToUserName
°°S ]
,
°°] ^
_brandService
°°_ l
.
°°l m
BrandId
°°m t
)
°°t u
;
°°u v
var
¢¢ 
currentUser
¢¢ 
=
¢¢ 
await
££ $
_accountServiceAdapter
££ (
.
££( )$
GetAffiliateByUserName
££) ?
(
££? @
request
££@ G
.
££G H
FromUserName
££H T
,
££T U
_brandService
££V c
.
££c d
BrandId
££d k
)
££k l
;
££l m
if
•• 

(
•• 
!
•• 
userInfo
•• 
.
•• 
IsSuccessful
•• "
)
••" #
return
¶¶ 
false
¶¶ 
;
¶¶ 
if
®® 

(
®® 
string
®® 
.
®® 
IsNullOrEmpty
®®  
(
®®  !
userInfo
®®! )
.
®®) *
Content
®®* 1
)
®®1 2
)
®®2 3
return
©© 
false
©© 
;
©© 
var
´´ 

userResult
´´ 
=
´´ 
JsonConvert
´´ $
.
´´$ %
DeserializeObject
´´% 6
<
´´6 7#
UserAffiliateResponse
´´7 L
>
´´L M
(
´´M N
currentUser
´´N Y
.
´´Y Z
Content
´´Z a
!
´´a b
)
´´b c
;
´´c d
var
¨¨ 
result
¨¨ 
=
¨¨ 
JsonConvert
¨¨  
.
¨¨  !
DeserializeObject
¨¨! 2
<
¨¨2 3#
UserAffiliateResponse
¨¨3 H
>
¨¨H I
(
¨¨I J
userInfo
¨¨J R
.
¨¨R S
Content
¨¨S Z
!
¨¨Z [
)
¨¨[ \
;
¨¨\ ]
var
ÆÆ 
userBalance
ÆÆ 
=
ÆÆ 
await
ÆÆ 0
"GetBalanceInformationByAffiliateId
ÆÆ  B
(
ÆÆB C
request
ÆÆC J
.
ÆÆJ K
FromAffiliateId
ÆÆK Z
)
ÆÆZ [
;
ÆÆ[ \
if
∞∞ 

(
∞∞ 

userResult
∞∞ 
?
∞∞ 
.
∞∞ 
Data
∞∞ 
?
∞∞ 
.
∞∞ 
VerificationCode
∞∞ .
!=
∞∞/ 1
request
∞∞2 9
.
∞∞9 :
SecurityCode
∞∞: F
)
∞∞F G
return
±± 
false
±± 
;
±± 
if
≥≥ 

(
≥≥ 
amount
≥≥ 
>
≥≥ 
userBalance
≥≥  
.
≥≥  !
AvailableBalance
≥≥! 1
)
≥≥1 2
return
¥¥ 
false
¥¥ 
;
¥¥ 
if
∂∂ 

(
∂∂ 
result
∂∂ 
?
∂∂ 
.
∂∂ 
Data
∂∂ 
?
∂∂ 
.
∂∂ 
Status
∂∂  
!=
∂∂! #
$num
∂∂$ %
)
∂∂% &
return
∑∑ 
false
∑∑ 
;
∑∑ 
if
ππ 

(
ππ 
result
ππ 
.
ππ 
Data
ππ 
?
ππ 
.
ππ 
ActivationDate
ππ '
!=
ππ( *
null
ππ+ /
)
ππ/ 0
return
∫∫ 
false
∫∫ 
;
∫∫ 
var
ºº 
debitTransaction
ºº 
=
ºº 
new
ºº "&
WalletTransactionRequest
ºº# ;
{
ΩΩ 	
Debit
ææ 
=
ææ 
amount
ææ 
,
ææ 
Deferred
øø 
=
øø 
	Constants
øø  
.
øø  !

EmptyValue
øø! +
,
øø+ ,
Detail
¿¿ 
=
¿¿ 
null
¿¿ 
,
¿¿ 
AffiliateId
¡¡ 
=
¡¡ 
request
¡¡ !
.
¡¡! "
FromAffiliateId
¡¡" 1
,
¡¡1 2
AdminUserName
¬¬ 
=
¬¬ 
_brandService
¬¬ )
.
¬¬) *
BrandId
¬¬* 1
switch
¬¬2 8
{
√√ 
$num
ƒƒ 
=>
ƒƒ 
	Constants
ƒƒ 
.
ƒƒ $
AdminEcosystemUserName
ƒƒ 5
,
ƒƒ5 6
$num
≈≈ 
=>
≈≈ 
	Constants
≈≈ 
.
≈≈ 
RecycoinAdmin
≈≈ ,
,
≈≈, -
$num
∆∆ 
=>
∆∆ 
	Constants
∆∆ 
.
∆∆ 
HouseCoinAdmin
∆∆ -
,
∆∆- .
$num
«« 
=>
«« 
	Constants
«« 
.
«« 
ExitoJuntosAdmin
«« /
,
««/ 0
_
»» 
=>
»» 
	Constants
»» 
.
»» $
AdminEcosystemUserName
»» 5
}
…… 
,
…… 
Status
   
=
   
true
   
,
   
UserId
ÀÀ 
=
ÀÀ 
	Constants
ÀÀ 
.
ÀÀ 
AdminUserId
ÀÀ *
,
ÀÀ* +
Credit
ÃÃ 
=
ÃÃ 
	Constants
ÃÃ 
.
ÃÃ 

EmptyValue
ÃÃ )
,
ÃÃ) *
Concept
ÕÕ 
=
ÕÕ 
$"
ÕÕ 
{
ÕÕ 
	Constants
ÕÕ "
.
ÕÕ" ##
TransferForMembership
ÕÕ# 8
}
ÕÕ8 9
$str
ÕÕ9 :
{
ÕÕ: ;
request
ÕÕ; B
.
ÕÕB C

ToUserName
ÕÕC M
}
ÕÕM N
"
ÕÕN O
,
ÕÕO P
Support
ŒŒ 
=
ŒŒ 
null
ŒŒ 
!
ŒŒ 
,
ŒŒ 
Date
œœ 
=
œœ 
today
œœ 
,
œœ 
Compression
–– 
=
–– 
false
–– 
,
––  
AffiliateUserName
—— 
=
—— 
request
——  '
.
——' (
FromUserName
——( 4
,
——4 5
ConceptType
““ 
=
““ 
WalletConceptType
““ +
.
““+ ,
balance_transfer
““, <
}
”” 	
;
””	 

var
’’ 
creditTransaction
’’ 
=
’’ 
new
’’  #&
WalletTransactionRequest
’’$ <
{
÷÷ 	
Debit
◊◊ 
=
◊◊ 
	Constants
◊◊ 
.
◊◊ 

EmptyValue
◊◊ (
,
◊◊( )
Deferred
ÿÿ 
=
ÿÿ 
	Constants
ÿÿ  
.
ÿÿ  !

EmptyValue
ÿÿ! +
,
ÿÿ+ ,
Detail
ŸŸ 
=
ŸŸ 
null
ŸŸ 
,
ŸŸ 
AffiliateId
⁄⁄ 
=
⁄⁄ 
result
⁄⁄  
.
⁄⁄  !
Data
⁄⁄! %
!
⁄⁄% &
.
⁄⁄& '
Id
⁄⁄' )
,
⁄⁄) *
AdminUserName
€€ 
=
€€ 
_brandService
€€ )
.
€€) *
BrandId
€€* 1
switch
€€2 8
{
‹‹ 
$num
›› 
=>
›› 
	Constants
›› 
.
›› $
AdminEcosystemUserName
›› 5
,
››5 6
$num
ﬁﬁ 
=>
ﬁﬁ 
	Constants
ﬁﬁ 
.
ﬁﬁ 
RecycoinAdmin
ﬁﬁ ,
,
ﬁﬁ, -
$num
ﬂﬂ 
=>
ﬂﬂ 
	Constants
ﬂﬂ 
.
ﬂﬂ 
HouseCoinAdmin
ﬂﬂ -
,
ﬂﬂ- .
$num
‡‡ 
=>
‡‡ 
	Constants
‡‡ 
.
‡‡ 
ExitoJuntosAdmin
‡‡ /
,
‡‡/ 0
_
·· 
=>
·· 
	Constants
·· 
.
·· $
AdminEcosystemUserName
·· 5
}
‚‚ 
,
‚‚ 
Status
„„ 
=
„„ 
true
„„ 
,
„„ 
UserId
‰‰ 
=
‰‰ 
	Constants
‰‰ 
.
‰‰ 
AdminUserId
‰‰ *
,
‰‰* +
Credit
ÂÂ 
=
ÂÂ 
amount
ÂÂ 
,
ÂÂ 
Concept
ÊÊ 
=
ÊÊ 
$"
ÊÊ 
{
ÊÊ 
	Constants
ÊÊ "
.
ÊÊ" #"
TransferToMembership
ÊÊ# 7
}
ÊÊ7 8
$str
ÊÊ8 9
{
ÊÊ9 :
request
ÊÊ: A
.
ÊÊA B
FromUserName
ÊÊB N
}
ÊÊN O
"
ÊÊO P
,
ÊÊP Q
Support
ÁÁ 
=
ÁÁ 
null
ÁÁ 
!
ÁÁ 
,
ÁÁ 
Date
ËË 
=
ËË 
today
ËË 
,
ËË 
Compression
ÈÈ 
=
ÈÈ 
false
ÈÈ 
,
ÈÈ  
AffiliateUserName
ÍÍ 
=
ÍÍ 
result
ÍÍ  &
.
ÍÍ& '
Data
ÍÍ' +
.
ÍÍ+ ,
UserName
ÍÍ, 4
,
ÍÍ4 5
ConceptType
ÎÎ 
=
ÎÎ 
WalletConceptType
ÎÎ +
.
ÎÎ+ ,
balance_transfer
ÎÎ, <
}
ÏÏ 	
;
ÏÏ	 

var
ÓÓ 
debitWallet
ÓÓ 
=
ÓÓ 
Mapper
ÓÓ  
.
ÓÓ  !
Map
ÓÓ! $
<
ÓÓ$ %
Wallet
ÓÓ% +
>
ÓÓ+ ,
(
ÓÓ, -
debitTransaction
ÓÓ- =
)
ÓÓ= >
;
ÓÓ> ?
var
ÔÔ 
creditWallet
ÔÔ 
=
ÔÔ 
Mapper
ÔÔ !
.
ÔÔ! "
Map
ÔÔ" %
<
ÔÔ% &
Wallet
ÔÔ& ,
>
ÔÔ, -
(
ÔÔ- .
creditTransaction
ÔÔ. ?
)
ÔÔ? @
;
ÔÔ@ A
var
ÒÒ 
success
ÒÒ 
=
ÒÒ 
await
ÒÒ 
_walletRepository
ÒÒ -
.
ÒÒ- .#
CreateTransferBalance
ÒÒ. C
(
ÒÒC D
debitWallet
ÒÒD O
,
ÒÒO P
creditWallet
ÒÒQ ]
)
ÒÒ] ^
;
ÒÒ^ _
if
ÛÛ 

(
ÛÛ 
!
ÛÛ 
success
ÛÛ 
)
ÛÛ 
return
ÙÙ 
false
ÙÙ 
;
ÙÙ 
var
ˆˆ 
keys
ˆˆ 
=
ˆˆ 
new
ˆˆ 
List
ˆˆ 
<
ˆˆ 
string
ˆˆ "
>
ˆˆ" #
{
˜˜ 	
string
¯¯ 
.
¯¯ 
Format
¯¯ 
(
¯¯ 
	CacheKeys
¯¯ #
.
¯¯# $&
BalanceInformationModel2
¯¯$ <
,
¯¯< =
debitTransaction
¯¯> N
.
¯¯N O
AffiliateId
¯¯O Z
)
¯¯Z [
,
¯¯[ \
string
˘˘ 
.
˘˘ 
Format
˘˘ 
(
˘˘ 
	CacheKeys
˘˘ #
.
˘˘# $&
BalanceInformationModel2
˘˘$ <
,
˘˘< =
creditTransaction
˘˘> O
.
˘˘O P
AffiliateId
˘˘P [
)
˘˘[ \
,
˘˘\ ]
}
˙˙ 	
;
˙˙	 

await
¸¸ 
RemoveKeysAsync
¸¸ 
(
¸¸ 
keys
¸¸ "
)
¸¸" #
;
¸¸# $
var
˛˛ 
confirmPurchase
˛˛ 
=
˛˛ 
await
˛˛ #0
"PurchaseMembershipForNewAffiliates
˛˛$ F
(
˛˛F G
creditTransaction
˛˛G X
)
˛˛X Y
;
˛˛Y Z
if
ÄÄ 

(
ÄÄ 
!
ÄÄ 
confirmPurchase
ÄÄ 
)
ÄÄ 
return
ÅÅ 
false
ÅÅ 
;
ÅÅ 
return
ÉÉ 
confirmPurchase
ÉÉ 
;
ÉÉ 
}
ÑÑ 
public
ÜÜ 

async
ÜÜ 
Task
ÜÜ 
<
ÜÜ 
ServicesResponse
ÜÜ &
>
ÜÜ& '
TransferBalance
ÜÜ( 7
(
ÜÜ7 8
string
ÜÜ8 >
	encrypted
ÜÜ? H
)
ÜÜH I
{
áá 
var
àà 
data
àà 
=
àà 
CommonExtensions
àà #
.
àà# $
DecryptObject
àà$ 1
<
àà1 2$
TransferBalanceRequest
àà2 H
>
ààH I
(
ààI J
	encrypted
ààJ S
)
ààS T
;
ààT U
var
ää 
today
ää 
=
ää 
DateTime
ää 
.
ää 
Now
ää  
;
ää  !
var
ãã 
amount
ãã 
=
ãã 
data
ãã 
.
ãã 
Amount
ãã  
;
ãã  !
var
åå 
currentUser
åå 
=
åå 
await
åå $
_accountServiceAdapter
åå  6
.
åå6 7$
GetAffiliateByUserName
åå7 M
(
ååM N
data
ååN R
.
ååR S
FromUserName
ååS _
,
åå_ `
_brandService
ååa n
.
åån o
BrandId
ååo v
)
ååv w
;
ååw x
var
çç 
userInfo
çç 
=
çç 
await
çç $
_accountServiceAdapter
çç 3
.
çç3 4$
GetAffiliateByUserName
çç4 J
(
ççJ K
data
ççK O
.
ççO P

ToUserName
ççP Z
,
ççZ [
_brandService
çç\ i
.
ççi j
BrandId
ççj q
)
ççq r
;
ççr s
var
éé 
isActivePool
éé 
=
éé 
await
èè 
_walletRepository
èè #
.
èè# $0
"IsActivePoolGreaterThanOrEqualTo25
èè$ F
(
èèF G
data
èèG K
.
èèK L
FromAffiliateId
èèL [
,
èè[ \
_brandService
èè] j
.
èèj k
BrandId
èèk r
)
èèr s
;
èès t
if
ëë 

(
ëë 
!
ëë 
isActivePool
ëë 
&&
ëë 
_brandService
ëë *
.
ëë* +
BrandId
ëë+ 2
==
ëë3 5
$num
ëë6 7
)
ëë7 8
return
íí 
new
íí 
ServicesResponse
íí '
{
íí( )
Success
íí* 1
=
íí2 3
false
íí4 9
,
íí9 :
Message
íí; B
=
ííC D
$str
ííE ^
,
íí^ _
Code
íí` d
=
ííe f
$num
ííg j
}
íík l
;
ííl m
if
îî 

(
îî 
!
îî 
userInfo
îî 
.
îî 
IsSuccessful
îî "
)
îî" #
return
ïï 
new
ïï 
ServicesResponse
ïï '
{
ïï( )
Success
ïï* 1
=
ïï2 3
false
ïï4 9
,
ïï9 :
Message
ïï; B
=
ïïC D
$str
ïïE L
,
ïïL M
Code
ïïN R
=
ïïS T
$num
ïïU X
}
ïïY Z
;
ïïZ [
if
óó 

(
óó 
string
óó 
.
óó 
IsNullOrEmpty
óó  
(
óó  !
userInfo
óó! )
.
óó) *
Content
óó* 1
)
óó1 2
)
óó2 3
return
òò 
new
òò 
ServicesResponse
òò '
{
òò( )
Success
òò* 1
=
òò2 3
false
òò4 9
,
òò9 :
Message
òò; B
=
òòC D
$str
òòE L
,
òòL M
Code
òòN R
=
òòS T
$num
òòU X
}
òòY Z
;
òòZ [
var
öö 
currentUserResult
öö 
=
öö 
JsonConvert
öö  +
.
öö+ ,
DeserializeObject
öö, =
<
öö= >#
UserAffiliateResponse
öö> S
>
ööS T
(
ööT U
currentUser
ööU `
.
öö` a
Content
ööa h
!
ööh i
)
ööi j
;
ööj k
var
õõ 
result
õõ 
=
õõ 
JsonConvert
õõ  
.
õõ  !
DeserializeObject
õõ! 2
<
õõ2 3#
UserAffiliateResponse
õõ3 H
>
õõH I
(
õõI J
userInfo
õõJ R
.
õõR S
Content
õõS Z
!
õõZ [
)
õõ[ \
;
õõ\ ]
var
úú 
userBalance
úú 
=
úú 
await
úú 0
"GetBalanceInformationByAffiliateId
úú  B
(
úúB C
data
úúC G
.
úúG H
FromAffiliateId
úúH W
)
úúW X
;
úúX Y
if
ûû 

(
ûû 
currentUserResult
ûû 
?
ûû 
.
ûû 
Data
ûû #
?
ûû# $
.
ûû$ %
VerificationCode
ûû% 5
!=
ûû6 8
data
ûû9 =
.
ûû= >
SecurityCode
ûû> J
)
ûûJ K
return
üü 
new
üü 
ServicesResponse
üü '
{
†† 
Success
†† 
=
†† 
false
†† !
,
††! "
Message
††# *
=
††+ ,
$str
††- S
,
††S T
Code
††U Y
=
††Z [
$num
††\ _
}
††` a
;
††a b
if
¢¢ 

(
¢¢ 
amount
¢¢ 
>
¢¢ 
userBalance
¢¢  
.
¢¢  !
AvailableBalance
¢¢! 1
)
¢¢1 2
return
££ 
new
££ 
ServicesResponse
££ '
{
§§ 
Success
§§ 
=
§§ 
false
§§ !
,
§§! "
Message
§§# *
=
§§+ ,
$str
§§- U
,
§§U V
Code
§§W [
=
§§\ ]
$num
§§^ a
}
§§b c
;
§§c d
if
¶¶ 

(
¶¶ 
result
¶¶ 
?
¶¶ 
.
¶¶ 
Data
¶¶ 
?
¶¶ 
.
¶¶ 
Status
¶¶  
!=
¶¶! #
$num
¶¶$ %
)
¶¶% &
return
ßß 
new
ßß 
ServicesResponse
ßß '
{
®® 
Success
®® 
=
®® 
false
®® !
,
®®! "
Message
®®# *
=
®®+ ,
$str
®®- `
,
®®` a
Code
®®b f
=
®®g h
$num
®®i l
}
®®m n
;
®®n o
var
™™ 
debitTransaction
™™ 
=
™™ 
new
™™ "&
WalletTransactionRequest
™™# ;
{
´´ 	
Debit
¨¨ 
=
¨¨ 
amount
¨¨ 
,
¨¨ 
Deferred
≠≠ 
=
≠≠ 
$num
≠≠ 
,
≠≠ 
Detail
ÆÆ 
=
ÆÆ 
null
ÆÆ 
,
ÆÆ 
AffiliateId
ØØ 
=
ØØ 
data
ØØ 
.
ØØ 
FromAffiliateId
ØØ .
,
ØØ. /
AdminUserName
∞∞ 
=
∞∞ 
_brandService
∞∞ )
.
∞∞) *
BrandId
∞∞* 1
switch
∞∞2 8
{
±± 
$num
≤≤ 
=>
≤≤ 
	Constants
≤≤ 
.
≤≤ $
AdminEcosystemUserName
≤≤ 5
,
≤≤5 6
$num
≥≥ 
=>
≥≥ 
	Constants
≥≥ 
.
≥≥ 
RecycoinAdmin
≥≥ ,
,
≥≥, -
$num
¥¥ 
=>
¥¥ 
	Constants
¥¥ 
.
¥¥ 
HouseCoinAdmin
¥¥ -
,
¥¥- .
$num
µµ 
=>
µµ 
	Constants
µµ 
.
µµ 
ExitoJuntosAdmin
µµ /
,
µµ/ 0
_
∂∂ 
=>
∂∂ 
	Constants
∂∂ 
.
∂∂ $
AdminEcosystemUserName
∂∂ 5
}
∑∑ 
,
∑∑ 
Status
∏∏ 
=
∏∏ 
true
∏∏ 
,
∏∏ 
UserId
ππ 
=
ππ 
$num
ππ 
,
ππ 
Credit
∫∫ 
=
∫∫ 
$num
∫∫ 
,
∫∫ 
Concept
ªª 
=
ªª 
$str
ªª ;
+
ªª< =
data
ªª> B
.
ªªB C

ToUserName
ªªC M
,
ªªM N
Support
ºº 
=
ºº 
null
ºº 
!
ºº 
,
ºº 
Date
ΩΩ 
=
ΩΩ 
today
ΩΩ 
,
ΩΩ 
Compression
ææ 
=
ææ 
false
ææ 
,
ææ  
AffiliateUserName
øø 
=
øø 
data
øø  $
.
øø$ %
FromUserName
øø% 1
,
øø1 2
ConceptType
¿¿ 
=
¿¿ 
WalletConceptType
¿¿ +
.
¿¿+ ,
balance_transfer
¿¿, <
,
¿¿< =
BrandId
¡¡ 
=
¡¡ 
_brandService
¡¡ #
.
¡¡# $
BrandId
¡¡$ +
,
¡¡+ ,
}
¬¬ 	
;
¬¬	 

var
ƒƒ 
creditTransaction
ƒƒ 
=
ƒƒ 
new
ƒƒ  #&
WalletTransactionRequest
ƒƒ$ <
{
≈≈ 	
Debit
∆∆ 
=
∆∆ 
$num
∆∆ 
,
∆∆ 
Deferred
«« 
=
«« 
$num
«« 
,
«« 
Detail
»» 
=
»» 
null
»» 
,
»» 
AffiliateId
…… 
=
…… 
result
……  
.
……  !
Data
……! %
.
……% &
Id
……& (
,
……( )
AdminUserName
   
=
   
_brandService
   )
.
  ) *
BrandId
  * 1
switch
  2 8
{
ÀÀ 
$num
ÃÃ 
=>
ÃÃ 
	Constants
ÃÃ 
.
ÃÃ $
AdminEcosystemUserName
ÃÃ 5
,
ÃÃ5 6
$num
ÕÕ 
=>
ÕÕ 
	Constants
ÕÕ 
.
ÕÕ 
RecycoinAdmin
ÕÕ ,
,
ÕÕ, -
$num
ŒŒ 
=>
ŒŒ 
	Constants
ŒŒ 
.
ŒŒ 
HouseCoinAdmin
ŒŒ -
,
ŒŒ- .
$num
œœ 
=>
œœ 
	Constants
œœ 
.
œœ 
ExitoJuntosAdmin
œœ /
,
œœ/ 0
_
–– 
=>
–– 
	Constants
–– 
.
–– $
AdminEcosystemUserName
–– 5
}
—— 
,
—— 
Status
““ 
=
““ 
true
““ 
,
““ 
UserId
”” 
=
”” 
$num
”” 
,
”” 
Credit
‘‘ 
=
‘‘ 
amount
‘‘ 
,
‘‘ 
Concept
’’ 
=
’’ 
$str
’’ <
+
’’= >
data
’’? C
.
’’C D
FromUserName
’’D P
,
’’P Q
Support
÷÷ 
=
÷÷ 
null
÷÷ 
!
÷÷ 
,
÷÷ 
Date
◊◊ 
=
◊◊ 
today
◊◊ 
,
◊◊ 
Compression
ÿÿ 
=
ÿÿ 
false
ÿÿ 
,
ÿÿ  
AffiliateUserName
ŸŸ 
=
ŸŸ 
result
ŸŸ  &
.
ŸŸ& '
Data
ŸŸ' +
.
ŸŸ+ ,
UserName
ŸŸ, 4
,
ŸŸ4 5
ConceptType
⁄⁄ 
=
⁄⁄ 
WalletConceptType
⁄⁄ +
.
⁄⁄+ ,
balance_transfer
⁄⁄, <
,
⁄⁄< =
BrandId
€€ 
=
€€ 
_brandService
€€ #
.
€€# $
BrandId
€€$ +
,
€€+ ,
}
‹‹ 	
;
‹‹	 

var
ﬁﬁ 
debitWallet
ﬁﬁ 
=
ﬁﬁ 
Mapper
ﬁﬁ  
.
ﬁﬁ  !
Map
ﬁﬁ! $
<
ﬁﬁ$ %
Wallet
ﬁﬁ% +
>
ﬁﬁ+ ,
(
ﬁﬁ, -
debitTransaction
ﬁﬁ- =
)
ﬁﬁ= >
;
ﬁﬁ> ?
var
ﬂﬂ 
creditWallet
ﬂﬂ 
=
ﬂﬂ 
Mapper
ﬂﬂ !
.
ﬂﬂ! "
Map
ﬂﬂ" %
<
ﬂﬂ% &
Wallet
ﬂﬂ& ,
>
ﬂﬂ, -
(
ﬂﬂ- .
creditTransaction
ﬂﬂ. ?
)
ﬂﬂ? @
;
ﬂﬂ@ A
var
·· 
success
·· 
=
·· 
await
·· 
_walletRepository
·· -
.
··- .#
CreateTransferBalance
··. C
(
··C D
debitWallet
··D O
,
··O P
creditWallet
··Q ]
)
··] ^
;
··^ _
if
„„ 

(
„„ 
!
„„ 
success
„„ 
)
„„ 
return
‰‰ 
new
‰‰ 
ServicesResponse
‰‰ '
{
‰‰( )
Success
‰‰* 1
=
‰‰2 3
false
‰‰4 9
,
‰‰9 :
Message
‰‰; B
=
‰‰C D
$str
‰‰E i
,
‰‰i j
Code
‰‰k o
=
‰‰p q
$num
‰‰r u
}
‰‰v w
;
‰‰w x
var
ÊÊ 
keys
ÊÊ 
=
ÊÊ 
new
ÊÊ 
List
ÊÊ 
<
ÊÊ 
string
ÊÊ "
>
ÊÊ" #
{
ÁÁ 	
string
ËË 
.
ËË 
Format
ËË 
(
ËË 
	CacheKeys
ËË #
.
ËË# $&
BalanceInformationModel2
ËË$ <
,
ËË< =
debitTransaction
ËË> N
.
ËËN O
AffiliateId
ËËO Z
)
ËËZ [
,
ËË[ \
string
ÈÈ 
.
ÈÈ 
Format
ÈÈ 
(
ÈÈ 
	CacheKeys
ÈÈ #
.
ÈÈ# $&
BalanceInformationModel2
ÈÈ$ <
,
ÈÈ< =
creditTransaction
ÈÈ> O
.
ÈÈO P
AffiliateId
ÈÈP [
)
ÈÈ[ \
,
ÈÈ\ ]
}
ÍÍ 	
;
ÍÍ	 

await
ÏÏ 
RemoveKeysAsync
ÏÏ 
(
ÏÏ 
keys
ÏÏ "
)
ÏÏ" #
;
ÏÏ# $
return
ÓÓ 
new
ÓÓ 
ServicesResponse
ÓÓ #
{
ÔÔ 
Success
ÔÔ 
=
ÔÔ 
true
ÔÔ 
,
ÔÔ 
Message
ÔÔ %
=
ÔÔ& '
$str
ÔÔ( V
,
ÔÔV W
Code
ÔÔX \
=
ÔÔ] ^
$num
ÔÔ_ b
}
ÔÔc d
;
ÔÔd e
}
 
public
ÚÚ 

async
ÚÚ 
Task
ÚÚ 
<
ÚÚ 
bool
ÚÚ 
>
ÚÚ 7
)HandleWalletRequestRevertTransactionAsync
ÚÚ E
(
ÚÚE F
int
ÚÚF I
option
ÚÚJ P
,
ÚÚP Q
int
ÚÚR U
	invoiceId
ÚÚV _
)
ÚÚ_ `
{
ÛÛ 
var
ÙÙ 
walletRequest
ÙÙ 
=
ÙÙ 
await
ÙÙ !&
_walletRequestRepository
ÙÙ" :
.
ÙÙ: ;.
 GetWalletRequestsByInvoiceNumber
ÙÙ; [
(
ÙÙ[ \
	invoiceId
ÙÙ\ e
)
ÙÙe f
;
ÙÙf g
if
ˆˆ 

(
ˆˆ 
walletRequest
ˆˆ 
==
ˆˆ 
null
ˆˆ !
)
ˆˆ! "
return
˜˜ 
false
˜˜ 
;
˜˜ 
var
˘˘ 
creditRequest
˘˘ 
=
˘˘ ,
CreateCreditTransactionRequest
˘˘ :
(
˘˘: ;
walletRequest
˘˘; H
)
˘˘H I
;
˘˘I J
switch
˚˚ 
(
˚˚ 
option
˚˚ 
)
˚˚ 
{
¸¸ 	
case
˝˝ 
$num
˝˝ 
:
˝˝ 
walletRequest
˛˛ 
.
˛˛ 
Status
˛˛ $
=
˛˛% &!
WalletRequestStatus
˛˛' :
.
˛˛: ;
cancel
˛˛; A
.
˛˛A B
ToByte
˛˛B H
(
˛˛H I
)
˛˛I J
;
˛˛J K
await
ˇˇ &
UpdateWalletRequestAsync
ˇˇ .
(
ˇˇ. /
walletRequest
ˇˇ/ <
)
ˇˇ< =
;
ˇˇ= >
break
ÅÅ 
;
ÅÅ 
case
ÇÇ 
$num
ÇÇ 
:
ÇÇ 
if
ÉÉ 
(
ÉÉ 
!
ÉÉ 
await
ÉÉ %
DeleteInvoiceAndDetails
ÉÉ 2
(
ÉÉ2 3
walletRequest
ÉÉ3 @
.
ÉÉ@ A
InvoiceNumber
ÉÉA N
)
ÉÉN O
)
ÉÉO P
return
ÑÑ 
false
ÑÑ  
;
ÑÑ  !
if
ÜÜ 
(
ÜÜ 
!
ÜÜ 
await
ÜÜ 
_walletRepository
ÜÜ ,
.
ÜÜ, -
CreditTransaction
ÜÜ- >
(
ÜÜ> ?
creditRequest
ÜÜ? L
)
ÜÜL M
)
ÜÜM N
return
áá 
false
áá  
;
áá  !
walletRequest
ââ 
.
ââ 
Status
ââ $
=
ââ% &!
WalletRequestStatus
ââ' :
.
ââ: ;
approved
ââ; C
.
ââC D
ToByte
ââD J
(
ââJ K
)
ââK L
;
ââL M
await
ää &
UpdateWalletRequestAsync
ää .
(
ää. /
walletRequest
ää/ <
)
ää< =
;
ää= >
break
ãã 
;
ãã 
default
åå 
:
åå 
walletRequest
çç 
.
çç 
Status
çç $
=
çç% &!
WalletRequestStatus
çç' :
.
çç: ;
cancel
çç; A
.
ççA B
ToByte
ççB H
(
ççH I
)
ççI J
;
ççJ K
break
éé 
;
éé 
}
èè 	
await
ëë 
RemoveCacheKey
ëë 
(
ëë 
walletRequest
ëë *
.
ëë* +
AffiliateId
ëë+ 6
)
ëë6 7
;
ëë7 8
return
ìì 
true
ìì 
;
ìì 
}
îî 
private
ññ &
CreditTransactionRequest
ññ $,
CreateCreditTransactionRequest
ññ% C
(
ññC D
WalletsRequest
ññD R
walletRequest
ññS `
)
ññ` a
{
óó 
return
òò 
new
òò &
CreditTransactionRequest
òò +
{
ôô 	
AffiliateId
öö 
=
öö 
walletRequest
öö '
.
öö' (
AffiliateId
öö( 3
,
öö3 4
UserId
õõ 
=
õõ 
	Constants
õõ 
.
õõ 
AdminUserId
õõ *
,
õõ* +
Concept
úú 
=
úú 
	Constants
úú 
.
úú  "
RevertEcoPoolConcept
úú  4
+
úú5 6
$"
úú7 9
$str
úú9 C
{
úúC D
walletRequest
úúD Q
.
úúQ R
InvoiceNumber
úúR _
}
úú_ `
"
úú` a
,
úúa b
Credit
ùù 
=
ùù 
Convert
ùù 
.
ùù 
ToDouble
ùù %
(
ùù% &
walletRequest
ùù& 3
.
ùù3 4
Amount
ùù4 :
)
ùù: ;
,
ùù; <
AffiliateUserName
ûû 
=
ûû 
walletRequest
ûû  -
.
ûû- .
AdminUserName
ûû. ;
!
ûû; <
,
ûû< =
AdminUserName
üü 
=
üü 
	Constants
üü %
.
üü% &$
AdminEcosystemUserName
üü& <
,
üü< =
ConceptType
†† 
=
†† 
WalletConceptType
†† +
.
††+ ,
revert_pool
††, 7
.
††7 8
ToString
††8 @
(
††@ A
)
††A B
}
°° 	
;
°°	 

}
¢¢ 
private
§§ 
async
§§ 
Task
§§ 
<
§§ 
bool
§§ 
>
§§ %
DeleteInvoiceAndDetails
§§ 4
(
§§4 5
long
§§5 9
invoiceNumber
§§: G
)
§§G H
{
•• 
try
¶¶ 
{
ßß 	
var
®® 
invoiceResponse
®® 
=
®®  !
await
®®" ' 
_invoiceRepository
®®( :
.
®®: ;
GetInvoiceById
®®; I
(
®®I J
invoiceNumber
®®J W
,
®®W X
_brandService
®®Y f
.
®®f g
BrandId
®®g n
)
®®n o
;
®®o p
var
©© #
invoiceDetailResponse
©© %
=
©©& '
await
©©( -&
_invoiceDetailRepository
©©. F
.
©©F G.
 GetInvoiceDetailByInvoiceIdAsync
©©G g
(
©©g h
invoiceNumber
©©h u
)
©©u v
;
©©v w
if
´´ 
(
´´ 
invoiceResponse
´´ 
is
´´  "
null
´´# '
||
´´( *#
invoiceDetailResponse
´´+ @
.
´´@ A
Any
´´A D
(
´´D E
)
´´E F
==
´´G I
false
´´J O
)
´´O P
return
¨¨ 
false
¨¨ 
;
¨¨ 
await
ÆÆ  
_invoiceRepository
ÆÆ $
.
ÆÆ$ % 
DeleteInvoiceAsync
ÆÆ% 7
(
ÆÆ7 8
invoiceResponse
ÆÆ8 G
)
ÆÆG H
;
ÆÆH I
await
ØØ &
_invoiceDetailRepository
ØØ *
.
ØØ* +*
DeleteBulkInvoiceDetailAsync
ØØ+ G
(
ØØG H#
invoiceDetailResponse
ØØH ]
)
ØØ] ^
;
ØØ^ _
return
±± 
true
±± 
;
±± 
}
≤≤ 	
catch
≥≥ 
(
≥≥ 
	Exception
≥≥ 
)
≥≥ 
{
¥¥ 	
return
µµ 
false
µµ 
;
µµ 
}
∂∂ 	
}
∑∑ 
private
ππ 
async
ππ 
Task
ππ &
UpdateWalletRequestAsync
ππ /
(
ππ/ 0
WalletsRequest
ππ0 >
walletRequest
ππ? L
)
ππL M
{
∫∫ 
walletRequest
ªª 
.
ªª 
AttentionDate
ªª #
=
ªª$ %
DateTime
ªª& .
.
ªª. /
Now
ªª/ 2
;
ªª2 3
await
ºº &
_walletRequestRepository
ºº &
.
ºº& ''
UpdateWalletRequestsAsync
ºº' @
(
ºº@ A
walletRequest
ººA N
)
ººN O
;
ººO P
}
ΩΩ 
public
øø 

async
øø 
Task
øø 
<
øø 
(
øø 
List
øø 
<
øø "
PurchasesPerMonthDto
øø 0
>
øø0 1"
CurrentYearPurchases
øø2 F
,
øøF G
List
øøH L
<
øøL M"
PurchasesPerMonthDto
øøM a
>
øøa b#
PreviousYearPurchases
øøc x
)
¿¿ 
?
¿¿ 
>
¿¿ )
GetPurchasesMadeInMyNetwork
¡¡ #
(
¡¡# $
int
¡¡$ '
affiliateId
¡¡( 3
)
¡¡3 4
{
¬¬ 
var
√√ 
networkResult
√√ 
=
√√ 
await
√√ !$
_accountServiceAdapter
√√" 8
.
√√8 9 
GetPersonalNetwork
√√9 K
(
√√K L
affiliateId
√√L W
,
√√W X
_brandService
√√Y f
.
√√f g
BrandId
√√g n
)
√√n o
;
√√o p
if
≈≈ 

(
≈≈ 
networkResult
≈≈ 
.
≈≈ 
Content
≈≈ !
==
≈≈" $
null
≈≈% )
||
≈≈* ,
!
≈≈- .
networkResult
≈≈. ;
.
≈≈; <
Content
≈≈< C
.
≈≈C D
Any
≈≈D G
(
≈≈G H
)
≈≈H I
)
≈≈I J
return
∆∆ 
null
∆∆ 
;
∆∆ 
var
»» 
result
»» 
=
»» 
networkResult
»» "
.
»»" #
Content
»»# *
!
»»* +
.
»»+ ,
ToJsonObject
»», 8
<
»»8 9)
UserPersonalNetworkResponse
»»9 T
>
»»T U
(
»»U V
)
»»V W
;
»»W X
if
   

(
   
result
   
?
   
.
   
Data
   
==
   
null
    
||
  ! #
!
  $ %
result
  % +
.
  + ,
Data
  , 0
.
  0 1
Any
  1 4
(
  4 5
)
  5 6
)
  6 7
return
ÀÀ 
null
ÀÀ 
;
ÀÀ 
var
ÕÕ 
idsInMyNetwork
ÕÕ 
=
ÕÕ 
new
ÕÕ  
HashSet
ÕÕ! (
<
ÕÕ( )
int
ÕÕ) ,
>
ÕÕ, -
(
ÕÕ- .
result
ÕÕ. 4
.
ÕÕ4 5
Data
ÕÕ5 9
.
ÕÕ9 :
Select
ÕÕ: @
(
ÕÕ@ A
	affiliate
ÕÕA J
=>
ÕÕK M
	affiliate
ÕÕN W
.
ÕÕW X
id
ÕÕX Z
)
ÕÕZ [
)
ÕÕ[ \
;
ÕÕ\ ]
idsInMyNetwork
œœ 
.
œœ 
Add
œœ 
(
œœ 
affiliateId
œœ &
)
œœ& '
;
œœ' (
var
—— 
purchasesSummary
—— 
=
—— 
await
—— $(
_networkPurchaseRepository
——% ?
.
——? @)
GetPurchasesMadeInMyNetwork
——@ [
(
——[ \
idsInMyNetwork
——\ j
)
——j k
;
——k l
var
”” 
groupedPurchases
”” 
=
”” 
purchasesSummary
”” /
.
‘‘ 
GroupBy
‘‘ 
(
‘‘ 
p
‘‘ 
=>
‘‘ 
p
‘‘ 
.
‘‘ 
Year
‘‘  
)
‘‘  !
.
’’ 
ToDictionary
’’ 
(
’’ 
g
’’ 
=>
’’ 
g
’’  
.
’’  !
Key
’’! $
,
’’$ %
g
’’& '
=>
’’( *
g
’’+ ,
.
’’, -
Select
’’- 3
(
’’3 4
p
’’4 5
=>
’’6 8
new
’’9 <"
PurchasesPerMonthDto
’’= Q
{
÷÷ 
Year
◊◊ 
=
◊◊ 
p
◊◊ 
.
◊◊ 
Year
◊◊ 
,
◊◊ 
Month
ÿÿ 
=
ÿÿ 
p
ÿÿ 
.
ÿÿ 
Month
ÿÿ 
,
ÿÿ  
TotalPurchases
ŸŸ 
=
ŸŸ  
p
ŸŸ! "
.
ŸŸ" #
TotalPurchases
ŸŸ# 1
}
⁄⁄ 
)
⁄⁄ 
.
⁄⁄ 
ToList
⁄⁄ 
(
⁄⁄ 
)
⁄⁄ 
)
⁄⁄ 
;
⁄⁄ 
var
‹‹ 
currentYear
‹‹ 
=
‹‹ 
DateTime
‹‹ "
.
‹‹" #
Now
‹‹# &
.
‹‹& '
Year
‹‹' +
;
‹‹+ ,
var
›› 
previousYear
›› 
=
›› 
currentYear
›› &
-
››' (
$num
››) *
;
››* +
groupedPurchases
ﬂﬂ 
.
ﬂﬂ 
TryGetValue
ﬂﬂ $
(
ﬂﬂ$ %
currentYear
ﬂﬂ% 0
,
ﬂﬂ0 1
out
ﬂﬂ2 5
var
ﬂﬂ6 9"
currentYearPurchases
ﬂﬂ: N
)
ﬂﬂN O
;
ﬂﬂO P
groupedPurchases
‡‡ 
.
‡‡ 
TryGetValue
‡‡ $
(
‡‡$ %
previousYear
‡‡% 1
,
‡‡1 2
out
‡‡3 6
var
‡‡7 :#
previousYearPurchases
‡‡; P
)
‡‡P Q
;
‡‡Q R
return
‚‚ 
(
‚‚ "
currentYearPurchases
‚‚ $
??
‚‚% '
new
‚‚( +
List
‚‚, 0
<
‚‚0 1"
PurchasesPerMonthDto
‚‚1 E
>
‚‚E F
(
‚‚F G
)
‚‚G H
,
‚‚H I#
previousYearPurchases
„„ !
??
„„" $
new
„„% (
List
„„) -
<
„„- ."
PurchasesPerMonthDto
„„. B
>
„„B C
(
„„C D
)
„„D E
)
„„E F
;
„„F G
}
‰‰ 
private
ÊÊ 
async
ÊÊ 
Task
ÊÊ 
<
ÊÊ 
bool
ÊÊ 
>
ÊÊ 0
"PurchaseMembershipForNewAffiliates
ÊÊ ?
(
ÊÊ? @&
WalletTransactionRequest
ÊÊ@ X
request
ÊÊY `
)
ÊÊ` a
{
ÁÁ 
var
ËË 

membership
ËË 
=
ËË 
new
ËË 
ProductsRequests
ËË -
{
ÈÈ 	
	IdProduct
ÍÍ 
=
ÍÍ 
$num
ÍÍ 
,
ÍÍ 
Count
ÎÎ 
=
ÎÎ 
$num
ÎÎ 
}
ÏÏ 	
;
ÏÏ	 

var
ÓÓ 
walletRequest
ÓÓ 
=
ÓÓ 
new
ÓÓ 
WalletRequest
ÓÓ  -
{
ÔÔ 	
AffiliateId
 
=
 
request
 !
.
! "
AffiliateId
" -
,
- .
AffiliateUserName
ÒÒ 
=
ÒÒ 
request
ÒÒ  '
.
ÒÒ' (
AffiliateUserName
ÒÒ( 9
!
ÒÒ9 :
,
ÒÒ: ;
PurchaseFor
ÚÚ 
=
ÚÚ 
	Constants
ÚÚ #
.
ÚÚ# $

EmptyValue
ÚÚ$ .
,
ÚÚ. /
Bank
ÛÛ 
=
ÛÛ 
	Constants
ÛÛ 
.
ÛÛ 
WalletBalance
ÛÛ *
,
ÛÛ* +
PaymentMethod
ÙÙ 
=
ÙÙ 
$num
ÙÙ 
,
ÙÙ 
	SecretKey
ıı 
=
ıı 
null
ıı 
,
ıı 
ReceiptNumber
ˆˆ 
=
ˆˆ 
null
ˆˆ  
,
ˆˆ  !
ProductsList
˜˜ 
=
˜˜ 
new
˜˜ 
List
˜˜ #
<
˜˜# $
ProductsRequests
˜˜$ 4
>
˜˜4 5
{
˜˜6 7

membership
˜˜8 B
}
˜˜C D
}
¯¯ 	
;
¯¯	 

return
˙˙ 
await
˙˙ %
_balancePaymentStrategy
˙˙ ,
.
˙˙, -&
ExecuteMembershipPayment
˙˙- E
(
˙˙E F
walletRequest
˙˙F S
)
˙˙S T
;
˙˙T U
}
˚˚ 
public
˝˝ 

async
˝˝ 
Task
˝˝ 
<
˝˝ 
IEnumerable
˝˝ !
<
˝˝! "
AffiliateBalance
˝˝" 2
>
˝˝2 3
>
˝˝3 41
#GetAllAffiliatesWithPositiveBalance
˝˝5 X
(
˝˝X Y
)
˝˝Y Z
{
˛˛ 
var
ˇˇ 
result
ˇˇ 
=
ˇˇ 
await
ˇˇ 
_walletRepository
ˇˇ ,
.
ˇˇ, -1
#GetAllAffiliatesWithPositiveBalance
ˇˇ- P
(
ˇˇP Q
_brandService
ˇˇQ ^
.
ˇˇ^ _
BrandId
ˇˇ_ f
)
ˇˇf g
;
ˇˇg h
return
ÅÅ 
result
ÅÅ 
;
ÅÅ 
}
ÇÇ 
public
ÑÑ 

async
ÑÑ 
Task
ÑÑ 
<
ÑÑ 
bool
ÑÑ 
>
ÑÑ  
CreateBalanceAdmin
ÑÑ .
(
ÑÑ. /+
CreditTransactionAdminRequest
ÑÑ/ L
request
ÑÑM T
)
ÑÑT U
{
ÖÖ 
if
ÜÜ 

(
ÜÜ 
request
ÜÜ 
.
ÜÜ 
Amount
ÜÜ 
==
ÜÜ 
$num
ÜÜ 
)
ÜÜ  
return
áá 
false
áá 
;
áá 
var
ââ 
user
ââ 
=
ââ 
await
ââ $
_accountServiceAdapter
ââ /
.
ââ/ 0
GetUserInfo
ââ0 ;
(
ââ; <
request
ââ< C
.
ââC D
AffiliateId
ââD O
,
ââO P
_brandService
ââQ ^
.
ââ^ _
BrandId
ââ_ f
)
ââf g
;
ââg h
if
ãã 

(
ãã 
user
ãã 
is
ãã 
null
ãã 
)
ãã 
return
åå 
false
åå 
;
åå 
var
éé 
today
éé 
=
éé 
DateTime
éé 
.
éé 
Now
éé  
;
éé  !
var
êê 
wallet
êê 
=
êê 
new
êê 
Wallet
êê 
{
ëë 	
AffiliateId
íí 
=
íí 
user
íí 
.
íí 
Id
íí !
,
íí! "
UserId
ìì 
=
ìì 
$num
ìì 
,
ìì 
Credit
îî 
=
îî 
(
îî 
decimal
îî 
)
îî 
request
îî %
.
îî% &
Amount
îî& ,
,
îî, -
Debit
ïï 
=
ïï 
$num
ïï 
,
ïï 
Deferred
ññ 
=
ññ 
$num
ññ 
,
ññ 
Status
óó 
=
óó 
true
óó 
,
óó 
Concept
òò 
=
òò 
$str
òò .
,
òò. /
Date
ôô 
=
ôô 
today
ôô 
,
ôô 
Compression
öö 
=
öö 
false
öö 
,
öö  
AffiliateUserName
õõ 
=
õõ 
user
õõ  $
.
õõ$ %
UserName
õõ% -
,
õõ- .
AdminUserName
úú 
=
úú 
_brandService
úú )
.
úú) *
BrandId
úú* 1
switch
úú2 8
{
ùù 
$num
ûû 
=>
ûû 
	Constants
ûû 
.
ûû $
AdminEcosystemUserName
ûû 5
,
ûû5 6
$num
üü 
=>
üü 
	Constants
üü 
.
üü 
RecycoinAdmin
üü ,
,
üü, -
$num
†† 
=>
†† 
	Constants
†† 
.
†† 
HouseCoinAdmin
†† -
,
††- .
$num
°° 
=>
°° 
	Constants
°° 
.
°° 
ExitoJuntosAdmin
°° /
,
°°/ 0
_
¢¢ 
=>
¢¢ 
	Constants
¢¢ 
.
¢¢ $
AdminEcosystemUserName
¢¢ 5
}
££ 
,
££ 
ConceptType
§§ 
=
§§ 
WalletConceptType
§§ +
.
§§+ ,
balance_transfer
§§, <
.
§§< =
ToString
§§= E
(
§§E F
)
§§F G
,
§§G H
BrandId
•• 
=
•• 
_brandService
•• #
.
••# $
BrandId
••$ +
,
••+ ,
}
¶¶ 	
;
¶¶	 

var
®® 
credit
®® 
=
®® 
new
®® 
Credit
®® 
{
©© 	
AffiliateId
™™ 
=
™™ 
user
™™ 
.
™™ 
Id
™™ !
,
™™! "
Concept
´´ 
=
´´ 
$str
´´ .
,
´´. /
Credit1
¨¨ 
=
¨¨ 
wallet
¨¨ 
.
¨¨ 
Credit
¨¨ #
,
¨¨# $
Debit
≠≠ 
=
≠≠ 
$num
≠≠ 
,
≠≠ 
Paid
ÆÆ 
=
ÆÆ 
$num
ÆÆ 
,
ÆÆ 
Request
ØØ 
=
ØØ 
$num
ØØ 
,
ØØ 
RequestDenied
∞∞ 
=
∞∞ 
$num
∞∞ 
,
∞∞ 
Iva
±± 
=
±± 
$num
±± 
,
±± 
Islr
≤≤ 
=
≤≤ 
$num
≤≤ 
}
≥≥ 	
;
≥≥	 

try
¥¥ 
{
µµ 	
await
∂∂ 
_unitOfWork
∂∂ 
.
∂∂ #
BeginTransactionAsync
∂∂ 3
(
∂∂3 4
)
∂∂4 5
;
∂∂5 6
var
∏∏ 
createdWallet
∏∏ 
=
∏∏ 
await
∏∏  %
_walletRepository
∏∏& 7
.
∏∏7 8
CreateAsync
∏∏8 C
(
∏∏C D
wallet
∏∏D J
)
∏∏J K
;
∏∏K L
var
ππ 
createdCredit
ππ 
=
ππ 
await
ππ  %
_creditRepository
ππ& 7
.
ππ7 8
CreateCredit
ππ8 D
(
ππD E
credit
ππE K
)
ππK L
;
ππL M
await
ªª 
_unitOfWork
ªª 
.
ªª 
CommitAsync
ªª )
(
ªª) *
)
ªª* +
;
ªª+ ,
await
ºº 
RemoveCacheKey
ºº  
(
ºº  !
user
ºº! %
.
ºº% &
Id
ºº& (
)
ºº( )
;
ºº) *
return
ææ 
true
ææ 
;
ææ 
}
øø 	
catch
¿¿ 
{
¡¡ 	
await
¬¬ 
_unitOfWork
¬¬ 
.
¬¬ 
RollbackAsync
¬¬ +
(
¬¬+ ,
)
¬¬, -
;
¬¬- .
throw
√√ 
;
√√ 
}
ƒƒ 	
}
≈≈ 
private
«« 
async
«« 
Task
«« 
RemoveKeysAsync
«« &
(
««& '
IEnumerable
««' 2
<
««2 3
string
««3 9
>
««9 :
keys
««; ?
)
««? @
{
»» 
foreach
…… 
(
…… 
var
…… 
key
…… 
in
…… 
keys
……  
)
……  !
{
   	
var
ÀÀ 
exists
ÀÀ 
=
ÀÀ 
await
ÀÀ 
_redisCache
ÀÀ *
.
ÀÀ* +
	KeyExists
ÀÀ+ 4
(
ÀÀ4 5
key
ÀÀ5 8
)
ÀÀ8 9
;
ÀÀ9 :
if
ÃÃ 
(
ÃÃ 
exists
ÃÃ 
)
ÃÃ 
await
ÕÕ 
_redisCache
ÕÕ !
.
ÕÕ! "
Delete
ÕÕ" (
(
ÕÕ( )
key
ÕÕ) ,
)
ÕÕ, -
;
ÕÕ- .
}
ŒŒ 	
}
œœ 
private
—— 
async
—— 
Task
—— 
RemoveCacheKey
—— %
(
——% &
int
——& )
affiliateId
——* 5
)
——5 6
{
““ 
var
”” 
key
”” 
=
”” 
string
”” 
.
”” 
Format
”” 
(
””  
	CacheKeys
””  )
.
””) *&
BalanceInformationModel2
””* B
,
””B C
affiliateId
””D O
)
””O P
;
””P Q
var
‘‘ 
	existsKey
‘‘ 
=
‘‘ 
await
‘‘ 
_redisCache
‘‘ )
.
‘‘) *
	KeyExists
‘‘* 3
(
‘‘3 4
key
‘‘4 7
)
‘‘7 8
;
‘‘8 9
if
÷÷ 

(
÷÷ 
	existsKey
÷÷ 
)
÷÷ 
await
◊◊ 
_redisCache
◊◊ 
.
◊◊ 
Delete
◊◊ $
(
◊◊$ %
key
◊◊% (
)
◊◊( )
;
◊◊) *
}
ÿÿ 
}€€ ÷5
LC:\HeroSystem\walletService\WalletService.Core\Services\WalletWaitService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public

 
class

 
WalletWaitService

 
:

  
BaseService

! ,
,

, -
IWalletWaitService

. @
{ 
private 
readonly !
IWalletWaitRepository *!
_walletWaitRepository+ @
;@ A
public 

WalletWaitService 
( 
IMapper $
mapper% +
,+ ,!
IWalletWaitRepository- B 
walletWaitRepositoryC W
)W X
:Y Z
base[ _
(_ `
mapper` f
)f g
=> 
!
_walletWaitRepository  
=! " 
walletWaitRepository# 7
;7 8
public 

async 
Task 
< 
IEnumerable !
<! "
WalletWaitDto" /
>/ 0
>0 1
GetAllWalletsWaits2 D
(D E
)E F
{ 
var 
response 
= 
await !
_walletWaitRepository 2
.2 3
GetAllWalletsWaits3 E
(E F
)F G
;G H
return 
Mapper 
. 
Map 
< 
IEnumerable %
<% &
WalletWaitDto& 3
>3 4
>4 5
(5 6
response6 >
)> ?
;? @
} 
public 

async 
Task 
< 
WalletWaitDto #
?# $
>$ %
GetWalletWaitById& 7
(7 8
int8 ;
id< >
)> ?
{ 
var 
response 
= 
await !
_walletWaitRepository 2
.2 3
GetWalletWaitById3 D
(D E
idE G
)G H
;H I
return 
Mapper 
. 
Map 
< 
WalletWaitDto '
>' (
(( )
response) 1
)1 2
;2 3
} 
public 

async 
Task 
< 
WalletWaitDto #
?# $
>$ %!
CreateWalletWaitAsync& ;
(; <
WalletWaitRequest< M
requestN U
)U V
{ 
var 
wallet 
= 
Mapper 
. 
Map 
<  
WalletsWait  +
>+ ,
(, -
request- 4
)4 5
;5 6
wallet   
=   
await   !
_walletWaitRepository   ,
.  , -!
CreateWalletWaitAsync  - B
(  B C
wallet  C I
)  I J
;  J K
return!! 
Mapper!! 
.!! 
Map!! 
<!! 
WalletWaitDto!! '
>!!' (
(!!( )
wallet!!) /
)!!/ 0
;!!0 1
}"" 
public$$ 

async$$ 
Task$$ 
<$$ 
WalletWaitDto$$ #
?$$# $
>$$$ %!
UpdateWalletWaitAsync$$& ;
($$; <
int$$< ?
id$$@ B
,$$B C
WalletWaitRequest$$D U
request$$V ]
)$$] ^
{%% 
var&& 
wallet&& 
=&& 
await&& !
_walletWaitRepository&& 0
.&&0 1
GetWalletWaitById&&1 B
(&&B C
id&&C E
)&&E F
;&&F G
if(( 

((( 
wallet(( 
is(( 
null(( 
)(( 
return)) 
null)) 
;)) 
wallet** 
.** 
AffiliateId** 
=** 
request** &
.**& '
AffiliateId**' 2
;**2 3
wallet++ 
.++ 
Credit++ 
=++ 
request++ &
.++& '
Credit++' -
;++- .
wallet,, 
.,, 
PaymentMethod,, 
=,, 
request,, &
.,,& '
PaymentMethod,,' 4
!,,4 5
;,,5 6
wallet-- 
.-- 
Bank-- 
=-- 
request-- &
.--& '
Bank--' +
;--+ ,
wallet.. 
... 
Support.. 
=.. 
request.. &
...& '
Support..' .
;... /
wallet// 
.// 
DepositDate// 
=// 
request// &
.//& '
DepositDate//' 2
;//2 3
wallet00 
.00 
Status00 
=00 
request00 &
.00& '
Status00' -
;00- .
wallet11 
.11 
Attended11 
=11 
request11 &
.11& '
Attended11' /
;11/ 0
wallet22 
.22 
Date22 
=22 
request22 &
.22& '
Date22' +
;22+ ,
wallet33 
.33 
Order33 
=33 
request33 &
.33& '
Order33' ,
;33, -
wallet44 
.44 
	UpdatedAt44 
=44 
DateTime44 '
.44' (
Now44( +
;44+ ,
wallet66 
=66 
await66 !
_walletWaitRepository66 ,
.66, -!
UpdateWalletWaitAsync66- B
(66B C
wallet66C I
)66I J
;66J K
return88 
Mapper88 
.88 
Map88 
<88 
WalletWaitDto88 '
>88' (
(88( )
wallet88) /
)88/ 0
;880 1
}99 
public;; 

async;; 
Task;; 
<;; 
WalletWaitDto;; #
?;;# $
>;;$ %!
DeleteWalletWaitAsync;;& ;
(;;; <
int;;< ?
id;;@ B
);;B C
{<< 
var== 
wallet== 
=== 
await== !
_walletWaitRepository== 0
.==0 1
GetWalletWaitById==1 B
(==B C
id==C E
)==E F
;==F G
if?? 

(?? 
wallet?? 
is?? 
null?? 
)?? 
return@@ 
null@@ 
;@@ 
awaitBB !
_walletWaitRepositoryBB #
.BB# $!
DeleteWalletWaitAsyncBB$ 9
(BB9 :
walletBB: @
)BB@ A
;BBA B
returnCC 
MapperCC 
.CC 
MapCC 
<CC 
WalletWaitDtoCC '
>CC' (
(CC( )
walletCC) /
)CC/ 0
;CC0 1
}DD 
}EE «4
RC:\HeroSystem\walletService\WalletService.Core\Services\WalletWithDrawalService.cs
	namespace 	
WalletService
 
. 
Core 
. 
Services %
;% &
public

 
class

 #
WalletWithDrawalService

 $
:

% &
BaseService

' 2
,

2 3$
IWalletWithdrawalService

4 L
{ 
private 
readonly '
IWalletWithDrawalRepository 0'
_walletWithDrawalRepository1 L
;L M
public 
#
WalletWithDrawalService "
(" #
IMapper# *
mapper+ 1
,1 2'
IWalletWithDrawalRepository3 N&
walletWithDrawalRepositoryO i
)i j
:k l
basem q
(q r
mapperr x
)x y
=> 
'
_walletWithDrawalRepository &
=' (&
walletWithDrawalRepository) C
;C D
public 

async 
Task 
< 
IEnumerable !
<! "
WalletWithDrawalDto" 5
>5 6
>6 7$
GetAllWalletsWithdrawals8 P
(P Q
)Q R
{ 
var 
response 
= 
await '
_walletWithDrawalRepository 8
.8 9$
GetAllWalletsWithdrawals9 Q
(Q R
)R S
;S T
return 
Mapper 
. 
Map 
< 
IEnumerable %
<% &
WalletWithDrawalDto& 9
>9 :
>: ;
(; <
response< D
)D E
;E F
} 
public 

async 
Task 
< 
WalletWithDrawalDto )
?) *
>* +#
GetWalletWithdrawalById, C
(C D
intD G
idH J
)J K
{ 
var 
response 
= 
await '
_walletWithDrawalRepository 8
.8 9#
GetWalletWithdrawalById9 P
(P Q
idQ S
)S T
;T U
return 
Mapper 
. 
Map 
< 
WalletWithDrawalDto -
>- .
(. /
response/ 7
)7 8
;8 9
} 
public 

async 
Task 
< 
WalletWithDrawalDto )
?) *
>* +'
CreateWalletWithdrawalAsync, G
(G H#
WalletWithDrawalRequestH _
request` g
)g h
{   
var!! 
wallet!! 
=!! 
Mapper!! 
.!! 
Map!! 
<!!  
WalletsWithdrawal!!  1
>!!1 2
(!!2 3
request!!3 :
)!!: ;
;!!; <
wallet"" 
="" 
await"" '
_walletWithDrawalRepository"" 2
.""2 3'
CreateWalletWithdrawalAsync""3 N
(""N O
wallet""O U
)""U V
;""V W
return## 
Mapper## 
.## 
Map## 
<## 
WalletWithDrawalDto## -
>##- .
(##. /
wallet##/ 5
)##5 6
;##6 7
}$$ 
public&& 

async&& 
Task&& 
<&& 
WalletWithDrawalDto&& )
?&&) *
>&&* +'
UpdateWalletWithdrawalAsync&&, G
(&&G H
int&&H K
id&&L N
,&&N O#
WalletWithDrawalRequest&&P g
request&&h o
)&&o p
{'' 
var(( 
wallet(( 
=(( 
await(( '
_walletWithDrawalRepository(( 6
.((6 7#
GetWalletWithdrawalById((7 N
(((N O
id((O Q
)((Q R
;((R S
if** 

(** 
wallet** 
is** 
null** 
)** 
return++ 
null++ 
;++ 
wallet,, 
.,, 
AffiliateId,, 
=,, 
request,, $
.,,$ %
AffiliateId,,% 0
;,,0 1
wallet-- 
.-- 
Amount-- 
=-- 
request-- $
.--$ %
Amount--% +
;--+ ,
wallet// 
.// 
Observation// 
=//# $
request//% ,
.//, -
Observation//- 8
;//8 9
wallet00 
.00 
AdminObservation00 
=00# $
request00% ,
.00, -
AdminObservation00- =
;00= >
wallet11 
.11 
Date11 
=11# $
request11% ,
.11, -
Date11- 1
;111 2
wallet22 
.22 
ResponseDate22 
=22# $
request22% ,
.22, -
ResponseDate22- 9
;229 :
wallet33 
.33 
RetentionPercentage33 "
=33# $
request33% ,
.33, -
RetentionPercentage33- @
;33@ A
wallet44 
.44 
Status44 
=44# $
request44% ,
.44, -
Status44- 3
;443 4
wallet55 
=55# $
await55% *'
_walletWithDrawalRepository55+ F
.55F G'
UpdateWalletWithdrawalAsync55G b
(55b c
wallet55c i
)55i j
;55j k
return77 
Mapper77 
.77 
Map77 
<77 
WalletWithDrawalDto77 -
>77- .
(77. /
wallet77/ 5
)775 6
;776 7
}88 
public:: 

async:: 
Task:: 
<:: 
WalletWithDrawalDto:: )
?::) *
>::* +'
DeleteWalletWithdrawalAsync::, G
(::G H
int::H K
id::L N
)::N O
{;; 
var<< 
wallet<< 
=<< 
await<< '
_walletWithDrawalRepository<< 6
.<<6 7#
GetWalletWithdrawalById<<7 N
(<<N O
id<<O Q
)<<Q R
;<<R S
if>> 

(>> 
wallet>> 
is>> 
null>> 
)>> 
return?? 
null?? 
;?? 
awaitAA '
_walletWithDrawalRepositoryAA )
.AA) *'
DeleteWalletWithdrawalAsyncAA* E
(AAE F
walletAAF L
)AAL M
;AAM N
returnBB 
MapperBB 
.BB 
MapBB 
<BB 
WalletWithDrawalDtoBB -
>BB- .
(BB. /
walletBB/ 5
)BB5 6
;BB6 7
}CC 
}DD 